@* 互動式表格組件 - 支援多種輸入控件和統一的UI風格 *@
@using System.Reflection
@using System.Web
@using ERPCore2.Helpers
@inject IJSRuntime JSRuntime
@typeparam TItem

<div class="table-responsive table-container-hover interactive-table-container">
    <table class="table @GetTableClass() interactive-table">
        @if (ShowHeader && ColumnDefinitions != null && ColumnDefinitions.Any())
        {
            <thead class="@GetHeaderClass()">
                <tr>
                    @if (ShowRowNumbers)
                    {
                        <th scope="col" class="text-center row-number-column">#</th>
                    }
                    @if (ShowSelectColumn)
                    {
                        <th scope="col" class="text-center" style="width: @SelectColumnWidth;">
                            @if (AllowMultipleSelection)
                            {
                                <input type="checkbox" 
                                       id="@_selectAllCheckboxId"
                                       class="form-check-input"
                                       checked="@IsAllSelected"
                                       @onchange="HandleSelectAllChanged"
                                       title="全選/取消全選" />
                            }
                        </th>
                    }
                    @foreach (var column in ColumnDefinitions)
                    {
                        var headerStyle = GetColumnWidthStyle(column);
                        if (!string.IsNullOrEmpty(column.Tooltip))
                        {
                            headerStyle = (headerStyle ?? "") + (string.IsNullOrEmpty(headerStyle) ? "" : " ") + "cursor: help;";
                        }
                        
                        <th scope="col" 
                            class="@column.HeaderCssClass @(column.HideOnMobile ? "d-none d-md-table-cell" : "")" 
                            style="@headerStyle"
                            title="@column.Tooltip">
                            @if (!string.IsNullOrEmpty(column.IconClass))
                            {
                                <i class="@column.IconClass me-1"></i>
                            }
                            @column.Title
                            @if (column.IsRequired)
                            {
                                <span class="text-danger ms-1">*</span>
                            }
                        </th>
                    }
                    @if (ShowActions && ActionsTemplate != null)
                    {
                        <th scope="col" class="text-center table-actions-column" style="@GetActionsColumnStyle()">@ActionsHeader</th>
                    }
                    @if (ShowBuiltInActions)
                    {
                        <th scope="col" class="text-center table-actions-column" style="@GetActionsColumnStyle()">@ActionsHeader</th>
                    }
                </tr>
            </thead>
        }
        <tbody @ondragover="HandleTableDragOver" 
               @ondragover:preventDefault="@EnableDrop"
               @ondragleave="HandleTableDragLeave"
               @ondrop="HandleTableDrop"
               @ondrop:preventDefault="@EnableDrop"
               class="@GetTableBodyClass()">
            @if (Items != null && Items.Any())
            {
                var itemIndex = 0;
                @foreach (var item in Items)
                {
                    var currentIndex = itemIndex;
                    var canDrag = EnableDrag && (IsDraggable?.Invoke(item) ?? true);
                    <tr class="@GetRowClass(item, currentIndex) @GetDragDropRowClass(item, currentIndex)" 
                        @onclick="() => HandleRowClick(item)"
                        @onclick:stopPropagation="false"
                        style="@GetRowStyle(canDrag)"
                        draggable="@canDrag.ToString().ToLower()"
                        @ondragstart="() => HandleDragStart(item, currentIndex)"
                        @ondragend="() => HandleDragEnd(item)"
                        @ondragover="() => HandleRowDragOver(currentIndex)"
                        @ondragenter="() => HandleRowDragEnter(currentIndex)"
                        @ondragleave="HandleRowDragLeave">
                        
                        @if (ShowRowNumbers)
                        {
                            <td class="text-center text-muted row-number-column">
                                <small>@(currentIndex + 1)</small>
                            </td>
                        }
                        @if (ShowSelectColumn)
                        {
                            <td class="text-center" style="width: @SelectColumnWidth;" @onclick:stopPropagation="true">
                                @{ var isSelectable = IsItemSelectable?.Invoke(item) ?? true; }
                                @if (isSelectable)
                                {
                                    <input type="checkbox" 
                                           class="form-check-input"
                                           checked="@IsItemSelected(item)"
                                           @onchange="e => HandleItemSelectionChanged(item, (bool?)e.Value ?? false)"
                                           title="選取此項目" />
                                }
                                else if (UnselectableTemplate != null)
                                {
                                    @UnselectableTemplate(item)
                                }
                            </td>
                        }
                        
                        @foreach (var column in ColumnDefinitions ?? new List<InteractiveColumnDefinition>())
                        {
                            <td class="@column.CellCssClass @(column.HideOnMobile ? "d-none d-md-table-cell" : "")"
                                style="@(GetCellStyle(column))"
                                @onclick:stopPropagation="@ShouldStopPropagation(column)">
                                
                                @* 根據欄位類型渲染不同的控件 *@
                                @if (column.ColumnType == InteractiveColumnType.Display)
                                {
                                    @* 純顯示文字 *@
                                    var value = GetPropertyValue(item, column.PropertyName);
                                    string displayText;
                                    
                                    if (column.DisplayFormatter != null)
                                    {
                                        // DisplayFormatter 接收整個 item 物件，而不是屬性值
                                        displayText = column.DisplayFormatter(item);
                                    }
                                    else if (value == null)
                                    {
                                        displayText = column.NullDisplayText ?? "-";
                                    }
                                    // 智能數字格式化：整數不顯示小數點，有小數才顯示
                                    else if (column.SmartDecimalDisplay && decimal.TryParse(value.ToString(), out var decimalValue))
                                    {
                                        displayText = decimalValue % 1 == 0 
                                            ? decimalValue.ToString("N0") 
                                            : decimalValue.ToString(column.NumberFormat ?? "N2");
                                    }
                                    // 一般數字格式化
                                    else if (!string.IsNullOrEmpty(column.NumberFormat) && decimal.TryParse(value.ToString(), out var numValue))
                                    {
                                        displayText = numValue.ToString(column.NumberFormat);
                                    }
                                    else
                                    {
                                        displayText = HttpUtility.HtmlEncode(value.ToString() ?? "");
                                    }

                                    <span>@((MarkupString)displayText)</span>
                                }
                                else if (column.ColumnType == InteractiveColumnType.Input)
                                {
                                    @* 文字輸入框 *@
                                    var value = GetPropertyValue(item, column.PropertyName);
                                    var stringValue = value?.ToString() ?? "";
                                    var isDisabled = IsReadOnly || column.IsDisabled;
                                    var validationClass = GetValidationCssClass(item, column.PropertyName);
                                    
                                    <input type="text" 
                                           class="form-control @validationClass" 
                                           value="@stringValue"
                                           placeholder="@column.Placeholder"
                                           title="@column.Tooltip"
                                           disabled="@isDisabled"
                                           readonly="@column.IsReadOnly"
                                           @oninput="async (e) => await HandleInputChange(column, item, e.Value?.ToString())" />
                                }
                                else if (column.ColumnType == InteractiveColumnType.Number)
                                {
                                    @* 數字輸入框 - 智能格式化：整數不顯示小數點 *@
                                    var value = GetPropertyValue(item, column.PropertyName);
                                    var stringValue = "";
                                    
                                    // 智能格式化數字：如果是整數則不顯示小數點，有小數才顯示
                                    if (value != null && decimal.TryParse(value.ToString(), out var decimalValue))
                                    {
                                        if (decimalValue != 0)
                                        {
                                            stringValue = decimalValue % 1 == 0 
                                                ? decimalValue.ToString("F0") 
                                                : decimalValue.ToString();
                                        }
                                    }
                                    
                                    var isDisabled = IsReadOnly || column.IsDisabled || (column.IsDisabledFunc?.Invoke(item!) ?? false);
                                    var validationClass = GetValidationCssClass(item, column.PropertyName);
                                    var tooltip = column.TooltipFunc?.Invoke(item!) ?? column.Tooltip;
                                    
                                    <input type="number" 
                                           class="form-control @validationClass" 
                                           value="@stringValue"
                                           placeholder="@column.Placeholder"
                                           title="@tooltip"
                                           min="@column.MinValue"
                                           max="@column.MaxValue"
                                           step="any"
                                           disabled="@isDisabled"
                                           readonly="@column.IsReadOnly"
                                           onkeydown="if(['e','E','+','-'].includes(event.key)) event.preventDefault();"
                                           @oninput="async (e) => await HandleInputChange(column, item, e.Value?.ToString())" />
                                }
                                else if (column.ColumnType == InteractiveColumnType.Select)
                                {
                                    @* 下拉選單 *@
                                    var value = GetPropertyValue(item, column.PropertyName);
                                    var selectedValue = value?.ToString() ?? "";
                                    var isDisabled = IsReadOnly || column.IsDisabled || (column.IsDisabledFunc?.Invoke(item!) ?? false);
                                    var validationClass = GetValidationCssClass(item, column.PropertyName);
                                    
                                    <select class="form-select @validationClass"
                                            value="@selectedValue"
                                            title="@column.Title"
                                            disabled="@isDisabled"
                                            @onchange="async (e) => await HandleSelectionChange(column, item, e.Value)">
                                        
                                        @if (!string.IsNullOrEmpty(column.Placeholder))
                                        {
                                            <option value="">@column.Placeholder</option>
                                        }
                                        
                                        @if (column.Options != null)
                                        {
                                            @foreach (var option in column.Options)
                                            {
                                                <option value="@option.Value" disabled="@option.IsDisabled">
                                                    @option.Text
                                                </option>
                                            }
                                        }
                                    </select>
                                }
                                else if (column.ColumnType == InteractiveColumnType.SearchableSelect)
                                {
                                    @* 可搜尋下拉選單 *@
                                    var searchValue = GetPropertyValue(item, column.SearchValuePropertyName ?? "")?.ToString() ?? "";
                                    var selectedItem = GetPropertyValue(item, column.SelectedItemPropertyName ?? "");
                                    var filteredItems = GetPropertyValue(item, column.FilteredItemsPropertyName ?? "") as IEnumerable<object> ?? new List<object>();
                                    var showDropdown = GetPropertyValue(item, column.ShowDropdownPropertyName ?? "") is bool showValue && showValue;
                                    var selectedIndex = GetPropertyValue(item, column.SelectedIndexPropertyName ?? "") is int indexValue ? indexValue : -1;
                                    var isDisabled = IsReadOnly || column.IsDisabled || (column.IsDisabledFunc?.Invoke(item!) ?? false);
                                    var validationClass = GetValidationCssClass(item, column.PropertyName);
                                    var tooltip = column.TooltipFunc?.Invoke(item!) ?? column.Tooltip;
                                    
                                    <div class="position-relative">
                                        <input type="text" 
                                               class="form-control @validationClass" 
                                               value="@searchValue"
                                               placeholder="@column.Placeholder"
                                               title="@tooltip"
                                               disabled="@isDisabled"
                                               readonly="@column.IsReadOnly"
                                               @oninput="async (e) => await HandleSearchableSelectInput(column, item, e.Value?.ToString())"
                                               @onfocus="async () => await HandleSearchableSelectFocus(column, item)"
                                               @onblur="async () => await HandleSearchableSelectBlur(column, item)"
                                               @onkeydown="async (e) => await HandleSearchableSelectKeyDown(column, item, e)" />
                                        
                                        @if (showDropdown && filteredItems.Any() && !isDisabled)
                                        {
                                            var dropdownId = $"dropdown-{GetHashCode()}-{currentIndex}";
                                            @* 移除 position-absolute 因為 Bootstrap 使用 !important，會覆蓋 JS 動態設定的 position: fixed *@
                                            @* 改用 inline style 讓 JS 可以動態調整位置，解決手機版下拉選單被裁切的問題 *@
                                            <div class="dropdown-menu show w-auto shadow searchable-dropdown" 
                                                 id="@dropdownId"
                                                 style="position: fixed; z-index: 10000; max-height: @column.DropdownMaxHeight; overflow-y: auto; overflow-x: hidden; border: 1px solid #dee2e6; min-width: @column.DropdownMinWidth; max-width: @column.DropdownMaxWidth;"
                                                 @onmousedown:preventDefault="true">
                                                @{
                                                    var dropdownItemIndex = 0;
                                                }
                                                @foreach (var dropdownItem in filteredItems.Take(column.MaxDisplayItems))
                                                {
                                                    var currentDropdownIndex = dropdownItemIndex;
                                                    var isSelected = selectedIndex == currentDropdownIndex;
                                                    var displayText = column.ItemDisplayFormatter?.Invoke(dropdownItem) ?? dropdownItem.ToString() ?? "";
                                                    var itemId = $"dropdown-item-{GetHashCode()}-{currentIndex}-{currentDropdownIndex}";
                                                    
                                                    <a class="dropdown-item @(isSelected ? "active bg-primary text-white" : "")" 
                                                       id="@itemId"
                                                       href="#" 
                                                       @onclick="async () => await HandleSearchableSelectItemClick(column, item, dropdownItem)" 
                                                       @onclick:preventDefault="true"
                                                       style="cursor: pointer; padding: 8px 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                                                       @onmouseenter="async () => await HandleSearchableSelectItemMouseEnter(column, item, currentDropdownIndex)">
                                                        @((MarkupString)displayText)
                                                    </a>
                                                    dropdownItemIndex++;
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                                else if (column.ColumnType == InteractiveColumnType.Checkbox)
                                {
                                    @* 勾選框 *@
                                    var value = GetPropertyValue(item, column.PropertyName);
                                    var isChecked = value is bool boolValue && boolValue;
                                    var isDisabled = IsReadOnly || column.IsDisabled;
                                    
                                    <div class="form-check form-switch d-flex justify-content-center">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               checked="@isChecked"
                                               title="@column.Title"
                                               disabled="@isDisabled"
                                               @onchange="async (e) => await HandleCheckboxChange(column, item, e.Value)" />
                                    </div>
                                    
                                    @if (!string.IsNullOrEmpty(column.CheckedText) || !string.IsNullOrEmpty(column.UncheckedText))
                                    {
                                        <small class="@(isChecked ? "text-success" : "text-muted")">
                                            @(isChecked ? column.CheckedText : column.UncheckedText)
                                        </small>
                                    }
                                }
                                else if (column.ColumnType == InteractiveColumnType.Button)
                                {
                                    @* 按鈕 *@
                                    var isDisabled = IsReadOnly || column.IsDisabled;
                                    var buttonDisabled = isDisabled || (column.IsButtonDisabled?.Invoke(item!) ?? false);
                                    
                                    <GenericButtonComponent Text="@column.ButtonText"
                                                           IconClass="@column.ButtonIcon"
                                                           Variant="@column.ButtonVariant"
                                                           Size="@column.ButtonSize"
                                                           IsDisabled="@buttonDisabled"
                                                           Title="@column.Title"
                                                           OnClick="async () => await HandleButtonClick(column, item)" />
                                }
                                else if (column.ColumnType == InteractiveColumnType.Custom && column.CustomTemplate != null)
                                {
                                    @* 自訂模板 - 支援鍵盤導航 *@
                                    @if (column.EnableKeyboardNavigation)
                                    {
                                        <div @onkeydown="async (e) => await HandleKeyboardNavigation(column, item, e)">
                                            @column.CustomTemplate(item!)
                                        </div>
                                    }
                                    else
                                    {
                                        @column.CustomTemplate(item!)
                                    }
                                }
                            </td>
                        }
                        
                        @if (ShowActions && ActionsTemplate != null)
                        {
                            <td class="text-center table-actions-column" style="@GetActionsColumnStyle()" @onclick:stopPropagation="true">
                                @ActionsTemplate(item)
                            </td>
                        }
                        @if (ShowBuiltInActions)
                        {
                            <td class="text-center table-actions-column" style="@GetActionsColumnStyle()" @onclick:stopPropagation="true">
                                @GetBuiltInActionsTemplate()(item)
                            </td>
                        }
                    </tr>
                    itemIndex++;
                }
            }
            else
            {
                <tr class="@(_isDragOver && EnableDrop ? "drop-zone-active" : "")">
                    <td colspan="@GetColspan()" class="text-center py-4 text-light-custom @(EnableDrop ? "drop-zone" : "")">
                        @if (_isDragOver && EnableDrop && DragDropState.CanDropTo(DragDropGroup))
                        {
                            @if (DropZoneEmptyTemplate != null)
                            {
                                @DropZoneEmptyTemplate
                            }
                            else
                            {
                                <div class="drop-zone-hint">
                                    <i class="bi bi-plus-circle fa-2x mb-2 text-primary"></i>
                                    <br />
                                    <span class="text-primary">放開以加入項目</span>
                                </div>
                            }
                        }
                        else if (EmptyTemplate != null)
                        {
                            @EmptyTemplate
                        }
                        else
                        {
                            <i class="fas fa-inbox fa-2x mb-2 text-light-custom"></i>
                            <br />
                            @EmptyMessage
                        }
                    </td>
                </tr>
            }
        </tbody>
        @if (ShowTotalRow && Items != null && Items.Any())
        {
            <tfoot>
                <tr class="table-info">
                    @if (ShowRowNumbers)
                    {
                        <th class="row-number-column"></th>
                    }
                    @if (ShowSelectColumn)
                    {
                        <th style="width: @SelectColumnWidth;"></th>
                    }
                    @foreach (var column in ColumnDefinitions ?? new List<InteractiveColumnDefinition>())
                    {
                        <th class="@(column.HideOnMobile ? "d-none d-md-table-cell" : "")" 
                            style="@(GetColumnWidthStyle(column))">
                            @if (TotalRowTemplate != null)
                            {
                                @TotalRowTemplate(column)
                            }
                        </th>
                    }
                    @if (ShowActions)
                    {
                        <th style="@GetActionsColumnStyle()"></th>
                    }
                    @if (ShowBuiltInActions)
                    {
                        <th style="@GetActionsColumnStyle()"></th>
                    }
                </tr>
            </tfoot>
        }
    </table>
</div>

@code {
    #region 參數定義
    [Parameter] public List<TItem>? Items { get; set; }  // 改用 List 以支援自動空行管理
    [Parameter] public List<InteractiveColumnDefinition>? ColumnDefinitions { get; set; }
    [Parameter] public RenderFragment<TItem>? ActionsTemplate { get; set; }
    [Parameter] public RenderFragment? EmptyTemplate { get; set; }
    [Parameter] public RenderFragment<InteractiveColumnDefinition>? TotalRowTemplate { get; set; }
    
    // 自動空行管理參數
    [Parameter] public bool EnableAutoEmptyRow { get; set; } = false;
    [Parameter] public Func<TItem>? CreateEmptyItem { get; set; }
    [Parameter] public bool DataLoadCompleted { get; set; } = true;  // 資料是否已載入完成(預設 true 保持向下兼容)
    [Parameter] public bool AllowAddNewRow { get; set; } = true;  // 是否允許新增空行（預設 true 保持向下兼容）
    
    // 表格樣式設定
    [Parameter] public bool ShowHeader { get; set; } = true;
    [Parameter] public bool ShowActions { get; set; } = false;
    [Parameter] public bool ShowRowNumbers { get; set; } = true;
    [Parameter] public bool ShowTotalRow { get; set; } = false;
    [Parameter] public bool IsStriped { get; set; } = true;
    [Parameter] public bool IsHoverable { get; set; } = true;
    [Parameter] public bool IsBordered { get; set; } = true;
    [Parameter] public bool IsReadOnly { get; set; } = false;
    [Parameter] public string CssClass { get; set; } = string.Empty;
    [Parameter] public string EmptyMessage { get; set; } = "沒有找到資料";
    [Parameter] public string ActionsHeader { get; set; } = "操作";
    [Parameter] public string ActionsColumnWidth { get; set; } = "auto"; // 操作欄位寬度參數：可設定固定值(如"120px")、百分比(如"10%")，或"auto"自動計算
    
    // 行互動設定
    [Parameter] public Func<TItem, int, string>? GetRowCssClass { get; set; }
    [Parameter] public EventCallback<TItem> OnRowClick { get; set; }
    [Parameter] public bool EnableRowClick { get; set; } = false;
    [Parameter] public string RowClickCursor { get; set; } = "pointer";
    
    // 行選取功能設定
    [Parameter] public bool EnableRowSelection { get; set; } = false;
    [Parameter] public bool AllowMultipleSelection { get; set; } = false;
    [Parameter] public HashSet<TItem>? SelectedItems { get; set; }
    [Parameter] public EventCallback<HashSet<TItem>> OnSelectionChanged { get; set; }
    
    // 選取欄位設定（顯示 Checkbox 的獨立欄位）
    [Parameter] public bool ShowSelectColumn { get; set; } = false;                    // 是否顯示選取欄位
    [Parameter] public string SelectColumnWidth { get; set; } = "50px";               // 選取欄位寬度
    [Parameter] public Func<TItem, bool>? IsItemSelectable { get; set; }              // 判斷特定項目是否可選取（null = 全部可選）
    [Parameter] public RenderFragment<TItem>? UnselectableTemplate { get; set; }      // 不可選取時的替代內容
    
    // 驗證相關
    [Parameter] public EventCallback<(TItem item, string propertyName, string? errorMessage)> OnValidationFailed { get; set; }
    [Parameter] public Dictionary<string, string>? ValidationErrors { get; set; }
    
    // 內建操作按鈕相關
    [Parameter] public bool ShowBuiltInActions { get; set; } = false;
    [Parameter] public bool ShowBuiltInDeleteButton { get; set; } = true;
    [Parameter] public string DeleteButtonIcon { get; set; } = "bi bi-trash text-white";
    [Parameter] public ButtonVariant DeleteButtonVariant { get; set; } = ButtonVariant.Red;
    [Parameter] public ButtonSize DeleteButtonSize { get; set; } = ButtonSize.Large;
    [Parameter] public string DeleteButtonTitle { get; set; } = "刪除";
    [Parameter] public Func<TItem, bool>? IsDeleteDisabled { get; set; }
    [Parameter] public EventCallback<TItem> OnItemDelete { get; set; }
    [Parameter] public RenderFragment<TItem>? CustomActionsTemplate { get; set; }
    
    // 拖放功能參數
    [Parameter] public bool EnableDrag { get; set; } = false;                          // 是否可作為拖曳來源
    [Parameter] public bool EnableDrop { get; set; } = false;                          // 是否可作為放置目標
    [Parameter] public string DragDropGroup { get; set; } = "default";                 // 拖放群組識別（相同群組才能互相拖放）
    [Parameter] public string TableId { get; set; } = "";                              // 表格識別碼（用於同表格排序判斷）
    [Parameter] public Func<TItem, bool>? IsDraggable { get; set; }                    // 判斷特定項目是否可拖曳
    [Parameter] public EventCallback<TItem> OnDragStart { get; set; }                  // 拖曳開始事件
    [Parameter] public EventCallback<TItem> OnDragEnd { get; set; }                    // 拖曳結束事件
    [Parameter] public EventCallback<DragDropEventArgs<TItem>> OnItemDropped { get; set; }  // 項目被放置事件（跨表格）
    [Parameter] public EventCallback<(int oldIndex, int newIndex)> OnRowReordered { get; set; } // 行重新排序事件（同表格）
    [Parameter] public RenderFragment? DropZoneEmptyTemplate { get; set; }             // 空放置區域的自訂模板
    #endregion

    #region 私有欄位
    
    // 記錄最後一個空行的參考
    private TItem? _lastEmptyRow = default;
    
    // 標記是否已經執行過首次空行檢查
    private bool _hasInitializedEmptyRow = false;
    
    // 記錄上一次的 DataLoadCompleted 狀態,用於偵測狀態變化
    private bool _previousDataLoadCompleted = false;
    
    // 記錄上一次的非空行數量，用於偵測資料載入
    private int _previousNonEmptyCount = 0;
    
    // 標記是否需要在下次渲染後檢查空行（Items 集合變化時設定）
    private bool _needsEmptyRowCheck = false;
    
    // 拖放相關私有欄位
    private int? _dragOverIndex = null;           // 當前拖曳經過的行索引
    private bool _isDragOver = false;             // 表格是否處於拖曳經過狀態
    private string _uniqueTableId = "";           // 自動生成的表格唯一識別碼
    
    // 全選 checkbox 相關
    private string _selectAllCheckboxId = "";     // 全選 checkbox 的唯一 ID
    
    #endregion

    #region 生命週期方法
    
    protected override void OnInitialized()
    {
        base.OnInitialized();
        
        // 生成唯一表格識別碼（如果沒有指定 TableId）
        _uniqueTableId = !string.IsNullOrEmpty(TableId) ? TableId : $"table-{Guid.NewGuid():N}";
        
        // 生成全選 checkbox 的唯一 ID
        _selectAllCheckboxId = $"select-all-{Guid.NewGuid():N}";
        
        //  不在這裡檢查空行，改到 OnAfterRenderAsync
        // 避免在父組件載入資料之前就新增空行
    }
    
    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        
        //  監控 Items 集合的變化
        if (EnableAutoEmptyRow && Items != null)
        {
            // 計算非空行的數量
            var nonEmptyCount = Items.Count(item => !IsRowEmpty(item));
            
            //  檢測到非空行數量增加（表示父組件載入了資料）
            if (nonEmptyCount > _previousNonEmptyCount)
            {
                _needsEmptyRowCheck = true;
            }
            
            _previousNonEmptyCount = nonEmptyCount;
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        
        // 初始化拖放功能
        if (EnableDrag || EnableDrop)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("reinitDragDrop");
            }
            catch
            {
                // 忽略 JS 初始化錯誤
            }
        }
        
        // 更新全選 checkbox 的 indeterminate 狀態
        if (ShowSelectColumn && AllowMultipleSelection)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("setCheckboxIndeterminate", _selectAllCheckboxId, IsPartiallySelected);
            }
            catch
            {
                // 忽略 JS 錯誤
            }
        }
        
        if (EnableAutoEmptyRow)
        {
            var itemCount = Items?.Count ?? 0;
            var nonEmptyCount = Items?.Count(item => !IsRowEmpty(item)) ?? 0;
        }
        
        //  優先處理：如果標記了需要檢查空行（Items 集合變化觸發）
        if (EnableAutoEmptyRow && _needsEmptyRowCheck)
        {
            _needsEmptyRowCheck = false;
            
            await InvokeAsync(() =>
            {
                CheckAndAddEmptyRowIfNeeded();
                StateHasChanged();
            });
            return;
        }
        
        //  不再使用 firstRender,改為監控 DataLoadCompleted 狀態變化
        if (EnableAutoEmptyRow && DataLoadCompleted && !_previousDataLoadCompleted)
        {
            _previousDataLoadCompleted = DataLoadCompleted;
            
            // 使用 InvokeAsync 確保在正確的同步上下文中執行
            await InvokeAsync(() =>
            {
                CheckAndAddEmptyRowIfNeeded();
                StateHasChanged();
            });
        }
        else if (firstRender && EnableAutoEmptyRow && DataLoadCompleted && !_hasInitializedEmptyRow)
        {
            //  向下兼容:如果父組件沒有控制 DataLoadCompleted(預設 true),使用原有邏輯
            _hasInitializedEmptyRow = true;
            _previousDataLoadCompleted = DataLoadCompleted;

            await InvokeAsync(() =>
            {
                CheckAndAddEmptyRowIfNeeded();
                StateHasChanged();
            });
        }
    }
    
    #endregion

    #region 私有方法
    private string GetTableClass()
    {
        var classes = new List<string>();
        
        if (IsStriped) classes.Add("table-striped");
        if (IsHoverable) classes.Add("table-hover");
        if (IsBordered) classes.Add("table-bordered");
        classes.Add("table-with-column-borders");
        
        if (!string.IsNullOrEmpty(CssClass))
            classes.Add(CssClass);
            
        return string.Join(" ", classes.Where(c => !string.IsNullOrEmpty(c)));
    }

    private string GetHeaderClass()
    {
        return "table-header-primary";
    }

    private string GetRowClass(TItem item, int index)
    {
        var classes = new List<string>();
        
        // 使用者自訂的 CSS class
        if (GetRowCssClass != null)
        {
            var customClass = GetRowCssClass(item, index);
            if (!string.IsNullOrEmpty(customClass))
                classes.Add(customClass);
        }
        
        // 如果啟用選取功能，檢查是否為選取的項目
        if (EnableRowSelection && SelectedItems != null && SelectedItems.Contains(item))
        {
            classes.Add("row-selected");
        }
        
        return string.Join(" ", classes);
    }

    private string? GetColumnWidthStyle(InteractiveColumnDefinition column)
    {
        if (string.IsNullOrEmpty(column.Width))
            return null;
            
        var styles = new List<string> { $"width: {column.Width}" };
        
        // 如果是百分比寬度，添加 min-width 防止過度壓縮
        if (column.Width.EndsWith("%"))
        {
            // 根據百分比大小設定合理的最小寬度
            if (double.TryParse(column.Width.TrimEnd('%'), out var percentage))
            {
                // 較大百分比（>15%）給予較大最小寬度，較小百分比給予較小最小寬度
                var minWidth = percentage >= 15 ? "100px" : percentage >= 10 ? "80px" : "60px";
                styles.Add($"min-width: {minWidth}");
            }
        }
        // 如果是固定像素寬度，同時設定 min-width 確保不被壓縮
        else if (column.Width.EndsWith("px"))
        {
            styles.Add($"min-width: {column.Width}");
        }
        
        return string.Join("; ", styles) + ";";
    }

    /// <summary>
    /// 判斷是否應阻止 click 事件冒泡
    /// 只有可編輯的控件才需要阻止冒泡，以支援行點擊功能
    /// </summary>
    private bool ShouldStopPropagation(InteractiveColumnDefinition column)
    {
        // Display 和 Custom 類型不阻止冒泡，允許 click 傳遞到 <tr>
        // 只有可編輯類型（Input, Select, Checkbox, Date, Number, TextArea）才阻止
        return column.ColumnType switch
        {
            InteractiveColumnType.Display => false,
            InteractiveColumnType.Custom => false,
            InteractiveColumnType.Button => false, // Button 有自己的 click handler，但允許冒泡
            _ => true // 其他可編輯類型阻止冒泡
        };
    }

    private string? GetCellStyle(InteractiveColumnDefinition column)
    {
        var styles = new List<string>();
        
        // 寬度設定
        if (!string.IsNullOrEmpty(column.Width))
        {
            styles.Add($"width: {column.Width}");
            
            // 如果是百分比寬度，添加 min-width 防止過度壓縮
            if (column.Width.EndsWith("%"))
            {
                if (double.TryParse(column.Width.TrimEnd('%'), out var percentage))
                {
                    var minWidth = percentage >= 15 ? "100px" : percentage >= 10 ? "80px" : "60px";
                    styles.Add($"min-width: {minWidth}");
                }
            }
            // 如果是固定像素寬度，同時設定 min-width 確保不被壓縮
            else if (column.Width.EndsWith("px"))
            {
                styles.Add($"min-width: {column.Width}");
            }
        }
        
        // 文字對齊設定 (支援 Display、Button 和 Custom 類型)
        if ((column.ColumnType == InteractiveColumnType.Display || 
             column.ColumnType == InteractiveColumnType.Button || 
             column.ColumnType == InteractiveColumnType.Custom) 
            && !string.IsNullOrEmpty(column.TextAlign))
        {
            styles.Add($"text-align: {column.TextAlign}");
        }
        
        return styles.Any() ? string.Join("; ", styles) + ";" : null;
    }

    private string? GetActionsColumnStyle()
    {
        // 如果有明確設定寬度，直接使用
        if (!string.IsNullOrEmpty(ActionsColumnWidth) && ActionsColumnWidth != "auto")
        {
            return $"width: {ActionsColumnWidth};";
        }
        
        // 自動計算剩餘寬度
        if (ColumnDefinitions != null && ColumnDefinitions.Any())
        {
            var totalUsedPercentage = 0m;
            var hasPercentageColumns = false;
            
            foreach (var column in ColumnDefinitions)
            {
                if (!string.IsNullOrEmpty(column.Width) && column.Width.EndsWith("%"))
                {
                    hasPercentageColumns = true;
                    var percentageStr = column.Width.Replace("%", "");
                    if (decimal.TryParse(percentageStr, out var percentage))
                    {
                        totalUsedPercentage += percentage;
                    }
                }
            }
            
            // 如果有使用百分比的欄位，計算剩餘空間
            if (hasPercentageColumns)
            {
                var remainingPercentage = 100 - totalUsedPercentage;
                
                // 確保至少有 5% 的空間給操作欄位，最多不超過 15%
                var actionsPercentage = Math.Max(5, Math.Min(15, remainingPercentage));
                
                return $"width: {actionsPercentage}%;";
            }
        }
        
        // 預設情況：使用固定寬度
        return "width: 120px;";
    }

    private int GetColspan()
    {
        var columnCount = ColumnDefinitions?.Count ?? 0;
        if (ShowRowNumbers) columnCount++;
        if (ShowSelectColumn) columnCount++;
        if (ShowActions) columnCount++;
        if (ShowBuiltInActions) columnCount++;
        return columnCount;
    }
    
    #region 選取欄位相關方法
    
    /// <summary>
    /// 取得可選取的項目列表
    /// </summary>
    private IEnumerable<TItem> GetSelectableItems()
    {
        if (Items == null) return Enumerable.Empty<TItem>();
        return IsItemSelectable != null 
            ? Items.Where(item => IsItemSelectable(item))
            : Items;
    }
    
    /// <summary>
    /// 是否全部已選取
    /// </summary>
    private bool IsAllSelected
    {
        get
        {
            if (SelectedItems == null || !SelectedItems.Any()) return false;
            var selectableItems = GetSelectableItems().ToList();
            return selectableItems.Any() && selectableItems.All(item => SelectedItems.Contains(item));
        }
    }
    
    /// <summary>
    /// 是否部分選取（用於 indeterminate 狀態）
    /// </summary>
    private bool IsPartiallySelected
    {
        get
        {
            if (SelectedItems == null || !SelectedItems.Any()) return false;
            var selectableItems = GetSelectableItems().ToList();
            var selectedCount = selectableItems.Count(item => SelectedItems.Contains(item));
            return selectedCount > 0 && selectedCount < selectableItems.Count;
        }
    }
    
    /// <summary>
    /// 檢查特定項目是否已選取
    /// </summary>
    private bool IsItemSelected(TItem item)
    {
        return SelectedItems?.Contains(item) ?? false;
    }
    
    /// <summary>
    /// 處理全選/取消全選
    /// </summary>
    private async Task HandleSelectAllChanged(ChangeEventArgs e)
    {
        var isChecked = (bool?)e.Value ?? false;
        
        if (SelectedItems == null)
        {
            SelectedItems = new HashSet<TItem>();
        }
        
        var selectableItems = GetSelectableItems().ToList();
        
        if (isChecked)
        {
            // 全選：添加所有可選取的項目
            foreach (var item in selectableItems)
            {
                SelectedItems.Add(item);
            }
        }
        else
        {
            // 取消全選：移除所有可選取的項目
            foreach (var item in selectableItems)
            {
                SelectedItems.Remove(item);
            }
        }
        
        if (OnSelectionChanged.HasDelegate)
        {
            await OnSelectionChanged.InvokeAsync(SelectedItems);
        }
        
        StateHasChanged();
    }
    
    /// <summary>
    /// 處理單一項目的選取變更
    /// </summary>
    private async Task HandleItemSelectionChanged(TItem item, bool isSelected)
    {
        if (SelectedItems == null)
        {
            SelectedItems = new HashSet<TItem>();
        }
        
        if (isSelected)
        {
            if (AllowMultipleSelection)
            {
                SelectedItems.Add(item);
            }
            else
            {
                // 單選模式：先清除再添加
                SelectedItems.Clear();
                SelectedItems.Add(item);
            }
        }
        else
        {
            SelectedItems.Remove(item);
        }
        
        if (OnSelectionChanged.HasDelegate)
        {
            await OnSelectionChanged.InvokeAsync(SelectedItems);
        }
        
        StateHasChanged();
    }
    
    #endregion

    private async Task HandleRowClick(TItem item)
    {
        // 處理行選取功能
        if (EnableRowSelection)
        {
            if (SelectedItems == null)
            {
                SelectedItems = new HashSet<TItem>();
            }
            
            if (AllowMultipleSelection)
            {
                // 多選模式：切換選取狀態
                if (SelectedItems.Contains(item))
                {
                    SelectedItems.Remove(item);
                }
                else
                {
                    SelectedItems.Add(item);
                }
            }
            else
            {
                // 單選模式：清除其他選取，只選取當前項目
                if (SelectedItems.Contains(item) && SelectedItems.Count == 1)
                {
                    // 如果點擊已選取的唯一項目，則取消選取
                    SelectedItems.Clear();
                }
                else
                {
                    SelectedItems.Clear();
                    SelectedItems.Add(item);
                }
            }
            
            // 通知父組件選取狀態已改變
            if (OnSelectionChanged.HasDelegate)
            {
                await OnSelectionChanged.InvokeAsync(SelectedItems);
            }
            
            StateHasChanged();
        }
        
        // 原有的 OnRowClick 事件
        if (EnableRowClick && OnRowClick.HasDelegate)
        {
            await OnRowClick.InvokeAsync(item);
        }
    }

    private object? GetPropertyValue(TItem item, string propertyName)
    {
        if (item == null || string.IsNullOrEmpty(propertyName))
            return null;

        // 支援巢狀屬性 例如: "Customer.Name"
        var parts = propertyName.Split('.');
        object? currentValue = item;
        
        foreach (var part in parts)
        {
            if (currentValue == null) return null;
            
            var currentType = currentValue.GetType();
            var property = currentType.GetProperty(part);
            
            if (property == null) return null;
            
            currentValue = property.GetValue(currentValue);
        }
        
        return currentValue;
    }

    private void SetPropertyValue(TItem item, string propertyName, object? value)
    {
        if (item == null || string.IsNullOrEmpty(propertyName))
            return;

        try
        {
            var parts = propertyName.Split('.');
            object? currentObj = item;
            
            // 找到最後一個物件
            for (int i = 0; i < parts.Length - 1; i++)
            {
                if (currentObj == null) return;
                
                var property = currentObj.GetType().GetProperty(parts[i]);
                if (property == null) return;
                
                currentObj = property.GetValue(currentObj);
            }
            
            if (currentObj == null) return;
            
            // 設定最後的屬性值
            var finalProperty = currentObj.GetType().GetProperty(parts.Last());
            if (finalProperty != null && finalProperty.CanWrite)
            {
                // 型別轉換
                var convertedValue = ConvertValue(value, finalProperty.PropertyType);
                finalProperty.SetValue(currentObj, convertedValue);
            }
        }
        catch
        {
            // 忽略設定屬性值失敗
        }
    }

    private object? ConvertValue(object? value, Type targetType)
    {
        if (value == null)
            return targetType.IsValueType ? Activator.CreateInstance(targetType) : null;

        if (targetType.IsAssignableFrom(value.GetType()))
            return value;

        // 處理 Nullable 型別
        var underlyingType = Nullable.GetUnderlyingType(targetType) ?? targetType;

        try
        {
            if (underlyingType == typeof(bool) && value is string strValue)
            {
                return bool.TryParse(strValue, out var boolResult) ? boolResult : false;
            }

            return Convert.ChangeType(value, underlyingType);
        }
        catch
        {
            return targetType.IsValueType ? Activator.CreateInstance(targetType) : null;
        }
    }

    private async Task ValidateField(TItem item, InteractiveColumnDefinition column, string? value)
    {
        if (column.IsRequired && string.IsNullOrWhiteSpace(value))
        {
            await OnValidationFailed.InvokeAsync((item, column.PropertyName, $"{column.Title} 為必填欄位"));
            return;
        }

        if (!string.IsNullOrEmpty(column.ValidationPattern) && !string.IsNullOrWhiteSpace(value))
        {
            var regex = new System.Text.RegularExpressions.Regex(column.ValidationPattern);
            if (!regex.IsMatch(value))
            {
                await OnValidationFailed.InvokeAsync((item, column.PropertyName, $"{column.Title} 格式不正確"));
                return;
            }
        }

        if (column.ColumnType == InteractiveColumnType.Number && !string.IsNullOrWhiteSpace(value))
        {
            if (decimal.TryParse(value, out var numValue))
            {
                if (column.MinValue.HasValue && numValue < column.MinValue.Value)
                {
                    await OnValidationFailed.InvokeAsync((item, column.PropertyName, $"{column.Title} 不能小於 {column.MinValue.Value}"));
                    return;
                }

                if (column.MaxValue.HasValue && numValue > column.MaxValue.Value)
                {
                    await OnValidationFailed.InvokeAsync((item, column.PropertyName, $"{column.Title} 不能大於 {column.MaxValue.Value}"));
                    return;
                }
            }
            else
            {
                await OnValidationFailed.InvokeAsync((item, column.PropertyName, $"{column.Title} 必須為有效數字"));
                return;
            }
        }
    }

    private string GetValidationCssClass(TItem item, string propertyName)
    {
        if (ValidationErrors?.ContainsKey($"{item?.GetHashCode()}_{propertyName}") == true)
        {
            return "is-invalid";
        }
        return "";
    }
    
    #region 自動空行管理方法
    
    /// <summary>
    /// 檢查指定項目是否為空行
    /// 規則：
    /// 1. 如果有欄位設定 TriggerEmptyRowOnFilled，只檢查這些「觸發欄位」是否都為空
    /// 2. 如果沒有觸發欄位，則檢查所有可編輯且未排除的欄位
    /// </summary>
    private bool IsRowEmpty(TItem item)
    {
        if (item == null || ColumnDefinitions == null) return true;
        
        //  優先檢查是否有設定 TriggerEmptyRowOnFilled 的欄位
        var triggerFields = ColumnDefinitions
            .Where(c => c.TriggerEmptyRowOnFilled)
            .ToList();
        
        if (triggerFields.Any())
        {
            //  檢查所有觸發欄位：必須所有觸發欄位都有值，才不是空行
            foreach (var field in triggerFields)
            {
                var propertyName = !string.IsNullOrEmpty(field.EmptyCheckPropertyName)
                    ? field.EmptyCheckPropertyName
                    : field.PropertyName;
                
                if (string.IsNullOrEmpty(propertyName))
                {
                    continue;
                }
                
                var value = GetPropertyValue(item, propertyName);
                var isEmpty = IsValueNullOrEmpty(value);
                
                //  只要有一個觸發欄位是空的，整行就是空行
                if (isEmpty)
                {
                    return true;
                }
            }
            
            return false;
        }
        
        //  沒有觸發欄位，使用原有邏輯：檢查所有可編輯且未排除的欄位
        var columnsToCheck = ColumnDefinitions
            .Where(c => !c.IsReadOnly && !c.ExcludeFromEmptyCheck)
            .ToList();
        
        // 沒有可檢查的欄位，視為非空行
        if (!columnsToCheck.Any()) return false;
        
        // 檢查每個欄位
        foreach (var column in columnsToCheck)
        {
            var propertyNameToCheck = !string.IsNullOrEmpty(column.EmptyCheckPropertyName)
                ? column.EmptyCheckPropertyName
                : column.PropertyName;
            
            if (string.IsNullOrEmpty(propertyNameToCheck)) continue;
            
            var value = GetPropertyValue(item, propertyNameToCheck);
            
            // 只要有一個欄位有值，就不是空行
            if (!IsValueNullOrEmpty(value))
            {
                return false;
            }
        }
        
        return true;
    }
    
    /// <summary>
    /// 判斷值是否為 null 或 empty
    /// 規則：
    /// - null → 空
    /// - string: "" 或 whitespace → 空
    /// - 數字類型: 0 → 空（因為數字欄位預設值是 0，應視為未填寫）
    /// - 布林: false → 空
    /// - 其他類型：只要不是 null 就算有值
    /// <summary>
    /// 判斷值是否為 null 或 empty
    /// 規則：
    /// - null → 空
    /// - string: "" 或 whitespace → 空
    /// - 其他類型：只要不是 null 就算有值
    /// </summary>
    private bool IsValueNullOrEmpty(object? value)
    {
        if (value == null) return true;
        if (value is string str) return string.IsNullOrWhiteSpace(str);
        
        // 其他類型：不是 null 就算有值（數字 0、false 等都算有值）
        // 因為使用 TriggerEmptyRowOnFilled，不再需要將 0 視為空值
        return false;
    }
    
    /// <summary>
    /// 檢查是否有空行存在
    /// </summary>
    private bool HasEmptyRow()
    {
        return Items?.Any(IsRowEmpty) ?? false;
    }
    
    /// <summary>
    /// 統一的空行檢查和管理方法
    /// 核心邏輯：
    /// 1. 當 AllowAddNewRow=true 時，確保至少有一個空行且在最後
    /// 2. 當 AllowAddNewRow=false 時，移除所有空行
    /// </summary>
    private void CheckAndAddEmptyRowIfNeeded()
    {
        if (!EnableAutoEmptyRow || CreateEmptyItem == null || Items == null) 
        {
            return;
        }
        
        //  找出所有空行
        var emptyRows = Items.Where(IsRowEmpty).ToList();
        
        // 當不允許新增時，移除所有空行
        if (!AllowAddNewRow)
        {
            if (emptyRows.Any())
            {
                foreach (var emptyRow in emptyRows)
                {
                    Items.Remove(emptyRow);
                }
                _lastEmptyRow = default;
            }
            return;
        }
        
        // 當允許新增時，確保有且只有一個空行在最後
        if (emptyRows.Count == 0)
        {
            var newEmptyRow = CreateEmptyItem();
            Items.Add(newEmptyRow);
            _lastEmptyRow = newEmptyRow;
        }
        else if (emptyRows.Count > 1 || !Equals(Items.Last(), emptyRows[0]))
        {
            foreach (var emptyRow in emptyRows)
            {
                Items.Remove(emptyRow);
            }
            
            var newEmptyRow = CreateEmptyItem();
            Items.Add(newEmptyRow);
            _lastEmptyRow = newEmptyRow;
        }
        else
        {
            // 只有一個空行且在最後,不需要處理
            _lastEmptyRow = emptyRows[0];
        }
    }
    
    /// <summary>
    /// 確保至少有一個空行（向下兼容）
    /// </summary>
    private void EnsureOneEmptyRow()
    {
        CheckAndAddEmptyRowIfNeeded();
    }
    
    /// <summary>
    /// 在輸入變更後，自動檢查並新增空行
    /// </summary>
    private void AutoAddEmptyRowIfNeeded()
    {
        CheckAndAddEmptyRowIfNeeded();
    }
    
    #endregion
    
    #region 公開方法
    
    /// <summary>
    /// 公開方法：手動刷新空行檢查
    /// 適用於父組件批量載入或清空資料後，需要確保空行存在的場景
    /// </summary>
    public void RefreshEmptyRow()
    {
        if (!EnableAutoEmptyRow || !AllowAddNewRow) return;
        
        // 重置最後空行的參考
        _lastEmptyRow = default;
        
        // 執行空行檢查
        CheckAndAddEmptyRowIfNeeded();
        
        // 手動觸發更新（因為是外部呼叫）
        StateHasChanged();
    }
    
    #endregion
    
    #endregion
    #region 事件處理方法
    private async Task HandleInputChange(InteractiveColumnDefinition column, TItem item, string? value)
    {
        // 記錄變更前的狀態
        var wasEmpty = EnableAutoEmptyRow ? IsRowEmpty(item) : false;
        var fieldWasEmpty = EnableAutoEmptyRow && column.TriggerEmptyRowOnFilled 
            ? IsValueNullOrEmpty(GetPropertyValue(item, column.PropertyName)) 
            : false;
        await ValidateField(item, column, value);
        SetPropertyValue(item, column.PropertyName, value);
        
        if (column.OnInputChanged.HasValue)
        {
            await column.OnInputChanged.Value.InvokeAsync((item!, value));
        }
        
        //  新邏輯：如果這個欄位設定為觸發欄位，優先使用欄位級別的觸發
        if (EnableAutoEmptyRow && column.TriggerEmptyRowOnFilled)
        {
            var fieldHasValueNow = !IsValueNullOrEmpty(value);

            // 整行原本是空的 && 這個欄位原本是空的 && 這個欄位現在有值 → 觸發新增空行
            if (wasEmpty && fieldWasEmpty && fieldHasValueNow)
            {
                AutoAddEmptyRowIfNeeded();
                return;
            }
        }
        
        // 檢查變更後的整行狀態
        var isEmptyNow = EnableAutoEmptyRow ? IsRowEmpty(item) : false;
        
        //  原有邏輯：整行從空變非空時，檢查是否需要新增空行
        if (EnableAutoEmptyRow && wasEmpty && !isEmptyNow)
        {
            AutoAddEmptyRowIfNeeded();
        }
    }

    private async Task HandleSelectionChange(InteractiveColumnDefinition column, TItem item, object? value)
    {
        // 記錄變更前的狀態
        var wasEmpty = EnableAutoEmptyRow ? IsRowEmpty(item) : false;
        var fieldWasEmpty = EnableAutoEmptyRow && column.TriggerEmptyRowOnFilled 
            ? IsValueNullOrEmpty(GetPropertyValue(item, column.PropertyName)) 
            : false;
        
        SetPropertyValue(item, column.PropertyName, value);
        
        if (column.OnSelectionChanged.HasValue)
        {
            await column.OnSelectionChanged.Value.InvokeAsync((item!, value));
        }
        
        //  如果這個欄位設定為觸發欄位，優先使用欄位級別的觸發
        if (EnableAutoEmptyRow && column.TriggerEmptyRowOnFilled)
        {
            var fieldHasValueNow = !IsValueNullOrEmpty(value);
            
            // 整行原本是空的 && 這個欄位原本是空的 && 這個欄位現在有值 → 觸發新增空行
            if (wasEmpty && fieldWasEmpty && fieldHasValueNow)
            {
                AutoAddEmptyRowIfNeeded();
                return;
            }
        }
        
        //  原有邏輯：整行從空變非空時，檢查是否需要新增空行
        var isEmptyNow = EnableAutoEmptyRow ? IsRowEmpty(item) : false;
        if (EnableAutoEmptyRow && wasEmpty && !isEmptyNow)
        {
            AutoAddEmptyRowIfNeeded();
        }
    }

    private async Task HandleCheckboxChange(InteractiveColumnDefinition column, TItem item, object? value)
    {
        //  記錄變更前的狀態
        var wasEmpty = EnableAutoEmptyRow ? IsRowEmpty(item) : false;
        
        var isChecked = value is bool boolValue && boolValue;
        SetPropertyValue(item, column.PropertyName, isChecked);
        
        if (column.OnCheckboxChanged.HasValue)
        {
            await column.OnCheckboxChanged.Value.InvokeAsync((item!, isChecked));
        }
        
        //  只有當這一行從空變非空時，才檢查是否需要新增空行
        if (EnableAutoEmptyRow && wasEmpty && !IsRowEmpty(item))
        {
            AutoAddEmptyRowIfNeeded();
        }
    }

    private async Task HandleButtonClick(InteractiveColumnDefinition column, TItem item)
    {
        if (column.OnButtonClick.HasValue)
        {
            await column.OnButtonClick.Value.InvokeAsync(item!);
        }
    }
    
    private RenderFragment<TItem> GetBuiltInActionsTemplate()
    {
        return item => __builder =>
        {
            <div class="d-flex align-items-center justify-content-center h-100">
                @if (CustomActionsTemplate != null)
                {
                    @CustomActionsTemplate(item)
                }
                @if (ShowBuiltInDeleteButton)
                {
                    var isDeleteDisabled = IsReadOnly || (IsDeleteDisabled?.Invoke(item) ?? false);
                    <GenericButtonComponent Variant="@DeleteButtonVariant"
                                           IconClass="@DeleteButtonIcon"
                                           Size="@DeleteButtonSize"
                                           IsDisabled="@isDeleteDisabled"
                                           Title="@DeleteButtonTitle"
                                           OnClick="async () => await HandleBuiltInDelete(item)"
                                           StopPropagation="true"
                                           CssClass="btn-square" />
                }
            </div>
        };
    }
    
    private async Task HandleBuiltInDelete(TItem item)
    {
        if (OnItemDelete.HasDelegate)
        {
            await OnItemDelete.InvokeAsync(item);
            
            // 自動空行管理：確保刪除後還有空行
            EnsureOneEmptyRow();
        }
    }
    
    #region 鍵盤導航相關方法
    /// <summary>
    /// 處理鍵盤導航事件
    /// </summary>
    private async Task HandleKeyboardNavigation(InteractiveColumnDefinition column, TItem item, KeyboardEventArgs e)
    {
        if (!column.EnableKeyboardNavigation || column.GetDropdownItems == null || 
            column.GetShowDropdown == null || column.SetSelectedIndex == null || 
            column.GetSelectedIndex == null || column.SetShowDropdown == null)
            return;

        var dropdownItems = column.GetDropdownItems(item!).ToList();
        var showDropdown = column.GetShowDropdown(item!);
        var selectedIndex = column.GetSelectedIndex(item!);

        if (!showDropdown || !dropdownItems.Any())
            return;

        switch (e.Key)
        {
            case "ArrowDown":
                var newDownIndex = Math.Min(selectedIndex + 1, dropdownItems.Count - 1);
                column.SetSelectedIndex(item!, newDownIndex);
                await ScrollSelectedItemIntoView(column, item, newDownIndex);
                StateHasChanged();
                break;
                
            case "ArrowUp":
                var newUpIndex = Math.Max(selectedIndex - 1, 0);
                column.SetSelectedIndex(item!, newUpIndex);
                await ScrollSelectedItemIntoView(column, item, newUpIndex);
                StateHasChanged();
                break;
                
            case "Enter":
                if (selectedIndex >= 0 && selectedIndex < dropdownItems.Count)
                {
                    var selectedItem = dropdownItems[selectedIndex];
                    
                    //  記錄變更前的狀態（用於自動空行檢查）
                    var wasEmpty = EnableAutoEmptyRow ? IsRowEmpty(item) : false;
                    
                    // 優先使用 OnDropdownItemSelected（向下兼容）
                    if (column.OnDropdownItemSelected.HasValue)
                    {
                        await column.OnDropdownItemSelected.Value.InvokeAsync((item!, selectedItem));
                    }
                    // SearchableSelect 使用 OnItemSelected
                    else if (column.ItemSelectedAction != null)
                    {
                        column.ItemSelectedAction(item!, selectedItem);
                    }
                    else if (column.ItemSelectedCallback.HasValue)
                    {
                        await column.ItemSelectedCallback.Value.InvokeAsync((item!, selectedItem));
                    }
                    else if (column.OnItemSelected.HasValue)
                    {
                        await column.OnItemSelected.Value.InvokeAsync((item!, selectedItem));
                    }
                    
                    // 關閉下拉選單
                    column.SetShowDropdown(item!, false);
                    column.SetSelectedIndex(item!, -1);
                    
                    //  只有當這一行從空變非空時，才檢查是否需要新增空行
                    if (EnableAutoEmptyRow && wasEmpty && !IsRowEmpty(item))
                    {
                        AutoAddEmptyRowIfNeeded();
                    }
                    
                    StateHasChanged();
                }
                break;
                
            case "Escape":
                column.SetShowDropdown(item!, false);
                column.SetSelectedIndex(item!, -1);
                StateHasChanged();
                break;
        }
    }

    /// <summary>
    /// 判斷是否為導航按鍵（用於 preventDefault）
    /// </summary>
    private bool IsNavigationKey(KeyboardEventArgs e)
    {
        return e.Key is "ArrowDown" or "ArrowUp" or "Enter" or "Escape";
    }

    /// <summary>
    /// 將選中的項目捲動到可視範圍內
    /// </summary>
    private async Task ScrollSelectedItemIntoView(InteractiveColumnDefinition column, TItem item, int selectedIndex)
    {
        try
        {
            var currentIndex = Items?.ToList().IndexOf(item) ?? 0;
            var dropdownId = $"dropdown-{GetHashCode()}-{currentIndex}";
            var itemId = $"dropdown-item-{GetHashCode()}-{currentIndex}-{selectedIndex}";
            
            await JSRuntime.InvokeVoidAsync("scrollDropdownItemIntoView", dropdownId, itemId);
        }
        catch (Exception)
        {
            // 忽略 JavaScript 錯誤
        }
    }
    #endregion
    #endregion
    
    #region SearchableSelect 事件處理方法
    private async Task HandleSearchableSelectInput(InteractiveColumnDefinition column, TItem item, string? value)
    {
        //  記錄變更前的狀態
        var wasEmpty = EnableAutoEmptyRow ? IsRowEmpty(item) : false;
        
        // 優先使用 Action 委託（來自 SearchableSelectHelper）
        if (column.SearchInputChangedAction != null)
        {
            column.SearchInputChangedAction(item!, value);
        }
        else if (column.SearchInputChangedCallback.HasValue)
        {
            await column.SearchInputChangedCallback.Value.InvokeAsync((item!, value));
        }
        else if (column.OnSearchInputChanged.HasValue)
        {
            await column.OnSearchInputChanged.Value.InvokeAsync((item!, value));
        }
        
        //  只有當這一行從空變非空時，才檢查是否需要新增空行
        // 注意：SearchableSelect 通常不會在輸入時就改變空行狀態，而是在選擇項目時
        if (EnableAutoEmptyRow && wasEmpty && !IsRowEmpty(item))
        {
            AutoAddEmptyRowIfNeeded();
        }
    }
    
    private async Task HandleSearchableSelectFocus(InteractiveColumnDefinition column, TItem item)
    {
        // 優先使用 Action 委託（來自 SearchableSelectHelper）
        if (column.InputFocusAction != null)
        {
            column.InputFocusAction(item!);
        }
        else if (column.InputFocusCallback.HasValue)
        {
            await column.InputFocusCallback.Value.InvokeAsync(item!);
        }
        else if (column.OnInputFocus.HasValue)
        {
            await column.OnInputFocus.Value.InvokeAsync(item!);
        }
    }
    
    private async Task HandleSearchableSelectBlur(InteractiveColumnDefinition column, TItem item)
    {
        // 優先使用 Action 委託（來自 SearchableSelectHelper）
        if (column.InputBlurAction != null)
        {
            column.InputBlurAction(item!);
        }
        else if (column.InputBlurCallback.HasValue)
        {
            await column.InputBlurCallback.Value.InvokeAsync(item!);
        }
        else if (column.OnInputBlur.HasValue)
        {
            await column.OnInputBlur.Value.InvokeAsync(item!);
        }
    }
    
    private async Task HandleSearchableSelectItemClick(InteractiveColumnDefinition column, TItem item, object selectedItem)
    {
        //  記錄變更前的狀態
        var wasEmpty = EnableAutoEmptyRow ? IsRowEmpty(item) : false;
        
        // 優先使用 Action 委託（來自 SearchableSelectHelper）
        if (column.ItemSelectedAction != null)
        {
            column.ItemSelectedAction(item!, selectedItem);
        }
        else if (column.ItemSelectedCallback.HasValue)
        {
            await column.ItemSelectedCallback.Value.InvokeAsync((item!, selectedItem));
        }
        else if (column.OnItemSelected.HasValue)
        {
            await column.OnItemSelected.Value.InvokeAsync((item!, selectedItem));
        }
        
        //  只有當這一行從空變非空時，才檢查是否需要新增空行
        if (EnableAutoEmptyRow && wasEmpty && !IsRowEmpty(item))
        {
            AutoAddEmptyRowIfNeeded();
        }
    }
    
    private async Task HandleSearchableSelectItemMouseEnter(InteractiveColumnDefinition column, TItem item, int index)
    {
        // 優先使用 Action 委託（來自 SearchableSelectHelper）
        if (column.ItemMouseEnterAction != null)
        {
            column.ItemMouseEnterAction(item!, index);
        }
        else if (column.ItemMouseEnterCallback.HasValue)
        {
            await column.ItemMouseEnterCallback.Value.InvokeAsync((item!, index));
        }
        else if (column.OnItemMouseEnter.HasValue)
        {
            await column.OnItemMouseEnter.Value.InvokeAsync((item!, index));
        }
    }
    
    private async Task HandleSearchableSelectKeyDown(InteractiveColumnDefinition column, TItem item, KeyboardEventArgs e)
    {
        if (column.EnableKeyboardNavigation)
        {
            // 防止預設行為（對導航鍵）
            if (IsNavigationKey(e))
            {
                await HandleKeyboardNavigation(column, item, e);
            }
        }
    }
    #endregion
    
    #region 拖放事件處理方法
    
    /// <summary>
    /// 取得表格 tbody 的 CSS class
    /// </summary>
    private string GetTableBodyClass()
    {
        var classes = new List<string>();
        if (EnableDrop && _isDragOver && DragDropState.CanDropTo(DragDropGroup))
        {
            classes.Add("drop-target-active");
        }
        return string.Join(" ", classes);
    }
    
    /// <summary>
    /// 取得行的樣式（含拖曳游標）
    /// </summary>
    private string GetRowStyle(bool canDrag)
    {
        var styles = new List<string>();
        
        // 拖曳游標優先（因為拖曳是主要互動）
        if (canDrag)
        {
            styles.Add("cursor: grab");
        }
        else if (EnableRowClick || EnableRowSelection)
        {
            styles.Add($"cursor: {RowClickCursor}");
        }
        
        return string.Join("; ", styles);
    }
    
    /// <summary>
    /// 取得行的拖放相關 CSS class
    /// </summary>
    private string GetDragDropRowClass(TItem item, int index)
    {
        var classes = new List<string>();
        
        // 正在被拖曳的行
        if (EnableDrag && DragDropState.IsDragging && 
            DragDropState.SourceTableId == _uniqueTableId && 
            DragDropState.DraggedIndex == index)
        {
            classes.Add("dragging");
        }
        
        // 拖曳經過的目標行（用於排序時顯示插入位置）
        if (EnableDrop && _dragOverIndex == index && DragDropState.CanDropTo(DragDropGroup))
        {
            classes.Add("drag-over");
        }
        
        return string.Join(" ", classes);
    }
    
    /// <summary>
    /// 處理拖曳開始
    /// </summary>
    private async Task HandleDragStart(TItem item, int index)
    {
        if (!EnableDrag) return;
        
        DragDropState.StartDrag(item!, DragDropGroup, index, _uniqueTableId);
        
        if (OnDragStart.HasDelegate)
        {
            await OnDragStart.InvokeAsync(item);
        }
        
        StateHasChanged();
    }
    
    /// <summary>
    /// 處理拖曳結束
    /// </summary>
    private async Task HandleDragEnd(TItem item)
    {
        if (!EnableDrag) return;
        
        DragDropState.EndDrag();
        _dragOverIndex = null;
        _isDragOver = false;
        
        if (OnDragEnd.HasDelegate)
        {
            await OnDragEnd.InvokeAsync(item);
        }
        
        StateHasChanged();
    }
    
    /// <summary>
    /// 處理表格層級的 dragover
    /// </summary>
    private void HandleTableDragOver()
    {
        if (!EnableDrop || !DragDropState.CanDropTo(DragDropGroup)) return;
        
        _isDragOver = true;
        StateHasChanged();
    }
    
    /// <summary>
    /// 處理表格層級的 dragleave
    /// </summary>
    private void HandleTableDragLeave()
    {
        _isDragOver = false;
        _dragOverIndex = null;
        StateHasChanged();
    }
    
    /// <summary>
    /// 處理行層級的 dragover
    /// </summary>
    private void HandleRowDragOver(int index)
    {
        if (!EnableDrop || !DragDropState.CanDropTo(DragDropGroup)) return;
        
        _dragOverIndex = index;
    }
    
    /// <summary>
    /// 處理行層級的 dragenter
    /// </summary>
    private void HandleRowDragEnter(int index)
    {
        if (!EnableDrop || !DragDropState.CanDropTo(DragDropGroup)) return;
        
        _dragOverIndex = index;
        StateHasChanged();
    }
    
    /// <summary>
    /// 處理行層級的 dragleave
    /// </summary>
    private void HandleRowDragLeave()
    {
        // 不清除 _dragOverIndex，因為可能立即進入另一行
    }
    
    /// <summary>
    /// 處理放置事件
    /// </summary>
    private async Task HandleTableDrop()
    {
        if (!EnableDrop || !DragDropState.CanDropTo(DragDropGroup)) return;
        
        var draggedItem = DragDropState.DraggedItem;
        var sourceIndex = DragDropState.DraggedIndex;
        var isFromSameTable = DragDropState.IsFromSameTable(_uniqueTableId);
        var targetIndex = _dragOverIndex;
        
        if (draggedItem == null) return;
        
        // 同表格排序
        if (isFromSameTable && sourceIndex.HasValue && targetIndex.HasValue && OnRowReordered.HasDelegate)
        {
            if (sourceIndex.Value != targetIndex.Value)
            {
                await OnRowReordered.InvokeAsync((sourceIndex.Value, targetIndex.Value));
            }
        }
        // 跨表格放置
        else if (!isFromSameTable && OnItemDropped.HasDelegate)
        {
            var args = new DragDropEventArgs<TItem>
            {
                DroppedItem = draggedItem,
                TargetIndex = targetIndex,
                SourceTableId = DragDropState.SourceTableId ?? "",
                TargetTableId = _uniqueTableId
            };
            
            await OnItemDropped.InvokeAsync(args);
        }
        
        // 清除狀態
        DragDropState.EndDrag();
        _dragOverIndex = null;
        _isDragOver = false;
        
        StateHasChanged();
    }
    
    #endregion
}
