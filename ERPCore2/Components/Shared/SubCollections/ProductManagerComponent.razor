
@using Microsoft.EntityFrameworkCore
@using System.Linq.Expressions
@using System.Reflection
@using ERPCore2.Data.Enums
@inject IProductService ProductService
@typeparam TMainEntity where TMainEntity : BaseEntity
@typeparam TDetailEntity where TDetailEntity : BaseEntity, new()

    @if (ProductItems != null && ProductItems.Any())
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        @if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
                        {
                            <th width="100%">請先選擇供應商後再新增商品</th>
                        }
                        else
                        {
                            <th width="35%">商品</th>
                            <th width="15%">數量</th>
                            <th width="15%">價格</th>
                            <th width="30%" class="d-none d-sm-table-cell">備註</th>
                            <th width="5%">操作</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in ProductItems)
                    {
                        var isEmptyRow = IsEmptyRow(item);
                        <tr class="@(isEmptyRow ? "table-light" : "")">
                            @if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
                            {
                                <td class="text-center py-4">
                                    <div class="supplier-warning">
                                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                        <span class="text-muted">請先選擇供應商...</span>
                                    </div>
                                </td>
                            }
                            else
                            {
                                <td>
                                    <div class="position-relative">
                                        <input type="text" class="form-control form-control-sm @(isEmptyRow ? "empty-row-input" : "")" 
                                               value="@item.ProductSearch"
                                               @oninput="(e) => OnProductSearchInput(item, e.Value?.ToString())"
                                               @onfocus="() => OnInputFocus(item)"
                                               @onkeydown="(e) => OnKeyDown(item, e)"
                                               placeholder="@GetProductInputPlaceholder(isEmptyRow)" />
                                        
                                        @if (item.ShowDropdown && FilteredProducts != null && FilteredProducts.Any())
                                        {
                                            <div class="dropdown-menu show position-absolute w-100" style="z-index: 1000; max-height: 200px; overflow-y: auto;">
                                                @for (int i = 0; i < FilteredProducts.Count; i++)
                                                {
                                                    var product = FilteredProducts[i];
                                                    var index = i;
                                                    <a class="dropdown-item @(item.SelectedIndex == index ? "active" : "")" 
                                                       href="#" 
                                                       @onclick="() => SelectProduct(item, product)" 
                                                       @onclick:preventDefault="true">
                                                        <strong>@product.Code</strong> - @product.Name
                                                    </a>
                                                }
                                            </div>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <input type="number" class="form-control form-control-sm" 
                                           value="@item.Quantity"
                                           @onfocus="() => OnInputFocus(item)"
                                           @oninput="(e) => OnQuantityInput(item, e.Value?.ToString())"
                                           placeholder="@GetQuantityPlaceholder(isEmptyRow)" 
                                           min="0" 
                                           step="1" />
                                </td>
                                <td>
                                    <input type="number" class="form-control form-control-sm" 
                                           value="@item.Price"
                                           @onfocus="() => OnInputFocus(item)"
                                           @oninput="(e) => OnPriceInput(item, e.Value?.ToString())"
                                           placeholder="@GetPricePlaceholder(isEmptyRow)" 
                                           min="0" 
                                           step="0.01" />
                                </td>
                                <td>
                                    <input type="text" class="form-control form-control-sm" 
                                           value="@item.Remarks"
                                           @onfocus="() => OnInputFocus(item)"
                                           @oninput="(e) => OnRemarksInput(item, e.Value?.ToString())"
                                           placeholder="@GetRemarksPlaceholder(isEmptyRow)" />
                                </td>
                                <td>
                                    <button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => RemoveItem(item)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            }
                        </tr>
                    }
                </tbody>
                @if (SelectedSupplierId.HasValue && SelectedSupplierId.Value > 0)
                {
                    <tfoot>
                        <tr class="total-row">
                            <th colspan="2">總計</th>
                            <th class="text-end total-amount">@GetTotalAmount().ToString("C")</th>
                            <th class="d-none d-sm-table-cell" colspan="2"></th>
                            <th class="d-sm-none"></th>
                        </tr>
                    </tfoot>
                }
            </table>
        </div>
    }
    else
    {
        <div class="text-center text-muted py-4">
            <i class="fas fa-box-open fa-3x mb-3"></i>
            <p>尚無商品資料，點擊上方按鈕新增商品</p>
        </div>
    }

<style>
    /* 移動端表格優化 */
    .table-responsive {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    /* 小螢幕優化 */
    @@media (max-width: 768px) {
        .table-responsive table {
            min-width: 600px; /* 設定最小寬度確保可讀性 */
        }
        
        .table th,
        .table td {
            padding: 0.5rem 0.25rem; /* 減少padding以節省空間 */
            font-size: 0.875rem; /* 稍微縮小字體 */
            white-space: nowrap; /* 防止文字換行 */
        }
        
        /* 優化輸入框在小螢幕的顯示 */
        .form-control-sm {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        
        /* 優化按鈕在小螢幕的顯示 */
        .btn-sm {
            padding: 0.2rem 0.4rem;
            font-size: 0.75rem;
        }
        
        /* 商品搜尋下拉選單優化 */
        .dropdown-menu {
            font-size: 0.875rem;
            max-height: 150px; /* 限制下拉選單高度 */
        }
        
        .dropdown-item {
            padding: 0.375rem 0.75rem;
        }
        
        /* 移動端總計卡片樣式 */
        .card {
            border: 1px solid #dee2e6;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
    }
    
    /* 超小螢幕額外優化 */
    @@media (max-width: 576px) {
        .table th:nth-child(4), /* 備註欄 */
        .table td:nth-child(4) {
            display: none !important; /* 在很小的螢幕隱藏備註欄 */
        }
        
        .table th:nth-child(5), /* 操作欄 */
        .table td:nth-child(5) {
            width: 60px; /* 固定操作欄寬度 */
            min-width: 60px;
        }
        
        .table th:nth-child(1), /* 商品欄 */
        .table td:nth-child(1) {
            min-width: 200px; /* 確保商品欄有足夠寬度 */
        }
        
        .table th:nth-child(2), /* 數量欄 */
        .table td:nth-child(2) {
            width: 80px;
            min-width: 80px;
        }
        
        .table th:nth-child(3), /* 價格欄 */
        .table td:nth-child(3) {
            width: 90px;
            min-width: 90px;
        }
        
        .table-responsive table {
            min-width: 450px; /* 減少最小寬度 */
        }
    }
    
    /* 改善觸控體驗 */
    @@media (pointer: coarse) {
        .btn-sm {
            min-height: 38px; /* 確保觸控目標足夠大 */
            min-width: 38px;
        }
        
        .form-control-sm {
            min-height: 36px; /* 改善觸控輸入體驗 */
        }
        
        .dropdown-item {
            min-height: 40px; /* 改善下拉選項的觸控體驗 */
            display: flex;
            align-items: center;
        }
    }
    
    /* 改善滾動條樣式 */
    .table-responsive::-webkit-scrollbar {
        height: 8px;
    }
    
    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }
    
    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
</style>

@code {
    // === 基本參數 ===
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public EventCallback<List<ProductItem>> OnProductItemsChanged { get; set; }
    
    // === 新增供應商過濾參數 ===
    [Parameter] public int? SelectedSupplierId { get; set; }
    
    // === 泛型參數 ===
    [Parameter] public TMainEntity? MainEntity { get; set; }
    [Parameter] public List<TDetailEntity> ExistingDetails { get; set; } = new List<TDetailEntity>();
    [Parameter] public EventCallback<List<TDetailEntity>> OnDetailsChanged { get; set; }
    
    // === 欄位映射參數 ===
    [Parameter] public string MainEntityIdPropertyName { get; set; } = string.Empty; // 主檔ID欄位名稱，例如 "PurchaseOrderId"
    [Parameter] public string QuantityPropertyName { get; set; } = "Quantity"; // 數量欄位名稱
    [Parameter] public string UnitPricePropertyName { get; set; } = "UnitPrice"; // 單價欄位名稱
    [Parameter] public string RemarksPropertyName { get; set; } = "Remarks"; // 備註欄位名稱
    [Parameter] public string? UnitIdPropertyName { get; set; } // 單位ID欄位名稱（可選）
    
    // === 顯示標籤參數 ===
    [Parameter] public string QuantityLabel { get; set; } = "數量";
    [Parameter] public string PriceLabel { get; set; } = "單價";
    [Parameter] public string RemarksLabel { get; set; } = "備註";

    private List<ProductItem> ProductItems { get; set; } = new List<ProductItem>();
    private List<Product> FilteredProducts { get; set; } = new List<Product>();
    private List<Product> AvailableProducts { get; set; } = new List<Product>(); // 新增：儲存可用商品列表
    private int? _previousSelectedSupplierId = null; // 新增：追蹤前一個選擇的供應商ID

    protected override async Task OnInitializedAsync()
    {
        // 載入可用商品
        await LoadAvailableProductsAsync();
        
        // 從現有明細載入資料
        LoadExistingDetails();
        // 初始化時確保有1行空白
        EnsureOneEmptyRow();
    }

    protected override async Task OnParametersSetAsync()
    {
        // 檢查供應商是否變更
        if (_previousSelectedSupplierId != SelectedSupplierId)
        {
            _previousSelectedSupplierId = SelectedSupplierId;
            await LoadAvailableProductsAsync();
        }
        
        // 當參數變更時重新載入
        if (ExistingDetails?.Any() == true)
        {
            LoadExistingDetails(); // 這裡面已經會呼叫 EnsureOneEmptyRow()
        }
        else
        {
            // 如果沒有現有明細，也要確保有空白行
            EnsureOneEmptyRow();
        }
    }

    /// <summary>
    /// 根據選擇的供應商載入可用商品
    /// </summary>
    private async Task LoadAvailableProductsAsync()
    {
        try
        {
            if (SelectedSupplierId.HasValue && SelectedSupplierId.Value > 0)
            {
                // 使用 ProductService 的 GetBySupplierAsync 方法載入該供應商的商品
                AvailableProducts = await ProductService.GetBySupplierAsync(SelectedSupplierId.Value);
            }
            else
            {
                // 如果沒有選擇供應商，清空可用商品列表
                AvailableProducts = new List<Product>();
            }
        }
        catch (Exception)
        {
            // 處理錯誤，使用空列表作為備用
            AvailableProducts = new List<Product>();
            // 可以考慮記錄錯誤或顯示通知
        }
    }

    /// <summary>
    /// 從現有明細資料載入到 ProductItems
    /// </summary>
    private void LoadExistingDetails()
    {
        if (ExistingDetails?.Any() != true) return;

        ProductItems.Clear();
        
        foreach (var detail in ExistingDetails)
        {
            var productId = GetPropertyValue<int>(detail, "ProductId");
            var product = Products.FirstOrDefault(p => p.Id == productId);
            
            if (product != null)
            {
                var item = new ProductItem
                {
                    SelectedProduct = product,
                    ProductSearch = $"{product.Code} - {product.Name}",
                    Quantity = Convert.ToInt32(GetPropertyValue<object>(detail, QuantityPropertyName) ?? 0),
                    Price = Convert.ToDecimal(GetPropertyValue<object>(detail, UnitPricePropertyName) ?? 0m),
                    Remarks = GetPropertyValue<string>(detail, RemarksPropertyName) ?? string.Empty,
                    ExistingDetailEntity = detail
                };
                
                ProductItems.Add(item);
            }
        }
        
        // 載入完成後確保有空白行
        EnsureOneEmptyRow();
    }

    /// <summary>
    /// 轉換 ProductItems 為明細實體列表
    /// </summary>
    private List<TDetailEntity> ConvertToDetailEntities()
    {
        var details = new List<TDetailEntity>();
        
        foreach (var item in ProductItems.Where(x => !IsEmptyRow(x) && x.SelectedProduct != null))
        {
            TDetailEntity detail;
            
            // 如果有現有的明細實體，則更新它
            if (item.ExistingDetailEntity != null)
            {
                detail = item.ExistingDetailEntity;
            }
            else
            {
                detail = new TDetailEntity();
                
                // 設定主檔ID
                if (MainEntity != null && !string.IsNullOrEmpty(MainEntityIdPropertyName))
                {
                    SetPropertyValue(detail, MainEntityIdPropertyName, MainEntity.Id);
                }
                
                // 設定商品ID
                if (item.SelectedProduct != null)
                {
                    SetPropertyValue(detail, "ProductId", item.SelectedProduct.Id);
                }
            }
            
            // 更新數量、單價、備註
            SetPropertyValue(detail, QuantityPropertyName, item.Quantity);
            SetPropertyValue(detail, UnitPricePropertyName, item.Price);
            SetPropertyValue(detail, RemarksPropertyName, item.Remarks);
            
            details.Add(detail);
        }
        
        return details;
    }

    /// <summary>
    /// 通知明細變更
    /// </summary>
    private async Task NotifyDetailsChanged()
    {
        var details = ConvertToDetailEntities();
        await OnDetailsChanged.InvokeAsync(details);
        await NotifyItemsChanged(); // 向下相容
    }

    /// <summary>
    /// 使用反射取得屬性值
    /// </summary>
    private T? GetPropertyValue<T>(object obj, string propertyName)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property == null) return default(T);
        
        var value = property.GetValue(obj);
        if (value == null) return default(T);
        
        if (typeof(T) == typeof(object)) return (T)value;
        
        return (T)Convert.ChangeType(value, typeof(T));
    }

    /// <summary>
    /// 使用反射設定屬性值
    /// </summary>
    private void SetPropertyValue(object obj, string propertyName, object? value)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property != null && property.CanWrite)
        {
            if (value != null && property.PropertyType != value.GetType())
            {
                // 處理型別轉換
                if (property.PropertyType.IsGenericType && property.PropertyType.GetGenericTypeDefinition() == typeof(Nullable<>))
                {
                    var underlyingType = Nullable.GetUnderlyingType(property.PropertyType);
                    value = Convert.ChangeType(value, underlyingType!);
                }
                else
                {
                    value = Convert.ChangeType(value, property.PropertyType);
                }
            }
            property.SetValue(obj, value);
        }
    }

    private void AddNewRow()
    {
        ProductItems.Add(new ProductItem());
        StateHasChanged();
    }

    private void OnInputFocus(ProductItem item)
    {
        // 只負責顯示下拉選單，新增行的邏輯放在實際輸入時處理
        ShowProductDropdown(item);
    }

    private bool IsEmptyRow(ProductItem item)
    {
        var isEmpty = item.SelectedProduct == null && 
               item.Quantity <= 0 && 
               item.Price <= 0 && 
               string.IsNullOrWhiteSpace(item.Remarks) &&
               string.IsNullOrWhiteSpace(item.ProductSearch);
        
        return isEmpty;
    }

    private void EnsureOneEmptyRow()
    {
        var emptyCount = ProductItems.Count(IsEmptyRow);
        
        if (emptyCount < 1)
        {
            ProductItems.Add(new ProductItem());
        }
        
        StateHasChanged();
    }

    private async Task RemoveItem(ProductItem item)
    {
        ProductItems.Remove(item);
        EnsureOneEmptyRow(); // 刪除後確保還有1行空白
        await NotifyDetailsChanged();
    }

    private void OnProductSearchInput(ProductItem item, string? searchValue)
    {
        // 檢查是否在空行輸入，如果是則新增行
        var wasEmpty = IsEmptyRow(item);
        
        item.ProductSearch = searchValue ?? string.Empty;
        
        if (string.IsNullOrWhiteSpace(searchValue))
        {
            item.ShowDropdown = false;
            item.SelectedIndex = -1;
            FilteredProducts.Clear();
        }
        else
        {
            // 取得可用商品列表（根據供應商過濾）
            var availableProducts = GetAvailableProducts();
            
            FilteredProducts = availableProducts
                .Where(p => p.Code?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) == true ||
                           p.Name?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) == true)
                .Take(10)
                .ToList();
            
            item.ShowDropdown = FilteredProducts.Any();
            item.SelectedIndex = FilteredProducts.Any() ? 0 : -1; // 預設選中第一項
        }
        
        // 如果原本是空行，現在有輸入了，確保有足夠的空行
        if (wasEmpty && !string.IsNullOrWhiteSpace(searchValue))
        {
            EnsureOneEmptyRow();
        }
        
        StateHasChanged();
    }

    /// <summary>
    /// 取得可用商品列表（根據供應商過濾）
    /// </summary>
    private List<Product> GetAvailableProducts()
    {
        // 如果沒有選擇供應商，返回空列表（強制使用者選擇供應商）
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
        {
            return new List<Product>();
        }
        
        // 直接使用已載入的可用商品列表
        return AvailableProducts;
    }

    private async Task OnQuantityInput(ProductItem item, string? value)
    {
        var wasEmpty = IsEmptyRow(item);
        if (int.TryParse(value, out int quantity) && quantity > 0)
        {
            item.Quantity = quantity;
        }
        else
        {
            item.Quantity = 0;  // 空字串或無效值都設為0
        }
        
        if (wasEmpty && !string.IsNullOrWhiteSpace(value) && int.TryParse(value, out var parsedValue) && parsedValue > 0)
        {
            EnsureOneEmptyRow();
        }
        
        StateHasChanged();
        await NotifyDetailsChanged(); // 通知明細變更
    }

    private async Task OnPriceInput(ProductItem item, string? value)
    {
        var wasEmpty = IsEmptyRow(item);
        
        if (decimal.TryParse(value, out decimal price) && price > 0)
        {
            item.Price = price;
        }
        else
        {
            item.Price = 0;  // 空字串或無效值都設為0
        }
        
        if (wasEmpty && !string.IsNullOrWhiteSpace(value) && decimal.TryParse(value, out var parsedValue) && parsedValue > 0)
        {
            EnsureOneEmptyRow();
        }
        
        StateHasChanged();
        await NotifyDetailsChanged(); // 通知明細變更
    }

    private async Task OnRemarksInput(ProductItem item, string? value)
    {
        var wasEmpty = IsEmptyRow(item);
        item.Remarks = value ?? string.Empty;
        
        if (wasEmpty && !string.IsNullOrWhiteSpace(value))
        {
            EnsureOneEmptyRow();
        }
        
        StateHasChanged();
        await NotifyDetailsChanged(); // 通知明細變更
    }

    private void ShowProductDropdown(ProductItem item)
    {
        if (!string.IsNullOrWhiteSpace(item.ProductSearch))
        {
            OnProductSearchInput(item, item.ProductSearch);
        }
        else
        {
            item.SelectedIndex = -1;
            // 如果沒有搜尋文字，顯示所有可用商品的前10項
            var availableProducts = GetAvailableProducts();
            FilteredProducts = availableProducts.Take(10).ToList();
            item.ShowDropdown = FilteredProducts.Any();
        }
    }

    private async Task SelectProduct(ProductItem item, Product product)
    {
        item.ProductSearch = $"{product.Code} - {product.Name}";
        item.SelectedProduct = product;
        item.ShowDropdown = false;
        item.SelectedIndex = -1; // 重置選中索引
        
        StateHasChanged();
        await NotifyDetailsChanged();
    }

    private async Task OnKeyDown(ProductItem item, KeyboardEventArgs e)
    {
        if (!item.ShowDropdown || FilteredProducts == null || !FilteredProducts.Any())
            return;

        switch (e.Key)
        {
            case "ArrowDown":
                item.SelectedIndex = Math.Min(item.SelectedIndex + 1, FilteredProducts.Count - 1);
                StateHasChanged();
                break;
                
            case "ArrowUp":
                item.SelectedIndex = Math.Max(item.SelectedIndex - 1, 0);
                StateHasChanged();
                break;
                
            case "Enter":
                if (item.SelectedIndex >= 0 && item.SelectedIndex < FilteredProducts.Count)
                {
                    await SelectProduct(item, FilteredProducts[item.SelectedIndex]);
                }
                break;
                
            case "Escape":
                item.ShowDropdown = false;
                item.SelectedIndex = -1;
                StateHasChanged();
                break;
        }
    }

    private async Task NotifyItemsChanged()
    {
        await OnProductItemsChanged.InvokeAsync(ProductItems);
    }

    /// <summary>
    /// 取得商品輸入框的提示文字
    /// </summary>
    private string GetProductInputPlaceholder(bool isEmptyRow)
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
        {
            return "請先選擇供應商...";
        }
        
        return isEmptyRow ? "點擊開始輸入商品..." : "輸入商品編號或名稱...";
    }

    /// <summary>
    /// 取得數量輸入框的提示文字
    /// </summary>
    private string GetQuantityPlaceholder(bool isEmptyRow)
    {
        return isEmptyRow ? "0" : "數量";
    }

    /// <summary>
    /// 取得價格輸入框的提示文字
    /// </summary>
    private string GetPricePlaceholder(bool isEmptyRow)
    {        
        return isEmptyRow ? "0.00" : "價格";
    }

    /// <summary>
    /// 取得備註輸入框的提示文字
    /// </summary>
    private string GetRemarksPlaceholder(bool isEmptyRow)
    {        
        return isEmptyRow ? "選填..." : "備註...";
    }

    private decimal GetTotalAmount()
    {
        return ProductItems
            .Where(item => !IsEmptyRow(item) && item.SelectedProduct != null && item.Quantity > 0)
            .Sum(item => item.Quantity * item.Price);
    }

    public class ProductItem
    {
        public string ProductSearch { get; set; } = string.Empty;
        public Product? SelectedProduct { get; set; }
        public int Quantity { get; set; } = 0;  // 改為0，不是1
        public decimal Price { get; set; } = 0;
        public string Remarks { get; set; } = string.Empty;
        public bool ShowDropdown { get; set; } = false;
        public int SelectedIndex { get; set; } = -1; // 新增：記錄當前選中的索引
        public TDetailEntity? ExistingDetailEntity { get; set; } // 新增：關聯的現有明細實體
    }
}
