@using ERPCore2.Data.Entities
@using Microsoft.EntityFrameworkCore

<div class="product-manager">
    @if (ProductItems != null && ProductItems.Any())
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th width="25%">商品</th>
                        <th width="15%">數量</th>
                        <th width="15%">價格</th>
                        <th width="30%">備註</th>
                        <th width="15%">操作</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in ProductItems)
                    {
                        var isEmptyRow = IsEmptyRow(item);
                        <tr class="@(isEmptyRow ? "table-light" : "")">
                            <td>
                                <div class="position-relative">
                                    <input type="text" class="form-control form-control-sm @(isEmptyRow ? "empty-row-input" : "")" 
                                           value="@item.ProductSearch"
                                           @oninput="(e) => OnProductSearchInput(item, e.Value?.ToString())"
                                           @onfocus="() => OnInputFocus(item)"
                                           @onkeydown="(e) => OnKeyDown(item, e)"
                                           placeholder="@(isEmptyRow ? "點擊開始輸入商品..." : "輸入商品編號或名稱...")" />
                                    
                                    @if (item.ShowDropdown && FilteredProducts != null && FilteredProducts.Any())
                                    {
                                        <div class="dropdown-menu show position-absolute w-100" style="z-index: 1000; max-height: 200px; overflow-y: auto;">
                                            @for (int i = 0; i < FilteredProducts.Count; i++)
                                            {
                                                var product = FilteredProducts[i];
                                                var index = i;
                                                <a class="dropdown-item @(item.SelectedIndex == index ? "active" : "")" 
                                                   href="#" 
                                                   @onclick="() => SelectProduct(item, product)" 
                                                   @onclick:preventDefault="true">
                                                    <strong>@product.Code</strong> - @product.Name
                                                </a>
                                            }
                                        </div>
                                    }
                                </div>
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm" 
                                       value="@item.Quantity"
                                       @onfocus="() => OnInputFocus(item)"
                                       @oninput="(e) => OnQuantityInput(item, e.Value?.ToString())"
                                       placeholder="@(isEmptyRow ? "0" : "數量")" 
                                       min="0" 
                                       step="1" />
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm" 
                                       value="@item.Price"
                                       @onfocus="() => OnInputFocus(item)"
                                       @oninput="(e) => OnPriceInput(item, e.Value?.ToString())"
                                       placeholder="@(isEmptyRow ? "0.00" : "價格")" 
                                       min="0" 
                                       step="0.01" />
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm" 
                                       value="@item.Remarks"
                                       @onfocus="() => OnInputFocus(item)"
                                       @oninput="(e) => OnRemarksInput(item, e.Value?.ToString())"
                                       placeholder="@(isEmptyRow ? "選填..." : "備註...")" />
                            </td>
                            <td>
                                <button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => RemoveItem(item)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot class="table-secondary">
                    <tr>
                        <th colspan="2">總計</th>
                        <th class="text-end">@GetTotalAmount().ToString("C")</th>
                        <th colspan="2"></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    }
    else
    {
        <div class="text-center text-muted py-4">
            <i class="fas fa-box-open fa-3x mb-3"></i>
            <p>尚無商品資料，點擊上方按鈕新增商品</p>
        </div>
    }
</div>

@code {
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public EventCallback<List<ProductItem>> OnProductItemsChanged { get; set; }

    private List<ProductItem> ProductItems { get; set; } = new List<ProductItem>();
    private List<Product> FilteredProducts { get; set; } = new List<Product>();

    protected override void OnInitialized()
    {
        // 初始化時確保有1行空白
        EnsureOneEmptyRow();
    }

    private void AddNewRow()
    {
        ProductItems.Add(new ProductItem());
        StateHasChanged();
    }

    private void OnInputFocus(ProductItem item)
    {
        // 只負責顯示下拉選單，新增行的邏輯放在實際輸入時處理
        ShowProductDropdown(item);
    }

    private bool IsEmptyRow(ProductItem item)
    {
        var isEmpty = item.SelectedProduct == null && 
               item.Quantity <= 0 && 
               item.Price <= 0 && 
               string.IsNullOrWhiteSpace(item.Remarks) &&
               string.IsNullOrWhiteSpace(item.ProductSearch);
        
        return isEmpty;
    }

    private void EnsureOneEmptyRow()
    {
        var emptyCount = ProductItems.Count(IsEmptyRow);
        
        while (emptyCount < 1)
        {
            ProductItems.Add(new ProductItem());
            emptyCount++;
        }
        StateHasChanged();
    }

    private async Task RemoveItem(ProductItem item)
    {
        ProductItems.Remove(item);
        EnsureOneEmptyRow(); // 刪除後確保還有1行空白
        await NotifyItemsChanged();
    }

    private void OnProductSearchInput(ProductItem item, string? searchValue)
    {
        // 檢查是否在空行輸入，如果是則新增行
        var wasEmpty = IsEmptyRow(item);
        
        item.ProductSearch = searchValue ?? string.Empty;
        
        if (string.IsNullOrWhiteSpace(searchValue))
        {
            item.ShowDropdown = false;
            item.SelectedIndex = -1;
            FilteredProducts.Clear();
        }
        else
        {
            FilteredProducts = Products
                .Where(p => p.Code?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) == true ||
                           p.Name?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) == true)
                .Take(10)
                .ToList();
            
            item.ShowDropdown = FilteredProducts.Any();
            item.SelectedIndex = FilteredProducts.Any() ? 0 : -1; // 預設選中第一項
        }
        
        // 如果原本是空行，現在有輸入了，確保有足夠的空行
        if (wasEmpty && !string.IsNullOrWhiteSpace(searchValue))
        {
            EnsureOneEmptyRow();
        }
        
        StateHasChanged();
    }

    private void OnQuantityInput(ProductItem item, string? value)
    {
        var wasEmpty = IsEmptyRow(item);
        if (int.TryParse(value, out int quantity) && quantity > 0)
        {
            item.Quantity = quantity;
        }
        else
        {
            item.Quantity = 0;  // 空字串或無效值都設為0
        }
        
        if (wasEmpty && !string.IsNullOrWhiteSpace(value) && int.TryParse(value, out var parsedValue) && parsedValue > 0)
        {
            EnsureOneEmptyRow();
        }
        
        StateHasChanged();
    }

    private void OnPriceInput(ProductItem item, string? value)
    {
        var wasEmpty = IsEmptyRow(item);
        
        if (decimal.TryParse(value, out decimal price) && price > 0)
        {
            item.Price = price;
        }
        else
        {
            item.Price = 0;  // 空字串或無效值都設為0
        }
        
        if (wasEmpty && !string.IsNullOrWhiteSpace(value) && decimal.TryParse(value, out var parsedValue) && parsedValue > 0)
        {
            EnsureOneEmptyRow();
        }
        
        StateHasChanged();
    }

    private void OnRemarksInput(ProductItem item, string? value)
    {
        var wasEmpty = IsEmptyRow(item);
        item.Remarks = value ?? string.Empty;
        
        if (wasEmpty && !string.IsNullOrWhiteSpace(value))
        {
            EnsureOneEmptyRow();
        }
        
        StateHasChanged();
    }

    private void ShowProductDropdown(ProductItem item)
    {
        if (!string.IsNullOrWhiteSpace(item.ProductSearch))
        {
            OnProductSearchInput(item, item.ProductSearch);
        }
        else
        {
            item.SelectedIndex = -1;
        }
    }

    private async Task SelectProduct(ProductItem item, Product product)
    {
        item.ProductSearch = $"{product.Code} - {product.Name}";
        item.SelectedProduct = product;
        item.ShowDropdown = false;
        item.SelectedIndex = -1; // 重置選中索引
        
        StateHasChanged();
        await NotifyItemsChanged();
    }

    private async Task OnKeyDown(ProductItem item, KeyboardEventArgs e)
    {
        if (!item.ShowDropdown || FilteredProducts == null || !FilteredProducts.Any())
            return;

        switch (e.Key)
        {
            case "ArrowDown":
                item.SelectedIndex = Math.Min(item.SelectedIndex + 1, FilteredProducts.Count - 1);
                StateHasChanged();
                break;
                
            case "ArrowUp":
                item.SelectedIndex = Math.Max(item.SelectedIndex - 1, 0);
                StateHasChanged();
                break;
                
            case "Enter":
                if (item.SelectedIndex >= 0 && item.SelectedIndex < FilteredProducts.Count)
                {
                    await SelectProduct(item, FilteredProducts[item.SelectedIndex]);
                }
                break;
                
            case "Escape":
                item.ShowDropdown = false;
                item.SelectedIndex = -1;
                StateHasChanged();
                break;
        }
    }

    private async Task NotifyItemsChanged()
    {
        await OnProductItemsChanged.InvokeAsync(ProductItems);
    }

    private decimal GetTotalAmount()
    {
        return ProductItems
            .Where(item => !IsEmptyRow(item) && item.SelectedProduct != null && item.Quantity > 0)
            .Sum(item => item.Quantity * item.Price);
    }

    public class ProductItem
    {
        public string ProductSearch { get; set; } = string.Empty;
        public Product? SelectedProduct { get; set; }
        public int Quantity { get; set; } = 0;  // 改為0，不是1
        public decimal Price { get; set; } = 0;
        public string Remarks { get; set; } = string.Empty;
        public bool ShowDropdown { get; set; } = false;
        public int SelectedIndex { get; set; } = -1; // 新增：記錄當前選中的索引
    }
}
