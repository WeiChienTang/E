@* 領貨明細管理組件 - 使用條碼掃描和 InteractiveTableComponent *@

@inject IProductService ProductService
@inject IInventoryStockService InventoryStockService
@inject INotificationService NotificationService

@using ERPCore2.Data.Entities
@using ERPCore2.Helpers
@using ERPCore2.Components.Shared.SubCollections
@using ERPCore2.Components.Shared.Buttons

<div class="material-issue-detail-manager">
    <!-- 條碼掃描區 -->
    <div class="card mb-3 border-0 shadow-sm">
        <div class="card-body">
            <div class="row g-3">
                <!-- 條碼輸入欄位 -->
                <div class="col-md-12">
                    <label class="form-label">
                        <i class="bi bi-upc-scan me-2"></i>條碼掃描
                    </label>
                    <input type="text" 
                           class="form-control form-control-lg" 
                           placeholder="請掃描或輸入商品條碼，按 Enter 新增..."
                           @bind="barcodeInput"
                           @bind:event="oninput"
                           @onkeydown="HandleBarcodeKeyDown"
                           @ref="barcodeInputElement"
                           disabled="@IsReadOnly" />
                    <small class="text-muted">掃描條碼後按 Enter 自動新增商品，或直接在下方表格手動輸入</small>
                </div>
            </div>
        </div>
    </div>

    <!-- 明細表格 -->
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent TItem="DetailItem"
                                     Items="@DetailItems"
                                     ColumnDefinitions="@GetColumnDefinitions()"
                                     IsReadOnly="@IsReadOnly"
                                     ShowRowNumbers="true"
                                     EmptyMessage="尚未新增商品"
                                     ShowBuiltInActions="true"
                                     ShowBuiltInDeleteButton="false"
                                     ActionsColumnWidth="80px"
                                     CustomActionsTemplate="@GetCustomActionsTemplate" />
        </div>
    </div>
</div>

@code {
    // ===== 參數 =====
    [Parameter] public List<MaterialIssueDetail> Details { get; set; } = new();
    [Parameter] public EventCallback<List<MaterialIssueDetail>> DetailsChanged { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;

    // ===== 私有欄位 =====
    private ElementReference barcodeInputElement;
    private string barcodeInput = string.Empty;
    
    private List<Product> allProducts = new();
    
    private List<DetailItem> DetailItems = new();

    // ===== 內部 Item 類別 =====
    private class DetailItem
    {
        public int? ProductId { get; set; }
        public Product? SelectedProduct { get; set; }
        public int? WarehouseId { get; set; }
        public int? WarehouseLocationId { get; set; }
        public int? InventoryStockDetailId { get; set; } // 新增：庫存明細ID
        public int IssueQuantity { get; set; }
        public decimal UnitCost { get; set; }
        public int? AvailableStock { get; set; }
        
        // SearchableSelect 支援屬性
        public string ProductSearchValue { get; set; } = string.Empty;
        public List<Product> FilteredProducts { get; set; } = new();
        public bool ShowProductDropdown { get; set; }
        public int ProductSelectedIndex { get; set; } = -1;
        
        // 倉庫庫位組合選項
        public List<InventoryStockDetail> AvailableWarehouseLocations { get; set; } = new();
    }

    // ===== 生命週期方法 =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadRelatedDataAsync();
            await LoadExistingDetailsAsync();
            EnsureOneEmptyRow();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(OnInitializedAsync), GetType(), 
                additionalData: "初始化領貨明細管理器失敗");
            await NotificationService.ShowErrorAsync("初始化明細管理器失敗");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await barcodeInputElement.FocusAsync();
            }
            catch
            {
                // 忽略 Focus 失敗
            }
        }
    }

    // ===== 資料載入方法 =====

    private async Task LoadRelatedDataAsync()
    {
        try
        {
            allProducts = await ProductService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadRelatedDataAsync), GetType(), 
                additionalData: "載入相關資料失敗");
            await NotificationService.ShowErrorAsync("載入相關資料失敗");
            
            allProducts = new List<Product>();
        }
    }

    private async Task LoadExistingDetailsAsync()
    {
        try
        {
            DetailItems.Clear();
            
            foreach (var detail in Details)
            {
                var product = allProducts.FirstOrDefault(p => p.Id == detail.ProductId);
                
                var item = new DetailItem
                {
                    ProductId = detail.ProductId,
                    SelectedProduct = product,
                    WarehouseId = detail.WarehouseId,
                    WarehouseLocationId = detail.WarehouseLocationId,
                    IssueQuantity = detail.IssueQuantity,
                    UnitCost = detail.UnitCost ?? 0m,
                    ProductSearchValue = product != null ? $"[{product.Code}] {product.Name}" : ""
                };

                // 載入該商品的可用倉庫位置清單
                if (item.ProductId.HasValue)
                {
                    item.AvailableWarehouseLocations = await InventoryStockService.GetAvailableWarehouseLocationsByProductAsync(item.ProductId.Value);
                    
                    // 找到對應的庫存明細ID
                    if (item.WarehouseId.HasValue)
                    {
                        var stockDetail = item.AvailableWarehouseLocations.FirstOrDefault(d => 
                            d.WarehouseId == item.WarehouseId.Value && 
                            d.WarehouseLocationId == item.WarehouseLocationId);
                        
                        if (stockDetail != null)
                        {
                            item.InventoryStockDetailId = stockDetail.Id;
                            item.AvailableStock = stockDetail.AvailableStock;
                        }
                    }
                }

                DetailItems.Add(item);
            }
            
            EnsureOneEmptyRow();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadExistingDetailsAsync), GetType(), 
                additionalData: "載入現有明細失敗");
            DetailItems = new List<DetailItem>();
        }
    }

    // ===== InteractiveTableComponent 欄位定義 =====

    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // 商品欄位 - 使用 SearchableSelect
        columns.Add(new()
        {
            Title = "商品",
            PropertyName = "ProductSearchValue",
            ColumnType = InteractiveColumnType.SearchableSelect,
            Width = "250px",
            Tooltip = "搜尋並選擇商品",
            Placeholder = "請輸入商品編號或名稱",
            IsRequired = true,
            SearchValuePropertyName = nameof(DetailItem.ProductSearchValue),
            FilteredItemsPropertyName = nameof(DetailItem.FilteredProducts),
            ShowDropdownPropertyName = nameof(DetailItem.ShowProductDropdown),
            SelectedIndexPropertyName = nameof(DetailItem.ProductSelectedIndex),
            ItemDisplayFormatter = (item) =>
            {
                var product = (Product)item;
                return $"[{product.Code}] {product.Name}";
            },
            OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, (tuple) =>
            {
                var (item, searchValue) = tuple;
                OnProductSearchChanged((DetailItem)item, searchValue);
            }),
            OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
            {
                var (item, selectedItem) = tuple;
                await OnProductSelected((DetailItem)item, (Product?)selectedItem);
            }),
            OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
            {
                var detailItem = (DetailItem)item;
                detailItem.FilteredProducts = allProducts.Take(20).ToList();
                detailItem.ShowProductDropdown = true;
                detailItem.ProductSelectedIndex = -1;
                StateHasChanged();
            }),
            OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
            {
                Task.Delay(200).ContinueWith(_ =>
                {
                    var detailItem = (DetailItem)item;
                    detailItem.ShowProductDropdown = false;
                    InvokeAsync(StateHasChanged);
                });
            }),
            EnableKeyboardNavigation = true,
            GetDropdownItems = (item) => ((DetailItem)item).FilteredProducts,
            GetShowDropdown = (item) => ((DetailItem)item).ShowProductDropdown,
            GetSelectedIndex = (item) => ((DetailItem)item).ProductSelectedIndex,
            SetSelectedIndex = (item, index) => ((DetailItem)item).ProductSelectedIndex = index,
            SetShowDropdown = (item, show) => ((DetailItem)item).ShowProductDropdown = show
        });

        // 倉庫 - 庫位欄位（合併顯示）
        columns.Add(new()
        {
            Title = "倉庫 - 庫位",
            PropertyName = "InventoryStockDetailId",
            ColumnType = InteractiveColumnType.Custom,
            Width = "200px",
            Tooltip = "選擇倉庫和庫位（僅顯示有庫存的位置）",
            CustomTemplate = item =>
            {
                var detailItem = (DetailItem)item;
                var selectedValue = detailItem.InventoryStockDetailId?.ToString() ?? "";
                var isDisabled = IsReadOnly || !detailItem.ProductId.HasValue || !detailItem.AvailableWarehouseLocations.Any();

                return @<select class="form-select form-select-sm"
                                value="@selectedValue"
                                disabled="@isDisabled"
                                @onchange="@(async (e) => await OnWarehouseLocationChanged(detailItem, e.Value))">
                    <option value="">請選擇</option>
                    @foreach (var stockDetail in detailItem.AvailableWarehouseLocations)
                    {
                        var warehouseName = stockDetail.Warehouse?.Name ?? "未知倉庫";
                        var locationName = stockDetail.WarehouseLocation?.Name ?? "預設位置";
                        var displayText = $"{warehouseName} - {locationName}";
                        <option value="@stockDetail.Id">@displayText</option>
                    }
                </select>;
            }
        });

        // 可用庫存欄位
        columns.Add(new()
        {
            Title = "可用庫存",
            PropertyName = "AvailableStock",
            ColumnType = InteractiveColumnType.Display,
            Width = "100px",
            Tooltip = "當前可用庫存數量",
            DisplayFormatter = (value) =>
            {
                if (value == null) return "<span class='badge bg-secondary'>-</span>";
                var qty = (int)value;
                var badgeClass = qty == 0 ? "bg-danger" : qty < 10 ? "bg-warning" : "bg-success";
                return $"<span class='badge {badgeClass}'>{qty}</span>";
            }
        });

        // 領貨數量欄位
        columns.Add(new()
        {
            Title = "領貨數量",
            PropertyName = "IssueQuantity",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            Tooltip = "輸入領貨數量",
            CustomTemplate = item =>
            {
                var detailItem = (DetailItem)item;
                var displayValue = detailItem.IssueQuantity > 0 ? detailItem.IssueQuantity.ToString() : "";
                var isDisabled = IsReadOnly;

                return @<input type="number"
                               class="form-control form-control-sm"
                               value="@displayValue"
                               min="1"
                               step="1"
                               placeholder="請輸入數量"
                               disabled="@isDisabled"
                               @onchange="@(async (e) => await OnIssueQuantityChanged(detailItem, e.Value))" />;
            }
        });

        return columns;
    }

    // ===== 事件處理方法 =====

    private async Task HandleBarcodeKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await HandleBarcodeScanned();
        }
    }

    private async Task HandleBarcodeScanned()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(barcodeInput))
            {
                await NotificationService.ShowWarningAsync("請輸入條碼");
                return;
            }

            var product = await ProductService.GetByBarcodeAsync(barcodeInput.Trim());
            
            if (product == null)
            {
                await NotificationService.ShowWarningAsync($"找不到條碼 {barcodeInput} 的商品");
                barcodeInput = string.Empty;
                return;
            }

            // 檢查是否已存在
            if (DetailItems.Any(item => item.ProductId == product.Id))
            {
                await NotificationService.ShowWarningAsync($"商品 {product.Name} 已存在明細中");
                barcodeInput = string.Empty;
                return;
            }

            // 載入可用倉庫位置
            var availableLocations = await InventoryStockService.GetAvailableWarehouseLocationsByProductAsync(product.Id);

            // 建立新明細項目
            var newItem = new DetailItem
            {
                ProductId = product.Id,
                SelectedProduct = product,
                ProductSearchValue = $"[{product.Code}] {product.Name}",
                IssueQuantity = 0, // 預設為0（空白）
                UnitCost = 0m, // Product 實體中沒有 Cost 屬性,預設為 0
                AvailableWarehouseLocations = availableLocations
            };

            // 移除現有的空行
            var emptyRow = DetailItems.FirstOrDefault(IsEmptyRow);
            if (emptyRow != null)
            {
                DetailItems.Remove(emptyRow);
            }

            // 將新項目加到列表最後
            DetailItems.Add(newItem);
            
            // 確保最後有一個空行
            EnsureOneEmptyRow();
            
            await SyncToDetails();
            await NotificationService.ShowSuccessAsync($"已新增商品: {product.Name}");
            
            barcodeInput = string.Empty;
            await barcodeInputElement.FocusAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleBarcodeScanned), GetType(), 
                additionalData: $"處理條碼掃描失敗 - 條碼: {barcodeInput}");
            await NotificationService.ShowErrorAsync("處理條碼掃描失敗");
            barcodeInput = string.Empty;
        }
    }

    private void OnProductSearchChanged(DetailItem item, string? searchValue)
    {
        var wasEmpty = IsEmptyRow(item);
        
        item.ProductSearchValue = searchValue ?? "";
        
        if (string.IsNullOrWhiteSpace(searchValue))
        {
            item.FilteredProducts = allProducts.Take(20).ToList();
        }
        else
        {
            var search = searchValue.ToLower();
            item.FilteredProducts = allProducts
                .Where(p => (p.Code?.ToLower().Contains(search) ?? false) || 
                           (p.Name?.ToLower().Contains(search) ?? false) ||
                           (p.Barcode?.ToLower().Contains(search) ?? false))
                .Take(20)
                .ToList();
        }
        
        item.ShowProductDropdown = true;
        item.ProductSelectedIndex = -1;
        
        // 處理自動空行邏輯
        AutoEmptyRowHelper.ForAny<DetailItem>.HandleInputChange(
            DetailItems, item, IsEmptyRow, CreateEmptyItem, wasEmpty, hasValueNow: !string.IsNullOrWhiteSpace(searchValue));
        
        StateHasChanged();
    }

    private async Task OnProductSelected(DetailItem item, Product? product)
    {
        if (product == null) return;

        var wasEmpty = IsEmptyRow(item);

        item.ProductId = product.Id;
        item.SelectedProduct = product;
        item.ProductSearchValue = $"[{product.Code}] {product.Name}";
        item.ShowProductDropdown = false;
        item.UnitCost = 0m; // Product 實體中沒有 Cost 屬性,預設為 0
        
        // 載入該商品的可用倉庫位置清單
        item.AvailableWarehouseLocations = await InventoryStockService.GetAvailableWarehouseLocationsByProductAsync(product.Id);
        
        // 重置選擇
        item.InventoryStockDetailId = null;
        item.WarehouseId = null;
        item.WarehouseLocationId = null;
        item.AvailableStock = null;
        
        // 處理自動空行邏輯
        AutoEmptyRowHelper.ForAny<DetailItem>.HandleInputChange(
            DetailItems, item, IsEmptyRow, CreateEmptyItem, wasEmpty, hasValueNow: product != null);
        
        await SyncToDetails();
        StateHasChanged();
    }

    private async Task OnWarehouseLocationChanged(DetailItem item, object? value)
    {
        var wasEmpty = IsEmptyRow(item);
        
        if (value == null || !int.TryParse(value.ToString(), out int detailId))
        {
            item.InventoryStockDetailId = null;
            item.WarehouseId = null;
            item.WarehouseLocationId = null;
            item.AvailableStock = null;
        }
        else
        {
            item.InventoryStockDetailId = detailId;
            
            // 從可用位置清單中找到對應的明細
            var selectedDetail = item.AvailableWarehouseLocations.FirstOrDefault(d => d.Id == detailId);
            if (selectedDetail != null)
            {
                item.WarehouseId = selectedDetail.WarehouseId;
                item.WarehouseLocationId = selectedDetail.WarehouseLocationId;
                item.AvailableStock = selectedDetail.AvailableStock;
            }
        }
        
        // 處理自動空行邏輯
        AutoEmptyRowHelper.ForAny<DetailItem>.HandleInputChange(
            DetailItems, item, IsEmptyRow, CreateEmptyItem, wasEmpty, hasValueNow: item.WarehouseId.HasValue);
        
        await SyncToDetails();
        StateHasChanged();
    }

    private async Task OnIssueQuantityChanged(DetailItem item, object? value)
    {
        var wasEmpty = IsEmptyRow(item);
        
        if (string.IsNullOrWhiteSpace(value?.ToString()))
        {
            item.IssueQuantity = 0;
        }
        else if (int.TryParse(value?.ToString(), out int quantity))
        {
            item.IssueQuantity = quantity;
        }
        
        // 處理自動空行邏輯
        AutoEmptyRowHelper.ForAny<DetailItem>.HandleInputChange(
            DetailItems, item, IsEmptyRow, CreateEmptyItem, wasEmpty, hasValueNow: item.IssueQuantity > 0);
        
        await SyncToDetails();
        StateHasChanged();
    }

    private async Task HandleItemDelete(DetailItem item)
    {
        try
        {
            if (IsReadOnly) return;
            
            AutoEmptyRowHelper.ForAny<DetailItem>.HandleItemRemove(
                DetailItems, item, IsEmptyRow, CreateEmptyItem);
            
            await SyncToDetails();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleItemDelete), GetType(), 
                additionalData: "刪除明細失敗");
            await NotificationService.ShowErrorAsync("刪除明細失敗");
        }
    }

    // ===== AutoEmptyRowHelper 相關方法 =====
    
    private bool IsEmptyRow(DetailItem item)
    {
        return item.ProductId == null || item.ProductId == 0;
    }
    
    private DetailItem CreateEmptyItem()
    {
        return new DetailItem
        {
            FilteredProducts = new List<Product>()
        };
    }
    
    private void EnsureOneEmptyRow()
    {
        AutoEmptyRowHelper.ForAny<DetailItem>.EnsureOneEmptyRow(
            DetailItems, IsEmptyRow, CreateEmptyItem);
    }

    private RenderFragment<DetailItem> GetCustomActionsTemplate => item => __builder =>
    {
        // 如果是空行，不顯示刪除按鈕
        if (!IsEmptyRow(item))
        {
            <GenericButtonComponent 
                IconClass="bi bi-trash text-white"
                Title="刪除"
                Variant="ButtonVariant.Danger"
                Size="ButtonSize.Small"
                OnClick="async () => await HandleItemDelete(item)"
                IsDisabled="@IsReadOnly" />
        }
    };

    // ===== 輔助方法 =====

    private async Task SyncToDetails()
    {
        Details.Clear();
        
        foreach (var item in DetailItems)
        {
            // 只有在有商品ID、倉庫ID、且領貨數量大於0時才加入
            if (item.ProductId.HasValue && item.WarehouseId.HasValue && item.IssueQuantity > 0)
            {
                Details.Add(new MaterialIssueDetail
                {
                    ProductId = item.ProductId.Value,
                    WarehouseId = item.WarehouseId.Value,
                    WarehouseLocationId = item.WarehouseLocationId,
                    IssueQuantity = item.IssueQuantity,
                    UnitCost = item.UnitCost
                });
            }
        }
        
        await DetailsChanged.InvokeAsync(Details);
    }
}

