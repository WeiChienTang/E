@* 應收帳款沖款明細管理組件 - 使用 InteractiveTableComponent 來管理沖款明細 *@
@inject IAccountsReceivableSetoffDetailService AccountsReceivableSetoffDetailService
@inject INotificationService NotificationService

<div class="setoff-detail-manager">
    @if (IsLoading)
    {
        <div class="d-flex justify-content-center p-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">載入中...</span>
            </div>
        </div>
    }

    <InteractiveTableComponent TItem="SetoffDetailDto"
                                Items="@Details"
                                ColumnDefinitions="@GetColumnDefinitions()"
                                ShowHeader="true"
                                ShowRowNumbers="false"
                                ShowActions="false"
                                ShowBuiltInActions="false"
                                IsStriped="true"
                                IsHoverable="true"
                                IsBordered="true"
                                IsReadOnly="false"
                                EmptyMessage="此客戶沒有未結清的明細項目"
                                CssClass="setoff-detail-table"
                                ValidationErrors="@ValidationErrors"
                                OnValidationFailed="@HandleValidationFailed" />
</div>

@code {
    #region 參數定義
    [Parameter] public int? CustomerId { get; set; }
    [Parameter] public EventCallback<List<SetoffDetailDto>> OnSelectedDetailsChanged { get; set; }
    [Parameter] public EventCallback<decimal> OnTotalAmountChanged { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;
    [Parameter] public bool IsEditMode { get; set; } = false;
    [Parameter] public int? SetoffId { get; set; }
    #endregion

    #region 私有狀態
    private bool IsLoading { get; set; } = false;
    private List<SetoffDetailDto> Details { get; set; } = new();
    private Dictionary<string, string> ValidationErrors { get; set; } = new();
    
    private List<SetoffDetailDto> SelectedDetails => 
        Details.Where(d => d.ThisTimeAmount > 0 || d.ThisTimeDiscountAmount > 0).ToList();
    #endregion

    #region 私有方法 - 狀態檢查
    /// <summary>
    /// 檢查項目是否為當前沖款單的記錄
    /// </summary>
    private bool IsCurrentSetoffRecord(SetoffDetailDto detail)
    {
        return detail.ThisTimeAmount > 0 || detail.ThisTimeDiscountAmount > 0;
    }
    #endregion

    #region 生命周期方法
    protected override async Task OnParametersSetAsync()
    {
        try
        {
            if (CustomerId.HasValue && CustomerId > 0)
            {
                await LoadDetailsAsync();
            }
            else
            {
                Details.Clear();
                ValidationErrors.Clear();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(OnParametersSetAsync), GetType(), 
                additionalData: $"載入沖款明細失敗 - CustomerId: {CustomerId}");
        }
    }
    #endregion

    #region 私有方法
    /// <summary>
    /// 載入客戶的未結清明細
    /// </summary>
    private async Task LoadDetailsAsync()
    {
        try
        {
            IsLoading = true;
            StateHasChanged();

            if (!CustomerId.HasValue || CustomerId.Value <= 0)
            {
                Details.Clear();
                return;
            }

            if (IsEditMode && SetoffId.HasValue)
            {
                // 編輯模式：載入所有相關明細（包括已完成的）
                Details = await AccountsReceivableSetoffDetailService.GetCustomerAllDetailsForEditAsync(CustomerId.Value, SetoffId.Value);
            }
            else
            {
                // 新增模式：只載入未結清明細
                Details = await AccountsReceivableSetoffDetailService.GetCustomerPendingDetailsAsync(CustomerId.Value);
            }
            
            ValidationErrors.Clear();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDetailsAsync), GetType(), 
                additionalData: $"載入明細資料失敗 - CustomerId: {CustomerId}, IsEditMode: {IsEditMode}, SetoffId: {SetoffId}");
            Details = new List<SetoffDetailDto>();
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// 取得欄位定義
    /// </summary>
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>
        {
            new InteractiveColumnDefinition
            {
                Title = "單據號碼",
                PropertyName = nameof(SetoffDetailDto.DocumentNumber),
                ColumnType = InteractiveColumnType.Display,
                Width = "150px"
            },
            new InteractiveColumnDefinition
            {
                Title = "單據日期",
                PropertyName = nameof(SetoffDetailDto.DocumentDate),
                ColumnType = InteractiveColumnType.Custom,
                Width = "120px",
                CustomTemplate = item =>
                {
                    var detail = (SetoffDetailDto)item;
                    return @<span>@detail.DocumentDate.ToString("yyyy-MM-dd")</span>;
                }
            },
            new InteractiveColumnDefinition
            {
                Title = "商品",
                PropertyName = nameof(SetoffDetailDto.ProductName),
                ColumnType = InteractiveColumnType.Display,
                Width = "200px"
            },
            new InteractiveColumnDefinition
            {
                Title = "數量",
                PropertyName = nameof(SetoffDetailDto.Quantity),
                ColumnType = InteractiveColumnType.Custom,
                Width = "100px",
                CellCssClass = "text-end",
                CustomTemplate = item =>
                {
                    var detail = (SetoffDetailDto)item;
                    return @<span>@detail.Quantity.ToString("N0")</span>;
                }
            },
            new InteractiveColumnDefinition
            {
                Title = "單價",
                PropertyName = nameof(SetoffDetailDto.UnitPrice),
                ColumnType = InteractiveColumnType.Custom,
                Width = "120px",
                CellCssClass = "text-end",
                CustomTemplate = item =>
                {
                    var detail = (SetoffDetailDto)item;
                    return @<span>@detail.UnitPrice.ToString("N0")</span>;
                }
            },
            
            new InteractiveColumnDefinition
            {
                Title = "總金額",
                PropertyName = nameof(SetoffDetailDto.TotalAmount),
                ColumnType = InteractiveColumnType.Custom,
                Width = "120px",
                CellCssClass = "text-end",
                CustomTemplate = item =>
                {
                    var detail = (SetoffDetailDto)item;
                    return @<span>@detail.TotalAmount.ToString("N0")</span>;
                }
            },
            new InteractiveColumnDefinition
            {
                Title = "已沖款",
                PropertyName = nameof(SetoffDetailDto.SettledAmount),
                ColumnType = InteractiveColumnType.Custom,
                Width = "120px",
                CellCssClass = "text-end",
                CustomTemplate = item =>
                {
                    var detail = (SetoffDetailDto)item;
                    return @<span>@detail.SettledAmount.ToString("N0")</span>;
                }
            },
            new InteractiveColumnDefinition
            {
                Title = "已折讓",
                PropertyName = nameof(SetoffDetailDto.DiscountedAmount),
                ColumnType = InteractiveColumnType.Custom,
                Width = "120px",
                CellCssClass = "text-end text-info",
                CustomTemplate = item =>
                {
                    var detail = (SetoffDetailDto)item;
                    return @<span>@detail.DiscountedAmount.ToString("N0")</span>;
                }
            },
            new InteractiveColumnDefinition
            {
                Title = "待沖款",
                PropertyName = nameof(SetoffDetailDto.PendingAmount),
                ColumnType = InteractiveColumnType.Custom,
                Width = "120px",
                CellCssClass = "text-end text-warning",
                CustomTemplate = item =>
                {
                    var detail = (SetoffDetailDto)item;
                    return @<span class="fw-bold">@detail.PendingAmount.ToString("N0")</span>;
                }
            },
            new InteractiveColumnDefinition
            {
                Title = "本次沖款",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "120px",
                CellCssClass = "text-end",
                CustomTemplate = item =>
                {
                    var detail = (SetoffDetailDto)item;
                    
                    return @<input type="text"
                                  class="form-control form-control-sm text-end"
                                  value="@(detail.ThisTimeAmount > 0 ? detail.ThisTimeAmount.ToString("N0") : "")"
                                  pattern="[0-9]*"
                                  inputmode="numeric"
                                  @oninput="@(async (e) => await HandleAmountChanged((detail, e.Value?.ToString())))"
                                  readonly="@IsReadOnly" />;
                }
            },
            new InteractiveColumnDefinition
            {
                Title = "本次折讓",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "120px",
                CellCssClass = "text-end",
                CustomTemplate = item =>
                {
                    var detail = (SetoffDetailDto)item;
                    
                    return @<input type="text"
                                  class="form-control form-control-sm text-end"
                                  value="@(detail.ThisTimeDiscountAmount > 0 ? detail.ThisTimeDiscountAmount.ToString("N0") : "")"
                                  pattern="[0-9]*"
                                  inputmode="numeric"
                                  @oninput="@(async (e) => await HandleDiscountAmountChanged((detail, e.Value?.ToString())))"
                                  readonly="@IsReadOnly" />;
                }
            }
        };

        return columns;
    }

    /// <summary>
    /// 處理金額變更事件
    /// </summary>
    private async Task HandleAmountChanged((SetoffDetailDto detail, string? value) args)
    {
        try
        {
            if (string.IsNullOrWhiteSpace(args.value))
            {
                // 當輸入為空時，設置為 0，但保持可編輯狀態
                args.detail.ThisTimeAmount = 0;
            }
            else if (decimal.TryParse(args.value, out var amount))
            {
                // 確保金額不超過可用金額，且不為負數
                var availableAmount = args.detail.PendingAmount - args.detail.ThisTimeDiscountAmount;
                args.detail.ThisTimeAmount = Math.Max(0, Math.Min(amount, availableAmount));
            }
            else
            {
                // 輸入無效時，保持原值不變，不要設置為 0
                // 這樣可以避免在用戶輸入過程中破壞編輯狀態
                return;
            }
            
            // 驗證所有金額
            ValidateAmounts();
            
            // 通知選擇變更 (這裡面會調用 StateHasChanged)
            await NotifySelectionChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleAmountChanged), GetType());
        }
    }

    /// <summary>
    /// 處理折讓金額變更事件
    /// </summary>
    private async Task HandleDiscountAmountChanged((SetoffDetailDto detail, string? value) args)
    {
        try
        {
            if (string.IsNullOrWhiteSpace(args.value))
            {
                // 當輸入為空時，設置為 0，但保持可編輯狀態
                args.detail.ThisTimeDiscountAmount = 0;
            }
            else if (decimal.TryParse(args.value, out var amount))
            {
                // 確保金額不超過可用金額，且不為負數
                var availableAmount = args.detail.PendingAmount - args.detail.ThisTimeAmount;
                args.detail.ThisTimeDiscountAmount = Math.Max(0, Math.Min(amount, availableAmount));
            }
            else
            {
                // 輸入無效時，保持原值不變
                return;
            }
            
            // 驗證所有金額
            ValidateAmounts();
            
            // 通知選擇變更
            await NotifySelectionChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDiscountAmountChanged), GetType());
        }
    }


    /// <summary>
    /// 驗證金額
    /// </summary>
    private void ValidateAmounts()
    {
        ValidationErrors.Clear();
        
        foreach (var detail in Details.Where(d => d.ThisTimeAmount > 0 || d.ThisTimeDiscountAmount > 0))
        {
            // 驗證本次沖款金額
            var amountValidation = detail.ValidateThisTimeAmount();
            if (!amountValidation.IsValid)
            {
                var key = $"{detail.GetHashCode()}_{nameof(SetoffDetailDto.ThisTimeAmount)}";
                ValidationErrors[key] = amountValidation.ErrorMessage!;
            }
            
            // 驗證本次折讓金額
            var discountValidation = detail.ValidateThisTimeDiscountAmount();
            if (!discountValidation.IsValid)
            {
                var key = $"{detail.GetHashCode()}_{nameof(SetoffDetailDto.ThisTimeDiscountAmount)}";
                ValidationErrors[key] = discountValidation.ErrorMessage!;
            }
            
            // 驗證總金額
            var totalValidation = detail.ValidateTotalThisTimeAmount();
            if (!totalValidation.IsValid)
            {
                var key = $"{detail.GetHashCode()}_Total";
                ValidationErrors[key] = totalValidation.ErrorMessage!;
            }
        }
    }

    /// <summary>
    /// 處理驗證失敗事件
    /// </summary>
    private async Task HandleValidationFailed((SetoffDetailDto item, string propertyName, string? errorMessage) args)
    {
        try
        {
            if (!string.IsNullOrEmpty(args.errorMessage))
            {
                await NotificationService.ShowErrorAsync("驗證失敗", args.errorMessage);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleValidationFailed), GetType());
        }
    }

    /// <summary>
    /// 通知選擇變更
    /// </summary>
    private async Task NotifySelectionChanged()
    {
        try
        {
            var selectedDetails = SelectedDetails;
            var totalAmount = selectedDetails.Sum(d => d.ThisTimeAmount);

            if (OnSelectedDetailsChanged.HasDelegate)
            {
                await OnSelectedDetailsChanged.InvokeAsync(selectedDetails);
            }

            if (OnTotalAmountChanged.HasDelegate)
            {
                await OnTotalAmountChanged.InvokeAsync(totalAmount);
            }
            
            // 確保 UI 狀態更新
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(NotifySelectionChanged), GetType());
        }
    }
    #endregion

    #region 公開方法
    /// <summary>
    /// 重新整理資料
    /// </summary>
    public async Task RefreshAsync()
    {
        await LoadDetailsAsync();
    }

    /// <summary>
    /// 清除選擇
    /// </summary>
    public void ClearSelection()
    {
        foreach (var detail in Details)
        {
            detail.ThisTimeAmount = 0;
            detail.ThisTimeDiscountAmount = 0;
        }
        ValidationErrors.Clear();
        StateHasChanged();
    }

    /// <summary>
    /// 取得選中的明細項目
    /// </summary>
    /// <returns>選中的明細項目列表</returns>
    public List<SetoffDetailDto> GetSelectedDetails()
    {
        return SelectedDetails;
    }

    /// <summary>
    /// 取得總沖款金額（包含沖款和折讓）
    /// </summary>
    /// <returns>總沖款金額</returns>
    public decimal GetTotalAmount()
    {
        return SelectedDetails.Sum(d => d.ThisTimeAmount + d.ThisTimeDiscountAmount);
    }
    
    /// <summary>
    /// 取得總沖款金額（僅現金沖款）
    /// </summary>
    /// <returns>總沖款金額</returns>
    public decimal GetTotalCashAmount()
    {
        return SelectedDetails.Sum(d => d.ThisTimeAmount);
    }
    
    /// <summary>
    /// 取得總折讓金額
    /// </summary>
    /// <returns>總折讓金額</returns>
    public decimal GetTotalDiscountAmount()
    {
        return SelectedDetails.Sum(d => d.ThisTimeDiscountAmount);
    }

    /// <summary>
    /// 驗證選中的項目
    /// </summary>
    /// <returns>驗證結果</returns>
    public (bool IsValid, List<string> Errors) ValidateSelection()
    {
        var errors = new List<string>();
        
        if (!SelectedDetails.Any())
        {
            errors.Add("請至少選擇一筆明細項目");
        }

        foreach (var detail in SelectedDetails)
        {
            // 驗證沖款金額
            if (detail.ThisTimeAmount > 0)
            {
                var amountValidation = detail.ValidateThisTimeAmount();
                if (!amountValidation.IsValid)
                {
                    errors.Add($"{detail.DocumentNumber} - 沖款金額: {amountValidation.ErrorMessage}");
                }
            }
            
            // 驗證折讓金額
            if (detail.ThisTimeDiscountAmount > 0)
            {
                var discountValidation = detail.ValidateThisTimeDiscountAmount();
                if (!discountValidation.IsValid)
                {
                    errors.Add($"{detail.DocumentNumber} - 折讓金額: {discountValidation.ErrorMessage}");
                }
            }
            
            // 驗證總金額
            var totalValidation = detail.ValidateTotalThisTimeAmount();
            if (!totalValidation.IsValid)
            {
                errors.Add($"{detail.DocumentNumber} - {totalValidation.ErrorMessage}");
            }
        }

        return (errors.Count == 0, errors);
    }
    #endregion
}