@inject INotificationService NotificationService
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="modal fade @(IsVisible ? "show" : "")" 
     style="display: @(IsVisible ? "block" : "none"); background-color: rgba(0,0,0,0.5);" 
     tabindex="-1" 
     role="dialog"
     @onclick="@(() => HandleBackdropClick())">
    
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" 
         role="document"
         @onclick:stopPropagation="true">
        <div class="modal-content shadow-lg">
            @* Modal Header *@
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-link-45deg me-2"></i>
                    相關單據 - @ProductName
                </h5>
                <GenericButtonComponent Type="button" 
                                      CssClass="btn-close" 
                                      OnClick="Close" 
                                      Title="關閉" />
            </div>

            @* Modal Body *@
            <div class="modal-body">
                @if (IsLoading)
                {
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">載入中...</span>
                        </div>
                        <p class="mt-3 text-muted">正在載入相關單據...</p>
                    </div>
                }
                else if (RelatedDocuments == null || !RelatedDocuments.Any())
                {
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <p class="mt-3 text-muted">暫無相關單據</p>
                    </div>
                }
                else
                {
                    var receivingDocs = RelatedDocuments.Where(d => d.DocumentType == RelatedDocumentType.ReceivingDocument).ToList();
                    var returnDocs = RelatedDocuments.Where(d => d.DocumentType == RelatedDocumentType.ReturnDocument).ToList();
                    var setoffDocs = RelatedDocuments.Where(d => d.DocumentType == RelatedDocumentType.SetoffDocument).ToList();
                    
                    @* 入庫單區塊 *@
                    @if (receivingDocs.Any())
                    {
                        <div class="mb-4">
                            <h6 class="text-info mb-3">
                                <i class="bi bi-box-seam me-2"></i>
                                入庫記錄 (@receivingDocs.Count)
                            </h6>
                            <div class="list-group">
                                @foreach (var doc in receivingDocs)
                                {
                                    <a href="javascript:void(0)" 
                                       class="list-group-item list-group-item-action"
                                       @onclick="@(() => HandleDocumentClick(doc))">
                                        <div class="d-flex w-100 justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">
                                                    <span class="badge bg-info me-2">
                                                        <i class="@doc.Icon me-1"></i>
                                                        @doc.TypeDisplayName
                                                    </span>
                                                    @doc.DocumentNumber
                                                </h6>
                                                <p class="mb-1 text-muted small">
                                                    <span class="text-nowrap">
                                                        <i class="bi bi-calendar3 me-1"></i>
                                                        @doc.DocumentDate.ToString("yyyy-MM-dd")
                                                    </span>
                                                    @if (doc.Quantity.HasValue)
                                                    {
                                                        <span class="ms-3 text-nowrap">
                                                            <i class="bi bi-box-seam me-1"></i>
                                                            入庫數量: @doc.Quantity.Value
                                                        </span>
                                                    }
                                                    @if (doc.UnitPrice.HasValue)
                                                    {
                                                        <span class="ms-3 text-nowrap">
                                                            <i class="bi bi-cash me-1"></i>
                                                            單價: @doc.UnitPrice.Value.ToString("N2")
                                                        </span>
                                                    }
                                                </p>
                                                @if (!string.IsNullOrEmpty(doc.Remarks))
                                                {
                                                    <p class="mb-0 text-muted small">
                                                        <i class="bi bi-chat-left-text me-1"></i>
                                                        @doc.Remarks
                                                    </p>
                                                }
                                            </div>
                                            <div>
                                                <i class="bi bi-chevron-right"></i>
                                            </div>
                                        </div>
                                    </a>
                                }
                            </div>
                        </div>
                    }
                    
                    @* 退貨單區塊 *@
                    @if (returnDocs.Any())
                    {
                        <div class="mb-4">
                            <h6 class="text-warning mb-3">
                                <i class="bi bi-arrow-return-left me-2"></i>
                                退貨記錄 (@returnDocs.Count)
                            </h6>
                            <div class="list-group">
                                @foreach (var doc in returnDocs)
                                {
                                    <a href="javascript:void(0)" 
                                       class="list-group-item list-group-item-action"
                                       @onclick="@(() => HandleDocumentClick(doc))">
                                        <div class="d-flex w-100 justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">
                                                    <span class="badge bg-warning text-dark me-2">
                                                        <i class="@doc.Icon me-1"></i>
                                                        @doc.TypeDisplayName
                                                    </span>
                                                    @doc.DocumentNumber
                                                </h6>
                                                <p class="mb-1 text-muted small">
                                                    <span class="text-nowrap">
                                                        <i class="bi bi-calendar3 me-1"></i>
                                                        @doc.DocumentDate.ToString("yyyy-MM-dd")
                                                    </span>
                                                    @if (doc.Quantity.HasValue)
                                                    {
                                                        <span class="ms-3 text-nowrap">
                                                            <i class="bi bi-box-seam me-1"></i>
                                                            退貨數量: @doc.Quantity.Value
                                                        </span>
                                                    }
                                                </p>
                                                @if (!string.IsNullOrEmpty(doc.Remarks))
                                                {
                                                    <p class="mb-0 text-muted small">
                                                        <i class="bi bi-chat-left-text me-1"></i>
                                                        @doc.Remarks
                                                    </p>
                                                }
                                            </div>
                                            <div>
                                                <i class="bi bi-chevron-right"></i>
                                            </div>
                                        </div>
                                    </a>
                                }
                            </div>
                        </div>
                    }

                    @* 沖款單區塊 *@
                    @if (setoffDocs.Any())
                    {
                        <div class="mb-4">
                            <h6 class="text-success mb-3">
                                <i class="bi bi-cash-coin me-2"></i>
                                沖款記錄 (@setoffDocs.Count)
                            </h6>
                            <div class="list-group">
                                @foreach (var doc in setoffDocs)
                                {
                                    <a href="javascript:void(0)" 
                                       class="list-group-item list-group-item-action"
                                       @onclick="@(() => HandleDocumentClick(doc))">
                                        <div class="d-flex w-100 justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">
                                                    <span class="badge bg-success me-2">
                                                        <i class="@doc.Icon me-1"></i>
                                                        @doc.TypeDisplayName
                                                    </span>
                                                    @doc.DocumentNumber
                                                </h6>
                                                <p class="mb-1 text-muted small">
                                                    <span class="text-nowrap">
                                                        <i class="bi bi-calendar3 me-1"></i>
                                                        @doc.DocumentDate.ToString("yyyy-MM-dd")
                                                    </span>
                                                    @if (doc.CurrentAmount.HasValue)
                                                    {
                                                        <span class="ms-3 text-nowrap">
                                                            <i class="bi bi-currency-dollar me-1"></i>
                                                            本次收款: @doc.CurrentAmount.Value.ToString("N2")
                                                        </span>
                                                    }
                                                    @if (doc.TotalAmount.HasValue)
                                                    {
                                                        <span class="ms-3 text-nowrap">
                                                            <i class="bi bi-cash-stack me-1"></i>
                                                            累計收款: @doc.TotalAmount.Value.ToString("N2")
                                                        </span>
                                                    }
                                                </p>
                                                @if (!string.IsNullOrEmpty(doc.Remarks))
                                                {
                                                    <p class="mb-0 text-muted small">
                                                        <i class="bi bi-chat-left-text me-1"></i>
                                                        @doc.Remarks
                                                    </p>
                                                }
                                            </div>
                                            <div>
                                                <i class="bi bi-chevron-right"></i>
                                            </div>
                                        </div>
                                    </a>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public string ProductName { get; set; } = string.Empty;
    [Parameter] public List<RelatedDocument>? RelatedDocuments { get; set; }
    [Parameter] public bool IsLoading { get; set; }
    
    /// <summary>
    /// 當點擊單據時觸發，傳回單據資訊供父組件開啟對應的 EditModal
    /// </summary>
    [Parameter] public EventCallback<RelatedDocument> OnDocumentClick { get; set; }

    // ===== ESC 鍵支援 =====
    private DotNetObjectReference<RelatedDocumentsModalComponent>? _escKeyDotNetRef;
    private bool _isEscKeyListenerActive = false;
    private bool _isDisposed = false;
    private readonly object _escKeyLock = new object();

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        
        // 當 Modal 可見時，設置 ESC 鍵監聽器
        if (IsVisible)
        {
            bool shouldSetup;
            lock (_escKeyLock)
            {
                shouldSetup = !_isEscKeyListenerActive;
            }
            
            if (shouldSetup)
            {
                await SetupEscKeyListenerAsync();
            }
        }
        else
        {
            // 當 Modal 不可見時，清理 ESC 鍵監聽器
            bool shouldCleanup;
            lock (_escKeyLock)
            {
                shouldCleanup = _isEscKeyListenerActive;
            }
            
            if (shouldCleanup)
            {
                await CleanupEscKeyListenerAsync();
            }
        }
    }

    /// <summary>
    /// 設置 ESC 鍵監聽器
    /// </summary>
    private async Task SetupEscKeyListenerAsync()
    {
        try
        {
            lock (_escKeyLock)
            {
                // 如果已經設置過，不重複設置
                if (_isEscKeyListenerActive && _escKeyDotNetRef != null)
                {
                    return;
                }
                
                _isEscKeyListenerActive = true;
            }
            
            // 創建新的 DotNetObjectReference
            lock (_escKeyLock)
            {
                _escKeyDotNetRef = DotNetObjectReference.Create(this);
            }
            
            await JSRuntime.InvokeVoidAsync("setupEscKeyListener", _escKeyDotNetRef);
        }
        catch (Exception ex)
        {
            lock (_escKeyLock)
            {
                _isEscKeyListenerActive = false;
            }
            System.Diagnostics.Debug.WriteLine($"SetupEscKeyListener Error: {ex.Message}");
        }
    }

    /// <summary>
    /// 清理 ESC 鍵事件監聽器
    /// </summary>
    private async Task CleanupEscKeyListenerAsync()
    {
        DotNetObjectReference<RelatedDocumentsModalComponent>? refToDispose = null;
        
        lock (_escKeyLock)
        {
            // 如果已經清理過，不重複清理
            if (!_isEscKeyListenerActive)
            {
                return;
            }
            
            _isEscKeyListenerActive = false;
            refToDispose = _escKeyDotNetRef;
            _escKeyDotNetRef = null;
        }
        
        try
        {
            // 先調用 JavaScript 清理
            await JSRuntime.InvokeVoidAsync("cleanupEscKeyListener");
            
            // 給 JavaScript 更多時間完成清理
            await Task.Delay(200);
            
            // 在鎖外釋放資源，避免死鎖
            if (refToDispose != null)
            {
                try
                {
                    refToDispose.Dispose();
                }
                catch (ObjectDisposedException)
                {
                    // 對象已被釋放，這是正常的
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Debug.WriteLine($"DotNetObjectReference dispose warning: {ex.Message}");
                }
            }
        }
        catch (JSDisconnectedException)
        {
            // Blazor 連接已斷開，這是正常的
        }
        catch (TaskCanceledException)
        {
            // 任務被取消，這是正常的
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"CleanupEscKeyListener Error: {ex.Message}");
        }
    }

    /// <summary>
    /// 處理 ESC 鍵按下事件（由 JavaScript 調用）
    /// </summary>
    [JSInvokable]
    public async Task HandleEscapeKey()
    {
        try
        {
            // 增加額外的安全檢查
            if (_isDisposed)
            {
                return;
            }
            
            if (IsVisible && !IsLoading)
            {
                await Close();
            }
        }
        catch (ObjectDisposedException)
        {
            // 忽略已釋放物件的錯誤
        }
        catch (InvalidOperationException)
        {
            // 忽略無效操作錯誤（通常發生在組件已被釋放時）
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"ESC Error: {ex.Message}");
        }
    }

    private async Task Close()
    {
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(false);
    }

    private void HandleBackdropClick()
    {
        // 點擊背景不關閉，維持開啟狀態
        // 這樣可以讓使用者同時看到多個 Modal
    }

    private async Task HandleDocumentClick(RelatedDocument document)
    {
        if (OnDocumentClick.HasDelegate)
        {
            await OnDocumentClick.InvokeAsync(document);
        }
    }

    public void Dispose()
    {
        try
        {
            _isDisposed = true;
            
            // 清理 ESC 鍵監聽器
            lock (_escKeyLock)
            {
                _isEscKeyListenerActive = false;
            }
            
            // 同步清理 DotNet 對象引用
            var refToDispose = _escKeyDotNetRef;
            _escKeyDotNetRef = null;
            
            if (refToDispose != null)
            {
                try
                {
                    refToDispose.Dispose();
                }
                catch (ObjectDisposedException)
                {
                    // 忽略，對象已被釋放
                }
            }
            
            // JavaScript 端的清理將由下一個 Modal 打開時處理，或在頁面卸載時自動清理
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Dispose Error: {ex.Message}");
        }
    }
}
