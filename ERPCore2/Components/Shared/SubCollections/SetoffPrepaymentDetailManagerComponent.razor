@* 沖款預收付款項管理組件 - 管理預收付款項的使用記錄 *@

@inject ISetoffPrepaymentService SetoffPrepaymentService
@inject ISetoffPrepaymentUsageService SetoffPrepaymentUsageService
@inject IPrepaymentTypeService PrepaymentTypeService
@inject INotificationService NotificationService

<div class="card-body p-0">
    <InteractiveTableComponent TItem="SetoffPrepaymentItem" 
                                Items="@PrepaymentItems"
                                ColumnDefinitions="@GetPrepaymentColumnDefinitions()"
                                IsReadOnly="@IsReadOnly"
                                ShowRowNumbers="false"
                                EmptyMessage="尚未新增預收付款項記錄"
                                ShowBuiltInActions="true"
                                ShowBuiltInDeleteButton="true"
                                OnItemDelete="@HandleRemovePrepaymentRecord"
                                ActionsColumnWidth = "60px" />
</div>

@code {
    // ===== 參數定義 =====
    [Parameter] public int? SetoffDocumentId { get; set; }
    [Parameter] public int? CustomerId { get; set; }
    [Parameter] public int? SupplierId { get; set; }
    [Parameter] public SetoffType SetoffType { get; set; } // 新增：沖款類型（應收/應付）
    [Parameter] public string? SetoffDocumentNumber { get; set; } // 沖款單號（用於設定來源單號）
    
    // 資料綁定
    [Parameter] public List<SetoffPrepayment> ExistingPrepayments { get; set; } = new();
    [Parameter] public EventCallback<List<SetoffPrepayment>> OnPrepaymentsChanged { get; set; }
    
    // 顯示控制
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== 內部狀態 =====
    private List<SetoffPrepaymentItem> PrepaymentItems { get; set; } = new();
    private List<SetoffPrepayment> AvailablePrepayments { get; set; } = new();
    private List<PrepaymentType> AllPrepaymentTypes { get; set; } = new();
    private List<PrepaymentType> FilteredPrepaymentTypes { get; set; } = new();
    
    // 用於追蹤參數變更，避免不必要的重新載入
    private int? _previousCustomerId;
    private int? _previousSupplierId;
    private int _previousExistingPrepaymentsCount;

    // ===== 計算屬性 =====
    /// <summary>
    /// 取得總金額（預收/預付類型的 Amount + 轉沖款類型的 UsedAmount）
    /// </summary>
    private decimal TotalUsedAmount => PrepaymentItems
        .Where(p => !IsEmptyRow(p))
        .Sum(p =>
        {
            // 判斷是否為轉沖款類型
            if (p.PrepaymentTypeId.HasValue)
            {
                var selectedType = FilteredPrepaymentTypes.FirstOrDefault(pt => pt.Id == p.PrepaymentTypeId.Value);
                if (selectedType != null && IsTransferType(selectedType.Name))
                {
                    // 轉沖款類型：計算 UsedAmount
                    return p.UsedAmount;
                }
            }
            // 預收/預付類型：計算 Amount
            return p.Amount;
        });

    // ===== 生命週期方法 =====
    protected override async Task OnInitializedAsync()
    {
        await LoadPrepaymentTypesAsync();
        // 此時不篩選類型，因為 SetoffType 參數可能還未設定
        // FilterPrepaymentTypes() 會在 OnParametersSetAsync() 中執行
        await LoadAvailablePrepaymentsAsync();
        LoadExistingPrepayments();
        
        // 初始化追蹤變數
        _previousCustomerId = CustomerId;
        _previousSupplierId = SupplierId;
        _previousExistingPrepaymentsCount = ExistingPrepayments?.Count ?? 0;
    }

    protected override async Task OnParametersSetAsync()
    {
        // 篩選預收付類型（確保 SetoffType 已正確設定）
        FilterPrepaymentTypes();
        
        // 只有當 CustomerId 或 SupplierId 真正變更時，才重新載入可用的預收付款項
        if (_previousCustomerId != CustomerId || _previousSupplierId != SupplierId)
        {
            await LoadAvailablePrepaymentsAsync();
            _previousCustomerId = CustomerId;
            _previousSupplierId = SupplierId;
        }
        
        // 只有當 ExistingPrepayments 真正變更時（數量不同），才重新載入資料
        var currentCount = ExistingPrepayments?.Count ?? 0;
        if (_previousExistingPrepaymentsCount != currentCount)
        {
            LoadExistingPrepayments();
            _previousExistingPrepaymentsCount = currentCount;
        }
        
        // 總是確保有一行空行可以輸入（這不會覆蓋現有資料）
        EnsureOneEmptyRow();
        
        await base.OnParametersSetAsync();
    }

    // ===== AutoEmptyRowHelper 相關方法 =====
    
    /// <summary>
    /// 檢查是否為空行
    /// 業務邏輯：只要選擇了預收付類型，就算是有效的一行，不再是空行
    /// </summary>
    private bool IsEmptyRow(SetoffPrepaymentItem item)
    {
        // 檢查預收付類型是否為空（null 或 0 都算空）
        var isEmpty = !item.PrepaymentTypeId.HasValue || item.PrepaymentTypeId.Value <= 0;
        
        // 只要預收付類型有值（大於0），就不是空行
        // 預收付類型是核心欄位，其他欄位可以後續填寫
        return isEmpty;
    }
    
    /// <summary>
    /// 創建空的預收付款項記錄項目
    /// </summary>
    private SetoffPrepaymentItem CreateEmptyItem()
    {
        return new SetoffPrepaymentItem
        {
            Id = 0,
            PrepaymentTypeId = null,
            SourcePrepaymentId = null,
            SourceDocumentCode = string.Empty,
            Amount = 0,
            UsedAmount = 0,
            ExistingPrepayment = null
        };
    }
    
    /// <summary>
    /// 確保有一行空行
    /// </summary>
    private void EnsureOneEmptyRow()
    {
        // 確保有一行空行可以輸入
        AutoEmptyRowHelper.For<SetoffPrepaymentItem>.EnsureOneEmptyRow(
            PrepaymentItems, 
            IsEmptyRow, 
            CreateEmptyItem, 
            null, 
            SetoffDocumentId ?? 0
        );
    }

    // ===== 資料載入方法 =====
    
    /// <summary>
    /// 載入所有預收付類型
    /// </summary>
    private async Task LoadPrepaymentTypesAsync()
    {
        try
        {
            AllPrepaymentTypes = await PrepaymentTypeService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入預收付類型失敗：{ex.Message}");
            AllPrepaymentTypes = new List<PrepaymentType>();
            FilteredPrepaymentTypes = new List<PrepaymentType>();
        }
    }
    
    /// <summary>
    /// 根據沖款類型篩選預收付類型
    /// 應收：顯示「預收」和「預收轉沖款」
    /// 應付：顯示「預付」和「預付轉沖款」
    /// </summary>
    private void FilterPrepaymentTypes()
    {
        if (AllPrepaymentTypes == null || !AllPrepaymentTypes.Any())
        {
            FilteredPrepaymentTypes = new List<PrepaymentType>();
            return;
        }
        
        if (SetoffType == SetoffType.AccountsReceivable)
        {
            // 應收帳款：顯示所有「預收」相關類型（包括預收和預收轉沖款）
            FilteredPrepaymentTypes = AllPrepaymentTypes
                .Where(pt => pt.Name.Contains("預收"))
                .ToList();
        }
        else if (SetoffType == SetoffType.AccountsPayable)
        {
            // 應付帳款：顯示所有「預付」相關類型（包括預付和預付轉沖款）
            FilteredPrepaymentTypes = AllPrepaymentTypes
                .Where(pt => pt.Name.Contains("預付"))
                .ToList();
        }
        else
        {
            FilteredPrepaymentTypes = new List<PrepaymentType>();
        }
    }
    
    private async Task LoadAvailablePrepaymentsAsync()
    {
        try
        {
            // 根據客戶或供應商載入可用的預收付款項
            if (CustomerId.HasValue && CustomerId.Value > 0)
            {
                AvailablePrepayments = await SetoffPrepaymentService.GetAvailableByCustomerIdAsync(CustomerId.Value);
            }
            else if (SupplierId.HasValue && SupplierId.Value > 0)
            {
                AvailablePrepayments = await SetoffPrepaymentService.GetAvailableBySupplierIdAsync(SupplierId.Value);
            }
            else
            {
                AvailablePrepayments = new List<SetoffPrepayment>();
            }
            
            // ✅ 載入可用預收付款項後，自動比對並設定編輯模式下的 SourcePrepaymentId
            MatchSourcePrepaymentIds();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入可用預收付款項失敗：{ex.Message}");
            AvailablePrepayments = new List<SetoffPrepayment>();
        }
    }
    
    /// <summary>
    /// 自動比對並設定 SourcePrepaymentId（編輯模式用）
    /// </summary>
    private void MatchSourcePrepaymentIds()
    {
        if (!PrepaymentItems.Any() || !AvailablePrepayments.Any())
            return;
        
        foreach (var item in PrepaymentItems)
        {
            // 只處理轉沖款類型且尚未設定 SourcePrepaymentId 的項目
            if (!item.PrepaymentTypeId.HasValue)
                continue;
            
            var selectedType = FilteredPrepaymentTypes?.FirstOrDefault(pt => pt.Id == item.PrepaymentTypeId.Value);
            if (selectedType == null || !IsTransferType(selectedType.Name))
                continue;
            
            // 如果已經有 SourcePrepaymentId，不需要再比對
            if (item.SourcePrepaymentId.HasValue && item.SourcePrepaymentId.Value > 0)
                continue;
            
            // 根據 SourceDocumentCode 查詢對應的來源預收付款項
            if (!string.IsNullOrEmpty(item.SourceDocumentCode))
            {
                var sourcePrepayment = AvailablePrepayments.FirstOrDefault(p => p.SourceDocumentCode == item.SourceDocumentCode);
                if (sourcePrepayment != null)
                {
                    item.SourcePrepaymentId = sourcePrepayment.Id;
                    
                    // 同時設定 Amount（來源的總金額，用於顯示）
                    if (item.Amount == 0)
                    {
                        item.Amount = sourcePrepayment.Amount;
                    }
                }
            }
        }
    }

    private void LoadExistingPrepayments()
    {
        Console.WriteLine($"[LoadExistingPrepayments] 開始載入現有預收付款項");
        Console.WriteLine($"  ExistingPrepayments?.Count: {ExistingPrepayments?.Count ?? 0}");
        
        if (ExistingPrepayments?.Any() == true)
        {
            // 編輯模式：載入已存在的預收付款項記錄
            Console.WriteLine($"[LoadExistingPrepayments] 編輯模式：有 {ExistingPrepayments.Count} 筆現有資料");
            
            PrepaymentItems = ExistingPrepayments.Select((prepayment, index) => 
            {
                // ✅ 從 Remarks 中解析 SourcePrepaymentId（格式：SOURCE_ID:123）
                int? sourcePrepaymentId = null;
                if (!string.IsNullOrEmpty(prepayment.Remarks) && prepayment.Remarks.StartsWith("SOURCE_ID:"))
                {
                    var idPart = prepayment.Remarks.Substring("SOURCE_ID:".Length);
                    if (int.TryParse(idPart, out var parsedId))
                    {
                        sourcePrepaymentId = parsedId;
                    }
                }
                
                var item = new SetoffPrepaymentItem
                {
                    Id = prepayment.Id,
                    PrepaymentTypeId = prepayment.PrepaymentTypeId,
                    SourcePrepaymentId = sourcePrepaymentId,  // ✅ 設定從 Remarks 解析出的 SourcePrepaymentId
                    SourceDocumentCode = prepayment.SourceDocumentCode,
                    Amount = prepayment.Amount,
                    UsedAmount = prepayment.UsedAmount,
                    ExistingPrepayment = prepayment
                };
                
                Console.WriteLine($"  [{index}] 建立 item: Id={item.Id}, SourceCode={item.SourceDocumentCode}, Amount={item.Amount}, ExistingPrepayment.Id={item.ExistingPrepayment?.Id}");
                
                return item;
            }).ToList();
            
            Console.WriteLine($"[LoadExistingPrepayments] PrepaymentItems.Count: {PrepaymentItems.Count}");
            
            // ✅ 載入後立即嘗試比對 SourcePrepaymentId（如果 AvailablePrepayments 已載入）
            if (AvailablePrepayments?.Any() == true)
            {
                MatchSourcePrepaymentIds();
            }
        }
        else
        {
            // 新增模式：初始化為空列表
            Console.WriteLine($"[LoadExistingPrepayments] 新增模式：初始化空列表");
            PrepaymentItems = new List<SetoffPrepaymentItem>();
        }
    }

    // ===== InteractiveTable 欄位定義 =====
    private List<InteractiveColumnDefinition> GetPrepaymentColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = "預收付類型",
                PropertyName = nameof(SetoffPrepaymentItem.PrepaymentTypeId),
                ColumnType = InteractiveColumnType.Select,
                Width = "180px",
                IsRequired = true,
                Options = new List<InteractiveSelectOption> 
                { 
                    new InteractiveSelectOption { Value = 0, Text = "請選擇類型.." } 
                }
                .Concat((FilteredPrepaymentTypes ?? new List<PrepaymentType>()).Select(pt => new InteractiveSelectOption
                { 
                    Value = pt.Id, 
                    Text = pt.Name 
                })).ToList(),
                OnSelectionChanged = EventCallback.Factory.Create<(object, object?)>(this, async args =>
                {
                    var (itemObj, value) = args;
                    var item = (SetoffPrepaymentItem)itemObj;
                    var wasEmpty = IsEmptyRow(item);
                    
                    if (value != null && int.TryParse(value.ToString(), out int typeId) && typeId > 0)
                    {
                        item.PrepaymentTypeId = typeId;
                        
                        // 判斷是否需要顯示來源單號欄位
                        var selectedType = FilteredPrepaymentTypes!.FirstOrDefault(pt => pt.Id == typeId);
                        if (selectedType != null && !IsTransferType(selectedType.Name))
                        {
                            // 非轉沖款類型：清空來源相關欄位，設定來源單號為沖款單號
                            item.SourcePrepaymentId = null;
                            item.SourceDocumentCode = SetoffDocumentNumber ?? string.Empty;
                            item.Amount = 0;
                        }
                    }
                    else
                    {
                        item.PrepaymentTypeId = null;
                        item.SourcePrepaymentId = null;
                        item.SourceDocumentCode = string.Empty;
                        item.Amount = 0;
                        item.UsedAmount = 0;
                    }
                    
                    // 使用 AutoEmptyRowHelper 處理自動空行
                    AutoEmptyRowHelper.For<SetoffPrepaymentItem>.HandleInputChangeAdvanced(
                        PrepaymentItems, item, IsEmptyRow, CreateEmptyItem, wasEmpty, null, SetoffDocumentId ?? 0);
                    
                    await NotifyPrepaymentsChanged();
                    StateHasChanged();
                })
            },

            new()
            {
                Title = "來源單號",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "250px",
                CustomTemplate = item =>
                {
                    var prepaymentItem = (SetoffPrepaymentItem)item;
                    
                    // 檢查是否為轉沖款類型
                    if (!prepaymentItem.PrepaymentTypeId.HasValue)
                        return @<span class="text-muted">-</span>;
                    
                    var selectedType = FilteredPrepaymentTypes!.FirstOrDefault(pt => pt.Id == prepaymentItem.PrepaymentTypeId.Value);
                    if (selectedType == null || !IsTransferType(selectedType.Name))
                        return @<span class="text-muted">-</span>;
                    
                    // 建立下拉選單選項
                    var options = new List<InteractiveSelectOption> 
                    { 
                        new InteractiveSelectOption { Value = 0, Text = "請選擇預收付款項.." } 
                    };
                    
                    // 加入可用的預收付款項
                    var availableOptions = AvailablePrepayments.Select(p => new InteractiveSelectOption
                    { 
                        Value = p.Id, 
                        Text = $"{p.SourceDocumentCode} (可用餘額: {p.AvailableBalance:N2})" 
                    });
                    options.AddRange(availableOptions);
                    
                    var currentValue = prepaymentItem.SourcePrepaymentId ?? 0;
                    
                    // ✅ 編輯模式：如果當前選中的項目不在 AvailablePrepayments 中，需要加入到選項清單
                    // 這種情況發生在：來源預收付款項已經用完，不再顯示在可用清單中
                    if (currentValue > 0 && !options.Any(o => o.Value.Equals(currentValue)))
                    {
                        // 使用 SourceDocumentCode 和 Amount 顯示（因為 AvailablePrepayments 中找不到）
                        var displayText = !string.IsNullOrEmpty(prepaymentItem.SourceDocumentCode)
                            ? $"{prepaymentItem.SourceDocumentCode} (總金額: {prepaymentItem.Amount:N2})"
                            : "未知來源";
                        
                        // 插入到第二個位置（"請選擇..."之後）
                        options.Insert(1, new InteractiveSelectOption
                        {
                            Value = currentValue,
                            Text = displayText
                        });
                    }
                    
                    // 直接綁定到 item 的屬性，不使用局部變數
                    return @<select class="form-select form-select-sm" 
                                    value="@currentValue"
                                    disabled="@IsReadOnly"
                                    @onchange="@(async e => await OnSourcePrepaymentChangedAsync(prepaymentItem, e.Value?.ToString()))">
                        @foreach (var option in options)
                        {
                            <option value="@option.Value">@option.Text</option>
                        }
                    </select>;
                }
            },
            new()
            {
                Title = "總金額",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "120px",
                CustomTemplate = item =>
                {
                    var prepaymentItem = (SetoffPrepaymentItem)item;
                    
                    // 檢查是否為轉沖款類型
                    if (!prepaymentItem.PrepaymentTypeId.HasValue)
                        return @<span class="text-muted">-</span>;
                    
                    var selectedType = FilteredPrepaymentTypes!.FirstOrDefault(pt => pt.Id == prepaymentItem.PrepaymentTypeId.Value);
                    if (selectedType == null || !IsTransferType(selectedType.Name))
                        return @<span class="text-muted">-</span>;
                    
                    // 優先使用 item.Amount（編輯模式時已經設定好）
                    // 如果 Amount 為 0，則從 AvailablePrepayments 查詢（新增模式）
                    var amount = prepaymentItem.Amount;
                    if (amount == 0 && prepaymentItem.SourcePrepaymentId.HasValue)
                    {
                        var sourcePrepayment = AvailablePrepayments.FirstOrDefault(p => p.Id == prepaymentItem.SourcePrepaymentId);
                        amount = sourcePrepayment?.Amount ?? 0;
                    }
                    
                    return @<span class="text-muted">@amount.ToString("N2")</span>;
                }
            },
            new()
            {
                Title = "可用餘額",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "120px",
                CustomTemplate = item =>
                {
                    var prepaymentItem = (SetoffPrepaymentItem)item;
                    
                    // 檢查是否為轉沖款類型
                    if (!prepaymentItem.PrepaymentTypeId.HasValue)
                        return @<span class="text-muted">-</span>;
                    
                    var selectedType = FilteredPrepaymentTypes!.FirstOrDefault(pt => pt.Id == prepaymentItem.PrepaymentTypeId.Value);
                    if (selectedType == null || !IsTransferType(selectedType.Name))
                        return @<span class="text-muted">-</span>;
                    
                    var sourcePrepayment = AvailablePrepayments.FirstOrDefault(p => p.Id == prepaymentItem.SourcePrepaymentId);
                    var availableBalance = sourcePrepayment?.AvailableBalance ?? 0;
                    
                    return @<span class="text-primary fw-bold">@availableBalance.ToString("N2")</span>;
                }
            },
            new()
            {
                Title = "金額",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "150px",
                CustomTemplate = item =>
                {
                    var prepaymentItem = (SetoffPrepaymentItem)item;
                    
                    // 檢查是否為轉沖款類型
                    bool isTransferType = false;
                    if (prepaymentItem.PrepaymentTypeId.HasValue)
                    {
                        var selectedType = FilteredPrepaymentTypes!.FirstOrDefault(pt => pt.Id == prepaymentItem.PrepaymentTypeId.Value);
                        isTransferType = selectedType != null && IsTransferType(selectedType.Name);
                    }
                    
                    // 根據類型決定顯示的值
                    var displayValue = isTransferType ? prepaymentItem.UsedAmount : prepaymentItem.Amount;
                    
                    return @<input type="number" 
                                   class="form-control form-control-sm text-end" 
                                   value="@(displayValue == 0 ? "" : displayValue.ToString("F0"))" 
                                   onkeydown="if(['e','E','+','-'].includes(event.key)) event.preventDefault();"
                                   disabled="@IsReadOnly"
                                   step="1"
                                   min="0"
                                   placeholder=""
                                   @oninput="@(e => OnAmountInput(prepaymentItem, e.Value?.ToString()))" />;
                }
            }
        };

        return columns;
    }
    
    /// <summary>
    /// 判斷是否為轉沖款類型（預收轉沖款、預付轉沖款）
    /// </summary>
    private bool IsTransferType(string typeName)
    {
        return typeName.Contains("轉沖款");
    }
    
    /// <summary>
    /// 處理來源預收付款項變更
    /// </summary>
    private async Task OnSourcePrepaymentChangedAsync(SetoffPrepaymentItem item, string? value)
    {
        if (value != null && int.TryParse(value, out int prepaymentId) && prepaymentId > 0)
        {
            item.SourcePrepaymentId = prepaymentId;
            
            // 自動帶入來源預收付款項的資訊
            var selectedPrepayment = AvailablePrepayments.FirstOrDefault(p => p.Id == prepaymentId);
            if (selectedPrepayment != null)
            {
                item.SourceDocumentCode = selectedPrepayment.SourceDocumentCode;
                // ✅ 轉沖款類型：Amount 為來源的總金額（用於顯示），UsedAmount 為可用餘額
                item.Amount = selectedPrepayment.Amount;  // 設定來源的總金額
                item.UsedAmount = selectedPrepayment.AvailableBalance;
            }
        }
        else
        {
            item.SourcePrepaymentId = null;
            item.SourceDocumentCode = string.Empty;
            item.Amount = 0;
            item.UsedAmount = 0;
        }
        
        await NotifyPrepaymentsChanged();
        // 不呼叫 StateHasChanged()，讓 Blazor 自動處理渲染
    }

    // ===== 事件處理方法 =====
    private async Task HandleRemovePrepaymentRecord(SetoffPrepaymentItem item)
    {
        if (IsReadOnly) return;
        
        // 使用 AutoEmptyRowHelper 處理移除，自動確保空行
        AutoEmptyRowHelper.For<SetoffPrepaymentItem>.HandleItemRemove(
            PrepaymentItems, item, IsEmptyRow, CreateEmptyItem, null, SetoffDocumentId ?? 0);
        
        await NotificationService.ShowInfoAsync("已移除預收付款項記錄");
        await NotifyPrepaymentsChanged();
        StateHasChanged();
    }

    private async Task OnAmountInput(SetoffPrepaymentItem item, string? value)
    {
        var wasEmpty = IsEmptyRow(item);
        
        // 判斷是否為轉沖款類型
        bool isTransferType = false;
        if (item.PrepaymentTypeId.HasValue)
        {
            var selectedType = FilteredPrepaymentTypes.FirstOrDefault(pt => pt.Id == item.PrepaymentTypeId.Value);
            isTransferType = selectedType != null && IsTransferType(selectedType.Name);
        }
        
        if (decimal.TryParse(value, out var amount))
        {
            if (isTransferType)
            {
                // 轉沖款類型：輸入的是 UsedAmount，需檢查不能超過可用餘額
                var sourcePrepayment = AvailablePrepayments.FirstOrDefault(p => p.Id == item.SourcePrepaymentId);
                if (sourcePrepayment != null)
                {
                    if (amount > sourcePrepayment.AvailableBalance)
                    {
                        await NotificationService.ShowWarningAsync($"使用金額不能超過可用餘額 {sourcePrepayment.AvailableBalance:N2}");
                        item.UsedAmount = sourcePrepayment.AvailableBalance;
                    }
                    else if (amount < 0)
                    {
                        await NotificationService.ShowWarningAsync("使用金額不能小於 0");
                        item.UsedAmount = 0;
                    }
                    else
                    {
                        item.UsedAmount = amount;
                    }
                }
                else
                {
                    item.UsedAmount = amount;
                }
            }
            else
            {
                // 預收/預付類型：輸入的是 Amount
                if (amount < 0)
                {
                    await NotificationService.ShowWarningAsync("金額不能小於 0");
                    item.Amount = 0;
                }
                else
                {
                    item.Amount = amount;
                }
            }
        }
        else if (string.IsNullOrWhiteSpace(value))
        {
            // 如果輸入為空白，設為0
            if (isTransferType)
            {
                item.UsedAmount = 0;
            }
            else
            {
                item.Amount = 0;
            }
        }
        
        // 使用 AutoEmptyRowHelper 處理自動空行
        AutoEmptyRowHelper.For<SetoffPrepaymentItem>.HandleInputChangeAdvanced(
            PrepaymentItems, item, IsEmptyRow, CreateEmptyItem, wasEmpty, null, SetoffDocumentId ?? 0);
        
        await NotifyPrepaymentsChanged();
        StateHasChanged();
    }

    private async Task NotifyPrepaymentsChanged()
    {
        // 只傳遞非空行的預收付款項記錄
        var prepayments = PrepaymentItems
            .Where(item => !IsEmptyRow(item))
            .Select(item =>
            {
                // 如果是轉沖款類型，從 AvailablePrepayments 取得資料
                if (item.SourcePrepaymentId.HasValue && item.SourcePrepaymentId.Value > 0)
                {
                    var sourcePrepayment = AvailablePrepayments.FirstOrDefault(p => p.Id == item.SourcePrepaymentId);
                    if (sourcePrepayment == null)
                        return null;
                    
                    // ✅ 轉沖款類型：只增加 UsedAmount，Amount 設為 0
                    return new SetoffPrepayment
                    {
                        // ✅ 優先使用 item.Id（如果是編輯模式會有值），其次是 ExistingPrepayment?.Id
                        Id = item.Id > 0 ? item.Id : (item.ExistingPrepayment?.Id ?? 0),
                        SetoffDocumentId = SetoffDocumentId ?? 0,
                        PrepaymentTypeId = item.PrepaymentTypeId ?? 0,
                        SourceDocumentCode = sourcePrepayment.SourceDocumentCode,
                        Amount = 0,  // 轉沖款類型：Amount 為 0
                        UsedAmount = item.UsedAmount,  // 只記錄使用金額
                        CustomerId = sourcePrepayment.CustomerId,
                        SupplierId = sourcePrepayment.SupplierId,
                        // 重要：不設定導航屬性，避免 EF Core 追蹤衝突
                        PrepaymentType = null!,
                        Customer = null,
                        Supplier = null,
                        SetoffDocument = null
                    };
                }
                else
                {
                    // ✅ 預收/預付類型：只增加 Amount，UsedAmount 設為 0
                    return new SetoffPrepayment
                    {
                        // ✅ 優先使用 item.Id（如果是編輯模式會有值），其次是 ExistingPrepayment?.Id
                        Id = item.Id > 0 ? item.Id : (item.ExistingPrepayment?.Id ?? 0),
                        SetoffDocumentId = SetoffDocumentId ?? 0,
                        PrepaymentTypeId = item.PrepaymentTypeId ?? 0,
                        SourceDocumentCode = item.SourceDocumentCode,
                        Amount = item.Amount,  // 預收/預付類型：只記錄 Amount
                        UsedAmount = 0,  // UsedAmount 為 0
                        CustomerId = CustomerId,
                        SupplierId = SupplierId,
                        // 重要：不設定導航屬性，避免 EF Core 追蹤衝突
                        PrepaymentType = null!,
                        Customer = null,
                        Supplier = null,
                        SetoffDocument = null
                    };
                }
            })
            .Where(p => p != null)
            .Cast<SetoffPrepayment>()
            .ToList();

        await OnPrepaymentsChanged.InvokeAsync(prepayments);
    }

    // ===== 公開方法（供父組件調用）=====
    
    /// <summary>
    /// 取得總使用金額
    /// </summary>
    public decimal GetTotalUsedAmount() => TotalUsedAmount;

    /// <summary>
    /// 驗證預收付款項記錄
    /// </summary>
    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        var nonEmptyItems = PrepaymentItems.Where(item => !IsEmptyRow(item)).ToList();
        
        foreach (var item in nonEmptyItems)
        {
            // 檢查是否選擇了預收付類型
            if (!item.PrepaymentTypeId.HasValue || item.PrepaymentTypeId.Value <= 0)
            {
                errors.Add("請選擇預收付類型");
                continue;
            }
            
            var selectedType = FilteredPrepaymentTypes.FirstOrDefault(pt => pt.Id == item.PrepaymentTypeId.Value);
            if (selectedType != null && IsTransferType(selectedType.Name))
            {
                // 轉沖款類型：必須選擇來源預收付款項
                if (!item.SourcePrepaymentId.HasValue || item.SourcePrepaymentId.Value <= 0)
                {
                    errors.Add("轉沖款類型必須選擇來源預收付款項");
                    continue;
                }
                
                // 檢查使用金額是否超過可用餘額
                var sourcePrepayment = AvailablePrepayments.FirstOrDefault(p => p.Id == item.SourcePrepaymentId);
                if (sourcePrepayment != null && item.UsedAmount > sourcePrepayment.AvailableBalance)
                {
                    errors.Add($"來源單號 {sourcePrepayment.SourceDocumentCode} 的使用金額超過可用餘額");
                }
                
                // 轉沖款類型：檢查 UsedAmount 必須大於 0
                if (item.UsedAmount <= 0)
                {
                    errors.Add("使用金額必須大於 0");
                }
            }
            else if (selectedType != null)
            {
                // ✅ 預收/預付類型：檢查 Amount 必須大於 0
                if (item.Amount <= 0)
                {
                    errors.Add("金額必須大於 0");
                }
            }
        }
        
        if (errors.Any())
        {
            var errorMessage = string.Join("\n", errors);
            await NotificationService.ShowErrorAsync(errorMessage);
            return false;
        }
        
        return true;
    }

    // ===== 內部資料類別 =====
    private class SetoffPrepaymentItem : BaseEntity
    {
        public int? PrepaymentTypeId { get; set; }
        public int? SourcePrepaymentId { get; set; }
        public string SourceDocumentCode { get; set; } = string.Empty;
        public decimal Amount { get; set; }
        public decimal UsedAmount { get; set; }
        public SetoffPrepayment? ExistingPrepayment { get; set; }
    }
}
