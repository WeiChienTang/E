@* éŠ·å”®é€€è²¨å•†å“æ˜ç´°ç®¡ç†å…ƒä»¶ - ä½¿ç”¨ InteractiveTableComponent çµ±ä¸€UI ä¸¦æ•´åˆè‡ªå‹•ç©ºè¡ŒåŠŸèƒ½ *@

@inject ISalesOrderDetailService SalesOrderDetailService
@inject ISalesReturnDetailService SalesReturnDetailService
@inject INotificationService NotificationService
@inject IWarehouseLocationService WarehouseLocationService
@inject ISystemParameterService SystemParameterService
@inject IProductService ProductService
@inject RelatedDocumentsHelper RelatedDocumentsHelper

@if (!EffectiveCustomerId.HasValue || EffectiveCustomerId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="customer-warning">
                <i class="fas fa-user fa-2x mb-3 text-muted"></i>
                <p class="text-muted">é¸æ“‡å®¢æˆ¶å¾Œå³å¯æŸ¥çœ‹è©²å®¢æˆ¶å¯é€€è²¨çš„å•†å“</p>
            </div>
        </div>
    </div>
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent TItem="ReturnItem" 
                                      Items="@ReturnItems"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"
                                      ShowRowNumbers="false"
                                      EmptyMessage="@EmptyMessage"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="false"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"     
                                      ActionsColumnWidth = "60px"/>
        </div>

        <div class="card-footer">
            <div class="d-flex justify-content-between">
                <div class="d-flex gap-2">
                    @if (CanLoadAllReturnable)
                    {
                        <GenericButtonComponent Text="è¼‰å…¥å…¨éƒ¨å¯é€€"
                                              Icon="plus-circle"
                                              Variant="ButtonVariant.Primary"
                                              OnClick="@LoadAllReturnableItems" />
                    }
                </div>
                <div class="d-flex gap-2">
                    <GenericButtonComponent Text="é€€è²¨é‡å…¨å¡«"
                                          Icon="fill-drip"
                                          Variant="ButtonVariant.Success"
                                          OnClick="@FillAllQuantities" />
                    <GenericButtonComponent Text="é€€è²¨é‡æ¸…ç©º"
                                          Icon="eraser"
                                          Variant="ButtonVariant.Warning"
                                          OnClick="@ClearAllQuantities" />
                    <GenericButtonComponent Text="æ¸…é™¤æ˜ç´°"
                                          Icon="trash-alt"
                                          Variant="ButtonVariant.Info"
                                          OnClick="@ClearAllDetails" />
                </div>
            </div>
        </div>
    </div>
}

<!-- ç›¸é—œå–®æ“šæŸ¥çœ‹ Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

@code {
    // ===== åŸºæœ¬åƒæ•¸ =====
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public EventCallback<List<ReturnItem>> OnReturnItemsChanged { get; set; }
    
    // ===== å®¢æˆ¶éæ¿¾åƒæ•¸ =====
    [Parameter] public int? CustomerId { get; set; }
    [Parameter] public int? SelectedCustomerId { get; set; }
    
    // ===== ç¯©é¸åƒæ•¸ =====
    [Parameter] public int? SelectedSalesOrderId { get; set; }
    [Parameter] public int? FilterSalesOrderId { get; set; }
    [Parameter] public int? FilterProductId { get; set; }
    
    // ===== ç¾æœ‰æ˜ç´°åƒæ•¸ =====
    [Parameter] public List<SalesReturnDetail> ExistingReturnDetails { get; set; } = new List<SalesReturnDetail>();
    [Parameter] public EventCallback<List<SalesReturnDetail>> OnDetailsChanged { get; set; }
    [Parameter] public EventCallback<List<SalesReturnDetail>> OnReturnDetailsChanged { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    [Parameter] public EventCallback<ReturnItem> OnItemRemoved { get; set; }
    
    // ===== ç·¨è¼¯æ¨¡å¼åƒæ•¸ =====
    [Parameter] public bool IsEditMode { get; set; } = false;
    
    // ===== é¡¯ç¤ºè¨­å®š =====
    [Parameter] public string Title { get; set; } = "é€€è²¨æ˜ç´°";
    [Parameter] public string Subtitle { get; set; } = "";
    [Parameter] public string Icon { get; set; } = "undo";
    [Parameter] public string ItemDisplayName { get; set; } = "å•†å“";
    [Parameter] public string EmptyMessage { get; set; } = "å°šæœªæ–°å¢é€€è²¨å•†å“";
    
    // ===== å”¯è®€æ¨¡å¼åƒæ•¸ =====
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== ç‹€æ…‹é€šçŸ¥åƒæ•¸ =====
    /// <summary>
    /// ç‹€æ…‹é€šçŸ¥åƒæ•¸ - é€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
    /// </summary>
    [Parameter] public EventCallback<bool> OnHasUndeletableDetailsChanged { get; set; }
    
    // ===== ç›¸é—œå–®æ“šé–‹å•Ÿäº‹ä»¶ =====
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }

    private List<ReturnItem> ReturnItems { get; set; } = new List<ReturnItem>();
    private List<Product> AvailableProducts { get; set; } = new List<Product>();
    private List<SalesOrderDetail> AvailableOrderDetails { get; set; } = new List<SalesOrderDetail>();
    private int? _previousSelectedCustomerId = null;
    private int? _previousSelectedSalesOrderId = null;
    private int? _previousFilterProductId = null;
    private List<int> _deletedDetailIds { get; set; } = new List<int>();
    
    // ===== ç›¸é—œå–®æ“šæŸ¥çœ‹ =====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;

    // ===== è¨ˆç®—å±¬æ€§ =====
    private int? EffectiveCustomerId => CustomerId ?? SelectedCustomerId;
    private int? EffectiveSalesOrderId => FilterSalesOrderId ?? SelectedSalesOrderId;
    private int? EffectiveFilterProductId => FilterProductId;
    private EventCallback<List<SalesReturnDetail>> EffectiveDetailsChangedCallback => 
        OnReturnDetailsChanged.HasDelegate ? OnReturnDetailsChanged : OnDetailsChanged;
    
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦å¯ä»¥ä½¿ç”¨ã€Œè¼‰å…¥å…¨éƒ¨å¯é€€ã€åŠŸèƒ½
    /// è¦å‰‡ï¼š
    /// 1. å¿…é ˆé¸æ“‡å®¢æˆ¶
    /// 2. å¿…é ˆæœ‰å¯è¼‰å…¥çš„éŠ·å”®è¨‚å–®æ˜ç´°
    /// 3. ä¸å¯åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹ä½¿ç”¨ï¼ˆé¿å…è¦†è“‹ç¾æœ‰è³‡æ–™ï¼‰
    /// </summary>
    private bool CanLoadAllReturnable => 
        EffectiveCustomerId.HasValue && 
        EffectiveCustomerId.Value > 0 && 
        GetAvailableOrderDetails().Any() &&
        !IsEditMode; // ç·¨è¼¯æ¨¡å¼ä¸‹éš±è—æ­¤æŒ‰éˆ•
    
    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦æœ‰è¢«é–å®šçš„æ˜ç´°ï¼ˆæœ‰æ²–æ¬¾è¨˜éŒ„çš„æ˜ç´°ï¼‰
    /// </summary>
    private bool HasLockedDetails()
    {
        return ReturnItems.Any(item => 
            !IsEmptyRow(item) && HasPaymentRecord(item));
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadAvailableProductsAsync();
        LoadExistingDetailsAsync();
        EnsureOneEmptyRow();
        
        // ğŸ”‘ åˆå§‹åŒ–å¾Œé€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
        await NotifyHasUndeletableDetailsChanged();
    }

    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        
        // æª¢æŸ¥ç¯©é¸åƒæ•¸æ˜¯å¦è®Šæ›´
        bool customerChanged = _previousSelectedCustomerId != EffectiveCustomerId;
        bool salesOrderChanged = _previousSelectedSalesOrderId != EffectiveSalesOrderId;
        bool productFilterChanged = _previousFilterProductId != EffectiveFilterProductId;
        
        // å¦‚æœå®¢æˆ¶è®Šæ›´ï¼Œéœ€è¦é‡æ–°è¼‰å…¥æ‰€æœ‰è³‡æ–™
        if (customerChanged)
        {
            _previousSelectedCustomerId = EffectiveCustomerId;
            _previousSelectedSalesOrderId = EffectiveSalesOrderId;
            _previousFilterProductId = EffectiveFilterProductId;
            
            await LoadAvailableProductsAsync();
            
            // å®¢æˆ¶è®Šæ›´æ™‚æ¸…ç©ºç¾æœ‰é¸é …ä¸¦é‡æ–°è¼‰å…¥
            ReturnItems.Clear();
            LoadExistingDetailsAsync();
            return;
        }
        
        // å¦‚æœåªæ˜¯éŠ·å”®è¨‚å–®æˆ–å•†å“ç¯©é¸è®Šæ›´ï¼Œåªéœ€è¦æ›´æ–°ç¯©é¸ç‹€æ…‹ä¸¦é‡æ–°æ¸²æŸ“
        if (salesOrderChanged || productFilterChanged)
        {
            _previousSelectedSalesOrderId = EffectiveSalesOrderId;
            _previousFilterProductId = EffectiveFilterProductId;
            
            // è§¸ç™¼é‡æ–°æ¸²æŸ“ä»¥å¥—ç”¨æ–°çš„ç¯©é¸
            StateHasChanged();
            return;
        }
        
        // ç¸½æ˜¯ç¢ºä¿æœ‰ä¸€è¡Œç©ºè¡Œå¯ä»¥è¼¸å…¥ï¼Œä¸è«–æ˜¯å¦å·²æœ‰è³‡æ–™
        EnsureOneEmptyRow();
    }

    // ===== AutoEmptyRowHelper ç›¸é—œæ–¹æ³• =====
    private bool IsEmptyRow(ReturnItem item)
    {
        return item.SelectedOrderDetail == null && item.SelectedProduct == null;
    }
    
    private ReturnItem CreateEmptyItem()
    {
        return new ReturnItem();
    }
    
    private void EnsureOneEmptyRow()
    {
        AutoEmptyRowHelper.ForAny<ReturnItem>.EnsureOneEmptyRow(
            ReturnItems, 
            IsEmptyRow, 
            CreateEmptyItem
        );
    }

    // ===== æ²–æ¬¾è¨˜éŒ„æª¢æŸ¥æ–¹æ³• =====
    
    /// <summary>
    /// æª¢æŸ¥æŒ‡å®šçš„éŠ·è²¨é€€å›æ˜ç´°é …ç›®æ˜¯å¦æœ‰æ²–æ¬¾è¨˜éŒ„
    /// æª¢æŸ¥é‚è¼¯ï¼š
    /// - è³‡æ–™è¡¨ï¼šSalesReturnDetail
    /// - æ¬„ä½ï¼šTotalPaidAmount (ç´¯è¨ˆä»˜æ¬¾é‡‘é¡)
    /// - æ¢ä»¶ï¼šTotalPaidAmount > 0 è¡¨ç¤ºå·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œä¸å¯åˆªé™¤
    /// </summary>
    /// <param name="item">è¦æª¢æŸ¥çš„é€€è²¨æ˜ç´°é …ç›®</param>
    /// <returns>true è¡¨ç¤ºæœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œfalse è¡¨ç¤ºæ²’æœ‰</returns>
    private bool HasPaymentRecord(ReturnItem item)
    {
        if (item.ExistingDetailEntity != null && item.ExistingDetailEntity.Id > 0)
        {
            // æª¢æŸ¥ TotalPaidAmount æ˜¯å¦å¤§æ–¼ 0
            return item.ExistingDetailEntity.TotalPaidAmount > 0;
        }
        return false;
    }
    
    /// <summary>
    /// å–å¾—æŒ‡å®šé€€è²¨æ˜ç´°é …ç›®çš„å·²æ²–æ¬¾é‡‘é¡
    /// </summary>
    /// <param name="item">è¦æª¢æŸ¥çš„é€€è²¨æ˜ç´°é …ç›®</param>
    /// <returns>å·²æ²–æ¬¾é‡‘é¡</returns>
    private decimal GetPaidAmount(ReturnItem item)
    {
        if (item.ExistingDetailEntity != null && item.ExistingDetailEntity.Id > 0)
        {
            return item.ExistingDetailEntity.TotalPaidAmount;
        }
        return 0;
    }
    
    /// <summary>
    /// æª¢æŸ¥é …ç›®æ˜¯å¦å¯ä»¥åˆªé™¤
    /// æª¢æŸ¥æ¢ä»¶ï¼š
    /// 1. æ²–æ¬¾è¨˜éŒ„æª¢æŸ¥ (HasPaymentRecord)
    ///    - è³‡æ–™ä¾†æºï¼šç›´æ¥è®€å– SalesReturnDetail å¯¦é«”
    ///    - æª¢æŸ¥è³‡æ–™è¡¨ï¼šSalesReturnDetail (éŠ·è²¨é€€å›æ˜ç´°)
    ///    - æª¢æŸ¥æ¬„ä½ï¼šTotalPaidAmount (ç´¯è¨ˆä»˜æ¬¾é‡‘é¡)
    ///    - é™åˆ¶åŸå› ï¼šå·²æ²–æ¬¾çš„é€€è²¨æ˜ç´°ä¸å¯åˆªé™¤ï¼Œé¿å…è²¡å‹™è³‡æ–™éŒ¯äº‚
    /// </summary>
    /// <param name="item">è¦æª¢æŸ¥çš„é …ç›®</param>
    /// <param name="reason">ä¸å¯åˆªé™¤çš„åŸå› ï¼ˆè¼¸å‡ºåƒæ•¸ï¼‰</param>
    /// <returns>true è¡¨ç¤ºå¯ä»¥åˆªé™¤ï¼Œfalse è¡¨ç¤ºä¸å¯åˆªé™¤</returns>
    private bool CanDeleteItem(ReturnItem item, out string reason)
    {
        // æª¢æŸ¥ï¼šæ²–æ¬¾è¨˜éŒ„
        if (HasPaymentRecord(item))
        {
            var paidAmount = GetPaidAmount(item);
            reason = $"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ²–æ¬¾ {paidAmount:N0} å…ƒï¼‰ï¼Œç„¡æ³•åˆªé™¤";
            return false;
        }
        
        reason = string.Empty;
        return true;
    }
    
    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼‰
    /// </summary>
    private bool HasUndeletableDetails()
    {
        return ReturnItems.Any(item => 
            !IsEmptyRow(item) && !CanDeleteItem(item, out _));
    }

    /// <summary>
    /// é€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
    /// </summary>
    private async Task NotifyHasUndeletableDetailsChanged()
    {
        if (OnHasUndeletableDetailsChanged.HasDelegate)
        {
            var hasUndeletableDetails = HasUndeletableDetails();
            await OnHasUndeletableDetailsChanged.InvokeAsync(hasUndeletableDetails);
        }
    }

    // ===== InteractiveTableComponent æ–¹æ³• =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // éŠ·å”®è¨‚å–®æ˜ç´°é¸æ“‡æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "éŠ·å”®å•†å“", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "300px",
            CustomTemplate = item => 
            {
                var returnItem = (ReturnItem)item;
                var hasPaymentRecord = HasPaymentRecord(returnItem);
                var isFieldReadOnly = IsReadOnly || hasPaymentRecord;
                var selectedValue = returnItem.SelectedOrderDetail?.Id.ToString() ?? "";
                
                // çµ„åˆ tooltip è¨Šæ¯
                var title = hasPaymentRecord 
                    ? $"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ²–æ¬¾ {GetPaidAmount(returnItem):N0} å…ƒï¼‰ï¼Œç„¡æ³•ä¿®æ”¹å•†å“é¸æ“‡" 
                    : "";
                
                return @<div class="position-relative">
                    <select class="form-select form-select-sm" 
                            value="@selectedValue"
                            disabled="@isFieldReadOnly"
                            title="@title"
                            @onchange="@(async (e) => await OnOrderDetailChanged(returnItem, e.Value))">
                        <option value="">è«‹é¸æ“‡éŠ·å”®è¨‚å–®æ˜ç´°</option>
                        @foreach (var detail in GetAvailableOrderDetails())
                        {
                            var displayText = FormatOrderDetailDisplayText(detail);
                            <option value="@detail.Id">@displayText</option>
                        }
                    </select>
                    
                    @if (hasPaymentRecord)
                    {
                        <div class="position-absolute" style="top: 2px; right: 30px; pointer-events: none;">
                            <i title="@title"></i>
                        </div>
                    }
                </div>;
            }
        });

        // åŸå§‹éŠ·å”®æ•¸é‡æ¬„ä½ (åªè®€é¡¯ç¤º)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "åŸå§‹æ•¸é‡", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item => 
            {
                var returnItem = (ReturnItem)item;
                if (returnItem.SelectedOrderDetail == null) return @<span class="text-muted">-</span>;
                return @<div class="d-flex align-items-center justify-content-end">
                    <span>@returnItem.OriginalQuantity.ToString("N0")</span>
                </div>;
            }
        });

        // é€€è²¨æ•¸é‡æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "é€€è²¨æ•¸é‡", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item => 
            {
                var returnItem = (ReturnItem)item;
                var returnableQuantity = returnItem.AvailableQuantity;
                var value = returnItem.ReturnQuantity > 0 ? returnItem.ReturnQuantity.ToString("N0") : "";
                var hasPaymentRecord = HasPaymentRecord(returnItem);
                var isFieldReadOnly = IsReadOnly || hasPaymentRecord;
                
                // çµ„åˆ tooltip è¨Šæ¯
                var title = hasPaymentRecord 
                    ? $"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ²–æ¬¾ {GetPaidAmount(returnItem):N0} å…ƒï¼‰ï¼Œç„¡æ³•ä¿®æ”¹é€€è²¨æ•¸é‡" 
                    : "";
                
                // å¦‚æœæ˜¯å”¯è®€ç‹€æ…‹ï¼ˆå«æ²–æ¬¾è¨˜éŒ„ï¼‰ï¼Œç›´æ¥é¡¯ç¤º span
                if (isFieldReadOnly)
                {
                    return @<div class="position-relative d-flex align-items-center justify-content-end" style="min-height: 31px;">
                        <span class="text-muted small" title="@title">
                            @(returnItem.ReturnQuantity > 0 ? returnItem.ReturnQuantity.ToString("N0") : "0")
                        </span>
                    </div>;
                }
                
                // å¯ç·¨è¼¯ç‹€æ…‹ï¼Œé¡¯ç¤ºè¼¸å…¥æ¡†
                return @<div>
                    <input type="number" class="form-control form-control-sm text-end" 
                           value="@value"
                           min="0" max="@returnableQuantity"
                           step="1"
                           @oninput="@((e) => OnReturnQuantityInput(returnItem, e.Value?.ToString()))"
                           onkeydown="if(['e','E','+','-'].includes(event.key)) event.preventDefault();"
                           placeholder="0"
                           disabled="@(returnItem.SelectedOrderDetail == null)" />
                    @if (!string.IsNullOrEmpty(returnItem.ValidationError))
                    {
                        <small class="text-danger">@returnItem.ValidationError</small>
                    }
                </div>;
            }
        });

        // å–®åƒ¹æ¬„ä½ (åªè®€é¡¯ç¤º)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "é€€è²¨å–®åƒ¹", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item => 
            {
                var returnItem = (ReturnItem)item;
                var value = returnItem.OriginalUnitPrice;
                
                return @<div class="d-flex align-items-center justify-content-end">
                    <span>@value.ToString("N0")</span>
                </div>;
            }
        });

        // æŠ˜æ‰£æ¬„ä½ (åªè®€é¡¯ç¤º)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "ç•¶åˆæŠ˜æ‰£(%)", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "100px",
            CustomTemplate = item => 
            {
                var returnItem = (ReturnItem)item;
                var discount = returnItem.SelectedOrderDetail?.DiscountPercentage ?? 0;
                
                return @<div class="d-flex align-items-center justify-content-end">
                    <span>@discount.ToString("N0")</span>
                </div>;
            }
        });

        // å°è¨ˆæ¬„ä½ (åªè®€é¡¯ç¤º)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å°è¨ˆ", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item => 
            {
                var returnItem = (ReturnItem)item;
                
                return @<div class="text-end fw-bold text-success">
                    @returnItem.ReturnSubtotalAmount.ToString("C")
                </div>;
            }
        });

        // å‚™è¨»æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å‚™è¨»", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "150px",
            CustomTemplate = item =>
            {
                var returnItem = (ReturnItem)item;
                
                // å¦‚æœæ˜¯å”¯è®€ç‹€æ…‹ï¼Œç›´æ¥é¡¯ç¤º span
                if (IsReadOnly)
                {
                    var displayText = string.IsNullOrEmpty(returnItem.Remarks) ? "ç„¡å‚™è¨»" : returnItem.Remarks;
                    return @<div class="d-flex align-items-center" style="min-height: 31px;">
                        <span class="text-muted">@displayText</span>
                    </div>;
                }
                
                // å¯ç·¨è¼¯ç‹€æ…‹ï¼Œé¡¯ç¤ºè¼¸å…¥æ¡†
                return @<input type="text" class="form-control form-control-sm" 
                               value="@returnItem.Remarks"
                               @onchange="@(async (e) => await OnRemarksInput(returnItem, e.Value?.ToString()))"
                               placeholder="å‚™è¨»"
                               disabled="@(returnItem.SelectedOrderDetail == null)" />;
            }
        });

        return columns;
    }

    private RenderFragment<ReturnItem> GetCustomActionsTemplate => item => __builder =>
    {
        // æª¢æŸ¥é …ç›®æ˜¯å¦å¯ä»¥åˆªé™¤ï¼ˆç¶œåˆé€€è²¨è¨˜éŒ„å’Œæ²–æ¬¾è¨˜éŒ„æª¢æŸ¥ï¼‰
        var canDelete = CanDeleteItem(item, out _);
        
        if (canDelete)
        {
            // å¯ä»¥åˆªé™¤ï¼šé¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Danger"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="@IsReadOnly"
                                   Title="åˆªé™¤"
                                   OnClick="async () => await HandleItemDelete(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else
        {
            // ä¸èƒ½åˆªé™¤ï¼šé¡¯ç¤ºæŸ¥çœ‹æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Info"
                                   IconClass="bi bi-eye text-white"
                                   Size="ButtonSize.Large"
                                   Title="æŸ¥çœ‹ç›¸é—œå–®æ“š"
                                   OnClick="async () => await ShowRelatedDocuments(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
    };

    private async Task HandleItemDelete(ReturnItem item)
    {
        // ä½¿ç”¨ç¶œåˆæª¢æŸ¥æ–¹æ³•ï¼Œç¢ºèªæ˜¯å¦å¯ä»¥åˆªé™¤
        if (!CanDeleteItem(item, out string reason))
        {
            await NotificationService.ShowWarningAsync(
                reason, 
                "æ“ä½œé™åˆ¶"
            );
            return;
        }
        
        var index = ReturnItems.IndexOf(item);
        await RemoveItemAsync(index);
    }

    /// <summary>
    /// é¡¯ç¤ºç›¸é—œå–®æ“šï¼ˆé€€è²¨å–®å’Œæ²–æ¬¾å–®ï¼‰
    /// </summary>
    private async Task ShowRelatedDocuments(ReturnItem item)
    {
        // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰çš„æ˜ç´°å¯¦é«” ID
        if (item.ExistingDetailEntity is not SalesReturnDetail detail || detail.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("æ­¤é …ç›®å°šæœªå„²å­˜ï¼Œç„¡æ³•æŸ¥çœ‹ç›¸é—œå–®æ“š", "æç¤º");
            return;
        }

        // è¨­å®šå•†å“åç¨±
        selectedProductName = item.SelectedProduct?.Name ?? "æœªçŸ¥å•†å“";

        // é¡¯ç¤º Modal ä¸¦é–‹å§‹è¼‰å…¥
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            // æŸ¥è©¢ç›¸é—œå–®æ“š
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsForSalesReturnDetailAsync(detail.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ç›¸é—œå–®æ“šå¤±æ•—ï¼š{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// è™•ç†é»æ“Šç›¸é—œå–®æ“šçš„äº‹ä»¶
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // è§¸ç™¼äº‹ä»¶ï¼Œè®“çˆ¶çµ„ä»¶ï¼ˆEditModalï¼‰è™•ç†é–‹å•Ÿç›¸é—œå–®æ“š
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            // å¦‚æœçˆ¶çµ„ä»¶æ²’æœ‰è™•ç†ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
            await NotificationService.ShowInfoAsync(
                $"è«‹åœ¨ä¸»ç•«é¢ä¸­é–‹å•Ÿ {document.TypeDisplayName}: {document.DocumentNumber}", 
                "æç¤º"
            );
        }
    }

    // ===== å…§éƒ¨æ–¹æ³• =====
    private async Task LoadAvailableProductsAsync()
    {
        try
        {
            AvailableProducts = Products?.ToList() ?? new List<Product>();
            
            // åŒæ™‚è¼‰å…¥éŠ·å”®è¨‚å–®æ˜ç´°
            await LoadAvailableOrderDetailsAsync();
        }
        catch (Exception)
        {
            AvailableProducts = new List<Product>();
            AvailableOrderDetails = new List<SalesOrderDetail>();
        }
    }

    private async Task LoadAvailableOrderDetailsAsync()
    {
        try
        {
            if (EffectiveCustomerId.HasValue && EffectiveCustomerId.Value > 0)
            {
                // è¼‰å…¥è©²å®¢æˆ¶çš„å¯é€€è²¨éŠ·å”®è¨‚å–®æ˜ç´°
                AvailableOrderDetails = await SalesOrderDetailService.GetReturnableDetailsByCustomerAsync(EffectiveCustomerId.Value);
            }
            else
            {
                AvailableOrderDetails = new List<SalesOrderDetail>();
            }
        }
        catch (Exception)
        {
            AvailableOrderDetails = new List<SalesOrderDetail>();
        }
    }

    private void LoadExistingDetailsAsync()
    {
        if (ExistingReturnDetails?.Any() != true) 
        {
            ReturnItems.Clear();
            EnsureOneEmptyRow();
            return;
        }

        ReturnItems.Clear();
        
        foreach (var detail in ExistingReturnDetails)
        {
            // ç›´æ¥ä½¿ç”¨ Navigation Properties - æ›´å¯é çš„æ–¹å¼
            var orderDetail = detail.SalesOrderDetail;
            
            var item = new ReturnItem
            {
                // ç›´æ¥ä½¿ç”¨ Navigation Properties
                SelectedProduct = detail.Product,
                SelectedOrderDetail = orderDetail,
                OriginalQuantity = (int)(orderDetail?.OrderQuantity ?? 0),
                AlreadyReturnedQuantity = GetAlreadyReturnedQuantity(orderDetail?.Id ?? 0),
                ReturnQuantity = (int)detail.ReturnQuantity,
                OriginalUnitPrice = orderDetail?.UnitPrice ?? detail.OriginalUnitPrice,
                DiscountPercentage = orderDetail?.DiscountPercentage ?? detail.DiscountPercentage,
                ReturnReason = string.Empty,
                Remarks = detail.Remarks ?? string.Empty,
                ExistingDetailEntity = detail
            };
            
            ReturnItems.Add(item);
        }
        
        EnsureOneEmptyRow();
    }

    private List<SalesOrderDetail> GetAvailableOrderDetails()
    {
        var filteredDetails = AvailableOrderDetails.AsQueryable();
        
        // æ ¹æ“šéŠ·å”®è¨‚å–®ç¯©é¸
        if (EffectiveSalesOrderId.HasValue && EffectiveSalesOrderId.Value > 0)
        {
            filteredDetails = filteredDetails.Where(od => od.SalesOrderId == EffectiveSalesOrderId.Value);
        }
        
        // æ ¹æ“šå•†å“ç¯©é¸
        if (EffectiveFilterProductId.HasValue && EffectiveFilterProductId.Value > 0)
        {
            filteredDetails = filteredDetails.Where(od => od.ProductId == EffectiveFilterProductId.Value);
        }
        
        // åªé¡¯ç¤ºé‚„æœ‰å¯é€€å›æ•¸é‡çš„æ˜ç´°
        return filteredDetails.Where(od => GetAvailableReturnQuantity(od) > 0).ToList();
    }

    // ===== äº‹ä»¶è™•ç†æ–¹æ³• =====
    
    // ===== éŠ·å”®è¨‚å–®æ˜ç´°é¸æ“‡äº‹ä»¶è™•ç† =====
    
    /// <summary>
    /// æ ¼å¼åŒ–éŠ·å”®è¨‚å–®æ˜ç´°é¡¯ç¤ºæ–‡å­—ï¼ˆç”¨æ–¼ä¸‹æ‹‰é¸å–®ï¼‰
    /// </summary>
    private string FormatOrderDetailDisplayText(SalesOrderDetail detail)
    {
        if (detail?.Product == null || detail.SalesOrder == null) return "";
        
        var product = detail.Product;
        var orderNumber = detail.SalesOrder.SalesOrderNumber ?? "N/A";
        
        var productDisplay = !string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name)
            ? $"{product.Code} - {product.Name}"
            : product.Name ?? product.Code ?? "æœªçŸ¥å•†å“";
        
        return $"[{orderNumber}] {productDisplay}";
    }

    // ===== è¨‚å–®æ˜ç´°é¸æ“‡äº‹ä»¶è™•ç† =====

    private async Task OnOrderDetailChanged(ReturnItem returnItem, object? value)
    {
        var wasEmpty = IsEmptyRow(returnItem);
        
        var orderDetailIdStr = value?.ToString();
        if (string.IsNullOrEmpty(orderDetailIdStr))
        {
            returnItem.SelectedOrderDetail = null;
            returnItem.SelectedProduct = null;
            returnItem.OriginalQuantity = 0;
            returnItem.AlreadyReturnedQuantity = 0;
            returnItem.ReturnQuantity = 0;
            returnItem.OriginalUnitPrice = 0;
            returnItem.DiscountPercentage = 0;
        }
        else if (int.TryParse(orderDetailIdStr, out var orderDetailId))
        {
            var detail = GetAvailableOrderDetails().FirstOrDefault(d => d.Id == orderDetailId);
            if (detail != null)
            {
                returnItem.SelectedOrderDetail = detail;
                returnItem.SelectedProduct = detail.Product;
                returnItem.OriginalQuantity = (int)detail.OrderQuantity;
                returnItem.AlreadyReturnedQuantity = GetAlreadyReturnedQuantity(detail.Id);
                returnItem.ReturnQuantity = 0;
                returnItem.OriginalUnitPrice = detail.UnitPrice;
                returnItem.DiscountPercentage = detail.DiscountPercentage;
            }
        }
        
        // è™•ç†è‡ªå‹•ç©ºè¡Œé‚è¼¯
        AutoEmptyRowHelper.ForAny<ReturnItem>.HandleInputChange(
            ReturnItems, returnItem, IsEmptyRow, CreateEmptyItem, wasEmpty, !IsEmptyRow(returnItem));
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnReturnQuantityInput(ReturnItem returnItem, string? value)
    {
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹
        if (!CanDeleteItem(returnItem, out string reason))
        {
            await NotificationService.ShowWarningAsync(
                "æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹é€€è²¨æ•¸é‡", 
                "æ“ä½œé™åˆ¶"
            );
            return;
        }
        
        if (int.TryParse(value, out var quantity) && quantity >= 0)
        {
            var maxQuantity = returnItem.AvailableQuantity;
            returnItem.ReturnQuantity = Math.Min(quantity, maxQuantity);
            returnItem.ValidationError = quantity > maxQuantity ? $"æœ€å¤§å¯é€€æ•¸é‡ï¼š{maxQuantity}" : null;
        }
        else
        {
            returnItem.ReturnQuantity = 0;
            returnItem.ValidationError = null;
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnReturnReasonInput(ReturnItem returnItem, string? value)
    {
        returnItem.ReturnReason = value ?? string.Empty;
        await NotifyDetailsChanged();
    }

    private async Task OnRemarksInput(ReturnItem returnItem, string? value)
    {
        returnItem.Remarks = value ?? string.Empty;
        await NotifyDetailsChanged();
    }

    private async Task LoadAllReturnableItems()
    {
        try
        {
            var availableDetails = GetAvailableOrderDetails();
            
            foreach (var orderDetail in availableDetails)
            {
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“å­˜åœ¨ç›¸åŒçš„æ˜ç´°
                if (ReturnItems.Any(item => item.SelectedOrderDetail?.Id == orderDetail.Id))
                    continue;
                
                // æ‰¾åˆ°ç¬¬ä¸€å€‹ç©ºè¡Œæˆ–å‰µå»ºæ–°è¡Œ
                var emptyItem = ReturnItems.FirstOrDefault(IsEmptyRow);
                if (emptyItem == null)
                {
                    emptyItem = CreateEmptyItem();
                    ReturnItems.Add(emptyItem);
                }
                
                // è¨­ç½®æ˜ç´°è³‡è¨Š
                emptyItem.SelectedOrderDetail = orderDetail;
                emptyItem.SelectedProduct = orderDetail.Product;
                emptyItem.OriginalQuantity = (int)orderDetail.OrderQuantity;
                emptyItem.AlreadyReturnedQuantity = GetAlreadyReturnedQuantity(orderDetail.Id);
                emptyItem.OriginalUnitPrice = orderDetail.UnitPrice;
                emptyItem.DiscountPercentage = orderDetail.DiscountPercentage; // è¤‡è£½æŠ˜æ‰£
            }
            
            EnsureOneEmptyRow();
            await NotifyDetailsChanged();
            await NotificationService.ShowSuccessAsync($"å·²è¼‰å…¥ {availableDetails.Count} é …å¯é€€è²¨å•†å“");
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å¯é€€è²¨å•†å“æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    private async Task RemoveItemAsync(int index)
    {
        if (index >= 0 && index < ReturnItems.Count)
        {
            var item = ReturnItems[index];
            
            // é€šçŸ¥çˆ¶çµ„ä»¶é …ç›®å³å°‡è¢«ç§»é™¤
            if (OnItemRemoved.HasDelegate)
            {
                await OnItemRemoved.InvokeAsync(item);
            }
            
            // å¦‚æœæ˜¯ç¾æœ‰æ˜ç´°ï¼Œè¨˜éŒ„IDä»¥ä¾¿åˆªé™¤
            if (item.ExistingDetailEntity?.Id > 0)
            {
                _deletedDetailIds.Add(item.ExistingDetailEntity.Id);
            }
            
            ReturnItems.RemoveAt(index);
            EnsureOneEmptyRow();
            await NotifyDetailsChanged();
        }
    }

    private decimal GetTotalAmount()
    {
        return ReturnItems.Where(item => !IsEmptyRow(item))
                          .Sum(item => item.ReturnSubtotalAmount);
    }

    private async Task NotifyDetailsChanged()
    {
        // è½‰æ›ç‚º SalesReturnDetail å¯¦é«”ï¼ˆåŒ…å«æ‰€æœ‰éç©ºè¡Œçš„æ˜ç´°ï¼Œå³ä½¿ ReturnQuantity ç‚º 0ï¼‰
        // é€™æ¨£çˆ¶çµ„ä»¶æ‰èƒ½æ­£ç¢ºè¨ˆç®—ç¸½é‡‘é¡å’Œç¨…é¡
        var details = ReturnItems.Where(item => !IsEmptyRow(item))
                                 .Select(item => ConvertToEntity(item))
                                 .Where(entity => entity != null)
                                 .ToList();
        
        if (EffectiveDetailsChangedCallback.HasDelegate)
        {
            await EffectiveDetailsChangedCallback.InvokeAsync(details!);
        }
        
        // é€šçŸ¥å·²åˆªé™¤çš„æ˜ç´° ID
        if (OnDeletedDetailsChanged.HasDelegate && _deletedDetailIds.Any())
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds.ToList());
            _deletedDetailIds.Clear(); // æ¸…ç©ºå·²é€šçŸ¥çš„ID
        }
        
        if (OnReturnItemsChanged.HasDelegate)
        {
            await OnReturnItemsChanged.InvokeAsync(ReturnItems);
        }
        
        // ğŸ”‘ é€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
        await NotifyHasUndeletableDetailsChanged();
    }

    private SalesReturnDetail? ConvertToEntity(ReturnItem item)
    {
        // åªè¦é¸æ“‡äº†å•†å“å°±è½‰æ›ï¼Œå³ä½¿ ReturnQuantity ç‚º 0ï¼ˆç”¨æ–¼è¨ˆç®—ï¼‰
        if (item.SelectedOrderDetail == null || item.SelectedProduct == null)
        {
            return null;
        }
        
        // å¦‚æœå·²æœ‰å¯¦é«”ï¼Œæ›´æ–°å®ƒ
        if (item.ExistingDetailEntity != null)
        {
            item.ExistingDetailEntity.SalesOrderDetailId = item.SelectedOrderDetail.Id;
            item.ExistingDetailEntity.ProductId = item.SelectedProduct.Id;
            item.ExistingDetailEntity.ReturnQuantity = item.ReturnQuantity;
            item.ExistingDetailEntity.OriginalUnitPrice = item.OriginalUnitPrice;
            item.ExistingDetailEntity.DiscountPercentage = item.DiscountPercentage;
            item.ExistingDetailEntity.Remarks = item.Remarks;
            
            return item.ExistingDetailEntity;
        }
        
        // å‰µå»ºæ–°å¯¦é«”
        return new SalesReturnDetail
        {
            SalesOrderDetailId = item.SelectedOrderDetail.Id,
            ProductId = item.SelectedProduct.Id,
            ReturnQuantity = item.ReturnQuantity,
            OriginalUnitPrice = item.OriginalUnitPrice,
            DiscountPercentage = item.DiscountPercentage,
            Remarks = item.Remarks
        };
    }

    // ===== è¼”åŠ©æ–¹æ³• =====
    private int GetAlreadyReturnedQuantity(int orderDetailId)
    {
        // é€™è£¡æ‡‰è©²æŸ¥è©¢è³‡æ–™åº«ç²å–å·²é€€è²¨æ•¸é‡ï¼Œç›®å‰æš«æ™‚å›å‚³0
        // å¯èƒ½éœ€è¦å‘¼å«æœå‹™ä¾†ç²å–
        return 0;
    }
    
    private int GetAvailableReturnQuantity(SalesOrderDetail orderDetail)
    {
        var alreadyReturned = GetAlreadyReturnedQuantity(orderDetail.Id);
        return (int)(orderDetail.OrderQuantity - alreadyReturned);
    }

    /// <summary>
    /// é€€è²¨é‡å…¨å¡«ï¼ˆåªè™•ç†æœªé–å®šçš„æ˜ç´°ï¼‰
    /// </summary>
    private async Task FillAllQuantities()
    {
        var nonEmptyItems = ReturnItems.Where(item => !IsEmptyRow(item)).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("æ²’æœ‰å¯æ›´æ–°çš„æ˜ç´°é …ç›®", "æç¤º");
            return;
        }
        
        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
        
        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "æ‰€æœ‰æ˜ç´°éƒ½å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•æ‰¹æ¬¡å¡«å…¥æ•¸é‡", 
                "æ“ä½œé™åˆ¶");
            return;
        }
        
        foreach (var item in unlocked)
        {
            if (item.SelectedOrderDetail != null)
            {
                item.ReturnQuantity = item.AvailableQuantity;
                item.ValidationError = null;
            }
        }
        
        var message = $"å·²å¡«å…¥ {unlocked.Count} é …æ˜ç´°çš„é€€è²¨æ•¸é‡";
        if (locked.Any())
        {
            message += $"\nï¼ˆå·²è·³é {locked.Count} é …å·²é–å®šçš„æ˜ç´°ï¼‰";
        }
        await NotificationService.ShowSuccessAsync(message);
        
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// é€€è²¨é‡æ¸…ç©ºï¼ˆåªè™•ç†æœªé–å®šçš„æ˜ç´°ï¼‰
    /// </summary>
    private async Task ClearAllQuantities()
    {
        var nonEmptyItems = ReturnItems.Where(item => !IsEmptyRow(item)).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("æ²’æœ‰å¯æ›´æ–°çš„æ˜ç´°é …ç›®", "æç¤º");
            return;
        }
        
        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
        
        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "æ‰€æœ‰æ˜ç´°éƒ½å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•æ‰¹æ¬¡æ¸…ç©ºæ•¸é‡", 
                "æ“ä½œé™åˆ¶");
            return;
        }
        
        foreach (var item in unlocked)
        {
            item.ReturnQuantity = 0;
        }
        
        var message = $"å·²æ¸…ç©º {unlocked.Count} é …æ˜ç´°çš„é€€è²¨æ•¸é‡";
        if (locked.Any())
        {
            message += $"\nï¼ˆå·²è·³é {locked.Count} é …å·²é–å®šçš„æ˜ç´°ï¼‰";
        }
        await NotificationService.ShowSuccessAsync(message);
        
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// æ¸…é™¤æ˜ç´°ï¼ˆåªç§»é™¤æœªé–å®šçš„æ˜ç´°ï¼Œä¿ç•™å·²é–å®šçš„ï¼‰
    /// </summary>
    private async Task ClearAllDetails()
    {
        var nonEmptyItems = ReturnItems.Where(item => !IsEmptyRow(item)).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("æ²’æœ‰å¯ç§»é™¤çš„æ˜ç´°é …ç›®", "æç¤º");
            return;
        }
        
        // å€åˆ†å¯åˆªé™¤å’Œè¢«é–å®šçš„æ˜ç´°
        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
        
        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "æ‰€æœ‰æ˜ç´°éƒ½å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ç§»é™¤", 
                "æ“ä½œé™åˆ¶");
            return;
        }
        
        // é€šçŸ¥çˆ¶çµ„ä»¶é …ç›®å³å°‡è¢«ç§»é™¤
        if (OnItemRemoved.HasDelegate)
        {
            foreach (var item in unlocked)
            {
                await OnItemRemoved.InvokeAsync(item);
            }
        }
        
        // è¨˜éŒ„æ‰€æœ‰è¦åˆªé™¤çš„ç¾æœ‰æ˜ç´° ID
        foreach (var item in unlocked.Where(item => item.ExistingDetailEntity?.Id > 0))
        {
            _deletedDetailIds.Add(item.ExistingDetailEntity!.Id);
        }
        
        // å¾åˆ—è¡¨ä¸­ç§»é™¤æœªé–å®šçš„é …ç›®ï¼Œä¿ç•™å·²é–å®šçš„é …ç›®
        foreach (var item in unlocked)
        {
            ReturnItems.Remove(item);
        }
        
        // ç¢ºä¿æœ‰ä¸€å€‹ç©ºè¡Œ
        EnsureOneEmptyRow();
        
        await NotifyDetailsChanged();
        
        var message = $"å·²ç§»é™¤ {unlocked.Count} é …æ˜ç´°";
        if (locked.Any())
        {
            message += $"\nï¼ˆå·²ä¿ç•™ {locked.Count} é …å·²é–å®šçš„æ˜ç´°ï¼‰";
        }
        await NotificationService.ShowSuccessAsync(message);
    }

    // ===== å…¬é–‹æ–¹æ³• - ä¾›çˆ¶çµ„ä»¶èª¿ç”¨ =====
    public async Task<bool> ValidateAsync()
    {
        try
        {
            var errors = new List<string>();
            
            // æª¢æŸ¥æ˜¯å¦æœ‰é€€è²¨é …ç›®
            var potentialItems = ReturnItems.Where(item => !IsEmptyRow(item) && item.ReturnQuantity > 0).ToList();
            if (!potentialItems.Any())
            {
                errors.Add("è‡³å°‘éœ€è¦ä¸€å€‹é€€è²¨é …ç›®");
            }
            
            // æª¢æŸ¥å¿…å¡«æ¬„ä½å’ŒåŸºæœ¬é©—è­‰
            foreach (var item in potentialItems)
            {
                if (item.SelectedOrderDetail == null)
                {
                    errors.Add("è«‹é¸æ“‡æœ‰æ•ˆçš„éŠ·å”®è¨‚å–®æ˜ç´°");
                    continue;
                }
                
                if (item.ReturnQuantity > item.AvailableQuantity)
                {
                    errors.Add($"å•†å“ {item.SelectedProduct?.Code} çš„é€€è²¨æ•¸é‡è¶…éå¯é€€æ•¸é‡");
                }
                
                if (item.OriginalUnitPrice < 0)
                {
                    errors.Add($"å•†å“ {item.SelectedProduct?.Code} çš„åŸå§‹å–®åƒ¹ä¸å¯ç‚ºè² æ•¸");
                }
            }
            
            if (errors.Any())
            {
                var errorMessage = string.Join("\n", errors);
                await NotificationService.ShowErrorAsync(errorMessage);
                return false;
            }
            
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é©—è­‰æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }
    
    // ===== ReturnItem å…§éƒ¨é¡åˆ¥ =====
    public class ReturnItem
    {
        public Product? SelectedProduct { get; set; }
        public SalesOrderDetail? SelectedOrderDetail { get; set; }
        
        public int OriginalQuantity { get; set; } = 0;
        public int AlreadyReturnedQuantity { get; set; } = 0;
        public int ReturnQuantity { get; set; } = 0;
        
        public decimal OriginalUnitPrice { get; set; } = 0;
        public decimal DiscountPercentage { get; set; } = 0;
        
        public string ReturnReason { get; set; } = string.Empty;
        public string Remarks { get; set; } = string.Empty;
        
        public SalesReturnDetail? ExistingDetailEntity { get; set; }
        public string? ValidationError { get; set; }
        
        // è¨ˆç®—å±¬æ€§
        public decimal ReturnSubtotalAmount => Math.Round(ReturnQuantity * OriginalUnitPrice * (1 - DiscountPercentage / 100), 2);
        public int AvailableQuantity => OriginalQuantity - AlreadyReturnedQuantity;
        
        /// <summary>
        /// å–å¾—é¡¯ç¤ºç”¨çš„å•†å“åç¨±ï¼ˆåŒ…å«éŠ·å”®è¨‚å–®è™Ÿï¼‰
        /// </summary>
        public string DisplayName => 
            SelectedProduct != null 
                ? $"[{SelectedOrderDetail?.SalesOrder?.SalesOrderNumber ?? "N/A"}] {SelectedProduct.Code} - {SelectedProduct.Name}"
                : string.Empty;
    }
}