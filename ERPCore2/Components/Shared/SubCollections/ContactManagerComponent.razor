@* è¯çµ¡æ–¹å¼ç®¡ç†çµ„ä»¶ - ç®¡ç†å¯¦é«”çš„å¤šå€‹è¯çµ¡æ–¹å¼è³‡è¨Š - ä½¿ç”¨ InteractiveTableComponent çµ±ä¸€UI *@

@inject INotificationService NotificationService
@using ERPCore2.Helpers
@using ERPCore2.Components.Shared.SubCollections
@typeparam TContactEntity where TContactEntity : ERPCore2.Data.BaseEntity, new()
@typeparam TParentEntity where TParentEntity : ERPCore2.Data.BaseEntity

<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <InteractiveTableComponent TItem="TContactEntity" 
                                  Items="@Items"
                                  ColumnDefinitions="@GetColumnDefinitions()"
                                  IsReadOnly="@IsReadOnly"
                                  ShowRowNumbers="false"
                                  EmptyMessage="@EmptyMessage"
                                  ShowBuiltInActions="true"
                                  ShowBuiltInDeleteButton="true"
                                  OnItemDelete="@HandleItemDelete" />
    </div>
</div>

@code {
    // ===== ç§æœ‰æ¬„ä½ =====
    private readonly HashSet<int> _deletedDetailIds = new HashSet<int>();
    
    // ===== åŸºæœ¬åƒæ•¸ =====
    [Parameter] public List<TContactEntity> Items { get; set; } = new();
    [Parameter] public List<ERPCore2.Data.BaseEntity> Options { get; set; } = new(); // è¯çµ¡é¡å‹é¸é …
    [Parameter] public int ParentEntityId { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== é¡¯ç¤ºè¨­å®š =====
    [Parameter] public string Title { get; set; } = "è¯çµ¡æ–¹å¼";
    [Parameter] public string Subtitle { get; set; } = "";
    [Parameter] public string Icon { get; set; } = "telephone";
    [Parameter] public string ItemDisplayName { get; set; } = "è¯çµ¡æ–¹å¼";
    [Parameter] public string TypeDisplayName { get; set; } = "è¯çµ¡é¡å‹";
    [Parameter] public string ValueDisplayName { get; set; } = "è¯çµ¡å…§å®¹";
    [Parameter] public string ValuePlaceholder { get; set; } = "è«‹è¼¸å…¥è¯çµ¡å…§å®¹";
    [Parameter] public string EmptyIcon { get; set; } = "telephone-x";
    [Parameter] public string EmptyMessage { get; set; } = "å°šæœªæ–°å¢è¯çµ¡æ–¹å¼";
    
    // ===== å§”æ´¾åƒæ•¸ - Getter =====
    [Parameter] public Func<TContactEntity, int?> GetTypeId { get; set; } = item => null;
    [Parameter] public Func<TContactEntity, string> GetContactValue { get; set; } = item => string.Empty;
    [Parameter] public Func<TContactEntity, string?> GetRemarks { get; set; } = item => null;
    [Parameter] public Func<ERPCore2.Data.BaseEntity, int> GetOptionId { get; set; } = option => option.Id;
    [Parameter] public Func<ERPCore2.Data.BaseEntity, string> GetOptionDisplayText { get; set; } = option => 
    {
        // æª¢æŸ¥æ˜¯å¦æœ‰ TypeName å±¬æ€§ä¸¦å–å¾—å…¶å€¼
        var typeNameProperty = option.GetType().GetProperty("TypeName");
        if (typeNameProperty != null)
        {
            var typeName = typeNameProperty.GetValue(option) as string;
            return typeName ?? option.ToString() ?? "";
        }
        return option.ToString() ?? "";
    };
    
    // ===== å§”æ´¾åƒæ•¸ - Setter =====
    [Parameter] public Action<TContactEntity, int?> SetTypeId { get; set; } = (item, typeId) => { };
    [Parameter] public Action<TContactEntity, string> SetContactValue { get; set; } = (item, value) => { };
    [Parameter] public Action<TContactEntity, string?> SetRemarks { get; set; } = (item, value) => { };
    [Parameter] public Action<TContactEntity, int> SetParentId { get; set; } = (item, parentId) => { };
    
    // ===== äº‹ä»¶åƒæ•¸ =====
    [Parameter] public EventCallback<List<TContactEntity>> ItemsChanged { get; set; }
    [Parameter] public EventCallback<TContactEntity> ItemAdded { get; set; }
    [Parameter] public EventCallback<TContactEntity> ItemRemoved { get; set; }
    [Parameter] public EventCallback<TContactEntity> PrimaryChanged { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; } // ğŸ†• æ–°å¢
    
    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        
        var emptyCount = Items.Count(IsEmptyRow);
        
        // ç¸½æ˜¯ç¢ºä¿æœ‰ä¸€è¡Œç©ºè¡Œå¯ä»¥è¼¸å…¥
        // ä¸è«–æ˜¯å¦å·²æœ‰è³‡æ–™ï¼Œéƒ½æ‡‰è©²ä¿æŒæœ‰ç©ºè¡Œä¾›ä½¿ç”¨è€…æ–°å¢
        EnsureOneEmptyRow();
        
        var emptyCountAfter = Items.Count(IsEmptyRow);
    }

    // ===== AutoEmptyRowHelper ç›¸é—œæ–¹æ³• =====
    
    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦ç‚ºç©ºè¡Œ
    /// æ¥­å‹™é‚è¼¯ï¼šåªè¦é¸æ“‡äº†è¯çµ¡é¡å‹æˆ–è¼¸å…¥äº†è¯çµ¡å…§å®¹ï¼Œå°±ç®—æ˜¯æœ‰æ•ˆçš„ä¸€è¡Œï¼Œä¸å†æ˜¯ç©ºè¡Œ
    /// </summary>
    private bool IsEmptyRow(TContactEntity item)
    {
        var typeId = GetTypeId(item);
        var contactValue = GetContactValue(item);
        
        // æª¢æŸ¥è¯çµ¡é¡å‹æˆ–è¯çµ¡å…§å®¹æ˜¯å¦æœ‰å€¼
        var hasType = typeId.HasValue && typeId.Value > 0;
        var hasValue = !string.IsNullOrWhiteSpace(contactValue);
        
        // åªè¦æœ‰å…¶ä¸­ä¸€å€‹æ¬„ä½æœ‰å€¼ï¼Œå°±ä¸æ˜¯ç©ºè¡Œ
        return !hasType && !hasValue;
    }
    
    /// <summary>
    /// å‰µå»ºç©ºçš„è¯çµ¡æ–¹å¼é …ç›®
    /// </summary>
    private TContactEntity CreateEmptyItem()
    {
        var newItem = new TContactEntity();
        SetParentId(newItem, ParentEntityId);
        return newItem;
    }
    
    /// <summary>
    /// ç¢ºä¿æœ‰ä¸€è¡Œç©ºè¡Œ
    /// </summary>
    private void EnsureOneEmptyRow()
    {
        AutoEmptyRowHelper.For<TContactEntity>.EnsureOneEmptyRow(
            Items, 
            IsEmptyRow, 
            CreateEmptyItem, 
            SetParentId, 
            ParentEntityId
        );
    }

    // ===== InteractiveTableComponent æ–¹æ³• =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            // è¯çµ¡é¡å‹é¸æ“‡æ¬„ä½
            new() 
            { 
                Title = TypeDisplayName, 
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "25%",
                CustomTemplate = item => 
                {
                    var contact = (TContactEntity)item;
                    var typeId = GetTypeId(contact);
                    var selectedValue = typeId?.ToString() ?? "";
                    
                    return @<select class="form-select form-select-sm" 
                                    value="@selectedValue"
                                    disabled="@IsReadOnly"
                                    @onchange="@(async (e) => await OnTypeChanged((contact, e.Value)))">
                        <option value="">è«‹é¸æ“‡é¡å‹</option>
                        @foreach (var option in Options)
                        {
                            <option value="@GetOptionId(option)">@GetOptionDisplayText(option)</option>
                        }
                    </select>;
                }
            },
            
            // è¯çµ¡å…§å®¹ - æ–‡å­—è¼¸å…¥
            new() 
            { 
                Title = ValueDisplayName, 
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "35%",
                CustomTemplate = item => 
                {
                    var contact = (TContactEntity)item;
                    var value = GetContactValue(contact) ?? "";
                    
                    return @<input type="text" 
                                   class="form-control form-control-sm" 
                                   value="@value"
                                   placeholder="@ValuePlaceholder"
                                   disabled="@IsReadOnly"
                                   @oninput="@(async (e) => await OnContactValueChanged((contact, e.Value?.ToString())))" />;
                }
            },
            
            // å‚™è¨» - æ–‡å­—è¼¸å…¥
            new() 
            { 
                Title = "å‚™è¨»", 
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "40%",
                CustomTemplate = item => 
                {
                    var contact = (TContactEntity)item;
                    var value = GetRemarks(contact) ?? "";
                    
                    return @<input type="text" 
                                   class="form-control form-control-sm" 
                                   value="@value"
                                   placeholder="è«‹è¼¸å…¥å‚™è¨»"
                                   disabled="@IsReadOnly"
                                   @oninput="@(async (e) => await OnRemarksChanged((contact, e.Value?.ToString())))" />;
                }
            }
        };
    }

    private async Task HandleItemDelete(TContactEntity item)
    {
        var index = Items.IndexOf(item);
        await RemoveItemAsync(index);
    }

    private Task OnValidationFailed((TContactEntity item, string propertyName, string? errorMessage) args)
    {
        // ä¸å†éœ€è¦æ­¤æ–¹æ³•ï¼Œå› ç‚ºé©—è­‰å·²ç§»è‡³è‡ªè¨‚æ¨¡æ¿ä¸­
        return Task.CompletedTask;
    }

    private Task HandleRowClick(TContactEntity item)
    {
        // ä¸å†éœ€è¦æ­¤æ–¹æ³•ï¼Œå› ç‚ºç›´æ¥åœ¨è¡¨æ ¼ä¸Šç·¨è¼¯
        return Task.CompletedTask;
    }
    
    // ===== å…§éƒ¨æ–¹æ³• =====

    private string GetTypeDisplayText(TContactEntity item)
    {
        var typeId = GetTypeId(item);
        if (typeId.HasValue)
        {
            var type = Options.FirstOrDefault(o => GetOptionId(o) == typeId.Value);
            if (type != null)
            {
                return GetOptionDisplayText(type);
            }
        }
        return "æœªçŸ¥é¡å‹";
    }

    // ===== InteractiveTableComponent äº‹ä»¶è™•ç† =====
    private async Task OnTypeChanged((object item, object? value) args)
    {
        var contact = (TContactEntity)args.item;
        var wasEmpty = IsEmptyRow(contact);
        
        if (args.value != null && !string.IsNullOrEmpty(args.value.ToString()) && int.TryParse(args.value.ToString(), out var typeId) && typeId > 0)
        {
            SetTypeId(contact, typeId);
            
            // ä½¿ç”¨æ›´ç²¾ç¢ºçš„è‡ªå‹•ç©ºè¡Œè™•ç†ï¼ˆåœ¨è¨­å®šå€¼å¾Œæª¢æŸ¥æ•´è¡Œç‹€æ…‹ï¼‰
            var added = AutoEmptyRowHelper.For<TContactEntity>.HandleInputChangeAdvanced(
                Items, contact, IsEmptyRow, CreateEmptyItem, wasEmpty, SetParentId, ParentEntityId);
            
            await ItemsChanged.InvokeAsync(Items);
        }
        else
        {
            SetTypeId(contact, null);
            await ItemsChanged.InvokeAsync(Items);
        }
        StateHasChanged();
    }

    private async Task OnContactValueChanged((object item, string? value) args)
    {
        var contact = (TContactEntity)args.item;
        var wasEmpty = IsEmptyRow(contact);
        
        SetContactValue(contact, args.value ?? "");
        
        // ä½¿ç”¨æ›´ç²¾ç¢ºçš„è‡ªå‹•ç©ºè¡Œè™•ç†ï¼ˆåœ¨è¨­å®šå€¼å¾Œæª¢æŸ¥æ•´è¡Œç‹€æ…‹ï¼‰
        AutoEmptyRowHelper.For<TContactEntity>.HandleInputChangeAdvanced(
            Items, contact, IsEmptyRow, CreateEmptyItem, wasEmpty, SetParentId, ParentEntityId);
        
        await ItemsChanged.InvokeAsync(Items);
        StateHasChanged();
    }

    private async Task OnRemarksChanged((object item, string? value) args)
    {
        var contact = (TContactEntity)args.item;
        var wasEmpty = IsEmptyRow(contact);
        
        SetRemarks(contact, args.value);
        
        // ä½¿ç”¨æ›´ç²¾ç¢ºçš„è‡ªå‹•ç©ºè¡Œè™•ç†ï¼ˆåœ¨è¨­å®šå€¼å¾Œæª¢æŸ¥æ•´è¡Œç‹€æ…‹ï¼‰
        AutoEmptyRowHelper.For<TContactEntity>.HandleInputChangeAdvanced(
            Items, contact, IsEmptyRow, CreateEmptyItem, wasEmpty, SetParentId, ParentEntityId);
        
        await ItemsChanged.InvokeAsync(Items);
        StateHasChanged();
    }
    
    public async Task RemoveItemAsync(int index)
    {
        if (IsReadOnly || index < 0 || index >= Items.Count) return;
        
        var removedItem = Items[index];
        if (removedItem == null) return;
        
        // ğŸ†• è¨˜éŒ„è¦åˆªé™¤çš„è³‡æ–™åº«å¯¦é«”ID
        if (removedItem.Id > 0)
        {
            _deletedDetailIds.Add(removedItem.Id);
        }
        
        // ä½¿ç”¨ Helper è™•ç†ç§»é™¤ï¼Œè‡ªå‹•ç¢ºä¿ç©ºè¡Œ
        AutoEmptyRowHelper.For<TContactEntity>.HandleItemRemove(
            Items, removedItem, IsEmptyRow, CreateEmptyItem, SetParentId, ParentEntityId);
        
        await ItemRemoved.InvokeAsync(removedItem);
        await ItemsChanged.InvokeAsync(Items);
        
        // ğŸ†• é€šçŸ¥å·²åˆªé™¤çš„æ˜ç´°ID
        await NotifyDeletedDetailsChanged();
        
        StateHasChanged();
    }
    
    /// <summary>
    /// é€šçŸ¥å·²åˆªé™¤çš„æ˜ç´°ID
    /// </summary>
    private async Task NotifyDeletedDetailsChanged()
    {
        if (OnDeletedDetailsChanged.HasDelegate && _deletedDetailIds.Any())
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds.ToList());
            _deletedDetailIds.Clear(); // æ¸…ç©ºå·²é€šçŸ¥çš„åˆªé™¤ID
        }
    }
    
    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        // ä½¿ç”¨ Helper æª¢æŸ¥æ˜¯å¦æœ‰è¶³å¤ çš„éç©ºé …ç›®
        if (!AutoEmptyRowHelper.For<TContactEntity>.HasSufficientItems(Items, IsEmptyRow, 1))
        {
            errors.Add("è‡³å°‘éœ€è¦ä¸€å€‹è¯çµ¡æ–¹å¼");
        }
        else
        {
            // å–å¾—éç©ºçš„é …ç›®é€²è¡Œè©³ç´°é©—è­‰
            var nonEmptyItems = AutoEmptyRowHelper.For<TContactEntity>.GetNonEmptyItems(Items, IsEmptyRow);
            
            for (int i = 0; i < nonEmptyItems.Count; i++)
            {
                var item = nonEmptyItems[i];
                var contactValue = GetContactValue(item);
                var typeId = GetTypeId(item);
                
                if (string.IsNullOrWhiteSpace(contactValue))
                {
                    errors.Add($"{ItemDisplayName} #{i + 1} çš„{ValueDisplayName}ç‚ºå¿…å¡«");
                }
                
                if (!typeId.HasValue || typeId.Value <= 0)
                {
                    errors.Add($"{ItemDisplayName} #{i + 1} çš„{TypeDisplayName}ç‚ºå¿…å¡«");
                }
            }
        }
          
        if (errors.Any())
        {
            var errorMessage = string.Join("\n", errors);
            await NotificationService.ShowErrorAsync(errorMessage);
            return false;
        }
        
        return true;
    }
}
