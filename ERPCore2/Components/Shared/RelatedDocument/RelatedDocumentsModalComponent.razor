@inject INotificationService NotificationService
@inject IStringLocalizer<SharedResource> L
@using ERPCore2.Components.Shared.RelatedDocument.Config
@using ERPCore2.Components.Shared.RelatedDocument.Components
@using ERPCore2.Components.Shared.RelatedDocument.Templates

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@($"相關單據 - {ProductName}")"
                   Icon="bi bi-link-45deg"
                   Size="BaseModalComponent.ModalSize.Large"
                   HeaderColor="BaseModalComponent.HeaderVariant.Primary"
                   CloseOnEscape="true"
                   CloseOnBackdropClick="false"
                   IsLoading="@IsLoading"
                   LoadingMessage="@L["RelatedDoc.LoadingMessage"]"
                   OnClose="@Close">
    
    <BodyContent>
        @if (RelatedDocuments == null || !RelatedDocuments.Any())
        {
            <div class="text-center py-5">
                <i class="bi bi-inbox display-1 text-muted"></i>
                <p class="mt-3 text-muted">@L["RelatedDoc.NoDocuments"]</p>
            </div>
        }
        else
        {
            @* 使用重構後的組件顯示各類單據 *@
            @foreach (var group in DocumentGroups)
            {
                <RelatedDocumentSectionComponent 
                    Documents="@group.Documents"
                    Config="@group.Config"
                    OnDocumentClick="@HandleDocumentClick"
                    DetailsTemplate="@GetDetailsTemplate(group.Type)" />
            }
        }
    </BodyContent>
    
    <FooterContent>
        @* 顯示所有類型的新增按鈕（根據配置） *@
        @foreach (var group in DocumentGroups.Where(g => g.Config.ShowAddButton))
        {
            <GenericButtonComponent
                Text="@group.Config.AddButtonText"
                Variant="ButtonVariant.DarkBlue"
                OnClick="@HandleAddNew"
                Size="ButtonSize.Small" />
        }
        
        <GenericButtonComponent
            Text="@L["Button.Close"]"
            Variant="ButtonVariant.Gray"
            OnClick="@Close"
            Size="ButtonSize.Small" />
    </FooterContent>
    
</BaseModalComponent>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public string ProductName { get; set; } = string.Empty;
    [Parameter] public List<RelatedDocumentInfo>? RelatedDocuments { get; set; }
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public EventCallback<RelatedDocumentInfo> OnDocumentClick { get; set; }
    [Parameter] public EventCallback OnAddNew { get; set; }

    /// <summary>
    /// 單據分組資訊
    /// </summary>
    private class DocumentGroup
    {
        public RelatedDocumentType Type { get; set; }
        public List<RelatedDocumentInfo> Documents { get; set; } = new();
        public DocumentSectionConfig Config { get; set; } = null!;
    }

    /// <summary>
    /// 取得分組後的單據清單
    /// </summary>
    private List<DocumentGroup> DocumentGroups
    {
        get
        {
            if (RelatedDocuments == null || !RelatedDocuments.Any())
                return new List<DocumentGroup>();

            return RelatedDocuments
                .GroupBy(d => d.DocumentType)
                .Select(g => new DocumentGroup
                {
                    Type = g.Key,
                    Documents = g.ToList(),
                    Config = DocumentSectionConfig.GetConfig(g.Key)
                })
                .OrderBy(g => g.Type) // 可根據需要調整排序
                .ToList();
        }
    }

    /// <summary>
    /// 根據單據類型取得對應的詳細欄位範本
    /// </summary>
    private RenderFragment<RelatedDocumentInfo>? GetDetailsTemplate(RelatedDocumentType type)
    {
        return type switch
        {
            RelatedDocumentType.ProductComposition => doc => 
                @<CompositionDetailsTemplate Document="@doc" />,
            
            RelatedDocumentType.SalesOrder => doc => 
                @<SalesOrderDetailsTemplate Document="@doc" />,
            
            RelatedDocumentType.ReceivingDocument => doc => 
                @<ReceivingDetailsTemplate Document="@doc" />,
            
            RelatedDocumentType.ReturnDocument => doc => 
                @<ReturnDetailsTemplate Document="@doc" />,
            
            RelatedDocumentType.SetoffDocument => doc => 
                @<SetoffDetailsTemplate Document="@doc" />,
            
            RelatedDocumentType.SupplierRecommendation => doc => 
                @<SupplierRecommendationDetailsTemplate Document="@doc" />,
            
            RelatedDocumentType.InventoryTransaction => doc => 
                @<InventoryTransactionDetailsTemplate Document="@doc" />,
            
            _ => null // 使用預設範本
        };
    }

    private async Task Close()
    {
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(false);
    }

    private async Task HandleDocumentClick(RelatedDocumentInfo document)
    {
        if (OnDocumentClick.HasDelegate)
        {
            await OnDocumentClick.InvokeAsync(document);
        }
    }
    
    private async Task HandleAddNew()
    {
        if (OnAddNew.HasDelegate)
        {
            await OnAddNew.InvokeAsync();
        }
    }
}
