@* 泛型Index頁面基底組件 *@
@attribute [Authorize]
@typeparam TEntity where TEntity : BaseEntity
@typeparam TService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthenticationStateProvider

@using ERPCore2.Data.Enums
@using ERPCore2.Components.Shared.Forms
@using ERPCore2.Components.Shared.Buttons

@* 設置瀏覽器標題 *@
<PageTitle>@PageTitle</PageTitle>

@{
    // 權限檢查 - 如果沒有設定權限，預設拒絕存取
    string requiredPermission = RequiredPermission;
    if (string.IsNullOrWhiteSpace(requiredPermission))
    {
        // 安全起見，如果沒有設定權限，設定為一個不存在的權限以確保拒絕存取
        requiredPermission = "System.RequiredPermissionNotSet";
    }
}

<PagePermissionCheck RequiredPermission="@requiredPermission">

@* 頁面標題 *@
<GenericHeaderComponent Title="@PageTitle"
                       Subtitle="@PageSubtitle"
                       HeadingLevel="h1"
                       BreadcrumbItems="@BreadcrumbItems"
                       IsLoading="@IsLoading"
                       LoadingText="載入中..."
                       ShowDivider="true">
    <ActionButtons>
        @if (ShowDefaultActions && CustomActionButtons == null)
        {
            <IndexActionButtonsComponent 
                AddButtonText="@GetAddButtonText()"
                AddButtonTitle="@GetAddButtonTitle()"
                ShowAddButton="@ShowAddButton"
                OnAddClick="@HandleAddClick"
                OnRefreshClick="@RefreshData"
                ShowExportExcelButton="@ShowExportExcelButton"
                OnExportExcelClick="@HandleExportExcelClick"
                ShowExportPdfButton="@ShowExportPdfButton"
                OnExportPdfClick="@HandleExportPdfClick"
                ShowBatchPrintButton="@ShowBatchPrintButton"
                OnBatchPrintClick="@HandleBatchPrintClick"
                IsLoading="@IsLoading"
                LoadingOnRefresh="true" />
        }
        else if (CustomActionButtons != null)
        {
            @CustomActionButtons
        }
    </ActionButtons>
</GenericHeaderComponent>

@* 統計卡片區域 - 條件顯示 *@
@if (ShowStatisticsCards && StatisticsCardConfigs != null && StatisticsCardConfigs.Any())
{
    <div class="row mb-4">
        <div class="col-12">
            <ERPCore2.Components.Shared.Cards.GenericStatisticsCards CardConfigs="@StatisticsCardConfigs" 
                                   Statistics="@StatisticsData" />
        </div>
    </div>
}

@* 主要內容區域 *@
<div class="row">
    <div class="col-12">
        <div class="card section-card">
            <div class="card-header section-header-primary">                
                <h5 class="card-title mb-0">
                    <i class="bi bi-search me-2"></i>
                    @GetSearchSectionTitle()
                </h5>
            </div>
            <div class="card-body">                
                @* 搜尋篩選區域 *@
                <GenericSearchFilterComponent TModel="SearchFilterModel"
                                             FilterDefinitions="@GetFinalFilterDefinitions()"
                                             FilterModel="@SearchModel"
                                             OnSearch="@HandleSearch"
                                             OnFilterChanged="@HandleFilterChanged"
                                             AutoSearch="@AutoSearch"
                                             ShowSearchButton="@ShowSearchButton"
                                             SearchDelayMs="@SearchDelayMs" />

                @* 列表表格 *@
                <div class="mt-4">                    
                    <GenericTableComponent TItem="TEntity"
                                          Items="@PagedItems"
                                          ColumnDefinitions="@GetFinalColumnDefinitions()"
                                          EnableRowClick="@EnableRowClick"
                                          OnRowClick="@HandleRowClick"
                                          EnableSorting="@EnableSorting"
                                          IsStriped="@IsStriped"
                                          IsHoverable="@IsHoverable"
                                          IsBordered="@IsBordered"
                                          Size="@TableSize"
                                          EmptyMessage="@GetEmptyMessage()"
                                          EnablePagination="@EnablePagination"
                                          CurrentPage="@CurrentPage"
                                          PageSize="@PageSize"
                                          TotalItems="@TotalItems"
                                          OnPageChanged="@HandlePageChanged"
                                          OnPageSizeChanged="@HandlePageSizeChanged"
                                          ShowPageSizeSelector="@ShowPageSizeSelector">
                    </GenericTableComponent>
                </div>
            </div>
        </div>
    </div>
</div>
</PagePermissionCheck>

@code {
    // ===== 刷新方式枚舉 =====
    
    /// <summary>
    /// 頁面刷新方式
    /// </summary>
    public enum RefreshMode
    {
        /// <summary>
        /// 平滑刷新 - 僅重新載入資料，不會造成頁面閃爍
        /// </summary>
        Smooth,
        /// <summary>
        /// 強制刷新 - 重新載入整個頁面，會造成短暫閃爍但確保完全重置
        /// </summary>
        ForceReload
    }
    
    // ===== 參數 =====    
    
    // 權限檢查參數
    [Parameter] public string RequiredPermission { get; set; } = "";
    
    // 頁面行為設定
    [Parameter] public RefreshMode PageRefreshMode { get; set; } = RefreshMode.Smooth;
    
    // 頁面基本設定
    [Parameter] public string PageTitle { get; set; } = "資料管理";
    [Parameter] public string PageSubtitle { get; set; } = "管理資料";
    [Parameter] public string AddButtonText { get; set; } = "";
    [Parameter] public string AddButtonTitle { get; set; } = "";
    [Parameter] public string SearchSectionTitle { get; set; } = "";
    [Parameter] public string EmptyMessage { get; set; } = "";
    [Parameter] public string ActionsHeader { get; set; } = "操作";
    
    // 動作按鈕顯示控制
    [Parameter] public bool ShowDefaultActions { get; set; } = true;
    [Parameter] public bool ShowAddButton { get; set; } = true;
    [Parameter] public RenderFragment? CustomActionButtons { get; set; }
    
    // 匯出功能控制
    [Parameter] public bool ShowExportExcelButton { get; set; } = false;
    [Parameter] public bool ShowExportPdfButton { get; set; } = false;
    [Parameter] public EventCallback OnExportExcelClick { get; set; }
    [Parameter] public EventCallback OnExportPdfClick { get; set; }
    
    // 多筆列印功能控制
    [Parameter] public bool ShowBatchPrintButton { get; set; } = false;
    [Parameter] public EventCallback OnBatchPrintClick { get; set; }
    
    // 麵包屑導航
    [Parameter] public List<GenericHeaderComponent.BreadcrumbItem> BreadcrumbItems { get; set; } = new();
    
    // 統計卡片相關參數
    [Parameter] public bool ShowStatisticsCards { get; set; } = false;
    [Parameter] public List<StatisticsCardConfig>? StatisticsCardConfigs { get; set; }
    [Parameter] public Dictionary<string, object> StatisticsData { get; set; } = new();
    [Parameter] public Func<Task<Dictionary<string, object>>>? StatisticsDataLoader { get; set; }
    
    // 導航URL設定 - 新增的參數
    [Parameter] public string EntityBasePath { get; set; } = "";
    [Parameter] public string CreateUrl { get; set; } = "";
    [Parameter] public string DetailUrl { get; set; } = "";
    [Parameter] public string EditUrl { get; set; } = "";
    
    // 服務和資料相關
    [Parameter] public TService Service { get; set; } = default!;
    [Parameter] public Func<Task<List<TEntity>>> DataLoader { get; set; } = default!;
    [Parameter] public Func<Task> InitializeBasicData { get; set; } = default!;
    
    // 篩選和表格設定
    [Parameter] public List<SearchFilterDefinition> FilterDefinitions { get; set; } = new();
    [Parameter] public List<TableColumnDefinition> ColumnDefinitions { get; set; } = new();
    [Parameter] public Func<SearchFilterModel, IQueryable<TEntity>, IQueryable<TEntity>> FilterApplier { get; set; } = default!;
    
    // 自動標準欄位設定
    [Parameter] public bool AutoAddRemarksColumn { get; set; } = true;
    [Parameter] public bool AutoAddCreatedAtColumn { get; set; } = true;
    [Parameter] public bool AutoAddRemarksFilter { get; set; } = true;
    [Parameter] public string RemarksColumnTitle { get; set; } = "備註";
    [Parameter] public string CreatedAtColumnTitle { get; set; } = "建立日期";
    [Parameter] public string RemarksFilterTitle { get; set; } = "備註內容";
    
    // 搜尋組件設定
    [Parameter] public bool AutoSearch { get; set; } = true;
    [Parameter] public bool ShowSearchButton { get; set; } = true;
    [Parameter] public int SearchDelayMs { get; set; } = 500;
    
    // 表格組件設定
    [Parameter] public bool ShowActions { get; set; } = true;
    [Parameter] public bool EnableRowClick { get; set; } = true;
    [Parameter] public bool EnableSorting { get; set; } = false;
    [Parameter] public bool IsStriped { get; set; } = true;
    [Parameter] public bool IsHoverable { get; set; } = true;
    [Parameter] public bool IsBordered { get; set; } = false;
    [Parameter] public TableSize TableSize { get; set; } = TableSize.Normal;
    [Parameter] public bool EnablePagination { get; set; } = true;
    [Parameter] public bool ShowPageSizeSelector { get; set; } = true;
    [Parameter] public int DefaultPageSize { get; set; } = 20;
    
    // === 通用刪除功能相關參數 ===
    [Parameter] public string EntityName { get; set; } = "資料";
    [Parameter] public Func<TEntity, string> GetEntityDisplayName { get; set; } = entity => entity.Id.ToString();
    [Parameter] public string DeleteSuccessMessage { get; set; } = "";
    [Parameter] public string DeleteConfirmMessage { get; set; } = "";
    [Parameter] public bool EnableStandardActions { get; set; } = true;
    [Parameter] public bool ShowViewButton { get; set; } = false;
    [Parameter] public bool ShowEditButton { get; set; } = false;
    [Parameter] public bool ShowDeleteButton { get; set; } = true;
    [Parameter] public RenderFragment<TEntity>? CustomActionsTemplate { get; set; }
    
    /// <summary>
    /// 判斷特定實體是否可以刪除的函數
    /// 如果返回 false，則該實體的刪除按鈕將被隱藏
    /// 預設所有實體都可以刪除，除非明確指定判斷邏輯
    /// 例如：entity => entity.CreatedBy != "System"
    /// </summary>
    [Parameter] public Func<TEntity, bool>? CanDelete { get; set; }
    
    /// <summary>
    /// 是否啟用預設的系統資料保護機制
    /// 當啟用時，CreatedBy 為 "System" 的資料將不可刪除
    /// 預設值：true
    /// </summary>
    [Parameter] public bool EnableSystemDataProtection { get; set; } = true;
    
    // 自訂刪除處理函數 - 如果提供此參數，將會使用自訂邏輯而非預設刪除
    [Parameter] public Func<TEntity, Task<bool>>? CustomDeleteHandler { get; set; }
    
    // 事件處理 - 修改為內建導航
    [Parameter] public EventCallback OnAddClick { get; set; }
    [Parameter] public EventCallback<TEntity> OnRowClick { get; set; }
    [Parameter] public RenderFragment<TEntity>? ActionsTemplate { get; set; }

    // ===== 內建導航方法 =====
    
    private async Task HandleAddClick()
    {
        // 先執行外部提供的事件處理
        if (OnAddClick.HasDelegate)
        {
            await OnAddClick.InvokeAsync();
        }
        else
        {
            // 使用內建導航邏輯
            var url = !string.IsNullOrEmpty(CreateUrl) ? CreateUrl : $"{EntityBasePath}/edit";
            Navigation.NavigateTo(url);
        }
    }
    
    private async Task HandleRowClick(TEntity entity)
    {
        // 先執行外部提供的事件處理
        if (OnRowClick.HasDelegate)
        {
            await OnRowClick.InvokeAsync(entity);
        }
        else
        {
            // 使用內建導航邏輯
            var url = !string.IsNullOrEmpty(DetailUrl) ? DetailUrl.Replace("{id}", entity.Id.ToString()) : $"{EntityBasePath}/detail/{entity.Id}";
            Navigation.NavigateTo(url);
        }
    }

    private async Task HandleExportExcelClick()
    {
        if (OnExportExcelClick.HasDelegate)
        {
            await OnExportExcelClick.InvokeAsync();
        }
    }

    private async Task HandleExportPdfClick()
    {
        if (OnExportPdfClick.HasDelegate)
        {
            await OnExportPdfClick.InvokeAsync();
        }
    }

    private async Task HandleBatchPrintClick()
    {
        if (OnBatchPrintClick.HasDelegate)
        {
            await OnBatchPrintClick.InvokeAsync();
        }
    }
      // 公開方法供外部調用
    public void NavigateToEdit(TEntity entity)
    {
        var url = !string.IsNullOrEmpty(EditUrl) ? EditUrl.Replace("{id}", entity.Id.ToString()) : $"{EntityBasePath}/edit/{entity.Id}";
        Navigation.NavigateTo(url);
    }
    
    public void NavigateToDetail(TEntity entity)
    {
        var url = !string.IsNullOrEmpty(DetailUrl) ? DetailUrl.Replace("{id}", entity.Id.ToString()) : $"{EntityBasePath}/detail/{entity.Id}";
        Navigation.NavigateTo(url);
    }
    
    public void NavigateToCreate()
    {
        var url = !string.IsNullOrEmpty(CreateUrl) ? CreateUrl : $"{EntityBasePath}/edit";
        Navigation.NavigateTo(url);
    }
    
    // ===== 通用刪除操作 =====
    /// <summary>
    /// 通用刪除方法（永久刪除）
    /// </summary>
    public async Task DeleteEntityAsync(TEntity entity)
    {
        var displayName = GetEntityDisplayName(entity);
        
        try
        {
            // 步驟0：檢查是否允許刪除此實體（雙重保護）
            if (!IsEntityDeletable(entity))
            {
                await NotificationService.ShowWarningAsync($"此{EntityName}「{displayName}」無法刪除");
                return;
            }
            
            // 步驟1：先檢查是否可以刪除（檢查關聯）
            bool canDelete = false;
            string? canDeleteErrorMessage = null;
            
            if (CustomDeleteHandler != null)
            {
                // 如果有自訂刪除處理器，直接使用
                canDelete = true;
            }
            else
            {
                // 使用反射調用服務的 CanDeleteAsync 方法
                var canDeleteMethod = Service?.GetType().GetMethod("CanDeleteAsync", new[] { typeof(TEntity) });
                if (canDeleteMethod != null)
                {
                    var task = (Task)canDeleteMethod.Invoke(Service, new object[] { entity })!;
                    await task;
                    
                    // 獲取結果
                    var resultProperty = task.GetType().GetProperty("Result");
                    if (resultProperty != null)
                    {
                        var result = resultProperty.GetValue(task);
                        var isSuccessProperty = result?.GetType().GetProperty("IsSuccess");
                        var errorMessageProperty = result?.GetType().GetProperty("ErrorMessage");
                        
                        if (isSuccessProperty != null)
                        {
                            canDelete = (bool)isSuccessProperty.GetValue(result)!;
                            if (!canDelete)
                            {
                                canDeleteErrorMessage = errorMessageProperty?.GetValue(result)?.ToString() ?? "無法刪除此資料";
                            }
                        }
                    }
                }
                else
                {
                    // 如果沒有 CanDeleteAsync 方法，預設允許刪除
                    canDelete = true;
                }
            }
            
            // 步驟2：如果不能刪除，顯示錯誤訊息
            if (!canDelete)
            {
                await NotificationService.ShowWarningAsync(canDeleteErrorMessage ?? $"無法刪除{EntityName}「{displayName}」，因為有其他資料正在使用此{EntityName}");
                return;
            }
            
            // 步驟3：確認刪除
            var confirmMessage = GetDeleteConfirmMessage(displayName);
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", confirmMessage);
            
            if (!confirmed)
                return;
                
            // 步驟4：執行刪除
            bool deleteSuccess = false;
            
            if (CustomDeleteHandler != null)
            {
                deleteSuccess = await CustomDeleteHandler(entity);
            }
            else
            {
                // 使用預設的反射調用服務的 PermanentDeleteAsync 方法
                var deleteMethod = Service?.GetType().GetMethod("PermanentDeleteAsync", new[] { typeof(int) });
                if (deleteMethod != null)
                {
                    var task = (Task)deleteMethod.Invoke(Service, new object[] { entity.Id })!;
                    await task;
                    
                    // 獲取結果
                    var resultProperty = task.GetType().GetProperty("Result");
                    if (resultProperty != null)
                    {                        
                        var result = resultProperty.GetValue(task);
                        var isSuccessProperty = result?.GetType().GetProperty("IsSuccess");
                        var errorMessageProperty = result?.GetType().GetProperty("ErrorMessage");
                        
                        if (isSuccessProperty != null)
                        {
                            var isSuccess = (bool)isSuccessProperty.GetValue(result)!;                            
                            if (isSuccess)
                            {
                                deleteSuccess = true;
                            }
                            else
                            {
                                var errorMessage = errorMessageProperty?.GetValue(result)?.ToString() ?? "刪除失敗";
                                await NotificationService.ShowErrorAsync($"刪除失敗：{errorMessage}");
                                return;
                            }
                        }
                    }                
                }               
                else
                {
                    await NotificationService.ShowErrorAsync("找不到永久刪除方法");
                    return;
                }
            }
            
            // 步驟5：顯示成功訊息並刷新資料
            if (deleteSuccess)
            {
                var successMessage = GetDeleteSuccessMessage();
                await NotificationService.ShowSuccessAsync(successMessage);                
                await Refresh();
            }
        }            
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"刪除時發生錯誤：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 取得標準操作按鈕範本
    /// </summary>
    public RenderFragment<TEntity> GetStandardActionsTemplate()
    {
        return entity => 
            @<div>
                @if (CustomActionsTemplate != null)
                {
                    @CustomActionsTemplate(entity)
                }
                @if (ShowDeleteButton && IsEntityDeletable(entity))
                {
                    <GenericButtonComponent 
                        Variant="ButtonVariant.Danger"
                        IconClass="bi bi-trash text-white"
                        Title="刪除"
                        OnClick="async () => await DeleteEntityAsync(entity)"
                        StopPropagation="true"
                        CssClass="btn-square" />
                }
            </div>;
    }
    
    /// <summary>
    /// 取得最終的操作範本
    /// </summary>
    private RenderFragment<TEntity> GetFinalActionsTemplate()
    {
        if (ActionsTemplate != null)
        {
            return ActionsTemplate;
        }
        else if (EnableStandardActions)
        {
            return GetStandardActionsTemplate();
        }
        else
        {
            return entity => @<div></div>;
        }
    }

    /// <summary>
    /// 判斷實體是否可以刪除
    /// 結合預設系統資料保護和自訂判斷邏輯
    /// </summary>
    private bool IsEntityDeletable(TEntity entity)
    {
        // 優先檢查自訂的 CanDelete 函數
        if (CanDelete != null)
        {
            return CanDelete(entity);
        }
        
        // 如果啟用系統資料保護，則檢查 CreatedBy
        if (EnableSystemDataProtection)
        {
            return entity.CreatedBy != "System";
        }
        
        // 預設允許刪除
        return true;
    }

    // ===== 智能文字產生方法 =====
    
    /// <summary>
    /// 取得新增按鈕文字，優先使用自訂值，否則根據 EntityName 自動產生
    /// </summary>
    private string GetAddButtonText()
    {
        return !string.IsNullOrWhiteSpace(AddButtonText) ? AddButtonText : $"新增{EntityName}";
    }
    
    /// <summary>
    /// 取得新增按鈕標題，優先使用自訂值，否則根據 EntityName 自動產生
    /// </summary>
    private string GetAddButtonTitle()
    {
        return !string.IsNullOrWhiteSpace(AddButtonTitle) ? AddButtonTitle : $"新增{EntityName}資料";
    }
    
    /// <summary>
    /// 取得搜尋區域標題，優先使用自訂值，否則根據 EntityName 自動產生
    /// </summary>
    private string GetSearchSectionTitle()
    {
        return !string.IsNullOrWhiteSpace(SearchSectionTitle) ? SearchSectionTitle : $"{EntityName}搜尋與管理";
    }
    
    /// <summary>
    /// 取得空資料訊息，優先使用自訂值，否則根據 EntityName 自動產生
    /// </summary>
    private string GetEmptyMessage()
    {
        return !string.IsNullOrWhiteSpace(EmptyMessage) ? EmptyMessage : $"沒有找到符合條件的{EntityName}資料";
    }
    
    /// <summary>
    /// 取得刪除成功訊息，優先使用自訂值，否則根據 EntityName 自動產生
    /// </summary>
    private string GetDeleteSuccessMessage()
    {
        return !string.IsNullOrWhiteSpace(DeleteSuccessMessage) ? DeleteSuccessMessage : $"{EntityName}刪除成功";
    }
    
    /// <summary>
    /// 取得刪除確認訊息，優先使用自訂值，否則根據 EntityName 自動產生
    /// </summary>
    private string GetDeleteConfirmMessage(string displayName)
    {
        if (!string.IsNullOrWhiteSpace(DeleteConfirmMessage))
        {
            return string.Format(DeleteConfirmMessage, displayName);
        }
        return $"確定要刪除{EntityName}「{displayName}」嗎？";
    }

    // ===== 標準欄位和篩選器處理方法 =====
    
    /// <summary>
    /// 取得最終的欄位定義（自動添加標準欄位）
    /// </summary>
    private List<TableColumnDefinition> GetFinalColumnDefinitions()
    {
        var columns = new List<TableColumnDefinition>(ColumnDefinitions);
        
        // 自動添加備註欄位
        if (AutoAddRemarksColumn)
        {
            // 檢查是否已經有備註欄位，避免重複添加
            if (!columns.Any(c => c.PropertyName == "Remarks"))
            {
                var remarksColumn = TableColumnDefinition.Text(RemarksColumnTitle, nameof(BaseEntity.Remarks));
                // 設定備註欄位樣式
                remarksColumn.HeaderStyle = "width: 150px;";
                remarksColumn.CellCssClass = "text-truncate";
                columns.Add(remarksColumn);
            }
        }
        
        // 自動添加建立日期欄位
        if (AutoAddCreatedAtColumn)
        {
            // 檢查是否已經有建立日期欄位，避免重複添加
            if (!columns.Any(c => c.PropertyName == "CreatedAt"))
            {
                var createdAtColumn = TableColumnDefinition.Date(CreatedAtColumnTitle, nameof(BaseEntity.CreatedAt), "yyyy/MM/dd");
                // 設定較小的欄位寬度，標題和內容都置中
                createdAtColumn.HeaderStyle = "width: 100px; text-align: center;";
                createdAtColumn.CellCssClass = "text-center";
                columns.Add(createdAtColumn);
            }
        }
        
        // 自動添加操作欄位
        if (ShowActions && EnableStandardActions)
        {
            // 檢查是否已經有操作欄位，避免重複添加
            if (!columns.Any(c => c.PropertyName == "Actions"))
            {
                var actionsTemplate = GetFinalActionsTemplate();
                var actionsColumn = new TableColumnDefinition
                {
                    Title = ActionsHeader,
                    PropertyName = "Actions", // 虛擬屬性名稱
                    DataType = ColumnDataType.Html,
                    HeaderCssClass = "text-center",
                    CellCssClass = "text-center",
                    HeaderStyle = "width: 60px;",
                    CustomTemplate = (item) => actionsTemplate((TEntity)item)
                };
                columns.Add(actionsColumn);
            }
        }
        
        return columns;
    }
    
    /// <summary>
    /// 取得最終的篩選器定義（自動添加標準篩選器）
    /// </summary>
    private List<SearchFilterDefinition> GetFinalFilterDefinitions()
    {
        var filters = new List<SearchFilterDefinition>(FilterDefinitions);
        
        // 自動添加備註篩選器
        if (AutoAddRemarksFilter)
        {
            // 檢查是否已經有備註篩選器，避免重複添加
            if (!filters.Any(f => f.PropertyName == "Remarks"))
            {
                try
                {
                    var remarksFilter = new SearchFilterDefinition
                    {
                        Name = "Remarks",
                        Label = RemarksFilterTitle,
                        Type = SearchFilterType.Text,
                        Placeholder = "輸入備註關鍵字..."
                    };
                    
                    filters.Add(remarksFilter);
                }
                catch
                {
                    // 如果有錯誤，跳過添加備註篩選器
                }
            }
        }
        
        return filters;
    }

    // ...existing code...
    // ===== 內部狀態 =====
    
    // 資料來源
    private List<TEntity> allItems = new();
    private List<TEntity> filteredItems = new();
    private List<TEntity> pagedItems = new(); // 新增：快取分頁資料
    
    // 篩選相關
    private SearchFilterModel searchModel = new();
    
    // 分頁相關
    private int currentPage = 1;
    private int pageSize = 20;
    private int totalItems = 0;
    
    // 狀態管理
    private bool isLoading = true;
    
    // ===== 公開屬性 (供外部存取) =====
    public SearchFilterModel SearchModel => searchModel;
    public List<TEntity> PagedItems => pagedItems; // 改為返回快取的分頁資料
    public int CurrentPage => currentPage;
    public int PageSize => pageSize;
    public int TotalItems => totalItems;
    public bool IsLoading => isLoading;
    
    // ===== 生命週期 =====
    
    protected override async Task OnInitializedAsync()
    {
        pageSize = DefaultPageSize;
        await InitializePageAsync();
    }
    
    // ===== 初始化方法 =====
    
    private async Task InitializePageAsync()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            // 初始化基礎資料 (如選項清單等)
            if (InitializeBasicData != null)
            {
                await InitializeBasicData();
            }
            
            // 載入統計資料
            if (ShowStatisticsCards && StatisticsDataLoader != null)
            {
                StatisticsData = await StatisticsDataLoader();
            }
            
            // 載入主要資料
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            // 錯誤處理 - 可以透過參數提供自定義錯誤處理
            Console.Error.WriteLine($"初始化頁面時發生錯誤: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task LoadDataAsync()
    {
        try
        {
            if (DataLoader != null)
            {
                allItems = await DataLoader();
                await ApplyFilters(); // 這裡會調用 StateHasChanged()
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"載入資料失敗: {ex.Message}");
            allItems = new List<TEntity>();
            filteredItems = new List<TEntity>();
            StateHasChanged(); // 確保錯誤狀態也會更新 UI
        }
    }
    
    // ===== 篩選和分頁邏輯 =====
    
    private async Task ApplyFilters()
    {
        var query = allItems.AsQueryable();
        
        // 應用自定義篩選邏輯
        if (FilterApplier != null)
        {
            query = FilterApplier(searchModel, query);
        }
        else
        {
            // 如果沒有提供自定義篩選邏輯，應用標準狀態篩選
            query = ApplyStandardFilters(searchModel, query);
        }
        
        filteredItems = query.ToList();
        totalItems = filteredItems.Count;
        
        // 重置分頁到第一頁
        currentPage = 1;
        
        // 更新分頁資料
        UpdatePagedItems();
        
        // 自動更新統計資料
        if (ShowStatisticsCards && StatisticsCardConfigs != null && StatisticsCardConfigs.Any())
        {
            UpdateStatisticsData();
        }
        
        // 確保 UI 更新
        StateHasChanged();
        
        await Task.CompletedTask;
    }
    
    /// <summary>
    /// 應用標準篩選邏輯（當沒有提供自定義篩選器時使用）
    /// </summary>
    private IQueryable<TEntity> ApplyStandardFilters(SearchFilterModel searchModel, IQueryable<TEntity> query)
    {
        // 備註篩選
        if (AutoAddRemarksFilter)
        {
            var remarksFilter = searchModel.GetFilterValue("Remarks")?.ToString();
            if (!string.IsNullOrWhiteSpace(remarksFilter))
            {
                query = query.Where(entity => entity.Remarks != null && entity.Remarks.Contains(remarksFilter));
            }
        }
        
        return query;
    }
    
    /// <summary>
    /// 自動更新統計資料
    /// </summary>
    private void UpdateStatisticsData()
    {
        try
        {
            StatisticsData = StatisticsData ?? new Dictionary<string, object>();
            
            // 自動計算基本統計
            StatisticsData["TotalItems"] = filteredItems.Count;
            StatisticsData["TotalOrders"] = filteredItems.Count;
            
            // 如果是採購訂單，計算特定統計
            if (typeof(TEntity).Name == "PurchaseOrder")
            {
                var orders = filteredItems.Cast<dynamic>().ToList();
                
                StatisticsData["PendingOrders"] = 0;
                    
                StatisticsData["CompletedOrders"] = 0;
                    
                StatisticsData["TotalAmount"] = orders.Sum(o => (decimal)o.TotalAmount);
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"更新統計資料失敗: {ex.Message}");
        }
    }
    
    private void UpdatePagedItems()
    {
        // 確保當前頁面有效
        var maxPage = totalItems > 0 ? (int)Math.Ceiling((double)totalItems / pageSize) : 1;
        if (currentPage > maxPage)
        {
            currentPage = Math.Max(1, maxPage);
        }
        
        // 計算分頁資料並更新快取
        pagedItems = filteredItems
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }
    
    // ===== 事件處理方法 =====
    
    private async Task HandleSearch(SearchFilterModel filterModel)
    {
        searchModel = filterModel;
        await ApplyFilters(); // ApplyFilters 已經會調用 StateHasChanged()
    }
    
    private async Task HandleFilterChanged(SearchFilterModel filterModel)
    {
        searchModel = filterModel;
        // 如果啟用自動搜尋，這裡不需要立即執行搜尋
        await Task.CompletedTask;
    }
    
    private async Task HandlePageChanged(int newPage)
    {
        currentPage = newPage;
        UpdatePagedItems();
        StateHasChanged();
        await Task.CompletedTask;
    }
    
    private async Task HandlePageSizeChanged(int newPageSize)
    {
        pageSize = newPageSize;
        currentPage = 1; // 重置到第一頁
        UpdatePagedItems();
        StateHasChanged();
        await Task.CompletedTask;
    }
    
    private async Task RefreshData()
    {
        if (PageRefreshMode == RefreshMode.ForceReload)
        {
            // 強制重新載入整個頁面
            Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
            return;
        }
        
        // 使用平滑刷新，避免頁面閃爍
        try
        {
            isLoading = true;
            StateHasChanged();
            
            // 重新初始化基礎資料 (如選項清單等)
            if (InitializeBasicData != null)
            {
                await InitializeBasicData();
            }
            
            // 載入統計資料
            if (ShowStatisticsCards && StatisticsDataLoader != null)
            {
                StatisticsData = await StatisticsDataLoader();
            }
            
            // 重新載入主要資料 - 這是關鍵步驟
            if (DataLoader != null)
            {
                allItems = await DataLoader();
                await ApplyFilters(); // 這會重新計算 filteredItems 並觸發 StateHasChanged
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"刷新資料時發生錯誤: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    // ===== 公開方法 (供外部調用) =====
    
    public async Task Refresh()
    {
        await RefreshData();
    }
    
    /// <summary>
    /// 使用指定的刷新方式刷新頁面
    /// </summary>
    /// <param name="mode">刷新方式</param>
    public async Task Refresh(RefreshMode mode)
    {
        var originalMode = PageRefreshMode;
        PageRefreshMode = mode;
        await RefreshData();
        PageRefreshMode = originalMode; // 恢復原始設定
    }
    
    /// <summary>
    /// 平滑刷新 - 僅重新載入資料，不會造成頁面閃爍
    /// </summary>
    public async Task SmoothRefresh()
    {
        await Refresh(RefreshMode.Smooth);
    }
    
    /// <summary>
    /// 強制刷新 - 重新載入整個頁面
    /// </summary>
    public async Task ForceRefresh()
    {
        await Refresh(RefreshMode.ForceReload);
    }
    
    public async Task ReloadData()
    {
        await LoadDataAsync();
    }
    
    public void ResetFilters()
    {
        searchModel = new SearchFilterModel();
        _ = ApplyFilters();
        StateHasChanged();
    }
}

