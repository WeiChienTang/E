@* AutoComplete æ¬„ä½å­çµ„ä»¶ *@
@using Microsoft.AspNetCore.Components.Web
@using ERPCore2.Components.Shared.UI.Form
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="@FormConstants.CssClasses.PositionRelative">
    <input type="text"
           class="@InputCssClass"
           id="@FieldId"
           @ref="_inputRef"
           name="@($"{FieldId}_{Guid.NewGuid().ToString("N").Substring(0, 8)}")"
           placeholder="@Field.Placeholder"
           readonly="@Field.IsReadOnly"
           disabled="@Field.IsDisabled"
           autocomplete="@FormConstants.AutoCompleteAttributes.Off"
           maxlength="@Field.MaxLength"
           minlength="@Field.MinLength"
           value="@_state.DisplayValue"
           @oninput="@(e => HandleInput(e.Value?.ToString() ?? ""))"
           @onfocus="HandleFocus"
           @onblur="HandleBlur"
           @onkeydown="HandleKeyDown" />
    
    @if (!Field.IsReadOnly && !Field.IsDisabled)
    {
        @if (_state.IsLoading)
        {
            <div class="position-absolute" style="right: 10px; top: 50%; transform: translateY(-50%);">
                <span class="spinner-border" style="width: 2rem; height: 2rem; border-width: 0.15em;"></span>
            </div>
        }
        
        @if (_state.IsVisible && _state.Options.Any())
        {
            @* ä½¿ç”¨ fixed å®šä½è®“ä¸‹æ‹‰é¸å–®å¯ä»¥è¶…å‡º Modal é‚Šç•Œ *@
            <div class="@FormConstants.CssClasses.ListGroup autocomplete-dropdown-fixed" 
                 style="@GetDropdownStyle()">
                @for (int i = 0; i < _state.Options.Count; i++)
                {
                    var index = i;
                    var option = _state.Options[i];
                    var isHighlighted = _state.HighlightedIndex == index;
                    var cssClass = isHighlighted 
                        ? FormConstants.CssClasses.ListGroupItemActive 
                        : FormConstants.CssClasses.ListGroupItem;
                    
                    <button type="button"
                            class="@cssClass"
                            id="@($"{FieldId}_option_{index}")"
                            @onmousemove="@(() => SetHighlightedIndex(index))"
                            @onmousedown="@(async () => await SelectOption(option))">
                        @option.Text
                    </button>
                }
            </div>
        }
    }
</div>

@code {
    [Parameter, EditorRequired]
    public FormFieldDefinition Field { get; set; } = default!;

    [Parameter]
    public string? Value { get; set; }

    [Parameter]
    public EventCallback<string?> ValueChanged { get; set; }

    [Parameter]
    public string? InitialDisplayValue { get; set; }

    [Parameter]
    public bool HasActionButtons { get; set; }

    [Parameter]
    public string CssClass { get; set; } = FormConstants.CssClasses.FormControl;

    private string FieldId => Field.PropertyName;
    
    private string InputCssClass => HasActionButtons 
        ? $"{CssClass} {FormConstants.CssClasses.HasActionButtons}" 
        : CssClass;

    private readonly AutoCompleteFieldState _state = new();
    
    // è¿½è¹¤ä¸Šä¸€æ¬¡çš„ Valueï¼Œç”¨æ–¼åµæ¸¬å€¼è®ŠåŒ–æ–¹å‘
    private string? _previousValue;
    
    // Input å…ƒç´ åƒè€ƒï¼ˆç”¨æ–¼è¨ˆç®—ä¸‹æ‹‰é¸å–®ä½ç½®ï¼‰
    private ElementReference _inputRef;
    
    // ä¸‹æ‹‰é¸å–®ä½ç½®è³‡è¨Š
    private double _dropdownTop = 0;
    private double _dropdownLeft = 0;
    private double _dropdownWidth = 0;
    
    /// <summary>
    /// å–å¾—ä¸‹æ‹‰é¸å–®çš„æ¨£å¼ï¼ˆä½¿ç”¨ fixed å®šä½ï¼‰
    /// </summary>
    private string GetDropdownStyle()
    {
        // ä½¿ç”¨ fixed å®šä½è®“ä¸‹æ‹‰é¸å–®å¯ä»¥è¶…å‡ºçˆ¶å®¹å™¨ï¼ˆå¦‚ Modalï¼‰çš„é‚Šç•Œ
        return $"position: fixed; " +
               $"top: {_dropdownTop}px; " +
               $"left: {_dropdownLeft}px; " +
               $"width: {_dropdownWidth}px; " +
               $"max-height: {FormConstants.Defaults.DropdownMaxHeight}px; " +
               $"overflow-y: auto; " +
               $"z-index: 99999; " +  // ç¢ºä¿åœ¨ Modal ä¹‹ä¸Š
               $"background-color: #fff; " +
               $"border: 1px solid #dee2e6; " +
               $"border-radius: 0.375rem; " +
               $"box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);";
    }
    
    /// <summary>
    /// æ›´æ–°ä¸‹æ‹‰é¸å–®ä½ç½®
    /// </summary>
    private async Task UpdateDropdownPositionAsync()
    {
        try
        {
            var rect = await JSRuntime.InvokeAsync<BoundingClientRect>("getElementBoundingRect", _inputRef);
            if (rect != null)
            {
                _dropdownTop = rect.Bottom;
                _dropdownLeft = rect.Left;
                _dropdownWidth = rect.Width;
            }
        }
        catch
        {
            // å¦‚æœ JS å‘¼å«å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼
        }
    }
    
    /// <summary>
    /// ç”¨æ–¼æ¥æ”¶ JS å›å‚³çš„å…ƒç´ ä½ç½®è³‡è¨Š
    /// </summary>
    private class BoundingClientRect
    {
        public double Top { get; set; }
        public double Left { get; set; }
        public double Bottom { get; set; }
        public double Right { get; set; }
        public double Width { get; set; }
        public double Height { get; set; }
    }

    protected override void OnParametersSet()
    {
        // åˆ¤æ–· Value æ˜¯å¦æœ‰æ•ˆï¼ˆä¸æ˜¯ç©ºã€null æˆ– "0"ï¼‰
        var hasValidValue = !string.IsNullOrEmpty(Value) && Value != "0";

        // åˆ¤æ–·æ˜¯å¦å¾æœ‰å€¼è®Šæˆç„¡å€¼ï¼ˆçœŸæ­£çš„ã€Œæ¸…é™¤ã€å‹•ä½œï¼‰
        var previousWasValid = !string.IsNullOrEmpty(_previousValue) && _previousValue != "0";
        var valueWasCleared = previousWasValid && !hasValidValue;

        // åˆ¤æ–·æ˜¯å¦å¾ä¸€å€‹æœ‰æ•ˆå€¼æ›åˆ°å¦ä¸€å€‹æœ‰æ•ˆå€¼ï¼ˆä¾‹å¦‚ï¼šç¨‹å¼è‡ªå‹•å¸¶å…¥è·¨æ¬„ä½å€¼ï¼‰
        var valueChangedToAnother = hasValidValue && previousWasValid && _previousValue != Value;

        if (valueWasCleared)
        {
            // æƒ…æ³1ï¼šå€¼å¾æœ‰æ•ˆè®Šæˆç„¡æ•ˆ â†’ æ¸…ç©º DisplayValue
            _state.DisplayValue = string.Empty;
        }
        else if (valueChangedToAnother && !string.IsNullOrEmpty(InitialDisplayValue))
        {
            // æƒ…æ³4ï¼šå€¼å¾ä¸€å€‹æœ‰æ•ˆå€¼æ›æˆå¦ä¸€å€‹æœ‰æ•ˆå€¼ï¼ˆç¨‹å¼è‡ªå‹•å¸¶å…¥ï¼‰â†’ æ›´æ–° DisplayValue
            _state.DisplayValue = InitialDisplayValue;
        }
        else if (hasValidValue && string.IsNullOrEmpty(_state.DisplayValue))
        {
            // æƒ…æ³2ï¼šValue æœ‰æ•ˆä½† DisplayValue æ˜¯ç©ºçš„ â†’ éœ€è¦åˆå§‹åŒ–
            if (!string.IsNullOrEmpty(InitialDisplayValue))
            {
                _state.DisplayValue = InitialDisplayValue;
            }
            else
            {
                _ = LoadDisplayValueAsync();
            }
        }
        // æƒ…æ³3ï¼šValue ä¸€é–‹å§‹å°±æ˜¯ç©ºçš„ï¼ˆè™›æ“¬æ¬„ä½ï¼‰â†’ ä¸å¹²æ“¾ï¼Œä¿æŒ DisplayValue
        // é€™å…è¨±ç”¨æˆ¶åœ¨è™›æ“¬æ¬„ä½ä¸­è¼¸å…¥å’Œé¸æ“‡

        // æ›´æ–°è¿½è¹¤çš„å€¼
        _previousValue = Value;
    }

    private async Task LoadDisplayValueAsync()
    {
        if (Field.SearchFunction == null || string.IsNullOrEmpty(Value)) return;

        try
        {
            var options = await Field.SearchFunction("");
            var match = options.FirstOrDefault(o => o.Value == Value);
            if (match != null)
            {
                _state.DisplayValue = match.Text;
                StateHasChanged();
            }
        }
        catch
        {
            // éœé»˜è™•ç†
        }
    }

    private void HandleInput(string inputValue)
    {
        _state.DisplayValue = inputValue;
        _ = PerformSearchAsync(inputValue);
    }

    private async Task HandleFocus()
    {
        _state.HasBlurred = false;
        var inputValue = _state.DisplayValue;
        
        // å…ˆæ›´æ–°ä¸‹æ‹‰é¸å–®ä½ç½®
        await UpdateDropdownPositionAsync();
        
        if (Field.MinSearchLength == 0 || 
            (!string.IsNullOrEmpty(inputValue) && inputValue.Length >= Field.MinSearchLength))
        {
            _ = PerformSearchAsync(inputValue);
        }
    }

    private async Task HandleBlur()
    {
        _state.HasBlurred = true;
        _state.ClearTimer();
        _state.IsLoading = false;

        await TrySmartMatchAsync();

        // å»¶é²éš±è—ä¸‹æ‹‰é¸å–®
        Timer? timer = null;
        timer = new Timer(_ =>
        {
            _state.IsVisible = false;
            InvokeAsync(StateHasChanged);
            timer?.Dispose();
        }, null, FormConstants.Defaults.BlurDelayMs, Timeout.Infinite);
    }

    private async Task PerformSearchAsync(string inputValue)
    {
        _state.ClearTimer();
        _state.IsLoading = false;

        if (_state.HasBlurred) return;

        // è™•ç†ç©ºè¼¸å…¥
        if (string.IsNullOrEmpty(inputValue))
        {
            // ğŸ”‘ ä¿®æ­£ï¼šç„¡è«– Value æ˜¯å¦æœ‰å€¼éƒ½è§¸ç™¼æ¸…é™¤äº‹ä»¶
            // é€™è§£æ±ºäº†è™›æ“¬æ¬„ä½ï¼ˆValue å§‹çµ‚ç‚º nullï¼‰æ¸…é™¤æ™‚ç„¡æ³•è§¸ç™¼äº‹ä»¶çš„å•é¡Œ
            // çˆ¶çµ„ä»¶æœƒåŒæ­¥æ¸…é™¤ InitialDisplayValue ç‹€æ…‹
            await ValueChanged.InvokeAsync(null);

            if (Field.MinSearchLength > 0)
            {
                _state.IsVisible = false;
                StateHasChanged();
                return;
            }
        }

        // æª¢æŸ¥æœ€å°æœå°‹é•·åº¦
        if (inputValue.Length < Field.MinSearchLength)
        {
            _state.IsVisible = false;
            StateHasChanged();
            return;
        }

        _state.IsLoading = true;
        StateHasChanged();

        // å»¶é²æœå°‹
        _state.SearchTimer = new Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                try
                {
                    if (Field.SearchFunction != null)
                    {
                        var results = await Field.SearchFunction(inputValue);
                        _state.Options = results;
                        _state.IsVisible = results.Any();
                    }
                }
                catch
                {
                    _state.Options = new List<SelectOption>();
                    _state.IsVisible = false;
                }
                finally
                {
                    _state.IsLoading = false;
                    StateHasChanged();
                }
            });
        }, null, Field.AutoCompleteDelayMs, Timeout.Infinite);
    }

    private async Task HandleKeyDown(KeyboardEventArgs args)
    {
        var options = _state.Options;

        switch (args.Key)
        {
            case "ArrowDown":
                if (!_state.IsVisible)
                {
                    await PerformSearchAsync(_state.DisplayValue);
                }
                else if (options.Any())
                {
                    MoveHighlight(1);
                }
                break;

            case "ArrowUp":
                if (_state.IsVisible && options.Any())
                {
                    MoveHighlight(-1);
                }
                break;

            case "Enter":
                if (_state.IsVisible && options.Any())
                {
                    if (options.Count == 1)
                    {
                        await SelectOption(options[0]);
                    }
                    else if (_state.HighlightedIndex >= 0 && _state.HighlightedIndex < options.Count)
                    {
                        await SelectOption(options[_state.HighlightedIndex]);
                    }
                }
                break;

            case "Escape":
                _state.HideDropdown();
                break;

            case "Tab":
                if (_state.IsVisible && options.Count == 1)
                {
                    await SelectOption(options[0]);
                }
                else
                {
                    await TrySmartMatchAsync();
                    _state.HideDropdown();
                }
                break;
        }

        StateHasChanged();
    }

    private void MoveHighlight(int direction)
    {
        if (!_state.Options.Any()) return;

        var newIndex = _state.HighlightedIndex + direction;

        if (newIndex < 0)
            newIndex = _state.Options.Count - 1;
        else if (newIndex >= _state.Options.Count)
            newIndex = 0;

        _state.HighlightedIndex = newIndex;
        _state.IsKeyboardNavigating = true;

        _ = ScrollToOptionAsync(newIndex);
    }

    private async Task ScrollToOptionAsync(int index)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("scrollToElement", $"{FieldId}_option_{index}");
        }
        catch
        {
            // éœé»˜è™•ç†
        }
    }

    private void SetHighlightedIndex(int index)
    {
        _state.HighlightedIndex = index;
        _state.IsKeyboardNavigating = false;
        StateHasChanged();
    }

    private async Task SelectOption(SelectOption option)
    {
        _state.DisplayValue = option.Text;
        _state.HideDropdown();
        await ValueChanged.InvokeAsync(option.Value);
        StateHasChanged();
    }

    private async Task TrySmartMatchAsync()
    {
        var inputValue = _state.DisplayValue.Trim();

        if (string.IsNullOrEmpty(inputValue))
        {
            // ğŸ”‘ ä¿®æ­£ï¼šç„¡è«– Value æ˜¯å¦æœ‰å€¼éƒ½è§¸ç™¼æ¸…é™¤äº‹ä»¶
            // é€™è§£æ±ºäº†è™›æ“¬æ¬„ä½ï¼ˆValue å§‹çµ‚ç‚º nullï¼‰æ¸…é™¤æ™‚ç„¡æ³•è§¸ç™¼äº‹ä»¶çš„å•é¡Œ
            // çˆ¶çµ„ä»¶æœƒæ ¹æ“šè‡ªå·±è¿½è¹¤çš„ç‹€æ…‹ä¾†åˆ¤æ–·æ˜¯å¦éœ€è¦è™•ç†
            await ValueChanged.InvokeAsync(null);
            return;
        }

        try
        {
            if (Field.SearchFunction != null)
            {
                var results = await Field.SearchFunction(inputValue);

                // ç²¾ç¢ºåŒ¹é…
                var exactMatch = results.FirstOrDefault(r =>
                    string.Equals(r.Text, inputValue, StringComparison.OrdinalIgnoreCase));

                if (exactMatch != null)
                {
                    _state.DisplayValue = exactMatch.Text;
                    await ValueChanged.InvokeAsync(exactMatch.Value);
                    return;
                }

                // å–®ä¸€çµæœ
                if (results.Count == 1)
                {
                    _state.DisplayValue = results[0].Text;
                    await ValueChanged.InvokeAsync(results[0].Value);
                    return;
                }

                // ç„¡åŒ¹é…å‰‡æ¸…ç©º
                if (!string.IsNullOrEmpty(Value))
                {
                    _state.DisplayValue = string.Empty;
                    await ValueChanged.InvokeAsync(null);
                }
            }
        }
        catch
        {
            // éœé»˜è™•ç†
        }
    }

    public void Dispose()
    {
        _state.Dispose();
    }
}
