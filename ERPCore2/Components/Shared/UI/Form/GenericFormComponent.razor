@* 通用表單組件 - 基於配置驅動的動態表單 *@
@* 使用子組件架構重構版本 *@
@using System.ComponentModel.DataAnnotations
@using System.Reflection
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@using ERPCore2.Components.Shared.UI.Button
@using ERPCore2.Components.Shared.UI.Form
@using ERPCore2.Helpers.EditModal
@typeparam TModel

<div class="generic-form-container">
    @* 添加假的隱藏欄位來欺騙瀏覽器的自動填入功能 *@
    <input type="text" style="display:none" autocomplete="off" />
    <input type="password" style="display:none" autocomplete="new-password" />
    
    <EditForm Model="Model" @ref="editForm">
        <DataAnnotationsValidator />
        
        @if (ShowValidationSummary)
        {
            <ValidationSummary />
        }
        
        @if (TabDefinitions != null && TabDefinitions.Count > 0 && FieldSections != null && FieldDefinitions != null)
        {
            @* ===== Tab 佈局模式 - 每個 Tab 包含一或多個 Section ===== *@
            var orderedSections = GetOrderedSections().ToList();

            <div class="form-tab-container">
                @* Tab 按鈕群組 *@
                <div class="form-tab-btn-group">
                    @for (var i = 0; i < TabDefinitions.Count; i++)
                    {
                        var index = i;
                        var tab = TabDefinitions[i];
                        <button type="button"
                                class="form-tab-btn @(_activeTabIndex == index ? "active" : "")"
                                @onclick="@(() => SetActiveTab(index))">
                            @if (!string.IsNullOrEmpty(tab.Icon))
                            {
                                <i class="@tab.Icon"></i>
                            }
                            @tab.Label
                        </button>
                    }
                </div>

                @* Tab 內容區域 *@
                <div class="tab-content form-tab-content">
                    @for (var i = 0; i < TabDefinitions.Count; i++)
                    {
                        var index = i;
                        var tab = TabDefinitions[i];
                        var tabSections = orderedSections
                            .Where(s => tab.SectionNames.Contains(s.Key)).ToList();
                        var sectionColClass = GetSectionColumnClass(tabSections.Count);

                        <div class="tab-pane @(_activeTabIndex == index ? "active show" : "")"
                             style="@(_activeTabIndex == index ? "" : "display:none")">
                            @if (tab.CustomContent != null)
                            {
                                @* 自訂內容 Tab：渲染 CustomContent RenderFragment *@
                                @tab.CustomContent
                            }
                            else
                            {
                                <div class="form-sections-container">
                                    @foreach (var sectionGroup in tabSections)
                                    {
                                        var isFilterSectionTab = IsFilterSection(sectionGroup.Key);
                                        <div class="form-section-column @sectionColClass">
                                            <div class="form-section-header @(isFilterSectionTab ? "form-section-header-filter" : "")">
                                                @if (isFilterSectionTab)
                                                {
                                                    <i class="bi bi-funnel-fill form-section-filter-icon"></i>
                                                }
                                                <span class="form-section-title @(isFilterSectionTab ? "form-section-title-filter" : "")">@(sectionGroup.Key)</span>
                                            </div>
                                            <div class="form-section-fields">
                                                @foreach (var fieldKvp in sectionGroup)
                                                {
                                                    var field = FieldDefinitions?.FirstOrDefault(f => f.PropertyName == fieldKvp.Key);
                                                    if (field != null)
                                                    {
                                                        @RenderFieldMarkup(field)
                                                    }
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }
        else if (FieldSections != null && FieldSections.Any() && FieldDefinitions != null)
        {
            @* ===== 水平並排佈局（現有行為，無 Tab）===== *@
            var orderedSections = GetOrderedSections().ToList();
            var sectionCount = orderedSections.Count;
            var sectionColClass = GetSectionColumnClass(sectionCount);

            <div class="form-sections-container">
                @foreach (var sectionGroup in orderedSections)
                {
                    var isFilterSectionHorizontal = IsFilterSection(sectionGroup.Key);
                    <div class="form-section-column @sectionColClass">
                        <div class="form-section-header @(isFilterSectionHorizontal ? "form-section-header-filter" : "")">
                            @if (isFilterSectionHorizontal)
                            {
                                <i class="bi bi-funnel-fill form-section-filter-icon"></i>
                            }
                            <span class="form-section-title @(isFilterSectionHorizontal ? "form-section-title-filter" : "")">@(sectionGroup.Key)</span>
                        </div>
                        <div class="form-section-fields">
                            @foreach (var fieldKvp in sectionGroup)
                            {
                                var field = FieldDefinitions?.FirstOrDefault(f => f.PropertyName == fieldKvp.Key);
                                if (field != null)
                                {
                                    @RenderFieldMarkup(field)
                                }
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            @* ===== 無區段時的單欄佈局 ===== *@
            <div class="form-sections-container">
                <div class="form-section-column section-col-full">
                    <div class="form-section-fields">
                        @if (FieldDefinitions != null)
                        {
                            @foreach (var field in FieldDefinitions)
                            {
                                @RenderFieldMarkup(field)
                            }
                        }
                    </div>
                </div>
            </div>
        }
    </EditForm>
</div>

@code
{
    /// <summary>
    /// 判斷是否為篩選條件區段（用於套用不同視覺樣式）
    /// </summary>
    private static bool IsFilterSection(string sectionName) =>
        sectionName == ERPCore2.Helpers.EditModal.FormSectionNames.FilterConditions;

    /// <summary>
    /// 根據區段數量取得對應的 CSS 類別
    /// </summary>
    private string GetSectionColumnClass(int sectionCount)
    {
        return sectionCount switch
        {
            1 => "section-col-full",
            2 => "section-col-half",
            _ => "section-col-third"  // 3個以上時，每列最多3個，超過自動換行
        };
    }

    /// <summary>
    /// 渲染欄位標記的輔助方法 - 新版：Label 與 Input 同行
    /// </summary>
    private RenderFragment RenderFieldMarkup(FormFieldDefinition field) => __builder =>
    {
        // 如果欄位設定為不可見，則不渲染
        if (!field.IsVisible)
        {
            return;
        }
        
        var hasActionButtons = field.ActionButtons != null && field.ActionButtons.Any();
        var isCheckbox = field.FieldType == FormFieldType.Checkbox;
        
        <div class="form-field-row @(isCheckbox ? "form-field-row-checkbox" : "")">
            @* 所有欄位類型統一由此處渲染 Label *@
            @{ var labelText = field.LabelFactory?.Invoke() ?? field.Label; }
            @if (!string.IsNullOrEmpty(labelText))
            {
                <label class="form-field-label" for="@field.PropertyName" title="@field.HelpText">
                    @labelText
                    @if (field.IsRequired)
                    {
                        <span class="text-danger">*</span>
                    }
                    @if (field.LabelHelpItems?.Any() == true)
                    {
                        <button type="button" 
                                class="btn btn-link p-0 ms-1 align-baseline label-help-btn"
                                style="font-size: 0.85em; line-height: 1;"
                                data-bs-toggle="popover"
                                data-bs-trigger="focus"
                                data-bs-placement="right"
                                data-bs-html="true"
                                data-bs-content="@GetLabelHelpContent(field.LabelHelpItems)"
                                title="點擊查看說明">
                            <i class="bi bi-question-circle text-secondary"></i>
                        </button>
                    }
                </label>
            }
            
            <div class="form-field-input">
                @if (hasActionButtons && ShouldWrapWithActionButtons(field.FieldType))
                {
                    var multipleButtonsClass = field.ActionButtons?.Count > 1 ? FormConstants.CssClasses.MultipleButtons : "";
                    <div class="@FormConstants.CssClasses.PositionRelative @FormConstants.CssClasses.InputWithActionButtons @multipleButtonsClass">
                        @RenderInputField(field, hasActionButtons)
                        
                        @* 在 Input 右側渲染圖示按鈕 *@
                        <div class="input-action-buttons-container">
                            @foreach (var actionButton in field.ActionButtons!)
                            {
                                <button type="button"
                                        class="btn input-action-button"
                                        title="@(actionButton.Title ?? actionButton.Text)"
                                        disabled="@actionButton.IsDisabled"
                                        @onclick="@(actionButton.OnClick ?? (() => Task.CompletedTask))">
                                    <i class="@FormConstants.GetIconForButtonText(actionButton.Text)"></i>
                                </button>
                            }
                        </div>
                    </div>
                }
                else
                {
                    @RenderInputField(field, hasActionButtons)
                }
            </div>
        </div>
    };

    /// <summary>
    /// 渲染輸入欄位 - 使用子組件
    /// </summary>
    private RenderFragment RenderInputField(FormFieldDefinition field, bool hasActionButtons) => __builder =>
    {
        var cssClass = GetInputCssClass(field);
        
        @switch (field.FieldType)
        {
            case FormFieldType.Text:
            case FormFieldType.Email:
            case FormFieldType.Password:
                <FormTextField Field="@field"
                               Value="@GetPropertyValue(Model, field.PropertyName)?.ToString()"
                               ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))"
                               HasActionButtons="@hasActionButtons"
                               CssClass="@cssClass" />
                break;
            
            case FormFieldType.MobilePhone:
                <FormMobilePhoneField Field="@field"
                                      Value="@GetPropertyValue(Model, field.PropertyName)?.ToString()"
                                      ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))"
                                      HasActionButtons="@hasActionButtons"
                                      CssClass="@cssClass" />
                break;
                
            case FormFieldType.Number:
                <FormNumberField Field="@field"
                                 Value="@GetPropertyValue(Model, field.PropertyName)"
                                 ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))"
                                 HasActionButtons="@hasActionButtons"
                                 CssClass="@cssClass" />
                break;
                
            case FormFieldType.Date:
            case FormFieldType.DateTime:
                var dateValue = GetPropertyValue(Model, field.PropertyName);
                <FormDateField Field="@field"
                               Value="@(dateValue is DateTime dt ? dt : null)"
                               ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))"
                               HasActionButtons="@hasActionButtons"
                               CssClass="@cssClass" />
                break;
                
            case FormFieldType.TextArea:
                <FormTextAreaField Field="@field"
                                   Value="@GetPropertyValue(Model, field.PropertyName)?.ToString()"
                                   ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))"
                                   CssClass="@cssClass" />
                break;
                
            case FormFieldType.TextAreaWithCharacterCount:
                <CharacterCountTextAreaComponent 
                    Value="@GetPropertyValue(Model, field.PropertyName)?.ToString()"
                    ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))"
                    Id="@field.PropertyName"
                    CssClass="@cssClass"
                    Placeholder="@field.Placeholder"
                    HelpText="@field.HelpText"
                    IsReadOnly="@field.IsReadOnly"
                    IsDisabled="@field.IsDisabled"
                    Rows="@(field.Rows ?? FormConstants.Defaults.TextAreaRows)"
                    MaxCharacters="@(field.MaxLength ?? FormConstants.Defaults.MaxCharacters)"
                    MaxBytes="@(field.MaxBytes ?? FormConstants.Defaults.MaxBytes)" />
                break;
                
            case FormFieldType.Select:
                <FormSelectField Field="@field"
                                 Value="@GetPropertyValue(Model, field.PropertyName)"
                                 ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))"
                                 HasActionButtons="@hasActionButtons"
                                 CssClass="@cssClass" />
                break;
                
            case FormFieldType.Checkbox:
                var checkboxValue = GetPropertyValue(Model, field.PropertyName);
                <FormCheckboxField Field="@field"
                                   Value="@(checkboxValue is bool b && b)"
                                   ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))" />
                break;
                
            case FormFieldType.Radio:
                <FormRadioField Field="@field"
                                Value="@GetPropertyValue(Model, field.PropertyName)?.ToString()"
                                ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))" />
                break;
                
            case FormFieldType.AutoComplete:
                <FormAutoCompleteField Field="@field"
                                       Value="@GetPropertyValue(Model, field.PropertyName)?.ToString()"
                                       ValueChanged="@(value => HandleAutoCompleteFieldChanged(field.PropertyName, value))"
                                       InitialDisplayValue="@GetAutoCompleteDisplayValue(field.PropertyName)"
                                       HasActionButtons="@hasActionButtons"
                                       CssClass="@cssClass" />
                break;
                
            default:
                <FormTextField Field="@field"
                               Value="@GetPropertyValue(Model, field.PropertyName)?.ToString()"
                               ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))"
                               HasActionButtons="@hasActionButtons"
                               CssClass="@cssClass" />
                break;
        }
    };

    /// <summary>
    /// 處理欄位變更
    /// </summary>
    private void HandleFieldChanged(string propertyName, object? value)
    {
        SetPropertyValue(Model, propertyName, value);
    }

    /// <summary>
    /// 處理 AutoComplete 欄位變更
    /// 關鍵修復：當值被清除時，同步清除父組件的 DisplayValue 狀態
    /// 這確保了 InitialDisplayValue 參數會傳遞正確的空值給子組件
    /// </summary>
    private void HandleAutoCompleteFieldChanged(string propertyName, string? value)
    {
        SetPropertyValue(Model, propertyName, value);
        
        // 關鍵修復：當值被清除時，同步清除 AutoComplete 狀態的 DisplayValue
        // 這確保了下次渲染時 InitialDisplayValue 會是空字串
        if (string.IsNullOrEmpty(value) || value == "0")
        {
            var state = _autoCompleteStates.GetOrCreate(propertyName);
            state.DisplayValue = string.Empty;
        }
    }

    /// <summary>
    /// 產生標籤問號說明的 HTML 內容
    /// </summary>
    private string GetLabelHelpContent(List<LabelHelpItem> helpItems)
    {
        if (helpItems == null || !helpItems.Any())
            return string.Empty;

        var sb = new System.Text.StringBuilder();
        sb.Append("<div class='label-help-popover'>");
        
        foreach (var item in helpItems)
        {
            sb.Append("<div class='help-item mb-2'>");
            sb.Append($"<strong class='text-primary'>{System.Net.WebUtility.HtmlEncode(item.Title)}</strong>");
            sb.Append($"<div class='text-muted small'>{System.Net.WebUtility.HtmlEncode(item.Description)}</div>");
            sb.Append("</div>");
        }
        
        sb.Append("</div>");
        return sb.ToString();
    }
}
