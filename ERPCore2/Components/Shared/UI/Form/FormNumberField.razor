@* 數字欄位子組件 *@
@using ERPCore2.Components.Shared.UI.Form
@inject IJSRuntime JSRuntime

@if (Field.IsReadOnly)
{
    @* 唯讀模式：顯示格式化的值（帶千分位） *@
    <input type="text"
           class="@InputCssClass"
           id="@Field.PropertyName"
           name="@($"{Field.PropertyName}_{Guid.NewGuid().ToString("N").Substring(0, 8)}")"
           readonly
           tabindex="-1"
           value="@FormattedDisplayValue" />
}
else if (Field.UseThousandsSeparator)
{
    @* 可編輯模式 + 千分位：使用 text input 搭配格式化顯示 *@
    <input type="text"
           inputmode="decimal"
           class="@InputCssClass"
           id="@_fieldId"
           name="@($"{Field.PropertyName}_{Guid.NewGuid().ToString("N").Substring(0, 8)}")"
           placeholder="@Field.Placeholder"
           disabled="@Field.IsDisabled"
           autocomplete="@FormConstants.AutoCompleteAttributes.Off"
           required="@Field.IsRequired"
           value="@(_isFormattedFocused ? FormattedInputValue : FormattedDisplayValue)"
           @onchange="HandleFormattedChange"
           @oninput="HandleInputEvent"
           @onfocus="HandleFormattedFocus"
           @onblur="HandleFormattedBlur" />
}
else
{
    @* 一般可編輯模式 *@
    <input type="number"
           class="@InputCssClass"
           id="@_fieldId"
           name="@($"{Field.PropertyName}_{Guid.NewGuid().ToString("N").Substring(0, 8)}")"
           placeholder="@Field.Placeholder"
           disabled="@Field.IsDisabled"
           autocomplete="@FormConstants.AutoCompleteAttributes.Off"
           required="@Field.IsRequired"
           min="@Field.Min"
           max="@Field.Max"
           step="@Field.Step"
           value="@FormattedInputValue"
           @onchange="HandleChange"
           @oninput="HandleInputEvent"
           @onfocus="InitRangeLimit" />
}

@code {
    [Parameter, EditorRequired]
    public FormFieldDefinition Field { get; set; } = default!;

    [Parameter]
    public object? Value { get; set; }

    [Parameter]
    public EventCallback<object?> ValueChanged { get; set; }

    [Parameter]
    public bool HasActionButtons { get; set; }

    [Parameter]
    public string CssClass { get; set; } = FormConstants.CssClasses.FormControl;

    private string _fieldId = string.Empty;
    private bool _isInitialized = false;
    private bool _isFormattedFocused = false;

    private string InputCssClass => HasActionButtons 
        ? $"{CssClass} {FormConstants.CssClasses.HasActionButtons}" 
        : CssClass;

    private string FormattedDisplayValue => FormatForDisplay(Value);

    private string FormattedInputValue => FormatForInput(Value);

    protected override void OnInitialized()
    {
        _fieldId = $"number_{Field.PropertyName}_{Guid.NewGuid().ToString("N").Substring(0, 8)}";
    }

    private string FormatForInput(object? value)
    {
        if (value == null) return string.Empty;

        if (decimal.TryParse(value.ToString(), out decimal decimalValue))
        {
            return NumberFormatHelper.FormatForInput(decimalValue);
        }

        return value.ToString() ?? string.Empty;
    }

    private string FormatForDisplay(object? value)
    {
        if (value == null) return string.Empty;

        if (decimal.TryParse(value.ToString(), out decimal decimalValue))
        {
            return NumberFormatHelper.FormatSmart(decimalValue, Field.DecimalPlaces, Field.UseThousandsSeparator);
        }

        return value.ToString() ?? string.Empty;
    }

    private async Task HandleChange(ChangeEventArgs e)
    {
        var stringValue = e.Value?.ToString();

        if (string.IsNullOrWhiteSpace(stringValue))
        {
            await ValueChanged.InvokeAsync(null);
            return;
        }

        if (decimal.TryParse(stringValue, out decimal numericValue))
        {
            // 範圍驗證
            if (Field.Min.HasValue && numericValue < Field.Min.Value)
                numericValue = Field.Min.Value;
            if (Field.Max.HasValue && numericValue > Field.Max.Value)
                numericValue = Field.Max.Value;

            await ValueChanged.InvokeAsync(numericValue);
        }
        else
        {
            await ValueChanged.InvokeAsync(null);
        }
    }

    /// <summary>
    /// oninput 即時更新 - 僅在 BindOnInput = true 時生效，不做範圍驗證以免干擾輸入過程
    /// </summary>
    private async Task HandleInputEvent(ChangeEventArgs e)
    {
        if (!Field.BindOnInput) return;

        var stringValue = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(stringValue)) return;

        // 去除千分位分隔符（適用於千分位模式）
        var cleanValue = stringValue.Replace(",", "");
        if (decimal.TryParse(cleanValue, out decimal numericValue))
        {
            await ValueChanged.InvokeAsync(numericValue);
        }
    }

    private async Task InitRangeLimit()
    {
        if (_isInitialized) return;

        try
        {
            if (Field.Min.HasValue || Field.Max.HasValue)
            {
                await JSRuntime.InvokeVoidAsync("NumberInputHelper.initRangeLimitById",
                    _fieldId,
                    Field.Min.HasValue ? (object)(double)Field.Min.Value : null,
                    Field.Max.HasValue ? (object)(double)Field.Max.Value : null);

                _isInitialized = true;
            }
        }
        catch
        {
            // 靜默處理 JS 互操作錯誤
        }
    }

    /// <summary>
    /// 千分位格式化輸入 - 取得焦點時切換為原始數值
    /// </summary>
    private void HandleFormattedFocus()
    {
        _isFormattedFocused = true;
    }

    /// <summary>
    /// 千分位格式化輸入 - 失去焦點時顯示千分位格式
    /// </summary>
    private void HandleFormattedBlur()
    {
        _isFormattedFocused = false;
    }

    /// <summary>
    /// 千分位格式化輸入 - 處理值變更（需去除千分位分隔符後解析）
    /// </summary>
    private async Task HandleFormattedChange(ChangeEventArgs e)
    {
        var stringValue = e.Value?.ToString();

        if (string.IsNullOrWhiteSpace(stringValue))
        {
            await ValueChanged.InvokeAsync(null);
            return;
        }

        // 去除千分位分隔符後解析
        var cleanValue = stringValue.Replace(",", "");
        if (decimal.TryParse(cleanValue, out decimal numericValue))
        {
            // 範圍驗證
            if (Field.Min.HasValue && numericValue < Field.Min.Value)
                numericValue = Field.Min.Value;
            if (Field.Max.HasValue && numericValue > Field.Max.Value)
                numericValue = Field.Max.Value;

            await ValueChanged.InvokeAsync(numericValue);
        }
        else
        {
            await ValueChanged.InvokeAsync(null);
        }
    }
}
