@* 下拉選單項目元件 *@
@using ERPCore2.Components.Shared.UI.Auth
@using ERPCore2.Services
@using ERPCore2.Models
@using Microsoft.JSInterop
@inject INavigationPermissionCollector PermissionCollector
@inject IJSRuntime JSRuntime
@inject ILogger<NavDropdownItem> Logger

@if (IsDivider)
{
    <div class="dropdown-divider"></div>
}
else if (ItemType == NavigationItemType.Action)
{
    <button type="button" class="nav-dropdown-item dropdown-item btn-link @(string.IsNullOrEmpty(IconClass) ? "no-icon" : "")" @onclick="HandleActionClickAsync">
        @if (!string.IsNullOrEmpty(IconClass))
        {
            <span class="@IconClass nav-dropdown-bi" aria-hidden="true"></span>
        }
        @Text
    </button>
}
else if (ForceLoad)
{
    @* ForceLoad 使用 button 而非 <a>，避免 Blazor 攔截連結點擊觸發 RemoteNavigationManager *@
    @* 造成頁面卸載時 JS Interop 回呼未完成的 TaskCanceledException *@
    <button type="button" class="nav-dropdown-item dropdown-item btn-link @(string.IsNullOrEmpty(IconClass) ? "no-icon" : "")"
            @onclick="HandleForcedLoadClickAsync">
        @if (!string.IsNullOrEmpty(IconClass))
        {
            <span class="@IconClass nav-dropdown-bi" aria-hidden="true"></span>
        }
        @Text
    </button>
}
else
{
    <a class="nav-dropdown-item dropdown-item @(string.IsNullOrEmpty(IconClass) ? "no-icon" : "")" href="@Url" @onclick="OnDropdownItemClick">
        @if (!string.IsNullOrEmpty(IconClass))
        {
            <span class="@IconClass nav-dropdown-bi" aria-hidden="true"></span>
        }
        @Text
    </a>
}


@code {
    /// <summary>
    /// NavMenu 實例（透過 CascadingParameter 注入）
    /// </summary>
    [CascadingParameter(Name = "NavMenuInstance")]
    public ERPCore2.Components.Layout.NavMenu? NavMenuInstance { get; set; }
    
    /// <summary>
    /// 是否為分隔線
    /// </summary>
    [Parameter] public bool IsDivider { get; set; } = false;
    
    /// <summary>
    /// 下拉選單項目顯示的文字
    /// </summary>
    [Parameter] public string Text { get; set; } = "";

    /// <summary>
    /// 圖示的 CSS 類別（例如 "bi bi-person-lines-fill"）
    /// </summary>
    [Parameter] public string IconClass { get; set; } = "";

    /// <summary>
    /// 連結的 URL（當 ItemType 為 Route 時使用）
    /// </summary>
    [Parameter] public string Url { get; set; } = "";
    
    /// <summary>
    /// 導航項目類型
    /// </summary>
    [Parameter] public NavigationItemType ItemType { get; set; } = NavigationItemType.Route;
    
    /// <summary>
    /// 動作識別碼（當 ItemType 為 Action 時使用）
    /// </summary>
    [Parameter] public string? ActionId { get; set; }

    /// <summary>
    /// 強制完整頁面載入（用於非 Blazor 路由，如 /auth/signout）
    /// </summary>
    [Parameter] public bool ForceLoad { get; set; } = false;

    /// <summary>
    /// 此菜單項目需要的權限（可選）
    /// </summary>
    [Parameter] public string? RequiredPermission { get; set; }

    /// <summary>
    /// 父菜單識別鍵，用於權限收集
    /// </summary>
    [Parameter] public string? ParentMenuKey { get; set; }

    protected override void OnInitialized()
    {        
        // 在組件初始化時就註冊權限，確保父組件能及時收集到
        RegisterPermission();
    }

    protected override void OnParametersSet()
    {        
        // 參數變更時重新註冊權限
        RegisterPermission();
    }

    private void RegisterPermission()
    {
        // 如果是分隔線，不需要註冊權限
        if (IsDivider)
        {
            return;
        }
        
        // 如果有權限要求且有父菜單鍵,註冊到權限收集器
        if (!string.IsNullOrEmpty(RequiredPermission) && !string.IsNullOrEmpty(ParentMenuKey))
        {
            PermissionCollector.RegisterPermission(ParentMenuKey, RequiredPermission);
        }
        else if (!string.IsNullOrEmpty(RequiredPermission) || !string.IsNullOrEmpty(ParentMenuKey))
        {
            // 只有在部分設定的情況下才警告(表示可能是遺漏了某個參數)
        }
        // 如果兩者都沒設定,則視為不需要權限控制的項目,不發出警告
    }

    /// <summary>
    /// 處理下拉選單項目點擊事件
    /// </summary>
    private void OnDropdownItemClick()
    {
        // 這裡可以添加任何需要的邏輯
        // JavaScript 會自動處理手機模式下的選單隱藏
    }

    /// <summary>
    /// 處理 ForceLoad 連結的點擊事件
    /// 使用 JS location.assign 直接導航，繞過 Blazor 的導航攔截機制
    /// 並捕捉頁面卸載時預期的 TaskCanceledException / JSDisconnectedException
    /// </summary>
    private async Task HandleForcedLoadClickAsync()
    {
        if (!string.IsNullOrEmpty(Url))
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("location.assign", Url);
            }
            catch (TaskCanceledException)
            {
                // 預期：頁面正在卸載，電路斷開前 JS 回呼尚未返回
            }
            catch (JSDisconnectedException)
            {
                // 預期：SignalR 電路已斷開
            }
        }
    }
    
    /// <summary>
    /// 處理 Action 型項目的點擊事件
    /// </summary>
    private async Task HandleActionClickAsync()
    {
        if (string.IsNullOrEmpty(ActionId))
        {
            return;
        }
        
        try
        {
            // 透過 NavMenu 觸發動作
            if (NavMenuInstance != null)
            {
                await NavMenuInstance.TriggerActionAsync(ActionId);
            }
            else
            {
            }
        }
        catch
        {
        }
    }
}
