<button class="@GetFullButtonClass()" 
        type="@(IsSubmit ? "submit" : Type)"
        title="@(string.IsNullOrEmpty(Title) ? Text : Title)"
        disabled="@IsDisabled"
        @onclick="HandleClick"
        @onclick:stopPropagation="StopPropagation"
        @attributes="AdditionalAttributes">
    @if (!string.IsNullOrEmpty(IconClass))
    {
        <i class="@IconClass @(string.IsNullOrEmpty(Text) ? "" : "me-2")"></i>
    }
    @if (IsLoading)
    {
        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
    }
    @Text
    @ChildContent
</button>

@code {
    /// <summary>
    /// 按鈕顯示文字 - 主要參數
    /// </summary>
    [Parameter] public string Text { get; set; } = string.Empty;
    
    /// <summary>
    /// 按鈕類型 - 主要參數，決定按鈕的顏色和樣式
    /// </summary>
    [Parameter] public ButtonVariant Variant { get; set; } = ButtonVariant.DarkBlue;
    
    /// <summary>
    /// 按鈕尺寸
    /// </summary>
    [Parameter] public ButtonSize Size { get; set; } = ButtonSize.Normal;
    
    /// <summary>
    /// 點擊事件處理
    /// </summary>
    [Parameter] public EventCallback OnClick { get; set; }
    
    /// <summary>
    /// 自定義CSS類別
    /// </summary>
    [Parameter] public string CssClass { get; set; } = string.Empty;
    
    /// <summary>
    /// 按鈕標題提示
    /// </summary>
    [Parameter] public string Title { get; set; } = string.Empty;
    
    /// <summary>
    /// 按鈕HTML類型
    /// </summary>
    [Parameter] public string Type { get; set; } = "button";
    
    /// <summary>
    /// 是否禁用
    /// </summary>
    [Parameter] public bool IsDisabled { get; set; } = false;
    
    /// <summary>
    /// 是否顯示載入狀態
    /// </summary>
    [Parameter] public bool IsLoading { get; set; } = false;
    
    /// <summary>
    /// 是否為提交按鈕
    /// </summary>
    [Parameter] public bool IsSubmit { get; set; } = false;
    
    /// <summary>
    /// 圖示CSS類別
    /// </summary>
    [Parameter] public string IconClass { get; set; } = string.Empty;
    
    /// <summary>
    /// 是否阻止事件冒泡
    /// </summary>
    [Parameter] public bool StopPropagation { get; set; } = false;
    
    /// <summary>
    /// 子內容
    /// </summary>
    [Parameter] public RenderFragment? ChildContent { get; set; }
    
    /// <summary>
    /// 其他HTML屬性
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)] 
    public Dictionary<string, object>? AdditionalAttributes { get; set; }    
    private async Task HandleClick()
    {        
        if (IsDisabled || IsLoading)
            return;
            
        try
        {
            if (OnClick.HasDelegate)
            {
                await OnClick.InvokeAsync();
            }
        }
        catch (Exception)
        {
            // 在生產環境中，這裡應該使用適當的日誌記錄
        }
    }
    
    /// <summary>
    /// 取得完整的按鈕 CSS 類別，處理特殊情況（如 btn-close）
    /// </summary>
    private string GetFullButtonClass()
    {
        var classes = new List<string>();
        
        // 特殊處理：如果 CssClass 包含 "btn-close"，則不添加 "btn" 和其他變體類別
        if (!string.IsNullOrEmpty(CssClass) && CssClass.Contains("btn-close"))
        {
            // btn-close 是獨立的按鈕樣式，不需要其他類別
            classes.Add("btn-close");
            // 添加白色變體（用於深色背景）
            classes.Add("btn-close-white");
            return string.Join(" ", classes);
        }
        
        // 一般按鈕需要基礎 btn 類別
        classes.Add("btn");
        
        // 添加變體樣式
        classes.Add(GetVariantClass());
        
        // 添加尺寸樣式
        var sizeClass = GetSizeClass();
        if (!string.IsNullOrEmpty(sizeClass))
        {
            classes.Add(sizeClass);
        }
        
        // 添加自定義 CSS 類別（排除 btn-close，因為已在上面處理）
        if (!string.IsNullOrEmpty(CssClass) && !CssClass.Contains("btn-close"))
        {
            classes.Add(CssClass);
        }
        
        return string.Join(" ", classes);
    }
    
    /// <summary>
    /// 取得按鈕變體的 CSS 類別
    /// </summary>
    private string GetVariantClass()
    {
        return Variant switch
        {
            ButtonVariant.DarkBlue => "btn-primary",
            ButtonVariant.Gray => "btn-secondary",
            ButtonVariant.Green => "btn-success",
            ButtonVariant.Yellow => "btn-warning",
            ButtonVariant.Red => "btn-danger",
            ButtonVariant.Blue => "btn-info",
            ButtonVariant.OutlineDarkBlue => "btn-outline-primary",
            ButtonVariant.OutlineGray => "btn-outline-secondary",
            ButtonVariant.OutlineGreen => "btn-outline-success",
            ButtonVariant.OutlineYellow => "btn-outline-warning",
            ButtonVariant.OutlineRed => "btn-outline-danger",
            ButtonVariant.OutlineBlue => "btn-outline-info",
            ButtonVariant.Cyan => "btn-cyan",
            ButtonVariant.Purple => "btn-purple",
            ButtonVariant.Pink => "btn-pink",
            ButtonVariant.Orange => "btn-orange",
            ButtonVariant.Black => "btn-black",
            ButtonVariant.White => "btn-white",
            ButtonVariant.OutlineCyan => "btn-outline-cyan",
            ButtonVariant.OutlinePurple => "btn-outline-purple",
            ButtonVariant.OutlinePink => "btn-outline-pink",
            ButtonVariant.OutlineOrange => "btn-outline-orange",
            ButtonVariant.OutlineBlack => "btn-outline-black",
            ButtonVariant.OutlineWhite => "btn-outline-white",
            _ => "btn-primary"
        };
    }
    
    /// <summary>
    /// 取得按鈕尺寸的 CSS 類別
    /// </summary>
    private string GetSizeClass()
    {
        return Size switch
        {
            ButtonSize.Small => "btn-sm",
            ButtonSize.Large => "btn-lg",
            ButtonSize.Normal => string.Empty,
            _ => string.Empty
        };
    }
}
