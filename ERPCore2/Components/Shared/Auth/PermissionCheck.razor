@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inherits ComponentBase
@inject IServiceProvider ServiceProvider

@if (isAuthorized)
{
    @ChildContent
}
else if (!string.IsNullOrEmpty(UnauthorizedContent))
{
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        @UnauthorizedContent
    </div>
}

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public string? Permission { get; set; }
    [Parameter] public string? Role { get; set; }
    [Parameter] public string UnauthorizedContent { get; set; } = "æ‚¨æ²’æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œ";
    [Parameter] public int? EmployeeId { get; set; } // æ–°å¢ EmployeeId åƒæ•¸ç”¨æ–¼æ¸¬è©¦
    
    [CascadingParameter] private Task<AuthenticationState>? AuthenticationState { get; set; }
    
    private bool isAuthorized = false;    protected override async Task OnParametersSetAsync()
    {
        Console.WriteLine($"ğŸ” PermissionCheck é–‹å§‹æª¢æŸ¥ï¼Œæ¬Šé™: '{Permission}', è§’è‰²: '{Role}', å“¡å·¥ID: {EmployeeId}");
        
        // å¦‚æœæœ‰æä¾› EmployeeId åƒæ•¸ï¼Œç›´æ¥ä½¿ç”¨å®ƒé€²è¡Œæ¬Šé™æª¢æŸ¥ï¼ˆæ¸¬è©¦æ¨¡å¼ï¼‰
        if (EmployeeId.HasValue && !string.IsNullOrEmpty(Permission))
        {
            Console.WriteLine($"ğŸ§ª æ¸¬è©¦æ¨¡å¼ï¼šä½¿ç”¨æŒ‡å®šçš„å“¡å·¥ID ({EmployeeId}) æª¢æŸ¥æ¬Šé™");
            try
            {
                using var scope = ServiceProvider.CreateScope();
                var permissionService = scope.ServiceProvider.GetService<ERPCore2.Services.IPermissionService>();
                
                if (permissionService != null)
                {
                    Console.WriteLine("âœ… PermissionService æ³¨å…¥æˆåŠŸ");
                    var result = await permissionService.HasPermissionAsync(EmployeeId.Value, Permission);
                    isAuthorized = result.IsSuccess && result.Data;
                    Console.WriteLine($"ğŸ” æ¬Šé™æª¢æŸ¥çµæœ: IsSuccess={result.IsSuccess}, Data={result.Data}, isAuthorized={isAuthorized}");
                    if (!result.IsSuccess)
                    {
                        Console.WriteLine($"âŒ æ¬Šé™æª¢æŸ¥éŒ¯èª¤: {result.ErrorMessage}");
                    }
                }
                else
                {
                    Console.WriteLine("âŒ PermissionService æ³¨å…¥å¤±æ•—");
                    isAuthorized = false;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ğŸ’¥ æ¬Šé™æª¢æŸ¥ä¾‹å¤–: {ex.Message}");
                isAuthorized = false;
            }
            return;
        }
        
        // åŸæœ¬çš„èªè­‰é‚è¼¯
        if (AuthenticationState is null)
        {
            Console.WriteLine("âŒ AuthenticationState ç‚º null");
            isAuthorized = false;
            return;
        }

        var authState = await AuthenticationState;
        var user = authState.User;

        Console.WriteLine($"ğŸ” ä½¿ç”¨è€…èªè­‰ç‹€æ…‹: {user.Identity?.IsAuthenticated}");
        Console.WriteLine($"ğŸ” ä½¿ç”¨è€…åç¨±: {user.Identity?.Name}");

        if (!user.Identity?.IsAuthenticated ?? true)
        {
            Console.WriteLine("âŒ ä½¿ç”¨è€…æœªèªè­‰");
            isAuthorized = false;
            return;
        }

        // æª¢æŸ¥è§’è‰²æ¬Šé™
        if (!string.IsNullOrEmpty(Role))
        {
            isAuthorized = user.IsInRole(Role);
            Console.WriteLine($"ğŸ” è§’è‰²æª¢æŸ¥ '{Role}': {isAuthorized}");
            return;
        }

        // æª¢æŸ¥ç‰¹å®šæ¬Šé™
        if (!string.IsNullOrEmpty(Permission))
        {
            Console.WriteLine($"ğŸ” é–‹å§‹æª¢æŸ¥ç‰¹å®šæ¬Šé™: '{Permission}'");
            try
            {
                using var scope = ServiceProvider.CreateScope();
                var permissionService = scope.ServiceProvider.GetService<ERPCore2.Services.IPermissionService>();
                
                if (permissionService != null)
                {
                    Console.WriteLine("âœ… PermissionService æ³¨å…¥æˆåŠŸ");
                    var employeeIdClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                    Console.WriteLine($"ğŸ” å“¡å·¥ID Claim: '{employeeIdClaim}'");
                    
                    if (int.TryParse(employeeIdClaim, out int employeeId))
                    {
                        Console.WriteLine($"ğŸ” è§£æå“¡å·¥ID: {employeeId}");
                        
                        // å„ªå…ˆæª¢æŸ¥æ˜¯å¦æœ‰ System.Admin æ¬Šé™
                        var adminResult = await permissionService.HasPermissionAsync(employeeId, "System.Admin");
                        if (adminResult.IsSuccess && adminResult.Data)
                        {
                            Console.WriteLine("âœ… ä½¿ç”¨è€…å…·æœ‰ System.Admin æ¬Šé™ï¼Œå…è¨±å­˜å–");
                            isAuthorized = true;
                            return;
                        }
                        
                        // æª¢æŸ¥æŒ‡å®šçš„æ¬Šé™
                        var result = await permissionService.HasPermissionAsync(employeeId, Permission);
                        isAuthorized = result.IsSuccess && result.Data;
                        Console.WriteLine($"ğŸ” æ¬Šé™æª¢æŸ¥çµæœ: IsSuccess={result.IsSuccess}, Data={result.Data}, isAuthorized={isAuthorized}");
                        if (!result.IsSuccess)
                        {
                            Console.WriteLine($"âŒ æ¬Šé™æª¢æŸ¥éŒ¯èª¤: {result.ErrorMessage}");
                        }
                    }
                    else
                    {
                        Console.WriteLine("âŒ ç„¡æ³•è§£æå“¡å·¥ID");
                    }
                }
                else
                {
                    Console.WriteLine("âŒ PermissionService æ³¨å…¥å¤±æ•—");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ğŸ’¥ æ¬Šé™æª¢æŸ¥ä¾‹å¤–: {ex.Message}");
                isAuthorized = false;
            }
            return;
        }

        // å¦‚æœæ²’æœ‰ç‰¹å®šæ¬Šé™è¦æ±‚ï¼Œåªè¦å·²ç™»å…¥å°±å…è¨±
        Console.WriteLine("âœ… æ²’æœ‰ç‰¹å®šæ¬Šé™è¦æ±‚ï¼Œå…è¨±å­˜å–");
        isAuthorized = true;
    }
}
