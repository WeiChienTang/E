@* 通用搜尋篩選組件 - 使用標準 Blazor 語法 *@
@using Microsoft.AspNetCore.Components.Web
@using ERPCore2.Components.Shared.Forms
@typeparam TModel
@implements IDisposable

<div class="card mb-3">    
    <div class="card-header d-flex justify-content-between align-items-center">        
        <h6 class="card-title mb-0">
            條件
        </h6>        
        <div class="d-flex gap-2">            
            <GenericButtonComponent Variant="ButtonVariant.Red" 
                                    Text="清除" 
                                    OnClick="ClearAllFilters" 
                                    CssClass="search-clear-btn" />
        </div>
    </div>
    
    <div class="card-body">
        <div class="row g-1">
            @if (FilterDefinitions != null)
            {
                @foreach (var filter in FilterDefinitions)
                {
                    <div class="@(filter.ContainerCssClass ?? "col-md-2")">
                        @if (!string.IsNullOrEmpty(filter.Label) && filter.FilterType != SearchFilterType.Boolean)
                        {
                            <label class="form-label " for="@filter.PropertyName">@filter.Label</label>
                        }
                        
                        @switch (filter.FilterType)
                        {
                            case SearchFilterType.Text:
                                <input type="text" 
                                       class="form-control" 
                                       id="@filter.PropertyName"
                                       placeholder="@filter.Placeholder"
                                       value="@GetTextValue(filter.PropertyName)"
                                       @oninput="e => HandleTextInput(filter.PropertyName, e.Value?.ToString())" />
                                break;
                                
                            case SearchFilterType.Number:
                                <input type="number" 
                                       class="form-control" 
                                       id="@filter.PropertyName"
                                       placeholder="@filter.Placeholder"
                                       value="@GetNumberValue(filter.PropertyName)"
                                       @onchange="e => HandleNumberChange(filter.PropertyName, e.Value?.ToString())" />
                                break;
                                
                            case SearchFilterType.Date:
                                <input type="date" 
                                       class="form-control" 
                                       id="@filter.PropertyName"
                                       value="@GetDateValue(filter.PropertyName)"
                                       @onchange="e => HandleDateChange(filter.PropertyName, e.Value?.ToString())" />
                                break;
                                
                            case SearchFilterType.DateTime:
                                <input type="datetime-local" 
                                       class="form-control" 
                                       id="@filter.PropertyName"
                                       value="@GetDateTimeValue(filter.PropertyName)"
                                       @onchange="e => HandleDateTimeChange(filter.PropertyName, e.Value?.ToString())" />
                                break;
                                
                            case SearchFilterType.Select:
                                <select class="form-select" 
                                        id="@filter.PropertyName"
                                        value="@GetTextValue(filter.PropertyName)"
                                        @onchange="e => HandleSelectChange(filter.PropertyName, e.Value?.ToString())">
                                    <option value="">@(filter.EmptyOptionText ?? "全部")</option>
                                    @if (filter.Options != null)
                                    {
                                        @foreach (var option in filter.Options)
                                        {
                                            <option value="@option.Value">@option.Text</option>
                                        }
                                    }
                                </select>
                                break;
                                
                            case SearchFilterType.MultiSelect:
                                @if (filter.Options != null)
                                {
                                    var currentValues = GetMultiSelectValues(filter.PropertyName);
                                    @foreach (var option in filter.Options)
                                    {
                                        var isChecked = currentValues.Contains(option.Value);
                                        <div class="form-check">
                                            <input type="checkbox" 
                                                   class="form-check-input" 
                                                   id="@($"{filter.PropertyName}_{option.Value}")"
                                                   checked="@isChecked"
                                                   @onchange="e => HandleMultiSelectChange(filter.PropertyName, option.Value, e.Value)" />
                                            <label class="form-check-label" for="@($"{filter.PropertyName}_{option.Value}")">
                                                @option.Text
                                            </label>
                                        </div>
                                    }
                                }
                                break;
                                
                            case SearchFilterType.DateRange:
                                var dateRange = GetDateRange(filter.PropertyName);
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="date" 
                                               class="form-control" 
                                               placeholder="開始日期"
                                               value="@(dateRange.StartDate?.ToString("yyyy-MM-dd"))"
                                               @onchange="e => HandleDateRangeChange(filter.PropertyName, e.Value?.ToString(), true)" />
                                    </div>
                                    <div class="col-6">
                                        <input type="date" 
                                               class="form-control" 
                                               placeholder="結束日期"
                                               value="@(dateRange.EndDate?.ToString("yyyy-MM-dd"))"
                                               @onchange="e => HandleDateRangeChange(filter.PropertyName, e.Value?.ToString(), false)" />
                                    </div>
                                </div>
                                break;
                                
                            case SearchFilterType.DateTimeRange:
                                var dateTimeRange = GetDateTimeRange(filter.PropertyName);
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="datetime-local" 
                                               class="form-control" 
                                               placeholder="開始時間"
                                               value="@(dateTimeRange.StartDateTime?.ToString("yyyy-MM-ddTHH:mm"))"
                                               @onchange="e => HandleDateTimeRangeChange(filter.PropertyName, e.Value?.ToString(), true)" />
                                    </div>
                                    <div class="col-6">
                                        <input type="datetime-local" 
                                               class="form-control" 
                                               placeholder="結束時間"
                                               value="@(dateTimeRange.EndDateTime?.ToString("yyyy-MM-ddTHH:mm"))"
                                               @onchange="e => HandleDateTimeRangeChange(filter.PropertyName, e.Value?.ToString(), false)" />
                                    </div>
                                </div>
                                break;
                                
                            case SearchFilterType.NumberRange:
                                var numberRange = GetNumberRange(filter.PropertyName);
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="number" 
                                               class="form-control" 
                                               placeholder="最小值"
                                               value="@numberRange.Min"
                                               @onchange="e => HandleNumberRangeChange(filter.PropertyName, e.Value?.ToString(), true)" />
                                    </div>
                                    <div class="col-6">
                                        <input type="number" 
                                               class="form-control" 
                                               placeholder="最大值"
                                               value="@numberRange.Max"
                                               @onchange="e => HandleNumberRangeChange(filter.PropertyName, e.Value?.ToString(), false)" />
                                    </div>
                                </div>
                                break;
                                
                            case SearchFilterType.Boolean:
                                var boolValue = GetBoolValue(filter.PropertyName);
                                <div class="form-check">
                                    <input type="checkbox" 
                                           class="form-check-input" 
                                           id="@filter.PropertyName"
                                           checked="@boolValue"
                                           @onchange="e => HandleBoolChange(filter.PropertyName, e.Value)" />
                                    <label class="form-check-label" for="@filter.PropertyName">
                                        @filter.Label
                                    </label>
                                </div>
                                break;
                                
                            case SearchFilterType.Custom:
                                <div class="alert alert-info">
                                    自定義篩選類型需要在父組件中實作
                                </div>
                                break;
                                
                            case SearchFilterType.AutoComplete:
                                <input type="text" 
                                       class="form-control" 
                                       id="@filter.PropertyName"
                                       placeholder="@filter.Placeholder"
                                       list="@($"{filter.PropertyName}_datalist")"
                                       value="@GetTextValue(filter.PropertyName)"
                                       @oninput="e => HandleAutoCompleteInput(filter, e.Value?.ToString())" />
                                <datalist id="@($"{filter.PropertyName}_datalist")">
                                    @if (autoCompleteOptions.ContainsKey(filter.PropertyName))
                                    {
                                        @foreach (var option in autoCompleteOptions[filter.PropertyName])
                                        {
                                            <option value="@option.Value">@option.Text</option>
                                        }
                                    }
                                </datalist>
                                break;
                                
                            default:
                                <input type="text" 
                                       class="form-control" 
                                       id="@filter.PropertyName"
                                       placeholder="@filter.Placeholder"
                                       value="@GetTextValue(filter.PropertyName)"
                                       @oninput="e => HandleTextInput(filter.PropertyName, e.Value?.ToString())" />
                                break;
                        }
                    </div>
                }
            }        
        </div>
    </div>
</div>

@code {
    [Parameter] public List<SearchFilterDefinition>? FilterDefinitions { get; set; }
    [Parameter] public SearchFilterModel FilterModel { get; set; } = new();
    [Parameter] public EventCallback<SearchFilterModel> OnSearch { get; set; }
    [Parameter] public EventCallback<SearchFilterModel> OnFilterChanged { get; set; }
    [Parameter] public bool AutoSearch { get; set; } = true;
    [Parameter] public bool ShowSearchButton { get; set; } = false;
    [Parameter] public int SearchDelayMs { get; set; } = 300;

    private Timer? searchTimer;
    private readonly Dictionary<string, List<SelectOption>> autoCompleteOptions = new();
    private readonly Dictionary<string, Timer?> autoCompleteTimers = new();

    // 輔助方法：取得文字值
    private string GetTextValue(string propertyName)
    {
        return FilterModel.GetFilterValue(propertyName)?.ToString() ?? "";
    }

    // 輔助方法：取得數字值
    private string GetNumberValue(string propertyName)
    {
        var value = FilterModel.GetFilterValue(propertyName);
        return value?.ToString() ?? "";
    }

    // 輔助方法：取得日期值
    private string GetDateValue(string propertyName)
    {
        var value = FilterModel.GetFilterValue(propertyName);
        return value is DateTime dateValue ? dateValue.ToString("yyyy-MM-dd") : "";
    }

    // 輔助方法：取得日期時間值
    private string GetDateTimeValue(string propertyName)
    {
        var value = FilterModel.GetFilterValue(propertyName);
        return value is DateTime dateTimeValue ? dateTimeValue.ToString("yyyy-MM-ddTHH:mm") : "";
    }

    // 輔助方法：取得多選值
    private List<string> GetMultiSelectValues(string propertyName)
    {
        return FilterModel.GetFilterValue(propertyName) as List<string> ?? new List<string>();
    }

    // 輔助方法：取得日期範圍
    private DateRange GetDateRange(string propertyName)
    {
        return FilterModel.GetFilterValue(propertyName) as DateRange ?? new DateRange();
    }

    // 輔助方法：取得日期時間範圍
    private DateTimeRange GetDateTimeRange(string propertyName)
    {
        return FilterModel.GetFilterValue(propertyName) as DateTimeRange ?? new DateTimeRange();
    }

    // 輔助方法：取得數字範圍
    private NumberRange GetNumberRange(string propertyName)
    {
        return FilterModel.GetFilterValue(propertyName) as NumberRange ?? new NumberRange();
    }

    // 輔助方法：取得布林值
    private bool GetBoolValue(string propertyName)
    {
        var value = FilterModel.GetFilterValue(propertyName);
        return value is bool boolValue && boolValue;
    }

    // 事件處理：文字輸入
    private void HandleTextInput(string propertyName, string? value)
    {
        FilterModel.SetFilterValue(propertyName, value);
        _ = HandleFilterChanged();
    }

    // 事件處理：數字變更
    private void HandleNumberChange(string propertyName, string? value)
    {
        if (decimal.TryParse(value, out var num))
        {
            FilterModel.SetFilterValue(propertyName, num);
        }
        else
        {
            FilterModel.SetFilterValue(propertyName, null);
        }
        _ = HandleFilterChanged();
    }

    // 事件處理：日期變更
    private void HandleDateChange(string propertyName, string? value)
    {
        if (DateTime.TryParse(value, out var date))
        {
            FilterModel.SetFilterValue(propertyName, date);
        }
        else
        {
            FilterModel.SetFilterValue(propertyName, null);
        }
        _ = HandleFilterChanged();
    }

    // 事件處理：日期時間變更
    private void HandleDateTimeChange(string propertyName, string? value)
    {
        if (DateTime.TryParse(value, out var dateTime))
        {
            FilterModel.SetFilterValue(propertyName, dateTime);
        }
        else
        {
            FilterModel.SetFilterValue(propertyName, null);
        }
        _ = HandleFilterChanged();
    }

    // 事件處理：下拉選單變更
    private void HandleSelectChange(string propertyName, string? value)
    {
        FilterModel.SetFilterValue(propertyName, value);
        _ = HandleFilterChanged();
    }

    // 事件處理：多選變更
    private void HandleMultiSelectChange(string propertyName, string optionValue, object? isCheckedObj)
    {
        var isChecked = isCheckedObj is bool boolValue ? boolValue : bool.Parse(isCheckedObj?.ToString() ?? "false");
        var currentValues = GetMultiSelectValues(propertyName);
        
        if (isChecked && !currentValues.Contains(optionValue))
            currentValues.Add(optionValue);
        else if (!isChecked && currentValues.Contains(optionValue))
            currentValues.Remove(optionValue);
        
        FilterModel.SetFilterValue(propertyName, currentValues);
        _ = HandleFilterChanged();
    }

    // 事件處理：日期範圍變更
    private void HandleDateRangeChange(string propertyName, string? value, bool isStartDate)
    {
        var dateRange = GetDateRange(propertyName);
        
        if (DateTime.TryParse(value, out var date))
        {
            if (isStartDate)
                dateRange.StartDate = date;
            else
                dateRange.EndDate = date;
        }
        else
        {
            if (isStartDate)
                dateRange.StartDate = null;
            else
                dateRange.EndDate = null;
        }
        
        FilterModel.SetFilterValue(propertyName, dateRange);
        _ = HandleFilterChanged();
    }

    // 事件處理：日期時間範圍變更
    private void HandleDateTimeRangeChange(string propertyName, string? value, bool isStartDateTime)
    {
        var dateTimeRange = GetDateTimeRange(propertyName);
        
        if (DateTime.TryParse(value, out var dateTime))
        {
            if (isStartDateTime)
                dateTimeRange.StartDateTime = dateTime;
            else
                dateTimeRange.EndDateTime = dateTime;
        }
        else
        {
            if (isStartDateTime)
                dateTimeRange.StartDateTime = null;
            else
                dateTimeRange.EndDateTime = null;
        }
        
        FilterModel.SetFilterValue(propertyName, dateTimeRange);
        _ = HandleFilterChanged();
    }

    // 事件處理：數字範圍變更
    private void HandleNumberRangeChange(string propertyName, string? value, bool isMin)
    {
        var numberRange = GetNumberRange(propertyName);
        
        if (decimal.TryParse(value, out var num))
        {
            if (isMin)
                numberRange.Min = num;
            else
                numberRange.Max = num;
        }
        else
        {
            if (isMin)
                numberRange.Min = null;
            else
                numberRange.Max = null;
        }
        
        FilterModel.SetFilterValue(propertyName, numberRange);
        _ = HandleFilterChanged();
    }

    // 事件處理：布林值變更
    private void HandleBoolChange(string propertyName, object? isCheckedObj)
    {
        var isChecked = isCheckedObj is bool boolValue ? boolValue : bool.Parse(isCheckedObj?.ToString() ?? "false");
        FilterModel.SetFilterValue(propertyName, isChecked);
        _ = HandleFilterChanged();
    }

    // 事件處理：自動完成輸入
    private void HandleAutoCompleteInput(SearchFilterDefinition filter, string? inputValue)
    {
        var fieldId = filter.PropertyName;
        
        FilterModel.SetFilterValue(filter.PropertyName, inputValue);
        
        // 清除之前的計時器
        if (autoCompleteTimers.ContainsKey(fieldId))
        {
            autoCompleteTimers[fieldId]?.Dispose();
        }
        
        // 如果輸入長度不足，不觸發搜尋
        if (string.IsNullOrEmpty(inputValue) || inputValue.Length < filter.MinSearchLength)
        {
            autoCompleteOptions.Remove(fieldId);
            _ = HandleFilterChanged();
            return;
        }
        
        // 設置延遲搜尋計時器
        autoCompleteTimers[fieldId] = new Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                try
                {
                    if (filter.SearchFunction != null)
                    {
                        var options = await filter.SearchFunction(inputValue);
                        autoCompleteOptions[fieldId] = options;
                        StateHasChanged();
                    }
                }
                catch (Exception ex)
                {
                    Console.Error.WriteLine($"AutoComplete search error: {ex.Message}");
                    autoCompleteOptions[fieldId] = new List<SelectOption>();
                }
            });
        }, null, filter.AutoCompleteDelayMs, Timeout.Infinite);
        
        _ = HandleFilterChanged();
    }

    private async Task HandleSearch()
    {
        if (OnSearch.HasDelegate)
        {
            await OnSearch.InvokeAsync(FilterModel);
        }
    }

    private async Task HandleFilterChanged()
    {
        if (OnFilterChanged.HasDelegate)
        {
            await OnFilterChanged.InvokeAsync(FilterModel);
        }

        if (AutoSearch)
        {
            // 延遲搜尋，避免頻繁觸發
            searchTimer?.Dispose();
            searchTimer = new Timer(async _ =>
            {
                await InvokeAsync(async () =>
                {
                    await HandleSearch();
                    StateHasChanged();
                });
            }, null, SearchDelayMs, Timeout.Infinite);
        }
    }

    private async Task ClearAllFilters()
    {
        FilterModel = new SearchFilterModel();
        await HandleFilterChanged();
    }

    public void Dispose()
    {
        searchTimer?.Dispose();
        
        // 清理所有自動完成計時器
        foreach (var timer in autoCompleteTimers.Values)
        {
            timer?.Dispose();
        }
        autoCompleteTimers.Clear();
    }
}
