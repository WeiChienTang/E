@using ERPCore2.Models
@inject INotificationService NotificationService

<div class="modal fade @(IsVisible ? "show" : "")" 
     style="display: @(IsVisible ? "block" : "none"); background-color: rgba(0,0,0,0.5);" 
     tabindex="-1" 
     role="dialog"
     @onclick="@(() => HandleBackdropClick())">
    
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" 
         role="document"
         @onclick:stopPropagation="true">
        <div class="modal-content shadow-lg">
            @* Modal Header *@
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-link-45deg me-2"></i>
                    相關單據 - @ProductName
                </h5>
                <GenericButtonComponent Type="button" 
                                      CssClass="btn-close" 
                                      OnClick="Close" 
                                      Title="關閉" />
            </div>

            @* Modal Body *@
            <div class="modal-body">
                @if (IsLoading)
                {
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">載入中...</span>
                        </div>
                        <p class="mt-3 text-muted">正在載入相關單據...</p>
                    </div>
                }
                else if (RelatedDocuments == null || !RelatedDocuments.Any())
                {
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <p class="mt-3 text-muted">暫無相關單據</p>
                    </div>
                }
                else
                {
                    var returnDocs = RelatedDocuments.Where(d => d.DocumentType == RelatedDocumentType.ReturnDocument).ToList();
                    var setoffDocs = RelatedDocuments.Where(d => d.DocumentType == RelatedDocumentType.SetoffDocument).ToList();
                    
                    @if (returnDocs.Any())
                    {
                        <div class="mb-4">
                            <h6 class="text-warning mb-3">
                                <i class="bi bi-arrow-return-left me-2"></i>
                                退貨記錄 (@returnDocs.Count)
                            </h6>
                            <div class="list-group">
                                @foreach (var doc in returnDocs)
                                {
                                    <a href="javascript:void(0)" 
                                       class="list-group-item list-group-item-action"
                                       @onclick="@(() => HandleDocumentClick(doc))">
                                        <div class="d-flex w-100 justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">
                                                    <span class="badge bg-warning text-dark me-2">
                                                        <i class="@doc.Icon me-1"></i>
                                                        @doc.TypeDisplayName
                                                    </span>
                                                    @doc.DocumentNumber
                                                </h6>
                                                <p class="mb-1 text-muted small">
                                                    <i class="bi bi-calendar3 me-1"></i>
                                                    @doc.DocumentDate.ToString("yyyy-MM-dd")
                                                    @if (doc.Quantity.HasValue)
                                                    {
                                                        <span class="ms-3">
                                                            <i class="bi bi-box-seam me-1"></i>
                                                            退貨數量: @doc.Quantity.Value
                                                        </span>
                                                    }
                                                </p>
                                                @if (!string.IsNullOrEmpty(doc.Remarks))
                                                {
                                                    <p class="mb-0 text-muted small">
                                                        <i class="bi bi-chat-left-text me-1"></i>
                                                        @doc.Remarks
                                                    </p>
                                                }
                                            </div>
                                            <div>
                                                <i class="bi bi-chevron-right"></i>
                                            </div>
                                        </div>
                                    </a>
                                }
                            </div>
                        </div>
                    }

                    <!-- 沖款單區塊 -->
                    @if (setoffDocs.Any())
                    {
                        <div>
                            <h6 class="text-success mb-3">
                                <i class="bi bi-cash-coin me-2"></i>
                                沖款記錄 (@setoffDocs.Count)
                            </h6>
                            <div class="list-group">
                                @foreach (var doc in setoffDocs)
                                {
                                    <a href="javascript:void(0)" 
                                       class="list-group-item list-group-item-action"
                                       @onclick="@(() => HandleDocumentClick(doc))">
                                        <div class="d-flex w-100 justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">
                                                    <span class="badge bg-success me-2">
                                                        <i class="@doc.Icon me-1"></i>
                                                        @doc.TypeDisplayName
                                                    </span>
                                                    @doc.DocumentNumber
                                                </h6>
                                                <p class="mb-1 text-muted small">
                                                    <i class="bi bi-calendar3 me-1"></i>
                                                    @doc.DocumentDate.ToString("yyyy-MM-dd")
                                                    @if (doc.Amount.HasValue)
                                                    {
                                                        <span class="ms-3">
                                                            <i class="bi bi-currency-dollar me-1"></i>
                                                            沖款金額: @doc.Amount.Value.ToString("N2")
                                                        </span>
                                                    }
                                                </p>
                                                @if (!string.IsNullOrEmpty(doc.Remarks))
                                                {
                                                    <p class="mb-0 text-muted small">
                                                        <i class="bi bi-chat-left-text me-1"></i>
                                                        @doc.Remarks
                                                    </p>
                                                }
                                            </div>
                                            <div>
                                                <i class="bi bi-chevron-right"></i>
                                            </div>
                                        </div>
                                    </a>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public string ProductName { get; set; } = string.Empty;
    [Parameter] public List<RelatedDocument>? RelatedDocuments { get; set; }
    [Parameter] public bool IsLoading { get; set; }
    
    /// <summary>
    /// 當點擊單據時觸發，傳回單據資訊供父組件開啟對應的 EditModal
    /// </summary>
    [Parameter] public EventCallback<RelatedDocument> OnDocumentClick { get; set; }

    private async Task Close()
    {
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(false);
    }

    private void HandleBackdropClick()
    {
        // 點擊背景不關閉，維持開啟狀態
        // 這樣可以讓使用者同時看到多個 Modal
    }

    private async Task HandleDocumentClick(RelatedDocument document)
    {
        if (OnDocumentClick.HasDelegate)
        {
            await OnDocumentClick.InvokeAsync(document);
        }
    }
}
