@*
    通用搜尋 Modal 組件
    用於快速搜尋並選擇項目（支援頁面導航、報表等）
    使用 InteractiveTableComponent 統一 UI 風格
*@
@using ERPCore2.Models
@using ERPCore2.Helpers
@inject IJSRuntime JSRuntime
@inject IStringLocalizer<SharedResource> L
@inject NavigationManager NavigationManager
@rendermode InteractiveServer
@implements IDisposable

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@Title"
                   Icon="@Icon"
                   Size="BaseModalComponent.ModalSize.Large"
                   HeaderColor="BaseModalComponent.HeaderVariant.ProjectPrimary"
                   UseWhiteCloseButton="true"
                   BodyCssClass="p-0"
                   OnClose="@HandleClose"
                   CloseOnEscape="true"
                   CloseOnBackdropClick="true">
    
    <BodyContent>
        <div class="p-3">
            @* 搜尋輸入框 *@
            <div class="mb-3">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input @ref="searchInput"
                           type="text" 
                           class="form-control" 
                           placeholder="@Placeholder"
                           @bind="searchTerm"
                           @bind:event="oninput"
                           @bind:after="OnSearchTermChanged" />
                    @if (!string.IsNullOrWhiteSpace(searchTerm))
                    {
                        <button class="btn btn-outline-secondary" type="button" @onclick="ClearSearch">
                            <i class="bi bi-x"></i>
                        </button>
                    }
                </div>
            </div>

            @* 搜尋結果區域 *@
            @if (hasSearched && searchResults.Any())
            {
                <InteractiveTableComponent TItem="ISearchableItem"
                                          Items="@searchResults"
                                          ColumnDefinitions="@columnDefinitions"
                                          ShowRowNumbers="true"
                                          IsReadOnly="true"
                                          ShowBuiltInActions="true"
                                          ShowBuiltInDeleteButton="false"
                                          IsStriped="true"
                                          IsHoverable="true"
                                          IsBordered="true"
                                          EnableRowClick="true"
                                          OnRowClick="@HandleItemClick"
                                          EmptyMessage="@EmptyResultMessage">
                    <CustomActionsTemplate>
                        @{
                            var item = context;
                            var isEnabled = IsItemEnabled(item);
                        }
                        <GenericButtonComponent Variant="@(isEnabled ? ButtonVariant.DarkBlue : ButtonVariant.Gray)"
                                              Size="ButtonSize.Small"
                                              Text="@L["Search.GoTo"]"
                                              IsDisabled="@(!isEnabled)"
                                              Title="@(isEnabled ? string.Format(L["Search.GoToItem"], item.Name) : L["Search.ItemNotAvailable"].ToString())"
                                              OnClick="@(() => HandleItemClick(item))" />
                    </CustomActionsTemplate>
                </InteractiveTableComponent>
            }
            else if (hasSearched)
            {
                <div class="text-center py-5">
                    <i class="bi bi-emoji-frown fs-1 text-muted d-block mb-3"></i>
                    <p class="text-muted mb-0">@EmptyResultMessage</p>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="@EmptyStateIcon fs-1 text-primary d-block mb-3"></i>
                    <p class="text-muted mb-1">@EmptyStateMessage</p>
                    <small class="text-muted">@EmptyStateHint</small>
                </div>
            }
        </div>
    </BodyContent>
    
</BaseModalComponent>

@code {
    // ===== 基本參數 =====
    
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    
    /// <summary>
    /// Modal 標題
    /// </summary>
    [Parameter] public string Title { get; set; } = "搜尋";
    
    /// <summary>
    /// Modal 圖示 CSS 類別
    /// </summary>
    [Parameter] public string Icon { get; set; } = "bi-search";
    
    /// <summary>
    /// 搜尋框佔位符文字
    /// </summary>
    [Parameter] public string Placeholder { get; set; } = "輸入關鍵字搜尋...";
    
    /// <summary>
    /// 搜尋結果單位名稱（如「功能」、「報表」）
    /// </summary>
    [Parameter] public string ResultUnitName { get; set; } = "項目";
    
    /// <summary>
    /// 是否顯示圖示欄位
    /// </summary>
    [Parameter] public bool ShowIcon { get; set; } = false;
    
    // ===== 空狀態訊息 =====
    
    [Parameter] public string EmptyStateIcon { get; set; } = "bi bi-lightning-charge";
    [Parameter] public string EmptyStateMessage { get; set; } = "開始輸入以搜尋";
    [Parameter] public string EmptyStateHint { get; set; } = "支援名稱、關鍵字搜尋";
    [Parameter] public string EmptyResultMessage { get; set; } = "沒有找到符合條件的項目，請嘗試使用其他關鍵字";
    
    // ===== 搜尋與事件處理 =====
    
    /// <summary>
    /// 搜尋函數 - 接收搜尋字串，返回搜尋結果
    /// </summary>
    [Parameter] public Func<string, List<ISearchableItem>>? SearchFunction { get; set; }
    
    /// <summary>
    /// 分類顯示名稱轉換函數（可選）
    /// </summary>
    [Parameter] public Func<string, string>? CategoryDisplayNameFunc { get; set; }
    
    /// <summary>
    /// Action 處理器註冊表
    /// </summary>
    [Parameter] public NavigationActionHelper.ActionHandlerRegistry? ActionRegistry { get; set; }
    
    /// <summary>
    /// 當選擇項目時觸發（傳遞 ActionId）
    /// </summary>
    [Parameter] public EventCallback<string> OnItemSelected { get; set; }

    // ===== 私有欄位 =====
    
    private ElementReference searchInput;
    private List<ISearchableItem> searchResults = new();
    private List<InteractiveColumnDefinition> columnDefinitions = new();
    private string searchTerm = "";
    private bool hasSearched = false;
    private bool _isDisposed = false;
    
    // 防抖計時器
    private System.Threading.Timer? _searchDebounceTimer;

    // ===== 生命週期方法 =====
    
    protected override void OnInitialized()
    {
        InitializeColumnDefinitions();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsVisible && !_isDisposed)
        {
            try
            {
                await Task.Delay(100);
                await JSRuntime.InvokeVoidAsync("eval", "document.querySelector('.input-group input')?.focus()");
            }
            catch
            {
                // 忽略聚焦錯誤
            }
        }
    }
    
    // ===== 初始化方法 =====
    
    private void InitializeColumnDefinitions()
    {
        columnDefinitions = new List<InteractiveColumnDefinition>
        {
            new InteractiveColumnDefinition
            {
                PropertyName = "Name",
                Title = L["Search.NameColumn"].ToString(),
                ColumnType = InteractiveColumnType.Display,
                Width = "200px"
            },
            new InteractiveColumnDefinition
            {
                PropertyName = "Description",
                Title = L["Search.DescriptionColumn"].ToString(),
                ColumnType = InteractiveColumnType.Display
            },
        };
    }

    // ===== 公開方法 =====

    /// <summary>
    /// 開啟 Modal
    /// </summary>
    public async Task Open()
    {
        IsVisible = true;
        searchTerm = "";
        searchResults.Clear();
        hasSearched = false;
        await IsVisibleChanged.InvokeAsync(true);
        StateHasChanged();
    }

    /// <summary>
    /// 關閉 Modal
    /// </summary>
    public async Task Close()
    {
        await HandleClose();
    }

    // ===== 事件處理方法 =====
    
    private async Task HandleClose()
    {
        searchTerm = "";
        searchResults.Clear();
        hasSearched = false;
        
        if (IsVisibleChanged.HasDelegate)
        {
            await IsVisibleChanged.InvokeAsync(false);
        }
    }

    private void OnSearchTermChanged()
    {
        _searchDebounceTimer?.Dispose();
        
        _searchDebounceTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(async () =>
            {
                await PerformSearch();
                StateHasChanged();
            });
        }, null, 300, Timeout.Infinite);
    }

    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(searchTerm) || SearchFunction == null)
        {
            searchResults.Clear();
            hasSearched = false;
        }
        else
        {
            searchResults = SearchFunction(searchTerm);
            hasSearched = true;
        }
        
        await Task.CompletedTask;
    }

    private void ClearSearch()
    {
        searchTerm = "";
        searchResults.Clear();
        hasSearched = false;
        StateHasChanged();
    }
    
    /// <summary>
    /// 判斷項目是否可用
    /// </summary>
    private bool IsItemEnabled(ISearchableItem item)
    {
        // 有 ActionId 或有效的 Route 都視為可用
        return !string.IsNullOrWhiteSpace(item.ActionId) || 
               (!string.IsNullOrEmpty(item.Route) && item.Route != "#");
    }

    private async Task HandleItemClick(ISearchableItem item)
    {
        if (!IsItemEnabled(item))
        {
            return;
        }
        
        // 優先處理 ActionId
        if (!string.IsNullOrWhiteSpace(item.ActionId))
        {
            await HandleClose();
            
            // 透過 ActionRegistry 執行
            if (ActionRegistry != null)
            {
                ActionRegistry.Execute(item.ActionId);
            }
            
            // 透過事件回調通知父組件
            if (OnItemSelected.HasDelegate)
            {
                await OnItemSelected.InvokeAsync(item.ActionId);
            }
        }
        // 其次處理路由導航
        else if (!string.IsNullOrEmpty(item.Route) && item.Route != "#")
        {
            await HandleClose();
            NavigationManager.NavigateTo(item.Route);
        }
    }

    private string GetCategoryDisplayName(string category)
    {
        if (string.IsNullOrEmpty(category))
        {
            return "";
        }
        
        if (CategoryDisplayNameFunc != null)
        {
            return CategoryDisplayNameFunc(category);
        }
        return category;
    }

    // ===== 資源清理 =====
    
    public void Dispose()
    {
        try
        {
            _isDisposed = true;
            _searchDebounceTimer?.Dispose();
        }
        catch
        {
            // 忽略清理過程中的錯誤
        }
    }
}
