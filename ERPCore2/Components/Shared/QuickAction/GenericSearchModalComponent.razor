@*
    通用搜尋 Modal 組件
    用於快速搜尋並選擇項目（支援頁面導航、報表等）
*@
@using ERPCore2.Models
@using ERPCore2.Components.Shared.PageTemplate
@using ERPCore2.Helpers
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@rendermode InteractiveServer
@implements IDisposable

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@Title"
                   Icon="@Icon"
                   Size="BaseModalComponent.ModalSize.Large"
                   HeaderColor="BaseModalComponent.HeaderVariant.ProjectPrimary"
                   UseWhiteCloseButton="true"
                   BodyCssClass="pt-3"
                   OnClose="@HandleClose"
                   CloseOnEscape="true"
                   CloseOnBackdropClick="true">
    
    <BodyContent>
        @* 搜尋輸入框 *@
        <div class="search-input-wrapper mb-3">
            <i class="bi bi-search search-icon"></i>
            <input @ref="searchInput"
                   type="text" 
                   class="form-control ps-5" 
                   placeholder="@Placeholder"
                   @bind="searchTerm"
                   @bind:event="oninput"
                   @bind:after="OnSearchTermChanged"
                   @onkeydown="HandleKeyDown" />
            @if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                <button type="button" 
                        class="btn btn-sm btn-link clear-button" 
                        @onclick="ClearSearch"
                        title="清除搜尋">
                    <i class="bi bi-x-circle-fill"></i>
                </button>
            }
        </div>

        @* 搜尋結果區域 *@
        <div class="search-results-container">
            @if (searchResults.Any())
            {
                <div class="search-results-section">
                    <div class="search-results-list">
                        @for (int i = 0; i < searchResults.Count; i++)
                        {
                            var index = i;
                            var item = searchResults[i];
                            var isSelected = index == selectedIndex;
                            
                            <div class="search-result-item @(isSelected ? "keyboard-selected" : "")" 
                                 id="search-result-@index"
                                 @onclick="@(() => HandleItemClick(item))"
                                 @onmouseenter="@(() => HandleMouseEnter(index))"
                                 @onmouseleave="@HandleMouseLeave">
                                <div class="d-flex align-items-center gap-2">
                                    @if (ShowIcon && !string.IsNullOrWhiteSpace(item.IconClass))
                                    {
                                        <span class="result-icon">
                                            <i class="@item.IconClass"></i>
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="result-arrow">›</span>
                                    }
                                    <span class="result-name">@item.Name</span>
                                    @if (!string.IsNullOrWhiteSpace(item.Description))
                                    {
                                        <span class="result-description">@item.Description</span>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(item.Category))
                                    {
                                        <span class="result-category">@GetCategoryDisplayName(item.Category)</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else if (hasSearched)
            {
                <div class="search-empty-state text-center py-5">
                    <i class="bi bi-emoji-frown fs-1 text-muted d-block mb-3"></i>
                    <p class="text-muted mb-0">@EmptyResultMessage</p>
                </div>
            }
            else
            {
                <div class="search-empty-state text-center py-5">
                    <i class="@EmptyStateIcon fs-1 text-primary d-block mb-3"></i>
                    <p class="text-muted mb-1">@EmptyStateMessage</p>
                    <small class="text-muted">@EmptyStateHint</small>
                </div>
            }
        </div>
    </BodyContent>
    
</BaseModalComponent>

@code {
    // ===== 基本參數 =====
    
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    
    /// <summary>
    /// Modal 標題
    /// </summary>
    [Parameter] public string Title { get; set; } = "搜尋";
    
    /// <summary>
    /// Modal 圖示 CSS 類別
    /// </summary>
    [Parameter] public string Icon { get; set; } = "bi-search";
    
    /// <summary>
    /// 搜尋框佔位符文字
    /// </summary>
    [Parameter] public string Placeholder { get; set; } = "輸入關鍵字搜尋...";
    
    /// <summary>
    /// 搜尋結果單位名稱（如「功能」、「報表」）
    /// </summary>
    [Parameter] public string ResultUnitName { get; set; } = "項目";
    
    /// <summary>
    /// 是否顯示圖示
    /// </summary>
    [Parameter] public bool ShowIcon { get; set; } = false;
    
    // ===== 空狀態訊息 =====
    
    [Parameter] public string EmptyStateIcon { get; set; } = "bi bi-lightning-charge";
    [Parameter] public string EmptyStateMessage { get; set; } = "開始輸入以搜尋";
    [Parameter] public string EmptyStateHint { get; set; } = "支援名稱、關鍵字搜尋";
    [Parameter] public string EmptyResultMessage { get; set; } = "沒有找到符合條件的項目，請嘗試使用其他關鍵字";
    
    // ===== 搜尋與事件處理 =====
    
    /// <summary>
    /// 搜尋函數 - 接收搜尋字串，返回搜尋結果
    /// </summary>
    [Parameter] public Func<string, List<ISearchableItem>>? SearchFunction { get; set; }
    
    /// <summary>
    /// 分類顯示名稱轉換函數（可選）
    /// </summary>
    [Parameter] public Func<string, string>? CategoryDisplayNameFunc { get; set; }
    
    /// <summary>
    /// Action 處理器註冊表
    /// </summary>
    [Parameter] public NavigationActionHelper.ActionHandlerRegistry? ActionRegistry { get; set; }
    
    /// <summary>
    /// 當選擇項目時觸發（傳遞 ActionId）
    /// </summary>
    [Parameter] public EventCallback<string> OnItemSelected { get; set; }

    // ===== 私有欄位 =====
    
    private ElementReference searchInput;
    private List<ISearchableItem> searchResults = new();
    private string searchTerm = "";
    private bool hasSearched = false;
    private bool _isDisposed = false;
    private int selectedIndex = -1;
    private bool isUsingKeyboard = false;
    
    // 防抖計時器
    private System.Threading.Timer? _searchDebounceTimer;

    // ===== 生命週期方法 =====

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsVisible && !_isDisposed)
        {
            try
            {
                await Task.Delay(100);
                await JSRuntime.InvokeVoidAsync("eval", "document.querySelector('.search-input-wrapper input')?.focus()");
            }
            catch
            {
                // 忽略聚焦錯誤
            }
        }
    }

    // ===== 公開方法 =====

    /// <summary>
    /// 開啟 Modal
    /// </summary>
    public async Task Open()
    {
        IsVisible = true;
        searchTerm = "";
        searchResults.Clear();
        hasSearched = false;
        selectedIndex = -1;
        await IsVisibleChanged.InvokeAsync(true);
        StateHasChanged();
    }

    /// <summary>
    /// 關閉 Modal
    /// </summary>
    public async Task Close()
    {
        await HandleClose();
    }

    // ===== 事件處理方法 =====
    
    private async Task HandleClose()
    {
        searchTerm = "";
        searchResults.Clear();
        hasSearched = false;
        selectedIndex = -1;
        
        if (IsVisibleChanged.HasDelegate)
        {
            await IsVisibleChanged.InvokeAsync(false);
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "ArrowDown" || e.Key == "Down")
        {
            if (searchResults.Any())
            {
                isUsingKeyboard = true;
                selectedIndex = (selectedIndex + 1) % searchResults.Count;
                await ScrollToSelectedItem();
                StateHasChanged();
            }
        }
        else if (e.Key == "ArrowUp" || e.Key == "Up")
        {
            if (searchResults.Any())
            {
                isUsingKeyboard = true;
                selectedIndex = selectedIndex <= 0 ? searchResults.Count - 1 : selectedIndex - 1;
                await ScrollToSelectedItem();
                StateHasChanged();
            }
        }
        else if (e.Key == "Enter")
        {
            if (selectedIndex >= 0 && selectedIndex < searchResults.Count)
            {
                var selectedItem = searchResults[selectedIndex];
                await HandleItemClick(selectedItem);
            }
        }
    }

    private void HandleMouseEnter(int index)
    {
        isUsingKeyboard = false;
        selectedIndex = index;
        StateHasChanged();
    }

    private void HandleMouseLeave()
    {
        if (!isUsingKeyboard)
        {
            selectedIndex = -1;
            StateHasChanged();
        }
    }

    private void OnSearchTermChanged()
    {
        _searchDebounceTimer?.Dispose();
        
        _searchDebounceTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(async () =>
            {
                await PerformSearch();
                StateHasChanged();
            });
        }, null, 300, Timeout.Infinite);
    }

    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(searchTerm) || SearchFunction == null)
        {
            searchResults.Clear();
            hasSearched = false;
            selectedIndex = -1;
        }
        else
        {
            searchResults = SearchFunction(searchTerm);
            hasSearched = true;
            selectedIndex = searchResults.Any() ? 0 : -1;
        }
        
        await Task.CompletedTask;
    }

    private void ClearSearch()
    {
        searchTerm = "";
        searchResults.Clear();
        hasSearched = false;
        selectedIndex = -1;
        StateHasChanged();
    }

    private async Task HandleItemClick(ISearchableItem item)
    {
        // 優先處理 ActionId
        if (!string.IsNullOrWhiteSpace(item.ActionId))
        {
            await HandleClose();
            
            // 透過 ActionRegistry 執行
            if (ActionRegistry != null)
            {
                ActionRegistry.Execute(item.ActionId);
            }
            
            // 透過事件回調通知父組件
            if (OnItemSelected.HasDelegate)
            {
                await OnItemSelected.InvokeAsync(item.ActionId);
            }
        }
        // 其次處理路由導航
        else if (!string.IsNullOrEmpty(item.Route) && item.Route != "#")
        {
            await HandleClose();
            NavigationManager.NavigateTo(item.Route);
        }
    }

    private string GetCategoryDisplayName(string category)
    {
        if (CategoryDisplayNameFunc != null)
        {
            return CategoryDisplayNameFunc(category);
        }
        return category;
    }

    private async Task ScrollToSelectedItem()
    {
        if (selectedIndex >= 0 && !_isDisposed)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("eval", 
                    $"document.getElementById('search-result-{selectedIndex}')?.scrollIntoView({{ behavior: 'smooth', block: 'nearest' }})");
            }
            catch
            {
                // 忽略滾動錯誤
            }
        }
    }

    // ===== 資源清理 =====
    
    public void Dispose()
    {
        try
        {
            _isDisposed = true;
            _searchDebounceTimer?.Dispose();
        }
        catch
        {
            // 忽略清理過程中的錯誤
        }
    }
}
