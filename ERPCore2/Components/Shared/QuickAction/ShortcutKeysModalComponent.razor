@*
    快捷鍵說明 Modal
    顯示系統所有可用的快捷鍵列表
*@
@inject IJSRuntime JSRuntime
@inject IStringLocalizer<SharedResource> L

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@L["Shortcut.Title"]"
                   Icon="bi bi-keyboard"
                   Size="BaseModalComponent.ModalSize.Large"
                   HeaderColor="BaseModalComponent.HeaderVariant.ProjectPrimary"
                   ShowCloseButton="true"
                   CloseOnBackdropClick="true"
                   CloseOnEscape="true"
                   OnClose="@HandleClose">
    <BodyContent>
        <div class="shortcut-keys-content">
            <div class="alert alert-info mb-3">
                <i class="bi bi-info-circle-fill me-2"></i>
                @L["Shortcut.InfoMessage"]
            </div>

            <InteractiveTableComponent TItem="ShortcutKeyInfo"
                                      Items="@shortcutKeys"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      ShowHeader="true"
                                      ShowActions="false"
                                      ShowRowNumbers="false"
                                      IsStriped="true"
                                      IsHoverable="true"
                                      IsBordered="true"
                                      IsReadOnly="true"
                                      EmptyMessage="@L["Shortcut.NoKeys"]" />
        </div>
    </BodyContent>
</BaseModalComponent>

@code {
    // ===== 參數定義 =====
    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    // ===== 私有欄位 =====
    private List<ShortcutKeyInfo> shortcutKeys = new();

    // ===== 生命週期方法 =====
    protected override void OnInitialized()
    {
        InitializeShortcutKeys();
    }

    // ===== 私有方法 =====

    /// <summary>
    /// 初始化快捷鍵列表
    /// </summary>
    private void InitializeShortcutKeys()
    {
        shortcutKeys = new List<ShortcutKeyInfo>
        {
            new ShortcutKeyInfo
            {
                Keys = "Alt + S",
                Description = L["Shortcut.OpenPageSearch"].ToString(),
                Category = L["Shortcut.CategoryNavigation"].ToString()
            },
            new ShortcutKeyInfo
            {
                Keys = "Ctrl + R",
                Description = L["Shortcut.OpenReportSelector"].ToString(),
                Category = L["Shortcut.CategoryNavigation"].ToString()
            },
            new ShortcutKeyInfo
            {
                Keys = "Alt + Q",
                Description = L["Shortcut.OpenQuickActionMenu"].ToString(),
                Category = L["Shortcut.CategoryNavigation"].ToString()
            },
            new ShortcutKeyInfo
            {
                Keys = "Esc",
                Description = L["Shortcut.CloseModal"].ToString(),
                Category = L["Shortcut.CategoryWindowControl"].ToString()
            },
        };
    }

    /// <summary>
    /// 取得欄位定義
    /// </summary>
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            new InteractiveColumnDefinition
            {
                PropertyName = nameof(ShortcutKeyInfo.Category),
                Title = L["Shortcut.CategoryColumn"].ToString(),
                Width = "15%",
                ColumnType = InteractiveColumnType.Display,
                IsReadOnly = true,
                CellCssClass = "text-center"
            },
            new InteractiveColumnDefinition
            {
                PropertyName = nameof(ShortcutKeyInfo.Keys),
                Title = L["Shortcut.KeysColumn"].ToString(),
                Width = "25%",
                ColumnType = InteractiveColumnType.Custom,
                IsReadOnly = true,
                CellCssClass = "text-center",
                CustomTemplate = item => builder =>
                {
                    var shortcut = item as ShortcutKeyInfo;
                    if (shortcut != null)
                    {
                        builder.OpenElement(0, "div");
                        builder.AddAttribute(1, "class", "d-flex justify-content-center gap-1");
                        
                        var keys = shortcut.Keys.Split('+').Select(k => k.Trim()).ToArray();
                        for (int i = 0; i < keys.Length; i++)
                        {
                            builder.OpenElement(2 + (i * 4), "kbd");
                            builder.AddAttribute(3 + (i * 4), "class", "bg-dark text-white border px-2 py-1");
                            builder.AddContent(4 + (i * 4), keys[i]);
                            builder.CloseElement();
                            
                            if (i < keys.Length - 1)
                            {
                                builder.OpenElement(5 + (i * 4), "span");
                                builder.AddAttribute(6 + (i * 4), "class", "mx-1");
                                builder.AddContent(7 + (i * 4), "+");
                                builder.CloseElement();
                            }
                        }
                        
                        builder.CloseElement();
                    }
                }
            },
            new InteractiveColumnDefinition
            {
                PropertyName = nameof(ShortcutKeyInfo.Description),
                Title = L["Shortcut.DescriptionColumn"].ToString(),
                Width = "60%",
                ColumnType = InteractiveColumnType.Display,
                IsReadOnly = true
            }
        };
    }

    /// <summary>
    /// 處理關閉事件
    /// </summary>
    private async Task HandleClose()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }

    // ===== 內部類別 =====

    /// <summary>
    /// 快捷鍵資訊類別
    /// </summary>
    public class ShortcutKeyInfo
    {
        public string Category { get; set; } = string.Empty;
        public string Keys { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
    }
}
