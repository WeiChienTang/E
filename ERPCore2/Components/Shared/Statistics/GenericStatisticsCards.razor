@* 通用統計卡片套裝組件 - 緊湊 Badge 模式 *@
@inject IStringLocalizer<SharedResource> L

<div class="statistics-compact-container">
    <div class="statistics-compact-row">
        @foreach (var cardConfig in CardConfigs)
        {
            var value = GetCardValue(cardConfig);
            var isClickable = cardConfig.OnClick.HasDelegate;
            <span class="statistics-badge badge-@cardConfig.BorderColor @(isClickable ? "clickable" : "")"
                  @onclick="@(() => HandleBadgeClick(cardConfig))"
                  title="@(isClickable ? L["Stats.ClickForDetail"].ToString() : "")">
                <span class="badge-title">@cardConfig.Title</span>
                <span class="badge-value">
                    @if (cardConfig.IsCurrency)
                    {
                        <text>$@value.ToString("N0")</text>
                    }
                    else
                    {
                        @value.ToString("N0")
                    }
                </span>
                @if (isClickable)
                {
                    <i class="bi bi-chevron-right badge-arrow"></i>
                }
            </span>
        }
    </div>
</div>

@code {
    /// <summary>
    /// 統計卡片配置清單
    /// </summary>
    [Parameter, EditorRequired]
    public List<StatisticsCardConfig> CardConfigs { get; set; } = new();

    /// <summary>
    /// 統計資料來源
    /// </summary>
    [Parameter, EditorRequired]
    public Dictionary<string, object> Statistics { get; set; } = new();

    /// <summary>
    /// 處理 Badge 點擊事件
    /// </summary>
    private async Task HandleBadgeClick(StatisticsCardConfig config)
    {
        if (config.OnClick.HasDelegate)
        {
            await config.OnClick.InvokeAsync();
        }
    }

    /// <summary>
    /// 取得卡片顯示值
    /// </summary>
    private decimal GetCardValue(StatisticsCardConfig config)
    {
        if (config.ValueCalculator != null)
        {
            return config.ValueCalculator(Statistics);
        }

        if (!string.IsNullOrEmpty(config.DataKey))
        {
            return Convert.ToDecimal(Statistics.GetValueOrDefault(config.DataKey, config.DefaultValue));
        }

        return config.DefaultValue;
    }
}
