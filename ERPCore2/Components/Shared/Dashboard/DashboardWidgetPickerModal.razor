@using ERPCore2.Models.Navigation
@using ERPCore2.Data.Navigation

@* 新增項目選擇 Modal（雙 Tab：頁面連結 / 快速功能） *@
<BaseModalComponent IsVisible="@IsVisible"
                    IsVisibleChanged="@IsVisibleChanged"
                    Title="新增捷徑項目"
                    Icon="bi-grid-3x3-gap-fill"
                    Size="BaseModalComponent.ModalSize.Desktop"
                    HeaderColor="BaseModalComponent.HeaderVariant.ProjectPrimary"
                    UseWhiteCloseButton="true"
                    CloseOnEscape="true"
                    CloseOnBackdropClick="true"
                    OnClose="@HandleCancel">
    <HeaderButtons>
        <GenericButtonComponent Variant="ButtonVariant.Blue"
                               Text="確定"
                               OnClick="HandleConfirm"
                               IsDisabled="@(!selectedItemKeys.Any())"
                               Title="新增選取的項目" />
        <GenericButtonComponent Variant="ButtonVariant.Red"
                               Text="取消"
                               OnClick="HandleCancel"
                               Title="取消" />
    </HeaderButtons>
    <BodyContent>
        @* 搜尋框 *@
        <div class="mb-3">
            <SearchInputComponent @bind-Value="searchKeyword"
                                  Placeholder="搜尋名稱、描述或分類..." />
        </div>

        @if (IsSearchMode)
        {
            @* 搜尋結果模式：合併顯示所有類型 *@
            @if (!FilteredAllWidgets.Any())
            {
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-search fs-1"></i>
                    <p class="mt-2">找不到符合「@searchKeyword」的項目</p>
                </div>
            }
            else
            {
                @* 頁面連結搜尋結果 *@
                @if (FilteredShortcutWidgets.Any())
                {
                    <div class="mb-3">
                        <h6 class="fw-bold text-primary border-bottom pb-2 mb-2">
                            <i class="bi bi-link-45deg me-1"></i>頁面連結
                            <span class="badge bg-primary ms-1">@FilteredShortcutWidgets.Count</span>
                        </h6>
                        @RenderWidgetGrid(FilteredShortcutWidgets)
                    </div>
                }

                @* 快速功能搜尋結果 *@
                @if (FilteredQuickActionWidgets.Any())
                {
                    <div class="mb-3">
                        <h6 class="fw-bold text-primary border-bottom pb-2 mb-2">
                            <i class="bi bi-wrench-adjustable me-1"></i>快速功能
                            <span class="badge bg-primary ms-1">@FilteredQuickActionWidgets.Count</span>
                        </h6>
                        @RenderWidgetGrid(FilteredQuickActionWidgets)
                    </div>
                }

                @* 圖表介面搜尋結果 *@
                @if (FilteredChartWidgets.Any())
                {
                    <div class="mb-3">
                        <h6 class="fw-bold text-primary border-bottom pb-2 mb-2">
                            <i class="bi bi-bar-chart-fill me-1"></i>圖表介面
                            <span class="badge bg-primary ms-1">@FilteredChartWidgets.Count</span>
                        </h6>
                        @RenderWidgetGrid(FilteredChartWidgets)
                    </div>
                }
            }
        }
        else
        {
            @* 一般模式：Tab 切換 *@
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <button class="nav-link @(activeTab == "shortcut" ? "active tab-active" : "tab-inactive")"
                            type="button"
                            @onclick='@(() => activeTab = "shortcut")'>
                        <i class="bi bi-window me-1"></i>頁面連結
                        @if (AvailableShortcutWidgets.Any())
                        {
                            <span class="badge bg-secondary ms-1">@AvailableShortcutWidgets.Count</span>
                        }
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(activeTab == "quickaction" ? "active tab-active" : "tab-inactive")"
                            type="button"
                            @onclick='@(() => activeTab = "quickaction")'>
                        <i class="bi bi-wrench-adjustable me-1"></i>快速功能
                        @if (AvailableQuickActionWidgets.Any())
                        {
                            <span class="badge bg-secondary ms-1">@AvailableQuickActionWidgets.Count</span>
                        }
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(activeTab == "chart" ? "active tab-active" : "tab-inactive")"
                            type="button"
                            @onclick='@(() => activeTab = "chart")'>
                        <i class="bi bi-bar-chart-fill me-1"></i>圖表介面
                        @if (AvailableChartWidgets.Any())
                        {
                            <span class="badge bg-secondary ms-1">@AvailableChartWidgets.Count</span>
                        }
                    </button>
                </li>
            </ul>

            @* Tab 內容 *@
            var currentWidgets = activeTab == "quickaction" ? AvailableQuickActionWidgets
                               : activeTab == "chart"       ? AvailableChartWidgets
                               : AvailableShortcutWidgets;

            var emptyLabel = activeTab == "quickaction" ? "快速功能"
                           : activeTab == "chart"       ? "圖表介面"
                           : "頁面連結";

            @if (currentWidgets == null || !currentWidgets.Any())
            {
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-emoji-neutral fs-1"></i>
                    <p class="mt-2">目前沒有可新增的@emptyLabel</p>
                </div>
            }
            else
            {
                @* 依分類分組顯示 *@
                @foreach (var group in currentWidgets
                    .GroupBy(w => w.Category)
                    .OrderBy(g => g.Key))
                {
                    <div class="mb-3">
                        <h6 class="fw-bold text-primary border-bottom pb-2 mb-2">@group.Key</h6>
                        <div class="row g-2">
                            @foreach (var widget in group.OrderBy(w => w.Name))
                            {
                                var itemKey = DashboardDefaults.GetNavigationItemKey(widget);
                                var isExisting = ExistingWidgetKeys.Contains(itemKey);
                                var isSelected = selectedItemKeys.Contains(itemKey);
                                var capturedItemKey = itemKey;
                                var iconClass = widget.ItemType == NavigationItemType.QuickAction
                                    ? "bi bi-wrench-adjustable"
                                    : widget.IsChartWidget
                                        ? (widget.IconClass ?? "bi bi-bar-chart-fill")
                                        : widget.IconClass?.Contains("printer") == true
                                            ? "bi bi-printer-fill"
                                            : "bi bi-window";

                                <div class="col-lg-2 col-md-4 col-6">
                                    <div class="picker-item @(isExisting ? "existing" : isSelected ? "selected" : "")"
                                         @onclick="@(() => ToggleWidget(capturedItemKey, isExisting))">
                                        <div class="picker-icon me-2">
                                            <i class="@iconClass"></i>
                                        </div>
                                        <div class="picker-name">@widget.Name</div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
        }
    </BodyContent>
</BaseModalComponent>

@* 共用的項目格線渲染方法 *@
@code {
    private RenderFragment RenderWidgetGrid(List<NavigationItem> widgets) => __builder =>
    {
        <div class="row g-2">
            @foreach (var widget in widgets.OrderBy(w => w.Category).ThenBy(w => w.Name))
            {
                var itemKey = DashboardDefaults.GetNavigationItemKey(widget);
                var isExisting = ExistingWidgetKeys.Contains(itemKey);
                var isSelected = selectedItemKeys.Contains(itemKey);
                var capturedItemKey = itemKey;
                var iconClass = widget.ItemType == NavigationItemType.QuickAction
                    ? "bi bi-wrench-adjustable"
                    : widget.IconClass?.Contains("printer") == true
                        ? "bi bi-printer-fill"
                        : "bi bi-window";

                <div class="col-lg-2 col-md-4 col-6">
                    <div class="picker-item @(isExisting ? "existing" : isSelected ? "selected" : "")"
                         @onclick="@(() => ToggleWidget(capturedItemKey, isExisting))">
                        <div class="picker-icon me-2">
                            <i class="@iconClass"></i>
                        </div>
                        <div class="picker-name">@widget.Name</div>
                    </div>
                </div>
            }
        </div>
    };
}

@code {
    // ===== 參數 =====

    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    /// <summary>
    /// 可選的頁面連結項目清單（Route + Action 類型）
    /// </summary>
    [Parameter]
    public List<NavigationItem> AvailableShortcutWidgets { get; set; } = new();

    /// <summary>
    /// 可選的快速功能項目清單（QuickAction 類型）
    /// </summary>
    [Parameter]
    public List<NavigationItem> AvailableQuickActionWidgets { get; set; } = new();

    /// <summary>
    /// 可選的圖表介面項目清單（IsChartWidget = true 的 Action 類型）
    /// </summary>
    [Parameter]
    public List<NavigationItem> AvailableChartWidgets { get; set; } = new();

    /// <summary>
    /// 已存在於面板的導航項目識別鍵集合
    /// </summary>
    [Parameter]
    public HashSet<string> ExistingWidgetKeys { get; set; } = new();

    /// <summary>
    /// 確認新增事件（回傳選取的 NavigationItemKey 清單）
    /// </summary>
    [Parameter]
    public EventCallback<List<string>> OnConfirm { get; set; }

    // ===== 狀態 =====

    private string activeTab = "shortcut"; // "shortcut" 或 "quickaction"
    private HashSet<string> selectedItemKeys = new();
    private string searchKeyword = string.Empty;

    /// <summary>
    /// 是否處於搜尋模式
    /// </summary>
    private bool IsSearchMode => !string.IsNullOrWhiteSpace(searchKeyword);

    /// <summary>
    /// 篩選後的頁面連結項目
    /// </summary>
    private List<NavigationItem> FilteredShortcutWidgets => FilterWidgets(AvailableShortcutWidgets);

    /// <summary>
    /// 篩選後的快速功能項目
    /// </summary>
    private List<NavigationItem> FilteredQuickActionWidgets => FilterWidgets(AvailableQuickActionWidgets);

    /// <summary>
    /// 篩選後的圖表介面項目
    /// </summary>
    private List<NavigationItem> FilteredChartWidgets => FilterWidgets(AvailableChartWidgets);

    /// <summary>
    /// 所有篩選後的項目（合併）
    /// </summary>
    private List<NavigationItem> FilteredAllWidgets =>
        FilteredShortcutWidgets.Concat(FilteredQuickActionWidgets).Concat(FilteredChartWidgets).ToList();

    /// <summary>
    /// 篩選項目的共用方法
    /// </summary>
    private List<NavigationItem> FilterWidgets(List<NavigationItem> widgets)
    {
        if (string.IsNullOrWhiteSpace(searchKeyword))
            return widgets;

        var keyword = searchKeyword.Trim().ToLower();
        return widgets.Where(w =>
            (w.Name?.ToLower().Contains(keyword) ?? false) ||
            (w.Description?.ToLower().Contains(keyword) ?? false) ||
            (w.Category?.ToLower().Contains(keyword) ?? false) ||
            (w.QuickActionName?.ToLower().Contains(keyword) ?? false) ||
            (w.QuickActionDescription?.ToLower().Contains(keyword) ?? false) ||
            (w.SearchKeywords?.Any(k => k.ToLower().Contains(keyword)) ?? false)
        ).ToList();
    }

    /// <summary>
    /// 清除搜尋
    /// </summary>
    private void ClearSearch()
    {
        searchKeyword = string.Empty;
    }

    // ===== 方法 =====

    protected override void OnParametersSet()
    {
        // 當 Modal 開啟時重置狀態
        if (IsVisible)
        {
            if (AvailableShortcutWidgets.Any())
            {
                activeTab = "shortcut";
            }
            else if (AvailableQuickActionWidgets.Any())
            {
                activeTab = "quickaction";
            }
            else if (AvailableChartWidgets.Any())
            {
                activeTab = "chart";
            }
        }
    }

    private void ToggleWidget(string itemKey, bool isExisting)
    {
        // 已加入的不可操作
        if (isExisting) return;

        if (selectedItemKeys.Contains(itemKey))
        {
            selectedItemKeys.Remove(itemKey);
        }
        else
        {
            selectedItemKeys.Add(itemKey);
        }
    }

    private async Task HandleConfirm()
    {
        if (selectedItemKeys.Any() && OnConfirm.HasDelegate)
        {
            await OnConfirm.InvokeAsync(selectedItemKeys.ToList());
        }

        selectedItemKeys.Clear();
        await CloseModal();
    }

    private async Task HandleCancel()
    {
        selectedItemKeys.Clear();
        searchKeyword = string.Empty;
        await CloseModal();
    }

    private async Task CloseModal()
    {
        if (IsVisibleChanged.HasDelegate)
        {
            await IsVisibleChanged.InvokeAsync(false);
        }
    }
}
