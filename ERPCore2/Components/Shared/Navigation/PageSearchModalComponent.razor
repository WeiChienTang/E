@using ERPCore2.Models
@inject INavigationSearchService NavigationSearchService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@rendermode InteractiveServer
@implements IDisposable

@* Modal 背景遮罩 *@
@if (IsVisible)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog" aria-labelledby="pageSearchModalLabel" aria-modal="true"
         @onclick="@HandleBackdropClick">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document" @onclick:stopPropagation="true">
            <div class="modal-content page-search-modal">
                <div class="modal-header border-0 pb-2">
                    <h5 class="modal-title" id="pageSearchModalLabel">
                        <i class="bi bi-search me-2"></i>
                        頁面搜尋
                    </h5>
                    <div class="ms-auto d-flex align-items-center gap-3">
                        <small class="text-white">
                            <kbd>Alt</kbd> + <kbd>S</kbd> 開啟 | <kbd>↑</kbd><kbd>↓</kbd> 選取 | <kbd>Enter</kbd> 確認 | <kbd>ESC</kbd> 關閉
                        </small>
                        <button type="button" class="btn-close btn-close-white" @onclick="Close" aria-label="關閉"></button>
                    </div>
                </div>
                <div class="modal-body pt-0">
                    @* 搜尋輸入框 *@
                    <div class="search-input-wrapper mb-3">
                        <i class="bi bi-search search-icon"></i>
                        <input @ref="searchInput"
                               type="text" 
                               class="form-control form-control-lg ps-5" 
                               placeholder="輸入功能名稱或關鍵字搜尋..."
                               @bind="searchTerm"
                               @bind:event="oninput"
                               @bind:after="OnSearchTermChanged"
                               @onkeydown="HandleKeyDown" />
                        @if (!string.IsNullOrWhiteSpace(searchTerm))
                        {
                            <button type="button" 
                                    class="btn btn-sm btn-link clear-button" 
                                    @onclick="ClearSearch"
                                    title="清除搜尋">
                                <i class="bi bi-x-circle-fill"></i>
                            </button>
                        }
                    </div>

                    @* 搜尋結果區域 *@
                    <div class="search-results-container">
                        @if (searchResults.Any())
                        {
                            <div class="search-results-section">
                                <h6 class="mb-3">
                                    <i class="bi bi-list-ul me-2"></i>
                                    搜尋結果 (共 @searchResults.Count 個功能)
                                </h6>
                                <div class="search-results-list">
                                    @for (int i = 0; i < searchResults.Count; i++)
                                    {
                                        var index = i;
                                        var item = searchResults[i];
                                        var isSelected = index == selectedIndex;
                                        
                                        <div class="search-result-item @(isSelected ? "selected" : "")" 
                                             id="search-result-@index"
                                             @onclick="@(() => HandleNavigationCardClick(item))">
                                            <div class="d-flex align-items-center gap-3">
                                                <span class="result-arrow">›</span>
                                                <div class="flex-grow-1">
                                                    <div class="d-flex align-items-center gap-2 mb-1">
                                                        <span class="result-name">@item.Name</span>
                                                        @if (!string.IsNullOrWhiteSpace(item.Description))
                                                        {
                                                            <span class="result-description text-muted">@item.Description</span>
                                                        }
                                                    </div>
                                                    <div class="d-flex align-items-center gap-3">
                                                        @if (!string.IsNullOrWhiteSpace(item.Route))
                                                        {
                                                            <small class="result-route text-muted">
                                                                <i class="bi bi-link-45deg me-1"></i>@item.Route
                                                            </small>
                                                        }
                                                        @if (!string.IsNullOrWhiteSpace(item.Category))
                                                        {
                                                            <small class="result-category">
                                                                <span class="badge bg-secondary">@item.Category</span>
                                                            </small>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        else if (hasSearched)
                        {
                            <div class="search-empty-state text-center py-5">
                                <i class="bi bi-search-heart fs-1 text-muted d-block mb-3"></i>
                                <p class="text-muted mb-0">沒有找到符合條件的功能，請嘗試使用其他關鍵字</p>
                            </div>
                        }
                        else
                        {
                            <div class="search-empty-state text-center py-5">
                                <i class="bi bi-lightning-charge fs-1 text-primary d-block mb-3"></i>
                                <p class="text-muted mb-1">開始輸入以搜尋功能頁面</p>
                                <small class="text-muted">支援功能名稱、關鍵字搜尋</small>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    @* Bootstrap Modal 背景遮罩 *@
    <div class="modal-backdrop fade show"></div>
}

@code {
    /// <summary>
    /// 控制 Modal 顯示/隱藏
    /// </summary>
    [Parameter]
    public bool IsVisible { get; set; }

    /// <summary>
    /// Modal 顯示狀態改變時的回調
    /// </summary>
    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    // ===== 私有欄位 =====
    
    private ElementReference searchInput;
    private List<NavigationItem> searchResults = new();
    private string searchTerm = "";
    private bool hasSearched = false;
    private bool _isDisposed = false;
    private int selectedIndex = -1; // 目前選中的項目索引
    
    // 防抖計時器
    private System.Threading.Timer? _searchDebounceTimer;

    // ===== 生命週期方法 =====

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // 當 Modal 顯示時，自動聚焦到搜尋框
        if (IsVisible && !_isDisposed)
        {
            try
            {
                await Task.Delay(100);
                await JSRuntime.InvokeVoidAsync("eval", "document.querySelector('.page-search-modal input')?.focus()");
            }
            catch
            {
                // 忽略聚焦錯誤
            }
        }
    }

    // ===== 公開方法 =====

    /// <summary>
    /// 開啟 Modal
    /// </summary>
    public async Task Open()
    {
        IsVisible = true;
        searchTerm = "";
        searchResults.Clear();
        hasSearched = false;
        selectedIndex = -1; // 重置選取
        await IsVisibleChanged.InvokeAsync(true);
        StateHasChanged();
    }

    /// <summary>
    /// 關閉 Modal
    /// </summary>
    public async Task Close()
    {
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(false);
        StateHasChanged();
    }

    // ===== 私有方法 =====

    /// <summary>
    /// 處理鍵盤事件（支援 ESC 關閉、方向鍵選取、Enter 確認）
    /// </summary>
    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            // ESC 關閉 Modal
            await Close();
        }
        else if (e.Key == "ArrowDown" || e.Key == "Down")
        {
            // 向下移動選取
            if (searchResults.Any())
            {
                selectedIndex = (selectedIndex + 1) % searchResults.Count;
                await ScrollToSelectedItem();
                StateHasChanged();
            }
        }
        else if (e.Key == "ArrowUp" || e.Key == "Up")
        {
            // 向上移動選取
            if (searchResults.Any())
            {
                selectedIndex = selectedIndex <= 0 ? searchResults.Count - 1 : selectedIndex - 1;
                await ScrollToSelectedItem();
                StateHasChanged();
            }
        }
        else if (e.Key == "Enter")
        {
            // Enter 導航到選中的項目
            if (selectedIndex >= 0 && selectedIndex < searchResults.Count)
            {
                var selectedItem = searchResults[selectedIndex];
                await HandleNavigationCardClick(selectedItem);
            }
        }
    }

    /// <summary>
    /// 當搜尋字串改變時觸發（帶防抖）
    /// </summary>
    private void OnSearchTermChanged()
    {
        // 取消之前的計時器
        _searchDebounceTimer?.Dispose();
        
        // 設置新的計時器（300ms 防抖）
        _searchDebounceTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(async () =>
            {
                await PerformSearch();
                StateHasChanged();
            });
        }, null, 300, Timeout.Infinite);
    }

    /// <summary>
    /// 執行搜尋
    /// </summary>
    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            searchResults.Clear();
            hasSearched = false;
            selectedIndex = -1; // 重置選取
        }
        else
        {
            searchResults = NavigationSearchService.SearchNavigationItems(searchTerm)
                .Where(item => !item.IsParent && !string.IsNullOrEmpty(item.Route) && item.Route != "#")
                .ToList();
            hasSearched = true;
            
            // 自動選取第一個項目
            selectedIndex = searchResults.Any() ? 0 : -1;
        }
        
        await Task.CompletedTask;
    }

    /// <summary>
    /// 清除搜尋
    /// </summary>
    private void ClearSearch()
    {
        searchTerm = "";
        searchResults.Clear();
        hasSearched = false;
        selectedIndex = -1; // 重置選取
        StateHasChanged();
    }

    /// <summary>
    /// 導航到指定頁面
    /// </summary>
    private async Task NavigateToPage(string? route)
    {
        if (!string.IsNullOrEmpty(route) && route != "#")
        {
            await Close();
            NavigationManager.NavigateTo(route);
        }
    }

    /// <summary>
    /// 處理導航卡片點擊事件
    /// </summary>
    private async Task HandleNavigationCardClick(NavigationItem item)
    {
        if (!string.IsNullOrEmpty(item.Route) && item.Route != "#")
        {
            await Close();
            NavigationManager.NavigateTo(item.Route);
        }
    }

    /// <summary>
    /// 處理背景點擊事件（點擊背景關閉 Modal）
    /// </summary>
    private async Task HandleBackdropClick()
    {
        await Close();
    }

    /// <summary>
    /// 滾動到選中的項目
    /// </summary>
    private async Task ScrollToSelectedItem()
    {
        if (selectedIndex >= 0 && !_isDisposed)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("eval", 
                    $"document.getElementById('search-result-{selectedIndex}')?.scrollIntoView({{ behavior: 'smooth', block: 'nearest' }})");
            }
            catch
            {
                // 忽略滾動錯誤
            }
        }
    }

    // ===== 資源清理 =====
    public void Dispose()
    {
        try
        {
            _isDisposed = true;
            _searchDebounceTimer?.Dispose();
        }
        catch
        {
            // 忽略清理過程中的錯誤
        }
    }
}
