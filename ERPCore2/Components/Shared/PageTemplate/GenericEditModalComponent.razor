@* æ³›å‹Edit Modalçµ„ä»¶ *@
@attribute [Authorize]
@inject IJSRuntime JSRuntime
@inject INotificationService NotificationService
@using System.Reflection
@using ERPCore2.Components.Shared.Base
@using ERPCore2.Helpers
@typeparam TEntity where TEntity : BaseEntity, new()
@typeparam TService

@{
    // æ¬Šé™æª¢æŸ¥ - å¦‚æœæ²’æœ‰è¨­å®šæ¬Šé™ï¼Œé è¨­æ‹’çµ•å­˜å–
    string requiredPermission = RequiredPermission;
    if (string.IsNullOrWhiteSpace(requiredPermission))
    {
        // å®‰å…¨èµ·è¦‹ï¼Œå¦‚æœæ²’æœ‰è¨­å®šæ¬Šé™ï¼Œè¨­å®šç‚ºä¸€å€‹ä¸å­˜åœ¨çš„æ¬Šé™ä»¥ç¢ºä¿æ‹’çµ•å­˜å–
        requiredPermission = "System.RequiredPermissionNotSet";
    }
}

<PagePermissionCheck RequiredPermission="@requiredPermission">

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@GetModalTitle()"
                   Icon="@GetModalIcon()"
                   Size="@ConvertToBaseModalSize(Size)"
                   HeaderColor="BaseModalComponent.HeaderVariant.ProjectPrimary"
                   CloseOnEscape="true"
                   CloseOnBackdropClick="false"
                   ShowCloseButton="true"
                   IsLoading="@IsLoading"
                   LoadingMessage="@LoadingMessage"
                   ErrorMessage="@ErrorMessage"
                   ShowFooter="@(Entity != null && Entity.Id > 0)"
                   AuditInfo="@GetAuditInfo()"
                   BodyCssClass="p-0"
                   OnClose="@HandleCancel">    
    <HeaderButtons>
        @* ===== Modal Actions æŒ‰éˆ•å€å¡Š ===== *@
        <div class="w-100 d-flex align-items-center px-2">
            @* æœ€å·¦å´ï¼šè‡ªè¨‚æ“ä½œæŒ‰éˆ•ï¼ˆä¾‹å¦‚ï¼šè½‰å…¥åº«ã€è½‰æ²–æ¬¾ç­‰æ¥­å‹™æµç¨‹æŒ‰éˆ•ï¼‰ *@
            @if (CustomActionButtons != null)
            {
                <div class="d-flex gap-2 me-auto">
                    @CustomActionButtons
                </div>
            }
            
            @* å·¦å´/ä¸­é–“ï¼šç‹€æ…‹è¨Šæ¯é¡¯ç¤ºï¼ˆæ•´åˆå¯©æ ¸å’Œå…¶ä»–æ‰€æœ‰ç‹€æ…‹è¨Šæ¯ï¼‰ *@
            <div class="@(CustomActionButtons == null ? "flex-grow-1" : "")">
                @if (ShouldShowStatusMessage() && !IsLoading && Entity != null && Entity.Id > 0 && !string.IsNullOrEmpty(_cachedStatusMessage))
                {
                    <span class="badge bg-@GetBadgeColorClass(_cachedStatusVariant) me-2 fs-6">
                        <i class="@_cachedStatusIcon me-1"></i>@_cachedStatusMessage
                    </span>
                }
            </div>
            
            @* ä¸­å¤®ï¼šå¯©æ ¸æ“ä½œæŒ‰éˆ• *@
            @if (ShowApprovalSection && !IsLoading && Entity != null && Entity.Id > 0)
            {
                @* æœ‰æ¬Šé™è€…æ‰èƒ½çœ‹åˆ°å¯©æ ¸é€šé/é§å›æŒ‰éˆ• *@
                @if (!IsEntityApproved())
                {
                    <PermissionCheck Permission="@ApprovalPermission">
                        <div class="d-flex gap-2 me-3">
                            <GenericButtonComponent Text="é€šé" 
                                                  Variant="ButtonVariant.Green" 
                                                  OnClick="HandleApprove" 
                                                  IsDisabled="@(IsSubmitting || IsApproving || IsRejecting)"
                                                  IsLoading="@IsApproving" />
                            <GenericButtonComponent Text="é§å›" 
                                                  Variant="ButtonVariant.Red" 
                                                  OnClick="OpenRejectConfirmModal" 
                                                  IsDisabled="@(IsSubmitting || IsApproving || IsRejecting)"
                                                  IsLoading="@IsRejecting" />
                        </div>
                    </PermissionCheck>
                }
            }
            
            @* å³å´ï¼šåŸæœ‰çš„ä¸»è¦æ“ä½œæŒ‰éˆ• *@
            <div class="d-flex gap-2">
                @if (ShowSaveButton)
                {
                    <GenericButtonComponent Text="@SaveButtonText" 
                                          Variant="ButtonVariant.DarkBlue" 
                                          OnClick="HandleSave" 
                                          IsDisabled="@(IsSubmitting || IsLoading)" 
                                          IsLoading="@IsSubmitting" />
                }
                
                @* æ–°å¢æŒ‰éˆ•ï¼ˆåªåœ¨ç·¨è¼¯æ¨¡å¼é¡¯ç¤ºï¼‰ *@
                @if (ShowAddButton && Entity != null && Entity.Id > 0)
                {
                    <GenericButtonComponent Text="æ–°å¢" 
                                          Variant="ButtonVariant.DarkBlue" 
                                          OnClick="HandleAddClick" 
                                          IsDisabled="@(IsSubmitting || IsLoading)"
                                          Title="æ–°å¢è³‡æ–™" />
                }
                
                @* è¿”å›ç·¨è¼¯æŒ‰éˆ•ï¼ˆåªåœ¨æ–°å¢æ¨¡å¼ä¸”æœ‰æœ€å¾Œä¸€ç­†è¨˜éŒ„æ™‚é¡¯ç¤ºï¼‰ *@
                @if (ShowReturnToLastButton && !Id.HasValue && _lastRecordId.HasValue)
                {
                    <GenericButtonComponent Text="@ReturnToLastButtonText" 
                                          Variant="ButtonVariant.Green" 
                                          OnClick="HandleReturnToLast" 
                                          IsDisabled="@(IsSubmitting || IsLoading)"
                                          Title="è¿”å›åˆ°æœ€å¾Œä¸€ç­†å„²å­˜çš„è³‡æ–™" />
                }
                
                @* è¨˜éŒ„å°èˆªæŒ‰éˆ•ï¼ˆåœ¨å„²å­˜æŒ‰éˆ•å³å´ï¼Œåªåœ¨ç·¨è¼¯æ¨¡å¼é¡¯ç¤ºï¼‰ *@
                @* ç›®å‰æ­¤åŠŸèƒ½å­˜åœ¨å¾ˆå¤§çš„å•é¡Œï¼Œè©³æƒ…å¯ä»¥çœ‹ Readme_ä¸Šä¸‹ç­†å¤±æ•—æ¸¬è©¦ï¼Œç‚ºå°‡ä¾†å¦‚æœè¦ç¹¼çºŒæ¸¬è©¦å¯ä»¥å˜—è©¦ä¿®æ”¹*@
                @if (EnableNavigation && Entity != null && Entity.Id > 0)
                {
                    <GenericButtonComponent Text="ä¸Šç­†" 
                                          Variant="ButtonVariant.Green" 
                                          OnClick="HandlePrevious"
                                          IsDisabled="@(IsSubmitting || IsLoading)"
                                          Title="@GetPreviousButtonTitle()" />
                    
                    <GenericButtonComponent Text="ä¸‹ç­†" 
                                          Variant="ButtonVariant.Green"
                                          OnClick="HandleNext"
                                          IsDisabled="@(IsSubmitting || IsLoading)"
                                          Title="@GetNextButtonTitle()" />
                }
                
                @if (ShowPrintButton)
                {
                    <GenericButtonComponent Text="@PrintButtonText" 
                                          Variant="ButtonVariant.Blue" 
                                          OnClick="HandlePrint" 
                                          IsDisabled="@(IsSubmitting || IsLoading)" />
                }

                @if (ShowRefreshButton && Entity != null && Entity.Id > 0)
                {
                    <GenericButtonComponent Text="é‡æ•´" 
                                          Variant="ButtonVariant.Green" 
                                          OnClick="HandleRefresh" 
                                          IsDisabled="@(IsSubmitting || IsLoading)"
                                          Title="é‡æ–°è¼‰å…¥è³‡æ–™" />
                }
                
                @if (ShowDeleteButton && Entity != null && Entity.Id > 0 && IsEntityDeletable(Entity))
                {
                    <GenericButtonComponent Text="åˆªé™¤" 
                                          Variant="ButtonVariant.Red" 
                                          OnClick="DeleteEntityAsync" 
                                          IsDisabled="@(IsSubmitting || IsLoading)" />
                }
                

            </div>
        </div>
    </HeaderButtons>
    
    <BodyContent>
        @* è¡¨å–®é ‚éƒ¨å…§å®¹ï¼ˆåœ¨æ‰€æœ‰æ¬„ä½ä¹‹å‰ï¼‰ *@
        @if (FormHeaderContent != null)
        {
            <div class="form-header-content px-3 pt-3">
                <CascadingValue Value="@editContext">
                    @FormHeaderContent
                </CascadingValue>
            </div>
        }

        @* åŸºæœ¬è¡¨å–® *@
        @if (UseGenericForm && FormFields.Any())
        {
            <div class="edit-form-container px-3">
                <GenericFormComponent @key="@(Entity?.Id ?? 0)"
                                    TModel="TEntity"
                                    Model="@Entity"
                                    FieldDefinitions="@GetProcessedFormFields()"
                                    FieldSections="@FormSections"
                                    OnFieldChanged="@HandleFieldChanged" />
            </div>
        }

        @* è‡ªè¨‚è¡¨å–®å…§å®¹ *@
        @if (CustomFormContent != null)
        {
            <div class="custom-form-content px-3">
                <CascadingValue Value="@editContext">
                    @CustomFormContent
                </CascadingValue>
            </div>
        }

        @* è‡ªè¨‚æ¨¡çµ„ç³»çµ± *@
        @if (CustomModules != null && CustomModules.Any())
        {
            @foreach (var module in CustomModules.Where(m => m.IsVisible).OrderBy(m => m.Order))
            {
                @if (module.Content != null)
                {
                    <div class="@GetModuleCssClass(module) custom-module px-3">
                        @if (!string.IsNullOrWhiteSpace(module.Title))
                        {
                            <h6 class="mb-3 @module.TitleCssClass">@module.Title</h6>
                        }
                        <CascadingValue Value="@editContext">
                            @module.Content
                        </CascadingValue>
                    </div>
                }
            }
        }

        @* é¡å¤–å€æ®µ *@
        @if (AdditionalSections != null)
        {
            <div class="additional-sections px-3 pb-3">
                <CascadingValue Value="@editContext">
                    @AdditionalSections
                </CascadingValue>
            </div>
        }
    </BodyContent>
    
</BaseModalComponent>

@* é§å›ç¢ºèª Modal *@
<RejectConfirmModalComponent @ref="_rejectConfirmModal"
                            IsVisible="@_isRejectConfirmModalVisible"
                            IsVisibleChanged="@((bool value) => _isRejectConfirmModalVisible = value)"
                            Title="ç¢ºèªé§å›"
                            OnConfirm="@HandleRejectConfirm"
                            OnCancel="@HandleRejectCancel" />

</PagePermissionCheck>

@code {
    // ===== è‡ªè¨‚æ¨¡çµ„é¡åˆ¥ =====
    
    /// <summary>
    /// è‡ªè¨‚æ¨¡çµ„é¡åˆ¥ï¼Œç”¨æ–¼å®šç¾©å¯é‡è¤‡ä½¿ç”¨çš„é é¢æ¨¡çµ„
    /// </summary>
    public class CustomModule
    {
        /// <summary>
        /// æ¨¡çµ„æ¨™é¡Œï¼ˆå¯é¸ï¼‰
        /// </summary>
        public string? Title { get; set; }
        
        /// <summary>
        /// æ¨™é¡Œçš„ CSS é¡åˆ¥ï¼ˆå¯é¸ï¼Œä¾‹å¦‚ "text-primary fw-bold"ï¼‰
        /// </summary>
        public string? TitleCssClass { get; set; }
        
        /// <summary>
        /// æ¨¡çµ„å…§å®¹
        /// </summary>
        public RenderFragment? Content { get; set; }
        
        /// <summary>
        /// æ’åºé †åºï¼Œæ•¸å­—è¶Šå°è¶Šé å‰
        /// </summary>
        public int Order { get; set; } = 0;
        
        /// <summary>
        /// è‡ªè¨‚ CSS é¡åˆ¥
        /// </summary>
        public string? CssClass { get; set; }
        
        /// <summary>
        /// æ¨¡çµ„å”¯ä¸€è­˜åˆ¥ç¬¦ï¼ˆå¯é¸ï¼Œç”¨æ–¼é™¤éŒ¯æˆ–ç‰¹æ®Šè™•ç†ï¼‰
        /// </summary>
        public string? Id { get; set; }
        
        /// <summary>
        /// æ˜¯å¦é¡¯ç¤ºæ­¤æ¨¡çµ„
        /// </summary>
        public bool IsVisible { get; set; } = true;
    }
    
    // ===== åƒæ•¸ =====
    
    // é¡¯ç¤ºæ§åˆ¶
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    
    // æ¬Šé™æª¢æŸ¥åƒæ•¸
    [Parameter] public string RequiredPermission { get; set; } = "";
    
    // æ ¸å¿ƒåƒæ•¸
    [Parameter] public int? Id { get; set; }
    [Parameter] public EventCallback<int?> IdChanged { get; set; }
    [Parameter] public TEntity Entity { get; set; } = new();
    [Parameter] public TService Service { get; set; } = default!;
    
    // é é¢åŸºæœ¬è¨­å®š
    [Parameter] public string EntityName { get; set; } = "è³‡æ–™";
    [Parameter] public string EntityNamePlural { get; set; } = "è³‡æ–™";
    [Parameter] public string ModalTitle { get; set; } = string.Empty;
    [Parameter] public ModalSize Size { get; set; } = ModalSize.Desktop;
    
    // æŒ‰éˆ•è¨­å®š
    [Parameter] public string SaveButtonText { get; set; } = "å„²å­˜";
    [Parameter] public string CancelButtonText { get; set; } = "å–æ¶ˆ";
    [Parameter] public string PrintButtonText { get; set; } = "åˆ—å°";
    [Parameter] public bool ShowSaveButton { get; set; } = true;
    [Parameter] public bool ShowAddButton { get; set; } = true;
    [Parameter] public bool ShowRefreshButton { get; set; } = true;
    [Parameter] public bool ShowPrintButton { get; set; } = false;
    [Parameter] public bool ShowDeleteButton { get; set; } = true;
    [Parameter] public bool ShowReturnToLastButton { get; set; } = true;
    [Parameter] public string ReturnToLastButtonText { get; set; } = "è¿”å›ç·¨è¼¯";
    
    /// <summary>
    /// æ˜¯å¦å•Ÿç”¨è¨˜éŒ„å°èˆªåŠŸèƒ½ï¼ˆä¸Šä¸€ç­†/ä¸‹ä¸€ç­†æŒ‰éˆ•ï¼‰
    /// </summary>
    [Parameter] public bool EnableNavigation { get; set; } = true;
    
    /// <summary>
    /// æ˜¯å¦åœ¨å„²å­˜æˆåŠŸå¾Œè‡ªå‹•é—œé–‰ Modalï¼ˆé è¨­ç‚º falseï¼Œä¸é—œé–‰ï¼‰
    /// </summary>
    [Parameter] public bool CloseOnSave { get; set; } = false;
    
    // è‡ªè¨‚æ“ä½œæŒ‰éˆ•å€åŸŸï¼ˆé¡¯ç¤ºåœ¨é ‚éƒ¨æŒ‰éˆ•åˆ—çš„æœ€å·¦å´ï¼‰
    [Parameter] public RenderFragment? CustomActionButtons { get; set; }
    
    // è‡ªè¨‚æŒ‰éˆ•å€åŸŸï¼ˆé¡¯ç¤ºåœ¨ Modal Header ä¸­ï¼‰
    [Parameter] public RenderFragment? CustomButtons { get; set; }
    
    // è¡¨å–®è¨­å®š
    [Parameter] public bool UseGenericForm { get; set; } = true;
    [Parameter] public List<FormFieldDefinition> FormFields { get; set; } = new();
    [Parameter] public Dictionary<string, string> FormSections { get; set; } = new();
    
    // AutoComplete æ™ºèƒ½é å¡«æ”¯æ´
    [Parameter] public Dictionary<string, Func<string, Dictionary<string, object?>>>? AutoCompletePrefillers { get; set; }
    [Parameter] public Dictionary<string, object>? ModalManagers { get; set; }
    
    // AutoComplete è‡ªå‹•æœå°‹é›†åˆæ”¯æ´
    [Parameter] public Dictionary<string, IEnumerable<object>>? AutoCompleteCollections { get; set; }
    [Parameter] public Dictionary<string, string>? AutoCompleteDisplayProperties { get; set; }
    [Parameter] public Dictionary<string, string>? AutoCompleteValueProperties { get; set; }
    [Parameter] public Dictionary<string, int>? AutoCompleteMaxResults { get; set; }
    
    // è‡ªè¨‚å…§å®¹
    [Parameter] public RenderFragment? FormHeaderContent { get; set; }  // è¡¨å–®é ‚éƒ¨å…§å®¹ï¼ˆåœ¨æ¬„ä½ä¹‹å‰ï¼‰
    [Parameter] public RenderFragment? CustomFormContent { get; set; }
    [Parameter] public RenderFragment? AdditionalSections { get; set; }
    
    // è‡ªè¨‚æ¨¡çµ„ç³»çµ±
    [Parameter] public List<CustomModule> CustomModules { get; set; } = new();
    
    // å§”æ´¾åƒæ•¸ - è³‡æ–™æ“ä½œ
    [Parameter] public Func<Task<TEntity?>>? DataLoader { get; set; }
    [Parameter] public Func<TEntity, Task<bool>>? SaveHandler { get; set; }
    [Parameter] public Func<Task>? AdditionalDataLoader { get; set; }
    
    // é€šç”¨Saveç›¸é—œåƒæ•¸
    [Parameter] public Func<TEntity, Task<bool>>? CustomValidator { get; set; }
    [Parameter] public Func<TEntity, Task>? BeforeSave { get; set; }
    [Parameter] public Func<TEntity, Task>? AfterSave { get; set; }
    [Parameter] public bool UseGenericSave { get; set; } = false;
    [Parameter] public string SaveSuccessMessage { get; set; } = "å„²å­˜æˆåŠŸ";
    [Parameter] public string SaveFailureMessage { get; set; } = "å„²å­˜å¤±æ•—";
    
    // å§”æ´¾åƒæ•¸ - äº‹ä»¶è™•ç†
    [Parameter] public EventCallback OnSaveSuccess { get; set; }
    [Parameter] public EventCallback OnSaveFailure { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback OnPrint { get; set; }
    [Parameter] public Func<(string PropertyName, object? Value), Task>? OnFieldChanged { get; set; }
    
    /// <summary>
    /// å¯¦é«”è¼‰å…¥å®Œæˆäº‹ä»¶ï¼ˆå°èˆªåˆ‡æ›æ™‚è§¸ç™¼ï¼‰
    /// åƒæ•¸ç‚ºå·²è¼‰å…¥çš„å¯¦é«” IDï¼Œç”¨æ–¼é€šçŸ¥çˆ¶çµ„ä»¶é‡æ–°è¼‰å…¥ç›¸é—œè³‡æ–™ï¼ˆå¦‚æ˜ç´°ï¼‰
    /// </summary>
    [Parameter] public EventCallback<int> OnEntityLoaded { get; set; }
    
    // === é€šç”¨åˆªé™¤åŠŸèƒ½ç›¸é—œåƒæ•¸ ===
    [Parameter] public Func<TEntity, string> GetEntityDisplayName { get; set; } = entity => entity.Id.ToString();
    [Parameter] public string DeleteSuccessMessage { get; set; } = "";
    [Parameter] public string DeleteConfirmMessage { get; set; } = "";
    [Parameter] public Func<TEntity, bool>? CanDelete { get; set; }
    [Parameter] public bool EnableSystemDataProtection { get; set; } = true;
    [Parameter] public Func<TEntity, Task<bool>>? CustomDeleteHandler { get; set; }
    
    // è¨Šæ¯è¨­å®š
    [Parameter] public string LoadingMessage { get; set; } = "è¼‰å…¥è³‡æ–™ä¸­...";
    
    // ===== é€šç”¨ç‹€æ…‹è¨Šæ¯åƒæ•¸ =====
    
    /// <summary>
    /// é¡¯ç¤ºç‹€æ…‹è¨Šæ¯ï¼ˆå¯ç”¨æ–¼å¯©æ ¸ç‹€æ…‹ã€è­¦å‘Šã€æç¤ºç­‰ä»»ä½•æƒ…å¢ƒï¼‰
    /// </summary>
    [Parameter] public string? StatusMessage { get; set; }
    
    /// <summary>
    /// ç‹€æ…‹è¨Šæ¯çš„å¾½ç« é¡è‰²è®Šé«”
    /// </summary>
    [Parameter] public BadgeVariant StatusBadgeVariant { get; set; } = BadgeVariant.Info;
    
    /// <summary>
    /// ç‹€æ…‹è¨Šæ¯çš„åœ–ç¤ºé¡åˆ¥
    /// </summary>
    [Parameter] public string StatusIconClass { get; set; } = "fas fa-info-circle";
    
    /// <summary>
    /// æ˜¯å¦é¡¯ç¤ºç‹€æ…‹è¨Šæ¯ï¼ˆé è¨­ç‚º falseï¼‰
    /// </summary>
    [Parameter] public bool ShowStatusMessage { get; set; } = false;
    
    /// <summary>
    /// å‹•æ…‹å–å¾—ç‹€æ…‹è¨Šæ¯çš„å‡½å¼ï¼ˆå„ªå…ˆæ–¼ StatusMessageï¼‰
    /// ç”¨æ–¼å¯©æ ¸ç‹€æ…‹ç­‰éœ€è¦å‹•æ…‹è¨ˆç®—çš„æƒ…å¢ƒ
    /// </summary>
    [Parameter] public Func<Task<(string Message, BadgeVariant Variant, string IconClass)?>>? GetStatusMessage { get; set; }
    
    // ===== å¯©æ ¸åŠŸèƒ½åƒæ•¸ï¼ˆå‘ä¸‹ç›¸å®¹ï¼Œæ•´åˆåˆ°ç‹€æ…‹è¨Šæ¯ç³»çµ±ï¼‰ =====
    
    [Parameter] public bool ShowApprovalSection { get; set; } = false;
    [Parameter] public string ApprovalPermission { get; set; } = string.Empty;
    [Parameter] public Func<Task<bool>>? OnApprove { get; set; }
    [Parameter] public Func<Task<bool>>? OnReject { get; set; }
    
    // é§å›ç¢ºèª Modal ç›¸é—œåƒæ•¸
    [Parameter] public Func<string, Task<bool>>? OnRejectWithReason { get; set; }
    // ç§»é™¤ GetApprovalStatusï¼Œæ”¹ç”¨ GetStatusMessage
    
    // ===== å…§éƒ¨ç‹€æ…‹ =====
    
    private bool IsLoading { get; set; } = false;
    private bool IsSubmitting { get; set; } = false;
    private string ErrorMessage { get; set; } = string.Empty;
    private int? _lastId = null;
    private bool _lastVisible = false;
    private readonly SemaphoreSlim _loadingSemaphore = new(1, 1);
    private bool _isNavigating = false;  // æ¨™è¨˜æ˜¯å¦æ­£åœ¨åŸ·è¡Œå°èˆªæ“ä½œ
    private EditContext? editContext;
    
    // å¯©æ ¸ç‹€æ…‹
    private bool IsApproving { get; set; } = false;
    private bool IsRejecting { get; set; } = false;
    
    // é§å›ç¢ºèª Modal
    private RejectConfirmModalComponent? _rejectConfirmModal;
    private bool _isRejectConfirmModalVisible = false;
    
    // ç‹€æ…‹è¨Šæ¯å¿«å–
    private string? _cachedStatusMessage;
    private BadgeVariant _cachedStatusVariant = BadgeVariant.Info;
    private string _cachedStatusIcon = "fas fa-info-circle";
    
    // AutoComplete æœå°‹é—œéµå­—è¿½è¹¤
    private readonly Dictionary<string, string> _lastSearchTerms = new();
    
    // AutoComplete ç‰ˆæœ¬è™Ÿæ©Ÿåˆ¶ - ç”¨æ–¼å¼·åˆ¶åˆ·æ–° AutoComplete æ¬„ä½é¡¯ç¤º
    private int _autoCompleteVersion = 0;
    
    // è¨˜éŒ„å°èˆªç‹€æ…‹
    private int? _currentId = null;  // å…§éƒ¨è¿½è¹¤çš„ç•¶å‰ IDï¼ˆæ”¯æ´å°èˆªæ™‚çš„ ID è®Šæ›´ï¼‰
    private int? _previousId = null;
    private int? _nextId = null;
    private int? _firstId = null;  // ç¬¬ä¸€ç­†è¨˜éŒ„çš„ ID
    private int? _lastRecordId = null;   // æœ€å¾Œä¸€ç­†è¨˜éŒ„çš„ ID
    
    // æ–°å¢æ¨¡å¼æ§åˆ¶
    private bool _stayInAddMode = false;  // æ¨™è¨˜æ˜¯å¦åœ¨å„²å­˜å¾Œä¿æŒæ–°å¢æ¨¡å¼ï¼ˆç”¨æ–¼ã€Œæ–°å¢ã€æŒ‰éˆ•ï¼‰
    
    // ===== Modal å°ºå¯¸åˆ—èˆ‰ =====
    
    public enum ModalSize
    {
        Small,
        Default,
        Large,
        ExtraLarge,
        Desktop  // æ–°å¢æ¡Œé¢å°ºå¯¸ï¼Œæ›´å¤§æ›´é©åˆé›»è…¦è¢å¹•
    }
    
    // ===== ç‹€æ…‹å¾½ç« é¡è‰²åˆ—èˆ‰ =====
    
    /// <summary>
    /// Bootstrap å¾½ç« é¡è‰²è®Šé«”
    /// </summary>
    public enum BadgeVariant
    {
        Primary,    // è—è‰² - ä¸»è¦
        Secondary,  // ç°è‰² - æ¬¡è¦
        Success,    // ç¶ è‰² - æˆåŠŸ
        Danger,     // ç´…è‰² - å±éšª/éŒ¯èª¤
        Warning,    // é»ƒè‰² - è­¦å‘Š
        Info,       // æ·ºè—è‰² - è³‡è¨Šï¼ˆé è¨­ï¼‰
        Light,      // æ·ºè‰²
        Dark        // æ·±è‰²
    }
    
    // ===== ç”Ÿå‘½é€±æœŸæ–¹æ³• =====
    
    protected override Task OnInitializedAsync()
    {
        // åˆå§‹åŒ– EditContext
        editContext = new EditContext(Entity);
        return Task.CompletedTask;
    }
    
    protected override async Task OnParametersSetAsync()
    {
        // âš¡ æ—©æœŸè¿”å›ï¼šå¦‚æœ Modal ä¸€ç›´é—œé–‰ä¸”åƒæ•¸æœªè®Šæ›´ï¼Œç›´æ¥è¿”å›
        // é€™å¯ä»¥é¿å…å¤§é‡ä¸å¿…è¦çš„ OnParametersSetAsync è§¸ç™¼ï¼ˆå°¤å…¶æ˜¯åµŒå¥—å­ Modalï¼‰
        if (!IsVisible && !_lastVisible && _lastId == Id && !_isNavigating)
        {
            return;  // ç„¡è®Šæ›´ï¼Œè·³éæ‰€æœ‰è™•ç†
        }
        
        // ğŸ”‘ é—œéµä¿®å¾©ï¼šå¦‚æœ _currentId å­˜åœ¨ä¸”èˆ‡å‚³å…¥çš„ Id ä¸åŒï¼Œ
        // èªªæ˜æ˜¯å°èˆªå¾Œçš„ç‹€æ…‹ï¼Œä¸æ‡‰è©²è¢«å¤–éƒ¨åƒæ•¸è¦†è“‹ï¼ˆä¾‹å¦‚çˆ¶çµ„ä»¶åˆ·æ–°æ™‚å‚³å…¥èˆŠ IDï¼‰
        if (_currentId.HasValue && _currentId != Id && !_isNavigating && IsVisible)
        {
            // ä¿è­·å°èˆªç‹€æ…‹ï¼Œä¸»å‹•åŒæ­¥å›çˆ¶çµ„ä»¶ï¼Œç¢ºä¿çˆ¶çµ„ä»¶çŸ¥é“ç•¶å‰çš„ ID
            if (IdChanged.HasDelegate)
            {
                await IdChanged.InvokeAsync(_currentId);
            }
            
            // åŒæ­¥ _lastIdï¼Œé¿å…è§¸ç™¼é‡æ–°è¼‰å…¥
            _lastId = _currentId;
            
            // è·³éå¾ŒçºŒé‚è¼¯ï¼Œä¿æŒç•¶å‰ç‹€æ…‹ä¸è®Š
            return;
        }
        
        // åŒæ­¥ _currentId èˆ‡ Idï¼ˆé™¤éæ­£åœ¨å°èˆªä¸­ï¼‰
        if (!_isNavigating)
        {
            _currentId = Id;
        }
        
        // âš¡ å„ªåŒ–ï¼šåªåœ¨ Modal çœŸæ­£é–‹å•Ÿæˆ–åƒæ•¸è®Šæ›´æ™‚æ‰è¼‰å…¥ï¼Œéæ¿¾ç„¡æ•ˆå‘¼å«
        // é€™å¯ä»¥å¤§å¹…æ¸›å°‘ä¸å¿…è¦çš„æ¸²æŸ“ï¼ˆå¾ 4-21 æ¬¡é™åˆ° 1-2 æ¬¡ï¼‰
        if (IsVisible)
        {
            if (!_lastVisible)
            {
                // Modal å¾é—œé–‰è®Šæˆé–‹å•Ÿï¼ˆFalse â†’ Trueï¼‰
                _lastVisible = true;
                _lastId = Id;
                await LoadAllData();
            }
            else if (_lastId != Id)
            {
                // Modal å·²æ‰“é–‹ä½† Id è®Šæ›´ï¼ˆç·¨è¼¯ä¸åŒè¨˜éŒ„æˆ–å°èˆªï¼‰
                _lastId = Id;
                await LoadAllData();
            }
            // else: Modal å·²é–‹å•Ÿä¸” Id æœªè®Šï¼Œè·³éè¼‰å…¥ï¼ˆé€™æ˜¯ç„¡æ•ˆå‘¼å«ï¼‰
        }
        else
        {
            // Modal é—œé–‰
            if (_lastVisible)
            {
                // Modal å¾é–‹å•Ÿè®Šæˆé—œé–‰ï¼ˆTrue â†’ Falseï¼‰
                _lastVisible = false;
                ResetState();
            }
            // else: Modal ä»ç„¶é—œé–‰ï¼ˆFalse â†’ Falseï¼‰ï¼Œé€™æ˜¯ç„¡æ•ˆå‘¼å«ï¼Œä¸åŸ·è¡Œä»»ä½•æ“ä½œ
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsVisible && firstRender)
        {
            await SetupTabNavigationAsync();
        }
    }
    
    // ===== Tab å°èˆªè™•ç† =====
    
    /// <summary>
    /// è¨­ç½® Tab éµå°èˆªï¼Œç•¶ç„¦é»åœ¨æŒ‰éˆ•ä¸Šæ™‚è‡ªå‹•è·³åˆ°ä¸‹ä¸€å€‹éæŒ‰éˆ•å…ƒç´ 
    /// </summary>
    private async Task SetupTabNavigationAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("setupButtonTabNavigation");
        }
        catch (Exception ex)
        {
            LogError("SetupTabNavigation", ex);
        }
    }
    
    /// <summary>
    /// æ¸…ç† Tab éµå°èˆªäº‹ä»¶ç›£è½å™¨
    /// </summary>
    private async Task CleanupTabNavigationAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("cleanupButtonTabNavigation");
        }
        catch (Exception ex)
        {
            LogError("CleanupTabNavigation", ex);
        }
    }
    
    // ===== ESC éµè™•ç† =====
    
    // ESC éµç›£è½ã€è™•ç†å’Œæ¸…ç†æ–¹æ³•å·²ç§»é™¤ï¼Œç”± BaseModalComponent è‡ªå‹•è™•ç†

    
    // ===== è³‡æ–™è¼‰å…¥æ–¹æ³• =====
    
    private async Task LoadAllData()
    {
        await _loadingSemaphore.WaitAsync();
        try
        {
            IsLoading = true;
            ErrorMessage = string.Empty;
            StateHasChanged();
            
            // è¼‰å…¥é¡å¤–è³‡æ–™ï¼ˆå¦‚é¸é …åˆ—è¡¨ï¼‰
            if (AdditionalDataLoader != null)
            {
                await AdditionalDataLoader();
            }
            
            // è¼‰å…¥å¯¦é«”è³‡æ–™
            //  é—œéµä¿®å¾©ï¼šå¦‚æœæ­£åœ¨å°èˆªï¼Œè·³é DataLoaderï¼ˆEntity å·²ç”± NavigateToRecordAsync ç›´æ¥è¼‰å…¥ï¼‰
            if (!_isNavigating && DataLoader != null)
            {
                var loadedEntity = await DataLoader();
                if (loadedEntity != null)
                {
                    Entity = loadedEntity;
                    // é‡æ–°å»ºç«‹ EditContext
                    editContext = new EditContext(Entity);
                    
                    // æ–¹æ¡ˆä¸‰ï¼šä¸»å‹•æ›´æ–°æ‰€æœ‰ ActionButtonsï¼Œç¢ºä¿æŒ‰éˆ•ç‹€æ…‹èˆ‡å¯¦é«”è³‡æ–™åŒæ­¥
                    UpdateAllActionButtons();
                }
            }
            else if (_isNavigating)
            {
                // å°èˆªæ¨¡å¼ï¼šEntity å·²ç”± NavigateToRecordAsync è¼‰å…¥ï¼Œåªéœ€æ›´æ–° ActionButtons
                UpdateAllActionButtons();
            }
            
            // è¼‰å…¥ç‹€æ…‹è¨Šæ¯è³‡æ–™
            await LoadStatusMessageData();
            
            // è¼‰å…¥å°èˆªç‹€æ…‹
            // æ–°å¢æ¨¡å¼ï¼šåªè¼‰å…¥ _lastRecordIdï¼ˆç”¨æ–¼è¿”å›ç·¨è¼¯æŒ‰éˆ•ï¼‰
            // ç·¨è¼¯æ¨¡å¼ï¼šè¼‰å…¥å®Œæ•´å°èˆªè³‡è¨Šï¼ˆä¸Šä¸€ç­†ã€ä¸‹ä¸€ç­†ç­‰ï¼‰
            await LoadNavigationStateAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}";
            LogError("LoadAllData", ex);
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
            _loadingSemaphore.Release();
        }
    }
    
    /// <summary>
    /// è¼‰å…¥ç‹€æ…‹è¨Šæ¯è³‡æ–™ï¼ˆæ•´åˆå¯©æ ¸å’Œå…¶ä»–æ‰€æœ‰ç‹€æ…‹è¨Šæ¯ï¼‰
    /// </summary>
    private async Task LoadStatusMessageData()
    {
        try
        {
            if (!ShouldShowStatusMessage() || Entity == null || Entity.Id <= 0)
                return;

            // å„ªå…ˆä½¿ç”¨å‹•æ…‹å–å¾—å‡½å¼
            if (GetStatusMessage != null)
            {
                var result = await GetStatusMessage();
                if (result.HasValue)
                {
                    _cachedStatusMessage = result.Value.Message;
                    _cachedStatusVariant = result.Value.Variant;
                    _cachedStatusIcon = result.Value.IconClass;
                }
            }
            // å…¶æ¬¡ä½¿ç”¨éœæ…‹è¨­å®šå€¼
            else if (!string.IsNullOrEmpty(StatusMessage))
            {
                _cachedStatusMessage = StatusMessage;
                _cachedStatusVariant = StatusBadgeVariant;
                _cachedStatusIcon = StatusIconClass;
            }
        }
        catch (Exception ex)
        {
            LogError("LoadStatusMessageData", ex);
            // ä¸æ‹‹å‡ºä¾‹å¤–ï¼Œé¿å…å½±éŸ¿ä¸»è¦è³‡æ–™è¼‰å…¥
        }
    }
    
    /// <summary>
    /// é‡æ–°è¼‰å…¥å¯¦é«”è³‡æ–™ï¼ˆå…¬å…±æ–¹æ³•ï¼Œè§£æ±ºçµ„ä»¶åƒæ•¸ä¸æ‡‰åœ¨å¤–éƒ¨è¨­ç½®çš„å•é¡Œï¼‰
    /// </summary>
    public async Task RefreshEntityAsync()
    {
        if (DataLoader != null && Entity != null && Entity.Id > 0)
        {
            var reloadedEntity = await DataLoader();
            if (reloadedEntity != null)
            {
                Entity = reloadedEntity;
                editContext = new EditContext(Entity);
                await LoadStatusMessageData(); // é‡æ–°è¼‰å…¥ç‹€æ…‹è¨Šæ¯
                StateHasChanged();
            }
        }
    }
    
    /// <summary>
    /// é‡æ–°è¼‰å…¥é¡å¤–è³‡æ–™ä¸¦åˆ·æ–° AutoComplete æ¬„ä½é¡¯ç¤º
    /// ç•¶å­ Modal ç·¨è¼¯ä¸¦å„²å­˜å¾Œï¼Œå‘¼å«æ­¤æ–¹æ³•ä»¥æ›´æ–° AutoComplete é¸é …å’Œé¡¯ç¤ºå…§å®¹
    /// </summary>
    public async Task RefreshAutoCompleteFieldsAsync()
    {
        try
        {
            // 1. é‡æ–°è¼‰å…¥é¡å¤–è³‡æ–™ï¼ˆæ›´æ–° AutoCompleteCollectionsï¼‰
            if (AdditionalDataLoader != null)
            {
                await AdditionalDataLoader();
            }
            
            // 2. éå¢ç‰ˆæœ¬è™Ÿï¼Œå¼·åˆ¶ Blazor é‡æ–°å»ºç«‹ GenericFormComponent
            _autoCompleteVersion++;
            
            // 3. æ›´æ–°æ‰€æœ‰ ActionButtons ç‹€æ…‹
            UpdateAllActionButtons();
            
            // 4. é€šçŸ¥ UI æ›´æ–°
            StateHasChanged();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            LogError("RefreshAutoCompleteFields", ex);
        }
    }
    
    // ===== äº‹ä»¶è™•ç†æ–¹æ³• =====
    
    private async Task HandleSave()
    {
        if (IsSubmitting) return;
        
        try
        {
            IsSubmitting = true;
            StateHasChanged();
            
            if (Entity == null)
            {
                await ShowErrorMessage("å¯¦é«”è³‡æ–™ä¸å­˜åœ¨");
                return;
            }
            
            bool success;
            
            if (UseGenericSave)
            {
                success = await GenericSave(Entity);
            }
            else if (SaveHandler != null)
            {
                success = await SaveHandler(Entity);
            }
            else
            {
                await ShowErrorMessage("æœªè¨­å®šå„²å­˜è™•ç†ç¨‹åº");
                return;
            }
            
            if (success)
            {
                await ShowSuccessMessage(SaveSuccessMessage);
                
                //  é—œéµä¿®å¾©ï¼šæª¢æ¸¬å¾æ–°å¢æ¨¡å¼è½‰ç‚ºç·¨è¼¯æ¨¡å¼
                // ç•¶å„²å­˜æˆåŠŸä¸”æ˜¯å¾æ–°å¢ï¼ˆId ç‚º nullï¼‰è®Šç‚ºç·¨è¼¯ï¼ˆEntity.Id > 0ï¼‰æ™‚
                // è‡ªå‹•æ›´æ–° Id åƒæ•¸ä¸¦é‡æ–°è¼‰å…¥æ‰€æœ‰è³‡æ–™ï¼Œç¢ºä¿ Modal ç‹€æ…‹æ­£ç¢º
                bool wasNewRecord = !Id.HasValue;
                
                if (wasNewRecord && Entity != null && Entity.Id > 0)
                {
                    // ğŸ”‘ æª¢æŸ¥æ˜¯å¦è¦ä¿æŒæ–°å¢æ¨¡å¼
                    // æ¢ä»¶1ï¼šé€éã€Œæ–°å¢ã€æŒ‰éˆ•è§¸ç™¼ (_stayInAddMode = true)
                    // æ¢ä»¶2ï¼šåœ¨æ–°å¢æ¨¡å¼ä¸‹ä¸”å•Ÿç”¨äº† ShowAddButtonï¼ˆIndex é é¢å ´æ™¯ï¼‰
                    bool shouldStayInAddMode = _stayInAddMode || (ShowAddButton && wasNewRecord);
                    
                    if (shouldStayInAddMode)
                    {
                        // ä¿æŒæ–°å¢æ¨¡å¼ï¼šé‡ç½®æ——æ¨™ä¸¦é‡æ–°è¼‰å…¥æ–°å¢è¡¨å–®
                        _stayInAddMode = false;
                        
                        // è§¸ç™¼ OnSaveSuccessï¼ˆè®“çˆ¶çµ„ä»¶åˆ·æ–°åˆ—è¡¨ï¼‰
                        if (OnSaveSuccess.HasDelegate)
                        {
                            await OnSaveSuccess.InvokeAsync();
                        }
                        
                        // ğŸ”‘ é—œéµä¿®æ­£ï¼šé‡ç½®æ‰€æœ‰ç‹€æ…‹ï¼Œå¦å‰‡ HandleAddClick æœƒå› ç‚º IsSubmitting/IsLoading è€Œç›´æ¥è¿”å›
                        IsSubmitting = false;
                        IsLoading = false;
                        StateHasChanged();
                        
                        // é‡æ–°è§¸ç™¼æ–°å¢æµç¨‹ï¼ˆæ¸…ç©ºè¡¨å–®ã€ç”¢ç”Ÿæ–° Codeï¼‰
                        await HandleAddClick();
                        return; // æå‰è¿”å›ï¼Œä¸åŸ·è¡Œå¾ŒçºŒçš„ç·¨è¼¯æ¨¡å¼é‚è¼¯
                    }
                    else
                    {
                        // é è¨­è¡Œç‚ºï¼šè½‰ç‚ºç·¨è¼¯æ¨¡å¼
                        //  é—œéµï¼šå…ˆæ›´æ–° _lastIdï¼Œé¿å…è§¸ç™¼ OnParametersSetAsync çš„é‡è¤‡è¼‰å…¥
                        _lastId = Entity.Id;
                        Id = Entity.Id;
                        
                        //  ä¿®å¾©ï¼šè§¸ç™¼ IdChanged äº‹ä»¶ï¼Œæ›´æ–°çˆ¶çµ„ä»¶çš„ç¶å®šåƒæ•¸ï¼ˆå¦‚ PurchaseOrderIdï¼‰
                        // é€™ç¢ºä¿çˆ¶çµ„ä»¶å¯ä»¥æ­£ç¢ºåˆ¤æ–·æ¨¡å¼ï¼ˆæ–°å¢/ç·¨è¼¯ï¼‰
                        if (IdChanged.HasDelegate)
                        {
                            await IdChanged.InvokeAsync(Entity.Id);
                        }
                        
                        // é‡æ–°è¼‰å…¥æ‰€æœ‰è³‡æ–™ï¼ˆåŒ…å«æ˜ç´°ã€ç‹€æ…‹è¨Šæ¯ã€å°èˆªç‹€æ…‹ç­‰ï¼‰
                        // é€™ç¢ºä¿äº†ï¼š
                        // 1. Modal æ¨™é¡Œå¾ã€Œæ–°å¢ã€è®Šç‚ºã€Œç·¨è¼¯ã€
                        // 2. æ˜ç´°è³‡æ–™æ­£ç¢ºè¼‰å…¥ä¸¦é¡¯ç¤ºé–å®šç‹€æ…‹
                        // 3. å¯©æ ¸æŒ‰éˆ•ã€åˆªé™¤æŒ‰éˆ•ç­‰æ­£ç¢ºé¡¯ç¤º
                        // 4. ç›¸é—œå–®æ“šçš„æ“ä½œæŒ‰éˆ•å¯ä»¥æ­£å¸¸ä½¿ç”¨
                        await LoadAllData();
                    }
                }
                
                if (OnSaveSuccess.HasDelegate)
                {
                    await OnSaveSuccess.InvokeAsync();
                }
                
                // æ ¹æ“š CloseOnSave åƒæ•¸æ±ºå®šæ˜¯å¦é—œé–‰ Modal
                if (CloseOnSave)
                {
                    await CloseModal();
                }
            }
            else
            {
                if (OnSaveFailure.HasDelegate)
                {
                    await OnSaveFailure.InvokeAsync();
                }
            }
        }
        catch (Exception ex)
        {
            await ShowErrorMessage($"å„²å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            LogError("HandleSave", ex);
            
            if (OnSaveFailure.HasDelegate)
            {
                await OnSaveFailure.InvokeAsync();
            }
        }
        finally
        {
            IsSubmitting = false;
            StateHasChanged();
        }
    }
    
    private async Task HandleCancel()
    {
        try
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }
            
            await CloseModal();
        }
        catch (Exception ex)
        {
            LogError("HandleCancel", ex);
        }
    }
    
    private async Task HandlePrint()
    {
        if (OnPrint.HasDelegate)
        {
            await OnPrint.InvokeAsync();
        }
    }
    
    private async Task HandleRefresh()
    {
        if (IsLoading || IsSubmitting) return;
        
        try
        {
            await LoadAllData();
        }
        catch (Exception ex)
        {
            await ShowErrorMessage($"é‡æ–°è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            LogError("HandleRefresh", ex);
        }
    }
    
    private async Task HandleApprove()
    {
        if (OnApprove == null || IsApproving || IsRejecting) return;
        
        try
        {
            IsApproving = true;
            StateHasChanged();
            
            var success = await OnApprove();
            
            if (success)
            {
                await ShowSuccessMessage("å¯©æ ¸é€šé");
                
                // é‡æ–°è¼‰å…¥å¯¦é«”è³‡æ–™ä»¥ç¢ºä¿ç‹€æ…‹åŒæ­¥
                await RefreshEntityAsync();
            }
            else
            {
                await ShowErrorMessage("å¯©æ ¸é€šéå¤±æ•—");
            }
        }
        catch (Exception ex)
        {
            await ShowErrorMessage($"å¯©æ ¸é€šéæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            LogError("HandleApprove", ex);
        }
        finally
        {
            IsApproving = false;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// é–‹å•Ÿé§å›ç¢ºèª Modal
    /// </summary>
    private void OpenRejectConfirmModal()
    {
        if (IsApproving || IsRejecting) return;
        
        _isRejectConfirmModalVisible = true;
        StateHasChanged();
    }
    
    /// <summary>
    /// è™•ç†é§å›ç¢ºèª Modal çš„ç¢ºèªäº‹ä»¶
    /// </summary>
    private async Task HandleRejectConfirm(string rejectReason)
    {
        try
        {
            IsRejecting = true;
            StateHasChanged();
            
            bool success;
            
            // å„ªå…ˆä½¿ç”¨å¸¶é§å›åŸå› çš„å§”æ´¾
            if (OnRejectWithReason != null)
            {
                success = await OnRejectWithReason(rejectReason);
            }
            // å‘ä¸‹ç›¸å®¹ï¼šä½¿ç”¨åŸæœ‰çš„ OnReject å§”æ´¾
            else if (OnReject != null)
            {
                success = await OnReject();
            }
            else
            {
                await ShowErrorMessage("æœªè¨­å®šé§å›è™•ç†ç¨‹åº");
                return;
            }
            
            if (success)
            {
                // æˆåŠŸè¨Šæ¯ç”±å…·é«”çš„è™•ç†æ–¹æ³•ï¼ˆå¦‚ HandlePurchaseOrderRejectWithReasonï¼‰é¡¯ç¤º
                // é€™è£¡åªé‡æ–°è¼‰å…¥å¯¦é«”è³‡æ–™ä»¥ç¢ºä¿ç‹€æ…‹åŒæ­¥
                await RefreshEntityAsync();
            }
            else
            {
                // å¤±æ•—è¨Šæ¯ä¹Ÿç”±å…·é«”çš„è™•ç†æ–¹æ³•é¡¯ç¤ºï¼Œé€™è£¡ä¸é‡è¤‡é¡¯ç¤º
                // await ShowErrorMessage("å¯©æ ¸é§å›å¤±æ•—");
            }
        }
        catch (Exception ex)
        {
            await ShowErrorMessage($"å¯©æ ¸é§å›æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            LogError("HandleRejectConfirm", ex);
        }
        finally
        {
            IsRejecting = false;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// è™•ç†é§å›ç¢ºèª Modal çš„å–æ¶ˆäº‹ä»¶
    /// </summary>
    private Task HandleRejectCancel()
    {
        _isRejectConfirmModalVisible = false;
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    /// <summary>
    /// è™•ç†é§å›ï¼ˆèˆŠæ–¹æ³•ï¼Œä¿ç•™ä»¥å‘ä¸‹ç›¸å®¹ï¼Œä½†ç¾åœ¨æœƒé–‹å•Ÿç¢ºèª Modalï¼‰
    /// </summary>
    private async Task HandleReject()
    {
        // æ–°ç‰ˆæœ¬ï¼šé–‹å•Ÿé§å›ç¢ºèª Modal
        OpenRejectConfirmModal();
        await Task.CompletedTask;
    }
    

    
    private async Task CloseModal()
    {
        await CleanupTabNavigationAsync();
        await SetVisible(false);
    }
    
    private async Task SetVisible(bool visible)
    {
        if (IsVisible != visible)
        {
            await IsVisibleChanged.InvokeAsync(visible);
        }
    }
    
    // ===== è¼”åŠ©æ–¹æ³• =====
    
    /// <summary>
    /// æª¢æŸ¥å¯¦é«”æ˜¯å¦å·²å¯©æ ¸é€šé
    /// </summary>
    private bool IsEntityApproved()
    {
        if (Entity == null) return false;
        
        // æª¢æŸ¥å¯¦é«”æ˜¯å¦æœ‰ IsApproved å±¬æ€§
        var propertyInfo = typeof(TEntity).GetProperty("IsApproved");
        if (propertyInfo != null && propertyInfo.PropertyType == typeof(bool))
        {
            var isApproved = (bool?)propertyInfo.GetValue(Entity);
            return isApproved == true;
        }
        
        return false;
    }
    
    /// <summary>
    /// è™•ç†å·²å¯©æ ¸å¯¦é«”çš„å®ŒæˆæŒ‰éˆ•é»æ“Šäº‹ä»¶
    /// </summary>
    private async Task HandleApprovedEntityComplete()
    {
        try
        {
            // è§¸ç™¼ OnSaveSuccess äº‹ä»¶ä»¥é€šçŸ¥çˆ¶çµ„ä»¶åˆ·æ–°è³‡æ–™
            if (OnSaveSuccess.HasDelegate)
            {
                await OnSaveSuccess.InvokeAsync();
            }
            
            // é—œé–‰ Modal
            await CloseModal();
        }
        catch (Exception ex)
        {
            await ShowErrorMessage($"å®Œæˆæ“ä½œæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            LogError("HandleApprovedEntityComplete", ex);
        }
    }
    
    private string GetModalTitle()
    {
        if (!string.IsNullOrEmpty(ModalTitle))
            return ModalTitle;
            
        return Id.HasValue ? $"ç·¨è¼¯{EntityName}" : $"æ–°å¢{EntityName}";
    }
    
    private string GetModalIcon()
    {
        return Id.HasValue ? "fas fa-edit" : "fas fa-plus";
    }
    
    /// <summary>
    /// è½‰æ› ModalSize åˆ° BaseModalComponent.ModalSize
    /// </summary>
    private BaseModalComponent.ModalSize ConvertToBaseModalSize(ModalSize size)
    {
        return size switch
        {
            ModalSize.Small => BaseModalComponent.ModalSize.Small,
            ModalSize.Default => BaseModalComponent.ModalSize.Default,
            ModalSize.Large => BaseModalComponent.ModalSize.Large,
            ModalSize.ExtraLarge => BaseModalComponent.ModalSize.ExtraLarge,
            ModalSize.Desktop => BaseModalComponent.ModalSize.Desktop,
            _ => BaseModalComponent.ModalSize.Desktop
        };
    }
    
    /// <summary>
    /// å–å¾—å¯©è¨ˆè³‡è¨Š
    /// </summary>
    private BaseModalComponent.ModalAuditInfo? GetAuditInfo()
    {
        if (Entity == null || Entity.Id <= 0)
            return null;
            
        return new BaseModalComponent.ModalAuditInfo
        {
            CreatedAt = Entity.CreatedAt,
            CreatedBy = Entity.CreatedBy ?? "ç³»çµ±",
            UpdatedAt = Entity.UpdatedAt,
            UpdatedBy = Entity.UpdatedBy ?? "ç³»çµ±"
        };
    }
    
    /// <summary>
    /// å–å¾—è‡ªè¨‚æ¨¡çµ„çš„ CSS é¡åˆ¥
    /// </summary>
    private string GetModuleCssClass(CustomModule module)
    {
        var cssClasses = new List<string>();
        
        // åŸºæœ¬é–“è·é¡åˆ¥ï¼ˆModal ä¸­ä½¿ç”¨è¼ƒå°çš„é–“è·ï¼‰
        if (!string.IsNullOrWhiteSpace(module.Title))
        {
            cssClasses.Add("mb-3");
        }
        else
        {
            cssClasses.Add("mb-2");
        }
        
        // è‡ªè¨‚ CSS é¡åˆ¥
        if (!string.IsNullOrWhiteSpace(module.CssClass))
        {
            cssClasses.Add(module.CssClass);
        }
        
        return string.Join(" ", cssClasses);
    }
    
    private void ResetState()
    {
        IsLoading = false;
        IsSubmitting = false;
        ErrorMessage = string.Empty;
        Entity = new();
        editContext = new EditContext(Entity);
        
        // é‡ç½®å¯©æ ¸ç‹€æ…‹
        IsApproving = false;
        IsRejecting = false;
        
        // é‡ç½®ç‹€æ…‹è¨Šæ¯å¿«å–
        ResetStatusMessage();
    }
    
    // ===== ç‹€æ…‹è¨Šæ¯è¼”åŠ©æ–¹æ³• =====
    
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦æ‡‰è©²é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
    /// </summary>
    private bool ShouldShowStatusMessage()
    {
        // æ˜ç¢ºå•Ÿç”¨é¡¯ç¤ºï¼Œæˆ–è€…å•Ÿç”¨äº†å¯©æ ¸å€åŸŸï¼ˆå‘ä¸‹ç›¸å®¹ï¼‰
        return ShowStatusMessage || ShowApprovalSection;
    }
    
    /// <summary>
    /// å–å¾—å¾½ç« é¡è‰² CSS é¡åˆ¥
    /// </summary>
    private string GetBadgeColorClass(BadgeVariant variant)
    {
        return variant switch
        {
            BadgeVariant.Primary => "primary",
            BadgeVariant.Secondary => "secondary",
            BadgeVariant.Success => "success",
            BadgeVariant.Danger => "danger",
            BadgeVariant.Warning => "warning",
            BadgeVariant.Info => "info",
            BadgeVariant.Light => "light",
            BadgeVariant.Dark => "dark",
            _ => "info"
        };
    }
    
    /// <summary>
    /// é‡ç½®ç‹€æ…‹è¨Šæ¯å¿«å–
    /// </summary>
    private void ResetStatusMessage()
    {
        _cachedStatusMessage = null;
        _cachedStatusVariant = BadgeVariant.Info;
        _cachedStatusIcon = "fas fa-info-circle";
    }
    
    // ===== é€šçŸ¥æ–¹æ³• =====
    
    private async Task ShowSuccessMessage(string message)
    {
        // å¦‚æœè¨Šæ¯ç‚ºç©ºå‰‡ä¸é¡¯ç¤º
        if (string.IsNullOrWhiteSpace(message))
            return;
            
        await NotificationService.ShowSuccessAsync(message);
    }
    
    private async Task ShowErrorMessage(string message)
    {
        await NotificationService.ShowErrorAsync(message);
    }
    
    private void LogError(string method, Exception ex)
    {
        // ä½¿ç”¨ç³»çµ±æ—¥èªŒè€Œé console è¼¸å‡º
        System.Diagnostics.Debug.WriteLine($"[GenericEditModalComponent.{method}] éŒ¯èª¤ï¼š{ex.Message}");
    }
    
    // ===== é€šç”¨åˆªé™¤æ“ä½œ =====
    
    /// <summary>
    /// é€šç”¨åˆªé™¤æ–¹æ³•ï¼ˆæ°¸ä¹…åˆªé™¤ï¼‰
    /// </summary>
    public async Task DeleteEntityAsync()
    {
        if (Entity == null || Entity.Id <= 0)
            return;
            
        var displayName = GetEntityDisplayName(Entity);
        
        try
        {
            // æ­¥é©Ÿ0ï¼šæª¢æŸ¥æ˜¯å¦å…è¨±åˆªé™¤æ­¤å¯¦é«”ï¼ˆé›™é‡ä¿è­·ï¼‰
            if (!IsEntityDeletable(Entity))
            {
                await NotificationService.ShowWarningAsync($"æ­¤{EntityName}ã€Œ{displayName}ã€ç„¡æ³•åˆªé™¤");
                return;
            }
            
            // æ­¥é©Ÿ1ï¼šå…ˆæª¢æŸ¥æ˜¯å¦å¯ä»¥åˆªé™¤ï¼ˆæª¢æŸ¥é—œè¯ï¼‰
            bool canDelete = false;
            string? canDeleteErrorMessage = null;
            
            if (CustomDeleteHandler != null)
            {
                // å¦‚æœæœ‰è‡ªè¨‚åˆªé™¤è™•ç†å™¨ï¼Œç›´æ¥ä½¿ç”¨
                canDelete = true;
            }
            else
            {
                // ä½¿ç”¨åå°„èª¿ç”¨æœå‹™çš„ CanDeleteAsync æ–¹æ³•
                var canDeleteMethod = Service?.GetType().GetMethod("CanDeleteAsync", new[] { typeof(TEntity) });
                if (canDeleteMethod != null)
                {
                    var task = (Task)canDeleteMethod.Invoke(Service, new object[] { Entity })!;
                    await task;
                    
                    // ç²å–çµæœ
                    var resultProperty = task.GetType().GetProperty("Result");
                    if (resultProperty != null)
                    {
                        var result = resultProperty.GetValue(task);
                        var isSuccessProperty = result?.GetType().GetProperty("IsSuccess");
                        var errorMessageProperty = result?.GetType().GetProperty("ErrorMessage");
                        
                        if (isSuccessProperty != null)
                        {
                            canDelete = (bool)isSuccessProperty.GetValue(result)!;
                            if (!canDelete)
                            {
                                canDeleteErrorMessage = errorMessageProperty?.GetValue(result)?.ToString() ?? "ç„¡æ³•åˆªé™¤æ­¤è³‡æ–™";
                            }
                        }
                    }
                }
                else
                {
                    // å¦‚æœæ²’æœ‰ CanDeleteAsync æ–¹æ³•ï¼Œé è¨­å…è¨±åˆªé™¤
                    canDelete = true;
                }
            }
            
            // æ­¥é©Ÿ2ï¼šå¦‚æœä¸èƒ½åˆªé™¤ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            if (!canDelete)
            {
                await NotificationService.ShowWarningAsync(canDeleteErrorMessage ?? $"ç„¡æ³•åˆªé™¤{EntityName}ã€Œ{displayName}ã€ï¼Œå› ç‚ºæœ‰å…¶ä»–è³‡æ–™æ­£åœ¨ä½¿ç”¨æ­¤{EntityName}");
                return;
            }
            
            // æ­¥é©Ÿ3ï¼šç¢ºèªåˆªé™¤
            var confirmMessage = GetDeleteConfirmMessage(displayName);
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", confirmMessage);
            
            if (!confirmed)
                return;
                
            // æ­¥é©Ÿ4ï¼šåŸ·è¡Œåˆªé™¤
            bool deleteSuccess = false;
            
            if (CustomDeleteHandler != null)
            {
                deleteSuccess = await CustomDeleteHandler(Entity);
            }
            else
            {
                // ä½¿ç”¨é è¨­çš„åå°„èª¿ç”¨æœå‹™çš„ PermanentDeleteAsync æ–¹æ³•
                var deleteMethod = Service?.GetType().GetMethod("PermanentDeleteAsync", new[] { typeof(int) });
                if (deleteMethod != null)
                {
                    var task = (Task)deleteMethod.Invoke(Service, new object[] { Entity.Id })!;
                    await task;
                    
                    // ç²å–çµæœ
                    var resultProperty = task.GetType().GetProperty("Result");
                    if (resultProperty != null)
                    {                        
                        var result = resultProperty.GetValue(task);
                        var isSuccessProperty = result?.GetType().GetProperty("IsSuccess");
                        var errorMessageProperty = result?.GetType().GetProperty("ErrorMessage");
                        
                        if (isSuccessProperty != null)
                        {
                            var isSuccess = (bool)isSuccessProperty.GetValue(result)!;                            
                            if (isSuccess)
                            {
                                deleteSuccess = true;
                            }
                            else
                            {
                                var errorMessage = errorMessageProperty?.GetValue(result)?.ToString() ?? "åˆªé™¤å¤±æ•—";
                                await NotificationService.ShowErrorAsync($"åˆªé™¤å¤±æ•—ï¼š{errorMessage}");
                                return;
                            }
                        }
                    }                
                }               
                else
                {
                    await NotificationService.ShowErrorAsync("æ‰¾ä¸åˆ°æ°¸ä¹…åˆªé™¤æ–¹æ³•");
                    return;
                }
            }
            
            // æ­¥é©Ÿ5ï¼šé¡¯ç¤ºæˆåŠŸè¨Šæ¯ä¸¦é—œé–‰ Modal
            if (deleteSuccess)
            {
                var successMessage = GetDeleteSuccessMessage();
                await NotificationService.ShowSuccessAsync(successMessage);
                
                // è§¸ç™¼æˆåŠŸäº‹ä»¶ï¼ˆé€šçŸ¥çˆ¶çµ„ä»¶åˆ·æ–°è³‡æ–™ï¼‰
                if (OnSaveSuccess.HasDelegate)
                {
                    await OnSaveSuccess.InvokeAsync();
                }
                
                // é—œé–‰ Modal
                await CloseModal();
            }
        }            
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"åˆªé™¤æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            LogError("DeleteEntityAsync", ex);
        }
    }
    
    /// <summary>
    /// åˆ¤æ–·å¯¦é«”æ˜¯å¦å¯ä»¥åˆªé™¤
    /// çµåˆé è¨­ç³»çµ±è³‡æ–™ä¿è­·å’Œè‡ªè¨‚åˆ¤æ–·é‚è¼¯
    /// </summary>
    private bool IsEntityDeletable(TEntity entity)
    {
        // å„ªå…ˆæª¢æŸ¥è‡ªè¨‚çš„ CanDelete å‡½æ•¸
        if (CanDelete != null)
        {
            return CanDelete(entity);
        }
        
        // å¦‚æœå•Ÿç”¨ç³»çµ±è³‡æ–™ä¿è­·ï¼Œå‰‡æª¢æŸ¥ CreatedBy
        if (EnableSystemDataProtection)
        {
            return entity.CreatedBy != "System";
        }
        
        // é è¨­å…è¨±åˆªé™¤
        return true;
    }
    
    /// <summary>
    /// å–å¾—åˆªé™¤æˆåŠŸè¨Šæ¯ï¼Œå„ªå…ˆä½¿ç”¨è‡ªè¨‚å€¼ï¼Œå¦å‰‡æ ¹æ“š EntityName è‡ªå‹•ç”¢ç”Ÿ
    /// </summary>
    private string GetDeleteSuccessMessage()
    {
        return !string.IsNullOrWhiteSpace(DeleteSuccessMessage) ? DeleteSuccessMessage : $"{EntityName}åˆªé™¤æˆåŠŸ";
    }
    
    /// <summary>
    /// å–å¾—åˆªé™¤ç¢ºèªè¨Šæ¯ï¼Œå„ªå…ˆä½¿ç”¨è‡ªè¨‚å€¼ï¼Œå¦å‰‡æ ¹æ“š EntityName è‡ªå‹•ç”¢ç”Ÿ
    /// </summary>
    private string GetDeleteConfirmMessage(string displayName)
    {
        if (!string.IsNullOrWhiteSpace(DeleteConfirmMessage))
        {
            return string.Format(DeleteConfirmMessage, displayName);
        }
        // ç°¡åŒ–è¨Šæ¯
        return $"ç¢ºå®šåˆªé™¤å—ï¼Ÿ";
    }
    
    // ===== é€šç”¨Saveæ–¹æ³• =====
    
    /// <summary>
    /// é€šç”¨çš„ä¿å­˜æ–¹æ³•ï¼Œé©ç”¨æ–¼å¤§éƒ¨åˆ†ç°¡å–®å¯¦é«”
    /// </summary>
    private async Task<bool> GenericSave(TEntity entity)
    {
        try
        {
            // è‡ªè¨‚é©—è­‰
            if (CustomValidator != null && !await CustomValidator(entity))
            {
                return false;
            }
            
            // å„²å­˜å‰è™•ç†
            if (BeforeSave != null)
            {
                await BeforeSave(entity);
            }
            
            // ç›´æ¥è½‰å‹ç‚ºåŸºç¤æ¥å£èª¿ç”¨æ–¹æ³•ï¼Œé¿å…åå°„å•é¡Œ
            var genericService = Service as IGenericManagementService<TEntity>;
            if (genericService == null)
            {
                await ShowErrorMessage("æœå‹™æœªå¯¦ä½œæ³›å‹ç®¡ç†ä»‹é¢");
                return false;
            }
            
            ServiceResult<TEntity> serviceResult;
            
            if (Id.HasValue)
            {
                serviceResult = await genericService.UpdateAsync(entity);
            }
            else
            {
                serviceResult = await genericService.CreateAsync(entity);
            }
            
            var result = new ServiceResult
            {
                IsSuccess = serviceResult.IsSuccess,
                ErrorMessage = serviceResult.ErrorMessage,
                ValidationErrors = serviceResult.ValidationErrors
            };
            
            if (result.IsSuccess)
            {
                // å„²å­˜å¾Œè™•ç†
                if (AfterSave != null)
                {
                    await AfterSave(entity);
                }
                return true;
            }
            else
            {
                var errorMsg = !string.IsNullOrEmpty(result.ErrorMessage) 
                    ? result.ErrorMessage 
                    : "å„²å­˜å¤±æ•—";
                await ShowErrorMessage($"{SaveFailureMessage}ï¼š{errorMsg}");
                return false;
            }
        }
        catch (Exception ex)
        {
            await ShowErrorMessage($"{SaveFailureMessage}ï¼š{ex.Message}");
            LogError("GenericSave", ex);
            return false;
        }
    }
    
    // ===== æ¬„ä½è®Šæ›´è™•ç† =====
    
    private async Task HandleFieldChanged((string PropertyName, object? Value) fieldChange)
    {
        // æª¢æŸ¥æ˜¯å¦æ˜¯ AutoComplete æ¬„ä½ï¼Œå¦‚æœæ˜¯å‰‡æ›´æ–°æŒ‰éˆ•
        var field = FormFields?.FirstOrDefault(f => f.PropertyName == fieldChange.PropertyName);
        if (field != null && 
            field.FieldType == FormFieldType.AutoComplete && 
            field.ActionButtons != null && 
            field.ActionButtons.Any())
        {
            // å¦‚æœæ¬„ä½å€¼è¢«æ¸…ç©ºï¼ˆnull æˆ–ç©ºå­—ä¸²ï¼‰ï¼ŒåŒæ­¥æ¸…ç©ºæœå°‹é—œéµå­—è¨˜éŒ„
            if (fieldChange.Value == null || string.IsNullOrEmpty(fieldChange.Value.ToString()))
            {
                _lastSearchTerms[fieldChange.PropertyName] = string.Empty;
            }
            
            // é‡æ–°è™•ç†è©²æ¬„ä½çš„ ActionButtons
            field.ActionButtons = ProcessActionButtonsForAutoComplete(field);
            StateHasChanged(); // è§¸ç™¼ UI æ›´æ–°
        }
        
        if (OnFieldChanged != null)
        {
            await OnFieldChanged(fieldChange);
        }
    }
    
    // ===== AutoComplete æ™ºèƒ½è™•ç† =====
    
    /// <summary>
    /// è™•ç†å·²è™•ç†çš„è¡¨å–®æ¬„ä½ï¼ŒåŒ…å« AutoComplete æ™ºèƒ½åŠŸèƒ½
    /// </summary>
    private List<FormFieldDefinition> GetProcessedFormFields()
    {
        var processedFields = new List<FormFieldDefinition>();
        
        foreach (var field in FormFields)
        {
            var processedField = new FormFieldDefinition
            {
                PropertyName = field.PropertyName,
                Label = field.Label,
                FieldType = field.FieldType,
                Placeholder = field.Placeholder,
                HelpText = field.HelpText,
                IsRequired = field.IsRequired,
                IsReadOnly = field.IsReadOnly,
                IsDisabled = field.IsDisabled,
                CssClass = field.CssClass,
                ContainerCssClass = field.ContainerCssClass,
                Min = field.Min,
                Max = field.Max,
                Step = field.Step,
                MinLength = field.MinLength,
                MaxLength = field.MaxLength,
                Rows = field.Rows,
                Options = field.Options,
                AutoCompleteDelayMs = field.AutoCompleteDelayMs,
                MinSearchLength = field.MinSearchLength,
                DefaultValue = field.DefaultValue,
                ValidationRules = field.ValidationRules,
                Order = field.Order,
                GroupName = field.GroupName,
                ActionButtons = field.ActionButtons
            };
            
            // å¦‚æœæ˜¯ AutoComplete æ¬„ä½ï¼ŒåŒ…è£æœå°‹å‡½å¼ä»¥æ”¯æ´æ™ºèƒ½é å¡«
            if (field.FieldType == FormFieldType.AutoComplete)
            {
                if (field.SearchFunction != null)
                {
                    // ä½¿ç”¨è‡ªè¨‚æœå°‹å‡½å¼
                    var originalSearchFunction = field.SearchFunction;
                    processedField.SearchFunction = async (searchTerm) =>
                    {
                        // è¨˜éŒ„æœå°‹é—œéµå­—
                        _lastSearchTerms[field.PropertyName] = searchTerm ?? string.Empty;
                        
                        // èª¿ç”¨åŸå§‹æœå°‹å‡½å¼
                        return await originalSearchFunction(searchTerm ?? string.Empty);
                    };
                }
                else if (AutoCompleteCollections?.ContainsKey(field.PropertyName) == true)
                {
                    // ä½¿ç”¨è‡ªå‹•æœå°‹é›†åˆ
                    processedField.SearchFunction = CreateAutoSearchFunction(field.PropertyName);
                }
                
                // è™•ç†æ™ºèƒ½æŒ‰éˆ•
                if (field.ActionButtons != null && field.ActionButtons.Any())
                {
                    processedField.ActionButtons = ProcessActionButtonsForAutoComplete(field);
                }
            }
            
            processedFields.Add(processedField);
        }
        
        return processedFields;
    }
    
    /// <summary>
    /// è™•ç† AutoComplete æ¬„ä½çš„æ“ä½œæŒ‰éˆ•ï¼Œæ”¯æ´æ™ºèƒ½é å¡«å’Œåˆ†é›¢çš„æ–°å¢/ç·¨è¼¯æŒ‰éˆ•
    /// </summary>
    private List<FieldActionButton> ProcessActionButtonsForAutoComplete(FormFieldDefinition field)
    {
        var processedButtons = new List<FieldActionButton>();
        
        // æ™ºèƒ½æŒ‰éˆ•é¸æ“‡ï¼šæ ¹æ“šè¼¸å…¥å€¼æ˜¯å¦å­˜åœ¨æ–¼è³‡æ–™åº«æ±ºå®šé¡¯ç¤ºå“ªå€‹æŒ‰éˆ•
        var searchTerm = _lastSearchTerms.GetValueOrDefault(field.PropertyName, string.Empty);
        
        // å…ˆæª¢æŸ¥å¯¦é«”æ¬„ä½çš„å¯¦éš›å€¼ï¼Œå¦‚æœç‚ºç©ºå‰‡ç¢ºä¿ searchTerm ä¹Ÿç‚ºç©º
        var currentValue = GetEntityPropertyValue(Entity, field.PropertyName);
        var currentId = currentValue as int?;
        
        // å¦‚æœå¯¦é«”å€¼ç‚ºç©ºæˆ– 0ï¼Œå¼·åˆ¶æ¸…ç©º searchTermï¼ˆé¿å…æ®˜ç•™èˆŠé—œéµå­—ï¼‰
        if (currentId == null || currentId.Value <= 0)
        {
            searchTerm = string.Empty;
            _lastSearchTerms[field.PropertyName] = string.Empty;
        }
        // å¦‚æœ searchTerm ç‚ºç©ºä½†å¯¦é«”æœ‰å€¼ï¼ˆç·¨è¼¯æ¨¡å¼ï¼‰ï¼Œå¾ AutoComplete é›†åˆä¸­æ‰¾å‡ºå°æ‡‰çš„é¡¯ç¤ºåç¨±
        else if (string.IsNullOrWhiteSpace(searchTerm) && 
            Entity != null && 
            AutoCompleteCollections?.ContainsKey(field.PropertyName) == true)
        {
            if (currentId.HasValue && currentId.Value > 0)
            {
                var availableEntities = AutoCompleteCollections[field.PropertyName];
                var displayProperty = AutoCompleteDisplayProperties?.GetValueOrDefault(field.PropertyName, "Name") ?? "Name";
                
                // æ ¹æ“š ID æ‰¾å‡ºå°æ‡‰çš„å¯¦é«”
                var matchedByIdEntity = availableEntities.FirstOrDefault(e => 
                {
                    var idValue = GetPropertyValue(e, "Id") as int?;
                    return idValue == currentId.Value;
                });
                
                if (matchedByIdEntity != null)
                {
                    // å–å¾—é¡¯ç¤ºåç¨±ä¸¦å­˜å…¥ _lastSearchTerms
                    var displayValue = GetPropertyValue(matchedByIdEntity, displayProperty)?.ToString();
                    if (!string.IsNullOrWhiteSpace(displayValue))
                    {
                        searchTerm = displayValue;
                        _lastSearchTerms[field.PropertyName] = displayValue;
                    }
                }
            }
        }
        
        bool entityExists = false;
        object? matchedEntity = null;
        
        // æª¢æŸ¥è¼¸å…¥å€¼æ˜¯å¦å­˜åœ¨æ–¼ AutoComplete é›†åˆä¸­
        if (AutoCompleteCollections?.ContainsKey(field.PropertyName) == true && 
            !string.IsNullOrWhiteSpace(searchTerm))
        {
            var availableEntities = AutoCompleteCollections[field.PropertyName];
            var displayProperty = AutoCompleteDisplayProperties?.GetValueOrDefault(field.PropertyName, "Name") ?? "Name";
            matchedEntity = FindMatchingEntity(availableEntities, displayProperty, searchTerm);
            entityExists = matchedEntity != null;
        }
        
        foreach (var button in field.ActionButtons!)
        {
            // æ™ºèƒ½éæ¿¾ï¼šå¦‚æœå¯¦é«”å­˜åœ¨ï¼Œåªä¿ç•™ã€Œç·¨è¼¯ã€æŒ‰éˆ•ï¼›å¦å‰‡åªä¿ç•™ã€Œæ–°å¢ã€æŒ‰éˆ•
            if (entityExists && button.Text == "æ–°å¢")
            {
                continue; // å¯¦é«”å­˜åœ¨æ™‚è·³éæ–°å¢æŒ‰éˆ•
            }
            if (!entityExists && button.Text == "ç·¨è¼¯")
            {
                continue; // å¯¦é«”ä¸å­˜åœ¨æ™‚è·³éç·¨è¼¯æŒ‰éˆ•
            }
            
            var processedButton = new FieldActionButton
            {
                Text = button.Text,
                Variant = button.Variant,
                Size = button.Size,
                IconClass = button.IconClass,
                Title = button.Title,
                IsDisabled = button.IsDisabled
            };
            
            // å¦‚æœæ˜¯æ–°å¢æŒ‰éˆ•ä¸”æœ‰é å¡«å™¨ï¼ŒåŒ…è£é»æ“Šäº‹ä»¶ä»¥æ”¯æ´æ™ºèƒ½é å¡«
            if (button.Text == "æ–°å¢" && 
                AutoCompletePrefillers?.ContainsKey(field.PropertyName) == true &&
                button.OnClick != null)
            {
                var originalOnClick = button.OnClick;
                processedButton.OnClick = async () =>
                {
                    // å–å¾—é å¡«å€¼
                    var searchTerm = _lastSearchTerms.GetValueOrDefault(field.PropertyName, string.Empty);
                    if (!string.IsNullOrWhiteSpace(searchTerm))
                    {
                        var prefilledValues = AutoCompletePrefillers[field.PropertyName](searchTerm);
                        
                        // å¦‚æœæœ‰å°æ‡‰çš„ Modal ç®¡ç†å™¨ï¼Œä½¿ç”¨æ™ºèƒ½é–‹å•Ÿ
                        if (ModalManagers?.ContainsKey(field.PropertyName) == true)
                        {
                            var modalManager = ModalManagers[field.PropertyName];
                            
                            // ä½¿ç”¨åå°„èª¿ç”¨ OpenModalWithPrefilledValuesAsync
                            var openMethod = modalManager.GetType().GetMethod("OpenModalWithPrefilledValuesAsync");
                            if (openMethod != null)
                            {
                                var task = (Task?)openMethod.Invoke(modalManager, new object[] { null!, prefilledValues });
                                if (task != null)
                                {
                                    await task;
                                    return;
                                }
                            }
                        }
                    }
                    
                    // å¦å‰‡ä½¿ç”¨åŸå§‹é»æ“Šäº‹ä»¶
                    await originalOnClick();
                };
            }
            // å¦‚æœæ˜¯ç·¨è¼¯æŒ‰éˆ•ï¼ŒåŒ…è£é»æ“Šäº‹ä»¶ä»¥æ”¯æ´æ™ºèƒ½ç·¨è¼¯
            else if (button.Text == "ç·¨è¼¯" && button.OnClick != null)
            {
                var capturedMatchedEntity = matchedEntity; // æ•ç²å¤–å±¤å·²æ‰¾åˆ°çš„å¯¦é«”
                var originalOnClick = button.OnClick;
                processedButton.OnClick = async () =>
                {
                    // ä½¿ç”¨å·²æ‰¾åˆ°çš„åŒ¹é…å¯¦é«”
                    if (ModalManagers?.ContainsKey(field.PropertyName) == true && capturedMatchedEntity != null)
                    {
                        var modalManager = ModalManagers[field.PropertyName];
                        
                        // å–å¾—å¯¦é«” ID ä¸¦é–‹å•Ÿç·¨è¼¯æ¨¡å¼
                        var entityIdValue = GetPropertyValue(capturedMatchedEntity, "Id") as int?;
                        if (entityIdValue.HasValue)
                        {
                            var openMethod = modalManager.GetType().GetMethod("OpenModalAsync");
                            if (openMethod != null)
                            {
                                var task = (Task?)openMethod.Invoke(modalManager, new object[] { entityIdValue.Value });
                                if (task != null)
                                {
                                    await task;
                                    return;
                                }
                            }
                        }
                    }
                    
                    // å¦‚æœæ²’æœ‰åŒ¹é…å¯¦é«”æˆ–é–‹å•Ÿå¤±æ•—ï¼Œä½¿ç”¨åŸå§‹é»æ“Šäº‹ä»¶
                    await originalOnClick();
                };
            }
            else
            {
                processedButton.OnClick = button.OnClick;
            }
            
            processedButtons.Add(processedButton);
        }
        
        return processedButtons;
    }
    
    /// <summary>
    /// ç‚ºæŒ‡å®šå±¬æ€§å»ºç«‹è‡ªå‹•æœå°‹å‡½å¼
    /// </summary>
    private Func<string, Task<List<SelectOption>>> CreateAutoSearchFunction(string propertyName)
    {
        return async (searchTerm) =>
        {
            try
            {
                await Task.Delay(1); // æ¨¡æ“¬ç•°æ­¥æ“ä½œ
                
                // è¨˜éŒ„æœå°‹é—œéµå­—
                _lastSearchTerms[propertyName] = searchTerm ?? string.Empty;
                
                if (!AutoCompleteCollections!.ContainsKey(propertyName))
                {
                    return new List<SelectOption>();
                }
                
                var collection = AutoCompleteCollections[propertyName];
                var displayProperty = AutoCompleteDisplayProperties?.GetValueOrDefault(propertyName, "Name") ?? "Name";
                var valueProperty = AutoCompleteValueProperties?.GetValueOrDefault(propertyName, "Id") ?? "Id";
                var maxResults = AutoCompleteMaxResults?.GetValueOrDefault(propertyName, 100) ?? 100;
                
                var filteredResults = collection
                    .Where(item => 
                    {
                        if (string.IsNullOrEmpty(searchTerm))
                            return true;
                            
                        var displayValue = GetPropertyValue(item, displayProperty)?.ToString() ?? string.Empty;
                        return displayValue.Contains(searchTerm, StringComparison.OrdinalIgnoreCase);
                    })
                    .Take(maxResults)
                    .Select(item => new SelectOption
                    {
                        Text = GetPropertyValue(item, displayProperty)?.ToString() ?? string.Empty,
                        Value = GetPropertyValue(item, valueProperty)?.ToString() ?? string.Empty
                    })
                    .ToList();
                
                return filteredResults;
            }
            catch (Exception ex)
            {
                LogError($"AutoSearch_{propertyName}", ex);
                return new List<SelectOption>();
            }
        };
    }
    
    /// <summary>
    /// åœ¨é›†åˆä¸­å°‹æ‰¾åŒ¹é…çš„å¯¦é«”
    /// </summary>
    /// <param name="entities">å¯¦é«”é›†åˆ</param>
    /// <param name="propertyName">è¦æ¯”è¼ƒçš„å±¬æ€§åç¨±</param>
    /// <param name="searchValue">æœå°‹å€¼</param>
    /// <returns>åŒ¹é…çš„å¯¦é«”ï¼Œå¦‚æœæ‰¾ä¸åˆ°å‰‡è¿”å› null</returns>
    private object? FindMatchingEntity(IEnumerable<object> entities, string propertyName, string searchValue)
    {
        try
        {
            return entities.FirstOrDefault(entity =>
            {
                var propertyValue = GetPropertyValue(entity, propertyName)?.ToString();
                return string.Equals(propertyValue, searchValue, StringComparison.OrdinalIgnoreCase);
            });
        }
        catch
        {
            return null;
        }
    }
    
    /// <summary>
    /// ä½¿ç”¨åå°„å–å¾—ç‰©ä»¶å±¬æ€§å€¼
    /// </summary>
    private object? GetPropertyValue(object obj, string propertyName)
    {
        try
        {
            var property = obj.GetType().GetProperty(propertyName);
            return property?.GetValue(obj);
        }
        catch
        {
            return null;
        }
    }
    
    /// <summary>
    /// æ›´æ–°æ‰€æœ‰å¸¶æœ‰ ActionButtons çš„æ¬„ä½ï¼Œç¢ºä¿æŒ‰éˆ•ç‹€æ…‹èˆ‡å¯¦é«”è³‡æ–™åŒæ­¥
    /// </summary>
    private void UpdateAllActionButtons()
    {
        try
        {
            // åªæœ‰åœ¨å¯¦é«”è³‡æ–™å­˜åœ¨ä¸”æœ‰ ModalManagers å’Œ FormFields æ™‚æ‰åŸ·è¡Œæ›´æ–°
            if (Entity == null || ModalManagers == null || !ModalManagers.Any() || FormFields == null || !FormFields.Any())
                return;

            // ç›´æ¥æ›´æ–°åŸå§‹çš„ FormFieldsï¼Œè€Œä¸æ˜¯ GetProcessedFormFields çš„çµæœ
            var fieldsWithButtons = FormFields.Where(f => f.ActionButtons != null && f.ActionButtons.Any()).ToList();
            
            foreach (var field in fieldsWithButtons)
            {
                // å¾ ModalManagers å­—å…¸ä¸­æ‰¾åˆ°å°æ‡‰çš„ç®¡ç†å™¨ä¸¦æ›´æ–°æŒ‰éˆ•
                if (ModalManagers.ContainsKey(field.PropertyName))
                {
                    var modalManager = ModalManagers[field.PropertyName];
                    
                    // å–å¾—ç•¶å‰å¯¦é«”å°æ‡‰å±¬æ€§çš„å€¼
                    var currentValue = GetEntityPropertyValue(Entity, field.PropertyName);
                    var intValue = currentValue as int?;
                    
                    // ä½¿ç”¨åå°„èª¿ç”¨ UpdateFieldActionButtons æ–¹æ³•
                    var updateMethod = modalManager?.GetType().GetMethod("UpdateFieldActionButtons");
                    if (updateMethod != null && modalManager != null)
                    {
                        // ç›´æ¥å‚³å…¥åŸå§‹çš„ FormFieldsï¼Œè€Œä¸æ˜¯è™•ç†éçš„
                        updateMethod.Invoke(modalManager, new object?[] { FormFields, field.PropertyName, intValue });
                    }
                }
            }
        }
        catch (Exception ex)
        {
            _ = Task.Run(() => LogError("UpdateAllActionButtons", ex));
        }
    }
    
    /// <summary>
    /// å–å¾—å¯¦é«”å±¬æ€§å€¼çš„è¼”åŠ©æ–¹æ³•
    /// </summary>
    private object? GetEntityPropertyValue(object obj, string propertyName)
    {
        try
        {
            var property = obj.GetType().GetProperty(propertyName);
            return property?.GetValue(obj);
        }
        catch
        {
            return null;
        }
    }
    
    #region è¨˜éŒ„å°èˆªè™•ç†
    
    /// <summary>
    /// è¼‰å…¥å°èˆªç‹€æ…‹ï¼ˆä¸Šä¸€ç­†å’Œä¸‹ä¸€ç­†çš„ IDï¼Œæ”¯æ´å¾ªç’°å°èˆªï¼‰
    /// æ–°å¢æ¨¡å¼ï¼šåªè¼‰å…¥æœ€å¾Œä¸€ç­† ID
    /// ç·¨è¼¯æ¨¡å¼ï¼šè¼‰å…¥å®Œæ•´å°èˆªè³‡è¨Š
    /// </summary>
    private async Task LoadNavigationStateAsync()
    {
        // ä½¿ç”¨ _currentIdï¼ˆå°èˆªæ™‚çš„å¯¦éš› IDï¼‰æˆ– Idï¼ˆåƒæ•¸ï¼‰
        var currentId = _currentId ?? Id;
        
        //  é‡è¦ä¿®æ­£ï¼šå³ä½¿åœ¨æ–°å¢æ¨¡å¼ï¼ˆcurrentId ç‚º nullï¼‰ä¹Ÿéœ€è¦è¼‰å…¥ _lastRecordId
        // å› ç‚ºè¿”å›ç·¨è¼¯æŒ‰éˆ•éœ€è¦ _lastRecordId ä¾†åˆ¤æ–·æ˜¯å¦é¡¯ç¤º
        if (!EnableNavigation || Service == null)
        {
            _previousId = null;
            _nextId = null;
            _firstId = null;
            _lastRecordId = null;
            return;
        }
        
        try
        {
            // ä½¿ç”¨åå°„èª¿ç”¨æœå‹™çš„å°èˆªæ–¹æ³•
            var serviceType = Service.GetType();
            
            // æ–°å¢æ¨¡å¼ï¼šåªè¼‰å…¥æœ€å¾Œä¸€ç­† IDï¼ˆç”¨æ–¼è¿”å›ç·¨è¼¯æŒ‰éˆ•ï¼‰
            if (!currentId.HasValue)
            {
                var getLastMethod = serviceType.GetMethod("GetLastIdAsync");
                if (getLastMethod != null)
                {
                    var lastTask = getLastMethod.Invoke(Service, new object[] { }) as Task<int?>;
                    if (lastTask != null)
                    {
                        _lastRecordId = await lastTask;
                    }
                }
                
                // æ¸…ç©ºå…¶ä»–å°èˆªç‹€æ…‹
                _previousId = null;
                _nextId = null;
                _firstId = null;
                return;
            }
            
            // ç·¨è¼¯æ¨¡å¼ï¼šè¼‰å…¥å®Œæ•´å°èˆªè³‡è¨Š
            var getPreviousMethod = serviceType.GetMethod("GetPreviousIdAsync");
            var getNextMethod = serviceType.GetMethod("GetNextIdAsync");
            var getFirstMethod = serviceType.GetMethod("GetFirstIdAsync");
            var getLastMethod2 = serviceType.GetMethod("GetLastIdAsync");
            
            // è¼‰å…¥ä¸Šä¸€ç­† ID
            if (getPreviousMethod != null)
            {
                var previousTask = getPreviousMethod.Invoke(Service, new object[] { currentId.Value }) as Task<int?>;
                if (previousTask != null)
                {
                    _previousId = await previousTask;
                }
            }
            
            // è¼‰å…¥ä¸‹ä¸€ç­† ID
            if (getNextMethod != null)
            {
                var nextTask = getNextMethod.Invoke(Service, new object[] { currentId.Value }) as Task<int?>;
                if (nextTask != null)
                {
                    _nextId = await nextTask;
                }
            }
            
            // è¼‰å…¥ç¬¬ä¸€ç­† IDï¼ˆç”¨æ–¼å¾ªç’°å°èˆªï¼‰
            if (getFirstMethod != null)
            {
                var firstTask = getFirstMethod.Invoke(Service, new object[] { }) as Task<int?>;
                if (firstTask != null)
                {
                    _firstId = await firstTask;
                }
            }
            
            // è¼‰å…¥æœ€å¾Œä¸€ç­† IDï¼ˆç”¨æ–¼å¾ªç’°å°èˆªï¼‰
            if (getLastMethod2 != null)
            {
                var lastTask = getLastMethod2.Invoke(Service, new object[] { }) as Task<int?>;
                if (lastTask != null)
                {
                    _lastRecordId = await lastTask;
                }
            }
            
            // å¾ªç’°é‚è¼¯ï¼šå¦‚æœæ²’æœ‰ä¸Šä¸€ç­†ï¼Œè¨­ç‚ºæœ€å¾Œä¸€ç­†ï¼›å¦‚æœæ²’æœ‰ä¸‹ä¸€ç­†ï¼Œè¨­ç‚ºç¬¬ä¸€ç­†
            if (!_previousId.HasValue && _lastRecordId.HasValue)
            {
                _previousId = _lastRecordId.Value;
            }
            
            if (!_nextId.HasValue && _firstId.HasValue)
            {
                _nextId = _firstId.Value;
            }
        }
        catch (Exception ex)
        {
            LogError("LoadNavigationStateAsync", ex);
            _previousId = null;
            _nextId = null;
            _firstId = null;
            _lastRecordId = null;
        }
    }
    
    /// <summary>
    /// è™•ç†è¿”å›ç·¨è¼¯æŒ‰éˆ•é»æ“Šï¼ˆæ–°å¢æ¨¡å¼å°ˆç”¨ï¼Œè¿”å›åˆ°æœ€å¾Œä¸€ç­†è¨˜éŒ„ï¼‰
    /// </summary>
    private async Task HandleReturnToLast()
    {
        if (IsLoading || IsSubmitting) return;
        
        try
        {
            if (_lastRecordId.HasValue)
            {
                await NavigateToRecordAsync(_lastRecordId.Value);
            }
            else
            {
                await ShowErrorMessage($"æ‰¾ä¸åˆ°æœ€å¾Œä¸€ç­†{EntityName}");
            }
        }
        catch (Exception ex)
        {
            await ShowErrorMessage($"è¿”å›ç·¨è¼¯{EntityName}æ™‚ç™¼ç”ŸéŒ¯èª¤");
            LogError("HandleReturnToLast", ex);
        }
    }
    
    /// <summary>
    /// è™•ç†æ–°å¢æŒ‰éˆ•é»æ“Šï¼ˆç·¨è¼¯æ¨¡å¼å°ˆç”¨ï¼Œåˆ‡æ›åˆ°æ–°å¢æ¨¡å¼ï¼‰
    /// </summary>
    private async Task HandleAddClick()
    {
        if (IsLoading || IsSubmitting) 
        {
            return;
        }
        
        try
        {
            // ğŸ”‘ è¨­å®šæ——æ¨™ï¼šå„²å­˜å¾Œä¿æŒæ–°å¢æ¨¡å¼
            _stayInAddMode = true;
            
            // ğŸ”‘ é—œéµä¿®å¾©ï¼šé‡ç½®ç‹€æ…‹ä¸¦å¼·åˆ¶è§¸ç™¼å®Œæ•´çš„è¼‰å…¥æµç¨‹
            // å°‡ _lastId è¨­ç‚ºé null å€¼ï¼Œé€™æ¨£ OnParametersSetAsync æ‰æœƒåµæ¸¬åˆ°è®ŠåŒ–
            _lastId = -1;  // è¨­ç‚ºä¸€å€‹ä¸å¯èƒ½çš„å€¼ï¼Œç¢ºä¿è§¸ç™¼é‡æ–°è¼‰å…¥
            Id = null;
            _currentId = null;
            
            // è§¸ç™¼ IdChanged äº‹ä»¶é€šçŸ¥çˆ¶çµ„ä»¶ï¼ˆé€™æœƒè§¸ç™¼ OnParametersSetAsyncï¼‰
            if (IdChanged.HasDelegate)
            {
                await IdChanged.InvokeAsync(null);
            }
            
            // ğŸ”‘ ç›´æ¥èª¿ç”¨ LoadAllDataï¼Œç¢ºä¿å®Œæ•´çš„è¼‰å…¥æµç¨‹
            // é€™æœƒè¼‰å…¥æ–°å¢æ¨¡å¼çš„å¯¦é«”ï¼ˆåŒ…å«è‡ªå‹•ç”¢ç”Ÿçš„ Codeï¼‰
            await LoadAllData();
            
            // ğŸ”‘ é—œéµä¿®å¾©ï¼šåŒæ­¥ _lastId ç‚º nullï¼Œé˜²æ­¢ OnParametersSetAsync éŒ¯èª¤è§¸ç™¼
            // åœ¨å·¢ç‹€ Modal å ´æ™¯ï¼ˆå¦‚å¾ ProductEditModal é–‹å•Ÿ ProductCompositionEditModalï¼‰
            // å¦‚æœçˆ¶çµ„ä»¶æ²’æœ‰ä½¿ç”¨ @bind-Idï¼ˆåªæ˜¯å–®å‘ç¶å®šï¼‰ï¼ŒOnParametersSetAsync å¯èƒ½æœƒ
            // å› ç‚º _lastId != Id è€Œå†æ¬¡è¼‰å…¥èˆŠè³‡æ–™ï¼Œé€™è£¡ç¢ºä¿ _lastId èˆ‡ Id åŒæ­¥
            _lastId = null;
        }
        catch (Exception ex)
        {
            await ShowErrorMessage($"åˆ‡æ›åˆ°æ–°å¢æ¨¡å¼æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            LogError("HandleAddClick", ex);
        }
    }
    
    /// <summary>
    /// è™•ç†ä¸Šä¸€ç­†æŒ‰éˆ•é»æ“Šï¼ˆæ”¯æ´å¾ªç’°å°èˆªï¼‰
    /// </summary>
    private async Task HandlePrevious()
    {
        if (IsLoading || IsSubmitting) return;
        
        try
        {
            if (_previousId.HasValue)
            {
                await NavigateToRecordAsync(_previousId.Value);
            }
            else
            {
                await ShowErrorMessage($"ç„¡æ³•åˆ‡æ›åˆ°ä¸Šä¸€ç­†{EntityName}");
            }
        }
        catch (Exception ex)
        {
            await ShowErrorMessage($"åˆ‡æ›åˆ°ä¸Šä¸€ç­†{EntityName}æ™‚ç™¼ç”ŸéŒ¯èª¤");
            LogError("HandlePrevious", ex);
        }
    }
    
    /// <summary>
    /// è™•ç†ä¸‹ä¸€ç­†æŒ‰éˆ•é»æ“Šï¼ˆæ”¯æ´å¾ªç’°å°èˆªï¼‰
    /// </summary>
    private async Task HandleNext()
    {
        if (IsLoading || IsSubmitting) return;
        
        try
        {
            if (_nextId.HasValue)
            {
                await NavigateToRecordAsync(_nextId.Value);
            }
            else
            {
                await ShowErrorMessage($"ç„¡æ³•åˆ‡æ›åˆ°ä¸‹ä¸€ç­†{EntityName}");
            }
        }
        catch (Exception ex)
        {
            await ShowErrorMessage($"åˆ‡æ›åˆ°ä¸‹ä¸€ç­†{EntityName}æ™‚ç™¼ç”ŸéŒ¯èª¤");
            LogError("HandleNext", ex);
        }
    }
    
    /// <summary>
    /// å°èˆªåˆ°æŒ‡å®šçš„è¨˜éŒ„
    /// </summary>
    private async Task NavigateToRecordAsync(int targetId)
    {
        try
        {
            //  é—œéµä¿®å¾©ï¼šè¨­ç½®å°èˆªæ¨™è¨˜ï¼Œé˜²æ­¢ LoadAllData å‘¼å« DataLoader è¦†è“‹è³‡æ–™
            _isNavigating = true;
            
            //  å„ªåŒ–ï¼šä¸ä½¿ç”¨ IsLoadingï¼Œé¿å…é¡¯ç¤ºè¼‰å…¥å‹•ç•«é€ æˆé–ƒçˆ
            // IsLoading = true;
            // StateHasChanged();  // ç§»é™¤æ­¤è™•çš„ StateHasChangedï¼Œæ¸›å°‘é‡ç¹ªæ¬¡æ•¸
            
            //  é—œéµä¿®å¾©ï¼šä½¿ç”¨å…§éƒ¨è®Šæ•¸ _currentId è¿½è¹¤å°èˆªå¾Œçš„ ID
            // å› ç‚º Id æ˜¯ [Parameter]ï¼Œç„¡æ³•åœ¨çµ„ä»¶å…§éƒ¨ç›´æ¥ä¿®æ”¹
            _lastId = targetId;
            _currentId = targetId;  // ä½¿ç”¨å…§éƒ¨è®Šæ•¸è¿½è¹¤
            
            // ä½¿ç”¨ Service ç›´æ¥è¼‰å…¥æ–°çš„å¯¦é«”è³‡æ–™ï¼ˆä¸ä¾è³´ DataLoaderï¼‰
            if (Service != null)
            {
                // ä½¿ç”¨åå°„èª¿ç”¨ Service.GetByIdAsync æ–¹æ³•
                var serviceType = Service.GetType();
                var getByIdMethod = serviceType.GetMethod("GetByIdAsync");
                
                if (getByIdMethod != null)
                {
                    var getByIdTask = getByIdMethod.Invoke(Service, new object[] { targetId }) as Task<TEntity>;
                    if (getByIdTask != null)
                    {
                        var loadedEntity = await getByIdTask;
                        if (loadedEntity != null)
                        {
                            //  å„ªåŒ–ï¼šå…ˆå®Œæˆæ‰€æœ‰è³‡æ–™æ›´æ–°ï¼Œæœ€å¾Œæ‰è§¸ç™¼ä¸€æ¬¡ UI é‡ç¹ª
                            Entity = loadedEntity;
                            editContext = new EditContext(Entity);
                            
                            //  è§¸ç™¼ IdChanged äº‹ä»¶ï¼Œé€šçŸ¥çˆ¶çµ„ä»¶ ID å·²è®Šæ›´ï¼ˆé›™å‘ç¶å®šï¼‰
                            if (IdChanged.HasDelegate)
                            {
                                await IdChanged.InvokeAsync(targetId);
                            }
                            
                            //  é‡è¦ï¼šä¸éœ€è¦éå¢ _autoCompleteVersion
                            // å› ç‚º @key="@(Entity?.Id ?? 0)"ï¼ŒEntity.Id è®ŠåŒ–æ™‚çµ„ä»¶æœƒè‡ªå‹•é‡æ–°å‰µå»º
                            
                            //  é‡è¦ï¼šä¸å‘¼å« AdditionalDataLoader
                            // å°èˆªæ™‚è³‡æ–™å·²ç¶“è¼‰å…¥ï¼Œé‡è¤‡å‘¼å«å¯èƒ½å°è‡´ JavaScript é‡è¤‡åˆå§‹åŒ–éŒ¯èª¤
                            // AdditionalDataLoader ä¸»è¦ç”¨æ–¼ Modal é¦–æ¬¡é–‹å•Ÿæ™‚è¼‰å…¥é¸é …è³‡æ–™
                            
                            // æ›´æ–° ActionButtonsï¼ˆåŸºæ–¼æ–°çš„ Entity è³‡æ–™ï¼‰
                            UpdateAllActionButtons();
                            
                            // é‡æ–°è¼‰å…¥ç‹€æ…‹è¨Šæ¯
                            await LoadStatusMessageData();
                            
                            // é‡æ–°è¼‰å…¥å°èˆªç‹€æ…‹ï¼ˆåŸºæ–¼æ–°çš„ Idï¼‰
                            await LoadNavigationStateAsync();
                            
                            //  æ–°å¢ï¼šè§¸ç™¼å¯¦é«”è¼‰å…¥å®Œæˆäº‹ä»¶ï¼Œé€šçŸ¥çˆ¶çµ„ä»¶é‡æ–°è¼‰å…¥æ˜ç´°è³‡æ–™
                            if (OnEntityLoaded.HasDelegate)
                            {
                                await OnEntityLoaded.InvokeAsync(targetId);
                            }
                            
                            //  å„ªåŒ–ï¼šæ‰€æœ‰è³‡æ–™æ›´æ–°å®Œæˆå¾Œï¼Œåªè§¸ç™¼ä¸€æ¬¡ UI é‡ç¹ª
                            StateHasChanged();
                        }
                        else
                        {
                            await ShowErrorMessage($"æ‰¾ä¸åˆ°æŒ‡å®šçš„{EntityName}");
                        }
                    }
                }
            }
            else if (DataLoader != null)
            {
                // å¾Œå‚™æ–¹æ¡ˆï¼šå¦‚æœæ²’æœ‰ Serviceï¼Œå˜—è©¦ä½¿ç”¨ DataLoader
                // ä½†é€™å¯èƒ½ä¸æœƒæ­£ç¢ºè¼‰å…¥æ–° ID çš„è³‡æ–™
                await LoadAllData();
            }
        }
        catch (Exception ex)
        {
            await ShowErrorMessage($"å°èˆªæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            LogError("NavigateToRecordAsync", ex);
        }
        finally
        {
            // IsLoading = false;  // ä¸ä½¿ç”¨ IsLoading
            _isNavigating = false;  //  æ¸…é™¤å°èˆªæ¨™è¨˜
            // StateHasChanged();  // ç§»é™¤æ­¤è™•çš„ StateHasChangedï¼Œå·²åœ¨æˆåŠŸè¼‰å…¥å¾Œè§¸ç™¼
        }
    }
    
    /// <summary>
    /// å–å¾—ä¸Šä¸€ç­†æŒ‰éˆ•çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetPreviousButtonTitle()
    {
        if (!_previousId.HasValue)
            return $"æ²’æœ‰ä¸Šä¸€ç­†{EntityName}";
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºå¾ªç’°å°èˆªï¼ˆç•¶å‰æ˜¯ç¬¬ä¸€ç­†ï¼Œä¸Šä¸€ç­†æ˜¯æœ€å¾Œä¸€ç­†ï¼‰
        if (_firstId.HasValue && Id.HasValue && Id.Value == _firstId.Value)
            return $"åˆ‡æ›åˆ°æœ€å¾Œä¸€ç­†{EntityName}ï¼ˆå¾ªç’°ï¼‰";
        
        return $"åˆ‡æ›åˆ°ä¸Šä¸€ç­†{EntityName}";
    }
    
    /// <summary>
    /// å–å¾—ä¸‹ä¸€ç­†æŒ‰éˆ•çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetNextButtonTitle()
    {
        if (!_nextId.HasValue)
            return $"æ²’æœ‰ä¸‹ä¸€ç­†{EntityName}";
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºå¾ªç’°å°èˆªï¼ˆç•¶å‰æ˜¯æœ€å¾Œä¸€ç­†ï¼Œä¸‹ä¸€ç­†æ˜¯ç¬¬ä¸€ç­†ï¼‰
        if (_lastRecordId.HasValue && Id.HasValue && Id.Value == _lastRecordId.Value)
            return $"åˆ‡æ›åˆ°ç¬¬ä¸€ç­†{EntityName}ï¼ˆå¾ªç’°ï¼‰";
        
        return $"åˆ‡æ›åˆ°ä¸‹ä¸€ç­†{EntityName}";
    }
    
    #endregion
    
    // ===== æ¸…ç†è³‡æº =====
    
    // Dispose æ–¹æ³•å·²ç§»é™¤ï¼Œè³‡æºæ¸…ç†ç”± BaseModalComponent è‡ªå‹•è™•ç†
}
