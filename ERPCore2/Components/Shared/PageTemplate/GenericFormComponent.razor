@* 通用表單組件 - 基於配置驅動的動態表單 *@
@* 使用子組件架構重構版本 *@
@using System.ComponentModel.DataAnnotations
@using System.Reflection
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@using ERPCore2.Components.Shared.UI.Button
@using ERPCore2.Components.Shared.UI.Form
@typeparam TModel

<div class="generic-form-container">
    @* 添加假的隱藏欄位來欺騙瀏覽器的自動填入功能 *@
    <input type="text" style="display:none" autocomplete="off" />
    <input type="password" style="display:none" autocomplete="new-password" />
    
    <EditForm Model="Model" @ref="editForm">
        <DataAnnotationsValidator />
        
        @if (ShowValidationSummary)
        {
            <ValidationSummary />
        }
        
        @if (FieldSections != null && FieldSections.Any() && FieldDefinitions != null)
        {
            @* 區段佈局 - 所有區段在同一頁面顯示 *@
            var orderedSections = GetOrderedSections().ToList();
            
            @foreach (var sectionGroup in orderedSections)
            {
                <div class="mb-2 form-section-wrapper">
                    <h6 class="text-primary fw-bold section-title-compact">@(sectionGroup.Key)</h6>
                    <div class="row g-1">
                        @foreach (var fieldKvp in sectionGroup)
                        {
                            var field = FieldDefinitions?.FirstOrDefault(f => f.PropertyName == fieldKvp.Key);
                            if (field != null)
                            {
                                @RenderFieldMarkup(field)
                            }
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <div class="row g-1">
                @if (FieldDefinitions != null)
                {
                    @foreach (var field in FieldDefinitions)
                    {
                        @RenderFieldMarkup(field)
                    }
                }
            </div>
        }
    </EditForm>
</div>

@code
{
    /// <summary>
    /// 渲染欄位標記的輔助方法
    /// </summary>
    private RenderFragment RenderFieldMarkup(FormFieldDefinition field) => __builder =>
    {
        // 如果欄位設定為不可見，則不渲染
        if (!field.IsVisible)
        {
            return;
        }
        
        var containerCssClass = string.IsNullOrEmpty(field.ContainerCssClass) ? FieldContainerCssClass : field.ContainerCssClass;
        var hasActionButtons = field.ActionButtons != null && field.ActionButtons.Any();
        
        <div class="@containerCssClass">
            @if (!string.IsNullOrEmpty(field.Label) && field.FieldType != FormFieldType.Checkbox)
            {
                <label class="@FormConstants.CssClasses.FormLabel" for="@field.PropertyName" title="@field.HelpText">
                    @field.Label
                    @if (field.IsRequired)
                    {
                        <span class="text-danger"> *</span>
                    }
                </label>
            }
            
            @* 判斷是否需要包裝 input 與按鈕的容器 *@
            @if (hasActionButtons && ShouldWrapWithActionButtons(field.FieldType))
            {
                var multipleButtonsClass = field.ActionButtons?.Count > 1 ? FormConstants.CssClasses.MultipleButtons : "";
                <div class="@FormConstants.CssClasses.PositionRelative @FormConstants.CssClasses.InputWithActionButtons @multipleButtonsClass">
                    @RenderInputField(field, hasActionButtons)
                    
                    @* 在 Input 右側渲染圖示按鈕 *@
                    <div class="input-action-buttons-container">
                        @foreach (var actionButton in field.ActionButtons!)
                        {
                            <button type="button"
                                    class="btn input-action-button"
                                    title="@(actionButton.Title ?? actionButton.Text)"
                                    disabled="@actionButton.IsDisabled"
                                    @onclick="@(actionButton.OnClick ?? (() => Task.CompletedTask))">
                                <i class="@FormConstants.GetIconForButtonText(actionButton.Text)"></i>
                            </button>
                        }
                    </div>
                </div>
            }
            else
            {
                @RenderInputField(field, hasActionButtons)
            }
        </div>
    };

    /// <summary>
    /// 渲染輸入欄位 - 使用子組件
    /// </summary>
    private RenderFragment RenderInputField(FormFieldDefinition field, bool hasActionButtons) => __builder =>
    {
        var cssClass = GetInputCssClass(field);
        
        @switch (field.FieldType)
        {
            case FormFieldType.Text:
            case FormFieldType.Email:
            case FormFieldType.Password:
                <FormTextField Field="@field"
                               Value="@GetPropertyValue(Model, field.PropertyName)?.ToString()"
                               ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))"
                               HasActionButtons="@hasActionButtons"
                               CssClass="@cssClass" />
                break;
            
            case FormFieldType.MobilePhone:
                <FormMobilePhoneField Field="@field"
                                      Value="@GetPropertyValue(Model, field.PropertyName)?.ToString()"
                                      ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))"
                                      HasActionButtons="@hasActionButtons"
                                      CssClass="@cssClass" />
                break;
                
            case FormFieldType.Number:
                <FormNumberField Field="@field"
                                 Value="@GetPropertyValue(Model, field.PropertyName)"
                                 ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))"
                                 HasActionButtons="@hasActionButtons"
                                 CssClass="@cssClass" />
                break;
                
            case FormFieldType.Date:
            case FormFieldType.DateTime:
                var dateValue = GetPropertyValue(Model, field.PropertyName);
                <FormDateField Field="@field"
                               Value="@(dateValue is DateTime dt ? dt : null)"
                               ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))"
                               HasActionButtons="@hasActionButtons"
                               CssClass="@cssClass" />
                break;
                
            case FormFieldType.TextArea:
                <FormTextAreaField Field="@field"
                                   Value="@GetPropertyValue(Model, field.PropertyName)?.ToString()"
                                   ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))"
                                   CssClass="@cssClass" />
                break;
                
            case FormFieldType.TextAreaWithCharacterCount:
                <CharacterCountTextAreaComponent 
                    Value="@GetPropertyValue(Model, field.PropertyName)?.ToString()"
                    ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))"
                    Id="@field.PropertyName"
                    CssClass="@cssClass"
                    Placeholder="@field.Placeholder"
                    HelpText="@field.HelpText"
                    IsReadOnly="@field.IsReadOnly"
                    IsDisabled="@field.IsDisabled"
                    Rows="@(field.Rows ?? FormConstants.Defaults.TextAreaRows)"
                    MaxCharacters="@(field.MaxLength ?? FormConstants.Defaults.MaxCharacters)"
                    MaxBytes="@(field.MaxBytes ?? FormConstants.Defaults.MaxBytes)" />
                break;
                
            case FormFieldType.Select:
                <FormSelectField Field="@field"
                                 Value="@GetPropertyValue(Model, field.PropertyName)"
                                 ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))"
                                 HasActionButtons="@hasActionButtons"
                                 CssClass="@cssClass" />
                break;
                
            case FormFieldType.Checkbox:
                var checkboxValue = GetPropertyValue(Model, field.PropertyName);
                <FormCheckboxField Field="@field"
                                   Value="@(checkboxValue is bool b && b)"
                                   ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))" />
                break;
                
            case FormFieldType.Radio:
                <FormRadioField Field="@field"
                                Value="@GetPropertyValue(Model, field.PropertyName)?.ToString()"
                                ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))" />
                break;
                
            case FormFieldType.AutoComplete:
                <FormAutoCompleteField Field="@field"
                                       Value="@GetPropertyValue(Model, field.PropertyName)?.ToString()"
                                       ValueChanged="@(value => HandleAutoCompleteFieldChanged(field.PropertyName, value))"
                                       InitialDisplayValue="@GetAutoCompleteDisplayValue(field.PropertyName)"
                                       HasActionButtons="@hasActionButtons"
                                       CssClass="@cssClass" />
                break;
                
            default:
                <FormTextField Field="@field"
                               Value="@GetPropertyValue(Model, field.PropertyName)?.ToString()"
                               ValueChanged="@(value => HandleFieldChanged(field.PropertyName, value))"
                               HasActionButtons="@hasActionButtons"
                               CssClass="@cssClass" />
                break;
        }
    };

    /// <summary>
    /// 處理欄位變更
    /// </summary>
    private void HandleFieldChanged(string propertyName, object? value)
    {
        SetPropertyValue(Model, propertyName, value);
    }

    /// <summary>
    /// 處理 AutoComplete 欄位變更
    /// </summary>
    private void HandleAutoCompleteFieldChanged(string propertyName, string? value)
    {
        SetPropertyValue(Model, propertyName, value);
    }
}
