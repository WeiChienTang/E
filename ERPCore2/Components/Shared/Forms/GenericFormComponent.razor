@* é€šç”¨è¡¨å–®çµ„ä»¶ - åŸºæ–¼é…ç½®é©…å‹•çš„å‹•æ…‹è¡¨å–® *@
@using System.ComponentModel.DataAnnotations
@using System.Reflection
@using Microsoft.AspNetCore.Components.Rendering
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@using ERPCore2.Components.Shared.Buttons
@using ERPCore2.Components.Shared.Forms
@inject IJSRuntime JSRuntime
@typeparam TModel
@implements IDisposable

    <div class="@GetFormBodyCssClass()">
        @* æ·»åŠ å‡çš„éš±è—æ¬„ä½ä¾†æ¬ºé¨™ç€è¦½å™¨çš„è‡ªå‹•å¡«å…¥åŠŸèƒ½ *@
        <input type="text" style="display:none" autocomplete="off" />
        <input type="password" style="display:none" autocomplete="new-password" />
        
        <EditForm Model="Model" OnValidSubmit="HandleValidSubmit" @ref="editForm">
            <DataAnnotationsValidator />
            
            @if (ShowValidationSummary)
            {
                <ValidationSummary class="alert alert-danger" />
            }
            
            @if (FieldSections != null && FieldSections.Any() && FieldDefinitions != null)
            {
                @* æŒ‰ç…§ FieldDefinitions ä¸­çš„æ¬„ä½é †åºä¾†æ’åˆ—å€æ®µ *@
                @foreach (var section in GetOrderedSections())
                {
                    <div class="mb-2">
                        <h6 class="text-primary border-bottom pb-2">@(section.Key)</h6>
                        <div class="row g-3">
                            @foreach (var fieldKvp in section)
                            {
                                var field = FieldDefinitions?.FirstOrDefault(f => f.PropertyName == fieldKvp.Key);
                                if (field != null)
                                {
                                    @RenderField(field)
                                }
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="row g-3">
                    @if (FieldDefinitions != null)
                    {
                        @foreach (var field in FieldDefinitions)
                        {
                            @RenderField(field)
                        }
                    }
                </div>
            }              
            @if (ShowFormButtons)
            {
                <div class="mt-2 d-flex gap-2">
                    <GenericButtonComponent Variant="ButtonVariant.Primary" Text="@SubmitButtonText" 
                                           OnClick="@(async () => await HandleValidSubmit())" IsDisabled="@IsSubmitting" 
                                           IsLoading="@IsSubmitting" IsSubmit="true" />
                    
                    @if (ShowCancelButton)
                    {
                        <GenericButtonComponent Variant="ButtonVariant.Secondary" Text="@CancelButtonText" 
                                               OnClick="@(async () => await HandleCancel())" IsDisabled="@IsSubmitting" />
                    }
                    
                    @if (ShowResetButton)
                    {
                        <GenericButtonComponent Variant="ButtonVariant.OutlineSecondary" Text="@ResetButtonText" 
                                               Type="reset" IsDisabled="@IsSubmitting" />
                    }
                </div>
            }
        </EditForm>
    </div>

@code {
    [Parameter] public TModel Model { get; set; } = default!;
    [Parameter] public List<FormFieldDefinition>? FieldDefinitions { get; set; }
    [Parameter] public Dictionary<string, string>? FieldSections { get; set; }
    [Parameter] public EventCallback<TModel> OnFormSubmit { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<(string PropertyName, object? Value)> OnFieldChanged { get; set; }
    [Parameter] public bool IsSubmitting { get; set; } = false;
    [Parameter] public bool ShowFormHeader { get; set; } = true;
    [Parameter] public bool ShowFormButtons { get; set; } = true;
    [Parameter] public bool ShowCancelButton { get; set; } = true;
    [Parameter] public bool ShowResetButton { get; set; } = false;
    [Parameter] public bool ShowValidationSummary { get; set; } = true;
    [Parameter] public string FormTitle { get; set; } = "è¡¨å–®";
    [Parameter] public string FormIconClass { get; set; } = string.Empty;
    [Parameter] public string SubmitButtonText { get; set; } = "æäº¤";
    [Parameter] public string CancelButtonText { get; set; } = "å–æ¶ˆ";
    [Parameter] public string ResetButtonText { get; set; } = "é‡ç½®";
    [Parameter] public string FormCssClass { get; set; } = "card";
    [Parameter] public string FormBodyCssClass { get; set; } = "card-body";
    [Parameter] public string FieldContainerCssClass { get; set; } = "col-md-2";

    private EditForm? editForm;
      // è‡ªå‹•å®Œæˆç›¸é—œç‹€æ…‹
    private readonly Dictionary<string, List<SelectOption>> autoCompleteOptions = new();
    private readonly Dictionary<string, bool> autoCompleteLoading = new();
    private readonly Dictionary<string, bool> autoCompleteVisible = new();
    private readonly Dictionary<string, Timer?> autoCompleteTimers = new();
    private readonly Dictionary<string, string> autoCompleteDisplayValues = new();
    private readonly HashSet<string> blurredFields = new(); // è¿½è¹¤å¤±å»ç„¦é»çš„æ¬„ä½
    
    // éµç›¤å°èˆªç‹€æ…‹
    private readonly Dictionary<string, int> highlightedOptionIndex = new();
    private readonly Dictionary<string, bool> keyboardNavigationActive = new();

    private async Task HandleValidSubmit()
    {
        if (OnFormSubmit.HasDelegate)
        {
            await OnFormSubmit.InvokeAsync(Model);
        }
    }    private async Task HandleCancel()
    {
        if (OnCancel.HasDelegate)
        {
            await OnCancel.InvokeAsync();
        }
    }    protected override void OnParametersSet()
    {
        // åˆå§‹åŒ– AutoComplete æ¬„ä½çš„é¡¯ç¤ºå€¼
        if (FieldDefinitions != null && Model != null)
        {
            foreach (var field in FieldDefinitions.Where(f => f.FieldType == FormFieldType.AutoComplete))
            {
                var fieldId = field.PropertyName;
                var value = GetPropertyValue(Model, field.PropertyName);
                
                if (value != null && !autoCompleteDisplayValues.ContainsKey(fieldId))
                {
                    // å°æ–¼æ–°åŠ è¼‰çš„è³‡æ–™ï¼Œå…ˆè¨­ç½® ID å€¼ä½œç‚ºé¡¯ç¤ºå€¼
                    // å¯¦éš›çš„é¡¯ç¤ºæ–‡å­—æœƒåœ¨ä½¿ç”¨è€…èˆ‡æ¬„ä½äº’å‹•æ™‚é€šéæœç´¢ç²å–
                    autoCompleteDisplayValues[fieldId] = "";
                    
                    // å¦‚æœæˆ‘å€‘èƒ½å¤ å¿«é€ŸæŸ¥æ‰¾é¡¯ç¤ºæ–‡å­—ï¼Œå‰‡è¨­ç½®å®ƒ
                    _ = Task.Run(async () =>
                    {
                        try
                        {
                            if (field.SearchFunction != null)
                            {
                                // å˜—è©¦ä½¿ç”¨ç©ºå­—ç¬¦ä¸²æœç´¢ä¾†ç²å–æ‰€æœ‰é¸é …ï¼Œç„¶å¾Œæ‰¾åˆ°åŒ¹é…çš„é …ç›®
                                var options = await field.SearchFunction("");
                                var matchingOption = options.FirstOrDefault(o => o.Value == value.ToString());
                                if (matchingOption != null)
                                {
                                    await InvokeAsync(() =>
                                    {
                                        autoCompleteDisplayValues[fieldId] = matchingOption.Text;
                                        StateHasChanged();
                                    });
                                }
                            }
                        }
                        catch
                        {
                            // éœé»˜è™•ç†ï¼Œä¿æŒåŸä¾†çš„é¡¯ç¤ºå€¼
                        }
                    });
                }
            }
            
            // è™•ç†æ¬„ä½çš„é è¨­å€¼
            foreach (var field in FieldDefinitions)
            {
                if (field.DefaultValue != null)
                {
                    var currentValue = GetPropertyValue(Model, field.PropertyName);
                    
                    // åªæœ‰ç•¶å±¬æ€§å€¼ç‚º null æˆ–æ˜¯é è¨­å€¼æ™‚æ‰è¨­å®šé è¨­å€¼
                    if (ShouldApplyDefaultValue(currentValue, field))
                    {
                        SetPropertyValue(Model, field.PropertyName, field.DefaultValue);
                    }
                }
            }
        }
        
        base.OnParametersSet();
    }

    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦æ‡‰è©²æ‡‰ç”¨é è¨­å€¼
    /// </summary>
    private bool ShouldApplyDefaultValue(object? currentValue, FormFieldDefinition field)
    {
        // å¦‚æœç•¶å‰å€¼æ˜¯ nullï¼Œå‰‡æ‡‰ç”¨é è¨­å€¼
        if (currentValue == null)
            return true;
            
        // å°æ–¼å­—ä¸²é¡å‹ï¼Œå¦‚æœæ˜¯ç©ºå­—ä¸²ä¹Ÿæ‡‰ç”¨é è¨­å€¼
        if (currentValue is string str && string.IsNullOrEmpty(str))
            return true;
            
        // å°æ–¼æ•¸å€¼é¡å‹ï¼Œå¦‚æœæ˜¯é è¨­å€¼ï¼ˆå¦‚ 0ï¼‰ä¹Ÿå¯ä»¥æ‡‰ç”¨é è¨­å€¼ï¼ˆé€™éƒ¨åˆ†å¯ä»¥æ ¹æ“šéœ€æ±‚èª¿æ•´ï¼‰
        // é€™è£¡æˆ‘å€‘ä¿å®ˆä¸€é»ï¼Œåªæœ‰ç•¶å€¼ç¢ºå¯¦æ˜¯ null æˆ–ç©ºå­—ä¸²æ™‚æ‰æ‡‰ç”¨é è¨­å€¼
        
        return false;
    }

    // æŒ‰ç…§ FieldDefinitions ä¸­çš„æ¬„ä½é †åºä¾†æ’åˆ—å€æ®µ
    private IEnumerable<IGrouping<string, KeyValuePair<string, string>>> GetOrderedSections()
    {
        if (FieldDefinitions == null || FieldSections == null)
            return Enumerable.Empty<IGrouping<string, KeyValuePair<string, string>>>();

        // å»ºç«‹å€æ®µå‡ºç¾é †åºçš„å°æ‡‰è¡¨
        var sectionOrderMap = new Dictionary<string, int>();
        var sectionOrder = 0;
        
        foreach (var field in FieldDefinitions)
        {
            if (FieldSections.TryGetValue(field.PropertyName, out var sectionName))
            {
                if (!sectionOrderMap.ContainsKey(sectionName))
                {
                    sectionOrderMap[sectionName] = sectionOrder++;
                }
            }
        }

        // æŒ‰ç…§å€æ®µåœ¨ FieldDefinitions ä¸­çš„å‡ºç¾é †åºæ’åˆ—
        return FieldSections
            .GroupBy(kvp => kvp.Value)
            .OrderBy(g => sectionOrderMap.GetValueOrDefault(g.Key, int.MaxValue));
    }

    private string GetFormCssClass()
    {
        return string.IsNullOrEmpty(FormCssClass) ? "" : FormCssClass;
    }

    private string GetFormBodyCssClass()
    {
        return string.IsNullOrEmpty(FormBodyCssClass) ? "" : FormBodyCssClass;
    }

    private RenderFragment RenderField(FormFieldDefinition field) => builder =>
    {
    var containerCssClass = string.IsNullOrEmpty(field.ContainerCssClass) ? FieldContainerCssClass : field.ContainerCssClass;
            
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", containerCssClass);
        
        // æ¬„ä½æ¨™ç±¤
        if (!string.IsNullOrEmpty(field.Label))
        {
            builder.OpenElement(2, "div");
            builder.AddAttribute(3, "class", "d-flex align-items-center gap-2 mb-1");
            
            builder.OpenElement(4, "label");
            builder.AddAttribute(5, "class", "form-label mb-0");
            builder.AddAttribute(6, "for", field.PropertyName);
            
            // å¦‚æœæœ‰ HelpTextï¼Œå°‡å…¶ä½œç‚º title å±¬æ€§é¡¯ç¤ºç‚º Tooltip
            if (!string.IsNullOrEmpty(field.HelpText))
            {
                builder.AddAttribute(7, "title", field.HelpText);
                builder.AddAttribute(8, "style", "cursor: help;");
            }
            
            builder.AddContent(9, field.Label);
            
            if (field.IsRequired)
            {
                builder.OpenElement(10, "span");
                builder.AddAttribute(11, "class", "text-danger");
                builder.AddContent(12, " *");
                builder.CloseElement();
            }
            builder.CloseElement(); // label
            
            // æ¸²æŸ“æ“ä½œæŒ‰éˆ•
            if (field.ActionButtons != null && field.ActionButtons.Any())
            {
                var buttonSequence = 13;
                foreach (var actionButton in field.ActionButtons)
                {
                    builder.OpenComponent(buttonSequence, typeof(ERPCore2.Components.Shared.Buttons.GenericButtonComponent));
                    builder.AddAttribute(buttonSequence + 1, "Text", actionButton.Text);
                    builder.AddAttribute(buttonSequence + 2, "Variant", GetButtonVariant(actionButton.Variant));
                    builder.AddAttribute(buttonSequence + 3, "Size", GetButtonSize(actionButton.Size));
                    builder.AddAttribute(buttonSequence + 4, "CssClass", "field-action-button"); // æ·»åŠ ç‰¹å®š CSS class
                    if (!string.IsNullOrEmpty(actionButton.IconClass))
                    {
                        builder.AddAttribute(buttonSequence + 5, "IconClass", actionButton.IconClass);
                    }
                    if (!string.IsNullOrEmpty(actionButton.Title))
                    {
                        builder.AddAttribute(buttonSequence + 6, "Title", actionButton.Title);
                    }
                    if (actionButton.OnClick != null)
                    {
                        builder.AddAttribute(buttonSequence + 7, "OnClick", EventCallback.Factory.Create(this, actionButton.OnClick));
                    }
                    builder.AddAttribute(buttonSequence + 8, "IsDisabled", actionButton.IsDisabled);
                    builder.CloseComponent();
                    buttonSequence += 9;
                }
            }
            
            builder.CloseElement(); // div
        }
        
        // æ ¹æ“šæ¬„ä½é¡å‹æ¸²æŸ“ä¸åŒçš„è¼¸å…¥æ§åˆ¶é …
        switch (field.FieldType)
        {
            case FormFieldType.Text:
            case FormFieldType.Email:
            case FormFieldType.Password:
                RenderTextInput(builder, field, 9);
                break;
            case FormFieldType.Number:
                RenderNumberInput(builder, field, 9);
                break;
            case FormFieldType.Date:
                RenderDateInput(builder, field, 9);
                break;
            case FormFieldType.DateTime:
                RenderDateTimeInput(builder, field, 9);
                break;
            case FormFieldType.TextArea:
                RenderTextArea(builder, field, 9);
                break;
            case FormFieldType.TextAreaWithCharacterCount:
                RenderTextAreaWithCharacterCount(builder, field, 9);
                break;
            case FormFieldType.Select:
                RenderSelect(builder, field, 9);
                break;
            case FormFieldType.Checkbox:
                RenderCheckbox(builder, field, 9);
                break;            case FormFieldType.Radio:
                RenderRadio(builder, field, 9);
                break;
            case FormFieldType.AutoComplete:
                RenderAutoComplete(builder, field, 9);
                break;
            default:
                RenderTextInput(builder, field, 9);
                break;
        }
        
        // èªªæ˜æ–‡å­—å·²æ”¹ç‚º Label çš„ Tooltipï¼Œå› æ­¤é€™è£¡ä¸å†é¡¯ç¤º
        // TextAreaWithCharacterCount æœƒè‡ªå·±è™•ç† helpText é¡¯ç¤ºï¼Œæ‰€ä»¥ä¿ç•™
        // if (!string.IsNullOrEmpty(field.HelpText) && field.FieldType != FormFieldType.TextAreaWithCharacterCount)
        // {
        //     builder.OpenElement(20, "div");
        //     builder.AddAttribute(21, "class", "form-text");
        //     builder.AddContent(22, field.HelpText);
        //     builder.CloseElement();
        // }
        
        // é©—è­‰è¨Šæ¯ - ä½¿ç”¨ç°¡å–®çš„é©—è­‰éŒ¯èª¤é¡¯ç¤ºï¼Œä¸ä¾è³´ ValidationMessage çµ„ä»¶
        if (field.IsRequired && ShowValidationSummary)
        {
            builder.OpenElement(23, "div");
            builder.AddAttribute(24, "class", "invalid-feedback");
            builder.AddContent(25, $"{field.Label} ç‚ºå¿…å¡«æ¬„ä½");
            builder.CloseElement();
        }
        
        builder.CloseElement(); // container div
    };    private void RenderTextInput(RenderTreeBuilder builder, FormFieldDefinition field, int sequence)
    {
        builder.OpenElement(sequence, "input");
        builder.AddAttribute(sequence + 1, "type", GetInputType(field.FieldType));
        builder.AddAttribute(sequence + 2, "class", GetInputCssClass(field));
        builder.AddAttribute(sequence + 3, "id", field.PropertyName);
        builder.AddAttribute(sequence + 4, "name", field.PropertyName + "_" + Guid.NewGuid().ToString("N").Substring(0, 8)); // éš¨æ©Ÿ name é¿å…ç€è¦½å™¨è¨˜æ†¶
        builder.AddAttribute(sequence + 5, "placeholder", field.Placeholder);
        builder.AddAttribute(sequence + 6, "readonly", field.IsReadOnly);
        builder.AddAttribute(sequence + 7, "disabled", field.IsDisabled);
        
        // æ·»åŠ  autocomplete å±¬æ€§æ”¯æ´ - ä½¿ç”¨å¤šé‡ç­–ç•¥é˜²æ­¢è‡ªå‹•å¡«å…¥
        var autocompleteValue = !string.IsNullOrEmpty(field.AutoCompleteAttribute) 
            ? field.AutoCompleteAttribute 
            : (field.FieldType == FormFieldType.Password ? "new-password" : "off");
        builder.AddAttribute(sequence + 8, "autocomplete", autocompleteValue);
        
        if (field.IsRequired)
        {
            builder.AddAttribute(sequence + 9, "required", true);
        }
        if (field.MaxLength.HasValue)
        {
            builder.AddAttribute(sequence + 10, "maxlength", field.MaxLength.Value);
        }
        if (field.MinLength.HasValue)
        {
            builder.AddAttribute(sequence + 11, "minlength", field.MinLength.Value);
        }
        builder.AddAttribute(sequence + 12, "value", GetPropertyValue(Model, field.PropertyName)?.ToString());
        builder.AddAttribute(sequence + 13, "oninput", EventCallback.Factory.CreateBinder(this, 
            value => SetPropertyValue(Model, field.PropertyName, value), 
            GetPropertyValue(Model, field.PropertyName)?.ToString() ?? ""));
        builder.CloseElement();
    }    private void RenderNumberInput(RenderTreeBuilder builder, FormFieldDefinition field, int sequence)
    {
        builder.OpenElement(sequence, "input");
        builder.AddAttribute(sequence + 1, "type", "number");
        builder.AddAttribute(sequence + 2, "class", GetInputCssClass(field));
        builder.AddAttribute(sequence + 3, "id", field.PropertyName);
        builder.AddAttribute(sequence + 4, "placeholder", field.Placeholder);
        builder.AddAttribute(sequence + 5, "readonly", field.IsReadOnly);
        builder.AddAttribute(sequence + 6, "disabled", field.IsDisabled);
        
        if (field.IsRequired)
        {
            builder.AddAttribute(sequence + 7, "required", true);
        }
        
        if (field.Min.HasValue)
            builder.AddAttribute(sequence + 8, "min", field.Min.Value);
        if (field.Max.HasValue)
            builder.AddAttribute(sequence + 9, "max", field.Max.Value);
        if (field.Step.HasValue)
            builder.AddAttribute(sequence + 10, "step", field.Step.Value);
        
        // å°æ–¼å¯ç©ºæ•¸å­—æ¬„ä½ï¼Œç•¶å€¼ç‚º null æ™‚é¡¯ç¤ºç©ºå­—ä¸²è€Œä¸æ˜¯ 0
        var propertyValue = GetPropertyValue(Model, field.PropertyName);
        var displayValue = propertyValue?.ToString() ?? "";
            
        builder.AddAttribute(sequence + 11, "value", displayValue);
        builder.AddAttribute(sequence + 12, "onchange", EventCallback.Factory.CreateBinder(this, 
            value => SetPropertyValue(Model, field.PropertyName, value), 
            displayValue));
        builder.CloseElement();
    }

    private void RenderDateInput(RenderTreeBuilder builder, FormFieldDefinition field, int sequence)
    {
        builder.OpenElement(sequence, "input");
        builder.AddAttribute(sequence + 1, "type", "date");
        builder.AddAttribute(sequence + 2, "class", GetInputCssClass(field));
        builder.AddAttribute(sequence + 3, "id", field.PropertyName);
        builder.AddAttribute(sequence + 4, "readonly", field.IsReadOnly);
        builder.AddAttribute(sequence + 5, "disabled", field.IsDisabled);
        
        var dateValue = GetPropertyValue(Model, field.PropertyName);
        if (dateValue is DateTime dt)
        {
            builder.AddAttribute(sequence + 6, "value", dt.ToString("yyyy-MM-dd"));
        }
        
        builder.AddAttribute(sequence + 7, "onchange", EventCallback.Factory.CreateBinder(this, 
            value => SetPropertyValue(Model, field.PropertyName, value), 
            dateValue?.ToString() ?? ""));
        builder.CloseElement();
    }

    private void RenderDateTimeInput(RenderTreeBuilder builder, FormFieldDefinition field, int sequence)
    {
        builder.OpenElement(sequence, "input");
        builder.AddAttribute(sequence + 1, "type", "datetime-local");
        builder.AddAttribute(sequence + 2, "class", GetInputCssClass(field));
        builder.AddAttribute(sequence + 3, "id", field.PropertyName);
        builder.AddAttribute(sequence + 4, "readonly", field.IsReadOnly);
        builder.AddAttribute(sequence + 5, "disabled", field.IsDisabled);
        
        var dateValue = GetPropertyValue(Model, field.PropertyName);
        if (dateValue is DateTime dt)
        {
            builder.AddAttribute(sequence + 6, "value", dt.ToString("yyyy-MM-ddTHH:mm"));
        }
        
        builder.AddAttribute(sequence + 7, "onchange", EventCallback.Factory.CreateBinder(this, 
            value => SetPropertyValue(Model, field.PropertyName, value), 
            dateValue?.ToString() ?? ""));
        builder.CloseElement();
    }

    private void RenderTextArea(RenderTreeBuilder builder, FormFieldDefinition field, int sequence)
    {
        builder.OpenElement(sequence, "textarea");
        builder.AddAttribute(sequence + 1, "class", GetInputCssClass(field));
        builder.AddAttribute(sequence + 2, "id", field.PropertyName);
        builder.AddAttribute(sequence + 3, "placeholder", field.Placeholder);
        builder.AddAttribute(sequence + 4, "readonly", field.IsReadOnly);
        builder.AddAttribute(sequence + 5, "disabled", field.IsDisabled);
        builder.AddAttribute(sequence + 6, "rows", field.Rows ?? 3);
        if (field.MaxLength.HasValue)
        {
            builder.AddAttribute(sequence + 7, "maxlength", field.MaxLength.Value);
        }
        if (field.MinLength.HasValue)
        {
            builder.AddAttribute(sequence + 8, "minlength", field.MinLength.Value);
        }
        builder.AddAttribute(sequence + 9, "value", GetPropertyValue(Model, field.PropertyName)?.ToString());
        builder.AddAttribute(sequence + 10, "onchange", EventCallback.Factory.CreateBinder(this, 
            value => SetPropertyValue(Model, field.PropertyName, value), 
            GetPropertyValue(Model, field.PropertyName)?.ToString() ?? ""));
        builder.CloseElement();
    }

    private void RenderTextAreaWithCharacterCount(RenderTreeBuilder builder, FormFieldDefinition field, int sequence)
    {
        builder.OpenComponent<ERPCore2.Components.Shared.Forms.CharacterCountTextAreaComponent>(sequence);
        builder.AddAttribute(sequence + 1, "Value", GetPropertyValue(Model, field.PropertyName)?.ToString());
        builder.AddAttribute(sequence + 2, "ValueChanged", EventCallback.Factory.Create<string>(this, 
            value => SetPropertyValue(Model, field.PropertyName, value)));
        builder.AddAttribute(sequence + 3, "Id", field.PropertyName);
        builder.AddAttribute(sequence + 4, "CssClass", GetInputCssClass(field));
        builder.AddAttribute(sequence + 5, "Placeholder", field.Placeholder);
        builder.AddAttribute(sequence + 6, "HelpText", field.HelpText);
        builder.AddAttribute(sequence + 7, "IsReadOnly", field.IsReadOnly);
        builder.AddAttribute(sequence + 8, "IsDisabled", field.IsDisabled);
        builder.AddAttribute(sequence + 9, "Rows", field.Rows ?? 3);
        builder.AddAttribute(sequence + 10, "MaxCharacters", field.MaxLength ?? 500);
        builder.AddAttribute(sequence + 11, "MaxBytes", field.MaxBytes ?? 500);
        builder.CloseComponent();
    }

    private void RenderSelect(RenderTreeBuilder builder, FormFieldDefinition field, int sequence)
    {
        builder.OpenElement(sequence, "select");
        builder.AddAttribute(sequence + 1, "class", GetInputCssClass(field));
        builder.AddAttribute(sequence + 2, "id", field.PropertyName);
        builder.AddAttribute(sequence + 3, "disabled", field.IsReadOnly || field.IsDisabled);
        builder.AddAttribute(sequence + 4, "onchange", EventCallback.Factory.CreateBinder(this, 
            value => SetPropertyValue(Model, field.PropertyName, value), 
            GetPropertyValue(Model, field.PropertyName)?.ToString() ?? ""));
        
        // ç©ºé¸é …
        if (!field.IsRequired)
        {
            builder.OpenElement(sequence + 10, "option");
            builder.AddAttribute(sequence + 11, "value", "");
            builder.AddContent(sequence + 12, "è«‹é¸æ“‡...");
            builder.CloseElement();
        }        
        // é¸é …
        if (field.Options != null)
        {
            var currentValueObj = GetPropertyValue(Model, field.PropertyName);
            var currentValue = currentValueObj?.ToString();
            
            // ç‰¹åˆ¥è™•ç†æšèˆ‰é¡å‹ï¼Œç¢ºä¿æ¯”è¼ƒå€¼æ­£ç¢º
            if (currentValueObj != null && currentValueObj.GetType().IsEnum)
            {
                currentValue = ((int)currentValueObj).ToString();
            }
            
            var optionSequence = sequence + 20;
            
            foreach (var option in field.Options)
            {
                builder.OpenElement(optionSequence, "option");
                builder.AddAttribute(optionSequence + 1, "value", option.Value);
                builder.AddAttribute(optionSequence + 2, "selected", option.Value == currentValue);
                builder.AddContent(optionSequence + 3, option.Text);
                builder.CloseElement();
                optionSequence += 4;
            }        }
        
        builder.CloseElement();
    }

    private void RenderCheckbox(RenderTreeBuilder builder, FormFieldDefinition field, int sequence)
    {
        builder.OpenElement(sequence, "div");
        builder.AddAttribute(sequence + 1, "class", "form-check");
        
        builder.OpenElement(sequence + 2, "input");
        builder.AddAttribute(sequence + 3, "type", "checkbox");
        builder.AddAttribute(sequence + 4, "class", "form-check-input");
        builder.AddAttribute(sequence + 5, "id", field.PropertyName);
        builder.AddAttribute(sequence + 6, "disabled", field.IsReadOnly || field.IsDisabled);
          var currentValue = GetPropertyValue(Model, field.PropertyName);
        bool boolValue = false;
        if (currentValue is bool b)
        {
            boolValue = b;
            builder.AddAttribute(sequence + 7, "checked", boolValue);
        }
        
        builder.AddAttribute(sequence + 8, "onchange", EventCallback.Factory.CreateBinder(this, 
            value => SetPropertyValue(Model, field.PropertyName, value), 
            boolValue));
        builder.CloseElement();
        
        builder.OpenElement(sequence + 9, "label");
        builder.AddAttribute(sequence + 10, "class", "form-check-label");
        builder.AddAttribute(sequence + 11, "for", field.PropertyName);
        builder.AddContent(sequence + 12, field.Label);
        builder.CloseElement();
        
        builder.CloseElement();
    }

    private void RenderRadio(RenderTreeBuilder builder, FormFieldDefinition field, int sequence)
    {
        if (field.Options != null)
        {
            var currentValue = GetPropertyValue(Model, field.PropertyName)?.ToString();
            var radioSequence = sequence;
            
            foreach (var option in field.Options)
            {
                builder.OpenElement(radioSequence, "div");
                builder.AddAttribute(radioSequence + 1, "class", "form-check");
                
                builder.OpenElement(radioSequence + 2, "input");
                builder.AddAttribute(radioSequence + 3, "type", "radio");
                builder.AddAttribute(radioSequence + 4, "class", "form-check-input");
                builder.AddAttribute(radioSequence + 5, "id", $"{field.PropertyName}_{option.Value}");
                builder.AddAttribute(radioSequence + 6, "name", field.PropertyName);
                builder.AddAttribute(radioSequence + 7, "value", option.Value);
                builder.AddAttribute(radioSequence + 8, "disabled", field.IsReadOnly || field.IsDisabled);
                builder.AddAttribute(radioSequence + 9, "checked", option.Value == currentValue);
                builder.AddAttribute(radioSequence + 10, "onchange", EventCallback.Factory.CreateBinder(this, 
                    value => SetPropertyValue(Model, field.PropertyName, value), 
                    currentValue ?? ""));
                builder.CloseElement();
                
                builder.OpenElement(radioSequence + 11, "label");
                builder.AddAttribute(radioSequence + 12, "class", "form-check-label");
                builder.AddAttribute(radioSequence + 13, "for", $"{field.PropertyName}_{option.Value}");
                builder.AddContent(radioSequence + 14, option.Text);
                builder.CloseElement();
                
                builder.CloseElement();
                radioSequence += 15;
            }        }
    }

    private void RenderAutoComplete(RenderTreeBuilder builder, FormFieldDefinition field, int sequence)
    {
        var fieldId = field.PropertyName;
        var currentValue = GetPropertyValue(Model, field.PropertyName);
        var displayValue = autoCompleteDisplayValues.GetValueOrDefault(fieldId, currentValue?.ToString() ?? "");
        
        // å®¹å™¨ div
        builder.OpenElement(sequence, "div");
        builder.AddAttribute(sequence + 1, "class", "autocomplete-container");
        
        // è¼¸å…¥æ¡†
        builder.OpenElement(sequence + 2, "input");
        builder.AddAttribute(sequence + 3, "type", "text");
        builder.AddAttribute(sequence + 4, "class", GetInputCssClass(field));
        builder.AddAttribute(sequence + 5, "id", fieldId);
        builder.AddAttribute(sequence + 6, "placeholder", field.Placeholder);
        builder.AddAttribute(sequence + 7, "readonly", field.IsReadOnly);
        builder.AddAttribute(sequence + 8, "disabled", field.IsDisabled);
        builder.AddAttribute(sequence + 9, "value", displayValue);
        if (field.MaxLength.HasValue)
        {
            builder.AddAttribute(sequence + 10, "maxlength", field.MaxLength.Value);
        }
        if (field.MinLength.HasValue)
        {
            builder.AddAttribute(sequence + 11, "minlength", field.MinLength.Value);
        }
        
        // ğŸ”‘ åªæœ‰åœ¨éå”¯è®€å’Œéåœç”¨ç‹€æ…‹ä¸‹æ‰ç¶å®šäº’å‹•äº‹ä»¶
        if (!field.IsReadOnly && !field.IsDisabled)
        {
            // è¼¸å…¥äº‹ä»¶è™•ç†
            builder.AddAttribute(sequence + 12, "oninput", EventCallback.Factory.Create<ChangeEventArgs>(this, args =>
            {
                var inputValue = args.Value?.ToString() ?? "";
                autoCompleteDisplayValues[fieldId] = inputValue;
                _ = HandleAutoCompleteInput(field, inputValue);
            }));
            
            // ç„¦é»äº‹ä»¶è™•ç†
            builder.AddAttribute(sequence + 13, "onfocus", EventCallback.Factory.Create(this, () =>
            {
                // æ¸…é™¤å¤±å»ç„¦é»æ¨™è¨˜
                blurredFields.Remove(fieldId);
                
                var inputValue = autoCompleteDisplayValues.GetValueOrDefault(fieldId, "");
                // ç•¶ MinSearchLength ç‚º 0 æ™‚ï¼Œå…è¨±ç©ºè¼¸å…¥è§¸ç™¼æœå°‹ä»¥é¡¯ç¤ºæ‰€æœ‰é¸é …
                if (field.MinSearchLength == 0 || (!string.IsNullOrEmpty(inputValue) && inputValue.Length >= field.MinSearchLength))
                {
                    _ = HandleAutoCompleteInput(field, inputValue);
                }
            }));
              // å¤±å»ç„¦é»äº‹ä»¶è™•ç†
            builder.AddAttribute(sequence + 14, "onblur", EventCallback.Factory.Create(this, async () =>
            {
                // æ¨™è¨˜ç‚ºå·²å¤±å»ç„¦é»
                blurredFields.Add(fieldId);
                
                // å–æ¶ˆæ­£åœ¨é€²è¡Œçš„æœå°‹
                if (autoCompleteTimers.ContainsKey(fieldId))
                {
                    autoCompleteTimers[fieldId]?.Dispose();
                    autoCompleteTimers[fieldId] = null;
                }
                
                // æ¸…é™¤è¼‰å…¥ç‹€æ…‹ (é‡è¦ï¼šå› ç‚ºè¨ˆæ™‚å™¨è¢«å–æ¶ˆï¼Œfinally å¡Šä¸æœƒåŸ·è¡Œ)
                autoCompleteLoading[fieldId] = false;
                
                // å˜—è©¦æ™ºèƒ½åŒ¹é…
                await TrySmartMatch(field);
                
                // å»¶é²éš±è—ä¸‹æ‹‰é¸å–®ï¼Œè®“ä½¿ç”¨è€…æœ‰æ™‚é–“é»æ“Šé¸é …
                Timer? timer = null;
                timer = new Timer(_ =>
                {
                    autoCompleteVisible[fieldId] = false;
                    InvokeAsync(StateHasChanged);
                    timer?.Dispose();
                }, null, 300, Timeout.Infinite); // å¢åŠ å»¶é²æ™‚é–“
            }));
            
            // éµç›¤äº‹ä»¶è™•ç†
            builder.AddAttribute(sequence + 15, "onkeydown", EventCallback.Factory.Create<KeyboardEventArgs>(this, args =>
            {
                _ = HandleKeyDown(field, args);
            }));
        }
        
        builder.CloseElement(); // input
        
        // ğŸ”‘ åªæœ‰åœ¨éå”¯è®€å’Œéåœç”¨ç‹€æ…‹ä¸‹æ‰é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨å’Œä¸‹æ‹‰é¸é …
        if (!field.IsReadOnly && !field.IsDisabled)
        {
            // è¼‰å…¥æŒ‡ç¤ºå™¨
            if (autoCompleteLoading.GetValueOrDefault(fieldId, false))
            {
                builder.OpenElement(sequence + 20, "div");
                builder.AddAttribute(sequence + 21, "class", "position-absolute");
                builder.AddAttribute(sequence + 22, "style", "right: 10px; top: 50%; transform: translateY(-50%);");
                builder.OpenElement(sequence + 23, "span");
                builder.AddAttribute(sequence + 24, "class", "spinner-border spinner-border-sm");
                builder.CloseElement();
                builder.CloseElement();
            }
            
            // ä¸‹æ‹‰é¸é …
            if (autoCompleteVisible.GetValueOrDefault(fieldId, false) && autoCompleteOptions.ContainsKey(fieldId))
            {
                var options = autoCompleteOptions[fieldId];
                if (options.Any())
                {
                    builder.OpenElement(sequence + 30, "div");
                    builder.AddAttribute(sequence + 31, "class", "autocomplete-dropdown position-absolute w-100");
                    builder.AddAttribute(sequence + 32, "style", "max-height: 200px; overflow-y: auto; z-index: 1000;");                
                    var optionSequence = sequence + 40;
                    var optionIndex = 0;
                    foreach (var option in options)
                    {
                        var isHighlighted = highlightedOptionIndex.GetValueOrDefault(fieldId, -1) == optionIndex;
                        var cssClass = isHighlighted ? "autocomplete-item highlighted" : "autocomplete-item";
                        var optionId = $"{fieldId}_option_{optionIndex}";
                        
                        builder.OpenElement(optionSequence, "button");
                        builder.AddAttribute(optionSequence + 1, "type", "button");
                        builder.AddAttribute(optionSequence + 2, "class", cssClass);
                        builder.AddAttribute(optionSequence + 3, "id", optionId);
                        
                        // æ»‘é¼ ç§»å‹•æ™‚æ›´æ–°é«˜äº®ç´¢å¼•
                        builder.AddAttribute(optionSequence + 4, "onmousemove", EventCallback.Factory.Create(this, () =>
                        {
                            highlightedOptionIndex[fieldId] = optionIndex;
                            keyboardNavigationActive[fieldId] = false;
                            StateHasChanged();
                        }));
                          builder.AddAttribute(optionSequence + 5, "onmousedown", EventCallback.Factory.Create(this, async () =>
                        {
                            autoCompleteDisplayValues[fieldId] = option.Text;
                            SetPropertyValue(Model, field.PropertyName, option.Value);
                            autoCompleteVisible[fieldId] = false;
                            ResetKeyboardNavigation(fieldId);
                            
                            // è§¸ç™¼æ¬„ä½è®Šæ›´äº‹ä»¶
                            await OnFieldChanged.InvokeAsync((field.PropertyName, option.Value));
                            
                            StateHasChanged();
                        }));
                        builder.AddContent(optionSequence + 6, option.Text);
                        builder.CloseElement();
                        optionSequence += 7;
                        optionIndex++;
                    }
                    
                    builder.CloseElement(); // dropdown-menu
                }
            }
        }
        
        builder.CloseElement(); // container div
    }
    
    private async Task HandleAutoCompleteInput(FormFieldDefinition field, string inputValue)
    {
        var fieldId = field.PropertyName;
        
        // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨å’Œè¼‰å…¥ç‹€æ…‹
        if (autoCompleteTimers.ContainsKey(fieldId))
        {
            autoCompleteTimers[fieldId]?.Dispose();
            autoCompleteTimers[fieldId] = null; // é‡è¦ï¼šæ¸…ç©ºå¼•ç”¨
        }
        autoCompleteLoading[fieldId] = false; // æ¸…é™¤å¯èƒ½æ®˜ç•™çš„è¼‰å…¥ç‹€æ…‹
        
        // å¦‚æœæ¬„ä½å·²ç¶“å¤±å»ç„¦é»ï¼Œä¸è¦é€²è¡Œæœå°‹
        if (blurredFields.Contains(fieldId))
        {
            return;
        }
        
        // å¦‚æœè¼¸å…¥ç‚ºç©ºï¼Œæ¸…ç©ºå¯¦é«”å€¼
        if (string.IsNullOrEmpty(inputValue))
        {
            // æª¢æŸ¥ç›®å‰å¯¦é«”å€¼æ˜¯å¦ä¸ç‚ºç©ºï¼Œå¦‚æœä¸ç‚ºç©ºæ‰æ¸…ç©º
            var currentValue = GetPropertyValue(Model, field.PropertyName);
            if (currentValue != null)
            {
                SetPropertyValue(Model, field.PropertyName, null);
                await OnFieldChanged.InvokeAsync((field.PropertyName, null));
            }
            
            // å¦‚æœ MinSearchLength > 0ï¼Œéš±è—ä¸‹æ‹‰é¸å–®ä¸¦è¿”å›
            if (field.MinSearchLength > 0)
            {
                autoCompleteVisible[fieldId] = false;
                StateHasChanged();
                return;
            }
            // å¦‚æœ MinSearchLength = 0ï¼Œç¹¼çºŒåŸ·è¡Œæœå°‹ä»¥é¡¯ç¤ºæ‰€æœ‰é¸é …
        }
        
        // å¦‚æœè¼¸å…¥é•·åº¦ä¸è¶³ï¼Œéš±è—ä¸‹æ‹‰é¸å–®
        if (inputValue.Length < field.MinSearchLength)
        {
            autoCompleteVisible[fieldId] = false;
            StateHasChanged();
            return;
        }
        
        // è¨­ç½®è¼‰å…¥ç‹€æ…‹
        autoCompleteLoading[fieldId] = true;
        StateHasChanged();
        
        // è¨­ç½®å»¶é²æœå°‹è¨ˆæ™‚å™¨
        autoCompleteTimers[fieldId] = new Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                try
                {
                    if (field.SearchFunction != null)
                    {
                        var results = await field.SearchFunction(inputValue);
                        autoCompleteOptions[fieldId] = results;
                        autoCompleteVisible[fieldId] = results.Any();
                    }
                }
                catch (Exception ex)
                {
                    Console.Error.WriteLine($"AutoComplete search error: {ex.Message}");
                    autoCompleteOptions[fieldId] = new List<SelectOption>();
                    autoCompleteVisible[fieldId] = false;
                }
                finally
                {
                    autoCompleteLoading[fieldId] = false;
                    StateHasChanged();
                }
            });
        }, null, field.AutoCompleteDelayMs, Timeout.Infinite);
    }
    
    private async Task HandleKeyDown(FormFieldDefinition field, KeyboardEventArgs args)
    {
        var fieldId = field.PropertyName;
        var options = autoCompleteOptions.GetValueOrDefault(fieldId, new List<SelectOption>());
        
        switch (args.Key)
        {
            case "ArrowDown":
                // å¦‚æœä¸‹æ‹‰é¸å–®æœªé¡¯ç¤ºï¼Œé¡¯ç¤ºå®ƒ
                if (!autoCompleteVisible.GetValueOrDefault(fieldId, false))
                {
                    var inputValue = autoCompleteDisplayValues.GetValueOrDefault(fieldId, "");
                    // ç•¶ MinSearchLength ç‚º 0 æ™‚ï¼Œå…è¨±ç©ºè¼¸å…¥è§¸ç™¼æœå°‹
                    if (field.MinSearchLength == 0 || (!string.IsNullOrEmpty(inputValue) && inputValue.Length >= field.MinSearchLength))
                    {
                        await HandleAutoCompleteInput(field, inputValue);
                    }
                }
                else if (options.Any())
                {
                    // ç§»å‹•åˆ°ä¸‹ä¸€å€‹é¸é …
                    MoveHighlight(fieldId, options, 1);
                }
                break;
                
            case "ArrowUp":
                if (autoCompleteVisible.GetValueOrDefault(fieldId, false) && options.Any())
                {
                    MoveHighlight(fieldId, options, -1);
                }
                break;
                
            case "Enter":
                if (autoCompleteVisible.GetValueOrDefault(fieldId, false) && options.Any())
                {
                    // å¦‚æœåªæœ‰ä¸€å€‹é¸é …ï¼Œç›´æ¥é¸æ“‡å®ƒ
                    if (options.Count == 1)
                    {
                        var singleOption = options[0];
                        autoCompleteDisplayValues[fieldId] = singleOption.Text;
                        SetPropertyValue(Model, field.PropertyName, singleOption.Value);
                        HideDropdown(fieldId);
                        
                        // è§¸ç™¼æ¬„ä½è®Šæ›´äº‹ä»¶
                        await OnFieldChanged.InvokeAsync((field.PropertyName, singleOption.Value));
                    }
                    else
                    {
                        // å¤šå€‹é¸é …æ™‚ï¼Œé¸æ“‡é«˜äº®çš„é¸é …
                        await SelectHighlightedOption(field, options);
                    }
                }
                break;
                
            case "Escape":
                HideDropdown(fieldId);
                break;
                
            case "Tab":
                // å¦‚æœåªæœ‰ä¸€å€‹é¸é …ï¼Œè‡ªå‹•å¡«å…¥ä¸¦éš±è—ä¸‹æ‹‰é¸å–®
                if (autoCompleteVisible.GetValueOrDefault(fieldId, false) && 
                    options.Count == 1)
                {
                    var singleOption = options[0];
                    autoCompleteDisplayValues[fieldId] = singleOption.Text;
                    SetPropertyValue(Model, field.PropertyName, singleOption.Value);
                    HideDropdown(fieldId);
                    
                    // è§¸ç™¼æ¬„ä½è®Šæ›´äº‹ä»¶
                    await OnFieldChanged.InvokeAsync((field.PropertyName, singleOption.Value));
                }
                else
                {
                    // å˜—è©¦æ™ºèƒ½åŒ¹é…
                    await TrySmartMatch(field);
                    HideDropdown(fieldId);
                }
                // ä¸é˜»æ­¢ Tabï¼Œè®“å®ƒæ­£å¸¸ç§»å‹•åˆ°ä¸‹ä¸€å€‹æ¬„ä½
                break;
        }
        
        StateHasChanged();
    }
      private void MoveHighlight(string fieldId, List<SelectOption> options, int direction)
    {
        if (!options.Any()) return;
        
        var currentIndex = highlightedOptionIndex.GetValueOrDefault(fieldId, -1);
        var newIndex = currentIndex + direction;
        
        // å¾ªç’°å°èˆª
        if (newIndex < 0)
            newIndex = options.Count - 1;
        else if (newIndex >= options.Count)
            newIndex = 0;
            
        highlightedOptionIndex[fieldId] = newIndex;
        keyboardNavigationActive[fieldId] = true;
        
        // æ»¾å‹•åˆ°å¯è¦‹å€åŸŸ
        _ = ScrollToHighlightedOption(fieldId, newIndex);
    }
    
    private async Task ScrollToHighlightedOption(string fieldId, int optionIndex)
    {
        try
        {
            var optionId = $"{fieldId}_option_{optionIndex}";
            await JSRuntime.InvokeVoidAsync("scrollToElement", optionId);
        }
        catch (Exception ex)
        {
            // éœé»˜è™•ç†æ»¾å‹•éŒ¯èª¤ï¼Œä¸å½±éŸ¿ä¸»è¦åŠŸèƒ½
            Console.Error.WriteLine($"ScrollToHighlightedOption error: {ex.Message}");
        }
    }
      private async Task SelectHighlightedOption(FormFieldDefinition field, List<SelectOption> options)
    {
        var fieldId = field.PropertyName;
        var highlightedIndex = highlightedOptionIndex.GetValueOrDefault(fieldId, -1);
        
        if (highlightedIndex >= 0 && highlightedIndex < options.Count)
        {
            var selectedOption = options[highlightedIndex];
            autoCompleteDisplayValues[fieldId] = selectedOption.Text;
            SetPropertyValue(Model, field.PropertyName, selectedOption.Value);
            HideDropdown(fieldId);
            
            // è§¸ç™¼æ¬„ä½è®Šæ›´äº‹ä»¶
            await OnFieldChanged.InvokeAsync((field.PropertyName, selectedOption.Value));
        }
    }
    
    private void HideDropdown(string fieldId)
    {
        autoCompleteVisible[fieldId] = false;
        autoCompleteLoading[fieldId] = false; // æ¸…é™¤è¼‰å…¥ç‹€æ…‹
        ResetKeyboardNavigation(fieldId);
    }
    
    private void ResetKeyboardNavigation(string fieldId)
    {
        highlightedOptionIndex[fieldId] = -1;
        keyboardNavigationActive[fieldId] = false;
    }

    /// <summary>
    /// å˜—è©¦æ™ºèƒ½åŒ¹é… AutoComplete è¼¸å…¥å€¼
    /// </summary>
    private async Task TrySmartMatch(FormFieldDefinition field)
    {
        var fieldId = field.PropertyName;
        var inputValue = autoCompleteDisplayValues.GetValueOrDefault(fieldId, "").Trim();
        
        if (string.IsNullOrEmpty(inputValue)) return;
        
        try
        {
            if (field.SearchFunction != null)
            {
                var results = await field.SearchFunction(inputValue);
                
                // ç²¾ç¢ºåŒ¹é…å„ªå…ˆ
                var exactMatch = results.FirstOrDefault(r => 
                    string.Equals(r.Text, inputValue, StringComparison.OrdinalIgnoreCase));
                    
                if (exactMatch != null)
                {
                    // è‡ªå‹•é¸æ“‡ç²¾ç¢ºåŒ¹é…
                    autoCompleteDisplayValues[fieldId] = exactMatch.Text;
                    SetPropertyValue(Model, field.PropertyName, exactMatch.Value);
                    await OnFieldChanged.InvokeAsync((field.PropertyName, exactMatch.Value));
                    return;
                }
                
                // å¦‚æœåªæœ‰ä¸€å€‹çµæœï¼Œä¹Ÿè‡ªå‹•é¸æ“‡
                if (results.Count == 1)
                {
                    var singleResult = results[0];
                    autoCompleteDisplayValues[fieldId] = singleResult.Text;
                    SetPropertyValue(Model, field.PropertyName, singleResult.Value);
                    await OnFieldChanged.InvokeAsync((field.PropertyName, singleResult.Value));
                }
            }
        }
        catch
        {
            // éœé»˜è™•ç†éŒ¯èª¤
        }
    }

    public void Dispose()
    {
        // æ¸…ç†æ‰€æœ‰è¨ˆæ™‚å™¨
        foreach (var timer in autoCompleteTimers.Values)
        {
            timer?.Dispose();
        }
        autoCompleteTimers.Clear();
    }

    private string GetInputType(FormFieldType fieldType)
    {
        return fieldType switch
        {
            FormFieldType.Email => "email",
            FormFieldType.Password => "password",
            FormFieldType.Number => "number",
            FormFieldType.Date => "date",
            FormFieldType.DateTime => "datetime-local",
            FormFieldType.Time => "time",
            _ => "text"
        };
    }

    private string GetInputCssClass(FormFieldDefinition field)
    {
        var classes = new List<string> { "form-control" };
        
        if (!string.IsNullOrEmpty(field.CssClass))
            classes.Add(field.CssClass);
            
        return string.Join(" ", classes);
    }

    private object? GetPropertyValue(TModel model, string propertyName)
    {
        if (model == null || string.IsNullOrEmpty(propertyName))
            return null;

        var parts = propertyName.Split('.');
        object? currentValue = model;
        
        foreach (var part in parts)
        {
            if (currentValue == null) return null;
            
            var currentType = currentValue.GetType();
            var property = currentType.GetProperty(part);
            
            if (property == null) return null;
            
            currentValue = property.GetValue(currentValue);
        }
        
        return currentValue;
    }

    private async void SetPropertyValue(TModel model, string propertyName, object? value)
    {
        if (model == null || string.IsNullOrEmpty(propertyName))
            return;

        var parts = propertyName.Split('.');
        object? currentValue = model;
        
        // å°èˆªåˆ°æœ€å¾Œä¸€å€‹å±¬æ€§çš„çˆ¶ç‰©ä»¶
        for (int i = 0; i < parts.Length - 1; i++)
        {
            if (currentValue == null) return;
            
            var currentType = currentValue.GetType();
            var property = currentType.GetProperty(parts[i]);
            
            if (property == null) return;
            
            currentValue = property.GetValue(currentValue);
        }
        
        // è¨­å®šæœ€å¾Œä¸€å€‹å±¬æ€§çš„å€¼
        if (currentValue != null)
        {
            var finalType = currentValue.GetType();
            var finalProperty = finalType.GetProperty(parts[^1]);
            
            if (finalProperty != null && finalProperty.CanWrite)
            {
                var convertedValue = ConvertValue(value, finalProperty.PropertyType);
                finalProperty.SetValue(currentValue, convertedValue);
                
                // è§¸ç™¼æ¬„ä½è®Šæ›´äº‹ä»¶
                if (OnFieldChanged.HasDelegate)
                {
                    await OnFieldChanged.InvokeAsync((PropertyName: propertyName, Value: convertedValue));
                }
            }
            else
            {
                // å³ä½¿å±¬æ€§ä¸å­˜åœ¨ï¼Œä¹Ÿè§¸ç™¼æ¬„ä½è®Šæ›´äº‹ä»¶ï¼ˆç”¨æ–¼è™›æ“¬æ¬„ä½å¦‚ Passwordã€ConfirmPasswordï¼‰
                if (OnFieldChanged.HasDelegate)
                {
                    await OnFieldChanged.InvokeAsync((propertyName, value));
                }
            }
        }
    }

    private object? ConvertValue(object? value, Type targetType)
    {
        if (value == null)
            return null;

        // è™•ç†ç©ºå­—ä¸²ï¼šå°æ–¼å¯ç©ºå‹åˆ¥ï¼Œç©ºå­—ä¸²æ‡‰è©²è½‰æ›ç‚º null
        if (value is string stringValue && string.IsNullOrWhiteSpace(stringValue))
        {
            // å¦‚æœæ˜¯å¯ç©ºå‹åˆ¥ï¼Œè¿”å› null
            if (Nullable.GetUnderlyingType(targetType) != null)
            {
                return null;
            }
            // å¦‚æœä¸æ˜¯å¯ç©ºå‹åˆ¥ä½†å…è¨±ç©ºå­—ä¸²ï¼ˆå¦‚ string æœ¬èº«ï¼‰ï¼Œä¿ç•™ç©ºå­—ä¸²
            if (targetType == typeof(string))
            {
                return stringValue;
            }
            // å…¶ä»–éå¯ç©ºå‹åˆ¥ï¼Œå˜—è©¦ä½¿ç”¨é è¨­å€¼æˆ– null
            return null;
        }

        if (targetType.IsAssignableFrom(value.GetType()))
            return value;

        var underlyingType = Nullable.GetUnderlyingType(targetType) ?? targetType;

        try
        {
            // ç‰¹åˆ¥è™•ç†æšèˆ‰é¡å‹
            if (underlyingType.IsEnum)
            {
                if (value is string enumStringValue)
                {
                    // å˜—è©¦è½‰æ›å­—ä¸²ç‚ºæšèˆ‰ï¼ˆæ”¯æ´æ•¸å­—å­—ä¸²å’Œåç¨±å­—ä¸²ï¼‰
                    if (int.TryParse(enumStringValue, out var intValue))
                    {
                        return Enum.ToObject(underlyingType, intValue);
                    }
                    return Enum.Parse(underlyingType, enumStringValue, true);
                }
                else if (value is int intValue)
                {
                    return Enum.ToObject(underlyingType, intValue);
                }
            }
            
            return Convert.ChangeType(value, underlyingType);
        }
        catch
        {
            return null;
        }
    }

    private ERPCore2.Components.Shared.Buttons.ButtonVariant GetButtonVariant(string variant)
    {
        return variant switch
        {
            "Primary" => ERPCore2.Components.Shared.Buttons.ButtonVariant.Primary,
            "Secondary" => ERPCore2.Components.Shared.Buttons.ButtonVariant.Secondary,
            "Success" => ERPCore2.Components.Shared.Buttons.ButtonVariant.Success,
            "Danger" => ERPCore2.Components.Shared.Buttons.ButtonVariant.Danger,
            "Warning" => ERPCore2.Components.Shared.Buttons.ButtonVariant.Warning,
            "Info" => ERPCore2.Components.Shared.Buttons.ButtonVariant.Info,
            "OutlinePrimary" => ERPCore2.Components.Shared.Buttons.ButtonVariant.OutlinePrimary,
            "OutlineSecondary" => ERPCore2.Components.Shared.Buttons.ButtonVariant.OutlineSecondary,
            "OutlineSuccess" => ERPCore2.Components.Shared.Buttons.ButtonVariant.OutlineSuccess,
            "OutlineDanger" => ERPCore2.Components.Shared.Buttons.ButtonVariant.OutlineDanger,
            "OutlineWarning" => ERPCore2.Components.Shared.Buttons.ButtonVariant.OutlineWarning,
            "OutlineInfo" => ERPCore2.Components.Shared.Buttons.ButtonVariant.OutlineInfo,
            _ => ERPCore2.Components.Shared.Buttons.ButtonVariant.OutlinePrimary
        };
    }

    private ERPCore2.Components.Shared.Buttons.ButtonSize GetButtonSize(string size)
    {
        return size switch
        {
            "Large" => ERPCore2.Components.Shared.Buttons.ButtonSize.Large,
            "Normal" => ERPCore2.Components.Shared.Buttons.ButtonSize.Normal,
            "Small" => ERPCore2.Components.Shared.Buttons.ButtonSize.Small,
            _ => ERPCore2.Components.Shared.Buttons.ButtonSize.Small
        };
    }
}
