@* æ¡è³¼é€€å›æ˜ç´°ç®¡ç†çµ„ä»¶ - ä½¿ç”¨ InteractiveTableComponent çµ±ä¸€UI ä¸¦æ•´åˆè‡ªå‹•ç©ºè¡ŒåŠŸèƒ½ *@

@inject IProductService ProductService
@inject IPurchaseReceivingService PurchaseReceivingService
@inject IPurchaseReturnDetailService PurchaseReturnDetailService
@inject INotificationService NotificationService
@inject RelatedDocumentsHelper RelatedDocumentsHelper
@inject ISystemParameterService SystemParameterService

@if (!EffectiveSupplierId.HasValue || EffectiveSupplierId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="supplier-warning">
                <p class="text-muted">é¸æ“‡å» å•†å¾Œå³å¯æŸ¥çœ‹è©²å» å•†çš„é€€å›å•†å“</p>
            </div>
        </div>
    </div>
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="ReturnItem" 
                                      Items="@ReturnItems"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      EnableAutoEmptyRow="true"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@CreateNewEmptyItem"
                                      IsReadOnly="@IsReadOnly"
                                      ShowRowNumbers="false"
                                      EmptyMessage="@EmptyMessage"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="false"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"
                                      ActionsColumnWidth = "60px" />
        </div>

        <div class="card-footer">
            <div class="d-flex justify-content-between">
                <div>
                    <GenericButtonComponent Text="è¼‰å…¥å¯é€€å›"
                                          Variant="ButtonVariant.DarkBlue"
                                          IsDisabled="@(!CanLoadAllReturnable)"
                                          Title="@GetLoadAllReturnableTooltip()"
                                          OnClick="LoadAllReturnableItems" />
                </div>
                <div class="d-flex gap-2">
                    <GenericButtonComponent Text="é€€å›å…¨å¡«"
                                          Variant="ButtonVariant.DarkBlue"
                                          OnClick="FillAllQuantities" />
                    <GenericButtonComponent Text="é€€å›æ¸…ç©º"
                                          Variant="ButtonVariant.Red"
                                          OnClick="ClearAllQuantities" />
                    <GenericButtonComponent Text="æ¸…é™¤æ˜ç´°"
                                          Variant="ButtonVariant.Red"
                                          OnClick="ClearAllDetails" />
                </div>
            </div>
        </div>
    </div>
}

<!-- ç›¸é—œå–®æ“šæŸ¥çœ‹ Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

@code {
    // ===== InteractiveTableComponent åƒè€ƒ =====
    private InteractiveTableComponent<ReturnItem>? tableComponent;
    
    // ===== åŸºæœ¬åƒæ•¸ =====
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public EventCallback<List<ReturnItem>> OnReturnItemsChanged { get; set; }
    
    // ===== ä¾›æ‡‰å•†éæ¿¾åƒæ•¸ =====
    [Parameter] public int? SupplierId { get; set; }
    [Parameter] public int? SelectedSupplierId { get; set; }
    
    // ===== ç¯©é¸åƒæ•¸ =====
    [Parameter] public int? SelectedPurchaseReceivingId { get; set; }
    [Parameter] public int? FilterProductId { get; set; }
    [Parameter] public int? FilterPurchaseReceivingId { get; set; }
    
    // ===== ç¾æœ‰æ˜ç´°åƒæ•¸ =====
    [Parameter] public List<PurchaseReturnDetail> ExistingReturnDetails { get; set; } = new List<PurchaseReturnDetail>();
    [Parameter] public EventCallback<List<PurchaseReturnDetail>> OnDetailsChanged { get; set; }
    [Parameter] public EventCallback<List<PurchaseReturnDetail>> OnReturnDetailsChanged { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    [Parameter] public EventCallback<ReturnItem> OnItemRemoved { get; set; }
    
    /// <summary>
    /// ç‹€æ…‹é€šçŸ¥åƒæ•¸ - é€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
    /// </summary>
    [Parameter] public EventCallback<bool> OnHasUndeletableDetailsChanged { get; set; }
    
    // ===== ç·¨è¼¯æ¨¡å¼åƒæ•¸ =====
    [Parameter] public bool IsEditMode { get; set; } = false;
    
    // ===== é¡¯ç¤ºè¨­å®š =====
    [Parameter] public string Title { get; set; } = "é€€å›æ˜ç´°";
    [Parameter] public string Subtitle { get; set; } = "";
    [Parameter] public string Icon { get; set; } = "undo";
    [Parameter] public string ItemDisplayName { get; set; } = "å•†å“";
    [Parameter] public string EmptyIcon { get; set; } = "box-open";
    [Parameter] public string EmptyMessage { get; set; } = "å°šæœªæ–°å¢é€€å›å•†å“";
    
    // ===== å”¯è®€æ¨¡å¼åƒæ•¸ =====
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== ç¨…åˆ¥åƒæ•¸ =====
    [Parameter] public TaxCalculationMethod TaxCalculationMethod { get; set; } = TaxCalculationMethod.TaxExclusive;
    
    // ===== ç¨…åˆ¥è¼”åŠ©å±¬æ€§ =====
    private bool IsTaxCalculationMethodNoTax => TaxCalculationMethod == TaxCalculationMethod.NoTax;
    
    // ===== ç›¸é—œå–®æ“šé–‹å•Ÿäº‹ä»¶ =====
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }

    private List<ReturnItem> ReturnItems { get; set; } = new List<ReturnItem>();
    private List<Product> AvailableProducts { get; set; } = new List<Product>();
    private List<PurchaseReceivingDetail> AvailableReceivingDetails { get; set; } = new List<PurchaseReceivingDetail>();
    private int? _previousSelectedSupplierId = null;
    private int? _previousSelectedPurchaseReceivingId = null;
    private int? _previousFilterProductId = null;
    private List<int> _deletedDetailIds { get; set; } = new List<int>();
    
    // ===== è³‡æ–™è¼‰å…¥ç‹€æ…‹æ§åˆ¶ =====
    private bool _dataLoadCompleted = true;  // è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜
    
    // ===== ç›¸é—œå–®æ“šæŸ¥çœ‹ =====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;

    // ===== è¨ˆç®—å±¬æ€§ =====
    private int? EffectiveSupplierId => SupplierId ?? SelectedSupplierId;
    private int? EffectivePurchaseReceivingId => FilterPurchaseReceivingId ?? SelectedPurchaseReceivingId;
    private int? EffectiveFilterProductId => FilterProductId;
    private EventCallback<List<PurchaseReturnDetail>> EffectiveDetailsChangedCallback => 
        OnReturnDetailsChanged.HasDelegate ? OnReturnDetailsChanged : OnDetailsChanged;
    
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦å¯ä»¥ä½¿ç”¨ã€Œè¼‰å…¥æ‰€æœ‰å¯é€€å›ã€åŠŸèƒ½
    /// è¦å‰‡ï¼š
    /// 1. å¿…é ˆé¸æ“‡å» å•†
    /// 2. å¿…é ˆæœ‰å¯è¼‰å…¥çš„é€²è²¨æ˜ç´°
    /// 3. ç·¨è¼¯æ¨¡å¼ä¸‹æˆ–å·²æœ‰æ˜ç´°æ™‚ç¦ç”¨æ­¤æŒ‰éˆ•ï¼ˆé¿å…è¦†è“‹ç¾æœ‰è³‡æ–™ï¼‰
    /// </summary>
    private bool CanLoadAllReturnable => 
        EffectiveSupplierId.HasValue && 
        EffectiveSupplierId.Value > 0 && 
        GetAvailableReceivingDetails().Any() &&
        !(ExistingReturnDetails?.Any() == true) && // ç·¨è¼¯æ¨¡å¼ï¼ˆæœ‰ç¾æœ‰æ˜ç´°ï¼‰æ™‚ç¦ç”¨
        !ReturnItems.Any(x => x.SelectedReceivingDetail != null); // å·²è¼‰å…¥æ˜ç´°æ™‚ç¦ç”¨
    
    /// <summary>
    /// å–å¾—ã€Œè¼‰å…¥å¯é€€å›ã€æŒ‰éˆ•çš„æç¤ºè¨Šæ¯
    /// </summary>
    private string GetLoadAllReturnableTooltip()
    {
        if (!EffectiveSupplierId.HasValue || EffectiveSupplierId.Value <= 0)
            return "è«‹å…ˆé¸æ“‡å» å•†";
        
        if (!GetAvailableReceivingDetails().Any())
            return "è©²å» å•†æ²’æœ‰å¯é€€å›çš„é€²è²¨æ˜ç´°";
        
        if (ExistingReturnDetails?.Any() == true)
            return "ç·¨è¼¯æ¨¡å¼ä¸‹ç„¡æ³•è¼‰å…¥å¯é€€å›é …ç›®ï¼Œä»¥é¿å…è¦†è“‹ç¾æœ‰è³‡æ–™";
        
        if (ReturnItems.Any(x => x.SelectedReceivingDetail != null))
            return "å·²æœ‰æ˜ç´°é …ç›®ï¼Œç„¡æ³•å†æ¬¡è¼‰å…¥ä»¥é¿å…è¦†è“‹ç¾æœ‰è³‡æ–™";
        
        return "è¼‰å…¥è©²å» å•†æ‰€æœ‰å¯é€€å›çš„é€²è²¨æ˜ç´°";
    }
    
    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦æœ‰è¢«é–å®šçš„æ˜ç´°ï¼ˆæœ‰æ²–æ¬¾è¨˜éŒ„çš„æ˜ç´°ï¼‰
    /// </summary>
    private bool HasLockedDetails()
    {
        return ReturnItems.Any(item => 
            item.SelectedReceivingDetail != null && !DetailLockHelper.CanDeleteItem(item.ExistingDetailEntity, out _, checkPayment: true));
    }

    protected override async Task OnInitializedAsync()
    {
        // åˆå§‹åŒ–æ™‚è¨˜éŒ„ç•¶å‰ä¾›æ‡‰å•†IDï¼Œé¿å… OnParametersSetAsync èª¤åˆ¤ç‚ºè®Šæ›´
        _previousSelectedSupplierId = EffectiveSupplierId;
        _previousSelectedPurchaseReceivingId = EffectivePurchaseReceivingId;
        _previousFilterProductId = EffectiveFilterProductId;
        
        await LoadAvailableProductsAsync();
        await LoadExistingDetailsAsync();
    }

    // ===== æ²–æ¬¾è¨˜éŒ„ç®¡ç†æ–¹æ³• =====
    
    /// <summary>
    /// æª¢æŸ¥æŒ‡å®šçš„é€€å›æ˜ç´°é …ç›®æ˜¯å¦æœ‰æ²–æ¬¾è¨˜éŒ„
    /// æª¢æŸ¥é‚è¼¯ï¼š
    /// - è³‡æ–™è¡¨ï¼šPurchaseReturnDetail
    /// - æ¬„ä½ï¼šTotalReceivedAmount (ç´¯è¨ˆæ”¶æ¬¾é‡‘é¡)
    /// - æ¢ä»¶ï¼šTotalReceivedAmount > 0 è¡¨ç¤ºå·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œä¸å¯åˆªé™¤
    /// </summary>
    /// <param name="item">è¦æª¢æŸ¥çš„é€€å›æ˜ç´°é …ç›®</param>
    /// <returns>true è¡¨ç¤ºæœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œfalse è¡¨ç¤ºæ²’æœ‰</returns>
    private bool HasPaymentRecord(ReturnItem item)
    {
        if (item.ExistingDetailEntity is PurchaseReturnDetail detail && detail.Id > 0)
        {
            // æª¢æŸ¥ TotalReceivedAmount æ˜¯å¦å¤§æ–¼ 0
            return detail.TotalReceivedAmount > 0;
        }
        return false;
    }
    
    /// <summary>
    /// å–å¾—æŒ‡å®šé€€å›æ˜ç´°é …ç›®çš„å·²æ”¶æ¬¾é‡‘é¡
    /// </summary>
    /// <param name="item">è¦æª¢æŸ¥çš„é€€å›æ˜ç´°é …ç›®</param>
    /// <returns>å·²æ”¶æ¬¾é‡‘é¡</returns>
    private decimal GetReceivedAmount(ReturnItem item)
    {
        if (item.ExistingDetailEntity is PurchaseReturnDetail detail && detail.Id > 0)
        {
            return detail.TotalReceivedAmount;
        }
        return 0;
    }
    
    /// <summary>
    /// æª¢æŸ¥é …ç›®æ˜¯å¦å¯ä»¥åˆªé™¤
    /// æª¢æŸ¥æ¢ä»¶ï¼š
    /// - æ²–æ¬¾è¨˜éŒ„æª¢æŸ¥ (HasPaymentRecord)
    ///   - è³‡æ–™ä¾†æºï¼šç›´æ¥è®€å– PurchaseReturnDetail å¯¦é«”
    ///   - æª¢æŸ¥è³‡æ–™è¡¨ï¼šPurchaseReturnDetail (æ¡è³¼é€€å›æ˜ç´°)
    ///   - æª¢æŸ¥æ¬„ä½ï¼šTotalReceivedAmount (ç´¯è¨ˆæ”¶æ¬¾é‡‘é¡)
    ///   - é™åˆ¶åŸå› ï¼šå·²æ”¶æ¬¾çš„é€€å›æ˜ç´°ä¸å¯åˆªé™¤ï¼Œé¿å…è²¡å‹™è³‡æ–™éŒ¯äº‚
    /// </summary>
    /// <param name="item">è¦æª¢æŸ¥çš„é …ç›®</param>
    /// <param name="reason">ä¸å¯åˆªé™¤çš„åŸå› ï¼ˆè¼¸å‡ºåƒæ•¸ï¼‰</param>
    /// <returns>true è¡¨ç¤ºå¯ä»¥åˆªé™¤ï¼Œfalse è¡¨ç¤ºä¸å¯åˆªé™¤</returns>
    private bool CanDeleteItem(ReturnItem item, out string reason)
    {
        return DetailLockHelper.CanDeleteItem(
            item.ExistingDetailEntity, 
            out reason, 
            checkPayment: true);
    }

    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼‰
    /// </summary>
    private bool HasUndeletableDetails()
    {
        return ReturnItems.Any(item => 
            item.SelectedReceivingDetail != null && !CanDeleteItem(item, out _));
    }

    /// <summary>
    /// é€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
    /// </summary>
    private async Task NotifyHasUndeletableDetailsChanged()
    {
        if (OnHasUndeletableDetailsChanged.HasDelegate)
        {
            var hasUndeletableDetails = HasUndeletableDetails();
            await OnHasUndeletableDetailsChanged.InvokeAsync(hasUndeletableDetails);
        }
    }

    /// <summary>
    /// é€€å›é‡å…¨å¡«ï¼ˆåªè™•ç†æœªé–å®šçš„æ˜ç´°ï¼‰
    /// </summary>
    private async Task FillAllQuantities()
    {
        var nonEmptyItems = ReturnItems.Where(item => item.SelectedReceivingDetail != null).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("æ²’æœ‰å¯æ›´æ–°çš„æ˜ç´°é …ç›®", "æç¤º");
            return;
        }
        
        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
        
        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "æ‰€æœ‰æ˜ç´°éƒ½å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•æ‰¹æ¬¡å¡«å…¥æ•¸é‡", 
                "æ“ä½œé™åˆ¶");
            return;
        }
        
        foreach (var item in unlocked)
        {
            if (item.SelectedReceivingDetail != null)
            {
                // é€€å›é‡è¨­ç‚ºå¯é€€å›çš„æœ€å¤§æ•¸é‡
                var maxReturnQuantity = item.AvailableQuantity;
                item.ReturnQuantity = maxReturnQuantity > 0 ? maxReturnQuantity : 0;
            }
        }
        
        var message = $"å·²å¡«å…¥ {unlocked.Count} é …æ˜ç´°çš„é€€å›æ•¸é‡";
        if (locked.Any())
        {
            message += $"\nï¼ˆå·²è·³é {locked.Count} é …å·²é–å®šçš„æ˜ç´°ï¼‰";
        }
        await NotificationService.ShowSuccessAsync(message);
        
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// é€€å›é‡æ¸…ç©ºï¼ˆåªè™•ç†æœªé–å®šçš„æ˜ç´°ï¼‰
    /// </summary>
    private async Task ClearAllQuantities()
    {
        var nonEmptyItems = ReturnItems.Where(item => item.SelectedReceivingDetail != null).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("æ²’æœ‰å¯æ›´æ–°çš„æ˜ç´°é …ç›®", "æç¤º");
            return;
        }
        
        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
        
        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "æ‰€æœ‰æ˜ç´°éƒ½å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•æ‰¹æ¬¡æ¸…ç©ºæ•¸é‡", 
                "æ“ä½œé™åˆ¶");
            return;
        }
        
        foreach (var item in unlocked)
        {
            item.ReturnQuantity = 0;
        }
        
        var message = $"å·²æ¸…ç©º {unlocked.Count} é …æ˜ç´°çš„é€€å›æ•¸é‡";
        if (locked.Any())
        {
            message += $"\nï¼ˆå·²è·³é {locked.Count} é …å·²é–å®šçš„æ˜ç´°ï¼‰";
        }
        await NotificationService.ShowSuccessAsync(message);
        
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// æ˜ç´°å…¨ç§»é™¤ï¼ˆåªç§»é™¤æœªé–å®šçš„æ˜ç´°ï¼Œä¿ç•™å·²é–å®šçš„ï¼‰
    /// </summary>
    private async Task ClearAllDetails()
    {
        var nonEmptyItems = ReturnItems.Where(item => item.SelectedReceivingDetail != null).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("æ²’æœ‰å¯ç§»é™¤çš„æ˜ç´°é …ç›®", "æç¤º");
            return;
        }
        
        // å€åˆ†å¯åˆªé™¤å’Œè¢«é–å®šçš„æ˜ç´°
        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
        
        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "æ‰€æœ‰æ˜ç´°éƒ½å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ç§»é™¤", 
                "æ“ä½œé™åˆ¶");
            return;
        }
        
        // é€šçŸ¥çˆ¶çµ„ä»¶é …ç›®å³å°‡è¢«ç§»é™¤
        if (OnItemRemoved.HasDelegate)
        {
            foreach (var item in unlocked)
            {
                await OnItemRemoved.InvokeAsync(item);
            }
        }
        
        // è¨˜éŒ„æ‰€æœ‰è¦åˆªé™¤çš„ç¾æœ‰æ˜ç´° ID
        foreach (var item in unlocked.Where(item => item.ExistingDetailEntity?.Id > 0))
        {
            _deletedDetailIds.Add(item.ExistingDetailEntity!.Id);
        }
        
        // å¾åˆ—è¡¨ä¸­ç§»é™¤æœªé–å®šçš„é …ç›®ï¼Œä¿ç•™å·²é–å®šçš„é …ç›®
        foreach (var item in unlocked)
        {
            ReturnItems.Remove(item);
        }
        
        await NotifyDetailsChanged();
        
        var message = $"å·²ç§»é™¤ {unlocked.Count} é …æ˜ç´°";
        if (locked.Any())
        {
            message += $"\nï¼ˆå·²ä¿ç•™ {locked.Count} é …å·²é–å®šçš„æ˜ç´°ï¼‰";
        }
        await NotificationService.ShowSuccessAsync(message);
    }

    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        
        // æª¢æŸ¥ç¯©é¸åƒæ•¸æ˜¯å¦è®Šæ›´
        bool supplierChanged = _previousSelectedSupplierId != EffectiveSupplierId;
        bool purchaseReceivingChanged = _previousSelectedPurchaseReceivingId != EffectivePurchaseReceivingId;
        bool productFilterChanged = _previousFilterProductId != EffectiveFilterProductId;
        
        // å¦‚æœå» å•†è®Šæ›´ï¼Œéœ€è¦é‡æ–°è¼‰å…¥æ‰€æœ‰è³‡æ–™
        if (supplierChanged)
        {
            
            _previousSelectedSupplierId = EffectiveSupplierId;
            _previousSelectedPurchaseReceivingId = EffectivePurchaseReceivingId;
            _previousFilterProductId = EffectiveFilterProductId;
            
            await LoadAvailableProductsAsync();
            
            // å» å•†è®Šæ›´æ™‚æ¸…ç©ºç¾æœ‰é¸é …ä¸¦é‡æ–°è¼‰å…¥
            ReturnItems.Clear();
            await LoadExistingDetailsAsync();
            return;
        }
        
        // å¦‚æœåªæ˜¯é€²è²¨å–®æˆ–å•†å“ç¯©é¸è®Šæ›´ï¼Œåªéœ€è¦æ›´æ–°ç¯©é¸ç‹€æ…‹
        // âœ… ç¯©é¸é‚è¼¯æœƒåœ¨ GetAvailableReceivingDetails() ä¸­è‡ªå‹•å¥—ç”¨ï¼Œä¸éœ€è¦é‡æ–°è¼‰å…¥æˆ–æ¸²æŸ“
        if (purchaseReceivingChanged || productFilterChanged)
        {
            _previousSelectedPurchaseReceivingId = EffectivePurchaseReceivingId;
            _previousFilterProductId = EffectiveFilterProductId;
            // âœ… ä¸éœ€è¦ StateHasChanged()ï¼Œç¯©é¸æœƒåœ¨ä¸‹æ¬¡æ¸²æŸ“æ™‚è‡ªå‹•ç”Ÿæ•ˆ
            return;
        }
    }

    // ===== InteractiveTableComponent æ–¹æ³• =====
    
    /// <summary>
    /// å»ºç«‹æ–°çš„ç©ºé …ç›®ï¼ˆç”¨æ–¼ InteractiveTableComponent è‡ªå‹•ç©ºè¡ŒåŠŸèƒ½ï¼‰
    /// </summary>
    private ReturnItem CreateNewEmptyItem()
    {
        return new ReturnItem();
    }
    
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // é€²è²¨æ˜ç´°é¸æ“‡æ¬„ä½ - ä½¿ç”¨ SearchableSelect é¡å‹
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å•†å“ç·¨è™Ÿ/åç¨±", 
            PropertyName = "ReceivingDetailSearchValue",
            EmptyCheckPropertyName = "SelectedReceivingDetail",
            TriggerEmptyRowOnFilled = true,
            ColumnType = InteractiveColumnType.SearchableSelect,
            Width = "300px",
            Tooltip = "æœå°‹ä¸¦é¸æ“‡è¦é€€å›çš„é€²è²¨å•†å“ã€‚å·²æœ‰æ²–æ¬¾è¨˜éŒ„çš„å•†å“å°‡ç„¡æ³•è®Šæ›´",
            Placeholder = "è«‹è¼¸å…¥é€²è²¨å–®è™Ÿæˆ–å•†å“åç¨±",
            SearchValuePropertyName = nameof(ReturnItem.ReceivingDetailSearchValue),
            FilteredItemsPropertyName = nameof(ReturnItem.FilteredReceivingDetails),
            ShowDropdownPropertyName = nameof(ReturnItem.ShowReceivingDetailDropdown),
            SelectedIndexPropertyName = nameof(ReturnItem.ReceivingDetailSelectedIndex),
            ItemDisplayFormatter = (item) =>
            {
                var detail = (PurchaseReceivingDetail)item;
                return FormatReceivingDetailDisplayText(detail);
            },
            IsDisabledFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                return IsReadOnly || HasPaymentRecord(returnItem);
            },
            TooltipFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                var hasPaymentRecord = HasPaymentRecord(returnItem);
                if (!hasPaymentRecord) return null;
                
                return $"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ”¶æ¬¾ {GetReceivedAmount(returnItem):N0} å…ƒï¼‰ï¼Œç„¡æ³•ä¿®æ”¹å•†å“é¸æ“‡";
            },
            OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, (tuple) =>
            {
                var (item, searchValue) = tuple;
                OnReceivingDetailSearchInput((ReturnItem)item, searchValue);
            }),
            OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
            {
                var (item, selectedItem) = tuple;
                await OnReceivingDetailSelectItem((ReturnItem)item, (PurchaseReceivingDetail?)selectedItem);
            }),
            OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnReceivingDetailFocus((ReturnItem)item);
            }),
            OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnReceivingDetailBlur((ReturnItem)item);
            }),
            EnableKeyboardNavigation = true,
            GetDropdownItems = (item) => ((ReturnItem)item).FilteredReceivingDetails,
            GetSelectedIndex = (item) => ((ReturnItem)item).ReceivingDetailSelectedIndex,
            SetSelectedIndex = (item, index) => ((ReturnItem)item).ReceivingDetailSelectedIndex = index,
            GetShowDropdown = (item) => ((ReturnItem)item).ShowReceivingDetailDropdown,
            SetShowDropdown = (item, show) => ((ReturnItem)item).ShowReceivingDetailDropdown = show,
            MaxDisplayItems = 20
        });

        // åŸå§‹é€²è²¨æ•¸é‡æ¬„ä½ (åªè®€é¡¯ç¤º)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "é€²è²¨é‡", 
            PropertyName = nameof(ReturnItem.OriginalQuantity),
            ColumnType = InteractiveColumnType.Display,
            Width = "120px",
            Tooltip = "ç•¶åˆé€²è²¨æ™‚çš„åŸå§‹æ•¸é‡ï¼ˆå”¯è®€ï¼‰",
            TextAlign = "right",
            IsReadOnly = true
        });

        // é€€å›æ•¸é‡æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "é€€å›æ•¸é‡", 
            PropertyName = nameof(ReturnItem.ReturnQuantity),
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            Tooltip = "è¦é€€å›çµ¦ä¾›æ‡‰å•†çš„å•†å“æ•¸é‡ã€‚å·²æ”¶æ¬¾çš„å•†å“å°‡ç„¡æ³•ä¿®æ”¹æ•¸é‡",
            IsDisabledFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                return HasPaymentRecord(returnItem);
            },
            TooltipFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                var hasPaymentRecord = HasPaymentRecord(returnItem);
                if (!hasPaymentRecord) return null;
                
                return $"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ”¶æ¬¾ {GetReceivedAmount(returnItem):N0} å…ƒï¼‰ï¼Œç„¡æ³•ä¿®æ”¹é€€å›æ•¸é‡";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnReturnQuantityInput((ReturnItem)item, valueString);
            })
        });

        // å–®åƒ¹æ¬„ä½ (åªè®€é¡¯ç¤º) - ä½¿ç”¨æ™ºèƒ½å°æ•¸é»é¡¯ç¤º
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å–®åƒ¹", 
            PropertyName = nameof(ReturnItem.OriginalUnitPrice),
            ColumnType = InteractiveColumnType.Display,
            Width = "100px",
            Tooltip = "å•†å“çš„åŸå§‹é€²è²¨å–®åƒ¹ï¼ˆå”¯è®€ï¼‰",
            SmartDecimalDisplay = true,  // æ•´æ•¸ä¸é¡¯ç¤ºå°æ•¸é»ï¼Œæœ‰å°æ•¸æ‰é¡¯ç¤º
            TextAlign = "right",
            IsReadOnly = true
        });

        // ç¨…ç‡æ¬„ä½ï¼ˆå¯ç·¨è¼¯ï¼‰
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "ç¨…ç‡%",
            PropertyName = nameof(ReturnItem.TaxRate),
            ColumnType = InteractiveColumnType.Number,
            Width = "80px",
            Tooltip = "å•†å“çš„ç¨…ç‡ï¼ˆ0% ~ 100%ï¼‰ï¼Œå¯æ‰‹å‹•èª¿æ•´ã€‚ç•¶ä¸»æª”é¸æ“‡å…ç¨…æ™‚æ­¤æ¬„ä½å°‡è¢«ç¦ç”¨",
            IsDisabledFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                // ç•¶ä¸»æª”é¸æ“‡å…ç¨…æ™‚ï¼Œç¦ç”¨ç¨…ç‡æ¬„ä½ï¼›æˆ–å·²æœ‰æ²–æ¬¾è¨˜éŒ„æ™‚ä¹Ÿç¦ç”¨
                return IsReadOnly || IsTaxCalculationMethodNoTax || HasPaymentRecord(returnItem);
            },
            TooltipFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                if (IsTaxCalculationMethodNoTax) return "ä¸»æª”å·²é¸æ“‡å…ç¨…ï¼Œæ­¤æ¬„ä½å·²åœç”¨";
                if (HasPaymentRecord(returnItem))
                    return $"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ”¶æ¬¾ {GetReceivedAmount(returnItem):N0} å…ƒï¼‰ï¼Œç„¡æ³•ä¿®æ”¹ç¨…ç‡";
                return null;
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnTaxRateInput((ReturnItem)item, valueString);
            })
        });

        // å°è¨ˆæ¬„ä½ï¼ˆæ ¹æ“šç¨…åˆ¥è¨ˆç®—ï¼‰
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å°è¨ˆ",
            Tooltip = GetSubtotalTooltip(),
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item =>
            {
                var returnItem = (ReturnItem)item;
                var subtotal = CalculateItemSubtotal(returnItem);
                var displayValue = NumberFormatHelper.FormatSmartZeroAsEmpty(subtotal);
                return @<div class="text-end fw-bold text-success">@displayValue</div>;
            }
        });

        // å‚™è¨»æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å‚™è¨»", 
            PropertyName = nameof(ReturnItem.Remarks),
            ColumnType = InteractiveColumnType.Input,
            Width = "150px",
            HideOnMobile = true,
            Tooltip = "é¸å¡«ã€‚å¯è¨˜éŒ„é€€è²¨ç›¸é—œçš„å‚™è¨»è³‡è¨Šï¼ˆå¦‚é€€è²¨åŸå› ç­‰ï¼‰",
            Placeholder = "é¸å¡«...",
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var returnItem = (ReturnItem)args.Item1;
                await OnRemarksInput(returnItem, args.Item2);
            })
        });

        return columns;
    }

    private RenderFragment<ReturnItem> GetCustomActionsTemplate => item => __builder =>
    {
        // æª¢æŸ¥é …ç›®æ˜¯å¦å¯ä»¥åˆªé™¤ï¼ˆç¶œåˆé€€è²¨è¨˜éŒ„å’Œæ²–æ¬¾è¨˜éŒ„æª¢æŸ¥ï¼‰
        var canDelete = CanDeleteItem(item, out _);
        
        if (canDelete)
        {
            // å¯ä»¥åˆªé™¤ï¼šé¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Red"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="@IsReadOnly"
                                   Title="åˆªé™¤"
                                   OnClick="async () => await HandleItemDelete(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else
        {
            // ä¸èƒ½åˆªé™¤ï¼šé¡¯ç¤ºæŸ¥çœ‹æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Blue"
                                   IconClass="bi bi-eye text-white"
                                   Size="ButtonSize.Large"
                                   Title="æŸ¥çœ‹ç›¸é—œå–®æ“š"
                                   OnClick="async () => await ShowRelatedDocuments(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
    };

    private async Task HandleItemDelete(ReturnItem item)
    {
        // ä½¿ç”¨ç¶œåˆæª¢æŸ¥æ–¹æ³•ï¼Œç¢ºèªæ˜¯å¦å¯ä»¥åˆªé™¤
        if (!CanDeleteItem(item, out string reason))
        {
            await NotificationService.ShowWarningAsync(
                reason, 
                "æ“ä½œé™åˆ¶"
            );
            return;
        }
        
        var index = ReturnItems.IndexOf(item);
        await RemoveItemAsync(index);
    }

    /// <summary>
    /// é¡¯ç¤ºç›¸é—œå–®æ“šï¼ˆé€€è²¨å–®å’Œæ²–æ¬¾å–®ï¼‰
    /// </summary>
    private async Task ShowRelatedDocuments(ReturnItem item)
    {
        // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰çš„æ˜ç´°å¯¦é«” ID
        if (item.ExistingDetailEntity is not PurchaseReturnDetail detail || detail.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("æ­¤é …ç›®å°šæœªå„²å­˜ï¼Œç„¡æ³•æŸ¥çœ‹ç›¸é—œå–®æ“š", "æç¤º");
            return;
        }

        // è¨­å®šå•†å“åç¨±
        selectedProductName = item.SelectedReceivingDetail?.Product?.Name ?? "æœªçŸ¥å•†å“";

        // é¡¯ç¤º Modal ä¸¦é–‹å§‹è¼‰å…¥
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            // æŸ¥è©¢ç›¸é—œå–®æ“š
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsForPurchaseReturnDetailAsync(detail.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ç›¸é—œå–®æ“šå¤±æ•—ï¼š{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// è™•ç†é»æ“Šç›¸é—œå–®æ“šçš„äº‹ä»¶
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // è§¸ç™¼äº‹ä»¶ï¼Œè®“çˆ¶çµ„ä»¶ï¼ˆEditModalï¼‰è™•ç†é–‹å•Ÿç›¸é—œå–®æ“š
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            // å¦‚æœçˆ¶çµ„ä»¶æ²’æœ‰è™•ç†ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
            await NotificationService.ShowInfoAsync(
                $"è«‹åœ¨ä¸»ç•«é¢ä¸­é–‹å•Ÿ {document.TypeDisplayName}: {document.DocumentNumber}", 
                "æç¤º"
            );
        }
    }

    // ===== å…§éƒ¨æ–¹æ³• =====
    private async Task LoadAvailableProductsAsync()
    {
        try
        {
            if (EffectiveSupplierId.HasValue && EffectiveSupplierId.Value > 0)
            {
                // è¼‰å…¥è©²å» å•†çš„å¯é€€è²¨é€²è²¨æ˜ç´°
                AvailableReceivingDetails = await PurchaseReceivingService.GetReturnableDetailsBySupplierAsync(EffectiveSupplierId.Value);
                
                // å¾é€²è²¨æ˜ç´°ä¸­æå–å•†å“æ¸…å–®ï¼ˆå‘ä¸‹ç›¸å®¹ï¼‰
                AvailableProducts = AvailableReceivingDetails
                    .Where(rd => rd.Product != null)
                    .Select(rd => rd.Product!)
                    .Distinct()
                    .ToList();
            }
            else
            {
                AvailableProducts = new List<Product>();
                AvailableReceivingDetails = new List<PurchaseReceivingDetail>();
            }
        }
        catch (Exception)
        {
            AvailableProducts = new List<Product>();
            AvailableReceivingDetails = new List<PurchaseReceivingDetail>();
        }
    }

    /// <summary>
    /// å…¬é–‹çš„åˆ·æ–°æ–¹æ³•ï¼Œç”¨æ–¼å¤–éƒ¨è§¸ç™¼æ˜ç´°åˆ·æ–°ï¼ˆä¾‹å¦‚ï¼šä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼‰
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadExistingDetailsAsync();
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }
    
    private async Task LoadExistingDetailsAsync()
    {
        _dataLoadCompleted = false; // é–‹å§‹è¼‰å…¥æ•¸æ“šæ™‚ç¦æ­¢è‡ªå‹•ç©ºè¡Œ
        
        if (ExistingReturnDetails?.Any() != true) 
        {
            // é€šçŸ¥çˆ¶çµ„ä»¶æ²’æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
            await NotifyHasUndeletableDetailsChanged();
            _dataLoadCompleted = true; // æ•¸æ“šè¼‰å…¥å®Œæˆ,å•Ÿç”¨è‡ªå‹•ç©ºè¡Œ
            return;
        }

        ReturnItems.Clear();
        
        // å–å¾—ç³»çµ±é è¨­ç¨…ç‡ï¼ˆç”¨æ–¼ fallbackï¼‰
        var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();
        
        foreach (var detail in ExistingReturnDetails)
        {
            var item = new ReturnItem
            {
                // ä½¿ç”¨ Navigation Properties
                SelectedProduct = detail.Product,
                SelectedReceivingDetail = detail.PurchaseReceivingDetail,
                
                // SearchableSelect é¡¯ç¤ºå€¼
                ReceivingDetailSearchValue = detail.PurchaseReceivingDetail != null 
                    ? FormatReceivingDetailDisplayText(detail.PurchaseReceivingDetail) 
                    : string.Empty,
                
                // ä½¿ç”¨å±¬æ€§å€¼
                ReturnQuantity = detail.ReturnQuantity,
                OriginalUnitPrice = detail.OriginalUnitPrice,
                // è¨­å®šç¨…ç‡ï¼šæ˜ç´°ç¨…ç‡ > é€²è²¨æ˜ç´°ç¨…ç‡ > å•†å“ç¨…ç‡ > ç³»çµ±é è¨­ç¨…ç‡
                TaxRate = detail.TaxRate ?? detail.PurchaseReceivingDetail?.TaxRate ?? detail.Product?.TaxRate ?? defaultTaxRate,
                Remarks = detail.Remarks ?? string.Empty,
                BatchNumber = detail.BatchNumber ?? string.Empty,
                ExistingDetailEntity = detail
            };
            
            // è¨­ç½®åŸå§‹æ•¸é‡å’Œå·²é€€å›æ•¸é‡
            if (item.SelectedReceivingDetail != null)
            {
                item.OriginalQuantity = item.SelectedReceivingDetail.ReceivedQuantity;
                // å·²é€€å›æ•¸é‡éœ€è¦å¾è³‡æ–™åº«è¨ˆç®—ï¼Œæš«æ™‚è¨­ç‚º0
                item.AlreadyReturnedQuantity = 0; // TODO: éœ€è¦å¯¦ä½œè¨ˆç®—å·²é€€å›æ•¸é‡çš„é‚è¼¯
            }
            
            ReturnItems.Add(item);
        }
        
        _dataLoadCompleted = true; // æ•¸æ“šè¼‰å…¥å®Œæˆ,å•Ÿç”¨è‡ªå‹•ç©ºè¡Œ
        
        // é€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
        await NotifyHasUndeletableDetailsChanged();
    }

    private List<PurchaseReceivingDetail> GetAvailableReceivingDetails()
    {
        var filteredDetails = AvailableReceivingDetails.AsQueryable();
        
        // æ ¹æ“šé€²è²¨å–®ç¯©é¸
        if (EffectivePurchaseReceivingId.HasValue && EffectivePurchaseReceivingId.Value > 0)
        {
            filteredDetails = filteredDetails.Where(rd => rd.PurchaseReceivingId == EffectivePurchaseReceivingId.Value);
        }
        
        // æ ¹æ“šå•†å“ç¯©é¸
        if (EffectiveFilterProductId.HasValue && EffectiveFilterProductId.Value > 0)
        {
            filteredDetails = filteredDetails.Where(rd => rd.ProductId == EffectiveFilterProductId.Value);
        }
        
        // åªé¡¯ç¤ºé‚„æœ‰å¯é€€å›æ•¸é‡çš„æ˜ç´° (æš«æ™‚é¡¯ç¤ºæ‰€æœ‰å·²é€²è²¨çš„æ˜ç´°)
        return filteredDetails.ToList();
    }

    // ===== äº‹ä»¶è™•ç†æ–¹æ³• =====
    
    // ===== é€²è²¨æ˜ç´°é¸æ“‡äº‹ä»¶è™•ç† =====
    
    /// <summary>
    /// æ ¼å¼åŒ–é€²è²¨æ˜ç´°é¡¯ç¤ºæ–‡å­—ï¼ˆç”¨æ–¼ä¸‹æ‹‰é¸å–®ï¼‰
    /// </summary>
    private string FormatReceivingDetailDisplayText(PurchaseReceivingDetail detail)
    {
        if (detail?.Product == null || detail.PurchaseReceiving == null) return "";
        
        var product = detail.Product;
        var receiptNumber = detail.PurchaseReceiving.Code ?? "N/A";
        
        var productDisplay = !string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name)
            ? $"[{product.Code}] {product.Name}"
            : (!string.IsNullOrEmpty(product.Code) ? $"[{product.Code}]" : product.Name ?? "");
        
        return $"[{receiptNumber}] {productDisplay}";
    }

    // ===== é€²è²¨æ˜ç´°é¸æ“‡äº‹ä»¶è™•ç†ï¼ˆSearchableSelectï¼‰=====

    /// <summary>
    /// é€²è²¨æ˜ç´°æœå°‹è¼¸å…¥äº‹ä»¶
    /// </summary>
    private void OnReceivingDetailSearchInput(ReturnItem item, string? searchValue)
    {
        item.ReceivingDetailSearchValue = searchValue ?? string.Empty;
        
        var availableDetails = GetAvailableReceivingDetails();
        
        // ç¢ºä¿ç•¶å‰é¸ä¸­çš„æ˜ç´°ä¹Ÿåœ¨åˆ—è¡¨ä¸­
        if (item.SelectedReceivingDetail != null && 
            !availableDetails.Any(d => d.Id == item.SelectedReceivingDetail.Id))
        {
            availableDetails = new List<PurchaseReceivingDetail>(availableDetails) { item.SelectedReceivingDetail };
        }
        
        if (string.IsNullOrWhiteSpace(searchValue))
        {
            item.FilteredReceivingDetails = availableDetails.Take(20).ToList();
        }
        else
        {
            item.FilteredReceivingDetails = availableDetails
                .Where(d => 
                    (d.PurchaseReceiving?.Code?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (d.Product?.Code?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (d.Product?.Name?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false))
                .Take(20)
                .ToList();
        }
        
        item.ShowReceivingDetailDropdown = true;
        item.ReceivingDetailSelectedIndex = -1;
        // âœ… ç§»é™¤ StateHasChanged()ï¼ŒInteractiveTableComponent æœƒè‡ªå‹•è™•ç†é‡æ–°æ¸²æŸ“
    }
    
    /// <summary>
    /// é€²è²¨æ˜ç´°è¼¸å…¥æ¡†ç²å¾—ç„¦é»
    /// </summary>
    private void OnReceivingDetailFocus(ReturnItem item)
    {
        var availableDetails = GetAvailableReceivingDetails();
        
        // ç¢ºä¿ç•¶å‰é¸ä¸­çš„æ˜ç´°ä¹Ÿåœ¨åˆ—è¡¨ä¸­
        if (item.SelectedReceivingDetail != null && 
            !availableDetails.Any(d => d.Id == item.SelectedReceivingDetail.Id))
        {
            availableDetails = new List<PurchaseReceivingDetail>(availableDetails) { item.SelectedReceivingDetail };
        }
        
        item.FilteredReceivingDetails = availableDetails.Take(20).ToList();
        item.ShowReceivingDetailDropdown = true;
        item.ReceivingDetailSelectedIndex = -1;
        // âœ… ç§»é™¤ StateHasChanged()ï¼ŒInteractiveTableComponent æœƒè‡ªå‹•è™•ç†
    }
    
    /// <summary>
    /// é€²è²¨æ˜ç´°è¼¸å…¥æ¡†å¤±å»ç„¦é»
    /// </summary>
    private void OnReceivingDetailBlur(ReturnItem item)
    {
        Task.Delay(200).ContinueWith(_ =>
        {
            item.ShowReceivingDetailDropdown = false;
            InvokeAsync(StateHasChanged);
        });
    }
    
    /// <summary>
    /// é¸æ“‡é€²è²¨æ˜ç´°é …ç›®
    /// </summary>
    private async Task OnReceivingDetailSelectItem(ReturnItem returnItem, PurchaseReceivingDetail? selectedDetail)
    {
        if (selectedDetail == null)
        {
            returnItem.SelectedReceivingDetail = null;
            returnItem.SelectedProduct = null;
            returnItem.ReceivingDetailSearchValue = string.Empty;
            returnItem.OriginalQuantity = 0;
            returnItem.AlreadyReturnedQuantity = 0;
            returnItem.ReturnQuantity = 0;
            returnItem.OriginalUnitPrice = 0;
            returnItem.TaxRate = 0;
            returnItem.ShowReceivingDetailDropdown = false;
            returnItem.ReceivingDetailSelectedIndex = -1;
            await NotifyDetailsChanged();
            return;
        }
        
        returnItem.SelectedReceivingDetail = selectedDetail;
        returnItem.SelectedProduct = selectedDetail.Product;
        returnItem.ReceivingDetailSearchValue = FormatReceivingDetailDisplayText(selectedDetail);
        returnItem.OriginalQuantity = selectedDetail.ReceivedQuantity;
        returnItem.AlreadyReturnedQuantity = 0; // TODO: éœ€è¦å¯¦ä½œè¨ˆç®—å·²é€€å›æ•¸é‡çš„é‚è¼¯
        returnItem.ReturnQuantity = 0;
        returnItem.OriginalUnitPrice = selectedDetail.UnitPrice;
        // è¨­å®šç¨…ç‡ï¼šé€²è²¨æ˜ç´°ç¨…ç‡ > å•†å“ç¨…ç‡ > ç³»çµ±é è¨­ç¨…ç‡
        returnItem.TaxRate = selectedDetail.TaxRate ?? selectedDetail.Product?.TaxRate ?? await SystemParameterService.GetTaxRateAsync();
        returnItem.ShowReceivingDetailDropdown = false;
        returnItem.ReceivingDetailSelectedIndex = -1;
        
        await NotifyDetailsChanged();
        // âœ… ç§»é™¤ StateHasChanged()ï¼ŒNotifyDetailsChanged å·²ç¶“è§¸ç™¼æ›´æ–°ï¼Œé¿å…é‡è¤‡æ¸²æŸ“
    }

    private async Task OnReturnQuantityInput(ReturnItem returnItem, string? value)
    {
        if (int.TryParse(value, out var quantity) && quantity >= 0)
        {
            var maxQuantity = returnItem.OriginalQuantity - returnItem.AlreadyReturnedQuantity;
            returnItem.ReturnQuantity = Math.Min(quantity, maxQuantity);
        }
        else
        {
            returnItem.ReturnQuantity = 0;
        }
        
        await NotifyDetailsChanged();
    }

    private async Task OnRemarksInput(ReturnItem returnItem, string? value)
    {
        returnItem.Remarks = value ?? string.Empty;
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// è™•ç†ç¨…ç‡è¼¸å…¥
    /// </summary>
    private async Task OnTaxRateInput(ReturnItem item, string? valueString)
    {
        if (string.IsNullOrWhiteSpace(valueString))
        {
            item.TaxRate = 0;
        }
        else if (decimal.TryParse(valueString, out var taxRate))
        {
            // é™åˆ¶ç¯„åœ 0 ~ 100
            item.TaxRate = Math.Max(0, Math.Min(100, taxRate));
        }
        
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// è¨ˆç®—æ˜ç´°é …ç›®çš„å°è¨ˆï¼ˆæ ¹æ“šç¨…åˆ¥ï¼Œå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
    /// </summary>
    private decimal CalculateItemSubtotal(ReturnItem item)
    {
        if (item.SelectedReceivingDetail == null || item.ReturnQuantity <= 0 || item.OriginalUnitPrice <= 0)
        {
            return 0;
        }
        
        var baseAmount = item.ReturnQuantity * item.OriginalUnitPrice;
        
        switch (TaxCalculationMethod)
        {
            case TaxCalculationMethod.TaxExclusive:
                // å¤–åŠ ç¨…ï¼šå°è¨ˆ = æ•¸é‡ Ã— å–®åƒ¹ Ã— (1 + ç¨…ç‡%)ï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
                return Math.Round(baseAmount * (1 + item.TaxRate / 100m), 0, MidpointRounding.AwayFromZero);
                
            case TaxCalculationMethod.TaxInclusive:
                // å…§å«ç¨…ï¼šå°è¨ˆ = æ•¸é‡ Ã— å–®åƒ¹ï¼ˆå–®åƒ¹å·²å«ç¨…ï¼Œå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
                return Math.Round(baseAmount, 0, MidpointRounding.AwayFromZero);
                
            case TaxCalculationMethod.NoTax:
                // å…ç¨…ï¼šå°è¨ˆ = æ•¸é‡ Ã— å–®åƒ¹ï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
                return Math.Round(baseAmount, 0, MidpointRounding.AwayFromZero);
                
            default:
                return Math.Round(baseAmount, 0, MidpointRounding.AwayFromZero);
        }
    }
    
    /// <summary>
    /// å–å¾—å°è¨ˆæ¬„ä½çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetSubtotalTooltip()
    {
        return TaxCalculationMethod switch
        {
            TaxCalculationMethod.TaxExclusive => "å¤–åŠ ç¨…ï¼šæ•¸é‡ Ã— å–®åƒ¹ Ã— (1 + ç¨…ç‡%)",
            TaxCalculationMethod.TaxInclusive => "å…§å«ç¨…ï¼šæ•¸é‡ Ã— å–®åƒ¹ï¼ˆå–®åƒ¹å·²å«ç¨…ï¼‰",
            TaxCalculationMethod.NoTax => "å…ç¨…ï¼šæ•¸é‡ Ã— å–®åƒ¹",
            _ => "æ•¸é‡ Ã— å–®åƒ¹"
        };
    }

    /// <summary>
    /// è¼‰å…¥æ‰€æœ‰å¯é€€å›å•†å“çš„ä¸»è¦æ–¹æ³•ï¼ˆå…¬é–‹æ–¹æ³•ï¼Œä¾›çˆ¶çµ„ä»¶èª¿ç”¨ï¼‰
    /// </summary>
    public async Task LoadAllReturnableItems()
    {
        try
        {
            var availableDetails = GetAvailableReceivingDetails();
            
            // æ¸…é™¤ç¾æœ‰é …ç›®ä½†ä¿ç•™å·²æœ‰è³‡æ–™çš„é …ç›®
            var existingItems = ReturnItems.Where(item => item.SelectedReceivingDetail != null).ToList();
            ReturnItems.Clear();
            ReturnItems.AddRange(existingItems);
            
            // æ–°å¢æ‰€æœ‰å¯é€€å›çš„é …ç›®
            foreach (var detail in availableDetails)
            {
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“å­˜åœ¨
                if (ReturnItems.Any(item => item.SelectedReceivingDetail?.Id == detail.Id))
                    continue;
                
                // ğŸ”‘ å–å¾—ç¨…ç‡ï¼ˆå„ªå…ˆé †åºï¼šé€²è²¨æ˜ç´°ç¨…ç‡ > å•†å“ç¨…ç‡ > ç³»çµ±é è¨­ç¨…ç‡ï¼‰
                var taxRate = detail.TaxRate ?? detail.Product?.TaxRate ?? await SystemParameterService.GetTaxRateAsync();
                
                var newItem = new ReturnItem
                {
                    SelectedReceivingDetail = detail,
                    SelectedProduct = detail.Product,
                    ReceivingDetailSearchValue = FormatReceivingDetailDisplayText(detail),
                    OriginalQuantity = detail.ReceivedQuantity,
                    AlreadyReturnedQuantity = 0, // TODO: éœ€è¦å¾è³‡æ–™åº«è¨ˆç®—å·²é€€å›æ•¸é‡
                    ReturnQuantity = 0,
                    OriginalUnitPrice = detail.UnitPrice,
                    TaxRate = taxRate
                };
                
                ReturnItems.Add(newItem);
            }
            
            await NotifyDetailsChanged();
            await NotificationService.ShowSuccessAsync($"å·²è¼‰å…¥ {availableDetails.Count} é …å¯é€€å›å•†å“");
            StateHasChanged(); // å¼·åˆ¶æ›´æ–° UIï¼Œç¢ºä¿æŒ‰éˆ•ç‹€æ…‹æ­£ç¢ºæ›´æ–°
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å¯é€€å›å•†å“æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    private async Task RemoveItemAsync(int index)
    {
        if (index >= 0 && index < ReturnItems.Count)
        {
            var itemToRemove = ReturnItems[index];
            
            // å¦‚æœè¢«åˆªé™¤çš„é …ç›®æœ‰å°æ‡‰çš„è³‡æ–™åº«å¯¦é«”ï¼Œè¨˜éŒ„å…¶ ID ä»¥ä¾¿å¾ŒçºŒåˆªé™¤
            if (itemToRemove.ExistingDetailEntity?.Id > 0)
            {
                _deletedDetailIds.Add(itemToRemove.ExistingDetailEntity.Id);
            }
            
            // é€šçŸ¥çˆ¶çµ„ä»¶é …ç›®å³å°‡è¢«ç§»é™¤ï¼ˆè®“çˆ¶çµ„ä»¶å¯ä»¥è™•ç†å¯¦éš›çš„è³‡æ–™åº«åˆªé™¤ï¼‰
            if (OnItemRemoved.HasDelegate)
            {
                await OnItemRemoved.InvokeAsync(itemToRemove);
            }
            
            ReturnItems.RemoveAt(index);
            await NotifyDetailsChanged();
        }
    }

    private async Task NotifyDetailsChanged()
    {
        // è½‰æ›ç‚º PurchaseReturnDetail å¯¦é«”
        var details = ReturnItems.Where(item => item.SelectedReceivingDetail != null && item.ReturnQuantity > 0)
                                 .Select(ConvertToEntity)
                                 .Where(detail => detail != null)
                                 .Cast<PurchaseReturnDetail>()
                                 .ToList();
        
        if (EffectiveDetailsChangedCallback.HasDelegate)
        {
            await EffectiveDetailsChangedCallback.InvokeAsync(details);
        }
        
        // é€šçŸ¥å·²åˆªé™¤çš„æ˜ç´° ID
        if (OnDeletedDetailsChanged.HasDelegate && _deletedDetailIds.Any())
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds.ToList());
            // æ¸…ç©ºå·²é€šçŸ¥çš„åˆªé™¤ IDï¼Œé¿å…é‡è¤‡åˆªé™¤
            _deletedDetailIds.Clear();
        }
        
        if (OnReturnItemsChanged.HasDelegate)
        {
            await OnReturnItemsChanged.InvokeAsync(ReturnItems);
        }

        // é€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
        await NotifyHasUndeletableDetailsChanged();
    }

    private PurchaseReturnDetail? ConvertToEntity(ReturnItem item)
    {
        if (item.SelectedReceivingDetail == null || item.SelectedProduct == null || item.ReturnQuantity <= 0)
        {
            return null;
        }
        
        // å¦‚æœå·²æœ‰å¯¦é«”ï¼Œæ›´æ–°å®ƒ
        if (item.ExistingDetailEntity != null)
        {
            var existingDetail = item.ExistingDetailEntity;
            existingDetail.ReturnQuantity = item.ReturnQuantity;
            existingDetail.OriginalUnitPrice = item.OriginalUnitPrice;
            existingDetail.TaxRate = item.TaxRate;
            existingDetail.Remarks = item.Remarks;
            existingDetail.BatchNumber = item.BatchNumber;
            existingDetail.PurchaseReceivingDetailId = item.SelectedReceivingDetail.Id;
            existingDetail.ProductId = item.SelectedProduct.Id;
            
            return existingDetail;
        }
        
        // å‰µå»ºæ–°å¯¦é«”
        return new PurchaseReturnDetail
        {
            ProductId = item.SelectedProduct.Id,
            PurchaseReceivingDetailId = item.SelectedReceivingDetail.Id,
            ReturnQuantity = item.ReturnQuantity,
            OriginalUnitPrice = item.OriginalUnitPrice,
            TaxRate = item.TaxRate,
            Remarks = item.Remarks,
            BatchNumber = item.BatchNumber
        };
    }

    // ===== å…¬é–‹æ–¹æ³• - ä¾›çˆ¶çµ„ä»¶èª¿ç”¨ =====
    public async Task<bool> ValidateAsync()
    {
        try
        {
            // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„é€€å›æ˜ç´°
            var validItems = ReturnItems.Where(item => item.SelectedReceivingDetail != null && item.ReturnQuantity > 0).ToList();
            
            if (!validItems.Any())
            {
                await NotificationService.ShowWarningAsync("è‡³å°‘éœ€è¦ä¸€ç­†æœ‰æ•ˆçš„é€€å›æ˜ç´°");
                return false;
            }
            
            // æª¢æŸ¥é€€å›æ•¸é‡æ˜¯å¦è¶…éå¯é€€å›æ•¸é‡
            foreach (var item in validItems)
            {
                var maxQuantity = item.OriginalQuantity - item.AlreadyReturnedQuantity;
                if (item.ReturnQuantity > maxQuantity)
                {
                    await NotificationService.ShowErrorAsync($"å•†å“ {item.SelectedProduct?.Name} çš„é€€å›æ•¸é‡ ({item.ReturnQuantity}) è¶…éå¯é€€å›æ•¸é‡ ({maxQuantity})");
                    return false;
                }
            }
            
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é©—è­‰é€€å›æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }
    
    // ===== ReturnItem å…§éƒ¨é¡åˆ¥ =====
    public class ReturnItem
    {
        public Product? SelectedProduct { get; set; }
        public PurchaseReceivingDetail? SelectedReceivingDetail { get; set; }
        
        public int OriginalQuantity { get; set; } = 0;
        public int AlreadyReturnedQuantity { get; set; } = 0;
        public int ReturnQuantity { get; set; } = 0;
        
        public decimal OriginalUnitPrice { get; set; } = 0;
        
        public decimal TaxRate { get; set; } = 0;
        
        public string Remarks { get; set; } = string.Empty;
        public string BatchNumber { get; set; } = string.Empty;
        
        public PurchaseReturnDetail? ExistingDetailEntity { get; set; }
        public string? ValidationError { get; set; }
        
        // === SearchableSelect æ”¯æ´å±¬æ€§ ===
        public string ReceivingDetailSearchValue { get; set; } = string.Empty;
        public List<PurchaseReceivingDetail> FilteredReceivingDetails { get; set; } = new();
        public bool ShowReceivingDetailDropdown { get; set; } = false;
        public int ReceivingDetailSelectedIndex { get; set; } = -1;
        
        // è¨ˆç®—å±¬æ€§
        public decimal ReturnSubtotal => ReturnQuantity * OriginalUnitPrice;
        public int AvailableQuantity => OriginalQuantity - AlreadyReturnedQuantity;
        
        /// <summary>
        /// å–å¾—é¡¯ç¤ºç”¨çš„å•†å“åç¨±ï¼ˆåŒ…å«é€²è²¨å–®è™Ÿï¼‰
        /// </summary>
        public string DisplayName => 
            SelectedReceivingDetail?.Product != null && !string.IsNullOrEmpty(SelectedReceivingDetail.PurchaseReceiving?.Code)
                ? $"[{SelectedReceivingDetail.PurchaseReceiving.Code}] [{SelectedReceivingDetail.Product.Code}] {SelectedReceivingDetail.Product.Name}"
                : SelectedProduct != null 
                    ? $"[{SelectedProduct.Code}] {SelectedProduct.Name}" 
                    : "";
    }
}
