@* æ¡è³¼å–®å•†å“ç®¡ç†çµ„ä»¶ - ç°¡åŒ–æ¸¬è©¦ç‰ˆæœ¬ *@

@inject INotificationService NotificationService

@typeparam TMainEntity where TMainEntity : BaseEntity
@typeparam TDetailEntity where TDetailEntity : BaseEntity, new()

<div class="card border-0 shadow-sm">    
    <div class="card-body p-0">
        <InteractiveTableComponent @ref="tableComponent"
                                  TItem="ProductItem" 
                                  Items="@ProductItems"
                                  ColumnDefinitions="@GetColumnDefinitions()"
                                  IsReadOnly="@IsReadOnly"
                                  ShowRowNumbers="true"
                                  EmptyMessage="å°šæœªæ–°å¢å•†å“"
                                  ShowBuiltInActions="false"
                                  EnableAutoEmptyRow="true"
                                  CreateEmptyItem="@CreateNewEmptyItem" />
    </div>
</div>

@code {
    // ===== å¿…è¦åƒæ•¸ï¼ˆç¶­æŒåŸæœ‰ä»‹é¢ï¼‰ =====
    [Parameter] public List<Product> Products { get; set; } = new();
    [Parameter] public bool IsReadOnly { get; set; } = false;
    [Parameter] public int? SelectedSupplierId { get; set; }
    [Parameter] public TMainEntity? MainEntity { get; set; }
    [Parameter] public List<TDetailEntity> ExistingDetails { get; set; } = new();
    [Parameter] public EventCallback<List<TDetailEntity>> OnDetailsChanged { get; set; }
    
    // ===== æ¬„ä½æ˜ å°„åƒæ•¸ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰ =====
    [Parameter] public string MainEntityIdPropertyName { get; set; } = string.Empty;
    [Parameter] public string QuantityPropertyName { get; set; } = "Quantity";
    [Parameter] public string ReceivedQuantityPropertyName { get; set; } = "ReceivedQuantity";
    [Parameter] public string UnitPricePropertyName { get; set; } = "UnitPrice";
    [Parameter] public string RemarksPropertyName { get; set; } = "Remarks";
    [Parameter] public string? UnitIdPropertyName { get; set; }
    [Parameter] public string? IsReceivingCompletedPropertyName { get; set; }
    
    // ===== é¡¯ç¤ºè¨­å®šåƒæ•¸ =====
    [Parameter] public bool IsApproved { get; set; } = false;
    
    // ===== åŸæœ‰çš„äº‹ä»¶åƒæ•¸ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰ =====
    [Parameter] public EventCallback<bool> OnHasUndeletableDetailsChanged { get; set; }
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }
    
    // ===== ç§æœ‰æ¬„ä½ =====
    private InteractiveTableComponent<ProductItem>? tableComponent;
    private List<ProductItem> ProductItems { get; set; } = new();
    
    // ===== ç”Ÿå‘½é€±æœŸ =====
    protected override void OnInitialized()
    {
        Console.WriteLine("=== PurchaseOrderTable OnInitialized ===");
        Console.WriteLine($"ProductItems.Count = {ProductItems.Count}");
    }

    // ===== å»ºç«‹ç©ºé …ç›®ï¼ˆé—œéµæ–¹æ³•ï¼‰ =====
    private ProductItem CreateNewEmptyItem()
    {
        var timestamp = DateTime.Now.ToString("HH:mm:ss.fff");
        Console.WriteLine($"[{timestamp}] CreateNewEmptyItem è¢«å‘¼å« | ç•¶å‰æ•¸é‡: {ProductItems.Count}");
        return new ProductItem();
    }

    // ===== æ¬„ä½å®šç¾© =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = "å•†å“åç¨±",
                PropertyName = "ProductName",
                ColumnType = InteractiveColumnType.Input,
                Width = "200px",
                Placeholder = "è¼¸å…¥å•†å“åç¨±...",
                Tooltip = "å•†å“åç¨±æ˜¯é—œéµæ¬„ä½ï¼Œå¡«å…¥å¾Œæœƒè‡ªå‹•æ–°å¢ä¸‹ä¸€è¡Œ",
                TriggerEmptyRowOnFilled = true  // ğŸ”‘ é—œéµæ¬„ä½ï¼šå¡«å…¥å€¼å¾Œè‡ªå‹•æ–°å¢ç©ºè¡Œ
            },
            new()
            {
                Title = "é¡åˆ¥",
                PropertyName = "Category",
                ColumnType = InteractiveColumnType.Select,
                Width = "150px",
                Placeholder = "é¸æ“‡é¡åˆ¥",
                Tooltip = "é¸æ“‡å•†å“é¡åˆ¥",
                Options = new List<InteractiveSelectOption>
                {
                    new() { Value = "", Text = "è«‹é¸æ“‡" },
                    new() { Value = "A", Text = "é¡åˆ¥ A" },
                    new() { Value = "B", Text = "é¡åˆ¥ B" },
                    new() { Value = "C", Text = "é¡åˆ¥ C" },
                    new() { Value = "D", Text = "é¡åˆ¥ D" }
                },
                TriggerEmptyRowOnFilled = true
            },
            new()
            {
                Title = "æ•¸é‡",
                PropertyName = "Quantity",
                ColumnType = InteractiveColumnType.Number,
                Width = "100px",
                Placeholder = "è¼¸å…¥æ•¸é‡",
                Tooltip = "æ•¸é‡å¯ä»¥ç‚ºç©º"
            },
            new()
            {
                Title = "å–®åƒ¹",
                PropertyName = "Price",
                ColumnType = InteractiveColumnType.Number,
                Width = "120px",
                Placeholder = "è¼¸å…¥å–®åƒ¹",
                Tooltip = "å–®åƒ¹å¯ä»¥ç‚ºç©º"
            },
            new()
            {
                Title = "å°è¨ˆ",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Display,
                Width = "120px",
                DisplayFormatter = (item) =>
                {
                    if (item is ProductItem p)
                    {
                        if (p.Quantity.HasValue && p.Price.HasValue)
                        {
                            var total = p.Quantity.Value * p.Price.Value;
                            return total > 0 ? total.ToString("N2") : "0.00";
                        }
                        return "-";
                    }
                    return "-";
                }
            }
        };
    }

    // ===== ç°¡åŒ–çš„ ProductItem é¡åˆ¥ =====
    public class ProductItem
    {
        public string ProductName { get; set; } = string.Empty;
        public string? Category { get; set; } = null;  // ğŸ”‘ ä¸‹æ‹‰é¸å–®æ¬„ä½ï¼Œå¯ç‚º null
        public int? Quantity { get; set; } = null;     // ğŸ”‘ æ”¹ç‚ºå¯ç©ºå€¼ï¼Œé è¨­ç‚º null è€Œä¸æ˜¯ 0
        public decimal? Price { get; set; } = null;    // ğŸ”‘ æ”¹ç‚ºå¯ç©ºå€¼ï¼Œé è¨­ç‚º null è€Œä¸æ˜¯ 0
    }
}
