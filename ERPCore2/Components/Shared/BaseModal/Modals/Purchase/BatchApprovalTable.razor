@*
    批次審核表格元件
    專門用於批次審核功能的表格顯示
*@
@using ERPCore2.Models
@using ERPCore2.Data.Entities
@using ERPCore2.Components.Shared.SubCollections
@typeparam TEntity where TEntity : class

<div class="table-responsive">
    <InteractiveTableComponent TItem="TEntity"
                             Items="@Items"
                             ColumnDefinitions="@columnDefinitions"
                             ShowHeader="true"
                             ShowActions="true"
                             ShowRowNumbers="true"
                             IsStriped="true"
                             IsHoverable="true"
                             IsBordered="true"
                             EnableRowClick="true"
                             EnableRowSelection="true"
                             AllowMultipleSelection="true"
                             SelectedItems="@SelectedItems"
                             OnSelectionChanged="@HandleSelectionChanged"
                             GetRowCssClass="@GetRowCssClass"
                             ActionsTemplate="@GetActionsTemplate()"
                             CssClass="batch-approval-table"
                             EmptyMessage="太棒了！目前沒有待審核的項目。" />
</div>

@code {
    // ===== 參數定義 =====
    
    [Parameter] public List<TEntity> Items { get; set; } = new();
    [Parameter] public HashSet<TEntity>? SelectedItems { get; set; }
    [Parameter] public EventCallback<HashSet<TEntity>> OnSelectionChanged { get; set; }
    [Parameter] public Func<TEntity, int, string>? GetRowCssClass { get; set; }
    
    /// <summary>
    /// 查看按鈕點擊事件
    /// </summary>
    [Parameter] public EventCallback<TEntity> OnViewClick { get; set; }
    
    // ===== 內部狀態 =====
    
    private List<InteractiveColumnDefinition> columnDefinitions = new();
    
    // ===== 生命週期方法 =====
    
    protected override void OnInitialized()
    {
        BuildTableColumns();
    }
    
    // ===== 初始化方法 =====
    
    /// <summary>
    /// 建立表格欄位定義 - 針對採購單批次審核
    /// </summary>
    private void BuildTableColumns()
    {
        // 根據實體類型動態建立欄位
        if (typeof(TEntity) == typeof(PurchaseOrder))
        {
            BuildPurchaseOrderColumns();
        }
        else
        {
            // 其他實體類型可以在這裡擴展
            BuildDefaultColumns();
        }
    }
    
    /// <summary>
    /// 建立採購單的欄位定義
    /// </summary>
    private void BuildPurchaseOrderColumns()
    {
        columnDefinitions = new List<InteractiveColumnDefinition>
        {
            // 採購單號
            new InteractiveColumnDefinition
            {
                Title = "採購單號",
                PropertyName = nameof(PurchaseOrder.PurchaseOrderNumber),
                ColumnType = InteractiveColumnType.Display,
                Width = "150px"
            },
            
            // 廠商
            new InteractiveColumnDefinition
            {
                Title = "廠商",
                PropertyName = "Supplier.CompanyName",
                ColumnType = InteractiveColumnType.Display,
                Width = "200px"
            },
            
            // 訂單日期
            new InteractiveColumnDefinition
            {
                Title = "訂單日期",
                PropertyName = nameof(PurchaseOrder.OrderDate),
                ColumnType = InteractiveColumnType.Display,
                Width = "120px",
                DisplayFormatter = value => 
                {
                    if (value is DateTime date)
                        return $"<span style='font-size: 0.875rem;'>{date:yyyy/MM/dd}</span>";
                    return "-";
                }
            },
            
            // 預計到貨日
            new InteractiveColumnDefinition
            {
                Title = "預計到貨日",
                PropertyName = nameof(PurchaseOrder.ExpectedDeliveryDate),
                ColumnType = InteractiveColumnType.Display,
                Width = "120px",
                DisplayFormatter = value => 
                {
                    if (value is DateTime date)
                        return $"<span style='font-size: 0.875rem;'>{date:yyyy/MM/dd}</span>";
                    return "<span style='font-size: 0.875rem;'>-</span>";
                }
            },
            
            // 總金額
            new InteractiveColumnDefinition
            {
                Title = "總金額",
                PropertyName = nameof(PurchaseOrder.TotalAmount),
                ColumnType = InteractiveColumnType.Display,
                Width = "120px",
                CellCssClass = "text-end",
                DisplayFormatter = value => 
                {
                    if (value is decimal amount)
                        return $"<span style='font-size: 0.875rem;' class='fw-bold'>{amount:N0}</span>";
                    return "0";
                }
            },
            
            // 建立日期
            new InteractiveColumnDefinition
            {
                Title = "建立日期",
                PropertyName = nameof(PurchaseOrder.CreatedAt),
                ColumnType = InteractiveColumnType.Display,
                Width = "150px",
                DisplayFormatter = value => 
                {
                    if (value is DateTime date)
                        return $"<span style='font-size: 0.875rem;'>{date:yyyy/MM/dd HH:mm}</span>";
                    return "-";
                }
            }
        };
    }
    
    /// <summary>
    /// 建立預設欄位定義（用於其他實體類型）
    /// </summary>
    private void BuildDefaultColumns()
    {
        columnDefinitions = new List<InteractiveColumnDefinition>
        {
            new InteractiveColumnDefinition
            {
                Title = "ID",
                PropertyName = "Id",
                ColumnType = InteractiveColumnType.Display,
                Width = "100px"
            }
        };
    }
    
    // ===== 事件處理方法 =====
    
    /// <summary>
    /// 處理選取狀態變更事件
    /// </summary>
    private async Task HandleSelectionChanged(HashSet<TEntity> selectedItems)
    {
        if (OnSelectionChanged.HasDelegate)
        {
            await OnSelectionChanged.InvokeAsync(selectedItems);
        }
    }
    
    /// <summary>
    /// 操作按鈕範本
    /// </summary>
    private RenderFragment<TEntity> GetActionsTemplate()
    {
        return entity => __builder =>
        {
            @* 查看按鈕 *@
            <GenericButtonComponent Variant="ButtonVariant.Info"
                                  IconClass="bi bi-eye text-white"
                                  Size="ButtonSize.Large"
                                  Title="查看詳情"
                                  OnClick="@(async () => await HandleViewClick(entity))"
                                  StopPropagation="true"
                                  CssClass="btn-square" />
        };
    }
    
    /// <summary>
    /// 處理查看按鈕點擊
    /// </summary>
    private async Task HandleViewClick(TEntity entity)
    {
        if (OnViewClick.HasDelegate)
        {
            await OnViewClick.InvokeAsync(entity);
        }
    }
}
