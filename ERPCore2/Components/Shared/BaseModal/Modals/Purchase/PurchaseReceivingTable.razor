@* æ¡è³¼å…¥åº«æ˜ç´°ç®¡ç†çµ„ä»¶ - ç°¡åŒ–ç‰ˆæœ¬ *@

@using ERPCore2.Helpers.InteractiveTableComponentHelper
@using ERPCore2.Helpers
@using ERPCore2.Data.Enums
@inject IProductService ProductService
@inject IPurchaseOrderService PurchaseOrderService
@inject IPurchaseReceivingDetailService PurchaseReceivingDetailService
@inject ISystemParameterService SystemParameterService
@inject INotificationService NotificationService
@inject RelatedDocumentsHelper RelatedDocumentsHelper
@inject IPurchaseReturnDetailService PurchaseReturnDetailService
@inject IJSRuntime JSRuntime

@typeparam TMainEntity where TMainEntity : BaseEntity
@typeparam TDetailEntity where TDetailEntity : BaseEntity, new()

@if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <p class="text-muted">è«‹å…ˆé¸æ“‡å» å•†</p>
        </div>
    </div>
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="ReceivingItem" 
                                      Items="@ReceivingItems"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"
                                      ShowRowNumbers="false"
                                      EmptyMessage="å°šæœªæ–°å¢å…¥åº«å•†å“"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="false"
                                      ActionsColumnWidth="60px"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"
                                      OnItemDelete="@HandleItemDelete"
                                      EnableAutoEmptyRow="true"
                                      AllowAddNewRow="@(!_hasUndeletableDetails && !IsReadOnly)"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@(() => new ReceivingItem())" />
        </div>
        
        <div class="card-footer">
            <div class="d-flex justify-content-between">
                @* å·¦å´æŒ‰éˆ•çµ„ *@
                <div class="d-flex gap-2">
                    <GenericButtonComponent
                                          Text="æ™ºèƒ½ä¸‹å–®"
                                          OnClick="@SmartLoadReceivingDetails"
                                          IsDisabled="@(!CanUseSmartLoad || IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetSmartLoadTooltip()"
                                          Variant="ButtonVariant.DarkBlue"
                                          Size="ButtonSize.Small" />
                    <GenericButtonComponent
                                          Text="è¼‰å…¥æ¡è³¼"
                                          OnClick="@LoadAllUnreceivedItems"
                                          IsDisabled="@(!CanLoadPurchaseOrder || IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetLoadPurchaseOrderTooltip()"
                                          Variant="ButtonVariant.DarkBlue"
                                          Size="ButtonSize.Small" />
                </div>
                
                @* å³å´æŒ‰éˆ•çµ„ *@
                <div class="d-flex gap-2">
                    @* å€‰åº«çµ±ä¸€æŒ‰éˆ•ï¼ˆä¸‹æ‹‰é¸å–®ï¼‰ *@
                    <div class="dropdown">
                        <GenericButtonComponent
                                              Text="å€‰åº«çµ±ä¸€"
                                              Variant="ButtonVariant.Green"
                                              Size="ButtonSize.Small"
                                              IsDisabled="@(!HasReceivingItems || IsReadOnly || _hasUndeletableDetails)"
                                              Title="@GetUnifyWarehouseTooltip()"
                                              AdditionalAttributes="@(new Dictionary<string, object> 
                                              { 
                                                  { "data-bs-toggle", "dropdown" },
                                                  { "aria-expanded", "false" }
                                              })" />
                        <ul class="dropdown-menu dropdown-menu-end">
                            @if (Warehouses.Any())
                            {
                                @foreach (var warehouse in Warehouses)
                                {
                                    <li>
                                        <a class="dropdown-item" 
                                           href="#" 
                                           @onclick="() => UnifyWarehouse(warehouse.Id)"
                                           @onclick:preventDefault="true">
                                            @warehouse.Name
                                        </a>
                                    </li>
                                }
                            }
                            else
                            {
                                <li><span class="dropdown-item-text text-muted">ç„¡å¯ç”¨å€‰åº«</span></li>
                            }
                        </ul>
                    </div>
                    
                    <GenericButtonComponent
                                          Text="æ¸…é™¤æ˜ç´°"
                                          OnClick="@ClearAllDetails"
                                          IsDisabled="@(!HasReceivingItems || IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetClearDetailsTooltip()"
                                          Variant="ButtonVariant.Red"
                                          Size="ButtonSize.Small" />
                </div>
            </div>
        </div>
    </div>
}

<!-- ç›¸é—œå–®æ“šæŸ¥çœ‹ Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

@code {
    // ===== åƒæ•¸ =====
    [Parameter] public int? SelectedSupplierId { get; set; }
    [Parameter] public int? SelectedPurchaseOrderId { get; set; }
    [Parameter] public int? FilterProductId { get; set; }
    [Parameter] public TMainEntity? MainEntity { get; set; }
    [Parameter] public List<TDetailEntity> ExistingDetails { get; set; } = new();
    [Parameter] public EventCallback<List<TDetailEntity>> OnDetailsChanged { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    [Parameter] public EventCallback<bool> OnHasUndeletableDetailsChanged { get; set; }
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }
    [Parameter] public string MainEntityIdPropertyName { get; set; } = string.Empty;
    [Parameter] public string QuantityPropertyName { get; set; } = "ReceivedQuantity";
    [Parameter] public string UnitPricePropertyName { get; set; } = "UnitPrice";
    [Parameter] public string RemarksPropertyName { get; set; } = "Remarks";
    [Parameter] public string? PurchaseOrderDetailIdPropertyName { get; set; }
    [Parameter] public bool ShowWarehouse { get; set; } = true;
    [Parameter] public bool ShowWarehouseLocation { get; set; } = true;
    [Parameter] public string? WarehouseIdPropertyName { get; set; }
    [Parameter] public string? WarehouseLocationIdPropertyName { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;
    [Parameter] public List<Warehouse> Warehouses { get; set; } = new();
    [Parameter] public List<WarehouseLocation> WarehouseLocations { get; set; } = new();
    [Parameter] public TaxCalculationMethod TaxCalculationMethod { get; set; } = TaxCalculationMethod.TaxExclusive;
    
    // ===== ç§æœ‰æ¬„ä½ =====
    private InteractiveTableComponent<ReceivingItem>? tableComponent;
    private List<ReceivingItem> ReceivingItems { get; set; } = new();
    private List<Product> AvailableProducts { get; set; } = new();
    private List<PurchaseOrderDetail> AvailablePurchaseDetails { get; set; } = new();
    private bool _dataLoadCompleted = true;
    private int? _previousSupplierId = null;
    private List<int> _deletedDetailIds = new(); // è¿½è¹¤å·²åˆªé™¤çš„æ˜ç´°ID
    private Dictionary<int, decimal> _returnedQuantities = new(); // è¿½è¹¤æ¯å€‹æ˜ç´°çš„å·²é€€è²¨æ•¸é‡ (Key: DetailId, Value: å·²é€€è²¨æ•¸é‡)
    private bool _hasUndeletableDetails = false;  // æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼‰
    
    // ===== ç›¸é—œå–®æ“šæŸ¥çœ‹ =====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;
    
    // ===== å…§éƒ¨é¡åˆ¥ =====
    public class ReceivingItem
    {
        // åŸºæœ¬è³‡æ–™
        public Product? SelectedProduct { get; set; }
        public PurchaseOrderDetail? SelectedPurchaseDetail { get; set; }  // æ¡è³¼æ˜ç´°
        public string ProductSearchValue { get; set; } = string.Empty;
        
        // æ•¸é‡å’Œåƒ¹æ ¼
        public int OrderQuantity { get; set; }
        public int ReceivedQuantity { get; set; }
        public int TotalReturnedQuantity { get; set; } // ç´¯è¨ˆé€€è²¨æ•¸é‡
        public decimal UnitPrice { get; set; }
        public decimal TaxRate { get; set; }
        
        // å€‰åº«
        public Warehouse? SelectedWarehouse { get; set; }
        public WarehouseLocation? SelectedWarehouseLocation { get; set; }
        
        // å€‰åº«IDï¼ˆç”¨æ–¼Selectæ¬„ä½ç¶å®šï¼‰
        public int? WarehouseId
        {
            get => SelectedWarehouse?.Id;
            set
            {
                // ç•¶è¨­å®šå€¼æ™‚ï¼Œéœ€è¦å¾ Warehouses é›†åˆä¸­æ‰¾åˆ°å°æ‡‰çš„å€‰åº«ç‰©ä»¶
                // é€™å€‹è¨­å®šæœƒåœ¨ OnWarehouseChange ä¸­è™•ç†
            }
        }
        
        // å‚™è¨»
        public string Remarks { get; set; } = string.Empty;
        
        // SearchableSelect éœ€è¦çš„å±¬æ€§
        public List<object> FilteredItems { get; set; } = new();
        public bool ShowDropdown { get; set; }
        public int SelectedIndex { get; set; } = -1;
        
        // ç¾æœ‰å¯¦é«”ï¼ˆç·¨è¼¯æ¨¡å¼ç”¨ï¼‰
        public TDetailEntity? ExistingDetailEntity { get; set; }
    }
    
    // ===== ç”Ÿå‘½é€±æœŸ =====
    private int? _previousPurchaseOrderId = null; // è¿½è¹¤æ¡è³¼å–®è®Šæ›´
    private int? _previousFilterProductId = null; // è¿½è¹¤å•†å“ç¯©é¸è®Šæ›´
    
    protected override async Task OnInitializedAsync()
    {
        _previousSupplierId = SelectedSupplierId;
        _previousPurchaseOrderId = SelectedPurchaseOrderId;
        _previousFilterProductId = FilterProductId;
        await LoadProductsAsync();
        await LoadExistingDetailsAsync();
    }
    
    protected override async Task OnParametersSetAsync()
    {
        // æª¢æŸ¥ç¯©é¸åƒæ•¸æ˜¯å¦è®Šæ›´
        bool needReload = false;
        
        // å» å•†è®Šæ›´æ™‚é‡æ–°è¼‰å…¥
        if (_previousSupplierId != SelectedSupplierId)
        {
            _previousSupplierId = SelectedSupplierId;
            needReload = true;
        }
        
        // æ¡è³¼å–®ç¯©é¸è®Šæ›´æ™‚é‡æ–°è¼‰å…¥
        if (_previousPurchaseOrderId != SelectedPurchaseOrderId)
        {
            _previousPurchaseOrderId = SelectedPurchaseOrderId;
            needReload = true;
        }
        
        // å•†å“ç¯©é¸è®Šæ›´æ™‚é‡æ–°è¼‰å…¥
        if (_previousFilterProductId != FilterProductId)
        {
            _previousFilterProductId = FilterProductId;
            needReload = true;
        }
        
        if (needReload)
        {
            await LoadProductsAsync();
            
            // åªæœ‰å» å•†è®Šæ›´æ™‚æ‰æ¸…ç©ºæ˜ç´°é …ç›®
            if (_previousSupplierId != SelectedSupplierId)
            {
                ReceivingItems.Clear();
                
                if (ExistingDetails?.Any() != true)
                {
                    _dataLoadCompleted = true;
                    StateHasChanged();
                }
                else
                {
                    await LoadExistingDetailsAsync();
                }
            }
        }
    }
    
    // ===== æ¬„ä½å®šç¾© =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();
        
        // 1. å•†å“ç·¨è™Ÿ/åç¨± - è§¸ç™¼æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å•†å“ç·¨è™Ÿ/åç¨±",
            PropertyName = "ProductSearchValue",
            EmptyCheckPropertyName = "SelectedProduct",
            TriggerEmptyRowOnFilled = true,  // é¸æ“‡å¾Œè‡ªå‹•æ–°å¢ç©ºè¡Œ
            ColumnType = InteractiveColumnType.SearchableSelect,
            Width = "300px",
            Placeholder = "è«‹è¼¸å…¥å•†å“ç·¨è™Ÿæˆ–åç¨±",
            SearchValuePropertyName = nameof(ReceivingItem.ProductSearchValue),
            FilteredItemsPropertyName = nameof(ReceivingItem.FilteredItems),
            ShowDropdownPropertyName = nameof(ReceivingItem.ShowDropdown),
            SelectedIndexPropertyName = nameof(ReceivingItem.SelectedIndex),
            IsDisabledFunc = item =>
            {
                var receivingItem = (ReceivingItem)item;
                var isEmptyRow = receivingItem.SelectedProduct == null;
                return !DetailLockHelper.CanDeleteItem(receivingItem.ExistingDetailEntity, out _, 
                    checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities) && !isEmptyRow;
            },
            ItemDisplayFormatter = (item) =>
            {
                if (item is PurchaseOrderDetail detail)
                    return FormatPurchaseDetailDisplay(detail);
                else if (item is Product product)
                    return FormatProductDisplay(product);
                return string.Empty;
            },
            OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                await OnProductSearch((ReceivingItem)args.Item1, args.Item2);
            }),
            OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async args =>
            {
                await OnProductSelect((ReceivingItem)args.Item1, args.Item2);
            }),
            OnInputFocus = EventCallback.Factory.Create<object>(this, item =>
            {
                OnProductFocus((ReceivingItem)item);
            }),
            OnInputBlur = EventCallback.Factory.Create<object>(this, item =>
            {
                OnProductBlur((ReceivingItem)item);
            }),
            EnableKeyboardNavigation = true,
            GetDropdownItems = (item) => ((ReceivingItem)item).FilteredItems,
            GetSelectedIndex = (item) => ((ReceivingItem)item).SelectedIndex,
            SetSelectedIndex = (item, index) => ((ReceivingItem)item).SelectedIndex = index,
            GetShowDropdown = (item) => ((ReceivingItem)item).ShowDropdown,
            SetShowDropdown = (item, show) => ((ReceivingItem)item).ShowDropdown = show,
            MaxDisplayItems = 20
        });
        
        // 2. æ¡è³¼æ•¸é‡ï¼ˆå”¯è®€ï¼‰
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "æ¡è³¼é‡",
            PropertyName = "OrderQuantity",
            ColumnType = InteractiveColumnType.Display,
            Width = "100px",
            TextAlign = "right",
            IsReadOnly = true
        });
        
        // 3. å…¥åº«æ•¸é‡
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å…¥åº«é‡",
            PropertyName = "ReceivedQuantity",
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            MinValue = 0,
            IsDisabledFunc = item =>
            {
                var receivingItem = (ReceivingItem)item;
                var isEmptyRow = receivingItem.SelectedProduct == null;
                return !DetailLockHelper.CanDeleteItem(receivingItem.ExistingDetailEntity, out _, 
                    checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities) && !isEmptyRow;
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                await OnQuantityChange((ReceivingItem)args.Item1, args.Item2);
            })
        });
        
        // 4. å·²é€€æ•¸é‡ï¼ˆå”¯è®€ï¼Œé¡¯ç¤ºç´¯è¨ˆé€€è²¨æ•¸é‡ï¼‰
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å·²é€€é‡",
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "100px",
            CustomTemplate = item =>
            {
                var receivingItem = (ReceivingItem)item;
                var totalReturned = receivingItem.TotalReturnedQuantity;
                
                if (totalReturned > 0)
                {
                    // æœ‰é€€è²¨è¨˜éŒ„ï¼šç”¨è—è‰²é¡¯ç¤ºä¸¦åŠ ä¸Šåœ–ç¤º
                    return @<div class="text-end text-info fw-bold" title="å·²æœ‰é€€è²¨è¨˜éŒ„">
                        <i class="bi bi-arrow-return-left me-1"></i>@totalReturned
                    </div>;
                }
                else if (receivingItem.SelectedProduct != null)
                {
                    // ç„¡é€€è²¨è¨˜éŒ„ï¼šç”¨ç°è‰²é¡¯ç¤º
                    return @<div class="text-end text-muted">0</div>;
                }
                else
                {
                    // ç©ºè¡Œï¼šä¸é¡¯ç¤º
                    return @<div class="text-end text-muted">-</div>;
                }
            }
        });
        
        // 5. å–®åƒ¹
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å–®åƒ¹",
            PropertyName = "UnitPrice",
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            MinValue = 0,
            IsDisabledFunc = item =>
            {
                var receivingItem = (ReceivingItem)item;
                var isEmptyRow = receivingItem.SelectedProduct == null;
                return !DetailLockHelper.CanDeleteItem(receivingItem.ExistingDetailEntity, out _, 
                    checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities) && !isEmptyRow;
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                await OnPriceChange((ReceivingItem)args.Item1, args.Item2);
            })
        });
        
        // 6. ç¨…ç‡%
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "ç¨…ç‡%",
            PropertyName = "TaxRate",
            ColumnType = InteractiveColumnType.Number,
            Width = "80px",
            MinValue = 0,
            MaxValue = 100,
            IsDisabledFunc = item =>
            {
                var receivingItem = (ReceivingItem)item;
                var isEmptyRow = receivingItem.SelectedProduct == null;
                // å…ç¨…æ¨¡å¼ æˆ– å·²æœ‰é€€è²¨/æ²–æ¬¾è¨˜éŒ„æ™‚ç¦ç”¨
                return TaxCalculationMethod == TaxCalculationMethod.NoTax ||
                       (!DetailLockHelper.CanDeleteItem(receivingItem.ExistingDetailEntity, out _, 
                           checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities) && !isEmptyRow);
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                await OnTaxRateChange((ReceivingItem)args.Item1, args.Item2);
            })
        });
        
        // 7. å°è¨ˆï¼ˆè¨ˆç®—æ¬„ä½ï¼‰
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å°è¨ˆ",
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item =>
            {
                var receivingItem = (ReceivingItem)item;
                var subtotal = CalculateSubtotal(receivingItem);
                return @<div class="text-end fw-bold text-success">@subtotal.ToString("N0")</div>;
            }
        });
        
        // 8. å€‰åº«
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å€‰åº«",
            PropertyName = "WarehouseId",
            ColumnType = InteractiveColumnType.Select,
            Width = "120px",
            Placeholder = "è«‹é¸æ“‡",
            Options = Warehouses.Select(w => new InteractiveSelectOption
            {
                Value = w.Id.ToString(),
                Text = w.Name
            }).ToList(),
            IsDisabledFunc = item =>
            {
                var receivingItem = (ReceivingItem)item;
                var isEmptyRow = receivingItem.SelectedProduct == null;
                return !DetailLockHelper.CanDeleteItem(receivingItem.ExistingDetailEntity, out _, 
                    checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities) && !isEmptyRow;
            },
            OnSelectionChanged = EventCallback.Factory.Create<(object, object?)>(this, async args =>
            {
                await OnWarehouseChange((ReceivingItem)args.Item1, args.Item2?.ToString());
            })
        });
        
        // 9. åº«ä½
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "åº«ä½",
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item =>
            {
                var receivingItem = (ReceivingItem)item;
                var selectedLocationId = receivingItem.SelectedWarehouseLocation?.Id.ToString() ?? "";
                
                var availableLocations = receivingItem.SelectedWarehouse != null
                    ? WarehouseLocations.Where(wl => wl.WarehouseId == receivingItem.SelectedWarehouse.Id).ToList()
                    : new List<WarehouseLocation>();
                
                // æª¢æŸ¥æ˜¯å¦æ‡‰è©²ç¦ç”¨ï¼ˆå”¯è®€æ¨¡å¼ æˆ– å·²æœ‰é€€è²¨/æ²–æ¬¾è¨˜éŒ„ï¼‰
                var isEmptyRow = receivingItem.SelectedProduct == null;
                var isDisabled = IsReadOnly || 
                                (!DetailLockHelper.CanDeleteItem(receivingItem.ExistingDetailEntity, out _, 
                                    checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities) && !isEmptyRow);
                
                if (isDisabled)
                {
                    var displayText = receivingItem.SelectedWarehouseLocation?.Name ?? "æœªé¸æ“‡";
                    return @<span class="text-muted">@displayText</span>;
                }
                
                return @<select class="form-select form-select-sm"
                               value="@selectedLocationId"
                               @onchange="(e) => OnWarehouseLocationChange(receivingItem, e.Value?.ToString())">
                    <option value="">è«‹é¸æ“‡</option>
                    @foreach (var location in availableLocations)
                    {
                        <option value="@location.Id">@location.Name</option>
                    }
                </select>;
            }
        });
        
        // 10. å‚™è¨»
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å‚™è¨»",
            PropertyName = "Remarks",
            ColumnType = InteractiveColumnType.Input,
            Width = "150px",
            HideOnMobile = true,
            ExcludeFromEmptyCheck = true,  // å‚™è¨»ä¸åƒèˆ‡ç©ºè¡Œæª¢æŸ¥
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                await OnRemarksChange((ReceivingItem)args.Item1, args.Item2);
            })
        });
        
        return columns;
    }
    
    // ===== äº‹ä»¶è™•ç† =====
    
    // å•†å“æœå°‹
    private Task OnProductSearch(ReceivingItem item, string? searchValue)
    {
        item.ProductSearchValue = searchValue ?? string.Empty;
        
        var combinedItems = new List<object>();
        
        if (!string.IsNullOrWhiteSpace(searchValue))
        {
            // 1. æœå°‹æ¡è³¼æ˜ç´°ï¼ˆå„ªå…ˆé¡¯ç¤ºï¼‰
            var filteredDetails = AvailablePurchaseDetails
                .Where(d =>
                    (d.PurchaseOrder?.Code != null && d.PurchaseOrder.Code.Contains(searchValue, StringComparison.OrdinalIgnoreCase)) ||
                    (d.Product?.Code != null && d.Product.Code.Contains(searchValue, StringComparison.OrdinalIgnoreCase)) ||
                    (d.Product?.Name != null && d.Product.Name.Contains(searchValue, StringComparison.OrdinalIgnoreCase)))
                .Take(10)
                .ToList();
            
            // 2. æœå°‹ä¸€èˆ¬å•†å“
            var filteredProducts = AvailableProducts
                .Where(p =>
                    (p.Code != null && p.Code.Contains(searchValue, StringComparison.OrdinalIgnoreCase)) ||
                    (p.Name != null && p.Name.Contains(searchValue, StringComparison.OrdinalIgnoreCase)))
                .Take(10)
                .ToList();
            
            combinedItems.AddRange(filteredDetails.Cast<object>());
            combinedItems.AddRange(filteredProducts.Cast<object>());
        }
        else
        {
            // æ²’æœ‰æœå°‹æ¢ä»¶æ™‚ï¼Œå„ªå…ˆé¡¯ç¤ºæ¡è³¼æ˜ç´°ï¼Œç„¶å¾Œæ˜¯ä¸€èˆ¬å•†å“
            var topDetails = AvailablePurchaseDetails.Take(10).ToList();
            var topProducts = AvailableProducts.Take(10).ToList();
            
            combinedItems.AddRange(topDetails.Cast<object>());
            combinedItems.AddRange(topProducts.Cast<object>());
        }
        
        item.FilteredItems = combinedItems;
        item.ShowDropdown = true;
        item.SelectedIndex = -1;
        
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    private void OnProductFocus(ReceivingItem item)
    {
        _ = OnProductSearch(item, item.ProductSearchValue);
    }
    
    private void OnProductBlur(ReceivingItem item)
    {
        Task.Delay(200).ContinueWith(_ =>
        {
            item.ShowDropdown = false;
            InvokeAsync(StateHasChanged);
        });
    }
    
    // å•†å“é¸æ“‡
    private async Task OnProductSelect(ReceivingItem item, object? selectedItem)
    {
        if (selectedItem is PurchaseOrderDetail detail)
        {
            // é¸æ“‡æ¡è³¼æ˜ç´°
            item.SelectedPurchaseDetail = detail;
            item.SelectedProduct = detail.Product;
            item.ProductSearchValue = FormatPurchaseDetailDisplay(detail);
            item.OrderQuantity = detail.OrderQuantity;
            item.ReceivedQuantity = detail.PendingQuantity; // é è¨­å¡«å…¥å¾…é€²è²¨æ•¸é‡
            item.UnitPrice = detail.UnitPrice;
            item.TaxRate = detail.TaxRate ?? detail.Product?.TaxRate ?? await SystemParameterService.GetTaxRateAsync();
        }
        else if (selectedItem is Product product)
        {
            // é¸æ“‡ä¸€èˆ¬å•†å“
            item.SelectedPurchaseDetail = null;
            item.SelectedProduct = product;
            item.ProductSearchValue = FormatProductDisplay(product);
            item.OrderQuantity = 0;
            item.ReceivedQuantity = 0;
            item.UnitPrice = 0; // éœ€æ‰‹å‹•è¼¸å…¥å–®åƒ¹
            item.TaxRate = product.TaxRate ?? await SystemParameterService.GetTaxRateAsync();
        }
        else
        {
            item.SelectedPurchaseDetail = null;
            item.SelectedProduct = null;
            item.ProductSearchValue = string.Empty;
        }
        
        item.ShowDropdown = false;
        item.SelectedIndex = -1;
        await NotifyChange();
    }
    
    // æ•¸é‡è®Šæ›´
    private async Task OnQuantityChange(ReceivingItem item, string? value)
    {
        item.ReceivedQuantity = InputEventHelper.HandleIntegerInput(value);
        await NotifyChange();
    }
    
    // å–®åƒ¹è®Šæ›´
    private async Task OnPriceChange(ReceivingItem item, string? value)
    {
        item.UnitPrice = InputEventHelper.HandlePriceInput(value);
        await NotifyChange();
    }
    
    // ç¨…ç‡è®Šæ›´
    private async Task OnTaxRateChange(ReceivingItem item, string? value)
    {
        item.TaxRate = InputEventHelper.HandlePercentageInput(value);
        await NotifyChange();
    }
    
    // å€‰åº«è®Šæ›´
    private async Task OnWarehouseChange(ReceivingItem item, string? warehouseIdStr)
    {
        if (int.TryParse(warehouseIdStr, out var warehouseId))
        {
            item.SelectedWarehouse = Warehouses.FirstOrDefault(w => w.Id == warehouseId);
        }
        else
        {
            item.SelectedWarehouse = null;
        }
        
        // æ¸…ç©ºåº«ä½
        item.SelectedWarehouseLocation = null;
        await NotifyChange();
    }
    
    // åº«ä½è®Šæ›´
    private async Task OnWarehouseLocationChange(ReceivingItem item, string? locationIdStr)
    {
        if (int.TryParse(locationIdStr, out var locationId))
        {
            item.SelectedWarehouseLocation = WarehouseLocations.FirstOrDefault(wl => wl.Id == locationId);
        }
        else
        {
            item.SelectedWarehouseLocation = null;
        }
        await NotifyChange();
    }
    
    // å‚™è¨»è®Šæ›´
    private async Task OnRemarksChange(ReceivingItem item, string? value)
    {
        item.Remarks = InputEventHelper.HandleTextInput(value);
        await NotifyChange();
    }
    
    // åˆªé™¤é …ç›®
    private async Task HandleItemDelete(ReceivingItem item)
    {
        // å¦‚æœæ˜¯ç¾æœ‰æ˜ç´°ï¼Œè¨˜éŒ„å…¶IDä»¥ä¾¿å¾ŒçºŒåˆªé™¤
        if (item.ExistingDetailEntity != null)
        {
            var detailId = GetPropertyValue<int>(item.ExistingDetailEntity, "Id");
            if (detailId > 0 && !_deletedDetailIds.Contains(detailId))
            {
                _deletedDetailIds.Add(detailId);
                await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds);
            }
        }
        
        ReceivingItems.Remove(item);
        await NotifyChange();
    }
    
    // ===== è‡ªè¨‚æ“ä½œæŒ‰éˆ•æ¨¡æ¿ =====
    private RenderFragment<ReceivingItem> GetCustomActionsTemplate => item => __builder =>
    {
        // ä½¿ç”¨ DetailLockHelper æª¢æŸ¥æ˜¯å¦å¯ä»¥åˆªé™¤ï¼ˆéœ€å‚³å…¥é€€è²¨æ•¸é‡å­—å…¸ï¼‰
        if (DetailLockHelper.CanDeleteItem(item.ExistingDetailEntity, out _, 
            checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities))
        {
            // å¯ä»¥åˆªé™¤ï¼šé¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Red"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="@IsReadOnly"
                                   Title="åˆªé™¤"
                                   OnClick="async () => await HandleItemDelete(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else
        {
            // å·²è¢«ä½¿ç”¨ï¼šé¡¯ç¤ºæŸ¥çœ‹æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Blue"
                                   IconClass="bi bi-eye text-white"
                                   Size="ButtonSize.Large"
                                   Title="æŸ¥çœ‹ç›¸é—œå–®æ“š"
                                   OnClick="async () => await ShowRelatedDocuments(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
    };
    
    // ===== è¼”åŠ©æ–¹æ³• =====
    
    // è¼‰å…¥å•†å“æ¸…å–®
    private async Task LoadProductsAsync()
    {
        if (SelectedSupplierId.HasValue && SelectedSupplierId.Value > 0)
        {
            // 1. è¼‰å…¥æ¡è³¼æ˜ç´°ï¼ˆæœªå®Œæˆé€²è²¨çš„ï¼Œä¸æª¢æŸ¥å¯©æ ¸ç‹€æ…‹ï¼‰
            var allPurchaseDetails = await PurchaseOrderService.GetReceivingDetailsBySupplierAsync(
                SelectedSupplierId.Value,
                includeCompleted: false,
                checkApproval: false);
            
            // æ ¹æ“š SelectedPurchaseOrderId ç¯©é¸æ¡è³¼æ˜ç´°
            if (SelectedPurchaseOrderId.HasValue && SelectedPurchaseOrderId.Value > 0)
            {
                AvailablePurchaseDetails = allPurchaseDetails
                    .Where(d => d.PurchaseOrderId == SelectedPurchaseOrderId.Value)
                    .ToList();
            }
            else
            {
                AvailablePurchaseDetails = allPurchaseDetails;
            }
            
            // æ ¹æ“š FilterProductId é€²ä¸€æ­¥ç¯©é¸æ¡è³¼æ˜ç´°
            if (FilterProductId.HasValue && FilterProductId.Value > 0)
            {
                AvailablePurchaseDetails = AvailablePurchaseDetails
                    .Where(d => d.ProductId == FilterProductId.Value)
                    .ToList();
            }
            
            // 2. è¼‰å…¥æ‰€æœ‰å•Ÿç”¨çš„å¤–è³¼å•†å“ï¼ˆè‡ªè£½å•†å“ç”±ç”Ÿç”¢æ’ç¨‹ç”¢ç”Ÿï¼Œä¸éœ€è¦æ¡è³¼é€²è²¨ï¼‰
            var allProducts = await ProductService.GetActiveProductsAsync();
            AvailableProducts = allProducts
                .Where(p => p.ProcurementType == ProcurementType.Purchased)
                .ToList();
            
            // æ ¹æ“š FilterProductId ç¯©é¸å•†å“
            if (FilterProductId.HasValue && FilterProductId.Value > 0)
            {
                AvailableProducts = AvailableProducts
                    .Where(p => p.Id == FilterProductId.Value)
                    .ToList();
            }
        }
        else
        {
            AvailablePurchaseDetails = new List<PurchaseOrderDetail>();
            AvailableProducts = new List<Product>();
        }
    }
    
    // è¼‰å…¥ç¾æœ‰æ˜ç´°
    private async Task LoadExistingDetailsAsync()
    {
        if (ExistingDetails?.Any() != true)
        {
            return;
        }
        
        _dataLoadCompleted = false;
        ReceivingItems.Clear();
        _deletedDetailIds.Clear(); // æ¸…ç©ºå·²åˆªé™¤IDåˆ—è¡¨
        
        foreach (var detail in ExistingDetails)
        {
            if (detail is PurchaseReceivingDetail purchaseDetail)
            {
                var item = new ReceivingItem
                {
                    SelectedPurchaseDetail = purchaseDetail.PurchaseOrderDetail,
                    SelectedProduct = purchaseDetail.Product,
                    ProductSearchValue = purchaseDetail.PurchaseOrderDetail != null 
                        ? FormatPurchaseDetailDisplay(purchaseDetail.PurchaseOrderDetail)
                        : (purchaseDetail.Product != null ? FormatProductDisplay(purchaseDetail.Product) : ""),
                    OrderQuantity = purchaseDetail.OrderQuantity,
                    ReceivedQuantity = purchaseDetail.ReceivedQuantity,
                    TotalReturnedQuantity = purchaseDetail.TotalReturnedQuantity, // ğŸ”¥ è¼‰å…¥ç´¯è¨ˆé€€è²¨æ•¸é‡
                    UnitPrice = purchaseDetail.UnitPrice,
                    TaxRate = purchaseDetail.TaxRate ?? await SystemParameterService.GetTaxRateAsync(),
                    SelectedWarehouse = purchaseDetail.Warehouse,
                    SelectedWarehouseLocation = purchaseDetail.WarehouseLocation,
                    Remarks = purchaseDetail.Remarks ?? "",
                    ExistingDetailEntity = detail
                };
                
                ReceivingItems.Add(item);
            }
        }
        
        // è¼‰å…¥é€€è²¨æ•¸é‡ï¼ˆç”¨æ–¼é–å®šæª¢æŸ¥ï¼‰
        await LoadReturnedQuantitiesAsync();
        
        // ğŸ”¥ é—œéµï¼šè¼‰å…¥å¾Œç«‹å³æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
        bool hasUndeletableDetails = ReceivingItems.Any(item => 
            item.ExistingDetailEntity != null && 
            !DetailLockHelper.CanDeleteItem(item.ExistingDetailEntity, out _, 
                checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities));
        if (_hasUndeletableDetails != hasUndeletableDetails)
        {
            _hasUndeletableDetails = hasUndeletableDetails;
        }
        
        _dataLoadCompleted = true;
        StateHasChanged();
    }
    
    // è¨ˆç®—å°è¨ˆ
    private decimal CalculateSubtotal(ReceivingItem item)
    {
        if (item.ReceivedQuantity <= 0 || item.UnitPrice <= 0)
            return 0;
        
        var baseAmount = item.ReceivedQuantity * item.UnitPrice;
        
        return TaxCalculationMethod switch
        {
            TaxCalculationMethod.TaxExclusive => Math.Round(baseAmount * (1 + item.TaxRate / 100), 0),
            TaxCalculationMethod.TaxInclusive => Math.Round(baseAmount, 0),
            TaxCalculationMethod.NoTax => Math.Round(baseAmount, 0),
            _ => Math.Round(baseAmount, 0)
        };
    }
    
    // æ ¼å¼åŒ–æ¡è³¼æ˜ç´°é¡¯ç¤º
    private string FormatPurchaseDetailDisplay(PurchaseOrderDetail detail)
    {
        if (detail?.Product == null) return "";
        
        var purchaseOrderNumber = detail.PurchaseOrder?.Code ?? "N/A";
        var productCode = detail.Product.Code ?? "";
        var productName = detail.Product.Name ?? "";
        
        if (!string.IsNullOrEmpty(productCode) && !string.IsNullOrEmpty(productName))
            return $"[{purchaseOrderNumber}] [{productCode}] {productName}";
        
        return $"[{purchaseOrderNumber}] {productCode}{productName}";
    }
    
    // æ ¼å¼åŒ–å•†å“é¡¯ç¤º
    private string FormatProductDisplay(Product product)
    {
        if (product == null) return "";
        
        if (!string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name))
            return $"[{product.Code}] {product.Name}";
        
        return product.Code ?? product.Name ?? "";
    }
    
    // è½‰æ›ç‚ºå¯¦é«”æ¸…å–®
    private List<TDetailEntity> ConvertToEntities()
    {
        var entities = new List<TDetailEntity>();
        
        // åªè½‰æ›æœ‰é¸æ“‡å•†å“çš„é …ç›®ï¼ˆæ’é™¤ç©ºè¡Œï¼‰
        foreach (var item in ReceivingItems.Where(x => x.SelectedProduct != null))
        {
            
            TDetailEntity entity;
            
            if (item.ExistingDetailEntity != null)
            {
                entity = item.ExistingDetailEntity;
            }
            else
            {
                entity = new TDetailEntity();
                
                // è¨­å®šä¸»æª”IDï¼ˆæ–°å¢æ˜ç´°æ™‚éœ€è¦ï¼‰
                if (MainEntity != null && !string.IsNullOrEmpty(MainEntityIdPropertyName))
                {
                    SetPropertyValue(entity, MainEntityIdPropertyName, MainEntity.Id);
                }
            }
            
            // ç„¡è«–æ˜¯æ–°å¢æˆ–ç·¨è¼¯ï¼Œéƒ½è¦æ›´æ–° ProductIdï¼ˆå…è¨±æ›´æ›å•†å“ï¼‰
            if (item.SelectedProduct != null)
            {
                SetPropertyValue(entity, "ProductId", item.SelectedProduct.Id);
            }
            
            // è¨­å®šæ•¸é‡ç›¸é—œæ¬„ä½
            SetPropertyValue(entity, QuantityPropertyName, item.ReceivedQuantity);
            SetPropertyValue(entity, "OrderQuantity", item.OrderQuantity > 0 ? item.OrderQuantity : item.ReceivedQuantity);
            SetPropertyValue(entity, UnitPricePropertyName, item.UnitPrice);
            SetPropertyValue(entity, "TaxRate", item.TaxRate);
            SetPropertyValue(entity, RemarksPropertyName, item.Remarks);
            
            // ä¿å­˜æ¡è³¼æ˜ç´°é—œè¯ï¼ˆæ”¯æ´ç„¡æ¡è³¼å–®ï¼šåªæœ‰åœ¨æœ‰æ¡è³¼å–®æ™‚æ‰è¨­å®šï¼‰
            if (!string.IsNullOrEmpty(PurchaseOrderDetailIdPropertyName))
            {
                int? purchaseOrderDetailId = item.SelectedPurchaseDetail != null ? (int?)item.SelectedPurchaseDetail.Id : null;
                SetPropertyValue(entity, PurchaseOrderDetailIdPropertyName, purchaseOrderDetailId);
            }
            
            // è¨­å®šå€‰åº«ç›¸é—œæ¬„ä½
            if (!string.IsNullOrEmpty(WarehouseIdPropertyName) && item.SelectedWarehouse != null)
            {
                SetPropertyValue(entity, WarehouseIdPropertyName, item.SelectedWarehouse.Id);
            }
            
            if (!string.IsNullOrEmpty(WarehouseLocationIdPropertyName) && item.SelectedWarehouseLocation != null)
            {
                SetPropertyValue(entity, WarehouseLocationIdPropertyName, item.SelectedWarehouseLocation.Id);
            }
            
            entities.Add(entity);
        }
        
        return entities;
    }
    
    // é€šçŸ¥è®Šæ›´
    private async Task NotifyChange()
    {
        var entities = ConvertToEntities();
        await DetailSyncHelper.SyncToParentAsync(entities, OnDetailsChanged);
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼‰
        bool hasUndeletableDetails = ReceivingItems.Any(item => 
            item.ExistingDetailEntity != null && 
            !DetailLockHelper.CanDeleteItem(item.ExistingDetailEntity, out _, 
                checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities));
        
        // ç‹€æ…‹è®Šæ›´æ™‚æ‰é€šçŸ¥çˆ¶çµ„ä»¶ä¸¦è§¸ç™¼ UI æ›´æ–°
        if (_hasUndeletableDetails != hasUndeletableDetails)
        {
            _hasUndeletableDetails = hasUndeletableDetails;
            await OnHasUndeletableDetailsChanged.InvokeAsync(hasUndeletableDetails);
            
            // ğŸ”¥ é—œéµï¼šç‹€æ…‹è®Šæ›´å¾Œï¼Œç«‹å³åˆ·æ–°ç©ºè¡Œï¼ˆç§»é™¤æˆ–æ–°å¢ï¼‰
            tableComponent?.RefreshEmptyRow();
            
            StateHasChanged();  // è§¸ç™¼ UI æ›´æ–°ï¼Œè®“ AllowAddNewRow åƒæ•¸ç”Ÿæ•ˆ
        }
    }
    
    /// <summary>
    /// ä½¿ç”¨åå°„å–å¾—å±¬æ€§å€¼
    /// </summary>
    private T? GetPropertyValue<T>(object obj, string propertyName)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property == null) return default(T);
        
        var value = property.GetValue(obj);
        if (value == null) return default(T);
        
        if (typeof(T) == typeof(object)) return (T)value;
        
        // è™•ç† nullable é¡å‹çš„è½‰æ›
        var targetType = typeof(T);
        
        // å¦‚æœç›®æ¨™é¡å‹æ˜¯ nullableï¼Œå–å¾—å…¶åº•å±¤é¡å‹
        if (targetType.IsGenericType && targetType.GetGenericTypeDefinition() == typeof(Nullable<>))
        {
            var underlyingType = Nullable.GetUnderlyingType(targetType);
            if (underlyingType != null)
            {
                targetType = underlyingType;
            }
        }
        
        return (T)Convert.ChangeType(value, targetType);
    }
    
    /// <summary>
    /// ä½¿ç”¨åå°„è¨­å®šå±¬æ€§å€¼
    /// </summary>
    private void SetPropertyValue(object obj, string propertyName, object? value)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property != null && property.CanWrite)
        {
            try
            {
                if (value == null)
                {
                    property.SetValue(obj, null);
                }
                else if (property.PropertyType == value.GetType())
                {
                    property.SetValue(obj, value);
                }
                else
                {
                    // è™•ç† Nullable é¡å‹çš„è½‰æ›
                    var targetType = property.PropertyType;
                    
                    // å¦‚æœç›®æ¨™é¡å‹æ˜¯ nullableï¼Œå–å¾—å…¶åº•å±¤é¡å‹
                    if (targetType.IsGenericType && targetType.GetGenericTypeDefinition() == typeof(Nullable<>))
                    {
                        var underlyingType = Nullable.GetUnderlyingType(targetType);
                        if (underlyingType != null)
                        {
                            targetType = underlyingType;
                        }
                    }
                    
                    var convertedValue = Convert.ChangeType(value, targetType);
                    property.SetValue(obj, convertedValue);
                }
            }
            catch
            {
                // å¿½ç•¥è½‰æ›éŒ¯èª¤
            }
        }
    }
    
    // ===== å…¬é–‹æ–¹æ³• =====
    
    /// <summary>
    /// åˆ·æ–°æ˜ç´°ï¼ˆä¾›çˆ¶çµ„ä»¶å‘¼å«ï¼‰
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadExistingDetailsAsync();
        // LoadExistingDetailsAsync å…§éƒ¨å·²ç¶“æœƒå‘¼å« LoadReturnedQuantitiesAsync
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }
    
    /// <summary>
    /// é©—è­‰æ˜ç´°è³‡æ–™ï¼ˆä¾›çˆ¶çµ„ä»¶å‘¼å«ï¼‰
    /// </summary>
    public async Task<bool> ValidateAsync()
    {
        // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„æ˜ç´°
        var validItems = ReceivingItems.Where(x => x.SelectedProduct != null && x.ReceivedQuantity > 0).ToList();
        
        if (!validItems.Any())
        {
            await NotificationService.ShowWarningAsync("è«‹è‡³å°‘æ–°å¢ä¸€ç­†å•†å“æ˜ç´°");
            return false;
        }
        
        // æª¢æŸ¥æ¯ç­†æ˜ç´°æ˜¯å¦éƒ½æœ‰é¸æ“‡å€‰åº«
        var itemsWithoutWarehouse = validItems.Where(x => x.SelectedWarehouse == null).ToList();
        if (itemsWithoutWarehouse.Any())
        {
            var productNames = string.Join("ã€", itemsWithoutWarehouse.Select(x => x.SelectedProduct?.Name ?? "æœªçŸ¥å•†å“"));
            await NotificationService.ShowWarningAsync($"ä»¥ä¸‹å•†å“å°šæœªé¸æ“‡å€‰åº«ï¼š{productNames}");
            return false;
        }

        return true;
    }
    
    /// <summary>
    /// è¼‰å…¥é€€è²¨æ•¸é‡ - å¾é€²è²¨æ˜ç´°çš„ TotalReturnedQuantity æ¬„ä½ç›´æ¥è®€å–
    /// ğŸ”¥ ç°¡åŒ–ç‰ˆï¼šä¸å†éœ€è¦æŸ¥è©¢ PurchaseReturnDetail è¡¨ï¼Œç›´æ¥å¾ Entity è®€å–
    /// </summary>
    public async Task LoadReturnedQuantitiesAsync()
    {
        try
        {
            _returnedQuantities.Clear();
            
            // åªè™•ç†å·²å„²å­˜çš„æ˜ç´°ï¼ˆæœ‰IDçš„ï¼‰
            var items = ReceivingItems
                .Where(item => item.ExistingDetailEntity != null)
                .ToList();
            
            if (!items.Any())
            {
                return;
            }
            
            // ç›´æ¥å¾ ReceivingItem çš„ TotalReturnedQuantity å±¬æ€§è®€å–
            // é€™å€‹å€¼å·²ç¶“åœ¨ LoadExistingDetailsAsync ä¸­å¾ Entity è¼‰å…¥
            foreach (var item in items)
            {
                var detailId = GetPropertyValue<int>(item.ExistingDetailEntity!, "Id");
                if (detailId > 0 && item.TotalReturnedQuantity > 0)
                {
                    _returnedQuantities[detailId] = item.TotalReturnedQuantity;
                }
            }
            
            await Task.CompletedTask; // ä¿æŒéåŒæ­¥ç°½ç« ï¼Œä½†å¯¦éš›ä¸Šä¸éœ€è¦æŸ¥è©¢
        }
        catch (Exception)
        {
            // ç™¼ç”ŸéŒ¯èª¤æ™‚æ¸…ç©ºå­—å…¸ï¼Œé¿å…é¡¯ç¤ºéŒ¯èª¤çš„é–å®šç‹€æ…‹
            _returnedQuantities.Clear();
        }
    }
    
    /// <summary>
    /// è¼‰å…¥æ‰€æœ‰æœªå…¥åº«é …ç›® - å¾é¸å®šçš„æ¡è³¼å–®è¼‰å…¥æœªå®Œæˆé€²è²¨çš„æ˜ç´°
    /// </summary>
    public async Task LoadAllUnreceivedItems()
    {
        try
        {
            // æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡æ¡è³¼å–®
            if (!SelectedPurchaseOrderId.HasValue || SelectedPurchaseOrderId.Value <= 0)
            {
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡å» å•†
            if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
            {
                return;
            }
            
            _dataLoadCompleted = false;
            ReceivingItems.Clear();
            _deletedDetailIds.Clear();
            
            // è¼‰å…¥æ¡è³¼å–®è³‡æ–™ï¼ˆåŒ…å«Codeï¼‰
            var purchaseOrder = await PurchaseOrderService.GetByIdAsync(SelectedPurchaseOrderId.Value);
            if (purchaseOrder == null)
            {
                await NotificationService.ShowErrorAsync("æ‰¾ä¸åˆ°æŒ‡å®šçš„æ¡è³¼å–®");
                _dataLoadCompleted = true;
                StateHasChanged();
                return;
            }
            
            // å¾æ¡è³¼å–®æœå‹™å–å¾—æ‰€æœ‰æ˜ç´°
            var purchaseOrderDetails = await PurchaseOrderService.GetOrderDetailsAsync(SelectedPurchaseOrderId.Value);
            
            if (purchaseOrderDetails?.Any() != true)
            {
                _dataLoadCompleted = true;
                StateHasChanged();
                return;
            }
            
            // æ‰‹å‹•è¨­å®šæ¯å€‹æ˜ç´°çš„ PurchaseOrder åƒç…§ï¼Œç¢ºä¿æ¡è³¼å–®è™Ÿèƒ½æ­£ç¢ºé¡¯ç¤º
            foreach (var detail in purchaseOrderDetails)
            {
                detail.PurchaseOrder = purchaseOrder;
            }
            
            // åªè¼‰å…¥æœ‰å¾…é€²è²¨æ•¸é‡çš„æ˜ç´°ï¼ˆå¾…é€²è²¨æ•¸é‡ > 0ï¼‰
            var unreceivedDetails = purchaseOrderDetails
                .Where(d => d.OrderQuantity - d.ReceivedQuantity > 0)
                .ToList();
            
            if (!unreceivedDetails.Any())
            {
                await NotificationService.ShowInfoAsync("æ­¤æ¡è³¼å–®çš„æ‰€æœ‰æ˜ç´°éƒ½å·²å®Œæˆé€²è²¨");
                _dataLoadCompleted = true;
                StateHasChanged();
                return;
            }
            
            // å–å¾—ç³»çµ±é è¨­ç¨…ç‡
            var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();
            
            // è½‰æ›ç‚º ReceivingItem
            foreach (var detail in unreceivedDetails)
            {
                var item = new ReceivingItem
                {
                    SelectedPurchaseDetail = detail,
                    SelectedProduct = detail.Product,
                    ProductSearchValue = FormatPurchaseDetailDisplay(detail),
                    OrderQuantity = detail.OrderQuantity,
                    ReceivedQuantity = detail.OrderQuantity - detail.ReceivedQuantity, // é è¨­å¡«å…¥å¾…é€²è²¨æ•¸é‡
                    UnitPrice = detail.UnitPrice,
                    TaxRate = detail.TaxRate ?? detail.Product?.TaxRate ?? defaultTaxRate,
                    Remarks = detail.Remarks ?? ""
                };
                
                ReceivingItems.Add(item);
            }
            
            _dataLoadCompleted = true;
            
            // é€šçŸ¥çˆ¶çµ„ä»¶æ˜ç´°å·²è®Šæ›´
            await NotifyChange();
            
            StateHasChanged();
            
            await NotificationService.ShowSuccessAsync($"å·²è¼‰å…¥ {unreceivedDetails.Count} ç­†å¾…é€²è²¨æ˜ç´°");
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥æœªé€²è²¨æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            _dataLoadCompleted = true;
        }
    }
    
    // ===== æŒ‰éˆ•åŠŸèƒ½æ–¹æ³• =====
    
    /// <summary>
    /// è¨ˆç®—å±¬æ€§ï¼šæ˜¯å¦å¯ä»¥ä½¿ç”¨æ™ºèƒ½ä¸‹å–®ï¼ˆè®€å–æ­·å²å…¥åº«è¨˜éŒ„ï¼‰
    /// </summary>
    private bool CanUseSmartLoad => 
        SelectedSupplierId.HasValue && 
        SelectedSupplierId.Value > 0 &&
        !IsReadOnly;
    
    /// <summary>
    /// å–å¾—æ™ºèƒ½ä¸‹å–®æŒ‰éˆ•çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetSmartLoadTooltip()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
            return "è«‹å…ˆé¸æ“‡å» å•†";
        
        if (IsReadOnly)
            return "å”¯è®€æ¨¡å¼ç„¡æ³•ä½¿ç”¨";
        
        if (_hasUndeletableDetails)
            return "éƒ¨åˆ†æ˜ç´°å·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ä½¿ç”¨æ™ºèƒ½ä¸‹å–®";
        
        return "è¼‰å…¥è©²å» å•†æœ€å¾Œä¸€æ¬¡å…¥åº«è¨˜éŒ„ä½œç‚ºåƒè€ƒ";
    }
    
    /// <summary>
    /// è¨ˆç®—å±¬æ€§ï¼šæ˜¯å¦å¯ä»¥ä½¿ç”¨è¼‰å…¥æ¡è³¼ï¼ˆè¼‰å…¥ç‰¹å®šæ¡è³¼å–®çš„å¾…é€²è²¨æ˜ç´°ï¼‰
    /// </summary>
    private bool CanLoadPurchaseOrder => 
        SelectedSupplierId.HasValue && 
        SelectedSupplierId.Value > 0 &&
        SelectedPurchaseOrderId.HasValue &&
        SelectedPurchaseOrderId.Value > 0 &&
        !IsReadOnly;
    
    /// <summary>
    /// å–å¾—è¼‰å…¥æ¡è³¼æŒ‰éˆ•çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetLoadPurchaseOrderTooltip()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
            return "è«‹å…ˆé¸æ“‡å» å•†";
        
        if (!SelectedPurchaseOrderId.HasValue || SelectedPurchaseOrderId.Value <= 0)
            return "è«‹å…ˆé¸æ“‡æ¡è³¼å–®";
        
        if (IsReadOnly)
            return "å”¯è®€æ¨¡å¼ç„¡æ³•ä½¿ç”¨";
        
        if (_hasUndeletableDetails)
            return "éƒ¨åˆ†æ˜ç´°å·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•è¼‰å…¥æ¡è³¼";
        
        return "è¼‰å…¥è©²æ¡è³¼å–®çš„å¾…é€²è²¨æ˜ç´°";
    }
    
    /// <summary>
    /// è¨ˆç®—å±¬æ€§ï¼šæ˜¯å¦æœ‰å…¥åº«æ˜ç´°é …ç›®
    /// </summary>
    private bool HasReceivingItems =>
        ReceivingItems.Any(item => item.SelectedProduct != null);
    
    /// <summary>
    /// å–å¾—å€‰åº«çµ±ä¸€æŒ‰éˆ•çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetUnifyWarehouseTooltip()
    {
        if (!HasReceivingItems)
            return "ç›®å‰ç„¡æ˜ç´°å¯è¨­å®š";
        
        if (IsReadOnly)
            return "å”¯è®€æ¨¡å¼ç„¡æ³•ä½¿ç”¨";
        
        if (_hasUndeletableDetails)
            return "éƒ¨åˆ†æ˜ç´°å·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•çµ±ä¸€è¨­å®šå€‰åº«";
        
        return "çµ±ä¸€è¨­å®šæ‰€æœ‰æ˜ç´°çš„å€‰åº«";
    }
    
    /// <summary>
    /// å–å¾—æ¸…é™¤æ˜ç´°æŒ‰éˆ•çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetClearDetailsTooltip()
    {
        if (!HasReceivingItems)
            return "ç›®å‰ç„¡æ˜ç´°å¯æ¸…é™¤";
        
        if (IsReadOnly)
            return "å”¯è®€æ¨¡å¼ç„¡æ³•ä½¿ç”¨";
        
        if (_hasUndeletableDetails)
            return "éƒ¨åˆ†æ˜ç´°å·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•æ¸…é™¤æ˜ç´°";
        
        return "æ¸…ç©ºæ‰€æœ‰å…¥åº«æ˜ç´°";
    }
    
    /// <summary>
    /// æ™ºèƒ½ä¸‹å–® - è¼‰å…¥è©²å» å•†æœ€å¾Œä¸€æ¬¡å…¥åº«è¨˜éŒ„
    /// </summary>
    private async Task SmartLoadReceivingDetails()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
        {
            await NotificationService.ShowWarningAsync("è«‹å…ˆé¸æ“‡å» å•†");
            return;
        }
        
        try
        {
            // å¦‚æœç›®å‰æœ‰æ˜ç´°ï¼Œå…ˆè©¢å•æ˜¯å¦æ¸…é™¤
            if (ReceivingItems.Any(item => item.SelectedProduct != null))
            {
                var confirmed = await NotificationService.ShowConfirmAsync(
                    "æ­¤æ“ä½œæœƒæ¸…é™¤ç›®å‰çš„å…¥åº«æ˜ç´°ä¸¦è¼‰å…¥æ­·å²è¨˜éŒ„ï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ",
                    "æ™ºèƒ½ä¸‹å–®ç¢ºèª");
                
                if (!confirmed)
                {
                    return;
                }
            }
            
            _dataLoadCompleted = false;
            ReceivingItems.Clear();
            _deletedDetailIds.Clear();
            StateHasChanged();
            
            // å¾æœå‹™ç²å–å» å•†çš„æœ€è¿‘ä¸€æ¬¡å®Œæ•´å…¥åº«è¨˜éŒ„
            var lastReceivingDetails = await PurchaseReceivingDetailService.GetLastCompleteReceivingAsync(SelectedSupplierId.Value);
            
            if (!lastReceivingDetails.Any())
            {
                await NotificationService.ShowInfoAsync("è©²å» å•†æ²’æœ‰å…¥åº«æ­·å²ç´€éŒ„å¯åƒè€ƒ");
                _dataLoadCompleted = true;
                StateHasChanged();
                return;
            }
            
            // å–å¾—ç³»çµ±é è¨­ç¨…ç‡
            var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();
            
            // å°‡æ­·å²å…¥åº«è½‰æ›ç‚ºæ–°çš„å…¥åº«é …ç›®
            foreach (var detail in lastReceivingDetails)
            {
                if (detail.Product == null) continue; // è·³éæ²’æœ‰å•†å“çš„æ˜ç´°
                
                var item = new ReceivingItem
                {
                    SelectedPurchaseDetail = null, // æ™ºèƒ½ä¸‹å–®ä¸é—œè¯æ¡è³¼æ˜ç´°
                    SelectedProduct = detail.Product,
                    ProductSearchValue = FormatProductDisplay(detail.Product),
                    OrderQuantity = 0, // æ™ºèƒ½ä¸‹å–®æ²’æœ‰æ¡è³¼æ•¸é‡
                    ReceivedQuantity = detail.ReceivedQuantity, // åƒè€ƒä¸Šæ¬¡çš„å…¥åº«æ•¸é‡
                    UnitPrice = detail.UnitPrice,
                    TaxRate = detail.TaxRate ?? detail.Product?.TaxRate ?? defaultTaxRate,
                    SelectedWarehouse = detail.Warehouse,
                    SelectedWarehouseLocation = detail.WarehouseLocation,
                    Remarks = detail.Remarks ?? ""
                };
                
                ReceivingItems.Add(item);
            }
            
            _dataLoadCompleted = true;
            
            // é€šçŸ¥çˆ¶çµ„ä»¶æ˜ç´°å·²è®Šæ›´
            await NotifyChange();
            
            tableComponent?.RefreshEmptyRow();
            StateHasChanged();
            
            await NotificationService.ShowSuccessAsync($"å·²è¼‰å…¥ {lastReceivingDetails.Count} é …å•†å“ä½œç‚ºåƒè€ƒ");
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æ™ºèƒ½ä¸‹å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            _dataLoadCompleted = true;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// çµ±ä¸€è¨­å®šæ‰€æœ‰æ˜ç´°çš„å€‰åº«
    /// </summary>
    private async Task UnifyWarehouse(int warehouseId)
    {
        var warehouse = Warehouses.FirstOrDefault(w => w.Id == warehouseId);
        if (warehouse == null)
        {
            await NotificationService.ShowErrorAsync("æ‰¾ä¸åˆ°æŒ‡å®šçš„å€‰åº«");
            return;
        }
        
        // åªæ›´æ–°æœ‰é¸æ“‡å•†å“çš„é …ç›®
        var validItems = ReceivingItems.Where(item => item.SelectedProduct != null).ToList();
        
        if (!validItems.Any())
        {
            await NotificationService.ShowWarningAsync("ç›®å‰æ²’æœ‰å¯è¨­å®šçš„æ˜ç´°");
            return;
        }
        
        // åˆ†é›¢å¯ä¿®æ”¹å’Œä¸å¯ä¿®æ”¹çš„æ˜ç´°
        var modifiableItems = new List<ReceivingItem>();
        var lockedItems = new List<ReceivingItem>();
        
        foreach (var item in validItems)
        {
            // æª¢æŸ¥æ˜¯å¦è¢«é–å®šï¼ˆå·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼‰
            if (item.ExistingDetailEntity != null && 
                !DetailLockHelper.CanDeleteItem(item.ExistingDetailEntity, out _, 
                    checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities))
            {
                lockedItems.Add(item);
            }
            else
            {
                modifiableItems.Add(item);
            }
        }
        
        if (!modifiableItems.Any())
        {
            await NotificationService.ShowWarningAsync("æ‰€æœ‰æ˜ç´°éƒ½å·²è¢«é–å®šï¼ˆå·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼‰ï¼Œç„¡æ³•çµ±ä¸€è¨­å®šå€‰åº«");
            return;
        }
        
        // åªæ›´æ–°å¯ä¿®æ”¹çš„æ˜ç´°
        foreach (var item in modifiableItems)
        {
            item.SelectedWarehouse = warehouse;
            // æ¸…ç©ºåº«ä½ï¼ˆå› ç‚ºå€‰åº«è®Šæ›´äº†ï¼‰
            item.SelectedWarehouseLocation = null;
        }
        
        await NotifyChange();
        StateHasChanged();
        
        // é¡¯ç¤ºçµæœè¨Šæ¯
        if (lockedItems.Any())
        {
            await NotificationService.ShowSuccessAsync(
                $"å·²å°‡ {modifiableItems.Count} ç­†æ˜ç´°çš„å€‰åº«çµ±ä¸€è¨­å®šç‚ºã€Œ{warehouse.Name}ã€\n" +
                $"ï¼ˆ{lockedItems.Count} ç­†æ˜ç´°å› å·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„è€Œç„¡æ³•ä¿®æ”¹ï¼‰");
        }
        else
        {
            await NotificationService.ShowSuccessAsync($"å·²å°‡ {modifiableItems.Count} ç­†æ˜ç´°çš„å€‰åº«çµ±ä¸€è¨­å®šç‚ºã€Œ{warehouse.Name}ã€");
        }
    }
    
    /// <summary>
    /// æ¸…é™¤æ‰€æœ‰æ˜ç´°ï¼ˆåƒ…å¾ç•«é¢ç§»é™¤ï¼Œä¸å¾è³‡æ–™åº«åˆªé™¤ï¼‰
    /// </summary>
    private async Task ClearAllDetails()
    {
        if (!ReceivingItems.Any(item => item.SelectedProduct != null))
        {
            await NotificationService.ShowWarningAsync("ç›®å‰æ²’æœ‰å¯æ¸…é™¤çš„æ˜ç´°");
            return;
        }
        
        // åˆ†é›¢å¯æ¸…é™¤å’Œå·²é–å®šçš„æ˜ç´°
        var validItems = ReceivingItems.Where(item => item.SelectedProduct != null).ToList();
        var clearableItems = new List<ReceivingItem>();
        var lockedItems = new List<ReceivingItem>();
        
        foreach (var item in validItems)
        {
            // æª¢æŸ¥æ˜¯å¦è¢«é–å®šï¼ˆå·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼‰
            if (item.ExistingDetailEntity != null && 
                !DetailLockHelper.CanDeleteItem(item.ExistingDetailEntity, out _, 
                    checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities))
            {
                lockedItems.Add(item);
            }
            else
            {
                clearableItems.Add(item);
            }
        }
        
        if (!clearableItems.Any())
        {
            await NotificationService.ShowWarningAsync("æ‰€æœ‰æ˜ç´°éƒ½å·²è¢«é–å®šï¼ˆå·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼‰ï¼Œç„¡æ³•æ¸…é™¤");
            return;
        }
        
        // ğŸ”‘ é‡è¦ï¼šã€Œæ¸…é™¤æ˜ç´°ã€åªå¾ç•«é¢ç§»é™¤ï¼Œä¸åŠ å…¥ _deletedDetailIds
        // é€™æ¨£å„²å­˜æ™‚ä¸æœƒçœŸçš„å¾è³‡æ–™åº«åˆªé™¤ï¼Œåªæ˜¯ä¸åŒ…å«åœ¨æ›´æ–°çš„æ˜ç´°æ¸…å–®ä¸­
        // ç›´æ¥æ¸…é™¤å¯æ¸…é™¤çš„æ˜ç´°ï¼Œä¸éœ€è¦ç¢ºèª
        foreach (var item in clearableItems)
        {
            ReceivingItems.Remove(item);
        }
        
        // é€šçŸ¥è®Šæ›´ï¼ˆä½†ä¸è§¸ç™¼ OnDeletedDetailsChangedï¼‰
        await NotifyChange();
        
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
        
        // é¡¯ç¤ºçµæœè¨Šæ¯
        if (lockedItems.Any())
        {
            await NotificationService.ShowSuccessAsync(
                $"å·²æ¸…é™¤ {clearableItems.Count} ç­†æ˜ç´°\n" +
                $"ï¼ˆä¿ç•™ {lockedItems.Count} ç­†å·²è¢«é–å®šçš„æ˜ç´°ï¼‰");
        }
        else
        {
            await NotificationService.ShowSuccessAsync($"å·²æ¸…é™¤ {clearableItems.Count} ç­†å…¥åº«æ˜ç´°");
        }
    }
    
    // ===== ç›¸é—œå–®æ“šæŸ¥çœ‹æ–¹æ³• =====
    
    /// <summary>
    /// é¡¯ç¤ºç›¸é—œå–®æ“šï¼ˆé€€è²¨å–®ã€æ²–æ¬¾å–®ï¼‰
    /// </summary>
    private async Task ShowRelatedDocuments(ReceivingItem item)
    {
        if (item.ExistingDetailEntity is not PurchaseReceivingDetail detail || detail.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("æ­¤é …ç›®å°šæœªå„²å­˜ï¼Œç„¡æ³•æŸ¥çœ‹ç›¸é—œå–®æ“š", "æç¤º");
            return;
        }

        selectedProductName = item.SelectedProduct?.Name ?? "æœªçŸ¥å•†å“";
        
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsForPurchaseReceivingDetailAsync(detail.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ç›¸é—œå–®æ“šå¤±æ•—ï¼š{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// è™•ç†é»æ“Šç›¸é—œå–®æ“šçš„äº‹ä»¶
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // è§¸ç™¼äº‹ä»¶ï¼Œè®“çˆ¶çµ„ä»¶ï¼ˆEditModalï¼‰è™•ç†é–‹å•Ÿç›¸é—œå–®æ“š
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            // å¦‚æœçˆ¶çµ„ä»¶æ²’æœ‰è™•ç†ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
            await NotificationService.ShowInfoAsync(
                $"è«‹åœ¨ä¸»ç•«é¢ä¸­é–‹å•Ÿ {document.TypeDisplayName}: {document.DocumentNumber}", 
                "æç¤º"
            );
        }
    }
}
