@* æ¡è³¼å…¥åº«æ˜ç´°ç®¡ç†çµ„ä»¶ - ä½¿ç”¨ InteractiveTableComponent çµ±ä¸€UI ä¸¦æ•´åˆè‡ªå‹•ç©ºè¡ŒåŠŸèƒ½ *@

@using ERPCore2.Helpers.InteractiveTableComponentHelper
@inject IProductService ProductService
@inject IPurchaseOrderService PurchaseOrderService
@inject IPurchaseReceivingDetailService PurchaseReceivingDetailService
@inject IPurchaseReturnDetailService PurchaseReturnDetailService
@inject INotificationService NotificationService
@inject RelatedDocumentsHelper RelatedDocumentsHelper

@typeparam TMainEntity where TMainEntity : BaseEntity
@typeparam TDetailEntity where TDetailEntity : BaseEntity, new()

@if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="supplier-warning">
                <p class="text-muted">é¸æ“‡å» å•†å¾Œå³å¯æŸ¥çœ‹è©²å» å•†çš„å…¥åº«å•†å“</p>
            </div>
        </div>
    </div>
}
else
{
    @* è­¦å‘Šè¨Šæ¯ï¼šé¡¯ç¤ºæœªå¯©æ ¸çš„æ˜ç´°æ•¸é‡ *@
    @if (IsApprovalEnabled && GetUnapprovedItemsCount() > 0)
    {
        <div class="alert alert-warning mb-3" role="alert">
            <div class="d-flex align-items-start">
                <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                <div>
                    <strong>æ³¨æ„ï¼š</strong>ç›®å‰æœ‰ <strong>@GetUnapprovedItemsCount()</strong> é …æ˜ç´°ä¾†è‡ªæœªå¯©æ ¸çš„æ¡è³¼å–®ã€‚
                    <br/>
                    <small class="text-muted">é€™äº›æ˜ç´°å°‡ç„¡æ³•å„²å­˜ï¼Œè«‹ç¢ºèªç›¸é—œæ¡è³¼å–®å·²å®Œæˆå¯©æ ¸å¾Œå†é€²è¡Œå…¥åº«ä½œæ¥­ã€‚</small>
                </div>
            </div>
        </div>
    }
    
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent TItem="ReceivingItem" 
                                      Items="@ReceivingItems"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"
                                      ShowRowNumbers="false"
                                      EmptyMessage="@EmptyMessage"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="false"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"
                                      ActionsColumnWidth = "60px" />
        </div>

        <div class="card-footer">
            <div class="d-flex justify-content-between">
                <div>
                    @if (CanLoadAllUnreceived)
                    {
                        <GenericButtonComponent Text="è¼‰å…¥æœªå…¥åº«"
                                              Variant="ButtonVariant.Info"
                                              OnClick="LoadAllUnreceivedItems" />
                    }
                </div>
                <div class="d-flex gap-2">
                    @* çµ±ä¸€å€‰åº«ä¸‹æ‹‰é¸å–® *@
                    <div class="dropdown">
                        <GenericButtonComponent Text="çµ±ä¸€å€‰åº«"
                                              Variant="ButtonVariant.Primary"
                                              IsDisabled="@(ReceivingItems.Count == 0 || IsReadOnly || !ReceivingItems.Any(x => !IsEmptyRow(x)))"
                                              AdditionalAttributes="@(new Dictionary<string, object> 
                                              { 
                                                  { "data-bs-toggle", "dropdown" },
                                                  { "aria-expanded", "false" }
                                              })" />
                        <ul class="dropdown-menu">
                            <li><h6 class="dropdown-header">é¸æ“‡è¦çµ±ä¸€è¨­å®šçš„å€‰åº«</h6></li>
                            @if (Warehouses.Any())
                            {
                                @foreach (var warehouse in Warehouses)
                                {
                                    <li>
                                        <a class="dropdown-item" href="#" 
                                           @onclick="() => ApplyUnifyWarehouse(warehouse.Id)" 
                                           @onclick:preventDefault="true">
                                            <i class="me-2"></i>@warehouse.Name
                                        </a>
                                    </li>
                                }
                            }
                            else
                            {
                                <li><span class="dropdown-item-text text-muted">æ²’æœ‰å¯ç”¨çš„å€‰åº«</span></li>
                            }
                        </ul>
                    </div>
                
                    <GenericButtonComponent Text="é€²è²¨å…¨å¡«"
                                          Variant="ButtonVariant.Primary"
                                          OnClick="FillAllQuantities" />
                    <GenericButtonComponent Text="é€²è²¨æ¸…ç©º"
                                          Variant="ButtonVariant.Danger"
                                          OnClick="ClearAllQuantities" />
                    <GenericButtonComponent Text="æ¸…é™¤æ˜ç´°"
                                          Variant="ButtonVariant.Danger"
                                          OnClick="ClearAllDetails" />
                </div>
            </div>
        </div>
    </div>
}

<!-- ç›¸é—œå–®æ“šæŸ¥çœ‹ Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

@code {
    // ===== åŸºæœ¬åƒæ•¸ =====
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public EventCallback<List<ReceivingItem>> OnReceivingItemsChanged { get; set; }
    
    // ===== ä¾›æ‡‰å•†éæ¿¾åƒæ•¸ =====
    [Parameter] public int? SelectedSupplierId { get; set; }
    
    // ===== å¯©æ ¸æ§åˆ¶åƒæ•¸ =====
    [Parameter] public bool IsApprovalEnabled { get; set; } = true; // æ˜¯å¦å•Ÿç”¨æ¡è³¼å–®å¯©æ ¸ï¼ˆå¾ç³»çµ±åƒæ•¸è¼‰å…¥ï¼‰
    
    // ===== ç¯©é¸åƒæ•¸ =====
    [Parameter] public int? SelectedPurchaseOrderId { get; set; }
    [Parameter] public int? FilterProductId { get; set; }
    
    // ===== æ³›å‹åƒæ•¸ =====
    [Parameter] public TMainEntity? MainEntity { get; set; }
    [Parameter] public List<TDetailEntity> ExistingDetails { get; set; } = new List<TDetailEntity>();
    [Parameter] public EventCallback<List<TDetailEntity>> OnDetailsChanged { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    [Parameter] public EventCallback<ReceivingItem> OnItemRemoved { get; set; }
    
    // ===== æ¬„ä½æ˜ å°„åƒæ•¸ =====
    [Parameter] public string MainEntityIdPropertyName { get; set; } = string.Empty;
    [Parameter] public string QuantityPropertyName { get; set; } = "ReceivedQuantity";
    [Parameter] public string UnitPricePropertyName { get; set; } = "UnitPrice";
    [Parameter] public string RemarksPropertyName { get; set; } = "Remarks";
    [Parameter] public string? UnitIdPropertyName { get; set; }
    [Parameter] public string? WarehouseIdPropertyName { get; set; }
    [Parameter] public string? WarehouseLocationIdPropertyName { get; set; }
    [Parameter] public string? PurchaseOrderDetailIdPropertyName { get; set; }

    // ===== é¡¯ç¤ºæ§åˆ¶åƒæ•¸ =====
    [Parameter] public bool ShowWarehouse { get; set; } = true;
    [Parameter] public bool ShowWarehouseLocation { get; set; } = true;
    [Parameter] public bool ShowPurchaseOrderReference { get; set; } = false;
    
    // ===== é¡¯ç¤ºæ¨™ç±¤åƒæ•¸ =====
    [Parameter] public string OrderQuantityLabel { get; set; } = "æ¡è³¼æ•¸é‡";
    [Parameter] public string ReceivedQuantityLabel { get; set; } = "å…¥åº«æ•¸é‡";
    [Parameter] public string PriceLabel { get; set; } = "å–®åƒ¹";
    [Parameter] public string RemarksLabel { get; set; } = "å‚™è¨»";
    [Parameter] public string WarehouseLabel { get; set; } = "å€‰åº«";
    [Parameter] public string WarehouseLocationLabel { get; set; } = "åº«ä½";
    [Parameter] public string PurchaseOrderLabel { get; set; } = "æ¡è³¼å–®åƒè€ƒ";
    
    // ===== é¡¯ç¤ºè¨­å®š =====
    [Parameter] public string Title { get; set; } = "å…¥åº«æ˜ç´°";
    [Parameter] public string Subtitle { get; set; } = "";
    [Parameter] public string Icon { get; set; } = "warehouse";
    [Parameter] public string ItemDisplayName { get; set; } = "å•†å“";
    [Parameter] public string EmptyIcon { get; set; } = "box-open";
    [Parameter] public string EmptyMessage { get; set; } = "å°šæœªæ–°å¢å…¥åº«å•†å“";
    
    // ===== å”¯è®€æ¨¡å¼åƒæ•¸ =====
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== ç‹€æ…‹é€šçŸ¥åƒæ•¸ =====
    [Parameter] public EventCallback<bool> OnHasUndeletableDetailsChanged { get; set; }
    
    // ===== ç›¸é—œå–®æ“šé–‹å•Ÿäº‹ä»¶ =====
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }
    
    // ===== ä¸‹æ‹‰é¸é …åƒæ•¸ =====
    [Parameter] public List<Warehouse> Warehouses { get; set; } = new List<Warehouse>();
    [Parameter] public List<WarehouseLocation> WarehouseLocations { get; set; } = new List<WarehouseLocation>();

    private List<ReceivingItem> ReceivingItems { get; set; } = new List<ReceivingItem>();
    private List<Product> AvailableProducts { get; set; } = new List<Product>();
    private List<PurchaseOrderDetail> AvailablePurchaseDetails { get; set; } = new List<PurchaseOrderDetail>();
    private int? _previousSelectedSupplierId = null;
    private int? _previousSelectedPurchaseOrderId = null;
    private int? _previousFilterProductId = null;
    private List<int> _deletedDetailIds { get; set; } = new List<int>();
    
    // ===== é€€è²¨æ•¸é‡ç®¡ç† =====
    private Dictionary<int, decimal> _returnedQuantities = new(); // Key: PurchaseReceivingDetailId, Value: å·²é€€è²¨æ•¸é‡

    // ===== ç›¸é—œå–®æ“šæŸ¥çœ‹ =====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;

    // ===== è¨ˆç®—å±¬æ€§ =====
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦å¯ä»¥ä½¿ç”¨ã€Œè¼‰å…¥æ‰€æœ‰æœªå…¥åº«ã€åŠŸèƒ½
    /// è¦å‰‡ï¼š
    /// 1. å¿…é ˆé¸æ“‡å» å•†
    /// 2. å¿…é ˆæœ‰å¯è¼‰å…¥çš„æ¡è³¼æ˜ç´°
    /// 3. ç·¨è¼¯æ¨¡å¼ä¸‹éš±è—æ­¤æŒ‰éˆ•ï¼ˆé¿å…è¦†è“‹ç¾æœ‰è³‡æ–™ï¼‰
    /// </summary>
    private bool CanLoadAllUnreceived => 
        SelectedSupplierId.HasValue && 
        SelectedSupplierId.Value > 0 && 
        GetAvailablePurchaseDetails().Any() &&
        !(ExistingDetails?.Any() == true); // ç·¨è¼¯æ¨¡å¼ï¼ˆæœ‰ç¾æœ‰æ˜ç´°ï¼‰æ™‚éš±è—
    
    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦æœ‰è¢«é–å®šçš„æ˜ç´°ï¼ˆæœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„çš„æ˜ç´°ï¼‰
    /// </summary>
    private bool HasLockedDetails()
    {
        return ReceivingItems.Any(item => 
            !IsEmptyRow(item) && 
            !DetailLockHelper.CanDeleteItem(item.ExistingDetailEntity, out _, checkPayment: true, checkReturn: true, returnedQuantities: _returnedQuantities));
    }

    /// <summary>
    /// å–å¾—æœªå¯©æ ¸çš„æ˜ç´°æ•¸é‡
    /// </summary>
    private int GetUnapprovedItemsCount()
    {
        if (!IsApprovalEnabled)
            return 0;
        
        return ReceivingItems
            .Where(item => !IsEmptyRow(item) && 
                          item.SelectedPurchaseDetail != null &&
                          !(item.SelectedPurchaseDetail.PurchaseOrder?.IsApproved ?? false))
            .Count();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadAvailableProductsAsync();
        await LoadExistingDetailsAsync();
        EnsureOneEmptyRow();
    }

    // ===== é€€è²¨æ•¸é‡ç®¡ç†æ–¹æ³• =====
    
    /// <summary>
    /// è¼‰å…¥æ‰€æœ‰é€²è²¨æ˜ç´°çš„é€€è²¨æ•¸é‡ï¼ˆå…¬é–‹æ–¹æ³•ï¼Œå¯ä¾›çˆ¶çµ„ä»¶å‘¼å«ï¼‰
    /// </summary>
    /// <summary>
    /// å…¬é–‹æ–¹æ³•ï¼šé‡æ–°è¼‰å…¥é€€è²¨æ•¸é‡
    /// ç•¶é€²è²¨é€€å‡ºå„²å­˜å¾Œï¼Œçˆ¶çµ„ä»¶å¯ä»¥å‘¼å«æ­¤æ–¹æ³•ä¾†æ›´æ–°é€€è²¨æ•¸é‡é¡¯ç¤º
    /// </summary>
    public async Task LoadReturnedQuantitiesAsync()
    {
        _returnedQuantities.Clear();
        
        // å…ˆè¤‡è£½è¦è™•ç†çš„é …ç›®åˆ°åˆ—è¡¨ä¸­ï¼Œé¿å…åœ¨è¿­ä»£æ™‚ä¿®æ”¹é›†åˆ
        var itemsToProcess = ReceivingItems
            .Where(x => x.ExistingDetailEntity != null)
            .ToList();
        
        foreach (var item in itemsToProcess)
        {
            if (item.ExistingDetailEntity is PurchaseReceivingDetail detail && detail.Id > 0)
            {
                try
                {
                    var returnedQty = await PurchaseReturnDetailService.GetReturnedQuantityByReceivingDetailAsync(detail.Id);
                    if (returnedQty > 0)
                    {
                        _returnedQuantities[detail.Id] = returnedQty;
                    }
                }
                catch (Exception ex)
                {
                    await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadReturnedQuantitiesAsync), GetType());
                }
            }
        }
        
        // è¼‰å…¥å®Œé€€è²¨æ•¸é‡å¾Œ,é€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
        await NotifyHasUndeletableDetailsChanged();
    }
    
    /// <summary>
    /// æª¢æŸ¥æŒ‡å®šçš„é€²è²¨æ˜ç´°é …ç›®æ˜¯å¦æœ‰é€€è²¨è¨˜éŒ„
    /// </summary>
    private bool HasReturnRecord(ReceivingItem item)
    {
        if (item.ExistingDetailEntity is PurchaseReceivingDetail detail && detail.Id > 0)
        {
            return _returnedQuantities.ContainsKey(detail.Id);
        }
        return false;
    }
    
    /// <summary>
    /// å–å¾—æŒ‡å®šé€²è²¨æ˜ç´°é …ç›®çš„å·²é€€è²¨æ•¸é‡
    /// </summary>
    private decimal GetReturnedQuantity(ReceivingItem item)
    {
        if (item.ExistingDetailEntity is PurchaseReceivingDetail detail && detail.Id > 0)
        {
            return _returnedQuantities.GetValueOrDefault(detail.Id, 0);
        }
        return 0;
    }
    
    /// <summary>
    /// æª¢æŸ¥æŒ‡å®šçš„é€²è²¨æ˜ç´°é …ç›®æ˜¯å¦æœ‰æ²–æ¬¾è¨˜éŒ„
    /// æª¢æŸ¥é‚è¼¯ï¼š
    /// - è³‡æ–™è¡¨ï¼šPurchaseReceivingDetail
    /// - æ¬„ä½ï¼šTotalPaidAmount (ç´¯è¨ˆä»˜æ¬¾é‡‘é¡)
    /// - æ¢ä»¶ï¼šTotalPaidAmount > 0 è¡¨ç¤ºå·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œä¸å¯åˆªé™¤
    /// </summary>
    /// <param name="item">è¦æª¢æŸ¥çš„é€²è²¨æ˜ç´°é …ç›®</param>
    /// <returns>true è¡¨ç¤ºæœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œfalse è¡¨ç¤ºæ²’æœ‰</returns>
    private bool HasPaymentRecord(ReceivingItem item)
    {
        if (item.ExistingDetailEntity is PurchaseReceivingDetail detail && detail.Id > 0)
        {
            // æª¢æŸ¥ TotalPaidAmount æ˜¯å¦å¤§æ–¼ 0
            return detail.TotalPaidAmount > 0;
        }
        return false;
    }
    
    /// <summary>
    /// å–å¾—æŒ‡å®šé€²è²¨æ˜ç´°é …ç›®çš„å·²æ²–æ¬¾é‡‘é¡
    /// </summary>
    /// <param name="item">è¦æª¢æŸ¥çš„é€²è²¨æ˜ç´°é …ç›®</param>
    /// <returns>å·²æ²–æ¬¾é‡‘é¡</returns>
    private decimal GetPaidAmount(ReceivingItem item)
    {
        if (item.ExistingDetailEntity is PurchaseReceivingDetail detail && detail.Id > 0)
        {
            return detail.TotalPaidAmount;
        }
        return 0;
    }
    
    /// <summary>
    /// æª¢æŸ¥é …ç›®æ˜¯å¦å¯ä»¥åˆªé™¤
    /// ç¶œåˆæª¢æŸ¥ä»¥ä¸‹æ¢ä»¶ï¼š
    /// 1. é€€è²¨è¨˜éŒ„æª¢æŸ¥ (HasReturnRecord)
    ///    - è³‡æ–™ä¾†æºï¼šé€é PurchaseReturnDetailService.GetReturnedQuantityByReceivingDetailAsync() æŸ¥è©¢
    ///    - æª¢æŸ¥è³‡æ–™è¡¨ï¼šPurchaseReturnDetail (æ¡è³¼é€€è²¨æ˜ç´°)
    ///    - æª¢æŸ¥æ¬„ä½ï¼šPurchaseReceivingDetailId (é—œè¯çš„é€²è²¨æ˜ç´°ID)
    ///    - é™åˆ¶åŸå› ï¼šå·²æœ‰é€€è²¨è¨˜éŒ„çš„é€²è²¨æ˜ç´°ä¸å¯åˆªé™¤ï¼Œä»¥ä¿æŒè³‡æ–™ä¸€è‡´æ€§
    /// 
    /// 2. æ²–æ¬¾è¨˜éŒ„æª¢æŸ¥ (HasPaymentRecord)
    ///    - è³‡æ–™ä¾†æºï¼šç›´æ¥è®€å– PurchaseReceivingDetail å¯¦é«”
    ///    - æª¢æŸ¥è³‡æ–™è¡¨ï¼šPurchaseReceivingDetail (æ¡è³¼é€²è²¨æ˜ç´°)
    ///    - æª¢æŸ¥æ¬„ä½ï¼šTotalPaidAmount (ç´¯è¨ˆä»˜æ¬¾é‡‘é¡)
    ///    - é™åˆ¶åŸå› ï¼šå·²æ²–æ¬¾çš„é€²è²¨æ˜ç´°ä¸å¯åˆªé™¤ï¼Œé¿å…è²¡å‹™è³‡æ–™éŒ¯äº‚
    /// </summary>
    /// <param name="item">è¦æª¢æŸ¥çš„é …ç›®</param>
    /// <param name="reason">ä¸å¯åˆªé™¤çš„åŸå› ï¼ˆè¼¸å‡ºåƒæ•¸ï¼‰</param>
    /// <returns>true è¡¨ç¤ºå¯ä»¥åˆªé™¤ï¼Œfalse è¡¨ç¤ºä¸å¯åˆªé™¤</returns>
    private bool CanDeleteItem(ReceivingItem item, out string reason)
    {
        return DetailLockHelper.CanDeleteItem(
            item.ExistingDetailEntity, 
            out reason, 
            checkPayment: true, 
            checkReturn: true, 
            returnedQuantities: _returnedQuantities);
    }

    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼‰
    /// </summary>
    private bool HasUndeletableDetails()
    {
        return ReceivingItems.Any(item => 
            !IsEmptyRow(item) && !CanDeleteItem(item, out _));
    }

    /// <summary>
    /// é€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
    /// </summary>
    private async Task NotifyHasUndeletableDetailsChanged()
    {
        if (OnHasUndeletableDetailsChanged.HasDelegate)
        {
            var hasUndeletableDetails = HasUndeletableDetails();
            await OnHasUndeletableDetailsChanged.InvokeAsync(hasUndeletableDetails);
        }
    }

    /// <summary>
    /// é€²è²¨é‡å…¨å¡«ï¼ˆåªè™•ç†æœªé–å®šçš„æ˜ç´°ï¼‰
    /// </summary>
    private async Task FillAllQuantities()
    {
        var nonEmptyItems = ReceivingItems.Where(item => !IsEmptyRow(item)).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("æ²’æœ‰å¯æ›´æ–°çš„æ˜ç´°é …ç›®", "æç¤º");
            return;
        }
        
        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
        
        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "æ‰€æœ‰æ˜ç´°éƒ½å·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•æ‰¹æ¬¡å¡«å…¥æ•¸é‡", 
                "æ“ä½œé™åˆ¶");
            return;
        }
        
        foreach (var item in unlocked)
        {
            if (item.SelectedPurchaseDetail != null)
            {
                item.ReceivedQuantity = item.OrderQuantity;
            }
        }
        
        var message = $"å·²å¡«å…¥ {unlocked.Count} é …æ˜ç´°çš„é€²è²¨æ•¸é‡";
        if (locked.Any())
        {
            message += $"\nï¼ˆå·²è·³é {locked.Count} é …å·²é–å®šçš„æ˜ç´°ï¼‰";
        }
        await NotificationService.ShowSuccessAsync(message);
        
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// é€²è²¨é‡æ¸…ç©ºï¼ˆåªè™•ç†æœªé–å®šçš„æ˜ç´°ï¼‰
    /// </summary>
    private async Task ClearAllQuantities()
    {
        var nonEmptyItems = ReceivingItems.Where(item => !IsEmptyRow(item)).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("æ²’æœ‰å¯æ›´æ–°çš„æ˜ç´°é …ç›®", "æç¤º");
            return;
        }
        
        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
        
        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "æ‰€æœ‰æ˜ç´°éƒ½å·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•æ‰¹æ¬¡æ¸…ç©ºæ•¸é‡", 
                "æ“ä½œé™åˆ¶");
            return;
        }
        
        foreach (var item in unlocked)
        {
            // å¦‚æœæœ‰é€€è²¨è¨˜éŒ„ï¼Œä¿ç•™å·²é€€è²¨çš„æ•¸é‡ä½œç‚ºæœ€å°å€¼
            var returnedQty = GetReturnedQuantity(item);
            item.ReceivedQuantity = (int)returnedQty;
        }
        
        var message = $"å·²æ¸…ç©º {unlocked.Count} é …æ˜ç´°çš„é€²è²¨æ•¸é‡";
        if (locked.Any())
        {
            message += $"\nï¼ˆå·²è·³é {locked.Count} é …å·²é–å®šçš„æ˜ç´°ï¼‰";
        }
        await NotificationService.ShowSuccessAsync(message);
        
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// æ¸…é™¤æ˜ç´°ï¼ˆåªæ¸…é™¤æœªé–å®šçš„æ˜ç´°ï¼Œä¿ç•™å·²é–å®šçš„ï¼‰
    /// </summary>
    private async Task ClearAllDetails()
    {
        var nonEmptyItems = ReceivingItems.Where(item => !IsEmptyRow(item)).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("æ²’æœ‰å¯æ¸…é™¤çš„æ˜ç´°é …ç›®", "æç¤º");
            return;
        }
        
        // å€åˆ†å¯åˆªé™¤å’Œè¢«é–å®šçš„æ˜ç´°
        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
        
        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "æ‰€æœ‰æ˜ç´°éƒ½å·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•æ¸…é™¤", 
                "æ“ä½œé™åˆ¶");
            return;
        }
        
        // é€šçŸ¥çˆ¶çµ„ä»¶é …ç›®å³å°‡è¢«ç§»é™¤
        if (OnItemRemoved.HasDelegate)
        {
            foreach (var item in unlocked)
            {
                await OnItemRemoved.InvokeAsync(item);
            }
        }
        
        // è¨˜éŒ„æ‰€æœ‰è¦åˆªé™¤çš„ç¾æœ‰æ˜ç´° ID
        foreach (var item in unlocked.Where(item => item.ExistingDetailEntity != null))
        {
            var entityId = GetExistingDetailId(item.ExistingDetailEntity!);
            if (entityId > 0)
            {
                _deletedDetailIds.Add(entityId);
            }
        }
        
        // å¾åˆ—è¡¨ä¸­ç§»é™¤æœªé–å®šçš„é …ç›®ï¼Œä¿ç•™å·²é–å®šçš„é …ç›®
        foreach (var item in unlocked)
        {
            ReceivingItems.Remove(item);
        }
        
        // ç¢ºä¿æœ‰ä¸€å€‹ç©ºè¡Œ
        EnsureOneEmptyRow();
        
        await NotifyDetailsChanged();
        
        var message = $"å·²æ¸…é™¤ {unlocked.Count} é …æ˜ç´°";
        if (locked.Any())
        {
            message += $"\nï¼ˆå·²ä¿ç•™ {locked.Count} é …å·²é–å®šçš„æ˜ç´°ï¼‰";
        }
        await NotificationService.ShowSuccessAsync(message);
    }

    /// <summary>
    /// çµ±ä¸€è¨­å®šæ‰€æœ‰æ˜ç´°é …ç›®çš„å€‰åº«ï¼ˆåªè™•ç†æœªé–å®šçš„æ˜ç´°ï¼‰
    /// </summary>
    /// <param name="warehouseId">è¦è¨­å®šçš„å€‰åº«ID</param>
    private async Task ApplyUnifyWarehouse(int warehouseId)
    {
        if (IsReadOnly) return;

        try
        {
            var selectedWarehouse = Warehouses.FirstOrDefault(w => w.Id == warehouseId);
            if (selectedWarehouse == null)
            {
                await NotificationService.ShowErrorAsync("é¸æ“‡çš„å€‰åº«ä¸å­˜åœ¨", "éŒ¯èª¤");
                return;
            }

            // å–å¾—æ‰€æœ‰éç©ºè¡Œçš„æ˜ç´°é …ç›®
            var nonEmptyItems = ReceivingItems.Where(item => !IsEmptyRow(item)).ToList();
            
            if (!nonEmptyItems.Any())
            {
                await NotificationService.ShowWarningAsync("æ²’æœ‰å¯æ›´æ–°çš„æ˜ç´°é …ç›®", "æç¤º");
                return;
            }

            // å€åˆ†å¯ä¿®æ”¹å’Œè¢«é–å®šçš„æ˜ç´°
            var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
            var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();

            if (!unlocked.Any())
            {
                await NotificationService.ShowWarningAsync(
                    "æ‰€æœ‰æ˜ç´°éƒ½å·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•çµ±ä¸€è¨­å®šå€‰åº«", 
                    "æ“ä½œé™åˆ¶");
                return;
            }

            // æ‰¹é‡æ›´æ–°æœªé–å®šçš„æ˜ç´°é …ç›®çš„å€‰åº«
            foreach (var item in unlocked)
            {
                item.SelectedWarehouse = selectedWarehouse;
                // é‡ç½®åº«ä½é¸æ“‡ï¼Œå› ç‚ºå€‰åº«æ”¹è®Šäº†
                item.SelectedWarehouseLocation = null;
            }

            // é€šçŸ¥çˆ¶çµ„ä»¶è³‡æ–™å·²è®Šæ›´
            await NotifyDetailsChanged();
            
            // é¡¯ç¤ºæˆåŠŸé€šçŸ¥ï¼Œä¸¦æç¤ºè·³éçš„é …ç›®æ•¸é‡
            var message = $"å·²çµ±ä¸€è¨­å®š {unlocked.Count} é …æ˜ç´°çš„å€‰åº«ç‚ºï¼š{selectedWarehouse.Name}";
            if (locked.Any())
            {
                message += $"\nï¼ˆå·²è·³é {locked.Count} é …å·²é–å®šçš„æ˜ç´°ï¼‰";
            }
            await NotificationService.ShowSuccessAsync(message, "çµ±ä¸€è¨­å®šå®Œæˆ");
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ApplyUnifyWarehouse), GetType());
            await NotificationService.ShowErrorAsync("çµ±ä¸€è¨­å®šå€‰åº«æ™‚ç™¼ç”ŸéŒ¯èª¤", "éŒ¯èª¤");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        
        // æª¢æŸ¥ç¯©é¸åƒæ•¸æ˜¯å¦è®Šæ›´
        bool supplierChanged = _previousSelectedSupplierId != SelectedSupplierId;
        bool purchaseOrderChanged = _previousSelectedPurchaseOrderId != SelectedPurchaseOrderId;
        bool productFilterChanged = _previousFilterProductId != FilterProductId;
        
        // å¦‚æœå» å•†è®Šæ›´ï¼Œéœ€è¦é‡æ–°è¼‰å…¥æ‰€æœ‰è³‡æ–™
        if (supplierChanged)
        {
            _previousSelectedSupplierId = SelectedSupplierId;
            _previousSelectedPurchaseOrderId = SelectedPurchaseOrderId;
            _previousFilterProductId = FilterProductId;
            
            await LoadAvailableProductsAsync();
            
            // å» å•†è®Šæ›´æ™‚æ¸…ç©ºç¾æœ‰é¸é …ä¸¦é‡æ–°è¼‰å…¥
            ReceivingItems.Clear();
            await LoadExistingDetailsAsync();
            return;
        }
        
        // å¦‚æœåªæ˜¯æ¡è³¼å–®æˆ–å•†å“ç¯©é¸è®Šæ›´ï¼Œåªéœ€è¦æ›´æ–°ç¯©é¸ç‹€æ…‹ä¸¦é‡æ–°æ¸²æŸ“
        if (purchaseOrderChanged || productFilterChanged)
        {
            _previousSelectedPurchaseOrderId = SelectedPurchaseOrderId;
            _previousFilterProductId = FilterProductId;
            
            // è§¸ç™¼é‡æ–°æ¸²æŸ“ä»¥å¥—ç”¨æ–°çš„ç¯©é¸
            StateHasChanged();
            return;
        }
        
        // ç¸½æ˜¯ç¢ºä¿æœ‰ä¸€è¡Œç©ºè¡Œå¯ä»¥è¼¸å…¥ï¼Œä¸è«–æ˜¯å¦å·²æœ‰è³‡æ–™
        EnsureOneEmptyRow();
    }

    // ===== AutoEmptyRowHelper ç›¸é—œæ–¹æ³• =====
    private bool IsEmptyRow(ReceivingItem item)
    {
        return item.SelectedPurchaseDetail == null && item.SelectedProduct == null;
    }
    
    private ReceivingItem CreateEmptyItem()
    {
        return new ReceivingItem();
    }
    
    private void EnsureOneEmptyRow()
    {
        AutoEmptyRowHelper.ForAny<ReceivingItem>.EnsureOneEmptyRow(
            ReceivingItems, 
            IsEmptyRow, 
            CreateEmptyItem
        );
    }

    // ===== InteractiveTableComponent æ–¹æ³• =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // æ¡è³¼æ˜ç´°é¸æ“‡æ¬„ä½ - å‹•æ…‹åˆ¤æ–·æ˜¯å¦å”¯è®€
        var dynamicColumns = new List<InteractiveColumnDefinition>();
        
        // ç‚ºæ¯å€‹é …ç›®å‰µå»ºå‹•æ…‹æ¬„ä½å®šç¾©ï¼ˆå› ç‚º ProductSelectHelper ç›®å‰ä¸æ”¯æ´å‹•æ…‹ isReadOnlyï¼‰
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å•†å“", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "300px",
            Tooltip = "é¸æ“‡è¦å…¥åº«çš„æ¡è³¼å•†å“ã€‚å·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„çš„å•†å“å°‡ç„¡æ³•è®Šæ›´",
            CustomTemplate = item => 
            {
                var receivingItem = (ReceivingItem)item;
                var hasReturnRecord = HasReturnRecord(receivingItem);
                var hasPaymentRecord = HasPaymentRecord(receivingItem);
                var isFieldReadOnly = IsReadOnly || hasReturnRecord || hasPaymentRecord;
                var selectedValue = receivingItem.SelectedPurchaseDetail?.Id.ToString() ?? "";
                
                // æª¢æŸ¥ç•¶å‰æ˜ç´°çš„å¯©æ ¸ç‹€æ…‹
                var isApproved = receivingItem.SelectedPurchaseDetail?.PurchaseOrder?.IsApproved ?? true;
                var needsApproval = IsApprovalEnabled && !isApproved;
                
                // çµ„åˆ tooltip è¨Šæ¯
                var tooltipMessages = new List<string>();
                if (hasReturnRecord)
                    tooltipMessages.Add("æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„");
                if (hasPaymentRecord)
                {
                    var paidAmount = GetPaidAmount(receivingItem);
                    tooltipMessages.Add($"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ²–æ¬¾ {paidAmount:N0} å…ƒï¼‰");
                }
                if (needsApproval)
                {
                    var poNumber = receivingItem.SelectedPurchaseDetail?.PurchaseOrder?.Code ?? "";
                    tooltipMessages.Add($"æ¡è³¼å–® {poNumber} å°šæœªå¯©æ ¸");
                }
                var title = tooltipMessages.Any() 
                    ? string.Join("ï¼›", tooltipMessages) + (isFieldReadOnly ? "ï¼Œç„¡æ³•ä¿®æ”¹å•†å“é¸æ“‡" : "") 
                    : "";
                
                // å¦‚æœæ˜¯å”¯è®€ç‹€æ…‹ï¼Œç›´æ¥é¡¯ç¤ºæ ¼å¼åŒ–çš„å•†å“åç¨±
                if (isFieldReadOnly && receivingItem.SelectedPurchaseDetail != null)
                {
                    var displayText = FormatPurchaseDetailDisplayText(receivingItem.SelectedPurchaseDetail);
                    return @<div class="position-relative d-flex align-items-center" style="min-height: 31px;">
                        <span class="text-muted" title="@title">@displayText</span>
                    </div>;
                }
                
                // å–å¾—å¯ç”¨çš„æ¡è³¼æ˜ç´°åˆ—è¡¨
                var availableDetails = GetAvailablePurchaseDetails();
                
                // ç¢ºä¿ç•¶å‰é¸ä¸­çš„æ˜ç´°ä¹Ÿåœ¨åˆ—è¡¨ä¸­ï¼ˆå³ä½¿å®ƒå¯èƒ½å·²è¢«ç¯©é¸æ‰ï¼‰
                if (receivingItem.SelectedPurchaseDetail != null && 
                    !availableDetails.Any(d => d.Id == receivingItem.SelectedPurchaseDetail.Id))
                {
                    // å¦‚æœç•¶å‰é¸ä¸­çš„æ˜ç´°ä¸åœ¨å¯ç”¨åˆ—è¡¨ä¸­ï¼Œå»ºç«‹ä¸€å€‹åŒ…å«å®ƒçš„æ–°åˆ—è¡¨
                    availableDetails = new List<PurchaseOrderDetail>(availableDetails) 
                    { 
                        receivingItem.SelectedPurchaseDetail 
                    };
                }
                
                return @<div class="position-relative">
                    @* å¦‚æœå•Ÿç”¨å¯©æ ¸ä¸”æ˜ç´°æœªå¯©æ ¸ï¼Œé¡¯ç¤ºè­¦å‘Šæ¨™è¨˜ *@
                    @if (needsApproval && receivingItem.SelectedPurchaseDetail != null)
                    {
                        <div class="d-flex align-items-center mb-1">
                            <span class="badge bg-warning text-dark" style="font-size: 0.7rem;">
                                <i class="fas fa-exclamation-triangle me-1"></i>æœªå¯©æ ¸
                            </span>
                        </div>
                    }
                    
                    <select class="form-select form-select-sm @(needsApproval ? "border-warning" : "")" 
                            value="@selectedValue"
                            disabled="@isFieldReadOnly"
                            title="@title"
                            @onchange="@(async (e) => await OnPurchaseDetailChanged(receivingItem, e.Value))">
                        <option value="">è«‹é¸æ“‡æ¡è³¼æ˜ç´°</option>
                        @foreach (var detail in availableDetails)
                        {
                            var displayText = FormatPurchaseDetailDisplayText(detail);
                            var detailIsApproved = detail.PurchaseOrder?.IsApproved ?? true;
                            var detailNeedsApproval = IsApprovalEnabled && !detailIsApproved;
                            
                            @* æœªå¯©æ ¸çš„æ˜ç´°ä»¥ä¸åŒæ¨£å¼é¡¯ç¤º *@
                            @if (detailNeedsApproval)
                            {
                                <option value="@detail.Id" style="color: #856404; background-color: #fff3cd;">
                                    âš ï¸ @displayText (æœªå¯©æ ¸)
                                </option>
                            }
                            else
                            {
                                <option value="@detail.Id">@displayText</option>
                            }
                        }
                    </select>
                    
                    @if (hasReturnRecord || hasPaymentRecord)
                    {
                        <div class="position-absolute" style="top: 2px; right: 30px; pointer-events: none;">
                            <i title="@title"></i>
                        </div>
                    }
                </div>;
            }
        });        

        // æ¡è³¼æ•¸é‡æ¬„ä½ (åªè®€é¡¯ç¤º)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "æ¡è³¼æ•¸é‡", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "100px",
            Tooltip = "åŸå§‹æ¡è³¼å–®ä¸Šçš„è¨‚è³¼æ•¸é‡ï¼ˆå”¯è®€ï¼‰",
            CustomTemplate = item => 
            {
                var receivingItem = (ReceivingItem)item;
                
                return @<div class="d-flex align-items-center justify-content-end">
                    <span>@receivingItem.OrderQuantity.ToString("N0")</span>
                </div>;
            }
        });

        // å…¥åº«æ•¸é‡æ¬„ä½ - æª¢æŸ¥æ˜¯å¦æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼Œå¦‚æœæœ‰å‰‡é–å®š
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å…¥åº«æ•¸é‡", 
            PropertyName = "ReceivedQuantity",
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            Tooltip = "å¯¦éš›å…¥åº«çš„æ•¸é‡ã€‚å·²é€€è²¨æˆ–å·²æ²–æ¬¾çš„å•†å“å°‡ç„¡æ³•ä¿®æ”¹æ•¸é‡",
            CellCssClass = "text-end",
            MinValue = 0,
            IsDisabledFunc = item =>
            {
                var receivingItem = (ReceivingItem)item;
                var hasReturnRecord = HasReturnRecord(receivingItem);
                var hasPaymentRecord = HasPaymentRecord(receivingItem);
                return hasReturnRecord || hasPaymentRecord;
            },
            TooltipFunc = item =>
            {
                var receivingItem = (ReceivingItem)item;
                var returnedQty = GetReturnedQuantity(receivingItem);
                var hasReturnRecord = HasReturnRecord(receivingItem);
                var hasPaymentRecord = HasPaymentRecord(receivingItem);
                
                var tooltipMessages = new List<string>();
                if (hasReturnRecord)
                    tooltipMessages.Add($"æ­¤å•†å“å·²é€€è²¨ {returnedQty} å€‹");
                if (hasPaymentRecord)
                {
                    var paidAmount = GetPaidAmount(receivingItem);
                    tooltipMessages.Add($"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ²–æ¬¾ {paidAmount:N0} å…ƒï¼‰");
                }
                
                if (tooltipMessages.Any())
                    return string.Join("ï¼›", tooltipMessages) + "ï¼Œç„¡æ³•ä¿®æ”¹å…¥åº«æ•¸é‡";
                
                return "å¯¦éš›å…¥åº«çš„æ•¸é‡ã€‚å·²é€€è²¨æˆ–å·²æ²–æ¬¾çš„å•†å“å°‡ç„¡æ³•ä¿®æ”¹æ•¸é‡";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var receivingItem = (ReceivingItem)args.Item1;
                await OnReceivedQuantityInput(receivingItem, args.Item2);
            })
        });

        // å–®åƒ¹æ¬„ä½ (åªè®€é¡¯ç¤º)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å–®åƒ¹", 
            PropertyName = "UnitPrice",
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            Tooltip = "å•†å“çš„æ¡è³¼å–®åƒ¹ï¼ˆå”¯è®€ï¼‰",
            CellCssClass = "text-end",
            IsReadOnly = true
        });

        // å€‰åº«æ¬„ä½ (æ¢ä»¶é¡¯ç¤º)
        if (ShowWarehouse)
        {
            columns.Add(new InteractiveColumnDefinition
            { 
                Title = "å€‰åº«", 
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "120px",
                Tooltip = "é¸æ“‡å…¥åº«çš„å€‰åº«ä½ç½®ã€‚å·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„çš„å•†å“å°‡ç„¡æ³•è®Šæ›´",
                CustomTemplate = item => 
                {
                    var receivingItem = (ReceivingItem)item;
                    var selectedWarehouseId = receivingItem.SelectedWarehouse?.Id.ToString() ?? "";
                    var hasReturnRecord = HasReturnRecord(receivingItem);
                    var hasPaymentRecord = HasPaymentRecord(receivingItem);
                    var isFieldDisabled = IsReadOnly || hasReturnRecord || hasPaymentRecord;
                    
                    // çµ„åˆ tooltip è¨Šæ¯
                    var tooltipMessages = new List<string>();
                    if (hasReturnRecord)
                        tooltipMessages.Add("æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„");
                    if (hasPaymentRecord)
                    {
                        var paidAmount = GetPaidAmount(receivingItem);
                        tooltipMessages.Add($"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ²–æ¬¾ {paidAmount:N0} å…ƒï¼‰");
                    }
                    var title = tooltipMessages.Any() 
                        ? string.Join("ï¼›", tooltipMessages) + "ï¼Œç„¡æ³•ä¿®æ”¹å€‰åº«" 
                        : "";
                    
                // å¦‚æœæ˜¯å”¯è®€ç‹€æ…‹ï¼Œç›´æ¥é¡¯ç¤º span
                if (isFieldDisabled)
                {
                    var displayText = receivingItem.SelectedWarehouse?.Name ?? "æœªé¸æ“‡å€‰åº«";
                    return @<div class="position-relative d-flex align-items-center" style="min-height: 31px;">
                            <span class="text-muted" title="@title">@displayText</span>
                        </div>;
                }                    // å¯ç·¨è¼¯ç‹€æ…‹ï¼Œé¡¯ç¤ºä¸‹æ‹‰é¸å–®
                    return @<div class="position-relative">
                        <select class="form-select form-select-sm"
                               value="@selectedWarehouseId"
                               @onchange="(e) => OnWarehouseSelectionChanged(receivingItem, e.Value?.ToString())">
                            <option value="">è«‹é¸æ“‡å€‰åº«</option>
                            @foreach (var warehouse in Warehouses)
                            {
                                <option value="@warehouse.Id">@warehouse.Name</option>
                            }
                        </select>
                    </div>;
                }
            });
        }

        // å€‰åº«ä½ç½®æ¬„ä½ (æ¢ä»¶é¡¯ç¤º)
        if (ShowWarehouseLocation)
        {
            columns.Add(new InteractiveColumnDefinition
            { 
                Title = "åº«ä½", 
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "120px",
                Tooltip = "é¸æ“‡å€‰åº«å…§çš„å…·é«”å„²å­˜ä½ç½®ã€‚éœ€å…ˆé¸æ“‡å€‰åº«",
                CustomTemplate = item => 
                {
                    var receivingItem = (ReceivingItem)item;
                    var selectedWarehouseLocationId = receivingItem.SelectedWarehouseLocation?.Id.ToString() ?? "";
                    var hasReturnRecord = HasReturnRecord(receivingItem);
                    var hasPaymentRecord = HasPaymentRecord(receivingItem);
                    var isFieldDisabled = IsReadOnly || hasReturnRecord || hasPaymentRecord;
                    
                    // çµ„åˆ tooltip è¨Šæ¯
                    var tooltipMessages = new List<string>();
                    if (hasReturnRecord)
                        tooltipMessages.Add("æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„");
                    if (hasPaymentRecord)
                    {
                        var paidAmount = GetPaidAmount(receivingItem);
                        tooltipMessages.Add($"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ²–æ¬¾ {paidAmount:N0} å…ƒï¼‰");
                    }
                    var title = tooltipMessages.Any() 
                        ? string.Join("ï¼›", tooltipMessages) + "ï¼Œç„¡æ³•ä¿®æ”¹åº«ä½" 
                        : "";
                    
                    // æ ¹æ“šé¸æ“‡çš„å€‰åº«ç¯©é¸åº«ä½
                    var availableLocations = receivingItem.SelectedWarehouse != null 
                        ? WarehouseLocations.Where(wl => wl.WarehouseId == receivingItem.SelectedWarehouse.Id).ToList()
                        : new List<WarehouseLocation>();
                    
                    // å¦‚æœæ˜¯å”¯è®€ç‹€æ…‹ï¼Œç›´æ¥é¡¯ç¤º span
                    if (isFieldDisabled)
                    {
                        var displayText = receivingItem.SelectedWarehouseLocation?.Name ?? "æœªé¸æ“‡åº«ä½";
                        return @<div class="position-relative d-flex align-items-center" style="min-height: 31px;">
                            <span class="text-muted" title="@title">@displayText</span>
                        </div>;
                    }
                    
                    // å¯ç·¨è¼¯ç‹€æ…‹ï¼Œé¡¯ç¤ºä¸‹æ‹‰é¸å–®
                    return @<div class="position-relative">
                        <select class="form-select form-select-sm"
                               value="@selectedWarehouseLocationId"
                               @onchange="(e) => OnWarehouseLocationSelectionChanged(receivingItem, e.Value?.ToString())">
                            <option value="">è«‹é¸æ“‡åº«ä½</option>
                            @foreach (var location in availableLocations)
                            {
                                <option value="@location.Id">@location.Name</option>
                            }
                        </select>
                    </div>;
                }
            });
        }        

        // å‚™è¨»æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å‚™è¨»", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "150px",
            HideOnMobile = true,
            Tooltip = "é¸å¡«ã€‚å¯è¨˜éŒ„å…¥åº«ç›¸é—œçš„å‚™è¨»è³‡è¨Š",
            CustomTemplate = item => 
            {
                var receivingItem = (ReceivingItem)item;
                
                // å¦‚æœæ˜¯å”¯è®€ç‹€æ…‹ï¼Œç›´æ¥é¡¯ç¤º span
                if (IsReadOnly)
                {
                    var displayText = string.IsNullOrEmpty(receivingItem.Remarks) ? "ç„¡å‚™è¨»" : receivingItem.Remarks;
                    return @<div class="d-flex align-items-center" style="min-height: 31px;">
                        <span class="text-muted">@displayText</span>
                    </div>;
                }
                
                // å¯ç·¨è¼¯ç‹€æ…‹ï¼Œé¡¯ç¤ºè¼¸å…¥æ¡†
                return @<input type="text" class="form-control " 
                               value="@receivingItem.Remarks"
                               @oninput="(e) => OnRemarksInput(receivingItem, e.Value?.ToString())"
                               placeholder="é¸å¡«..." />;
            }
        });

        return columns;
    }

    private RenderFragment<ReceivingItem> GetCustomActionsTemplate => item => __builder =>
    {
        // æª¢æŸ¥é …ç›®æ˜¯å¦å¯ä»¥åˆªé™¤ï¼ˆç¶œåˆé€€è²¨è¨˜éŒ„å’Œæ²–æ¬¾è¨˜éŒ„æª¢æŸ¥ï¼‰
        var canDelete = CanDeleteItem(item, out _);
        
        if (canDelete)
        {
            // å¯ä»¥åˆªé™¤ï¼šé¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Danger"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="@IsReadOnly"
                                   Title="åˆªé™¤"
                                   OnClick="async () => await HandleItemDelete(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else
        {
            // ä¸èƒ½åˆªé™¤ï¼šé¡¯ç¤ºæŸ¥çœ‹æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Info"
                                   IconClass="bi bi-eye text-white"
                                   Size="ButtonSize.Large"
                                   Title="æŸ¥çœ‹ç›¸é—œå–®æ“š"
                                   OnClick="async () => await ShowRelatedDocuments(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
    };

    private async Task HandleItemDelete(ReceivingItem item)
    {
        // ä½¿ç”¨ç¶œåˆæª¢æŸ¥æ–¹æ³•ï¼Œç¢ºèªæ˜¯å¦å¯ä»¥åˆªé™¤
        if (!CanDeleteItem(item, out string reason))
        {
            await NotificationService.ShowWarningAsync(
                reason, 
                "æ“ä½œé™åˆ¶"
            );
            return;
        }
        
        var index = ReceivingItems.IndexOf(item);
        await RemoveItemAsync(index);
    }

    /// <summary>
    /// é¡¯ç¤ºç›¸é—œå–®æ“šï¼ˆé€€è²¨å–®å’Œæ²–æ¬¾å–®ï¼‰
    /// </summary>
    private async Task ShowRelatedDocuments(ReceivingItem item)
    {
        // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰çš„æ˜ç´°å¯¦é«” ID
        if (item.ExistingDetailEntity is not PurchaseReceivingDetail detail || detail.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("æ­¤é …ç›®å°šæœªå„²å­˜ï¼Œç„¡æ³•æŸ¥çœ‹ç›¸é—œå–®æ“š", "æç¤º");
            return;
        }

        // è¨­å®šå•†å“åç¨±
        selectedProductName = item.SelectedProduct?.Name ?? "æœªçŸ¥å•†å“";

        // é¡¯ç¤º Modal ä¸¦é–‹å§‹è¼‰å…¥
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            // æŸ¥è©¢ç›¸é—œå–®æ“š
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsForPurchaseReceivingDetailAsync(detail.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ç›¸é—œå–®æ“šå¤±æ•—ï¼š{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// è™•ç†é»æ“Šç›¸é—œå–®æ“šçš„äº‹ä»¶
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // è§¸ç™¼äº‹ä»¶ï¼Œè®“çˆ¶çµ„ä»¶ï¼ˆEditModalï¼‰è™•ç†é–‹å•Ÿç›¸é—œå–®æ“š
        // æ³¨æ„ï¼šä¸é—œé–‰ RelatedDocumentsModalï¼Œè®“ä½¿ç”¨è€…å¯ä»¥ç¹¼çºŒæŸ¥çœ‹åˆ—è¡¨
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            // å¦‚æœçˆ¶çµ„ä»¶æ²’æœ‰è™•ç†ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
            await NotificationService.ShowInfoAsync(
                $"è«‹åœ¨ä¸»ç•«é¢ä¸­é–‹å•Ÿ {document.TypeDisplayName}: {document.DocumentNumber}", 
                "æç¤º"
            );
        }
    }


    // ===== å…§éƒ¨æ–¹æ³• =====
    private async Task LoadAvailableProductsAsync()
    {
        try
        {
            if (SelectedSupplierId.HasValue && SelectedSupplierId.Value > 0)
            {
                // ğŸ”‘ ä¿®æ”¹ï¼šæ°¸é è¼‰å…¥æ‰€æœ‰æ˜ç´°ï¼ˆä¸åœ¨ Service å±¤éæ¿¾å¯©æ ¸ç‹€æ…‹ï¼‰
                // æ”¹ç‚ºåœ¨å‰ç«¯æ¨™è¨˜æœªå¯©æ ¸æ˜ç´°ï¼Œä¸¦åœ¨é©—è­‰æ™‚æ‹’çµ•å„²å­˜
                AvailablePurchaseDetails = await PurchaseOrderService.GetReceivingDetailsBySupplierAsync(
                    SelectedSupplierId.Value, 
                    includeCompleted: false,
                    checkApproval: false); // æ°¸é å‚³ falseï¼Œè¼‰å…¥æ‰€æœ‰æ˜ç´°
                
                // å¾æ¡è³¼æ˜ç´°ä¸­æå–å•†å“æ¸…å–®ï¼ˆå‘ä¸‹ç›¸å®¹ï¼‰
                AvailableProducts = AvailablePurchaseDetails
                    .Where(pd => pd.Product != null)
                    .Select(pd => pd.Product!)
                    .Distinct()
                    .ToList();
            }
            else
            {
                AvailableProducts = new List<Product>();
                AvailablePurchaseDetails = new List<PurchaseOrderDetail>();
            }
        }
        catch (Exception)
        {
            AvailableProducts = new List<Product>();
            AvailablePurchaseDetails = new List<PurchaseOrderDetail>();
        }
    }

    private async Task LoadExistingDetailsAsync()
    {
        if (ExistingDetails?.Any() != true) 
        {
            EnsureOneEmptyRow();
            return;
        }

        ReceivingItems.Clear();
        
        foreach (var detail in ExistingDetails)
        {
            // è½‰æ›ç‚ºæ­£ç¢ºçš„å¯¦é«”é¡å‹
            if (detail is PurchaseReceivingDetail purchaseDetail)
            {
                var item = new ReceivingItem
                {
                    // ç›´æ¥ä½¿ç”¨ Navigation Properties - ç°¡å–®ä¸”å¯é ï¼
                    SelectedProduct = purchaseDetail.Product,
                    SelectedWarehouse = purchaseDetail.Warehouse,
                    SelectedWarehouseLocation = purchaseDetail.WarehouseLocation,
                    SelectedPurchaseDetail = purchaseDetail.PurchaseOrderDetail,
                    
                    // ç›´æ¥ä½¿ç”¨å±¬æ€§å€¼ï¼Œä¸éœ€è¦åå°„
                    ReceivedQuantity = purchaseDetail.ReceivedQuantity,
                    UnitPrice = purchaseDetail.UnitPrice,
                    Remarks = string.Empty,
                    ExistingDetailEntity = detail
                };
                
                ReceivingItems.Add(item);
            }
            else
            {
                // å°æ–¼é PurchaseReceivingDetail é¡å‹ï¼Œä¿ç•™åŸæœ‰çš„æ³›å‹é‚è¼¯ä½œç‚ºå¾Œå‚™
                var productId = GetPropertyValue<int>(detail, "ProductId");
                var product = Products.FirstOrDefault(p => p.Id == productId) ?? 
                             AvailableProducts.FirstOrDefault(p => p.Id == productId);
                
                if (product != null)
                {
                    var item = new ReceivingItem
                    {
                        SelectedProduct = product,
                        ReceivedQuantity = Convert.ToInt32(GetPropertyValue<object>(detail, QuantityPropertyName) ?? 0),
                        UnitPrice = Convert.ToDecimal(GetPropertyValue<object>(detail, UnitPricePropertyName) ?? 0m),
                        Remarks = GetPropertyValue<string>(detail, RemarksPropertyName) ?? string.Empty,
                        ExistingDetailEntity = detail
                    };
                    
                    // è¼‰å…¥å€‰åº«è³‡è¨Š
                    if (!string.IsNullOrEmpty(WarehouseIdPropertyName))
                    {
                        var warehouseId = GetPropertyValue<int?>(detail, WarehouseIdPropertyName);
                        if (warehouseId.HasValue)
                        {
                            item.SelectedWarehouse = Warehouses.FirstOrDefault(w => w.Id == warehouseId.Value);
                        }
                    }
                    
                    // è¼‰å…¥å€‰åº«ä½ç½®è³‡è¨Š
                    if (!string.IsNullOrEmpty(WarehouseLocationIdPropertyName))
                    {
                        var warehouseLocationId = GetPropertyValue<int?>(detail, WarehouseLocationIdPropertyName);
                        if (warehouseLocationId.HasValue)
                        {
                            item.SelectedWarehouseLocation = WarehouseLocations.FirstOrDefault(wl => wl.Id == warehouseLocationId.Value);
                        }
                    }
                    
                    // è¼‰å…¥æ¡è³¼æ˜ç´°è³‡è¨Š
                    if (!string.IsNullOrEmpty(PurchaseOrderDetailIdPropertyName))
                    {
                        var purchaseOrderDetailId = GetPropertyValue<int?>(detail, PurchaseOrderDetailIdPropertyName);
                        if (purchaseOrderDetailId.HasValue)
                        {
                            var purchaseDetailFromList = AvailablePurchaseDetails.FirstOrDefault(pd => pd.Id == purchaseOrderDetailId.Value);
                            if (purchaseDetailFromList != null)
                            {
                                item.SelectedPurchaseDetail = purchaseDetailFromList;
                            }
                        }
                    }
                    
                    ReceivingItems.Add(item);
                }
            }
        }
        
        EnsureOneEmptyRow();
        
        // è¼‰å…¥é€€è²¨æ•¸é‡è³‡è¨Š
        await LoadReturnedQuantitiesAsync();
    }

    private List<TDetailEntity> ConvertToDetailEntities()
    {
        var details = new List<TDetailEntity>();
        
        // åªè™•ç†éç©ºè¡Œã€æœ‰é¸æ“‡å•†å“ä¸”å…¥åº«æ•¸é‡å¤§æ–¼ 0 çš„é …ç›®
        foreach (var item in ReceivingItems.Where(x => !IsEmptyRow(x) && 
                                                        (x.SelectedPurchaseDetail != null || x.SelectedProduct != null) &&
                                                        x.ReceivedQuantity > 0))
        {
            TDetailEntity detail;
            
            if (item.ExistingDetailEntity != null)
            {
                detail = item.ExistingDetailEntity;
                
                // å¦‚æœæ˜¯ PurchaseReceivingDetail é¡å‹ï¼Œç›´æ¥è¨­ç½®å±¬æ€§
                if (detail is PurchaseReceivingDetail purchaseDetail)
                {
                    purchaseDetail.ReceivedQuantity = item.ReceivedQuantity;
                    purchaseDetail.UnitPrice = item.UnitPrice;
                    purchaseDetail.OrderQuantity = item.OrderQuantity > 0 ? item.OrderQuantity : item.ReceivedQuantity;
                    
                    if (item.SelectedWarehouse != null)
                        purchaseDetail.WarehouseId = item.SelectedWarehouse.Id;
                    
                    if (item.SelectedWarehouseLocation != null)
                        purchaseDetail.WarehouseLocationId = item.SelectedWarehouseLocation.Id;
                    
                    if (item.SelectedPurchaseDetail != null)
                        purchaseDetail.PurchaseOrderDetailId = item.SelectedPurchaseDetail.Id;
                    
                    if (item.SelectedProduct != null)
                        purchaseDetail.ProductId = item.SelectedProduct.Id;
                }
                else
                {
                    // å°æ–¼å…¶ä»–é¡å‹ï¼Œä½¿ç”¨åå°„
                    SetPropertyValue(detail, QuantityPropertyName, item.ReceivedQuantity);
                    SetPropertyValue(detail, UnitPricePropertyName, item.UnitPrice);
                    SetPropertyValue(detail, RemarksPropertyName, item.Remarks);
                    SetPropertyValue(detail, "OrderQuantity", item.OrderQuantity > 0 ? item.OrderQuantity : item.ReceivedQuantity);
                    
                    if (!string.IsNullOrEmpty(WarehouseIdPropertyName) && item.SelectedWarehouse != null)
                    {
                        SetPropertyValue(detail, WarehouseIdPropertyName, item.SelectedWarehouse.Id);
                    }
                    
                    if (!string.IsNullOrEmpty(WarehouseLocationIdPropertyName) && item.SelectedWarehouseLocation != null)
                    {
                        SetPropertyValue(detail, WarehouseLocationIdPropertyName, item.SelectedWarehouseLocation.Id);
                    }
                    
                    if (!string.IsNullOrEmpty(PurchaseOrderDetailIdPropertyName) && item.SelectedPurchaseDetail != null)
                    {
                        SetPropertyValue(detail, PurchaseOrderDetailIdPropertyName, item.SelectedPurchaseDetail.Id);
                    }
                }
            }
            else
            {
                detail = new TDetailEntity();
                
                if (MainEntity != null && !string.IsNullOrEmpty(MainEntityIdPropertyName))
                {
                    SetPropertyValue(detail, MainEntityIdPropertyName, MainEntity.Id);
                }
                
                // è¨­å®šå•†å“ID - å„ªå…ˆä½¿ç”¨æ¡è³¼æ˜ç´°ä¸­çš„å•†å“ï¼Œå¦å‰‡ä½¿ç”¨ç›´æ¥é¸æ“‡çš„å•†å“
                if (item.SelectedPurchaseDetail?.Product != null)
                {
                    SetPropertyValue(detail, "ProductId", item.SelectedPurchaseDetail.Product.Id);
                }
                else if (item.SelectedProduct != null)
                {
                    SetPropertyValue(detail, "ProductId", item.SelectedProduct.Id);
                }
                
                SetPropertyValue(detail, QuantityPropertyName, item.ReceivedQuantity);
                SetPropertyValue(detail, UnitPricePropertyName, item.UnitPrice);
                SetPropertyValue(detail, RemarksPropertyName, item.Remarks);
                SetPropertyValue(detail, "OrderQuantity", item.OrderQuantity > 0 ? item.OrderQuantity : item.ReceivedQuantity);
                
                if (!string.IsNullOrEmpty(WarehouseIdPropertyName) && item.SelectedWarehouse != null)
                {
                    SetPropertyValue(detail, WarehouseIdPropertyName, item.SelectedWarehouse.Id);
                }
                
                if (!string.IsNullOrEmpty(WarehouseLocationIdPropertyName) && item.SelectedWarehouseLocation != null)
                {
                    SetPropertyValue(detail, WarehouseLocationIdPropertyName, item.SelectedWarehouseLocation.Id);
                }
                
                if (!string.IsNullOrEmpty(PurchaseOrderDetailIdPropertyName) && item.SelectedPurchaseDetail != null)
                {
                    SetPropertyValue(detail, PurchaseOrderDetailIdPropertyName, item.SelectedPurchaseDetail.Id);
                }
            }
            
            details.Add(detail);
        }
        
        return details;
    }

    private async Task NotifyDetailsChanged()
    {
        var details = ConvertToDetailEntities();
        await OnDetailsChanged.InvokeAsync(details);
        
        // é€šçŸ¥å·²åˆªé™¤çš„æ˜ç´° ID
        if (OnDeletedDetailsChanged.HasDelegate && _deletedDetailIds.Any())
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds.ToList());
            _deletedDetailIds.Clear(); // æ¸…ç©ºå·²é€šçŸ¥çš„åˆªé™¤ID
        }
        
        // é€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
        await NotifyHasUndeletableDetailsChanged();
    }

    private async Task<(Warehouse? warehouse, WarehouseLocation? location)> GetLastReceivingWarehouseAsync(int productId)
    {
        try
        {
            var receivingDetails = await PurchaseReceivingDetailService.GetByProductIdAsync(productId);
            var latestDetail = receivingDetails.FirstOrDefault();
            
            return (latestDetail?.Warehouse, latestDetail?.WarehouseLocation);
        }
        catch
        {
            return (null, null);
        }
    }

    private T? GetPropertyValue<T>(object obj, string propertyName)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property == null) return default(T);
        
        var value = property.GetValue(obj);
        if (value == null) return default(T);
        
        if (typeof(T) == typeof(object)) return (T)value;
        
        return (T)Convert.ChangeType(value, typeof(T));
    }

    private void SetPropertyValue(object obj, string propertyName, object? value)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property != null && property.CanWrite)
        {
            if (value != null && property.PropertyType != value.GetType())
            {
                if (property.PropertyType.IsGenericType && property.PropertyType.GetGenericTypeDefinition() == typeof(Nullable<>))
                {
                    var underlyingType = Nullable.GetUnderlyingType(property.PropertyType);
                    value = Convert.ChangeType(value, underlyingType!);
                }
                else
                {
                    value = Convert.ChangeType(value, property.PropertyType);
                }
            }
            property.SetValue(obj, value);
        }
    }

    // ===== æ¡è³¼æ˜ç´°é¸æ“‡äº‹ä»¶è™•ç† =====

    private async Task OnPurchaseDetailChanged(ReceivingItem receivingItem, object? value)
    {
        var wasEmpty = IsEmptyRow(receivingItem);
        
        var purchaseDetailIdStr = value?.ToString();
        if (string.IsNullOrEmpty(purchaseDetailIdStr))
        {
            receivingItem.SelectedPurchaseDetail = null;
            receivingItem.SelectedProduct = null;
            receivingItem.ReceivedQuantity = 0;
            receivingItem.UnitPrice = 0;
        }
        else if (int.TryParse(purchaseDetailIdStr, out var purchaseDetailId))
        {
            var detail = GetAvailablePurchaseDetails().FirstOrDefault(d => d.Id == purchaseDetailId);
            if (detail != null)
            {
                receivingItem.SelectedPurchaseDetail = detail;
                receivingItem.SelectedProduct = detail.Product;
                receivingItem.UnitPrice = detail.UnitPrice;
                
                // è‡ªå‹•å¸¶å‡ºæœ€è¿‘é€²è²¨çš„å€‰åº«å’Œåº«ä½ï¼ˆåªæœ‰åœ¨å°šæœªé¸æ“‡æ™‚æ‰è‡ªå‹•å¡«å…¥ï¼‰
                if (receivingItem.SelectedWarehouse == null && detail.Product != null)
                {
                    var (warehouse, location) = await GetLastReceivingWarehouseAsync(detail.Product.Id);
                    if (warehouse != null)
                    {
                        receivingItem.SelectedWarehouse = warehouse;
                        if (location != null)
                        {
                            receivingItem.SelectedWarehouseLocation = location;
                        }
                    }
                }
            }
        }
        
        // è™•ç†è‡ªå‹•ç©ºè¡Œé‚è¼¯
        AutoEmptyRowHelper.ForAny<ReceivingItem>.HandleInputChange(
            ReceivingItems, receivingItem, IsEmptyRow, CreateEmptyItem, wasEmpty, !IsEmptyRow(receivingItem));
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    /// <summary>
    /// æ ¼å¼åŒ–æ¡è³¼æ˜ç´°é¡¯ç¤ºæ–‡å­—ï¼ˆç”¨æ–¼ä¸‹æ‹‰é¸å–®ï¼‰
    /// </summary>
    private string FormatPurchaseDetailDisplayText(PurchaseOrderDetail detail)
    {
        if (detail?.Product == null) return "";
        
        var product = detail.Product;
        var purchaseOrderNumber = detail.PurchaseOrder?.Code ?? "N/A";
        
        var productDisplay = !string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name)
            ? $"[{product.Code}] {product.Name}"
            : (!string.IsNullOrEmpty(product.Code) ? $"[{product.Code}]" : product.Name ?? "");
        
        return $"[{purchaseOrderNumber}] {productDisplay}";
    }

    private async Task OnReceivedQuantityInput(ReceivingItem item, string? value)
    {
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹
        if (!CanDeleteItem(item, out string reason))
        {
            var friendlyMessage = HasReturnRecord(item)
                ? "æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹å…¥åº«æ•¸é‡"
                : "æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹å…¥åº«æ•¸é‡";
            
            await NotificationService.ShowWarningAsync(friendlyMessage, "æ“ä½œé™åˆ¶");
            return;
        }
        
        var wasEmpty = IsEmptyRow(item);
        
        if (string.IsNullOrEmpty(value))
        {
            item.ReceivedQuantity = 0;
        }
        else if (int.TryParse(value, out var quantity))
        {
            var returnedQty = GetReturnedQuantity(item);
            
            // æª¢æŸ¥æ˜¯å¦ä½æ–¼å·²é€€è²¨æ•¸é‡
            if (returnedQty > 0 && quantity < returnedQty)
            {
                await NotificationService.ShowWarningAsync(
                    $"é€²è²¨æ•¸é‡ä¸å¯ä½æ–¼å·²é€€è²¨æ•¸é‡ {returnedQty}",
                    "æ•¸é‡é™åˆ¶"
                );
                item.ReceivedQuantity = (int)returnedQty; // è‡ªå‹•èª¿æ•´ç‚ºæœ€å°å…è¨±å€¼
            }
            else
            {
                item.ReceivedQuantity = quantity;
            }
        }
        
        AutoEmptyRowHelper.ForAny<ReceivingItem>.HandleInputChange(
            ReceivingItems, item, IsEmptyRow, CreateEmptyItem, wasEmpty, !IsEmptyRow(item));
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnWarehouseSelectionChanged(ReceivingItem item, string? warehouseIdStr)
    {
        if (IsReadOnly) return;
        
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹ï¼ˆé€€è²¨è¨˜éŒ„æˆ–æ²–æ¬¾è¨˜éŒ„é™åˆ¶ï¼‰
        if (!CanDeleteItem(item, out string reason))
        {
            // ä½¿ç”¨æ›´å‹å–„çš„è¨Šæ¯
            var friendlyMessage = HasReturnRecord(item) 
                ? "æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹å€‰åº«è¨­å®š" 
                : "æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹å€‰åº«è¨­å®š";
            
            await NotificationService.ShowWarningAsync(
                friendlyMessage, 
                "æ“ä½œé™åˆ¶"
            );
            return;
        }
        
        var wasEmpty = IsEmptyRow(item);
        
        if (string.IsNullOrEmpty(warehouseIdStr) || !int.TryParse(warehouseIdStr, out var warehouseId))
        {
            item.SelectedWarehouse = null;
        }
        else
        {
            item.SelectedWarehouse = Warehouses.FirstOrDefault(w => w.Id == warehouseId);
        }
        
        item.SelectedWarehouseLocation = null;
        
        AutoEmptyRowHelper.ForAny<ReceivingItem>.HandleInputChange(
            ReceivingItems, item, IsEmptyRow, CreateEmptyItem, wasEmpty, !IsEmptyRow(item));
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnWarehouseLocationSelectionChanged(ReceivingItem item, string? warehouseLocationIdStr)
    {
        if (IsReadOnly) return;
        
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹ï¼ˆé€€è²¨è¨˜éŒ„æˆ–æ²–æ¬¾è¨˜éŒ„é™åˆ¶ï¼‰
        if (!CanDeleteItem(item, out string reason))
        {
            // ä½¿ç”¨æ›´å‹å–„çš„è¨Šæ¯
            var friendlyMessage = HasReturnRecord(item) 
                ? "æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹åº«ä½è¨­å®š" 
                : "æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹åº«ä½è¨­å®š";
            
            await NotificationService.ShowWarningAsync(
                friendlyMessage, 
                "æ“ä½œé™åˆ¶"
            );
            return;
        }
        
        var wasEmpty = IsEmptyRow(item);
        
        if (string.IsNullOrEmpty(warehouseLocationIdStr) || !int.TryParse(warehouseLocationIdStr, out var warehouseLocationId))
        {
            item.SelectedWarehouseLocation = null;
        }
        else
        {
            item.SelectedWarehouseLocation = WarehouseLocations.FirstOrDefault(wl => wl.Id == warehouseLocationId);
        }
        
        AutoEmptyRowHelper.ForAny<ReceivingItem>.HandleInputChange(
            ReceivingItems, item, IsEmptyRow, CreateEmptyItem, wasEmpty, !IsEmptyRow(item));
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnRemarksInput(ReceivingItem item, string? value)
    {
        var wasEmpty = IsEmptyRow(item);
        item.Remarks = value ?? string.Empty;
        
        AutoEmptyRowHelper.ForAny<ReceivingItem>.HandleInputChange(
            ReceivingItems, item, IsEmptyRow, CreateEmptyItem, wasEmpty, !IsEmptyRow(item));
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    public async Task RemoveItemAsync(int index)
    {
        if (IsReadOnly || index < 0 || index >= ReceivingItems.Count) return;
        
        var removedItem = ReceivingItems[index];
        
        // è¨˜éŒ„è¦åˆªé™¤çš„è³‡æ–™åº«å¯¦é«”ID
        if (removedItem.ExistingDetailEntity != null)
        {
            var entityId = GetExistingDetailId(removedItem.ExistingDetailEntity);
            if (entityId > 0)
            {
                _deletedDetailIds.Add(entityId);
            }
        }
        
        // é€šçŸ¥çˆ¶çµ„ä»¶é …ç›®å³å°‡è¢«ç§»é™¤
        if (OnItemRemoved.HasDelegate)
        {
            await OnItemRemoved.InvokeAsync(removedItem);
        }
        
        AutoEmptyRowHelper.ForAny<ReceivingItem>.HandleItemRemove(
            ReceivingItems, removedItem, IsEmptyRow, CreateEmptyItem);
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    /// <summary>
    /// å–å¾—ç¾æœ‰æ˜ç´°å¯¦é«”çš„ID
    /// </summary>
    private int GetExistingDetailId(TDetailEntity entity)
    {
        if (entity == null) return 0;
        
        // å‡è¨­æ‰€æœ‰çš„ BaseEntity éƒ½æœ‰ Id å±¬æ€§
        var idProperty = entity.GetType().GetProperty("Id");
        if (idProperty != null && idProperty.PropertyType == typeof(int))
        {
            var value = idProperty.GetValue(entity);
            return value != null ? (int)value : 0;
        }
        
        return 0;
    }

    private List<Product> GetAvailableProducts()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
        {
            return new List<Product>();
        }
        
        // è¿”å›å»é‡å¾Œçš„å•†å“æ¸…å–®ï¼Œä½†ä¿ç•™æ¡è³¼æ˜ç´°è³‡è¨Šä¾›å¾ŒçºŒä½¿ç”¨
        return AvailableProducts;
    }
    
    /// <summary>
    /// å–å¾—å¯ç”¨çš„æ¡è³¼æ˜ç´°æ¸…å–®ï¼ˆæ”¯æ´ä¸‰å±¤ç¯©é¸ï¼šå» å•†->æ¡è³¼å–®->å•†å“ï¼‰
    /// </summary>
    private List<PurchaseOrderDetail> GetAvailablePurchaseDetails()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
        {
            return new List<PurchaseOrderDetail>();
        }
        
        var filteredDetails = AvailablePurchaseDetails.AsEnumerable();
        
        // ç¬¬äºŒå±¤ç¯©é¸ï¼šæ¡è³¼å–®
        if (SelectedPurchaseOrderId.HasValue && SelectedPurchaseOrderId.Value > 0)
        {
            filteredDetails = filteredDetails.Where(pd => pd.PurchaseOrderId == SelectedPurchaseOrderId.Value);
        }
        
        // ç¬¬ä¸‰å±¤ç¯©é¸ï¼šå•†å“
        if (FilterProductId.HasValue && FilterProductId.Value > 0)
        {
            filteredDetails = filteredDetails.Where(pd => pd.ProductId == FilterProductId.Value);
        }
        
        return filteredDetails.ToList();
    }

    // ===== æ–°å¢ï¼šè¼‰å…¥æ‰€æœ‰æœªå…¥åº«ç›¸é—œæ–¹æ³• =====
    
    /// <summary>
    /// ç²å–ç•¶å‰ç¯©é¸ç‹€æ…‹çš„æè¿°è³‡è¨Š
    /// </summary>
    private string GetCurrentFilterInfo()
    {
        var filters = new List<string>();
        
        if (SelectedPurchaseOrderId.HasValue)
        {
            filters.Add("å·²ç¯©é¸æ¡è³¼å–®");
        }
        
        if (FilterProductId.HasValue)
        {
            var product = AvailableProducts.FirstOrDefault(p => p.Id == FilterProductId.Value);
            if (product != null)
            {
                filters.Add($"å·²ç¯©é¸ç”¢å“ï¼š{product.Name}");
            }
        }
        
        return filters.Any() ? $"ï¼ˆ{string.Join("ï¼Œ", filters)}ï¼‰" : "";
    }

    /// <summary>
    /// ç²å–é è¨­å€‰åº«ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
    /// </summary>
    private Warehouse? GetDefaultWarehouse(PurchaseOrderDetail? purchaseDetail = null)
    {
        // å„ªå…ˆä½¿ç”¨æ¡è³¼å–®æŒ‡å®šçš„å€‰åº«
        if (purchaseDetail?.PurchaseOrder?.Warehouse != null)
        {
            return purchaseDetail.PurchaseOrder.Warehouse;
        }
        
        // å¦‚æœåªæœ‰ä¸€å€‹å€‰åº«ï¼Œè‡ªå‹•é¸æ“‡å®ƒ
        return Warehouses.Count == 1 ? Warehouses.First() : null;
    }

    /// <summary>
    /// ç²å–é è¨­åº«ä½ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
    /// </summary>
    private WarehouseLocation? GetDefaultWarehouseLocation(Warehouse? selectedWarehouse = null)
    {
        if (selectedWarehouse != null)
        {
            // å–å¾—è©²å€‰åº«çš„åº«ä½
            var warehouseLocations = WarehouseLocations.Where(wl => wl.WarehouseId == selectedWarehouse.Id).ToList();
            
            // å¦‚æœè©²å€‰åº«åªæœ‰ä¸€å€‹åº«ä½ï¼Œè‡ªå‹•é¸æ“‡å®ƒ
            if (warehouseLocations.Count == 1)
            {
                return warehouseLocations.First();
            }
        }
        
        // å¦‚æœå…¨ç³»çµ±åªæœ‰ä¸€å€‹åº«ä½ï¼Œè‡ªå‹•é¸æ“‡å®ƒ
        return WarehouseLocations.Count == 1 ? WarehouseLocations.First() : null;
    }

    /// <summary>
    /// é¡¯ç¤ºç¢ºèªå°è©±æ¡†
    /// </summary>
    private async Task<bool> ShowConfirmationAsync(string title, string message)
    {
        // æš«æ™‚ä½¿ç”¨ç°¡å–®çš„é€šçŸ¥ï¼Œç­‰å¾…ç¢ºèªå¾ŒåŸ·è¡Œ
        // åœ¨å¯¦éš›å°ˆæ¡ˆä¸­å¯èƒ½æœƒä½¿ç”¨æ›´ç²¾ç¾çš„å°è©±æ¡†çµ„ä»¶
        try 
        {
            // å…ˆé¡¯ç¤ºè­¦å‘Šè¨Šæ¯ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“å°‡è¦é€²è¡Œçš„æ“ä½œ
            await NotificationService.ShowWarningAsync($"{title}: {message}");
            return true; // æš«æ™‚ç›´æ¥è¿”å› trueï¼Œå¯¦éš›æ‡‰è©²å¯¦ä½œç¢ºèªå°è©±æ¡†
        }
        catch
        {
            return false;
        }
    }

    /// <summary>
    /// å…§éƒ¨æ–¹æ³•ï¼šè¼‰å…¥æœªå…¥åº«é …ç›®
    /// </summary>
    private async Task LoadUnreceivedItemsInternal(List<PurchaseOrderDetail> details)
    {
        try
        {
            // æ¸…ç©ºç¾æœ‰é …ç›®
            ReceivingItems.Clear();

            // è¼‰å…¥æ‰€æœ‰æœªå…¥åº«é …ç›®
            foreach (var detail in details)
            {
                // ç²å–è©²æ¡è³¼æ˜ç´°çš„é è¨­å€‰åº«
                var defaultWarehouse = GetDefaultWarehouse(detail);
                
                var receivingItem = new ReceivingItem
                {
                    SelectedPurchaseDetail = detail,
                    SelectedProduct = detail.Product,
                    ReceivedQuantity = detail.OrderQuantity - detail.ReceivedQuantity, // é å¡«å‰©é¤˜æ•¸é‡
                    UnitPrice = detail.UnitPrice,
                    
                    // ä½¿ç”¨æ¡è³¼å–®æŒ‡å®šçš„å€‰åº«ï¼Œæˆ–é è¨­å€‰åº«
                    SelectedWarehouse = defaultWarehouse,
                    SelectedWarehouseLocation = GetDefaultWarehouseLocation(defaultWarehouse)
                };
                
                // è‡ªå‹•è¼‰å…¥æœ€è¿‘é€²è²¨çš„å€‰åº«å’Œåº«ä½ï¼ˆå¦‚æœæ²’æœ‰é è¨­å€‰åº«çš„è©±ï¼‰
                if (receivingItem.SelectedWarehouse == null && detail.Product != null)
                {
                    var (warehouse, location) = await GetLastReceivingWarehouseAsync(detail.Product.Id);
                    if (warehouse != null)
                    {
                        receivingItem.SelectedWarehouse = warehouse;
                        if (location != null && receivingItem.SelectedWarehouseLocation == null)
                        {
                            receivingItem.SelectedWarehouseLocation = location;
                        }
                    }
                }

                ReceivingItems.Add(receivingItem);
            }

            // ç¢ºä¿æœ‰ä¸€å€‹ç©ºè¡Œ
            EnsureOneEmptyRow();
            
            // é€šçŸ¥è®Šæ›´
            await NotifyDetailsChanged();
            
            var filterInfo = GetCurrentFilterInfo();
            await NotificationService.ShowSuccessAsync(
                $"æˆåŠŸè¼‰å…¥ {details.Count} é …æœªå…¥åº«å•†å“{filterInfo}"
            );
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥æœªå…¥åº«å•†å“å¤±æ•—ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è¼‰å…¥æ‰€æœ‰æœªå…¥åº«å•†å“çš„ä¸»è¦æ–¹æ³•ï¼ˆå…¬é–‹æ–¹æ³•ï¼Œä¾›çˆ¶çµ„ä»¶èª¿ç”¨ï¼‰
    /// </summary>
    public async Task LoadAllUnreceivedItems()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
        {
            await NotificationService.ShowWarningAsync("è«‹å…ˆé¸æ“‡å» å•†å¾Œå†è¼‰å…¥æœªå…¥åº«å•†å“");
            return;
        }

        var availableDetails = GetAvailablePurchaseDetails();
        
        if (!availableDetails.Any())
        {
            var filterInfo = GetCurrentFilterInfo();
            await NotificationService.ShowInfoAsync($"ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æœªå…¥åº«å•†å“{filterInfo}");
            return;
        }

        // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰è³‡æ–™
        var hasExistingData = ReceivingItems.Any(item => !IsEmptyRow(item));
        
        if (hasExistingData)
        {
            // ä½¿ç”¨ç¢ºèªå°è©±æ¡†
            var confirmed = await ShowConfirmationAsync(
                "è¼‰å…¥ç¢ºèª", 
                $"æ­¤æ“ä½œå°‡æ¸…ç©ºç¾æœ‰çš„å…¥åº«æ˜ç´°ä¸¦è¼‰å…¥ {availableDetails.Count} é …æœªå…¥åº«å•†å“ã€‚\n\næ˜¯å¦ç¹¼çºŒï¼Ÿ"
            );
            
            if (!confirmed) return;
        }

        await LoadUnreceivedItemsInternal(availableDetails);
    }


    private decimal GetTotalAmount()
    {
        return ReceivingItems
            .Where(item => !IsEmptyRow(item) && item.SelectedPurchaseDetail != null && item.ReceivedQuantity > 0)
            .Sum(item => item.ReceivedQuantity * item.UnitPrice);
    }

    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        if (!AutoEmptyRowHelper.ForAny<ReceivingItem>.HasSufficientItems(ReceivingItems, IsEmptyRow, 1))
        {
            errors.Add("è‡³å°‘éœ€è¦ä¸€å€‹å…¥åº«å•†å“");
        }
        else
        {
            var nonEmptyItems = AutoEmptyRowHelper.ForAny<ReceivingItem>.GetNonEmptyItems(ReceivingItems, IsEmptyRow);
            
            // ğŸ”‘ æ–°å¢ï¼šæª¢æŸ¥æ˜ç´°æ˜¯å¦å·²å¯©æ ¸ï¼ˆå¦‚æœå•Ÿç”¨å¯©æ ¸ï¼‰
            if (IsApprovalEnabled)
            {
                var unapprovedItems = nonEmptyItems
                    .Where(item => item.SelectedPurchaseDetail != null && 
                                  !(item.SelectedPurchaseDetail.PurchaseOrder?.IsApproved ?? false))
                    .ToList();
                
                if (unapprovedItems.Any())
                {
                    var productNames = unapprovedItems
                        .Select(item => {
                            var productName = item.SelectedProduct?.Name ?? item.DisplayName;
                            var poNumber = item.SelectedPurchaseDetail?.PurchaseOrder?.Code ?? "N/A";
                            return $"â€¢ {productName} (æ¡è³¼å–®: {poNumber})";
                        })
                        .ToList();
                    
                    errors.Add($"ä»¥ä¸‹å•†å“ä¾†è‡ªæœªå¯©æ ¸çš„æ¡è³¼å–®ï¼Œç„¡æ³•å„²å­˜ï¼š\n{string.Join("\n", productNames)}\n\nè«‹å…ˆå®Œæˆç›¸é—œæ¡è³¼å–®çš„å¯©æ ¸ä½œæ¥­ã€‚");
                }
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰é¸æ“‡å€‰åº«ï¼ˆå¦‚æœå•Ÿç”¨å€‰åº«åŠŸèƒ½ï¼‰
            if (ShowWarehouse)
            {
                var itemsWithoutWarehouse = nonEmptyItems.Where(item => item.SelectedWarehouse == null).ToList();
                if (itemsWithoutWarehouse.Any())
                {
                    var productNames = itemsWithoutWarehouse
                        .Select(item => item.SelectedProduct?.Name ?? item.DisplayName)
                        .Where(name => !string.IsNullOrEmpty(name))
                        .ToList();
                    
                    if (productNames.Any())
                    {
                        errors.Add($"ä»¥ä¸‹å•†å“å¿…é ˆé¸æ“‡å€‰åº«ï¼š{string.Join("ã€", productNames)}");
                    }
                    else
                    {
                        errors.Add("æ‰€æœ‰å•†å“éƒ½å¿…é ˆé¸æ“‡å€‰åº«");
                    }
                }
            }
            
            // æª¢æŸ¥é€€è²¨æ•¸é‡é™åˆ¶
            foreach (var item in nonEmptyItems)
            {
                var returnedQty = GetReturnedQuantity(item);
                if (returnedQty > 0 && item.ReceivedQuantity < returnedQty)
                {
                    var productName = item.SelectedProduct?.Name ?? item.DisplayName;
                    errors.Add($"å•†å“ã€Œ{productName}ã€çš„é€²è²¨æ•¸é‡ {item.ReceivedQuantity} ä¸å¯ä½æ–¼å·²é€€è²¨æ•¸é‡ {returnedQty}");
                }
            }
        }
          
        if (errors.Any())
        {
            var errorMessage = string.Join("\n\n", errors);
            await NotificationService.ShowErrorAsync(errorMessage);
            return false;
        }
        
        return true;
    }

    public class ReceivingItem
    {
        public Product? SelectedProduct { get; set; }
        public int ReceivedQuantity { get; set; } = 0;
        public decimal UnitPrice { get; set; } = 0;
        public string Remarks { get; set; } = string.Empty;
        public Warehouse? SelectedWarehouse { get; set; }
        public WarehouseLocation? SelectedWarehouseLocation { get; set; }
        public TDetailEntity? ExistingDetailEntity { get; set; }
        
        // === æ¡è³¼æ˜ç´°ç›¸é—œå±¬æ€§ ===
        public PurchaseOrderDetail? SelectedPurchaseDetail { get; set; }
        
        // === æ¡è³¼å–®ç›¸é—œè³‡è¨Šï¼ˆå¾é¸ä¸­çš„æ¡è³¼æ˜ç´°ä¸­ç²å–ï¼‰ ===
        public string? PurchaseOrderNumber => SelectedPurchaseDetail?.PurchaseOrder?.Code;
        public int? PurchaseOrderDetailId => SelectedPurchaseDetail?.Id;
        public int? PurchaseOrderId => SelectedPurchaseDetail?.PurchaseOrderId;
        public int OrderQuantity => SelectedPurchaseDetail?.OrderQuantity ?? 0;
        public int PreviousReceivedQuantity => SelectedPurchaseDetail?.ReceivedQuantity ?? 0;
        public int PendingQuantity => OrderQuantity - PreviousReceivedQuantity;
        
        /// <summary>
        /// å–å¾—é¡¯ç¤ºç”¨çš„å•†å“åç¨±
        /// </summary>
        public string DisplayName => 
            SelectedPurchaseDetail?.Product != null
                ? $"[{SelectedPurchaseDetail.Product.Code}] {SelectedPurchaseDetail.Product.Name}"
                : SelectedProduct != null 
                    ? $"[{SelectedProduct.Code}] {SelectedProduct.Name}" 
                    : "";
    }
}
