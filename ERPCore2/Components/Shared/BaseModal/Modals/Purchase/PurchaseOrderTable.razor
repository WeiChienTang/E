@* 備份檔案 - 2025-01-11 *@
@* 採購單商品管理組件 - 使用 InteractiveTableComponent 統一UI 並整合自動空行功能 *@

@using ERPCore2.Helpers
@using ERPCore2.Data.Enums
@inject IProductService ProductService
@inject IPurchaseOrderDetailService PurchaseOrderDetailService
@inject ISystemParameterService SystemParameterService
@inject INotificationService NotificationService
@inject RelatedDocumentsHelper RelatedDocumentsHelper
@inject AuthenticationStateProvider AuthenticationStateProvider

@typeparam TMainEntity where TMainEntity : BaseEntity
@typeparam TDetailEntity where TDetailEntity : BaseEntity, new()

@if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="supplier-warning">
                <p class="text-muted">選擇廠商後即可查看該廠商的未完成進貨商品</p>
            </div>
        </div>
    </div>
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">        
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="ProductItem" 
                                      Items="@ProductItems"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"
                                      ShowRowNumbers="false"
                                      EmptyMessage="尚未新增商品"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="false"
                                      ActionsColumnWidth = "60px"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"
                                      OnItemDelete="@HandleItemDelete"
                                      EnableAutoEmptyRow="true"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@(() => new ProductItem())" />
        </div>
        
        <div class="card-footer">
            <div class="d-flex justify-content-between">
                <div>
                    <GenericButtonComponent Text="智能下單"
                                          Variant="ButtonVariant.Primary"
                                          Icon="fas fa-magic"
                                          OnClick="SmartPurchaseOrder"
                                          IsDisabled="@(!CanUseSmartPurchase)" />
                </div>
                <div class="d-flex gap-2">
                    <GenericButtonComponent Text="清除明細"
                                          Variant="ButtonVariant.Danger"
                                          OnClick="ClearAllDetails" />
                </div>
            </div>
        </div>
    </div>
}

<!-- 相關單據查看 Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

@code {
    // ===== 基本參數 =====
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public EventCallback<List<ProductItem>> OnProductItemsChanged { get; set; }
    
    // ===== 新增供應商過濾參數 =====
    [Parameter] public int? SelectedSupplierId { get; set; }
    
    // ===== 泛型參數 =====
    [Parameter] public TMainEntity? MainEntity { get; set; }
    [Parameter] public List<TDetailEntity> ExistingDetails { get; set; } = new List<TDetailEntity>();
    [Parameter] public EventCallback<List<TDetailEntity>> OnDetailsChanged { get; set; }
    
    // ===== 欄位映射參數 =====
    [Parameter] public string MainEntityIdPropertyName { get; set; } = string.Empty;
    [Parameter] public string QuantityPropertyName { get; set; } = "Quantity";
    [Parameter] public string ReceivedQuantityPropertyName { get; set; } = "ReceivedQuantity";
    [Parameter] public string UnitPricePropertyName { get; set; } = "UnitPrice";
    [Parameter] public string RemarksPropertyName { get; set; } = "Remarks";
    [Parameter] public string? UnitIdPropertyName { get; set; }
    [Parameter] public string? IsReceivingCompletedPropertyName { get; set; }        
    
    // ===== 唯讀模式參數 =====
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== 核准狀態參數 =====
    [Parameter] public bool IsApproved { get; set; } = false;
    
    // ===== 不可刪除明細狀態變更事件 =====
    [Parameter] public EventCallback<bool> OnHasUndeletableDetailsChanged { get; set; }
    
    // ===== 相關單據開啟事件 =====
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }
    
    // ===== 稅率算法參數 =====
    [Parameter] public TaxCalculationMethod TaxCalculationMethod { get; set; } = TaxCalculationMethod.TaxExclusive;
    
    // ===== 稅率算法輔助屬性 =====
    private bool IsTaxCalculationMethodNoTax => TaxCalculationMethod == TaxCalculationMethod.NoTax;

    // ===== InteractiveTableComponent 參考 =====
    private InteractiveTableComponent<ProductItem>? tableComponent;

    private List<ProductItem> ProductItems { get; set; } = new List<ProductItem>();
    private int? _previousSelectedSupplierId = null;
    
    // ===== 資料載入狀態控制 =====
    private bool _dataLoadCompleted = true;  // 資料載入完成標記
    
    // ===== 相關單據查看 =====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;

    protected override async Task OnInitializedAsync()
    {
        // 初始化時記錄當前供應商ID，避免 OnParametersSetAsync 誤判為變更
        _previousSelectedSupplierId = SelectedSupplierId;
        
        await LoadExistingDetailsAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        
        // 檢查供應商是否變更
        if (_previousSelectedSupplierId != SelectedSupplierId)
        {
            _previousSelectedSupplierId = SelectedSupplierId;
            
            // 如果更換供應商，需要清空現有選項並重新載入
            ProductItems.Clear();
            await LoadExistingDetailsAsync();
            return; // 供應商變更時已經處理完畢，直接返回
        }
    }

    // ===== InteractiveTableComponent 方法 =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        //  商品選擇欄位 - 觸發欄位（第一個欄位預設為觸發欄位）
        columns.Add(new() 
        { 
            Title = "商品編號/名稱", 
            PropertyName = "ProductSearchValue",
            EmptyCheckPropertyName = "SelectedProduct",  // 檢查 SelectedProduct 物件
            TriggerEmptyRowOnFilled = true,  // 選擇商品後自動新增空行
            ColumnType = InteractiveColumnType.SearchableSelect,
            Width = "250px",
            Tooltip = "搜尋並選擇商品（輸入編號或名稱）。已有進貨記錄的商品將無法變更",
            Placeholder = "請輸入商品編號或名稱",
            SearchValuePropertyName = nameof(ProductItem.ProductSearchValue),
            FilteredItemsPropertyName = nameof(ProductItem.FilteredProducts),
            ShowDropdownPropertyName = nameof(ProductItem.ShowProductDropdown),
            SelectedIndexPropertyName = nameof(ProductItem.ProductSelectedIndex),
            ItemDisplayFormatter = (item) =>
            {
                var product = (Product)item;
                return $"[{product.Code}] {product.Name}";
            },
            IsDisabledFunc = item =>
            {
                var productItem = (ProductItem)item;
                return IsReadOnly || !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true);
            },
            TooltipFunc = item =>
            {
                var productItem = (ProductItem)item;
                return !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true) 
                    ? "此商品已有進貨記錄，無法修改商品選擇" : null;
            },
            OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, (tuple) =>
            {
                var (item, searchValue) = tuple;
                OnProductSearchChanged((ProductItem)item, searchValue);
            }),
            OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
            {
                var (item, selectedItem) = tuple;
                await OnProductSelected((ProductItem)item, (Product?)selectedItem);
            }),
            OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
            {
                var productItem = (ProductItem)item;
                var availableProducts = GetAvailableProducts();
                productItem.FilteredProducts = availableProducts.Take(20).ToList();
                productItem.ShowProductDropdown = true;
                productItem.ProductSelectedIndex = -1;
                StateHasChanged();
            }),
            OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
            {
                Task.Delay(200).ContinueWith(_ =>
                {
                    var productItem = (ProductItem)item;
                    productItem.ShowProductDropdown = false;
                    InvokeAsync(StateHasChanged);
                });
            }),
            EnableKeyboardNavigation = true,
            GetDropdownItems = (item) => ((ProductItem)item).FilteredProducts,
            GetSelectedIndex = (item) => ((ProductItem)item).ProductSelectedIndex,
            SetSelectedIndex = (item, index) => ((ProductItem)item).ProductSelectedIndex = index,
            GetShowDropdown = (item) => ((ProductItem)item).ShowProductDropdown,
            SetShowDropdown = (item, show) => ((ProductItem)item).ShowProductDropdown = show,
            MaxDisplayItems = 20
        });
        
        // 數量欄位
        columns.Add(new() 
        { 
            Title = "數量", 
            PropertyName = "Quantity",
            ColumnType = InteractiveColumnType.Number,
            Width = "80px",
            Tooltip = "採購的商品數量。已有進貨記錄的商品將無法修改數量",
            IsDisabledFunc = item =>
            {
                var productItem = (ProductItem)item;
                return !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true);
            },
            TooltipFunc = item =>
            {
                var productItem = (ProductItem)item;
                return !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true) 
                    ? "此商品已有進貨記錄，無法修改數量" : null;
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnQuantityInput((ProductItem)item, valueString);
            })
        });

        // 入庫量欄位 (只讀)
        columns.Add(new() 
        { 
            Title = "已入庫", 
            PropertyName = "ReceivedQuantity",
            ColumnType = InteractiveColumnType.Display,
            Width = "80px",
            Tooltip = "已入庫的累計數量（唯讀）",
            TextAlign = "right",
            IsReadOnly = true
        });

        // 單價欄位
        columns.Add(new() 
        { 
            Title = "單價", 
            PropertyName = "Price",
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            Tooltip = "商品的採購單價。已有進貨記錄的商品將無法修改單價",
            IsDisabledFunc = item =>
            {
                var productItem = (ProductItem)item;
                return !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true);
            },
            TooltipFunc = item =>
            {
                var productItem = (ProductItem)item;
                return !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true) 
                    ? "此商品已有進貨記錄，無法修改單價" : null;
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnPriceInput((ProductItem)item, valueString);
            })
        });

        // 稅率欄位（可編輯）
        columns.Add(new()
        {
            Title = "稅率%",
            PropertyName = "TaxRate",
            ColumnType = InteractiveColumnType.Number,
            Width = "80px",
            Tooltip = "商品的稅率（0% ~ 100%），可手動調整。當主檔選擇免稅時此欄位將被禁用",
            IsDisabledFunc = item =>
            {
                var productItem = (ProductItem)item;
                // 當主檔選擇免稅時，禁用稅率欄位
                return IsReadOnly || IsTaxCalculationMethodNoTax || 
                       !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true);
            },
            TooltipFunc = item =>
            {
                var productItem = (ProductItem)item;
                if (IsTaxCalculationMethodNoTax) return "主檔已選擇免稅，此欄位已停用";
                if (!DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true))
                    return "此商品已有進貨記錄，無法修改稅率";
                return null;
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnTaxRateInput((ProductItem)item, valueString);
            })
        });

        // 小計欄位（根據稅率算法顯示）
        columns.Add(new()
        {
            Title = "小計",
            Tooltip = GetSubtotalTooltip(),
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item =>
            {
                var productItem = (ProductItem)item;
                var subtotal = CalculateItemSubtotal(productItem);
                var displayValue = NumberFormatHelper.FormatSmartZeroAsEmpty(subtotal);
                return @<div class="text-end fw-bold text-success">@displayValue</div>;
            }
        });

        // 完成進貨欄位
        columns.Add(new() 
        { 
            Title = "結清", 
            PropertyName = "IsReceivingCompleted",
            ColumnType = InteractiveColumnType.Checkbox,
            Width = "40px",
            Tooltip = "手動標記此商品已完成所有進貨作業（即使數量未完全入庫）\n核准後仍可修改此狀態",
            IsDisabledFunc = item =>
            {
                var productItem = (ProductItem)item;
                // 檢查是否已經完全進貨（入庫 >= 採購）
                var isFullyReceived = productItem.ReceivedQuantity >= productItem.Quantity;
                // 如果已完全進貨且已標記完成，則禁用（不能取消）
                return IsReadOnly || (isFullyReceived && productItem.IsReceivingCompleted);
            },
            TooltipFunc = item =>
            {
                var productItem = (ProductItem)item;
                var isFullyReceived = productItem.ReceivedQuantity >= productItem.Quantity;
                if (isFullyReceived && productItem.IsReceivingCompleted)
                    return "已完全進貨，無法取消";
                return null;
            },
            OnCheckboxChanged = EventCallback.Factory.Create<(object, bool)>(this, async args =>
            {
                var (item, newValue) = args;
                await OnIsReceivingCompletedChanged((ProductItem)item, newValue);
            })
        });

        // 備註欄位 - 核准後仍可編輯（用於記錄執行狀況）
        columns.Add(new() 
        { 
            Title = "備註", 
            PropertyName = "Remarks",
            ColumnType = InteractiveColumnType.Custom,
            Width = "300px",
            HideOnMobile = true,
            ExcludeFromEmptyCheck = true,  // 備註不參與空行檢查
            Tooltip = "選填。可記錄採購相關的備註資訊（核准後仍可編輯）",
            CustomTemplate = item => 
            {
                var productItem = (ProductItem)item;
                // 銷貨 備註欄位只受 IsReadOnly 影響，核准後仍可編輯
                var isFieldReadOnly = IsReadOnly;
                
                // 如果是唯讀狀態，直接顯示 span
                if (isFieldReadOnly)
                {
                    var displayText = string.IsNullOrEmpty(productItem.Remarks) ? "無備註" : productItem.Remarks;
                    return @<div class="d-flex align-items-center" style="min-height: 31px;">
                        <span class="text-muted">@displayText</span>
                    </div>;
                }
                
                return @<input type="text" class="form-control " 
                               value="@productItem.Remarks"
                               @oninput="(e) => OnRemarksInput(productItem, e.Value?.ToString())"
                               placeholder="選填..." />;
            }
        });

        return columns;
    }

    private RenderFragment<ProductItem> GetCustomActionsTemplate => item => __builder =>
    {
        // 使用 DetailLockHelper 檢查是否可以刪除
        if (DetailLockHelper.CanDeleteItem(item, out _, checkReceiving: true))
        {
            // 可以刪除：顯示刪除按鈕
            <GenericButtonComponent Variant="ButtonVariant.Danger"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="@IsReadOnly"
                                   Title="刪除"
                                   OnClick="async () => await HandleItemDelete(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else
        {
            // 已被使用：顯示查看按鈕
            <GenericButtonComponent Variant="ButtonVariant.Info"
                                   IconClass="bi bi-eye text-white"
                                   Size="ButtonSize.Large"
                                   Title="查看相關單據"
                                   OnClick="async () => await ShowRelatedDocuments(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
    };

    private async Task HandleItemDelete(ProductItem item)
    {
        var index = ProductItems.IndexOf(item);
        await RemoveItemAsync(index);
    }

    // ===== 內部方法 =====

    /// <summary>
    /// 公開方法：刷新明細資料（供父組件呼叫）
    /// 用於子單據儲存後，重新載入明細以更新相關數量（如入庫量）
    /// 
    /// 使用場景：
    /// - 進貨單儲存後，刷新採購單明細的「入庫量」
    /// - 確保 UI 顯示最新的資料狀態
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadExistingDetailsAsync();
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }

    /// <summary>
    /// 從現有明細資料載入到 ProductItems
    /// </summary>
    private async Task LoadExistingDetailsAsync()
    {
        if (ExistingDetails?.Any() != true) 
        {
            return;
        }

        //  開始載入資料 - 設定為未完成
        _dataLoadCompleted = false;
        
        ProductItems.Clear();
        
        foreach (var detail in ExistingDetails)
        {
            var productId = GetPropertyValue<int>(detail, "ProductId");
            var product = Products.FirstOrDefault(p => p.Id == productId);
            
            if (product != null)
            {
                var taxRate = GetPropertyValue<decimal?>(detail, "TaxRate");
                var item = new ProductItem
                {
                    SelectedProduct = product,
                    SelectedProductId = productId,  //  同步設定 ID
                    ProductSearchValue = $"[{product.Code}] {product.Name}",  // 設定搜尋顯示值
                    Quantity = Convert.ToInt32(GetPropertyValue<object>(detail, QuantityPropertyName) ?? 0),
                    ReceivedQuantity = Convert.ToInt32(GetPropertyValue<object>(detail, ReceivedQuantityPropertyName) ?? 0),
                    Price = Convert.ToDecimal(GetPropertyValue<object>(detail, UnitPricePropertyName) ?? 0m),
                    TaxRate = taxRate ?? await SystemParameterService.GetTaxRateAsync(),
                    Remarks = GetPropertyValue<string>(detail, RemarksPropertyName) ?? string.Empty,
                    IsReceivingCompleted = !string.IsNullOrEmpty(IsReceivingCompletedPropertyName) ? 
                        Convert.ToBoolean(GetPropertyValue<object>(detail, IsReceivingCompletedPropertyName) ?? false) : false,
                    CompletedByEmployeeId = GetPropertyValue<int?>(detail, "CompletedByEmployeeId"),
                    CompletedAt = GetPropertyValue<DateTime?>(detail, "CompletedAt"),
                    ExistingDetailEntity = detail
                };
                
                // 檢查是否已被入庫單使用
                item.HasUsageRecordCache = await HasUsageRecord(item);
                
                ProductItems.Add(item);
            }
        }
        
        //  資料載入完成 - 觸發空行檢查
        _dataLoadCompleted = true;
        StateHasChanged();
    }

    /// <summary>
    /// 轉換 ProductItems 為明細實體列表
    /// </summary>
    private List<TDetailEntity> ConvertToDetailEntities()
    {
        var details = new List<TDetailEntity>();
        
        // 只轉換有選擇商品的項目（排除空行）
        foreach (var item in ProductItems.Where(x => x.SelectedProduct != null))
        {
            TDetailEntity detail;
            
            if (item.ExistingDetailEntity != null)
            {
                detail = item.ExistingDetailEntity;
            }
            else
            {
                detail = new TDetailEntity();
                
                if (MainEntity != null && !string.IsNullOrEmpty(MainEntityIdPropertyName))
                {
                    SetPropertyValue(detail, MainEntityIdPropertyName, MainEntity.Id);
                }
            }
            
            // 無論是新增或編輯，都要更新 ProductId（允許更換商品）
            if (item.SelectedProduct != null)
            {
                SetPropertyValue(detail, "ProductId", item.SelectedProduct.Id);
            }
            
            SetPropertyValue(detail, QuantityPropertyName, item.Quantity);
            SetPropertyValue(detail, ReceivedQuantityPropertyName, item.ReceivedQuantity);
            SetPropertyValue(detail, UnitPricePropertyName, item.Price);
            SetPropertyValue(detail, "TaxRate", item.TaxRate);
            SetPropertyValue(detail, RemarksPropertyName, item.Remarks);
            
            if (!string.IsNullOrEmpty(IsReceivingCompletedPropertyName))
            {
                SetPropertyValue(detail, IsReceivingCompletedPropertyName, item.IsReceivingCompleted);
            }
            
            // 儲存完成進貨的追蹤資料
            SetPropertyValue(detail, "CompletedByEmployeeId", item.CompletedByEmployeeId);
            SetPropertyValue(detail, "CompletedAt", item.CompletedAt);
            
            details.Add(detail);
        }
        
        return details;
    }

    /// <summary>
    /// 直接通知詳細資料變更 - 參考 ProductSupplierManagerComponent 的簡潔寫法
    /// </summary>
    private async Task NotifyDetailsChanged()
    {
        var details = ConvertToDetailEntities();
        await OnDetailsChanged.InvokeAsync(details);
        
        // 檢查是否有不可刪除的明細(已有進貨記錄)
        bool hasUndeletableDetails = ProductItems.Any(p => !DetailLockHelper.CanDeleteItem(p, out _, checkReceiving: true));
        await OnHasUndeletableDetailsChanged.InvokeAsync(hasUndeletableDetails);
    }

    /// <summary>
    /// 使用反射取得屬性值
    /// </summary>
    private T? GetPropertyValue<T>(object obj, string propertyName)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property == null) return default(T);
        
        var value = property.GetValue(obj);
        if (value == null) return default(T);
        
        if (typeof(T) == typeof(object)) return (T)value;
        
        // 銷貨 修復：處理 nullable 類型的轉換
        var targetType = typeof(T);
        
        // 如果目標類型是 nullable，取得其底層類型
        if (targetType.IsGenericType && targetType.GetGenericTypeDefinition() == typeof(Nullable<>))
        {
            var underlyingType = Nullable.GetUnderlyingType(targetType);
            if (underlyingType != null)
            {
                // 轉換為底層類型，然後讓 C# 自動裝箱為 nullable
                var convertedValue = Convert.ChangeType(value, underlyingType);
                return (T)convertedValue;
            }
        }
        
        return (T)Convert.ChangeType(value, targetType);
    }

    /// <summary>
    /// 使用反射設定屬性值
    /// </summary>
    private void SetPropertyValue(object obj, string propertyName, object? value)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property != null && property.CanWrite)
        {
            if (value != null && property.PropertyType != value.GetType())
            {
                if (property.PropertyType.IsGenericType && property.PropertyType.GetGenericTypeDefinition() == typeof(Nullable<>))
                {
                    var underlyingType = Nullable.GetUnderlyingType(property.PropertyType);
                    value = Convert.ChangeType(value, underlyingType!);
                }
                else
                {
                    value = Convert.ChangeType(value, property.PropertyType);
                }
            }
            property.SetValue(obj, value);
        }
    }

    // ===== 商品選擇事件處理 =====

    /// <summary>
    /// 商品搜尋輸入變更事件（SearchableSelect）
    /// </summary>
    private void OnProductSearchChanged(ProductItem item, string? searchValue)
    {
        item.ProductSearchValue = searchValue ?? string.Empty;
        
        var availableProducts = GetAvailableProducts();
        
        // 只在第一次搜尋時輸出調試信息
        if (string.IsNullOrWhiteSpace(searchValue) && availableProducts.Any())
        {
            ConsoleHelper.WriteInfo($"可用商品數量: {availableProducts.Count}");
            var firstProduct = availableProducts.First();
            ConsoleHelper.WriteInfo($"第一個商品範例: [{firstProduct.Code}] {firstProduct.Name}, TaxRate = {(firstProduct.TaxRate.HasValue ? firstProduct.TaxRate.Value.ToString() : "null")}");
        }
        
        if (string.IsNullOrWhiteSpace(searchValue))
        {
            // 空白搜尋：顯示前20筆
            item.FilteredProducts = availableProducts.Take(20).ToList();
        }
        else
        {
            // 篩選符合的商品（編號或名稱包含搜尋字串）
            item.FilteredProducts = availableProducts
                .Where(p => (p.Code?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                           (p.Name?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false))
                .Take(20)
                .ToList();
        }
        
        item.ShowProductDropdown = true;
        item.ProductSelectedIndex = -1;
        StateHasChanged();
    }
    
    /// <summary>
    /// 商品選擇事件（SearchableSelect）
    /// </summary>
    private async Task OnProductSelected(ProductItem item, Product? selectedProduct)
    {
        if (selectedProduct != null)
        {
            ConsoleHelper.WriteTitle("OnProductSelected - 商品選擇事件");
            ConsoleHelper.WriteInfo($"選擇的商品: [{selectedProduct.Code}] {selectedProduct.Name}");
            ConsoleHelper.WriteInfo($"商品的 TaxRate 屬性值: {(selectedProduct.TaxRate.HasValue ? selectedProduct.TaxRate.Value.ToString() : "null")}");
            
            item.SelectedProduct = selectedProduct;
            item.SelectedProductId = selectedProduct.Id;
            item.ProductSearchValue = $"[{selectedProduct.Code}] {selectedProduct.Name}";
            
            // 優先使用商品的稅率，如果為 null 則從系統參數取得預設值
            if (selectedProduct.TaxRate.HasValue)
            {
                item.TaxRate = selectedProduct.TaxRate.Value;
                ConsoleHelper.WriteSuccess($"使用商品稅率: {item.TaxRate}%");
            }
            else
            {
                // 從系統參數取得預設稅率
                item.TaxRate = await SystemParameterService.GetTaxRateAsync();
                ConsoleHelper.WriteWarning($"商品稅率為 null，使用系統預設稅率: {item.TaxRate}%");
            }
            
            ConsoleHelper.WriteInfo($"最終 ProductItem.TaxRate = {item.TaxRate}");
            ConsoleHelper.WriteSeparator();
        }
        else
        {
            item.SelectedProduct = null;
            item.SelectedProductId = null;
            item.ProductSearchValue = string.Empty;
        }
        
        item.ShowProductDropdown = false;
        item.ProductSelectedIndex = -1;
        
        await NotifyDetailsChanged();
    }

    // ===== 欄位變更事件處理 =====

    private async Task OnQuantityInput(ProductItem item, string? value)
    {
        if (string.IsNullOrEmpty(value))
        {
            item.Quantity = 0;
        }
        else if (int.TryParse(value, out var quantity))
        {
            item.Quantity = quantity;
        }
        
        await NotifyDetailsChanged();
    }

    private async Task OnPriceInput(ProductItem item, string? value)
    {
        if (string.IsNullOrEmpty(value))
        {
            item.Price = 0;
        }
        else if (decimal.TryParse(value, out var price))
        {
            item.Price = price;
        }
        
        // 調試：顯示單價變更後的稅額計算
        if (item.SelectedProduct != null && item.Price > 0)
        {
            var taxAmount = item.Quantity * item.Price * (item.TaxRate / 100);
            ConsoleHelper.WriteInfo($"單價變更 - 商品: {item.SelectedProduct.Name}, 數量: {item.Quantity}, 單價: {item.Price}, 稅率: {item.TaxRate}%, 計算稅額: {taxAmount}");
        }
        
        await NotifyDetailsChanged();
    }

    private async Task OnTaxRateInput(ProductItem item, string? value)
    {
        if (string.IsNullOrEmpty(value))
        {
            item.TaxRate = 0;
        }
        else if (decimal.TryParse(value, out var taxRate))
        {
            // 限制範圍 0 ~ 100
            item.TaxRate = Math.Max(0, Math.Min(100, taxRate));
        }
        
        await NotifyDetailsChanged();
    }

    private async Task OnRemarksInput(ProductItem item, string? value)
    {
        item.Remarks = value ?? string.Empty;
        await NotifyDetailsChanged();
    }

    private async Task OnIsReceivingCompletedChanged(ProductItem item, bool newValue)
    {
        // 檢查是否已經完全進貨
        var isFullyReceived = item.ReceivedQuantity >= item.Quantity;
        
        // 如果已完全進貨且嘗試取消完成狀態，不允許
        if (isFullyReceived && item.IsReceivingCompleted && !newValue)
        {
            await NotificationService.ShowWarningAsync("此商品已全數入庫，無法取消完成狀態");
            return;
        }
        
        // 設定新狀態
        item.IsReceivingCompleted = newValue;
        
        // 記錄操作者和時間（只在標記為完成時記錄）
        if (newValue)
        {
            var currentUserId = await GetCurrentUserIdAsync();
            if (currentUserId.HasValue)
            {
                item.CompletedByEmployeeId = currentUserId.Value;
                item.CompletedAt = DateTime.Now;
            }
        }
        else
        {
            // 取消完成時清除記錄
            item.CompletedByEmployeeId = null;
            item.CompletedAt = null;
        }
        
        await NotifyDetailsChanged();
    }

    public async Task RemoveItemAsync(int index)
    {
        if (IsReadOnly || index < 0 || index >= ProductItems.Count) return;
        
        var removedItem = ProductItems[index];
        ProductItems.Remove(removedItem);
        
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// 取得可用商品列表（根據供應商過濾）
    /// </summary>
    private List<Product> GetAvailableProducts()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
        {
            return new List<Product>();
        }
        
        return Products;
    }
    
    /// <summary>
    /// 計算明細項目的小計（根據稅率算法，四捨五入到整數）
    /// </summary>
    private decimal CalculateItemSubtotal(ProductItem item)
    {
        if (item.SelectedProduct == null || item.Quantity <= 0 || item.Price <= 0)
        {
            return 0;
        }
        
        var baseAmount = item.Quantity * item.Price;
        
        switch (TaxCalculationMethod)
        {
            case TaxCalculationMethod.TaxExclusive:
                // 外加稅：小計 = 數量 × 單價 × (1 + 稅率%)（四捨五入到整數）
                return Math.Round(baseAmount * (1 + item.TaxRate / 100m), 0, MidpointRounding.AwayFromZero);
                
            case TaxCalculationMethod.TaxInclusive:
                // 內含稅：小計 = 數量 × 單價（單價已含稅，四捨五入到整數）
                return Math.Round(baseAmount, 0, MidpointRounding.AwayFromZero);
                
            case TaxCalculationMethod.NoTax:
                // 免稅：小計 = 數量 × 單價（四捨五入到整數）
                return Math.Round(baseAmount, 0, MidpointRounding.AwayFromZero);
                
            default:
                return Math.Round(baseAmount, 0, MidpointRounding.AwayFromZero);
        }
    }
    
    /// <summary>
    /// 取得小計欄位的提示文字
    /// </summary>
    private string GetSubtotalTooltip()
    {
        return TaxCalculationMethod switch
        {
            TaxCalculationMethod.TaxExclusive => "外加稅：數量 × 單價 × (1 + 稅率%)",
            TaxCalculationMethod.TaxInclusive => "內含稅：數量 × 單價（單價已含稅）",
            TaxCalculationMethod.NoTax => "免稅：數量 × 單價",
            _ => "數量 × 單價"
        };
    }

    private decimal GetTotalAmount()
    {
        return ProductItems
            .Where(item => item.SelectedProduct != null && item.Quantity > 0)
            .Sum(item => item.Quantity * item.Price);
    }

    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        // 檢查是否至少有一個有效的商品
        var validItemsCount = ProductItems.Count(item => item.SelectedProduct != null);
        if (validItemsCount < 1)
        {
            errors.Add("至少需要一個商品");
        }
          
        if (errors.Any())
        {
            var errorMessage = string.Join("\n", errors);
            await NotificationService.ShowErrorAsync(errorMessage);
            return false;
        }
        
        return true;
    }

    // ===== 智能下單功能 =====
    
    /// <summary>
    /// 計算屬性：是否可以使用智能下單
    /// </summary>
    private bool CanUseSmartPurchase => 
        SelectedSupplierId.HasValue && 
        SelectedSupplierId.Value > 0;
    


    /// <summary>
    /// 智能下單主要方法
    /// </summary>
    private async Task SmartPurchaseOrder()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
        {
            await NotificationService.ShowWarningAsync("請先選擇廠商後再使用智能下單");
            return;
        }

        try
        {
            // 獲取該廠商最近一次的採購記錄
            var lastPurchaseDetails = await PurchaseOrderDetailService.GetLastCompletePurchaseAsync(SelectedSupplierId.Value);
            
            if (!lastPurchaseDetails.Any())
            {
                await NotificationService.ShowInfoAsync("該廠商沒有歷史採購記錄，無法使用智能下單");
                return;
            }

            // 檢查是否有現有資料
            var hasExistingData = ProductItems.Any(item => item.SelectedProduct != null);
            
            if (hasExistingData)
            {
                // 使用確認對話框
                var confirmed = await ShowConfirmationAsync(
                    "智能下單確認", 
                    $"此操作將清空現有的商品明細並載入 {lastPurchaseDetails.Count} 項上次採購的商品。\n\n是否繼續？"
                );
                
                if (!confirmed) return;
            }

            await LoadLastPurchaseDetailsInternal(lastPurchaseDetails);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"智能下單失敗：{ex.Message}");
        }
    }

    /// <summary>
    /// 顯示確認對話框
    /// </summary>
    private async Task<bool> ShowConfirmationAsync(string title, string message)
    {
        // 暫時使用簡單的通知，等待確認後執行
        // 在實際專案中可能會使用更精美的對話框組件
        try 
        {
            // 先顯示警告訊息，讓使用者知道將要進行的操作
            await NotificationService.ShowWarningAsync($"{title}: {message}");
            return true; // 暫時直接返回 true，實際應該實作確認對話框
        }
        catch
        {
            return false;
        }
    }

    /// <summary>
    /// 內部方法：載入上次採購明細
    /// </summary>
    private async Task LoadLastPurchaseDetailsInternal(List<PurchaseOrderDetail> lastPurchaseDetails)
    {
        try
        {
            //  開始載入資料 - 設定為未完成
            _dataLoadCompleted = false;
            
            // 清空現有項目
            ProductItems.Clear();

            // 載入上次採購的所有商品明細
            foreach (var detail in lastPurchaseDetails)
            {
                var productItem = new ProductItem
                {
                    SelectedProduct = detail.Product,
                    SelectedProductId = detail.Product?.Id,  //  同步設定 ID
                    ProductSearchValue = detail.Product != null ? $"[{detail.Product.Code}] {detail.Product.Name}" : string.Empty,  // 設定搜尋顯示值
                    Quantity = detail.OrderQuantity,  // 使用上次的採購數量
                    Price = detail.UnitPrice,         // 使用上次的採購單價
                    TaxRate = detail.TaxRate ?? await SystemParameterService.GetTaxRateAsync(),  // 使用上次的稅率，如果為 null 則使用系統預設
                    ReceivedQuantity = 0,             // 新訂單的已收貨數量從0開始
                    IsReceivingCompleted = false,     // 新訂單未完成收貨
                    Remarks = string.Empty           // 備註重新開始
                };

                ProductItems.Add(productItem);
            }

            // 通知父組件明細已變更
            await NotifyDetailsChanged();
            
            //  資料載入完成 - 觸發空行檢查
            _dataLoadCompleted = true;
            StateHasChanged();
            
            await NotificationService.ShowSuccessAsync(
                $"成功載入 {lastPurchaseDetails.Count} 項上次採購的商品明細"
            );
        }
        catch (Exception ex)
        {
            //  發生錯誤也要恢復載入完成狀態
            _dataLoadCompleted = true;
            await NotificationService.ShowErrorAsync($"載入上次採購明細失敗：{ex.Message}");
        }
    }

    /// <summary>
    /// 清空所有明細
    /// </summary>
    private async Task ClearAllDetails()
    {
        ProductItems.Clear();
        await NotifyDetailsChanged();
        tableComponent?.RefreshEmptyRow();
        
        await NotificationService.ShowSuccessAsync("已清空所有商品明細");
    }

    // ===== 相關單據查看方法 =====
    
    /// <summary>
    /// 顯示相關單據（入庫單）
    /// </summary>
    private async Task ShowRelatedDocuments(ProductItem item)
    {
        if (item.ExistingDetailEntity is not PurchaseOrderDetail detail || detail.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("此項目尚未儲存，無法查看相關單據", "提示");
            return;
        }

        selectedProductName = item.SelectedProduct?.Name ?? "未知商品";
        
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsForPurchaseOrderDetailAsync(detail.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入相關單據失敗：{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// 處理點擊相關單據的事件
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // 觸發事件，讓父組件（EditModal）處理開啟相關單據
        // 注意：不關閉 RelatedDocumentsModal，讓使用者可以繼續查看列表
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            // 如果父組件沒有處理，顯示提示訊息
            await NotificationService.ShowInfoAsync(
                $"請在主畫面中開啟 {document.TypeDisplayName}: {document.DocumentNumber}", 
                "提示"
            );
        }
    }
    
    /// <summary>
    /// 檢查指定的採購訂單明細項目是否已被入庫單使用
    /// </summary>
    private async Task<bool> HasUsageRecord(ProductItem item)
    {
        if (item.ExistingDetailEntity is not PurchaseOrderDetail detail || detail.Id <= 0)
        {
            return false;
        }

        try
        {
            var documents = await RelatedDocumentsHelper.GetRelatedDocumentsForPurchaseOrderDetailAsync(detail.Id);
            var hasUsage = documents?.Any() == true;
            return hasUsage;
        }
        catch
        {
            return false;
        }
    }
    
    /// <summary>
    /// 取得當前使用者ID
    /// </summary>
    private async Task<int?> GetCurrentUserIdAsync()
    {
        return await CurrentUserHelper.GetCurrentEmployeeIdAsync(AuthenticationStateProvider);
    }

    public class ProductItem
    {
        public Product? SelectedProduct { get; set; }
        public int? SelectedProductId { get; set; }  //  用於 InteractiveTableComponent Select 綁定
        public int Quantity { get; set; } = 0;
        public int ReceivedQuantity { get; set; } = 0;
        public decimal Price { get; set; } = 0;
        public decimal TaxRate { get; set; } = 0;
        public string Remarks { get; set; } = string.Empty;
        public bool IsReceivingCompleted { get; set; } = false;
        public int? CompletedByEmployeeId { get; set; }
        public DateTime? CompletedAt { get; set; }
        public TDetailEntity? ExistingDetailEntity { get; set; }
        
        // 標記是否已被入庫單使用（避免重複查詢）
        public bool? HasUsageRecordCache { get; set; } = null;
        
        // SearchableSelect 支援屬性
        public string ProductSearchValue { get; set; } = string.Empty;
        public List<Product> FilteredProducts { get; set; } = new();
        public bool ShowProductDropdown { get; set; } = false;
        public int ProductSelectedIndex { get; set; } = -1;
    }
}
