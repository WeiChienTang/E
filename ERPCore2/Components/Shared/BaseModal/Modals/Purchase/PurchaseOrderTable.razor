@* æ¡è³¼å–®å•†å“ç®¡ç†çµ„ä»¶ - ä½¿ç”¨ InteractiveTableComponent çµ±ä¸€UI ä¸¦æ•´åˆè‡ªå‹•ç©ºè¡ŒåŠŸèƒ½ *@

@inject IProductService ProductService
@inject IPurchaseOrderDetailService PurchaseOrderDetailService
@inject INotificationService NotificationService
@inject RelatedDocumentsHelper RelatedDocumentsHelper
@inject AuthenticationStateProvider AuthenticationStateProvider

@typeparam TMainEntity where TMainEntity : BaseEntity
@typeparam TDetailEntity where TDetailEntity : BaseEntity, new()

@if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="supplier-warning">
                <p class="text-muted">é¸æ“‡å» å•†å¾Œå³å¯æŸ¥çœ‹è©²å» å•†çš„æœªå®Œæˆé€²è²¨å•†å“</p>
            </div>
        </div>
    </div>
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent TItem="ProductItem" 
                                      Items="@ProductItems"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"
                                      ShowRowNumbers="false"
                                      EmptyMessage="@EmptyMessage"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="false"
                                      ActionsColumnWidth = "60px"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"
                                      OnItemDelete="@HandleItemDelete"/>
        </div>

        
        <div class="card-footer">
            <div class="d-flex justify-content-between">
                <div>
                    <GenericButtonComponent Text="æ™ºèƒ½ä¸‹å–®"
                                          Variant="ButtonVariant.Primary"
                                          Icon="fas fa-magic"
                                          OnClick="SmartPurchaseOrder"
                                          IsDisabled="@(!CanUseSmartPurchase)" />
                </div>
                <div class="d-flex gap-2">
                    <GenericButtonComponent Text="æ¸…é™¤æ˜ç´°"
                                          Variant="ButtonVariant.Danger"
                                          OnClick="ClearAllDetails" />
                </div>
            </div>
        </div>
    </div>
}

<!-- ç›¸é—œå–®æ“šæŸ¥çœ‹ Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

@code {
    // ===== åŸºæœ¬åƒæ•¸ =====
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public EventCallback<List<ProductItem>> OnProductItemsChanged { get; set; }
    
    // ===== æ–°å¢ä¾›æ‡‰å•†éæ¿¾åƒæ•¸ =====
    [Parameter] public int? SelectedSupplierId { get; set; }
    
    // ===== æ³›å‹åƒæ•¸ =====
    [Parameter] public TMainEntity? MainEntity { get; set; }
    [Parameter] public List<TDetailEntity> ExistingDetails { get; set; } = new List<TDetailEntity>();
    [Parameter] public EventCallback<List<TDetailEntity>> OnDetailsChanged { get; set; }
    
    // ===== æ¬„ä½æ˜ å°„åƒæ•¸ =====
    [Parameter] public string MainEntityIdPropertyName { get; set; } = string.Empty;
    [Parameter] public string QuantityPropertyName { get; set; } = "Quantity";
    [Parameter] public string ReceivedQuantityPropertyName { get; set; } = "ReceivedQuantity";
    [Parameter] public string UnitPricePropertyName { get; set; } = "UnitPrice";
    [Parameter] public string RemarksPropertyName { get; set; } = "Remarks";
    [Parameter] public string? UnitIdPropertyName { get; set; }
    [Parameter] public string? IsReceivingCompletedPropertyName { get; set; }    
    
    // ===== é¡¯ç¤ºè¨­å®š =====
    [Parameter] public string Title { get; set; } = "å•†å“è³‡è¨Š";
    [Parameter] public string Subtitle { get; set; } = "";
    [Parameter] public string Icon { get; set; } = "box";
    [Parameter] public string ItemDisplayName { get; set; } = "å•†å“";
    [Parameter] public string EmptyIcon { get; set; } = "box-open";
    [Parameter] public string EmptyMessage { get; set; } = "å°šæœªæ–°å¢å•†å“";
    
    // ===== å”¯è®€æ¨¡å¼åƒæ•¸ =====
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== æ ¸å‡†ç‹€æ…‹åƒæ•¸ =====
    [Parameter] public bool IsApproved { get; set; } = false;
    
    // ===== ä¸å¯åˆªé™¤æ˜ç´°ç‹€æ…‹è®Šæ›´äº‹ä»¶ =====
    [Parameter] public EventCallback<bool> OnHasUndeletableDetailsChanged { get; set; }
    
    // ===== ç›¸é—œå–®æ“šé–‹å•Ÿäº‹ä»¶ =====
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }

    private List<ProductItem> ProductItems { get; set; } = new List<ProductItem>();
    private List<Product> AvailableProducts { get; set; } = new List<Product>();
    private int? _previousSelectedSupplierId = null;
    private bool _isInitialized = false; // æ–°å¢åˆå§‹åŒ–æ¨™è¨˜
    
    // ===== ç›¸é—œå–®æ“šæŸ¥çœ‹ =====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;

    protected override async Task OnInitializedAsync()
    {
        // åˆå§‹åŒ–æ™‚è¨˜éŒ„ç•¶å‰ä¾›æ‡‰å•†IDï¼Œé¿å… OnParametersSetAsync èª¤åˆ¤ç‚ºè®Šæ›´
        _previousSelectedSupplierId = SelectedSupplierId;
        
        await LoadAvailableProductsAsync();
        await LoadExistingDetailsAsync();
        
        _isInitialized = true; // æ¨™è¨˜ç‚ºå·²åˆå§‹åŒ–
    }

    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        
        // å¦‚æœé‚„æ²’åˆå§‹åŒ–å®Œæˆï¼Œä¸è™•ç†åƒæ•¸è®Šæ›´ï¼ˆé¿å…é‡è¤‡è¼‰å…¥ï¼‰
        if (!_isInitialized)
        {
            return;
        }
        
        // æª¢æŸ¥ä¾›æ‡‰å•†æ˜¯å¦è®Šæ›´
        if (_previousSelectedSupplierId != SelectedSupplierId)
        {
            _previousSelectedSupplierId = SelectedSupplierId;
            await LoadAvailableProductsAsync();
            
            // å¦‚æœæ›´æ›ä¾›æ‡‰å•†ï¼Œéœ€è¦æ¸…ç©ºç¾æœ‰é¸é …ä¸¦é‡æ–°è¼‰å…¥
            ProductItems.Clear();
            await LoadExistingDetailsAsync();
            return; // ä¾›æ‡‰å•†è®Šæ›´æ™‚å·²ç¶“è™•ç†å®Œç•¢ï¼Œç›´æ¥è¿”å›
        }
        
        // åƒè€ƒ ProductSupplierManagerComponent - ç°¡åŒ–é‚è¼¯ï¼Œåªåœ¨åˆå§‹åŒ–æ™‚è¼‰å…¥
        // ç¸½æ˜¯ç¢ºä¿æœ‰ä¸€è¡Œç©ºè¡Œå¯ä»¥è¼¸å…¥ï¼Œä¸è«–æ˜¯å¦å·²æœ‰è³‡æ–™
        EnsureOneEmptyRow();
    }

    // ===== AutoEmptyRowHelper ç›¸é—œæ–¹æ³• =====
    
    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦ç‚ºç©ºè¡Œ
    /// æ¥­å‹™é‚è¼¯ï¼šåªè¦é¸æ“‡äº†å•†å“ï¼Œå°±ç®—æ˜¯æœ‰æ•ˆçš„ä¸€è¡Œï¼Œä¸å†æ˜¯ç©ºè¡Œ
    /// </summary>
    private bool IsEmptyRow(ProductItem item)
    {
        // æª¢æŸ¥å•†å“æ˜¯å¦ç‚ºç©º
        var isEmpty = item.SelectedProduct == null;
        
        // åªè¦å•†å“æœ‰å€¼ï¼Œå°±ä¸æ˜¯ç©ºè¡Œ
        // å•†å“æ˜¯æ ¸å¿ƒæ¬„ä½ï¼Œå…¶ä»–æ¬„ä½å¯ä»¥å¾ŒçºŒå¡«å¯«
        return isEmpty;
    }
    
    /// <summary>
    /// å‰µå»ºç©ºçš„å•†å“é …ç›®
    /// </summary>
    private ProductItem CreateEmptyItem()
    {
        return new ProductItem();
    }
    
    /// <summary>
    /// ç¢ºä¿æœ‰ä¸€è¡Œç©ºè¡Œ
    /// </summary>
    private void EnsureOneEmptyRow()
    {
        AutoEmptyRowHelper.ForAny<ProductItem>.EnsureOneEmptyRow(
            ProductItems, 
            IsEmptyRow, 
            CreateEmptyItem
        );
    }

    // ===== InteractiveTableComponent æ–¹æ³• =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // å•†å“é¸æ“‡æ¬„ä½
        columns.Add(new() 
        { 
            Title = "å•†å“", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "150px",
            Tooltip = "é¸æ“‡è¦æ¡è³¼çš„å•†å“ã€‚å·²æœ‰é€²è²¨è¨˜éŒ„çš„å•†å“å°‡ç„¡æ³•è®Šæ›´",
            CustomTemplate = item => 
            {
                var productItem = (ProductItem)item;
                var selectedValue = productItem.SelectedProduct?.Id.ToString() ?? "";
                var hasReceiving = productItem.ReceivedQuantity > 0;
                var isFieldReadOnly = IsReadOnly || hasReceiving;
                
                // å¦‚æœæ˜¯å”¯è®€ç‹€æ…‹ï¼Œç›´æ¥é¡¯ç¤ºå•†å“åç¨±
                if (isFieldReadOnly && productItem.SelectedProduct != null)
                {
                    var displayText = $"[{productItem.SelectedProduct.Code}] {productItem.SelectedProduct.Name}";
                    var title = hasReceiving ? "æ­¤å•†å“å·²æœ‰é€²è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹å•†å“é¸æ“‡" : "";
                    return @<div class="d-flex align-items-center" style="min-height: 31px;">
                        <span class="text-muted" title="@title">@displayText</span>
                    </div>;
                }
                
                return @<select class="form-select form-select-sm" 
                                value="@selectedValue"
                                disabled="@isFieldReadOnly"
                                @onchange="@(async (e) => await OnProductChanged(productItem, e.Value))">
                    <option value="">è«‹é¸æ“‡å•†å“</option>
                    @foreach (var product in GetAvailableProducts())
                    {
                        <option value="@product.Id">[@product.Code] @product.Name</option>
                    }
                </select>;
            }
        });
        
        // æ•¸é‡æ¬„ä½
        columns.Add(new() 
        { 
            Title = "æ•¸é‡", 
            PropertyName = "Quantity",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            Tooltip = "æ¡è³¼çš„å•†å“æ•¸é‡ã€‚å·²æœ‰é€²è²¨è¨˜éŒ„çš„å•†å“å°‡ç„¡æ³•ä¿®æ”¹æ•¸é‡",
            CustomTemplate = item => 
            {
                var productItem = (ProductItem)item;
                var isEmptyRow = IsEmptyRow(productItem);
                var value = productItem.Quantity > 0 ? productItem.Quantity.ToString() : "";
                var hasReceiving = productItem.ReceivedQuantity > 0;
                var isFieldReadOnly = IsReadOnly || hasReceiving;
                
                // å¦‚æœæ˜¯å”¯è®€ç‹€æ…‹ï¼Œç›´æ¥é¡¯ç¤º span
                if (isFieldReadOnly)
                {
                    var displayText = productItem.Quantity > 0 ? productItem.Quantity.ToString("N0") : "";
                    var title = hasReceiving ? "æ­¤å•†å“å·²æœ‰é€²è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹æ•¸é‡" : "";
                    return @<div class="d-flex align-items-center justify-content-end" style="min-height: 31px;">
                        <span class="text-muted" title="@title">@displayText</span>
                    </div>;
                }
                
                return @<input type="number" class="form-control form-control-sm" 
                               value="@value"
                               @oninput="(e) => OnQuantityInput(productItem, e.Value?.ToString())"
                               onkeydown="if(['e','E','+','-'].includes(event.key)) event.preventDefault();"
                               placeholder="" 
                               min="0" 
                               step="1" />;
            }
        });

        // å…¥åº«é‡æ¬„ä½ (åªè®€)
        columns.Add(new() 
        { 
            Title = "å…¥åº«é‡", 
            PropertyName = "ReceivedQuantity",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            Tooltip = "å·²å…¥åº«çš„ç´¯è¨ˆæ•¸é‡ï¼ˆå”¯è®€ï¼‰",
            CustomTemplate = item => 
            {
                var productItem = (ProductItem)item;
                
                return @<div class="d-flex align-items-center justify-content-end">
                    <span class="fw-bold">@productItem.ReceivedQuantity.ToString("F0")</span>
                </div>;
            }
        });

        // å–®åƒ¹æ¬„ä½
        columns.Add(new() 
        { 
            Title = "å–®åƒ¹", 
            PropertyName = "Price",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            Tooltip = "å•†å“çš„æ¡è³¼å–®åƒ¹ã€‚å·²æœ‰é€²è²¨è¨˜éŒ„çš„å•†å“å°‡ç„¡æ³•ä¿®æ”¹å–®åƒ¹",
            CustomTemplate = item => 
            {
                var productItem = (ProductItem)item;
                var isEmptyRow = IsEmptyRow(productItem);
                var value = productItem.Price > 0 ? productItem.Price.ToString("F0") : "";
                var hasReceiving = productItem.ReceivedQuantity > 0;
                var isFieldReadOnly = IsReadOnly || hasReceiving;
                
                // å¦‚æœæ˜¯å”¯è®€ç‹€æ…‹ï¼Œç›´æ¥é¡¯ç¤º span
                if (isFieldReadOnly)
                {
                    var displayText = productItem.Price > 0 ? productItem.Price.ToString("F0") : "";
                    var title = hasReceiving ? "æ­¤å•†å“å·²æœ‰é€²è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹å–®åƒ¹" : "";
                    return @<div class="d-flex align-items-center justify-content-end" style="min-height: 31px;">
                        <span class="text-muted" title="@title">@displayText</span>
                    </div>;
                }
                
                return @<input type="number" class="form-control form-control-sm" 
                               value="@value"
                               @oninput="(e) => OnPriceInput(productItem, e.Value?.ToString())"
                               onkeydown="if(['e','E','+','-'].includes(event.key)) event.preventDefault();"
                               placeholder=""
                               step="1"
                               min="0" />;
            }
        });

        // åªæœ‰åœ¨å·²æ ¸å‡†çš„ç‹€æ…‹ä¸‹æ‰é¡¯ç¤ºã€Œå®Œæˆé€²è²¨ã€æ¬„ä½
        if (IsApproved)
        {
            columns.Add(new() 
            { 
                Title = "å®Œæˆé€²è²¨", 
                PropertyName = "IsReceivingCompleted",
                ColumnType = InteractiveColumnType.Custom,
                Width = "120px",
                Tooltip = "æ‰‹å‹•æ¨™è¨˜æ­¤å•†å“å·²å®Œæˆæ‰€æœ‰é€²è²¨ä½œæ¥­ï¼ˆå³ä½¿æ•¸é‡æœªå®Œå…¨å…¥åº«ï¼‰\næ ¸å‡†å¾Œä»å¯ä¿®æ”¹æ­¤ç‹€æ…‹",
                CustomTemplate = item => 
                {
                    var productItem = (ProductItem)item;
                    
                    // ã€Œå®Œæˆé€²è²¨ã€æ˜¯åŸ·è¡Œç‹€æ…‹ï¼Œä¸å—æ ¸å‡†é–å®šå½±éŸ¿
                    var isFieldReadOnly = IsReadOnly;
                    
                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“å®Œå…¨é€²è²¨ï¼ˆå…¥åº« >= æ¡è³¼ï¼‰
                    var isFullyReceived = productItem.ReceivedQuantity >= productItem.Quantity;
                    
                    // å¦‚æœå·²å®Œå…¨é€²è²¨ï¼Œåªèƒ½å‹¾é¸å®Œæˆï¼Œä¸èƒ½å–æ¶ˆ
                    var canToggle = !isFullyReceived || !productItem.IsReceivingCompleted;                    
                    
                    return @<div class="text-center">
                        <div class="form-check form-switch d-flex justify-content-center">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   checked="@productItem.IsReceivingCompleted"
                                   disabled="@(!canToggle)"
                                   @onclick="() => OnIsReceivingCompletedChanged(productItem)"
                                   title="@(canToggle ? "æ¨™è¨˜ç‚ºå®Œæˆé€²è²¨" : "å·²å®Œå…¨é€²è²¨ï¼Œç„¡æ³•å–æ¶ˆ")" />
                        </div>
                    </div>;
                }
            });
        }
        

        // å‚™è¨»æ¬„ä½ - æ ¸å‡†å¾Œä»å¯ç·¨è¼¯ï¼ˆç”¨æ–¼è¨˜éŒ„åŸ·è¡Œç‹€æ³ï¼‰
        columns.Add(new() 
        { 
            Title = "å‚™è¨»", 
            PropertyName = "Remarks",
            ColumnType = InteractiveColumnType.Custom,
            Width = "150px",
            HideOnMobile = true,
            Tooltip = "é¸å¡«ã€‚å¯è¨˜éŒ„æ¡è³¼ç›¸é—œçš„å‚™è¨»è³‡è¨Šï¼ˆæ ¸å‡†å¾Œä»å¯ç·¨è¼¯ï¼‰",
            CustomTemplate = item => 
            {
                var productItem = (ProductItem)item;
                var isEmptyRow = IsEmptyRow(productItem);
                // ğŸ”‘ å‚™è¨»æ¬„ä½åªå— IsReadOnly å½±éŸ¿ï¼Œæ ¸å‡†å¾Œä»å¯ç·¨è¼¯
                var isFieldReadOnly = IsReadOnly;
                
                // å¦‚æœæ˜¯å”¯è®€ç‹€æ…‹ï¼Œç›´æ¥é¡¯ç¤º span
                if (isFieldReadOnly)
                {
                    var displayText = string.IsNullOrEmpty(productItem.Remarks) ? "ç„¡å‚™è¨»" : productItem.Remarks;
                    return @<div class="d-flex align-items-center" style="min-height: 31px;">
                        <span class="text-muted">@displayText</span>
                    </div>;
                }
                
                return @<input type="text" class="form-control form-control-sm" 
                               value="@productItem.Remarks"
                               @oninput="(e) => OnRemarksInput(productItem, e.Value?.ToString())"
                               placeholder="é¸å¡«..." />;
            }
        });

        return columns;
    }

    private RenderFragment<ProductItem> GetCustomActionsTemplate => item => __builder =>
    {
        // æª¢æŸ¥æ˜¯å¦å·²è¢«å…¥åº«å–®ä½¿ç”¨
        var hasUsage = item.HasUsageRecordCache ?? false;
        
        if (!hasUsage)
        {
            // å¯ä»¥åˆªé™¤ï¼šé¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Danger"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="@IsReadOnly"
                                   Title="åˆªé™¤"
                                   OnClick="async () => await HandleItemDelete(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else
        {
            // å·²è¢«ä½¿ç”¨ï¼šé¡¯ç¤ºæŸ¥çœ‹æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Info"
                                   IconClass="bi bi-eye text-white"
                                   Size="ButtonSize.Large"
                                   Title="æŸ¥çœ‹ç›¸é—œå–®æ“š"
                                   OnClick="async () => await ShowRelatedDocuments(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
    };

    private async Task HandleItemDelete(ProductItem item)
    {
        var index = ProductItems.IndexOf(item);
        await RemoveItemAsync(index);
    }

    // ===== å…§éƒ¨æ–¹æ³• =====

    /// <summary>
    /// æ ¹æ“šé¸æ“‡çš„ä¾›æ‡‰å•†è¼‰å…¥å¯ç”¨å•†å“
    /// </summary>
    private async Task LoadAvailableProductsAsync()
    {
        try
        {
            if (SelectedSupplierId.HasValue && SelectedSupplierId.Value > 0)
            {
                AvailableProducts = await ProductService.GetBySupplierAsync(SelectedSupplierId.Value);
            }
            else
            {
                AvailableProducts = new List<Product>();
            }
        }
        catch (Exception)
        {
            AvailableProducts = new List<Product>();
        }
    }
    
    /// <summary>
    /// å…¬é–‹æ–¹æ³•ï¼šé‡æ–°è¼‰å…¥å¯ç”¨å•†å“ï¼ˆä¾›çˆ¶çµ„ä»¶å‘¼å«ï¼‰
    /// ç•¶å» å•†è³‡æ–™è¢«ç·¨è¼¯å¾Œï¼Œçˆ¶çµ„ä»¶å¯ä»¥å‘¼å«æ­¤æ–¹æ³•ä¾†é‡æ–°è¼‰å…¥è©²å» å•†çš„å•†å“
    /// </summary>
    public async Task RefreshAvailableProductsAsync()
    {
        await LoadAvailableProductsAsync();
        StateHasChanged();
    }

    /// <summary>
    /// å¾ç¾æœ‰æ˜ç´°è³‡æ–™è¼‰å…¥åˆ° ProductItems
    /// </summary>
    private async Task LoadExistingDetailsAsync()
    {
        if (ExistingDetails?.Any() != true) 
        {
            EnsureOneEmptyRow();
            return;
        }

        ProductItems.Clear();
        
        foreach (var detail in ExistingDetails)
        {
            var productId = GetPropertyValue<int>(detail, "ProductId");
            var product = Products.FirstOrDefault(p => p.Id == productId) ?? 
                         AvailableProducts.FirstOrDefault(p => p.Id == productId);
            
            if (product != null)
            {
                var item = new ProductItem
                {
                    SelectedProduct = product,
                    Quantity = Convert.ToInt32(GetPropertyValue<object>(detail, QuantityPropertyName) ?? 0),
                    ReceivedQuantity = Convert.ToInt32(GetPropertyValue<object>(detail, ReceivedQuantityPropertyName) ?? 0),
                    Price = Convert.ToDecimal(GetPropertyValue<object>(detail, UnitPricePropertyName) ?? 0m),
                    Remarks = GetPropertyValue<string>(detail, RemarksPropertyName) ?? string.Empty,
                    IsReceivingCompleted = !string.IsNullOrEmpty(IsReceivingCompletedPropertyName) ? 
                        Convert.ToBoolean(GetPropertyValue<object>(detail, IsReceivingCompletedPropertyName) ?? false) : false,
                    CompletedByEmployeeId = GetPropertyValue<int?>(detail, "CompletedByEmployeeId"),
                    CompletedAt = GetPropertyValue<DateTime?>(detail, "CompletedAt"),
                    ExistingDetailEntity = detail
                };
                
                // æª¢æŸ¥æ˜¯å¦å·²è¢«å…¥åº«å–®ä½¿ç”¨
                item.HasUsageRecordCache = await HasUsageRecord(item);
                
                ProductItems.Add(item);
            }
        }
        
        EnsureOneEmptyRow();
    }

    /// <summary>
    /// è½‰æ› ProductItems ç‚ºæ˜ç´°å¯¦é«”åˆ—è¡¨
    /// </summary>
    private List<TDetailEntity> ConvertToDetailEntities()
    {
        var details = new List<TDetailEntity>();
        
        foreach (var item in ProductItems.Where(x => !IsEmptyRow(x) && x.SelectedProduct != null))
        {
            TDetailEntity detail;
            
            if (item.ExistingDetailEntity != null)
            {
                detail = item.ExistingDetailEntity;
            }
            else
            {
                detail = new TDetailEntity();
                
                if (MainEntity != null && !string.IsNullOrEmpty(MainEntityIdPropertyName))
                {
                    SetPropertyValue(detail, MainEntityIdPropertyName, MainEntity.Id);
                }
                
                if (item.SelectedProduct != null)
                {
                    SetPropertyValue(detail, "ProductId", item.SelectedProduct.Id);
                }
            }
            
            SetPropertyValue(detail, QuantityPropertyName, item.Quantity);
            SetPropertyValue(detail, ReceivedQuantityPropertyName, item.ReceivedQuantity);
            SetPropertyValue(detail, UnitPricePropertyName, item.Price);
            SetPropertyValue(detail, RemarksPropertyName, item.Remarks);
            
            if (!string.IsNullOrEmpty(IsReceivingCompletedPropertyName))
            {
                SetPropertyValue(detail, IsReceivingCompletedPropertyName, item.IsReceivingCompleted);
            }
            
            // å„²å­˜å®Œæˆé€²è²¨çš„è¿½è¹¤è³‡æ–™
            SetPropertyValue(detail, "CompletedByEmployeeId", item.CompletedByEmployeeId);
            SetPropertyValue(detail, "CompletedAt", item.CompletedAt);
            
            details.Add(detail);
        }
        
        return details;
    }

    /// <summary>
    /// ç›´æ¥é€šçŸ¥è©³ç´°è³‡æ–™è®Šæ›´ - åƒè€ƒ ProductSupplierManagerComponent çš„ç°¡æ½”å¯«æ³•
    /// </summary>
    private async Task NotifyDetailsChanged()
    {
        var details = ConvertToDetailEntities();
        await OnDetailsChanged.InvokeAsync(details);
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°(å·²æœ‰é€²è²¨è¨˜éŒ„)
        bool hasUndeletableDetails = ProductItems.Any(p => p.ReceivedQuantity > 0);
        await OnHasUndeletableDetailsChanged.InvokeAsync(hasUndeletableDetails);
    }

    /// <summary>
    /// ä½¿ç”¨åå°„å–å¾—å±¬æ€§å€¼
    /// </summary>
    private T? GetPropertyValue<T>(object obj, string propertyName)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property == null) return default(T);
        
        var value = property.GetValue(obj);
        if (value == null) return default(T);
        
        if (typeof(T) == typeof(object)) return (T)value;
        
        return (T)Convert.ChangeType(value, typeof(T));
    }

    /// <summary>
    /// ä½¿ç”¨åå°„è¨­å®šå±¬æ€§å€¼
    /// </summary>
    private void SetPropertyValue(object obj, string propertyName, object? value)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property != null && property.CanWrite)
        {
            if (value != null && property.PropertyType != value.GetType())
            {
                if (property.PropertyType.IsGenericType && property.PropertyType.GetGenericTypeDefinition() == typeof(Nullable<>))
                {
                    var underlyingType = Nullable.GetUnderlyingType(property.PropertyType);
                    value = Convert.ChangeType(value, underlyingType!);
                }
                else
                {
                    value = Convert.ChangeType(value, property.PropertyType);
                }
            }
            property.SetValue(obj, value);
        }
    }

    // ===== å•†å“é¸æ“‡äº‹ä»¶è™•ç† =====

    private async Task OnProductChanged(ProductItem item, object? value)
    {
        var wasEmpty = IsEmptyRow(item);
        
        var productIdStr = value?.ToString();
        if (string.IsNullOrEmpty(productIdStr))
        {
            item.SelectedProduct = null;
        }
        else if (int.TryParse(productIdStr, out var productId))
        {
            var product = GetAvailableProducts().FirstOrDefault(p => p.Id == productId);
            item.SelectedProduct = product;
        }
        
        // è™•ç†è‡ªå‹•ç©ºè¡Œé‚è¼¯
        AutoEmptyRowHelper.ForAny<ProductItem>.HandleInputChange(
            ProductItems, item, IsEmptyRow, CreateEmptyItem, wasEmpty, !IsEmptyRow(item));
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnQuantityInput(ProductItem item, string? value)
    {
        var wasEmpty = IsEmptyRow(item);
        
        if (string.IsNullOrEmpty(value))
        {
            item.Quantity = 0;
        }
        else if (int.TryParse(value, out var quantity))
        {
            item.Quantity = quantity;
        }
        
        AutoEmptyRowHelper.ForAny<ProductItem>.HandleInputChange(
            ProductItems, item, IsEmptyRow, CreateEmptyItem, wasEmpty, !IsEmptyRow(item));
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnPriceInput(ProductItem item, string? value)
    {
        var wasEmpty = IsEmptyRow(item);
        
        if (string.IsNullOrEmpty(value))
        {
            item.Price = 0;
        }
        else if (decimal.TryParse(value, out var price))
        {
            item.Price = price;
        }
        
        AutoEmptyRowHelper.ForAny<ProductItem>.HandleInputChange(
            ProductItems, item, IsEmptyRow, CreateEmptyItem, wasEmpty, !IsEmptyRow(item));
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnRemarksInput(ProductItem item, string? value)
    {
        var wasEmpty = IsEmptyRow(item);
        item.Remarks = value ?? string.Empty;
        
        AutoEmptyRowHelper.ForAny<ProductItem>.HandleInputChange(
            ProductItems, item, IsEmptyRow, CreateEmptyItem, wasEmpty, !IsEmptyRow(item));
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnIsReceivingCompletedChanged(ProductItem item)
    {
        var wasEmpty = IsEmptyRow(item);
        
        // æª¢æŸ¥æ˜¯å¦å·²ç¶“å®Œå…¨é€²è²¨
        var isFullyReceived = item.ReceivedQuantity >= item.Quantity;
        
        // å¦‚æœå·²å®Œå…¨é€²è²¨ä¸”å·²æ¨™è¨˜å®Œæˆï¼Œä¸å…è¨±å–æ¶ˆ
        if (isFullyReceived && item.IsReceivingCompleted)
        {
            await NotificationService.ShowWarningAsync("æ­¤å•†å“å·²å…¨æ•¸å…¥åº«ï¼Œç„¡æ³•å–æ¶ˆå®Œæˆç‹€æ…‹");
            return;
        }
        
        // åˆ‡æ›ç‹€æ…‹
        var newValue = !item.IsReceivingCompleted;
        item.IsReceivingCompleted = newValue;
        
        // è¨˜éŒ„æ“ä½œè€…å’Œæ™‚é–“ï¼ˆåªåœ¨æ¨™è¨˜ç‚ºå®Œæˆæ™‚è¨˜éŒ„ï¼‰
        if (newValue)
        {
            var currentUserId = await GetCurrentUserIdAsync();
            if (currentUserId.HasValue)
            {
                item.CompletedByEmployeeId = currentUserId.Value;
                item.CompletedAt = DateTime.Now;
            }
        }
        else
        {
            // å–æ¶ˆå®Œæˆæ™‚æ¸…é™¤è¨˜éŒ„
            item.CompletedByEmployeeId = null;
            item.CompletedAt = null;
        }
        
        AutoEmptyRowHelper.ForAny<ProductItem>.HandleInputChange(
            ProductItems, item, IsEmptyRow, CreateEmptyItem, wasEmpty, !IsEmptyRow(item));
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    public async Task RemoveItemAsync(int index)
    {
        if (IsReadOnly || index < 0 || index >= ProductItems.Count) return;
        
        var removedItem = ProductItems[index];
        
        AutoEmptyRowHelper.ForAny<ProductItem>.HandleItemRemove(
            ProductItems, removedItem, IsEmptyRow, CreateEmptyItem);
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    /// <summary>
    /// å–å¾—å¯ç”¨å•†å“åˆ—è¡¨ï¼ˆæ ¹æ“šä¾›æ‡‰å•†éæ¿¾ï¼‰
    /// </summary>
    private List<Product> GetAvailableProducts()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
        {
            return new List<Product>();
        }
        
        return AvailableProducts;
    }

    private decimal GetTotalAmount()
    {
        return ProductItems
            .Where(item => !IsEmptyRow(item) && item.SelectedProduct != null && item.Quantity > 0)
            .Sum(item => item.Quantity * item.Price);
    }

    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        if (!AutoEmptyRowHelper.ForAny<ProductItem>.HasSufficientItems(ProductItems, IsEmptyRow, 1))
        {
            errors.Add("è‡³å°‘éœ€è¦ä¸€å€‹å•†å“");
        }
          
        if (errors.Any())
        {
            var errorMessage = string.Join("\n", errors);
            await NotificationService.ShowErrorAsync(errorMessage);
            return false;
        }
        
        return true;
    }

    // ===== æ™ºèƒ½ä¸‹å–®åŠŸèƒ½ =====
    
    /// <summary>
    /// è¨ˆç®—å±¬æ€§ï¼šæ˜¯å¦å¯ä»¥ä½¿ç”¨æ™ºèƒ½ä¸‹å–®
    /// </summary>
    private bool CanUseSmartPurchase => 
        SelectedSupplierId.HasValue && 
        SelectedSupplierId.Value > 0;
    


    /// <summary>
    /// æ™ºèƒ½ä¸‹å–®ä¸»è¦æ–¹æ³•
    /// </summary>
    private async Task SmartPurchaseOrder()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
        {
            await NotificationService.ShowWarningAsync("è«‹å…ˆé¸æ“‡å» å•†å¾Œå†ä½¿ç”¨æ™ºèƒ½ä¸‹å–®");
            return;
        }

        try
        {
            // ç²å–è©²å» å•†æœ€è¿‘ä¸€æ¬¡çš„æ¡è³¼è¨˜éŒ„
            var lastPurchaseDetails = await PurchaseOrderDetailService.GetLastCompletePurchaseAsync(SelectedSupplierId.Value);
            
            if (!lastPurchaseDetails.Any())
            {
                await NotificationService.ShowInfoAsync("è©²å» å•†æ²’æœ‰æ­·å²æ¡è³¼è¨˜éŒ„ï¼Œç„¡æ³•ä½¿ç”¨æ™ºèƒ½ä¸‹å–®");
                return;
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰è³‡æ–™
            var hasExistingData = ProductItems.Any(item => !IsEmptyRow(item));
            
            if (hasExistingData)
            {
                // ä½¿ç”¨ç¢ºèªå°è©±æ¡†
                var confirmed = await ShowConfirmationAsync(
                    "æ™ºèƒ½ä¸‹å–®ç¢ºèª", 
                    $"æ­¤æ“ä½œå°‡æ¸…ç©ºç¾æœ‰çš„å•†å“æ˜ç´°ä¸¦è¼‰å…¥ {lastPurchaseDetails.Count} é …ä¸Šæ¬¡æ¡è³¼çš„å•†å“ã€‚\n\næ˜¯å¦ç¹¼çºŒï¼Ÿ"
                );
                
                if (!confirmed) return;
            }

            await LoadLastPurchaseDetailsInternal(lastPurchaseDetails);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æ™ºèƒ½ä¸‹å–®å¤±æ•—ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// é¡¯ç¤ºç¢ºèªå°è©±æ¡†
    /// </summary>
    private async Task<bool> ShowConfirmationAsync(string title, string message)
    {
        // æš«æ™‚ä½¿ç”¨ç°¡å–®çš„é€šçŸ¥ï¼Œç­‰å¾…ç¢ºèªå¾ŒåŸ·è¡Œ
        // åœ¨å¯¦éš›å°ˆæ¡ˆä¸­å¯èƒ½æœƒä½¿ç”¨æ›´ç²¾ç¾çš„å°è©±æ¡†çµ„ä»¶
        try 
        {
            // å…ˆé¡¯ç¤ºè­¦å‘Šè¨Šæ¯ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“å°‡è¦é€²è¡Œçš„æ“ä½œ
            await NotificationService.ShowWarningAsync($"{title}: {message}");
            return true; // æš«æ™‚ç›´æ¥è¿”å› trueï¼Œå¯¦éš›æ‡‰è©²å¯¦ä½œç¢ºèªå°è©±æ¡†
        }
        catch
        {
            return false;
        }
    }

    /// <summary>
    /// å…§éƒ¨æ–¹æ³•ï¼šè¼‰å…¥ä¸Šæ¬¡æ¡è³¼æ˜ç´°
    /// </summary>
    private async Task LoadLastPurchaseDetailsInternal(List<PurchaseOrderDetail> lastPurchaseDetails)
    {
        try
        {
            // æ¸…ç©ºç¾æœ‰é …ç›®
            ProductItems.Clear();

            // è¼‰å…¥ä¸Šæ¬¡æ¡è³¼çš„æ‰€æœ‰å•†å“æ˜ç´°
            foreach (var detail in lastPurchaseDetails)
            {
                var productItem = new ProductItem
                {
                    SelectedProduct = detail.Product,
                    Quantity = detail.OrderQuantity,  // ä½¿ç”¨ä¸Šæ¬¡çš„æ¡è³¼æ•¸é‡
                    Price = detail.UnitPrice,         // ä½¿ç”¨ä¸Šæ¬¡çš„æ¡è³¼å–®åƒ¹
                    ReceivedQuantity = 0,             // æ–°è¨‚å–®çš„å·²æ”¶è²¨æ•¸é‡å¾0é–‹å§‹
                    IsReceivingCompleted = false,     // æ–°è¨‚å–®æœªå®Œæˆæ”¶è²¨
                    Remarks = string.Empty           // å‚™è¨»é‡æ–°é–‹å§‹
                };

                ProductItems.Add(productItem);
            }

            // ç¢ºä¿æœ‰ä¸€å€‹ç©ºè¡Œ
            EnsureOneEmptyRow();
            
            // é€šçŸ¥è®Šæ›´ - é‡è¦ï¼šéœ€è¦åŒæ™‚èª¿ç”¨å…©å€‹é€šçŸ¥æ–¹æ³•
            await OnProductItemsChanged.InvokeAsync(ProductItems);
            await NotifyDetailsChanged(); // ä¿®å¾©ï¼šåŠ å…¥æ­¤èª¿ç”¨ä»¥é€šçŸ¥çˆ¶çµ„ä»¶æ›´æ–°æ˜ç´°è³‡æ–™
            
            await NotificationService.ShowSuccessAsync(
                $"æˆåŠŸè¼‰å…¥ {lastPurchaseDetails.Count} é …ä¸Šæ¬¡æ¡è³¼çš„å•†å“æ˜ç´°"
            );
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ä¸Šæ¬¡æ¡è³¼æ˜ç´°å¤±æ•—ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// æ¸…ç©ºæ‰€æœ‰æ˜ç´°
    /// </summary>
    private async Task ClearAllDetails()
    {
        // æ¸…ç©ºæ‰€æœ‰æ˜ç´°ï¼Œåªä¿ç•™ä¸€å€‹ç©ºè¡Œ
        ProductItems.Clear();
        EnsureOneEmptyRow();
        
        // é€šçŸ¥è®Šæ›´ - é‡è¦ï¼šéœ€è¦åŒæ™‚èª¿ç”¨å…©å€‹é€šçŸ¥æ–¹æ³•
        await OnProductItemsChanged.InvokeAsync(ProductItems);
        await NotifyDetailsChanged(); // ä¿®å¾©ï¼šåŠ å…¥æ­¤èª¿ç”¨ä»¥é€šçŸ¥çˆ¶çµ„ä»¶æ¸…ç©ºæ˜ç´°è³‡æ–™
        
        await NotificationService.ShowSuccessAsync("å·²æ¸…ç©ºæ‰€æœ‰å•†å“æ˜ç´°");
    }

    // ===== ç›¸é—œå–®æ“šæŸ¥çœ‹æ–¹æ³• =====
    
    /// <summary>
    /// é¡¯ç¤ºç›¸é—œå–®æ“šï¼ˆå…¥åº«å–®ï¼‰
    /// </summary>
    private async Task ShowRelatedDocuments(ProductItem item)
    {
        if (item.ExistingDetailEntity is not PurchaseOrderDetail detail || detail.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("æ­¤é …ç›®å°šæœªå„²å­˜ï¼Œç„¡æ³•æŸ¥çœ‹ç›¸é—œå–®æ“š", "æç¤º");
            return;
        }

        selectedProductName = item.SelectedProduct?.Name ?? "æœªçŸ¥å•†å“";
        
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsForPurchaseOrderDetailAsync(detail.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ç›¸é—œå–®æ“šå¤±æ•—ï¼š{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// è™•ç†é»æ“Šç›¸é—œå–®æ“šçš„äº‹ä»¶
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // è§¸ç™¼äº‹ä»¶ï¼Œè®“çˆ¶çµ„ä»¶ï¼ˆEditModalï¼‰è™•ç†é–‹å•Ÿç›¸é—œå–®æ“š
        // æ³¨æ„ï¼šä¸é—œé–‰ RelatedDocumentsModalï¼Œè®“ä½¿ç”¨è€…å¯ä»¥ç¹¼çºŒæŸ¥çœ‹åˆ—è¡¨
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            // å¦‚æœçˆ¶çµ„ä»¶æ²’æœ‰è™•ç†ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
            await NotificationService.ShowInfoAsync(
                $"è«‹åœ¨ä¸»ç•«é¢ä¸­é–‹å•Ÿ {document.TypeDisplayName}: {document.DocumentNumber}", 
                "æç¤º"
            );
        }
    }
    
    /// <summary>
    /// æª¢æŸ¥æŒ‡å®šçš„æ¡è³¼è¨‚å–®æ˜ç´°é …ç›®æ˜¯å¦å·²è¢«å…¥åº«å–®ä½¿ç”¨
    /// </summary>
    private async Task<bool> HasUsageRecord(ProductItem item)
    {
        if (item.ExistingDetailEntity is not PurchaseOrderDetail detail || detail.Id <= 0)
        {
            return false;
        }

        try
        {
            var documents = await RelatedDocumentsHelper.GetRelatedDocumentsForPurchaseOrderDetailAsync(detail.Id);
            var hasUsage = documents?.Any() == true;
            return hasUsage;
        }
        catch
        {
            return false;
        }
    }
    
    /// <summary>
    /// æª¢æŸ¥é …ç›®æ˜¯å¦å¯ä»¥åˆªé™¤
    /// </summary>
    private bool CanDeleteItem(ProductItem item, out string reason)
    {
        // æ–°é …ç›®ï¼ˆæœªå„²å­˜ï¼‰å¯ä»¥åˆªé™¤
        if (item.ExistingDetailEntity == null || item.ExistingDetailEntity.Id <= 0)
        {
            reason = string.Empty;
            return true;
        }
        
        // æª¢æŸ¥æ˜¯å¦å·²æœ‰å…¥åº«è¨˜éŒ„ï¼ˆé€™å€‹æ–¹æ³•æ˜¯åŒæ­¥çš„ï¼Œç„¡æ³•ç›´æ¥å‘¼å« async æ–¹æ³•ï¼‰
        // å› æ­¤æˆ‘å€‘åœ¨ CustomActionsTemplate ä¸­æœƒä½¿ç”¨ä¸åŒçš„ç­–ç•¥
        reason = string.Empty;
        return true;
    }
    
    /// <summary>
    /// å–å¾—ç•¶å‰ä½¿ç”¨è€…ID
    /// </summary>
    private async Task<int?> GetCurrentUserIdAsync()
    {
        return await CurrentUserHelper.GetCurrentEmployeeIdAsync(AuthenticationStateProvider);
    }

    public class ProductItem
    {
        public Product? SelectedProduct { get; set; }
        public int Quantity { get; set; } = 0;
        public int ReceivedQuantity { get; set; } = 0;
        public decimal Price { get; set; } = 0;
        public string Remarks { get; set; } = string.Empty;
        public bool IsReceivingCompleted { get; set; } = false;
        public int? CompletedByEmployeeId { get; set; }
        public DateTime? CompletedAt { get; set; }
        public TDetailEntity? ExistingDetailEntity { get; set; }
        
        // æ¨™è¨˜æ˜¯å¦å·²è¢«å…¥åº«å–®ä½¿ç”¨ï¼ˆé¿å…é‡è¤‡æŸ¥è©¢ï¼‰
        public bool? HasUsageRecordCache { get; set; } = null;
    }
}
