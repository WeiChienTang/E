@* 銷貨出貨明細管理組件 - 使用 InteractiveTableComponent 統一UI *@

@using ERPCore2.Helpers
@inject IProductService ProductService
@inject ISalesOrderService SalesOrderService
@inject INotificationService NotificationService
@inject IInventoryStockService InventoryStockService

@typeparam TMainEntity where TMainEntity : BaseEntity
@typeparam TDetailEntity where TDetailEntity : BaseEntity, new()

@if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
            <p class="text-muted mb-0">請先選擇客戶</p>
        </div>
    </div>
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="DeliveryItem"
                                      Items="@DeliveryItems"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      ShowHeader="true"
                                      ShowRowNumbers="true"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="true"
                                      IsReadOnly="@IsReadOnly"
                                      DeleteButtonTitle="刪除"
                                      EmptyMessage="@EmptyMessage"
                                      OnItemDelete="@HandleItemDelete"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"
                                      EnableAutoEmptyRow="true"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@CreateNewEmptyItem" />
        </div>

        <div class="card-footer">
            <div class="d-flex justify-content-between">
                <div>
                    <GenericButtonComponent Text="載入訂單"
                                          Variant="ButtonVariant.Info"
                                          IsDisabled="@(!CanLoadAllUndelivered)"
                                          Title="@GetLoadAllUndeliveredTooltip()"
                                          OnClick="LoadAllUndeliveredItems" />
                </div>
                <div class="d-flex gap-2">
                    <GenericButtonComponent Text="明細清除"
                                          Variant="ButtonVariant.Danger"
                                          IsDisabled="@(IsReadOnly || !DeliveryItems.Any(item => item.ProductId > 0))"
                                          Title="@(IsReadOnly ? "唯讀模式" : DeliveryItems.Any(item => item.ProductId > 0) ? "清除所有出貨明細" : "沒有可清除的明細項目")"
                                          OnClick="ClearAllDetails" />
                </div>
            </div>
        </div>
    </div>
}

@code {
    // ===== InteractiveTableComponent 參考 =====
    private InteractiveTableComponent<DeliveryItem>? tableComponent;
    
    // ===== 資料載入完成標記 =====
    private bool _dataLoadCompleted = true;  // 資料載入完成標記
    
    // ===== 建立空項目方法 =====
    private DeliveryItem CreateNewEmptyItem()
    {
        return new DeliveryItem();  //  返回新的空物件，所有屬性都是預設值（null）
    }
    
    // ===== 基本參數 =====
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public EventCallback<List<DeliveryItem>> OnDeliveryItemsChanged { get; set; }
    
    // ===== 客戶過濾參數 =====
    [Parameter] public int? SelectedCustomerId { get; set; }
    
    // ===== 泛型參數 =====
    [Parameter] public TMainEntity? MainEntity { get; set; }
    [Parameter] public List<TDetailEntity> ExistingDetails { get; set; } = new List<TDetailEntity>();
    [Parameter] public EventCallback<List<TDetailEntity>> OnDetailsChanged { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    
    // ===== 欄位映射參數 =====
    [Parameter] public string MainEntityIdPropertyName { get; set; } = string.Empty;
    [Parameter] public string QuantityPropertyName { get; set; } = "DeliveryQuantity";
    [Parameter] public string UnitPricePropertyName { get; set; } = "UnitPrice";
    [Parameter] public string RemarksPropertyName { get; set; } = "Remarks";
    [Parameter] public string? UnitIdPropertyName { get; set; }
    [Parameter] public string? WarehouseIdPropertyName { get; set; }
    [Parameter] public string? WarehouseLocationIdPropertyName { get; set; }
    
    // ===== 顯示控制參數 =====
    [Parameter] public bool ShowWarehouse { get; set; } = true;
    [Parameter] public bool ShowWarehouseLocation { get; set; } = true;
    
    // ===== 顯示標籤參數 =====
    [Parameter] public string QuantityLabel { get; set; } = "數量";
    [Parameter] public string PriceLabel { get; set; } = "單價";
    [Parameter] public string RemarksLabel { get; set; } = "備註";
    [Parameter] public string WarehouseLabel { get; set; } = "倉庫";
    [Parameter] public string WarehouseLocationLabel { get; set; } = "庫位";
    
    // ===== 顯示設定 =====
    [Parameter] public string Title { get; set; } = "出貨明細";
    [Parameter] public string EmptyMessage { get; set; } = "尚未新增出貨商品";
    
    // ===== 唯讀模式參數 =====
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== 篩選參數 =====
    [Parameter] public int? SelectedSalesOrderId { get; set; }  //  用於過濾指定訂單的明細
    
    // ===== 下拉選項參數 =====
    [Parameter] public List<Warehouse> Warehouses { get; set; } = new List<Warehouse>();
    [Parameter] public List<WarehouseLocation> WarehouseLocations { get; set; } = new List<WarehouseLocation>();

    private List<DeliveryItem> DeliveryItems { get; set; } = new List<DeliveryItem>();
    private List<Product> AvailableProducts { get; set; } = new List<Product>();
    private List<SalesOrderDetail> AvailableSalesDetails { get; set; } = new List<SalesOrderDetail>();
    private int? _previousSelectedCustomerId = null;
    private int _previousExistingDetailsCount = 0;  // 追蹤 ExistingDetails 數量變化
    private List<int> _deletedDetailIds { get; set; } = new List<int>();

    // ===== 計算屬性 =====
    /// <summary>
    /// 判斷是否可以使用「載入訂單」功能
    /// 規則：
    /// 1. 必須選擇客戶
    /// 2. 必須有可載入的訂單明細
    /// 3. 編輯模式下隱藏此按鈕（避免覆蓋現有資料）
    /// </summary>
    private bool CanLoadAllUndelivered => 
        SelectedCustomerId.HasValue && 
        SelectedCustomerId.Value > 0 && 
        GetAvailableSalesDetails().Any() &&
        !(ExistingDetails?.Any() == true); // 編輯模式（有現有明細）時隱藏
    
    /// <summary>
    /// 取得「載入訂單」按鈕的提示訊息
    /// </summary>
    private string GetLoadAllUndeliveredTooltip()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
            return "請先選擇客戶";
        
        if (!GetAvailableSalesDetails().Any())
            return "該客戶沒有未完成出貨的訂單明細";
        
        if (ExistingDetails?.Any() == true)
            return "編輯模式下無法載入訂單項目，以避免覆蓋現有資料";
        
        return "載入該客戶所有未完成出貨的訂單明細";
    }

    protected override async Task OnInitializedAsync()
    {
        // 初始化時記錄當前客戶ID和明細數量，避免 OnParametersSetAsync 誤判為變更
        _previousSelectedCustomerId = SelectedCustomerId;
        _previousExistingDetailsCount = ExistingDetails?.Count ?? 0;
        
        await LoadAvailableProductsAsync();
        await LoadExistingDetailsAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        
        // 檢查篩選參數是否變更
        bool customerChanged = _previousSelectedCustomerId != SelectedCustomerId;
        int currentExistingDetailsCount = ExistingDetails?.Count ?? 0;
        bool existingDetailsChanged = _previousExistingDetailsCount != currentExistingDetailsCount;
        
        //  關鍵：如果 ExistingDetails 有變化（例如從編輯模式返回），重新載入明細
        if (existingDetailsChanged)
        {
            _previousExistingDetailsCount = currentExistingDetailsCount;
            
            //  重新載入明細以顯示最新資料
            await LoadExistingDetailsAsync();
            return;
        }
        
        // 只在真正的客戶變更時才重新載入
        if (customerChanged)
        {
            _previousSelectedCustomerId = SelectedCustomerId;
            _previousExistingDetailsCount = currentExistingDetailsCount;
            
            await LoadAvailableProductsAsync();
            
            // 客戶變更時清空現有選項並重新載入
            DeliveryItems.Clear();
            await LoadExistingDetailsAsync();
            return;
        }
    }
    
    /// <summary>
    /// 公開的刷新方法，用於外部觸發明細刷新（例如：上下筆切換時）
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadExistingDetailsAsync();
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }

    // ===== InteractiveTableComponent 方法 =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // 訂單明細選擇欄位 - 使用 SearchableSelect 類型
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "訂單單號/商品編號/名稱",
            PropertyName = "SalesDetailSearchValue",
            EmptyCheckPropertyName = "SelectedSalesDetail",
            TriggerEmptyRowOnFilled = true,
            ColumnType = InteractiveColumnType.SearchableSelect,
            Width = "300px",
            Tooltip = "搜尋並選擇要出貨的訂單商品",
            Placeholder = "請輸入訂單單號或商品名稱",
            SearchValuePropertyName = nameof(DeliveryItem.SalesDetailSearchValue),
            FilteredItemsPropertyName = nameof(DeliveryItem.FilteredSalesDetails),
            ShowDropdownPropertyName = nameof(DeliveryItem.ShowSalesDetailDropdown),
            SelectedIndexPropertyName = nameof(DeliveryItem.SalesDetailSelectedIndex),
            ItemDisplayFormatter = (item) =>
            {
                var detail = (SalesOrderDetail)item;
                return FormatSalesDetailDisplayText(detail);
            },
            IsDisabledFunc = item => IsReadOnly,
            OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, (tuple) =>
            {
                var (item, searchValue) = tuple;
                OnSalesDetailSearchInput((DeliveryItem)item, searchValue);
            }),
            OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
            {
                var (item, selectedItem) = tuple;
                await OnSalesDetailSelectItem((DeliveryItem)item, (SalesOrderDetail?)selectedItem);
            }),
            OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnSalesDetailFocus((DeliveryItem)item);
            }),
            OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnSalesDetailBlur((DeliveryItem)item);
            }),
            EnableKeyboardNavigation = true,
            GetDropdownItems = (item) => ((DeliveryItem)item).FilteredSalesDetails,
            GetSelectedIndex = (item) => ((DeliveryItem)item).SalesDetailSelectedIndex,
            SetSelectedIndex = (item, index) => ((DeliveryItem)item).SalesDetailSelectedIndex = index,
            GetShowDropdown = (item) => ((DeliveryItem)item).ShowSalesDetailDropdown,
            SetShowDropdown = (item, show) => ((DeliveryItem)item).ShowSalesDetailDropdown = show,
            MaxDisplayItems = 20
        });

        // 數量欄位
        columns.Add(new InteractiveColumnDefinition
        {
            PropertyName = nameof(DeliveryItem.DeliveryQuantity),
            Title = QuantityLabel,
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            MinValue = 0,
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this,
                async args => await OnQuantityInput((DeliveryItem)args.Item1, args.Item2))
        });
            
        // 單價欄位
        columns.Add(new InteractiveColumnDefinition
        {
            PropertyName = nameof(DeliveryItem.UnitPrice),
            Title = PriceLabel,
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            MinValue = 0,
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this,
                async args => await OnUnitPriceInput((DeliveryItem)args.Item1, args.Item2))
        });
        
        // 小計欄位（唯讀）
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "小計",
            Tooltip = "數量 × 單價的總計",
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item =>
            {
                var deliveryItem = (DeliveryItem)item;
                var subtotal = (deliveryItem.DeliveryQuantity ?? 0) * (deliveryItem.UnitPrice ?? 0);
                var displayValue = NumberFormatHelper.FormatSmartZeroAsEmpty(subtotal);
                return @<div class="text-end fw-bold text-success">@displayValue</div>;
            }
        });

        // 倉庫 - 庫位選擇欄位（合併顯示，僅顯示有庫存的位置）
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "倉庫 - 庫位", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "200px",
            Tooltip = "選擇出貨的倉庫和庫位（僅顯示有庫存的位置）",
            CustomTemplate = item => 
            {
                var deliveryItem = (DeliveryItem)item;
                var selectedValue = deliveryItem.InventoryStockDetailId?.ToString() ?? "";
                var isDisabled = IsReadOnly || deliveryItem.ProductId <= 0 || !deliveryItem.AvailableWarehouseLocations.Any();
                
                if (IsReadOnly && deliveryItem.WarehouseId.HasValue)
                {
                    // 唯讀模式：顯示純文字
                    var warehouse = Warehouses.FirstOrDefault(w => w.Id == deliveryItem.WarehouseId);
                    var locationName = deliveryItem.WarehouseLocationId.HasValue 
                        ? deliveryItem.AvailableWarehouseLocations
                            .FirstOrDefault(d => d.Id == deliveryItem.InventoryStockDetailId)
                            ?.WarehouseLocation?.Name ?? "預設位置"
                        : "預設位置";
                    var displayText = warehouse != null 
                        ? $"{warehouse.Name} - {locationName}"
                        : "未設定";
                    
                    return @<span class="text-muted">
                        @displayText
                    </span>;
                }
                else
                {
                    // 可編輯模式：顯示下拉選單
                    return @<select class="form-select form-select-sm"
                                   value="@selectedValue"
                                   disabled="@isDisabled"
                                   @onchange="@(async (e) => await OnWarehouseLocationChanged(deliveryItem, e.Value))">
                        <option value="">請選擇</option>
                        @foreach (var stockDetail in deliveryItem.AvailableWarehouseLocations)
                        {
                            var warehouseName = stockDetail.Warehouse?.Name ?? "未知倉庫";
                            var locationName = stockDetail.WarehouseLocation?.Name ?? "預設位置";
                            var displayText = $"{warehouseName} - {locationName} (可用: {stockDetail.AvailableStock})";
                            <option value="@stockDetail.Id">@displayText</option>
                        }
                    </select>;
                }
            }
        });
        
        // 庫存量欄位 (只讀顯示，不儲存到資料庫)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "庫存量", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "100px",
            Tooltip = "選擇倉庫後顯示該商品的即時可用庫存量（唯讀）",
            CustomTemplate = item => 
            {
                var deliveryItem = (DeliveryItem)item;
                
                // 只有當選擇了商品和倉庫時才顯示庫存量
                if (deliveryItem.ProductId <= 0 || !deliveryItem.WarehouseId.HasValue)
                {
                    return @<span class="text-muted">-</span>;
                }
                
                // 顯示庫存量（有可能尚未載入）
                if (deliveryItem.CurrentStockQuantity.HasValue)
                {
                    var stockQty = deliveryItem.CurrentStockQuantity.Value;
                    var textColor = stockQty <= 0 ? "text-danger" : 
                                   stockQty < 10 ? "text-warning" : "text-success";
                    
                    return @<span class="@textColor fw-bold" title="即時可用庫存">
                        @stockQty.ToString("N0")
                    </span>;
                }
                else
                {
                    // 載入中
                    return @<span class="text-muted">
                        <i class="bi bi-hourglass-split"></i>
                    </span>;
                }
            }
        });

        // 備註欄位
        columns.Add(new InteractiveColumnDefinition
        {
            PropertyName = nameof(DeliveryItem.Remarks),
            Title = RemarksLabel,
            ColumnType = InteractiveColumnType.Input,
            Width = "200px",
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this,
                async args => await OnRemarksInput((DeliveryItem)args.Item1, args.Item2))
        });

        return columns;
    }

    private RenderFragment<DeliveryItem> GetCustomActionsTemplate => item => __builder =>
    {
        // 未來可以在此加入自訂操作按鈕（如查看相關單據等）
    };

    private async Task HandleItemDelete(DeliveryItem item)
    {
        var index = DeliveryItems.IndexOf(item);
        if (index >= 0)
        {
            // 如果是已存在的明細（有ID），加入刪除清單
            if (item.ExistingDetailEntity != null)
            {
                var detailId = GetExistingDetailId(item.ExistingDetailEntity);
                if (detailId > 0 && !_deletedDetailIds.Contains(detailId))
                {
                    _deletedDetailIds.Add(detailId);
                    await NotifyDeletedDetailsChanged();
                }
            }
            
            DeliveryItems.RemoveAt(index);
            await NotifyDetailsChanged();
        }
    }

    // ===== 內部方法 =====
    private async Task LoadAvailableProductsAsync()
    {
        try
        {
            if (SelectedCustomerId.HasValue && SelectedCustomerId.Value > 0)
            {
                // 載入該客戶的未出貨訂單明細
                AvailableSalesDetails = await SalesOrderService.GetDeliveryDetailsByCustomerAsync(
                    SelectedCustomerId.Value, 
                    includeCompleted: false,
                    checkApproval: false); // 永遠傳 false，載入所有明細
                
                // 從訂單明細中提取商品清單
                var productsFromOrders = AvailableSalesDetails
                    .Where(sod => sod.Product != null)
                    .Select(sod => sod.Product!)
                    .Distinct()
                    .ToList();
                
                // 合併所有可用商品
                AvailableProducts = Products
                    .Where(p => p.Status == EntityStatus.Active)
                    .Union(productsFromOrders)
                    .Distinct()
                    .ToList();
            }
            else
            {
                AvailableProducts = Products.Where(p => p.Status == EntityStatus.Active).ToList();
                AvailableSalesDetails = new List<SalesOrderDetail>();
            }
        }
        catch (Exception)
        {
            AvailableProducts = Products.Where(p => p.Status == EntityStatus.Active).ToList();
            AvailableSalesDetails = new List<SalesOrderDetail>();
        }
    }

    /// <summary>
    /// 取得可用的訂單明細清單
    /// 會根據 SelectedSalesOrderId 過濾指定訂單的明細
    /// </summary>
    private List<SalesOrderDetail> GetAvailableSalesDetails()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
        {
            return new List<SalesOrderDetail>();
        }
        
        var filteredDetails = AvailableSalesDetails.AsEnumerable();
        
        //  關鍵修正：如果指定了訂單ID，只載入該訂單的明細
        if (SelectedSalesOrderId.HasValue && SelectedSalesOrderId.Value > 0)
        {
            filteredDetails = filteredDetails.Where(sd => sd.SalesOrderId == SelectedSalesOrderId.Value);
        }
        
        return filteredDetails.ToList();
    }

    private Task LoadExistingDetailsAsync()
    {
        if (ExistingDetails == null || !ExistingDetails.Any())
        {
            DeliveryItems.Clear();
            _dataLoadCompleted = true;
            StateHasChanged();
            return Task.CompletedTask;
        }

        //  開始載入資料 - 設定為未完成
        _dataLoadCompleted = false;
        
        DeliveryItems.Clear();
        
        foreach (var detail in ExistingDetails)
        {
            var productId = GetPropertyValue<int>(detail, nameof(DeliveryItem.ProductId));
            var quantity = GetPropertyValue<decimal>(detail, QuantityPropertyName);
            var unitPrice = GetPropertyValue<decimal>(detail, UnitPricePropertyName);
            var remarks = GetPropertyValue<string>(detail, RemarksPropertyName);
            var warehouseId = !string.IsNullOrEmpty(WarehouseIdPropertyName) 
                ? GetPropertyValue<int?>(detail, WarehouseIdPropertyName) 
                : null;
            var warehouseLocationId = !string.IsNullOrEmpty(WarehouseLocationIdPropertyName) 
                ? GetPropertyValue<int?>(detail, WarehouseLocationIdPropertyName) 
                : null;

            var product = Products.FirstOrDefault(p => p.Id == productId);
            
            var deliveryItem = new DeliveryItem
            {
                ProductId = productId,
                SelectedProduct = product,  //  設定 SelectedProduct
                DeliveryQuantity = quantity,
                UnitPrice = unitPrice,
                Remarks = remarks ?? string.Empty,
                WarehouseId = warehouseId,
                WarehouseLocationId = warehouseLocationId,
                ExistingDetailEntity = detail,
                SalesDetailSearchValue = product != null 
                    ? (!string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name)
                        ? $"[{product.Code}] {product.Name}"
                        : (!string.IsNullOrEmpty(product.Code) ? $"[{product.Code}]" : product.Name ?? ""))
                    : string.Empty
            };

            // 非同步載入庫存資訊（不等待，讓 UI 先顯示）
            _ = Task.Run(async () =>
            {
                await LoadStockQuantityAsync(deliveryItem);
                await InvokeAsync(StateHasChanged);
            });

            DeliveryItems.Add(deliveryItem);
        }
        
        //  資料載入完成 - 觸發空行檢查
        _dataLoadCompleted = true;
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
        
        return Task.CompletedTask;
    }

    private List<TDetailEntity> ConvertToDetailEntities()
    {
        var validItems = DeliveryItems.Where(item => item.ProductId > 0).ToList();
        var detailEntities = new List<TDetailEntity>();

        foreach (var item in validItems)
        {
            TDetailEntity detailEntity;
            
            if (item.ExistingDetailEntity != null)
            {
                detailEntity = item.ExistingDetailEntity;
            }
            else
            {
                detailEntity = new TDetailEntity();
            }

            // 設定商品ID
            SetPropertyValue(detailEntity, nameof(DeliveryItem.ProductId), item.ProductId);
            
            // 設定數量
            SetPropertyValue(detailEntity, QuantityPropertyName, item.DeliveryQuantity ?? 0);
            
            // 設定單價
            SetPropertyValue(detailEntity, UnitPricePropertyName, item.UnitPrice ?? 0);
            
            // 設定備註
            SetPropertyValue(detailEntity, RemarksPropertyName, item.Remarks);
            
            // 設定倉庫（如果有）
            if (!string.IsNullOrEmpty(WarehouseIdPropertyName))
            {
                SetPropertyValue(detailEntity, WarehouseIdPropertyName, item.WarehouseId);
            }

            detailEntities.Add(detailEntity);
        }

        return detailEntities;
    }

    private async Task NotifyDetailsChanged()
    {
        var detailEntities = ConvertToDetailEntities();
        
        if (OnDetailsChanged.HasDelegate)
        {
            await OnDetailsChanged.InvokeAsync(detailEntities);
        }
        
        StateHasChanged();
    }

    private async Task NotifyDeletedDetailsChanged()
    {
        if (OnDeletedDetailsChanged.HasDelegate)
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds);
        }
    }

    private T? GetPropertyValue<T>(object obj, string propertyName)
    {
        if (obj == null || string.IsNullOrEmpty(propertyName))
            return default;

        var property = obj.GetType().GetProperty(propertyName);
        if (property == null)
            return default;

        var value = property.GetValue(obj);
        return value == null ? default : (T)value;
    }

    private void SetPropertyValue(object obj, string propertyName, object? value)
    {
        if (obj == null || string.IsNullOrEmpty(propertyName))
            return;

        var property = obj.GetType().GetProperty(propertyName);
        if (property != null && property.CanWrite)
        {
            try
            {
                if (value == null && property.PropertyType.IsValueType && 
                    Nullable.GetUnderlyingType(property.PropertyType) == null)
                {
                    return;
                }
                
                property.SetValue(obj, value);
            }
            catch
            {
                // 忽略設定失敗
            }
        }
    }

    // ===== 事件處理方法 =====
    
    private async Task OnWarehouseLocationChanged(DeliveryItem item, object? value)
    {
        if (value == null || !int.TryParse(value.ToString(), out int detailId))
        {
            item.WarehouseId = null;
            item.WarehouseLocationId = null;
            item.InventoryStockDetailId = null;
            item.CurrentStockQuantity = null;
        }
        else
        {
            // 從選擇的庫存明細中取得倉庫和庫位資訊
            var selectedDetail = item.AvailableWarehouseLocations.FirstOrDefault(d => d.Id == detailId);
            if (selectedDetail != null)
            {
                item.WarehouseId = selectedDetail.WarehouseId;
                item.WarehouseLocationId = selectedDetail.WarehouseLocationId;
                item.InventoryStockDetailId = detailId;
                item.CurrentStockQuantity = selectedDetail.AvailableStock;
            }
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    /// <summary>
    /// 載入指定項目的庫存量
    /// </summary>
    private async Task LoadStockQuantityAsync(DeliveryItem item)
    {
        try
        {
            if (item.ProductId <= 0)
            {
                item.AvailableWarehouseLocations.Clear();
                item.CurrentStockQuantity = null;
                return;
            }

            // 載入該商品的庫存（包含明細）
            var inventoryStocks = await InventoryStockService.GetByProductIdAsync(item.ProductId);
            
            // 從庫存主檔中提取所有庫存明細
            var stockDetails = inventoryStocks
                .SelectMany(s => s.InventoryStockDetails ?? new List<InventoryStockDetail>())
                .Where(d => d.AvailableStock > 0) // 只保留有庫存的位置
                .OrderByDescending(d => d.AvailableStock)
                .ToList();
            
            item.AvailableWarehouseLocations = stockDetails;

            // 如果之前有選擇倉庫和庫位，更新庫存量
            if (item.InventoryStockDetailId.HasValue)
            {
                var selectedDetail = item.AvailableWarehouseLocations
                    .FirstOrDefault(d => d.Id == item.InventoryStockDetailId.Value);
                if (selectedDetail != null)
                {
                    item.CurrentStockQuantity = selectedDetail.AvailableStock;
                }
            }
        }
        catch (Exception)
        {
            // 忽略錯誤，庫存量載入失敗不影響主要流程
            item.AvailableWarehouseLocations.Clear();
            item.CurrentStockQuantity = null;
        }
    }

    private async Task OnQuantityInput(DeliveryItem item, string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            item.DeliveryQuantity = null;
        }
        else if (decimal.TryParse(value, out var quantity))
        {
            item.DeliveryQuantity = quantity;
        }
        await NotifyDetailsChanged();
    }

    private async Task OnUnitPriceInput(DeliveryItem item, string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            item.UnitPrice = null;
        }
        else if (decimal.TryParse(value, out var price))
        {
            item.UnitPrice = price;
        }
        await NotifyDetailsChanged();
    }

    private async Task OnWarehouseChanged(DeliveryItem item, object? value)
    {
        if (value != null && int.TryParse(value.ToString(), out var warehouseId))
        {
            item.WarehouseId = warehouseId > 0 ? warehouseId : null;
            await NotifyDetailsChanged();
        }
    }

    private async Task OnRemarksInput(DeliveryItem item, string? value)
    {
        item.Remarks = value ?? string.Empty;
        await NotifyDetailsChanged();
    }

    private List<Product> GetAvailableProducts()
    {
        return AvailableProducts;
    }

    // ===== 訂單明細選擇事件處理（SearchableSelect）=====

    /// <summary>
    /// 訂單明細搜尋輸入事件
    /// </summary>
    private void OnSalesDetailSearchInput(DeliveryItem item, string? searchValue)
    {
        item.SalesDetailSearchValue = searchValue ?? string.Empty;
        
        var availableDetails = GetAvailableSalesDetails();
        
        // 確保當前選中的明細也在列表中
        if (item.SelectedSalesDetail != null && 
            !availableDetails.Any(d => d.Id == item.SelectedSalesDetail.Id))
        {
            availableDetails = new List<SalesOrderDetail>(availableDetails) { item.SelectedSalesDetail };
        }
        
        if (string.IsNullOrWhiteSpace(searchValue))
        {
            item.FilteredSalesDetails = availableDetails.Take(20).ToList();
        }
        else
        {
            item.FilteredSalesDetails = availableDetails
                .Where(d => 
                    (d.SalesOrder?.Code?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (d.Product?.Code?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (d.Product?.Name?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false))
                .Take(20)
                .ToList();
        }
        
        item.ShowSalesDetailDropdown = true;
        item.SalesDetailSelectedIndex = -1;
        StateHasChanged();
    }
    
    /// <summary>
    /// 訂單明細輸入框獲得焦點
    /// </summary>
    private void OnSalesDetailFocus(DeliveryItem item)
    {
        var availableDetails = GetAvailableSalesDetails();
        
        // 確保當前選中的明細也在列表中
        if (item.SelectedSalesDetail != null && 
            !availableDetails.Any(d => d.Id == item.SelectedSalesDetail.Id))
        {
            availableDetails = new List<SalesOrderDetail>(availableDetails) { item.SelectedSalesDetail };
        }
        
        item.FilteredSalesDetails = availableDetails.Take(20).ToList();
        item.ShowSalesDetailDropdown = true;
        item.SalesDetailSelectedIndex = -1;
        StateHasChanged();
    }
    
    /// <summary>
    /// 訂單明細輸入框失去焦點
    /// </summary>
    private void OnSalesDetailBlur(DeliveryItem item)
    {
        Task.Delay(200).ContinueWith(_ =>
        {
            item.ShowSalesDetailDropdown = false;
            InvokeAsync(StateHasChanged);
        });
    }
    
    /// <summary>
    /// 選擇訂單明細項目
    /// </summary>
    private async Task OnSalesDetailSelectItem(DeliveryItem deliveryItem, SalesOrderDetail? selectedDetail)
    {
        if (selectedDetail == null)
        {
            deliveryItem.SelectedSalesDetail = null;
            deliveryItem.SelectedProduct = null;
            deliveryItem.SalesDetailSearchValue = string.Empty;
            deliveryItem.ShowSalesDetailDropdown = false;
            deliveryItem.SalesDetailSelectedIndex = -1;
            deliveryItem.ProductId = 0;
            await NotifyDetailsChanged();
            return;
        }
        
        deliveryItem.SelectedSalesDetail = selectedDetail;
        deliveryItem.SelectedProduct = selectedDetail.Product;
        deliveryItem.ProductId = selectedDetail.ProductId;
        deliveryItem.SalesDetailSearchValue = FormatSalesDetailDisplayText(selectedDetail);
        deliveryItem.UnitPrice = selectedDetail.UnitPrice;
        deliveryItem.DeliveryQuantity = selectedDetail.OrderQuantity - selectedDetail.DeliveredQuantity; // 未出貨數量
        deliveryItem.WarehouseId = selectedDetail.WarehouseId;
        deliveryItem.ShowSalesDetailDropdown = false;
        deliveryItem.SalesDetailSelectedIndex = -1;
        
        // 載入該商品的庫存資訊
        await LoadStockQuantityAsync(deliveryItem);
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    /// <summary>
    /// 格式化訂單明細顯示文字（用於下拉選單）
    /// </summary>
    private string FormatSalesDetailDisplayText(SalesOrderDetail detail)
    {
        if (detail?.Product == null) return "";
        
        var product = detail.Product;
        var salesOrderNumber = detail.SalesOrder?.Code ?? "N/A";
        
        var productDisplay = !string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name)
            ? $"[{product.Code}] {product.Name}"
            : (!string.IsNullOrEmpty(product.Code) ? $"[{product.Code}]" : product.Name ?? "");
        
        return $"[{salesOrderNumber}] {productDisplay}";
    }

    private List<InteractiveSelectOption> GetWarehouseOptions()
    {
        var options = new List<InteractiveSelectOption>
        {
            new InteractiveSelectOption { Text = "-- 請選擇倉庫 --", Value = 0 }
        };
        
        options.AddRange(Warehouses.Select(w => new InteractiveSelectOption
        {
            Text = w.Name,
            Value = w.Id
        }));
        
        return options;
    }

    private int GetExistingDetailId(TDetailEntity entity)
    {
        var idProperty = entity.GetType().GetProperty("Id");
        if (idProperty != null)
        {
            var id = idProperty.GetValue(entity);
            if (id != null && int.TryParse(id.ToString(), out var intId))
            {
                return intId;
            }
        }
        return 0;
    }

    private decimal GetTotalAmount()
    {
        return DeliveryItems
            .Where(item => item.ProductId > 0)
            .Sum(item => item.SubtotalAmount);
    }

    // ===== 明細清除方法 =====
    /// <summary>
    /// 清除所有明細
    /// </summary>
    private async Task ClearAllDetails()
    {
        var nonEmptyItems = DeliveryItems.Where(item => item.ProductId > 0).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("沒有可清除的明細項目", "提示");
            return;
        }
        
        // 記錄所有要刪除的現有明細 ID
        foreach (var item in nonEmptyItems.Where(item => item.ExistingDetailEntity != null))
        {
            var entityId = GetExistingDetailId(item.ExistingDetailEntity!);
            if (entityId > 0 && !_deletedDetailIds.Contains(entityId))
            {
                _deletedDetailIds.Add(entityId);
            }
        }
        
        // 清空所有項目
        DeliveryItems.Clear();
        
        await NotifyDetailsChanged();
        await NotifyDeletedDetailsChanged();
        
        await NotificationService.ShowSuccessAsync($"已清除 {nonEmptyItems.Count} 項明細");
    }

    // ===== 載入訂單方法 =====
    
    /// <summary>
    /// 載入所有未出貨訂單的主要方法（公開方法，供父組件調用）
    /// </summary>
    public async Task LoadAllUndeliveredItems()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
        {
            await NotificationService.ShowWarningAsync("請先選擇客戶後再載入訂單");
            return;
        }

        var availableDetails = GetAvailableSalesDetails();
        
        if (!availableDetails.Any())
        {
            await NotificationService.ShowInfoAsync("目前沒有符合條件的未出貨訂單");
            return;
        }

        // 檢查是否有現有資料
        var hasExistingData = DeliveryItems.Any(item => item.ProductId > 0);
        
        if (hasExistingData)
        {
            // 簡單確認（實際可使用更好的對話框）
            await NotificationService.ShowWarningAsync(
                $"此操作將清空現有的出貨明細並載入 {availableDetails.Count} 項未出貨訂單。",
                "載入確認");
        }

        await LoadUndeliveredItemsInternal(availableDetails);
    }

    /// <summary>
    /// 內部方法：載入未出貨項目
    /// </summary>
    private async Task LoadUndeliveredItemsInternal(List<SalesOrderDetail> details)
    {
        try
        {
            //  開始載入資料 - 設定為未完成
            _dataLoadCompleted = false;
            
            // 清空現有項目
            DeliveryItems.Clear();

            // 載入所有未出貨項目
            foreach (var detail in details)
            {
                var deliveryItem = new DeliveryItem
                {
                    //  關鍵：設定 SelectedSalesDetail 用於空行檢查
                    SelectedSalesDetail = detail,
                    SelectedProduct = detail.Product,
                    SalesDetailSearchValue = FormatSalesDetailDisplayText(detail),
                    DeliveryQuantity = detail.OrderQuantity - detail.DeliveredQuantity, // 未出貨數量
                    UnitPrice = detail.UnitPrice,
                    WarehouseId = detail.WarehouseId, // 使用訂單明細的倉庫
                    Remarks = string.Empty
                };

                // 載入庫存資訊（非同步）
                _ = Task.Run(async () =>
                {
                    await LoadStockQuantityAsync(deliveryItem);
                    await InvokeAsync(StateHasChanged);
                });

                DeliveryItems.Add(deliveryItem);
            }
            
            // 通知變更
            await NotifyDetailsChanged();
            
            //  資料載入完成 - 觸發空行檢查
            _dataLoadCompleted = true;
            StateHasChanged();
            
            await NotificationService.ShowSuccessAsync(
                $"成功載入 {details.Count} 項未出貨訂單"
            );
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入未出貨訂單失敗：{ex.Message}");
        }
    }

    public async Task<bool> ValidateAsync()
    {
        var nonEmptyItems = DeliveryItems.Where(item => item.ProductId > 0).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("請至少新增一筆出貨明細");
            return false;
        }

        foreach (var item in nonEmptyItems)
        {
            if (item.ProductId <= 0)
            {
                await NotificationService.ShowWarningAsync("請選擇商品");
                return false;
            }

            if (!item.DeliveryQuantity.HasValue || item.DeliveryQuantity.Value <= 0)
            {
                await NotificationService.ShowWarningAsync("數量必須大於 0");
                return false;
            }

            if (!item.UnitPrice.HasValue || item.UnitPrice.Value < 0)
            {
                await NotificationService.ShowWarningAsync("單價不能為負數");
                return false;
            }

            //  檢查是否已選擇倉庫
            if (!item.WarehouseId.HasValue || item.WarehouseId.Value <= 0)
            {
                var product = Products.FirstOrDefault(p => p.Id == item.ProductId);
                var productName = product?.Name ?? $"商品ID: {item.ProductId}";
                await NotificationService.ShowWarningAsync($"商品「{productName}」尚未選擇倉庫，請選擇出貨倉庫");
                return false;
            }

            //  檢查庫存數量是否足夠
            if (!item.CurrentStockQuantity.HasValue)
            {
                var product = Products.FirstOrDefault(p => p.Id == item.ProductId);
                var productName = product?.Name ?? $"商品ID: {item.ProductId}";
                await NotificationService.ShowWarningAsync($"商品「{productName}」的庫存資料載入中，請稍後再試");
                return false;
            }

            if (item.CurrentStockQuantity.Value < item.DeliveryQuantity.Value)
            {
                var product = Products.FirstOrDefault(p => p.Id == item.ProductId);
                var productName = product?.Name ?? $"商品ID: {item.ProductId}";
                var warehouse = Warehouses.FirstOrDefault(w => w.Id == item.WarehouseId);
                var warehouseName = warehouse?.Name ?? "選定倉庫";
                
                await NotificationService.ShowWarningAsync(
                    $"商品「{productName}」在「{warehouseName}」的庫存不足！\n" +
                    $"目前可用庫存: {item.CurrentStockQuantity.Value:N0}，" +
                    $"出貨數量: {item.DeliveryQuantity.Value:N0}");
                return false;
            }
        }

        return true;
    }

    public class DeliveryItem
    {
        /// <summary>
        /// 商品ID（用於 Select 綁定）
        /// </summary>
        public int ProductId { get; set; }
        
        /// <summary>
        /// 選擇的商品物件（用於空行檢查）
        /// </summary>
        public Product? SelectedProduct { get; set; }
        
        // === 訂單明細相關屬性 ===
        public SalesOrderDetail? SelectedSalesDetail { get; set; }
        
        // === SearchableSelect 支援屬性 ===
        public string SalesDetailSearchValue { get; set; } = string.Empty;
        public List<SalesOrderDetail> FilteredSalesDetails { get; set; } = new();
        public bool ShowSalesDetailDropdown { get; set; } = false;
        public int SalesDetailSelectedIndex { get; set; } = -1;
        
        /// <summary>
        /// 數量（nullable，預設 null）
        /// </summary>
        public decimal? DeliveryQuantity { get; set; }
        
        /// <summary>
        /// 單價（nullable，預設 null）
        /// </summary>
        public decimal? UnitPrice { get; set; }
        
        public string Remarks { get; set; } = string.Empty;
        public int? WarehouseId { get; set; }
        public int? WarehouseLocationId { get; set; }
        
        /// <summary>
        /// 小計金額（計算屬性）
        /// </summary>
        public decimal SubtotalAmount => (DeliveryQuantity ?? 0) * (UnitPrice ?? 0);
        
        public TDetailEntity? ExistingDetailEntity { get; set; }
        
        /// <summary>
        /// 即時庫存量（不儲存到資料庫）
        /// </summary>
        public int? CurrentStockQuantity { get; set; }
        
        /// <summary>
        /// 庫存明細ID（用於選擇倉庫-庫位）
        /// </summary>
        public int? InventoryStockDetailId { get; set; }
        
        /// <summary>
        /// 可用的倉庫位置清單（僅顯示有庫存的位置）
        /// </summary>
        public List<InventoryStockDetail> AvailableWarehouseLocations { get; set; } = new();
    }
}
