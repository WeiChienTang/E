@* éŠ·è²¨å‡ºè²¨æ˜ç´°ç®¡ç†çµ„ä»¶ - ä½¿ç”¨ InteractiveTableComponent çµ±ä¸€UI *@

@using ERPCore2.Helpers
@using ERPCore2.Data.Enums
@inject IProductService ProductService
@inject ISalesOrderService SalesOrderService
@inject ISalesDeliveryDetailService SalesDeliveryDetailService
@inject INotificationService NotificationService
@inject IInventoryStockService InventoryStockService
@inject ISystemParameterService SystemParameterService
@inject IJSRuntime JSRuntime

@typeparam TMainEntity where TMainEntity : BaseEntity
@typeparam TDetailEntity where TDetailEntity : BaseEntity, new()

@if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
            <p class="text-muted mb-0">è«‹å…ˆé¸æ“‡å®¢æˆ¶</p>
        </div>
    </div>
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="DeliveryItem"
                                      Items="@DeliveryItems"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      ShowHeader="true"
                                      ShowRowNumbers="true"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="true"
                                      IsReadOnly="@IsReadOnly"
                                      DeleteButtonTitle="åˆªé™¤"
                                      EmptyMessage="@EmptyMessage"
                                      OnItemDelete="@HandleItemDelete"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"
                                      EnableAutoEmptyRow="true"
                                      AllowAddNewRow="@(!_hasUndeletableDetails && !IsReadOnly)"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@CreateNewEmptyItem" />
        </div>

        <div class="card-footer">
            <div class="d-flex justify-content-between">
                <div class="d-flex gap-2">
                    <GenericButtonComponent Text="æ™ºèƒ½ä¸‹å–®"
                                          Variant="ButtonVariant.DarkBlue"
                                          OnClick="LoadSmartDeliveryItems"
                                          IsDisabled="@(!CanLoadSmartDelivery || _hasUndeletableDetails)"
                                          Title="@GetSmartDeliveryTooltip()" />
                    <GenericButtonComponent Text="è¼‰å…¥è¨‚å–®"
                                          Variant="ButtonVariant.DarkBlue"
                                          IsDisabled="@(!CanLoadAllUndelivered || _hasUndeletableDetails)"
                                          Title="@GetLoadAllUndeliveredTooltip()"
                                          OnClick="LoadAllUndeliveredItems" />
                </div>
                <div class="d-flex gap-2">
                    <GenericButtonComponent Text="æ˜ç´°æ¸…é™¤"
                                          Variant="ButtonVariant.Red"
                                          IsDisabled="@(IsReadOnly || !DeliveryItems.Any(item => item.ProductId > 0) || _hasUndeletableDetails)"
                                          Title="@GetClearAllDetailsTooltip()"
                                          OnClick="ClearAllDetails" />
                </div>
            </div>
        </div>
    </div>
}

@code {
    // ===== InteractiveTableComponent åƒè€ƒ =====
    private InteractiveTableComponent<DeliveryItem>? tableComponent;
    
    // ===== è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜ =====
    private bool _dataLoadCompleted = true;  // è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜
    private bool _hasUndeletableDetails = false;  // æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²æœ‰é€€è²¨è¨˜éŒ„ï¼‰
    
    // ===== å»ºç«‹ç©ºé …ç›®æ–¹æ³• =====
    private DeliveryItem CreateNewEmptyItem()
    {
        return new DeliveryItem();  //  è¿”å›æ–°çš„ç©ºç‰©ä»¶ï¼Œæ‰€æœ‰å±¬æ€§éƒ½æ˜¯é è¨­å€¼ï¼ˆnullï¼‰
    }
    
    // ===== åŸºæœ¬åƒæ•¸ =====
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public EventCallback<List<DeliveryItem>> OnDeliveryItemsChanged { get; set; }
    
    // ===== å®¢æˆ¶éæ¿¾åƒæ•¸ =====
    [Parameter] public int? SelectedCustomerId { get; set; }
    
    // ===== é€€è²¨æ•¸é‡åƒæ•¸ =====
    [Parameter] public Dictionary<int, decimal>? ReturnedQuantities { get; set; }
    
    // ===== æ³›å‹åƒæ•¸ =====
    [Parameter] public TMainEntity? MainEntity { get; set; }
    [Parameter] public List<TDetailEntity> ExistingDetails { get; set; } = new List<TDetailEntity>();
    [Parameter] public EventCallback<List<TDetailEntity>> OnDetailsChanged { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    [Parameter] public EventCallback<bool> OnHasUndeletableDetailsChanged { get; set; }
    
    // ===== æ¬„ä½æ˜ å°„åƒæ•¸ =====
    [Parameter] public string MainEntityIdPropertyName { get; set; } = string.Empty;
    [Parameter] public string QuantityPropertyName { get; set; } = "DeliveryQuantity";
    [Parameter] public string UnitPricePropertyName { get; set; } = "UnitPrice";
    [Parameter] public string? DiscountPercentagePropertyName { get; set; } = "DiscountPercentage";
    [Parameter] public string RemarksPropertyName { get; set; } = "Remarks";
    [Parameter] public string? UnitIdPropertyName { get; set; }
    [Parameter] public string? WarehouseIdPropertyName { get; set; }
    [Parameter] public string? WarehouseLocationIdPropertyName { get; set; }
    
    // ===== é¡¯ç¤ºæ§åˆ¶åƒæ•¸ =====
    [Parameter] public bool ShowWarehouse { get; set; } = true;
    [Parameter] public bool ShowWarehouseLocation { get; set; } = true;
    
    // ===== é¡¯ç¤ºæ¨™ç±¤åƒæ•¸ =====
    [Parameter] public string QuantityLabel { get; set; } = "æ•¸é‡";
    [Parameter] public string PriceLabel { get; set; } = "å–®åƒ¹";
    [Parameter] public string RemarksLabel { get; set; } = "å‚™è¨»";
    [Parameter] public string WarehouseLabel { get; set; } = "å€‰åº«";
    [Parameter] public string WarehouseLocationLabel { get; set; } = "åº«ä½";
    
    // ===== é¡¯ç¤ºè¨­å®š =====
    [Parameter] public string Title { get; set; } = "å‡ºè²¨æ˜ç´°";
    [Parameter] public string EmptyMessage { get; set; } = "å°šæœªæ–°å¢å‡ºè²¨å•†å“";
    
    // ===== å”¯è®€æ¨¡å¼åƒæ•¸ =====
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== ç¯©é¸åƒæ•¸ =====
    [Parameter] public int? SelectedSalesOrderId { get; set; }  //  ç”¨æ–¼éæ¿¾æŒ‡å®šè¨‚å–®çš„æ˜ç´°
    
    // ===== ç¨…åˆ¥åƒæ•¸ï¼ˆæ–°å¢ï¼‰=====
    [Parameter] public TaxCalculationMethod TaxCalculationMethod { get; set; } = TaxCalculationMethod.TaxExclusive;
    
    // ===== ä¸‹æ‹‰é¸é …åƒæ•¸ =====
    [Parameter] public List<Warehouse> Warehouses { get; set; } = new List<Warehouse>();
    [Parameter] public List<WarehouseLocation> WarehouseLocations { get; set; } = new List<WarehouseLocation>();

    private List<DeliveryItem> DeliveryItems { get; set; } = new List<DeliveryItem>();
    private List<Product> AvailableProducts { get; set; } = new List<Product>();
    private List<SalesOrderDetail> AvailableSalesDetails { get; set; } = new List<SalesOrderDetail>();
    private int? _previousSelectedCustomerId = null;
    private List<int> _deletedDetailIds { get; set; } = new List<int>();
    
    // ç¨…ç‡å¿«å–è®Šæ•¸
    private decimal currentTaxRate = 5.0m;
    
    // ===== è¼”åŠ©è¨ˆç®—å±¬æ€§ =====
    private bool IsTaxCalculationMethodNoTax => TaxCalculationMethod == TaxCalculationMethod.NoTax;

    // ===== è¨ˆç®—å±¬æ€§ =====
    
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦å¯ä»¥ä½¿ç”¨ã€Œæ™ºèƒ½ä¸‹å–®ã€åŠŸèƒ½
    /// è¦å‰‡ï¼š
    /// 1. å¿…é ˆé¸æ“‡å®¢æˆ¶
    /// 2. ä¸å¯åœ¨å”¯è®€æ¨¡å¼
    /// 3. ä¸å¯åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹ä½¿ç”¨ï¼ˆé¿å…è¦†è“‹ç¾æœ‰è³‡æ–™ï¼‰
    /// </summary>
    private bool CanLoadSmartDelivery => 
        SelectedCustomerId.HasValue && 
        SelectedCustomerId.Value > 0 &&
        !IsReadOnly &&
        !(ExistingDetails?.Any() == true); // ç·¨è¼¯æ¨¡å¼ä¸‹ç¦ç”¨
    
    /// <summary>
    /// å–å¾—ã€Œæ™ºèƒ½ä¸‹å–®ã€æŒ‰éˆ•çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetSmartDeliveryTooltip()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
            return "è«‹å…ˆé¸æ“‡å®¢æˆ¶";
        
        if (IsReadOnly)
            return "å”¯è®€æ¨¡å¼ä¸‹ç„¡æ³•ä½¿ç”¨æ™ºèƒ½ä¸‹å–®";
        
        if (ExistingDetails?.Any() == true)
            return "ç·¨è¼¯æ¨¡å¼ä¸‹ç„¡æ³•ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè«‹åœ¨æ–°å¢æ¨¡å¼æ™‚ä½¿ç”¨";
        
        if (_hasUndeletableDetails)
            return "éƒ¨åˆ†æ˜ç´°å·²æœ‰é€€è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä½¿ç”¨æ™ºèƒ½ä¸‹å–®";
        
        return "è¼‰å…¥è©²å®¢æˆ¶ä¸Šæ¬¡å‡ºè²¨çš„å•†å“æ˜ç´°";
    }
    
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦å¯ä»¥ä½¿ç”¨ã€Œè¼‰å…¥è¨‚å–®ã€åŠŸèƒ½
    /// è¦å‰‡ï¼š
    /// 1. å¿…é ˆé¸æ“‡å®¢æˆ¶
    /// 2. å¿…é ˆæœ‰å¯è¼‰å…¥çš„è¨‚å–®æ˜ç´°
    /// 3. ç·¨è¼¯æ¨¡å¼ä¸‹éš±è—æ­¤æŒ‰éˆ•ï¼ˆé¿å…è¦†è“‹ç¾æœ‰è³‡æ–™ï¼‰
    /// </summary>
    private bool CanLoadAllUndelivered => 
        SelectedCustomerId.HasValue && 
        SelectedCustomerId.Value > 0 && 
        GetAvailableSalesDetails().Any() &&
        !(ExistingDetails?.Any() == true); // ç·¨è¼¯æ¨¡å¼ï¼ˆæœ‰ç¾æœ‰æ˜ç´°ï¼‰æ™‚éš±è—
    
    /// <summary>
    /// å–å¾—ã€Œè¼‰å…¥è¨‚å–®ã€æŒ‰éˆ•çš„æç¤ºè¨Šæ¯
    /// </summary>
    private string GetLoadAllUndeliveredTooltip()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
            return "è«‹å…ˆé¸æ“‡å®¢æˆ¶";
        
        if (!GetAvailableSalesDetails().Any())
            return "è©²å®¢æˆ¶æ²’æœ‰æœªå®Œæˆå‡ºè²¨çš„è¨‚å–®æ˜ç´°";
        
        if (ExistingDetails?.Any() == true)
            return "ç·¨è¼¯æ¨¡å¼ä¸‹ç„¡æ³•è¼‰å…¥è¨‚å–®é …ç›®ï¼Œä»¥é¿å…è¦†è“‹ç¾æœ‰è³‡æ–™";
        
        if (_hasUndeletableDetails)
            return "éƒ¨åˆ†æ˜ç´°å·²æœ‰é€€è²¨è¨˜éŒ„ï¼Œç„¡æ³•è¼‰å…¥è¨‚å–®";
        
        return "è¼‰å…¥è©²å®¢æˆ¶æ‰€æœ‰æœªå®Œæˆå‡ºè²¨çš„è¨‚å–®æ˜ç´°";
    }
    
    /// <summary>
    /// å–å¾—æ¸…é™¤æ˜ç´°æŒ‰éˆ•çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetClearAllDetailsTooltip()
    {
        if (IsReadOnly)
            return "å”¯è®€æ¨¡å¼ç„¡æ³•ä½¿ç”¨";
        
        if (!DeliveryItems.Any(item => item.ProductId > 0))
            return "æ²’æœ‰å¯æ¸…é™¤çš„æ˜ç´°é …ç›®";
        
        if (_hasUndeletableDetails)
            return "éƒ¨åˆ†æ˜ç´°å·²æœ‰é€€è²¨è¨˜éŒ„ï¼Œç„¡æ³•æ¸…é™¤æ˜ç´°";
        
        return "æ¸…é™¤æ‰€æœ‰å‡ºè²¨æ˜ç´°";
    }

    protected override async Task OnInitializedAsync()
    {
        // åˆå§‹åŒ–æ™‚è¨˜éŒ„ç•¶å‰å®¢æˆ¶IDï¼Œé¿å… OnParametersSetAsync èª¤åˆ¤ç‚ºè®Šæ›´
        _previousSelectedCustomerId = SelectedCustomerId;
        
        // è¼‰å…¥ç³»çµ±é è¨­ç¨…ç‡
        try
        {
            var allParams = await SystemParameterService.GetAllAsync();
            var systemParam = allParams.FirstOrDefault();
            if (systemParam != null)
            {
                currentTaxRate = systemParam.TaxRate;
            }
        }
        catch
        {
            currentTaxRate = 5.0m;
        }
        
        await LoadAvailableProductsAsync();
        await LoadExistingDetailsAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        
        // å®¢æˆ¶è®Šæ›´æ™‚é‡æ–°è¼‰å…¥
        if (_previousSelectedCustomerId != SelectedCustomerId)
        {
            _previousSelectedCustomerId = SelectedCustomerId;
            await LoadAvailableProductsAsync();
            
            DeliveryItems.Clear();
            
            if (ExistingDetails?.Any() != true)
            {
                _dataLoadCompleted = true;
                StateHasChanged();
            }
            else
            {
                await LoadExistingDetailsAsync();
            }
        }
    }
    
    /// <summary>
    /// å…¬é–‹çš„åˆ·æ–°æ–¹æ³•ï¼Œç”¨æ–¼å¤–éƒ¨è§¸ç™¼æ˜ç´°åˆ·æ–°ï¼ˆä¾‹å¦‚ï¼šä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼‰
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadExistingDetailsAsync();
        
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }

    // ===== InteractiveTableComponent æ–¹æ³• =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // å•†å“é¸æ“‡æ¬„ä½ - ä½¿ç”¨ SearchableSelect é¡å‹ï¼ˆæ”¯æ´è¨‚å–®æ˜ç´°å’Œä¸€èˆ¬å•†å“ï¼‰
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å•†å“ç·¨è™Ÿ/åç¨±",
            PropertyName = "ProductSearchValue",
            EmptyCheckPropertyName = "SelectedProduct",
            TriggerEmptyRowOnFilled = true,
            ColumnType = InteractiveColumnType.SearchableSelect,
            Width = "300px",
            Tooltip = "æœå°‹ä¸¦é¸æ“‡è¦å‡ºè²¨çš„è¨‚å–®å•†å“æˆ–ä¸€èˆ¬å•†å“",
            Placeholder = "è«‹è¼¸å…¥è¨‚å–®å–®è™Ÿæˆ–å•†å“ç·¨è™Ÿ/åç¨±",
            SearchValuePropertyName = nameof(DeliveryItem.ProductSearchValue),
            FilteredItemsPropertyName = nameof(DeliveryItem.FilteredItems),
            ShowDropdownPropertyName = nameof(DeliveryItem.ShowDropdown),
            SelectedIndexPropertyName = nameof(DeliveryItem.SelectedIndex),
            ItemDisplayFormatter = (item) =>
            {
                if (item is SalesOrderDetail detail)
                    return FormatSalesDetailDisplayText(detail);
                else if (item is Product product)
                    return FormatProductDisplayText(product);
                return string.Empty;
            },
            IsDisabledFunc = item => IsReadOnly,
            OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async (tuple) =>
            {
                var (item, searchValue) = tuple;
                await OnProductSearch((DeliveryItem)item, searchValue);
            }),
            OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
            {
                var (item, selectedItem) = tuple;
                await OnProductSelect((DeliveryItem)item, selectedItem);
            }),
            OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnProductFocus((DeliveryItem)item);
            }),
            OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnProductBlur((DeliveryItem)item);
            }),
            EnableKeyboardNavigation = true,
            GetDropdownItems = (item) => ((DeliveryItem)item).FilteredItems,
            GetSelectedIndex = (item) => ((DeliveryItem)item).SelectedIndex,
            SetSelectedIndex = (item, index) => ((DeliveryItem)item).SelectedIndex = index,
            GetShowDropdown = (item) => ((DeliveryItem)item).ShowDropdown,
            SetShowDropdown = (item, show) => ((DeliveryItem)item).ShowDropdown = show,
            MaxDisplayItems = 20
        });

        // æ•¸é‡æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        {
            PropertyName = nameof(DeliveryItem.DeliveryQuantity),
            Title = QuantityLabel,
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            MinValue = 0,
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this,
                async args => await OnQuantityInput((DeliveryItem)args.Item1, args.Item2))
        });
            
        // å–®åƒ¹æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        {
            PropertyName = nameof(DeliveryItem.UnitPrice),
            Title = PriceLabel,
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            MinValue = 0,
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this,
                async args => await OnUnitPriceInput((DeliveryItem)args.Item1, args.Item2))
        });
        
        // æŠ˜æ‰£æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "æŠ˜æ‰£%",
            PropertyName = nameof(DeliveryItem.DiscountPercentage),
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            MinValue = 0,
            MaxValue = 100,
            Tooltip = "æŠ˜æ‰£ç™¾åˆ†æ¯”ï¼ˆ0-100%ï¼‰",
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this,
                async args => await OnDiscountPercentageInput((DeliveryItem)args.Item1, args.Item2))
        });

        // ç¨…ç‡æ¬„ä½ï¼ˆæ–°å¢ï¼‰
        columns.Add(new InteractiveColumnDefinition
        {
            PropertyName = nameof(DeliveryItem.TaxRate),
            Title = "ç¨…ç‡%",
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            MinValue = 0,
            MaxValue = 100,
            IsDisabledFunc = item => IsReadOnly || IsTaxCalculationMethodNoTax,
            TooltipFunc = item => IsTaxCalculationMethodNoTax ? "ä¸å«ç¨…æ¨¡å¼ä¸‹ç¨…ç‡æ¬„ä½è¢«ç¦ç”¨" : "å•†å“ç¨…ç‡(%)",
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this,
                async args => await OnTaxRateInput((DeliveryItem)args.Item1, args.Item2))
        });
        
        // å°è¨ˆæ¬„ä½ï¼ˆå”¯è®€ï¼Œæ ¹æ“šç¨…åˆ¥è¨ˆç®—ï¼‰
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å°è¨ˆ",
            Tooltip = GetSubtotalTooltip(),
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item =>
            {
                var deliveryItem = (DeliveryItem)item;
                var subtotal = CalculateItemSubtotal(deliveryItem);
                var displayValue = NumberFormatHelper.FormatSmartZeroAsEmpty(subtotal);
                return @<div class="text-end fw-bold text-success">@displayValue</div>;
            }
        });

        // å€‰åº« - åº«ä½é¸æ“‡æ¬„ä½ï¼ˆåˆä½µé¡¯ç¤ºï¼Œåƒ…é¡¯ç¤ºæœ‰åº«å­˜çš„ä½ç½®ï¼‰
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å€‰åº« - åº«ä½", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "200px",
            Tooltip = "é¸æ“‡å‡ºè²¨çš„å€‰åº«å’Œåº«ä½ï¼ˆåƒ…é¡¯ç¤ºæœ‰åº«å­˜çš„ä½ç½®ï¼‰",
            CustomTemplate = item => 
            {
                var deliveryItem = (DeliveryItem)item;
                var selectedValue = deliveryItem.InventoryStockDetailId?.ToString() ?? "";
                var isDisabled = IsReadOnly || deliveryItem.ProductId <= 0 || !deliveryItem.AvailableWarehouseLocations.Any();
                
                if (IsReadOnly && deliveryItem.WarehouseId.HasValue)
                {
                    // å”¯è®€æ¨¡å¼ï¼šé¡¯ç¤ºç´”æ–‡å­—
                    var warehouse = Warehouses.FirstOrDefault(w => w.Id == deliveryItem.WarehouseId);
                    var locationName = deliveryItem.WarehouseLocationId.HasValue 
                        ? deliveryItem.AvailableWarehouseLocations
                            .FirstOrDefault(d => d.Id == deliveryItem.InventoryStockDetailId)
                            ?.WarehouseLocation?.Name ?? "é è¨­ä½ç½®"
                        : "é è¨­ä½ç½®";
                    var displayText = warehouse != null 
                        ? $"{warehouse.Name} - {locationName}"
                        : "æœªè¨­å®š";
                    
                    return @<span class="text-muted">
                        @displayText
                    </span>;
                }
                else
                {
                    // å¯ç·¨è¼¯æ¨¡å¼ï¼šé¡¯ç¤ºä¸‹æ‹‰é¸å–®
                    return @<select class="form-select form-select-sm"
                                   value="@selectedValue"
                                   disabled="@isDisabled"
                                   @onchange="@(async (e) => await OnWarehouseLocationChanged(deliveryItem, e.Value))">
                        <option value="">è«‹é¸æ“‡</option>
                        @foreach (var stockDetail in deliveryItem.AvailableWarehouseLocations)
                        {
                            var warehouseName = stockDetail.Warehouse?.Name ?? "æœªçŸ¥å€‰åº«";
                            var locationName = stockDetail.WarehouseLocation?.Name ?? "é è¨­ä½ç½®";
                            var displayText = $"{warehouseName} - {locationName} (å¯ç”¨: {stockDetail.AvailableStock})";
                            <option value="@stockDetail.Id">@displayText</option>
                        }
                    </select>;
                }
            }
        });
        
        // åº«å­˜é‡æ¬„ä½ (åªè®€é¡¯ç¤ºï¼Œä¸å„²å­˜åˆ°è³‡æ–™åº«)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "åº«å­˜é‡", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "100px",
            Tooltip = "é¸æ“‡å€‰åº«å¾Œé¡¯ç¤ºè©²å•†å“çš„å³æ™‚å¯ç”¨åº«å­˜é‡ï¼ˆå”¯è®€ï¼‰",
            CustomTemplate = item => 
            {
                var deliveryItem = (DeliveryItem)item;
                
                // åªæœ‰ç•¶é¸æ“‡äº†å•†å“å’Œå€‰åº«æ™‚æ‰é¡¯ç¤ºåº«å­˜é‡
                if (deliveryItem.ProductId <= 0 || !deliveryItem.WarehouseId.HasValue)
                {
                    return @<span class="text-muted">-</span>;
                }
                
                // é¡¯ç¤ºåº«å­˜é‡ï¼ˆæœ‰å¯èƒ½å°šæœªè¼‰å…¥ï¼‰
                if (deliveryItem.CurrentStockQuantity.HasValue)
                {
                    var stockQty = deliveryItem.CurrentStockQuantity.Value;
                    var textColor = stockQty <= 0 ? "text-danger" : 
                                   stockQty < 10 ? "text-warning" : "text-success";
                    
                    return @<span class="@textColor fw-bold" title="å³æ™‚å¯ç”¨åº«å­˜">
                        @stockQty.ToString("N0")
                    </span>;
                }
                else
                {
                    // è¼‰å…¥ä¸­
                    return @<span class="text-muted">
                        <i class="bi bi-hourglass-split"></i>
                    </span>;
                }
            }
        });

        // å‚™è¨»æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        {
            PropertyName = nameof(DeliveryItem.Remarks),
            Title = RemarksLabel,
            ColumnType = InteractiveColumnType.Input,
            Width = "200px",
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this,
                async args => await OnRemarksInput((DeliveryItem)args.Item1, args.Item2))
        });

        return columns;
    }

    private RenderFragment<DeliveryItem> GetCustomActionsTemplate => item => __builder =>
    {
        // æœªä¾†å¯ä»¥åœ¨æ­¤åŠ å…¥è‡ªè¨‚æ“ä½œæŒ‰éˆ•ï¼ˆå¦‚æŸ¥çœ‹ç›¸é—œå–®æ“šç­‰ï¼‰
    };

    private async Task HandleItemDelete(DeliveryItem item)
    {
        var index = DeliveryItems.IndexOf(item);
        if (index >= 0)
        {
            // å¦‚æœæ˜¯å·²å­˜åœ¨çš„æ˜ç´°ï¼ˆæœ‰IDï¼‰ï¼ŒåŠ å…¥åˆªé™¤æ¸…å–®
            if (item.ExistingDetailEntity != null)
            {
                var detailId = GetExistingDetailId(item.ExistingDetailEntity);
                if (detailId > 0 && !_deletedDetailIds.Contains(detailId))
                {
                    _deletedDetailIds.Add(detailId);
                    await NotifyDeletedDetailsChanged();
                }
            }
            
            DeliveryItems.RemoveAt(index);
            await NotifyDetailsChanged();
        }
    }

    // ===== å…§éƒ¨æ–¹æ³• =====
    private async Task LoadAvailableProductsAsync()
    {
        try
        {
            if (SelectedCustomerId.HasValue && SelectedCustomerId.Value > 0)
            {
                // è¼‰å…¥è©²å®¢æˆ¶çš„æœªå‡ºè²¨è¨‚å–®æ˜ç´°
                AvailableSalesDetails = await SalesOrderService.GetDeliveryDetailsByCustomerAsync(
                    SelectedCustomerId.Value, 
                    includeCompleted: false,
                    checkApproval: false);
                
                // è¼‰å…¥æ‰€æœ‰å•Ÿç”¨çš„å•†å“ï¼Œåªé¡¯ç¤ºå•†å“é¡åˆ¥æ¨™è¨˜ç‚ºå¯è²©å”®çš„å•†å“
                var allProducts = await ProductService.GetActiveProductsAsync();
                AvailableProducts = allProducts
                    .Where(p => p.ProductCategory != null && p.ProductCategory.IsSaleable)
                    .ToList();
            }
            else
            {
                AvailableProducts = new List<Product>();
                AvailableSalesDetails = new List<SalesOrderDetail>();
            }
        }
        catch
        {
            AvailableProducts = new List<Product>();
            AvailableSalesDetails = new List<SalesOrderDetail>();
        }
    }

    /// <summary>
    /// å–å¾—å¯ç”¨çš„è¨‚å–®æ˜ç´°æ¸…å–®
    /// æœƒæ ¹æ“š SelectedSalesOrderId éæ¿¾æŒ‡å®šè¨‚å–®çš„æ˜ç´°
    /// </summary>
    private List<SalesOrderDetail> GetAvailableSalesDetails()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
        {
            return new List<SalesOrderDetail>();
        }
        
        var filteredDetails = AvailableSalesDetails.AsEnumerable();
        
        //  é—œéµä¿®æ­£ï¼šå¦‚æœæŒ‡å®šäº†è¨‚å–®IDï¼Œåªè¼‰å…¥è©²è¨‚å–®çš„æ˜ç´°
        if (SelectedSalesOrderId.HasValue && SelectedSalesOrderId.Value > 0)
        {
            filteredDetails = filteredDetails.Where(sd => sd.SalesOrderId == SelectedSalesOrderId.Value);
        }
        
        return filteredDetails.ToList();
    }

    private async Task LoadExistingDetailsAsync()
    {
        if (ExistingDetails?.Any() != true)
        {
            return;
        }
        
        //  é–‹å§‹è¼‰å…¥è³‡æ–™ - è¨­å®šç‚ºæœªå®Œæˆ
        _dataLoadCompleted = false;
        
        DeliveryItems.Clear();
        
        foreach (var detail in ExistingDetails)
        {
            var productId = GetPropertyValue<int>(detail, nameof(DeliveryItem.ProductId));
            
            var quantity = GetPropertyValue<decimal>(detail, QuantityPropertyName);
            var unitPrice = GetPropertyValue<decimal>(detail, UnitPricePropertyName);
            var discountPercentage = !string.IsNullOrEmpty(DiscountPercentagePropertyName)
                ? GetPropertyValue<decimal>(detail, DiscountPercentagePropertyName)
                : 0;
            var remarks = GetPropertyValue<string>(detail, RemarksPropertyName);
            var taxRate = GetPropertyValue<decimal?>(detail, nameof(DeliveryItem.TaxRate));
            var warehouseId = !string.IsNullOrEmpty(WarehouseIdPropertyName) 
                ? GetPropertyValue<int?>(detail, WarehouseIdPropertyName) 
                : null;
            var warehouseLocationId = !string.IsNullOrEmpty(WarehouseLocationIdPropertyName) 
                ? GetPropertyValue<int?>(detail, WarehouseLocationIdPropertyName) 
                : null;

            // ä½¿ç”¨ AvailableProducts è€Œé Products åƒæ•¸ï¼ˆèˆ‡ PurchaseReceivingTable ä¸€è‡´ï¼‰
            var product = AvailableProducts.FirstOrDefault(p => p.Id == productId);
            
            var deliveryItem = new DeliveryItem
            {
                ProductId = productId,
                SelectedProduct = product,
                DeliveryQuantity = quantity,
                UnitPrice = unitPrice,
                DiscountPercentage = discountPercentage,
                Remarks = remarks ?? string.Empty,
                TaxRate = taxRate ?? product?.TaxRate ?? currentTaxRate,
                WarehouseId = warehouseId,
                WarehouseLocationId = warehouseLocationId,
                ExistingDetailEntity = detail,
                ProductSearchValue = product != null ? FormatProductDisplayText(product) : string.Empty
            };

            // éåŒæ­¥è¼‰å…¥åº«å­˜è³‡è¨Šï¼ˆä¸ç­‰å¾…ï¼Œè®“ UI å…ˆé¡¯ç¤ºï¼‰
            _ = Task.Run(async () =>
            {
                await LoadStockQuantityAsync(deliveryItem);
                await InvokeAsync(StateHasChanged);
            });

            DeliveryItems.Add(deliveryItem);
        }
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²æœ‰é€€è²¨è¨˜éŒ„ï¼‰
        bool hasUndeletableDetails = DeliveryItems.Any(item => 
            item.ExistingDetailEntity != null && 
            !DetailLockHelper.CanDeleteItem(item.ExistingDetailEntity, out _, 
                checkReturn: true, 
                returnedQuantities: ReturnedQuantities));
        if (_hasUndeletableDetails != hasUndeletableDetails)
        {
            _hasUndeletableDetails = hasUndeletableDetails;
            await NotifyHasUndeletableDetailsChanged();
        }
        
        //  è³‡æ–™è¼‰å…¥å®Œæˆ - è§¸ç™¼ç©ºè¡Œæª¢æŸ¥
        _dataLoadCompleted = true;
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }

    private List<TDetailEntity> ConvertToDetailEntities()
    {
        var validItems = DeliveryItems.Where(item => item.ProductId > 0).ToList();
        var detailEntities = new List<TDetailEntity>();

        foreach (var item in validItems)
        {
            TDetailEntity detailEntity;
            
            if (item.ExistingDetailEntity != null)
            {
                detailEntity = item.ExistingDetailEntity;
            }
            else
            {
                detailEntity = new TDetailEntity();
            }

            // è¨­å®šå•†å“ID
            SetPropertyValue(detailEntity, nameof(DeliveryItem.ProductId), item.ProductId);
            
            // ğŸ”¥ é—œéµï¼šè¨­å®šä¾†æºéŠ·è²¨è¨‚å–®æ˜ç´°IDï¼ˆå¦‚æœæ˜¯å¾è¨‚å–®è¼‰å…¥çš„ï¼‰
            if (item.SelectedSalesDetail != null)
            {
                SetPropertyValue(detailEntity, "SalesOrderDetailId", item.SelectedSalesDetail.Id);
            }
            
            // è¨­å®šæ•¸é‡
            SetPropertyValue(detailEntity, QuantityPropertyName, item.DeliveryQuantity ?? 0);
            
            // è¨­å®šå–®åƒ¹
            SetPropertyValue(detailEntity, UnitPricePropertyName, item.UnitPrice ?? 0);
            
            // è¨­å®šæŠ˜æ‰£
            if (!string.IsNullOrEmpty(DiscountPercentagePropertyName))
            {
                SetPropertyValue(detailEntity, DiscountPercentagePropertyName, item.DiscountPercentage);
            }
            
            // è¨­å®šç¨…ç‡
            SetPropertyValue(detailEntity, nameof(DeliveryItem.TaxRate), item.TaxRate);
            
            // è¨­å®šå‚™è¨»
            SetPropertyValue(detailEntity, RemarksPropertyName, item.Remarks);
            
            // è¨­å®šå€‰åº«ï¼ˆå¦‚æœæœ‰ï¼‰
            if (!string.IsNullOrEmpty(WarehouseIdPropertyName))
            {
                SetPropertyValue(detailEntity, WarehouseIdPropertyName, item.WarehouseId);
            }

            detailEntities.Add(detailEntity);
        }

        return detailEntities;
    }

    private async Task NotifyDetailsChanged()
    {
        var detailEntities = ConvertToDetailEntities();
        
        if (OnDetailsChanged.HasDelegate)
        {
            await DetailSyncHelper.SyncToParentAsync(detailEntities, OnDetailsChanged);
        }
        else
        {
            StateHasChanged();
        }
        
        // æª¢æŸ¥ä¸¦æ›´æ–°ä¸å¯åˆªé™¤æ˜ç´°çš„ç‹€æ…‹
        bool hasUndeletableDetails = DeliveryItems.Any(item => 
            item.ExistingDetailEntity != null && 
            !DetailLockHelper.CanDeleteItem(item.ExistingDetailEntity, out _, 
                checkReturn: true, 
                returnedQuantities: ReturnedQuantities));
        if (_hasUndeletableDetails != hasUndeletableDetails)
        {
            _hasUndeletableDetails = hasUndeletableDetails;
            await NotifyHasUndeletableDetailsChanged();
            tableComponent?.RefreshEmptyRow();  // åˆ·æ–°ç©ºè¡Œç‹€æ…‹
            StateHasChanged();
        }
    }

    /// <summary>
    /// é€šçŸ¥çˆ¶çµ„ä»¶ hasUndeletableDetails ç‹€æ…‹è®Šæ›´
    /// </summary>
    private async Task NotifyHasUndeletableDetailsChanged()
    {
        if (OnHasUndeletableDetailsChanged.HasDelegate)
        {
            await OnHasUndeletableDetailsChanged.InvokeAsync(_hasUndeletableDetails);
        }
    }

    private async Task NotifyDeletedDetailsChanged()
    {
        if (OnDeletedDetailsChanged.HasDelegate)
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds);
        }
    }

    private T? GetPropertyValue<T>(object obj, string propertyName)
    {
        if (obj == null || string.IsNullOrEmpty(propertyName))
            return default;

        var property = obj.GetType().GetProperty(propertyName);
        if (property == null)
            return default;

        var value = property.GetValue(obj);
        return value == null ? default : (T)value;
    }

    private void SetPropertyValue(object obj, string propertyName, object? value)
    {
        if (obj == null || string.IsNullOrEmpty(propertyName))
            return;

        var property = obj.GetType().GetProperty(propertyName);
        if (property != null && property.CanWrite)
        {
            try
            {
                if (value == null && property.PropertyType.IsValueType && 
                    Nullable.GetUnderlyingType(property.PropertyType) == null)
                {
                    return;
                }
                
                property.SetValue(obj, value);
            }
            catch
            {
                // å¿½ç•¥è¨­å®šå¤±æ•—
            }
        }
    }

    // ===== äº‹ä»¶è™•ç†æ–¹æ³• =====
    
    private async Task OnWarehouseLocationChanged(DeliveryItem item, object? value)
    {
        if (value == null || !int.TryParse(value.ToString(), out int detailId))
        {
            item.WarehouseId = null;
            item.WarehouseLocationId = null;
            item.InventoryStockDetailId = null;
            item.CurrentStockQuantity = null;
        }
        else
        {
            // å¾é¸æ“‡çš„åº«å­˜æ˜ç´°ä¸­å–å¾—å€‰åº«å’Œåº«ä½è³‡è¨Š
            var selectedDetail = item.AvailableWarehouseLocations.FirstOrDefault(d => d.Id == detailId);
            if (selectedDetail != null)
            {
                item.WarehouseId = selectedDetail.WarehouseId;
                item.WarehouseLocationId = selectedDetail.WarehouseLocationId;
                item.InventoryStockDetailId = detailId;
                item.CurrentStockQuantity = selectedDetail.AvailableStock;
            }
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    /// <summary>
    /// è¼‰å…¥æŒ‡å®šé …ç›®çš„åº«å­˜é‡
    /// </summary>
    private async Task LoadStockQuantityAsync(DeliveryItem item)
    {
        try
        {
            if (item.ProductId <= 0)
            {
                item.AvailableWarehouseLocations.Clear();
                item.CurrentStockQuantity = null;
                return;
            }

            // è¼‰å…¥è©²å•†å“çš„åº«å­˜ï¼ˆåŒ…å«æ˜ç´°ï¼‰
            var inventoryStocks = await InventoryStockService.GetByProductIdAsync(item.ProductId);
            
            // å¾åº«å­˜ä¸»æª”ä¸­æå–æ‰€æœ‰åº«å­˜æ˜ç´°
            var stockDetails = inventoryStocks
                .SelectMany(s => s.InventoryStockDetails ?? new List<InventoryStockDetail>())
                .Where(d => d.AvailableStock > 0) // åªä¿ç•™æœ‰åº«å­˜çš„ä½ç½®
                .OrderByDescending(d => d.AvailableStock)
                .ToList();
            
            item.AvailableWarehouseLocations = stockDetails;

            // å¦‚æœä¹‹å‰æœ‰é¸æ“‡å€‰åº«å’Œåº«ä½ï¼Œæ›´æ–°åº«å­˜é‡
            if (item.InventoryStockDetailId.HasValue)
            {
                var selectedDetail = item.AvailableWarehouseLocations
                    .FirstOrDefault(d => d.Id == item.InventoryStockDetailId.Value);
                if (selectedDetail != null)
                {
                    item.CurrentStockQuantity = selectedDetail.AvailableStock;
                }
            }
        }
        catch (Exception)
        {
            // å¿½ç•¥éŒ¯èª¤ï¼Œåº«å­˜é‡è¼‰å…¥å¤±æ•—ä¸å½±éŸ¿ä¸»è¦æµç¨‹
            item.AvailableWarehouseLocations.Clear();
            item.CurrentStockQuantity = null;
        }
    }

    private async Task OnQuantityInput(DeliveryItem item, string? value)
    {
        item.DeliveryQuantity = string.IsNullOrWhiteSpace(value) ? null : InputEventHelper.HandleQuantityInput(value);
        await NotifyDetailsChanged();
    }

    private async Task OnUnitPriceInput(DeliveryItem item, string? value)
    {
        item.UnitPrice = string.IsNullOrWhiteSpace(value) ? null : InputEventHelper.HandlePriceInput(value);
        await NotifyDetailsChanged();
    }

    private async Task OnWarehouseChanged(DeliveryItem item, object? value)
    {
        if (value != null && int.TryParse(value.ToString(), out var warehouseId))
        {
            item.WarehouseId = warehouseId > 0 ? warehouseId : null;
            await NotifyDetailsChanged();
        }
    }

    private async Task OnRemarksInput(DeliveryItem item, string? value)
    {
        item.Remarks = InputEventHelper.HandleTextInput(value);
        await NotifyDetailsChanged();
    }
    
    /// <summary>
    /// è™•ç†æŠ˜æ‰£è¼¸å…¥
    /// </summary>
    private async Task OnDiscountPercentageInput(DeliveryItem item, string? valueString)
    {
        if (string.IsNullOrWhiteSpace(valueString))
        {
            item.DiscountPercentage = 0;
        }
        else if (decimal.TryParse(valueString, out var percentage))
        {
            item.DiscountPercentage = Math.Max(0, Math.Min(100, percentage)); // é™åˆ¶åœ¨ 0-100 ä¹‹é–“
        }
        await NotifyDetailsChanged();
    }
    
    /// <summary>
    /// è™•ç†ç¨…ç‡è¼¸å…¥
    /// </summary>
    private async Task OnTaxRateInput(DeliveryItem item, string? valueString)
    {
        if (string.IsNullOrWhiteSpace(valueString))
        {
            item.TaxRate = null;
        }
        else if (decimal.TryParse(valueString, out var taxRate))
        {
            item.TaxRate = Math.Max(0, Math.Min(100, taxRate)); // é™åˆ¶åœ¨ 0-100 ä¹‹é–“
        }
        await NotifyDetailsChanged();
    }
    
    /// <summary>
    /// è¨ˆç®—æ˜ç´°é …ç›®çš„å°è¨ˆï¼ˆæ ¹æ“šç¨…åˆ¥ï¼Œå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
    /// </summary>
    private decimal CalculateItemSubtotal(DeliveryItem item)
    {
        if (item.SelectedProduct == null || (item.DeliveryQuantity ?? 0) <= 0 || (item.UnitPrice ?? 0) <= 0)
        {
            return 0;
        }
        
        var quantity = item.DeliveryQuantity ?? 0;
        var unitPrice = item.UnitPrice ?? 0;
        var discountPercentage = item.DiscountPercentage;
        var taxRate = item.TaxRate ?? 0;
        
        var subtotal = CalculationHelper.CalculateSubtotal(
            quantity,
            unitPrice,
            discountPercentage,
            taxRate,
            TaxCalculationMethod
        );
        
        // å››æ¨äº”å…¥åˆ°æ•´æ•¸
        return CalculationHelper.Round(subtotal, 0);
    }
    
    /// <summary>
    /// å–å¾—å°è¨ˆæ¬„ä½çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetSubtotalTooltip()
    {
        return TaxCalculationMethod switch
        {
            TaxCalculationMethod.TaxExclusive => "æ•¸é‡ Ã— å–®åƒ¹ Ã— (1 + ç¨…ç‡%)",
            TaxCalculationMethod.TaxInclusive => "æ•¸é‡ Ã— å–®åƒ¹ï¼ˆå–®åƒ¹å·²å«ç¨…ï¼‰",
            TaxCalculationMethod.NoTax => "æ•¸é‡ Ã— å–®åƒ¹ï¼ˆä¸å«ç¨…ï¼‰",
            _ => "æ•¸é‡ Ã— å–®åƒ¹çš„ç¸½è¨ˆ"
        };
    }

    private List<Product> GetAvailableProducts()
    {
        return AvailableProducts;
    }

    // ===== å•†å“é¸æ“‡äº‹ä»¶è™•ç†ï¼ˆSearchableSelectï¼‰- æ”¯æ´è¨‚å–®æ˜ç´°å’Œä¸€èˆ¬å•†å“ =====

    /// <summary>
    /// å•†å“æœå°‹è¼¸å…¥äº‹ä»¶ï¼ˆæ”¯æ´è¨‚å–®æ˜ç´°å’Œä¸€èˆ¬å•†å“ï¼‰
    /// </summary>
    private Task OnProductSearch(DeliveryItem item, string? searchValue)
    {
        item.ProductSearchValue = searchValue ?? string.Empty;
        
        var combinedItems = new List<object>();
        var availableDetails = GetAvailableSalesDetails();
        
        // åªé¡¯ç¤ºå•†å“é¡åˆ¥æ¨™è¨˜ç‚ºå¯è²©å”®çš„å•†å“
        var availableProducts = AvailableProducts
            .Where(p => p.ProductCategory != null && p.ProductCategory.IsSaleable)
            .ToList();
        
        // ç¢ºä¿ç•¶å‰é¸ä¸­çš„å•†å“ä¹Ÿåœ¨åˆ—è¡¨ä¸­
        if (item.SelectedProduct != null && 
            !availableProducts.Any(p => p.Id == item.SelectedProduct.Id))
        {
            availableProducts = new List<Product>(availableProducts) { item.SelectedProduct };
        }
        
        if (!string.IsNullOrWhiteSpace(searchValue))
        {
            // 1. æœå°‹è¨‚å–®æ˜ç´°ï¼ˆå„ªå…ˆé¡¯ç¤ºï¼‰
            var filteredDetails = availableDetails
                .Where(d =>
                    (d.SalesOrder?.Code != null && d.SalesOrder.Code.Contains(searchValue, StringComparison.OrdinalIgnoreCase)) ||
                    (d.Product?.Code != null && d.Product.Code.Contains(searchValue, StringComparison.OrdinalIgnoreCase)) ||
                    (d.Product?.Name != null && d.Product.Name.Contains(searchValue, StringComparison.OrdinalIgnoreCase)))
                .Take(10)
                .ToList();
            
            // 2. æœå°‹ä¸€èˆ¬å•†å“ï¼ˆåªé¡¯ç¤ºå¯è²©å”®çš„ï¼‰
            var filteredProducts = availableProducts
                .Where(p =>
                    (p.Code != null && p.Code.Contains(searchValue, StringComparison.OrdinalIgnoreCase)) ||
                    (p.Name != null && p.Name.Contains(searchValue, StringComparison.OrdinalIgnoreCase)))
                .Take(10)
                .ToList();
            
            combinedItems.AddRange(filteredDetails.Cast<object>());
            combinedItems.AddRange(filteredProducts.Cast<object>());
        }
        else
        {
            // æ²’æœ‰æœå°‹æ¢ä»¶æ™‚ï¼Œå„ªå…ˆé¡¯ç¤ºè¨‚å–®æ˜ç´°ï¼Œç„¶å¾Œæ˜¯ä¸€èˆ¬å•†å“ï¼ˆåªé¡¯ç¤ºå¯è²©å”®çš„ï¼‰
            var topDetails = availableDetails.Take(10).ToList();
            var topProducts = availableProducts.Take(10).ToList();
            
            combinedItems.AddRange(topDetails.Cast<object>());
            combinedItems.AddRange(topProducts.Cast<object>());
        }
        
        item.FilteredItems = combinedItems;
        item.ShowDropdown = true;
        item.SelectedIndex = -1;
        
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    /// <summary>
    /// å•†å“è¼¸å…¥æ¡†ç²å¾—ç„¦é»
    /// </summary>
    private void OnProductFocus(DeliveryItem item)
    {
        _ = OnProductSearch(item, item.ProductSearchValue);
    }
    
    /// <summary>
    /// å•†å“è¼¸å…¥æ¡†å¤±å»ç„¦é»
    /// </summary>
    private void OnProductBlur(DeliveryItem item)
    {
        Task.Delay(200).ContinueWith(_ =>
        {
            item.ShowDropdown = false;
            InvokeAsync(StateHasChanged);
        });
    }
    
    /// <summary>
    /// é¸æ“‡å•†å“é …ç›®ï¼ˆæ”¯æ´è¨‚å–®æ˜ç´°æˆ–ä¸€èˆ¬å•†å“ï¼‰
    /// </summary>
    private async Task OnProductSelect(DeliveryItem item, object? selectedItem)
    {
        if (selectedItem is SalesOrderDetail detail)
        {
            // é¸æ“‡è¨‚å–®æ˜ç´°
            item.SelectedSalesDetail = detail;
            item.SelectedProduct = detail.Product;
            item.ProductId = detail.ProductId;
            item.ProductSearchValue = FormatSalesDetailDisplayText(detail);
            item.UnitPrice = detail.UnitPrice;
            item.DeliveryQuantity = detail.OrderQuantity - detail.DeliveredQuantity; // æœªå‡ºè²¨æ•¸é‡
            item.DiscountPercentage = detail.DiscountPercentage;
            item.WarehouseId = detail.WarehouseId;
            item.TaxRate = detail.TaxRate ?? detail.Product?.TaxRate ?? currentTaxRate;
        }
        else if (selectedItem is Product product)
        {
            // é¸æ“‡ä¸€èˆ¬å•†å“
            item.SelectedSalesDetail = null;
            item.SelectedProduct = product;
            item.ProductId = product.Id;
            item.ProductSearchValue = FormatProductDisplayText(product);
            item.UnitPrice = null; // éœ€æ‰‹å‹•è¼¸å…¥å–®åƒ¹
            item.DeliveryQuantity = null; // éœ€æ‰‹å‹•è¼¸å…¥æ•¸é‡
            item.DiscountPercentage = 0; // é è¨­ç„¡æŠ˜æ‰£
            item.TaxRate = product.TaxRate ?? currentTaxRate;
        }
        else
        {
            item.SelectedSalesDetail = null;
            item.SelectedProduct = null;
            item.ProductId = 0;
            item.ProductSearchValue = string.Empty;
        }
        
        item.ShowDropdown = false;
        item.SelectedIndex = -1;
        
        // è¼‰å…¥è©²å•†å“çš„åº«å­˜è³‡è¨Š
        if (item.SelectedProduct != null)
        {
            await LoadStockQuantityAsync(item);
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    /// <summary>
    /// æ ¼å¼åŒ–è¨‚å–®æ˜ç´°é¡¯ç¤ºæ–‡å­—ï¼ˆç”¨æ–¼ä¸‹æ‹‰é¸å–®ï¼‰
    /// </summary>
    private string FormatSalesDetailDisplayText(SalesOrderDetail detail)
    {
        if (detail?.Product == null) return "";
        
        var product = detail.Product;
        var salesOrderNumber = detail.SalesOrder?.Code ?? "N/A";
        
        var productDisplay = !string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name)
            ? $"[{product.Code}] {product.Name}"
            : (!string.IsNullOrEmpty(product.Code) ? $"[{product.Code}]" : product.Name ?? "");
        
        return $"[{salesOrderNumber}] {productDisplay}";
    }
    
    /// <summary>
    /// æ ¼å¼åŒ–ä¸€èˆ¬å•†å“é¡¯ç¤ºæ–‡å­—ï¼ˆç”¨æ–¼ä¸‹æ‹‰é¸å–®ï¼‰
    /// </summary>
    private string FormatProductDisplayText(Product product)
    {
        if (product == null) return "";
        
        if (!string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name))
            return $"[{product.Code}] {product.Name}";
        
        return product.Code ?? product.Name ?? "";
    }

    private List<InteractiveSelectOption> GetWarehouseOptions()
    {
        var options = new List<InteractiveSelectOption>
        {
            new InteractiveSelectOption { Text = "-- è«‹é¸æ“‡å€‰åº« --", Value = 0 }
        };
        
        options.AddRange(Warehouses.Select(w => new InteractiveSelectOption
        {
            Text = w.Name,
            Value = w.Id
        }));
        
        return options;
    }

    private int GetExistingDetailId(TDetailEntity entity)
    {
        var idProperty = entity.GetType().GetProperty("Id");
        if (idProperty != null)
        {
            var id = idProperty.GetValue(entity);
            if (id != null && int.TryParse(id.ToString(), out var intId))
            {
                return intId;
            }
        }
        return 0;
    }

    private decimal GetTotalAmount()
    {
        return DeliveryItems
            .Where(item => item.ProductId > 0)
            .Sum(item => item.SubtotalAmount);
    }

    // ===== æ˜ç´°æ¸…é™¤æ–¹æ³• =====
    /// <summary>
    /// æ¸…é™¤æ‰€æœ‰æ˜ç´°
    /// </summary>
    private async Task ClearAllDetails()
    {
        var nonEmptyItems = DeliveryItems.Where(item => item.ProductId > 0).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("æ²’æœ‰å¯æ¸…é™¤çš„æ˜ç´°é …ç›®", "æç¤º");
            return;
        }
        
        // è¨˜éŒ„æ‰€æœ‰è¦åˆªé™¤çš„ç¾æœ‰æ˜ç´° ID
        foreach (var item in nonEmptyItems.Where(item => item.ExistingDetailEntity != null))
        {
            var entityId = GetExistingDetailId(item.ExistingDetailEntity!);
            if (entityId > 0 && !_deletedDetailIds.Contains(entityId))
            {
                _deletedDetailIds.Add(entityId);
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰é …ç›®
        DeliveryItems.Clear();
        
        await NotifyDetailsChanged();
        await NotifyDeletedDetailsChanged();
        
        await NotificationService.ShowSuccessAsync($"å·²æ¸…é™¤ {nonEmptyItems.Count} é …æ˜ç´°");
    }
    
    // ===== æ™ºèƒ½ä¸‹å–®åŠŸèƒ½ =====
    
    /// <summary>
    /// æ™ºèƒ½ä¸‹å–® - è¼‰å…¥è©²å®¢æˆ¶æœ€è¿‘ä¸€æ¬¡å®Œæ•´çš„éŠ·è²¨å‡ºè²¨æ˜ç´°
    /// </summary>
    private async Task LoadSmartDeliveryItems()
    {
        if (IsReadOnly || !SelectedCustomerId.HasValue) return;
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰è³‡æ–™
        var hasExistingData = DeliveryItems.Any(item => item.ProductId > 0);
        
        if (hasExistingData)
        {
            if (!await ShowConfirmationAsync("è¼‰å…¥æ™ºèƒ½ä¸‹å–®", "æ­¤æ“ä½œå°‡è¦†è“‹ç¾æœ‰çš„å‡ºè²¨æ˜ç´°ï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ"))
            {
                return;
            }
        }

        // å¾æœå‹™ç²å–å®¢æˆ¶çš„æœ€è¿‘ä¸€æ¬¡å®Œæ•´å‡ºè²¨
        var lastDeliveryDetails = await SalesDeliveryDetailService.GetLastCompleteDeliveryAsync(SelectedCustomerId.Value);
        
        if (!lastDeliveryDetails.Any())
        {
            await NotificationService.ShowInfoAsync("è©²å®¢æˆ¶æ²’æœ‰éŠ·è²¨å‡ºè²¨æ­·å²ç´€éŒ„å¯åƒè€ƒ", "æ™ºèƒ½ä¸‹å–®");
            return;
        }

        // æ¸…ç©ºç¾æœ‰é …ç›®
        DeliveryItems.Clear();
        _deletedDetailIds.Clear();

        // å°‡æ­·å²å‡ºè²¨è½‰æ›ç‚ºæ–°çš„å‡ºè²¨é …ç›®
        foreach (var detail in lastDeliveryDetails)
        {
            var deliveryItem = new DeliveryItem
            {
                SelectedProduct = detail.Product,
                ProductId = detail.ProductId,
                DeliveryQuantity = detail.DeliveryQuantity,
                UnitPrice = detail.UnitPrice,
                DiscountPercentage = detail.DiscountPercentage,
                TaxRate = detail.TaxRate ?? detail.Product?.TaxRate ?? currentTaxRate,
                Remarks = detail.Remarks ?? "",
                WarehouseId = detail.WarehouseId
            };
            
            // åˆå§‹åŒ– ProductSearchValue
            if (deliveryItem.SelectedProduct != null)
            {
                deliveryItem.ProductSearchValue = FormatProductDisplayText(deliveryItem.SelectedProduct);
            }
            
            // è¼‰å…¥åº«å­˜è³‡è¨Šï¼ˆéåŒæ­¥ï¼‰
            _ = Task.Run(async () =>
            {
                await LoadStockQuantityAsync(deliveryItem);
                await InvokeAsync(StateHasChanged);
            });
            
            DeliveryItems.Add(deliveryItem);
        }
        
        await NotifyDetailsChanged();
        await NotificationService.ShowSuccessAsync($"å·²è¼‰å…¥ {lastDeliveryDetails.Count} é …å•†å“ä½œç‚ºåƒè€ƒ", "æ™ºèƒ½ä¸‹å–®å®Œæˆ");
        
        StateHasChanged();
    }
    
    /// <summary>
    /// é¡¯ç¤ºç¢ºèªå°è©±æ¡†
    /// </summary>
    private async Task<bool> ShowConfirmationAsync(string title, string message)
    {
        // æš«æ™‚ä½¿ç”¨ç°¡å–®çš„é€šçŸ¥ï¼Œç­‰å¾…ç¢ºèªå¾ŒåŸ·è¡Œ
        // åœ¨å¯¦éš›å°ˆæ¡ˆä¸­å¯èƒ½æœƒä½¿ç”¨æ›´ç²¾ç¾çš„å°è©±æ¡†çµ„ä»¶
        try 
        {
            await NotificationService.ShowInfoAsync(message, title);
            return true;
        }
        catch
        {
            return false;
        }
    }

    // ===== è¼‰å…¥è¨‚å–®æ–¹æ³• =====
    
    /// <summary>
    /// è¼‰å…¥æ‰€æœ‰æœªå‡ºè²¨è¨‚å–®çš„ä¸»è¦æ–¹æ³•ï¼ˆå…¬é–‹æ–¹æ³•ï¼Œä¾›çˆ¶çµ„ä»¶èª¿ç”¨ï¼‰
    /// </summary>
    public async Task LoadAllUndeliveredItems()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
        {
            await NotificationService.ShowWarningAsync("è«‹å…ˆé¸æ“‡å®¢æˆ¶å¾Œå†è¼‰å…¥è¨‚å–®");
            return;
        }

        var availableDetails = GetAvailableSalesDetails();
        
        if (!availableDetails.Any())
        {
            await NotificationService.ShowInfoAsync("ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æœªå‡ºè²¨è¨‚å–®");
            return;
        }

        // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰è³‡æ–™
        var hasExistingData = DeliveryItems.Any(item => item.ProductId > 0);
        
        if (hasExistingData)
        {
            // ç°¡å–®ç¢ºèªï¼ˆå¯¦éš›å¯ä½¿ç”¨æ›´å¥½çš„å°è©±æ¡†ï¼‰
            await NotificationService.ShowWarningAsync(
                $"æ­¤æ“ä½œå°‡æ¸…ç©ºç¾æœ‰çš„å‡ºè²¨æ˜ç´°ä¸¦è¼‰å…¥ {availableDetails.Count} é …æœªå‡ºè²¨è¨‚å–®ã€‚",
                "è¼‰å…¥ç¢ºèª");
        }

        await LoadUndeliveredItemsInternal(availableDetails);
    }

    /// <summary>
    /// å…§éƒ¨æ–¹æ³•ï¼šè¼‰å…¥æœªå‡ºè²¨é …ç›®
    /// </summary>
    private async Task LoadUndeliveredItemsInternal(List<SalesOrderDetail> details)
    {
        try
        {
            //  é–‹å§‹è¼‰å…¥è³‡æ–™ - è¨­å®šç‚ºæœªå®Œæˆ
            _dataLoadCompleted = false;
            
            // æ¸…ç©ºç¾æœ‰é …ç›®
            DeliveryItems.Clear();

            // è¼‰å…¥æ‰€æœ‰æœªå‡ºè²¨é …ç›®
            foreach (var detail in details)
            {
                var deliveryItem = new DeliveryItem
                {
                    // é—œéµï¼šè¨­å®š SelectedSalesDetail å’Œ SelectedProduct
                    SelectedSalesDetail = detail,
                    SelectedProduct = detail.Product,
                    ProductId = detail.ProductId,
                    ProductSearchValue = FormatSalesDetailDisplayText(detail),
                    DeliveryQuantity = detail.OrderQuantity - detail.DeliveredQuantity, // æœªå‡ºè²¨æ•¸é‡
                    UnitPrice = detail.UnitPrice,
                    TaxRate = detail.TaxRate ?? detail.Product?.TaxRate ?? currentTaxRate,
                    WarehouseId = detail.WarehouseId,
                    Remarks = string.Empty
                };

                // è¼‰å…¥åº«å­˜è³‡è¨Šï¼ˆéåŒæ­¥ï¼‰
                _ = Task.Run(async () =>
                {
                    await LoadStockQuantityAsync(deliveryItem);
                    await InvokeAsync(StateHasChanged);
                });

                DeliveryItems.Add(deliveryItem);
            }
            
            // é€šçŸ¥è®Šæ›´
            await NotifyDetailsChanged();
            
            //  è³‡æ–™è¼‰å…¥å®Œæˆ - è§¸ç™¼ç©ºè¡Œæª¢æŸ¥
            _dataLoadCompleted = true;
            StateHasChanged();
            
            await NotificationService.ShowSuccessAsync(
                $"æˆåŠŸè¼‰å…¥ {details.Count} é …æœªå‡ºè²¨è¨‚å–®"
            );
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥æœªå‡ºè²¨è¨‚å–®å¤±æ•—ï¼š{ex.Message}");
        }
    }

    public async Task<bool> ValidateAsync()
    {
        var nonEmptyItems = DeliveryItems.Where(item => item.ProductId > 0).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("è«‹è‡³å°‘æ–°å¢ä¸€ç­†å‡ºè²¨æ˜ç´°");
            return false;
        }

        foreach (var item in nonEmptyItems)
        {
            if (item.ProductId <= 0)
            {
                await NotificationService.ShowWarningAsync("è«‹é¸æ“‡å•†å“");
                return false;
            }

            if (!item.DeliveryQuantity.HasValue || item.DeliveryQuantity.Value <= 0)
            {
                await NotificationService.ShowWarningAsync("æ•¸é‡å¿…é ˆå¤§æ–¼ 0");
                return false;
            }

            if (!item.UnitPrice.HasValue || item.UnitPrice.Value < 0)
            {
                await NotificationService.ShowWarningAsync("å–®åƒ¹ä¸èƒ½ç‚ºè² æ•¸");
                return false;
            }

            //  æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡å€‰åº«
            if (!item.WarehouseId.HasValue || item.WarehouseId.Value <= 0)
            {
                var product = AvailableProducts.FirstOrDefault(p => p.Id == item.ProductId);
                var productName = product?.Name ?? $"å•†å“ID: {item.ProductId}";
                await NotificationService.ShowWarningAsync($"å•†å“ã€Œ{productName}ã€å°šæœªé¸æ“‡å€‰åº«ï¼Œè«‹é¸æ“‡å‡ºè²¨å€‰åº«");
                return false;
            }

            //  æª¢æŸ¥åº«å­˜æ•¸é‡æ˜¯å¦è¶³å¤ 
            if (!item.CurrentStockQuantity.HasValue)
            {
                var product = AvailableProducts.FirstOrDefault(p => p.Id == item.ProductId);
                var productName = product?.Name ?? $"å•†å“ID: {item.ProductId}";
                await NotificationService.ShowWarningAsync($"å•†å“ã€Œ{productName}ã€çš„åº«å­˜è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦");
                return false;
            }

            if (item.CurrentStockQuantity.Value < item.DeliveryQuantity.Value)
            {
                var product = AvailableProducts.FirstOrDefault(p => p.Id == item.ProductId);
                var productName = product?.Name ?? $"å•†å“ID: {item.ProductId}";
                var warehouse = Warehouses.FirstOrDefault(w => w.Id == item.WarehouseId);
                var warehouseName = warehouse?.Name ?? "é¸å®šå€‰åº«";
                
                await NotificationService.ShowWarningAsync(
                    $"å•†å“ã€Œ{productName}ã€åœ¨ã€Œ{warehouseName}ã€çš„åº«å­˜ä¸è¶³ï¼\n" +
                    $"ç›®å‰å¯ç”¨åº«å­˜: {item.CurrentStockQuantity.Value:N0}ï¼Œ" +
                    $"å‡ºè²¨æ•¸é‡: {item.DeliveryQuantity.Value:N0}");
                return false;
            }
        }

        return true;
    }

    public class DeliveryItem
    {
        /// <summary>
        /// å•†å“IDï¼ˆç”¨æ–¼ Select ç¶å®šï¼‰
        /// </summary>
        public int ProductId { get; set; }
        
        /// <summary>
        /// é¸æ“‡çš„å•†å“ç‰©ä»¶ï¼ˆç”¨æ–¼ç©ºè¡Œæª¢æŸ¥ï¼‰
        /// </summary>
        public Product? SelectedProduct { get; set; }
        
        // === è¨‚å–®æ˜ç´°ç›¸é—œå±¬æ€§ ===
        public SalesOrderDetail? SelectedSalesDetail { get; set; }
        
        // === SearchableSelect æ”¯æ´å±¬æ€§ï¼ˆé€šç”¨ï¼šæ”¯æ´ SalesOrderDetail å’Œ Productï¼‰===
        public string ProductSearchValue { get; set; } = string.Empty;
        public List<object> FilteredItems { get; set; } = new();
        public bool ShowDropdown { get; set; } = false;
        public int SelectedIndex { get; set; } = -1;
        
        /// <summary>
        /// æ•¸é‡ï¼ˆnullableï¼Œé è¨­ nullï¼‰
        /// </summary>
        public decimal? DeliveryQuantity { get; set; }
        
        /// <summary>
        /// å–®åƒ¹ï¼ˆnullableï¼Œé è¨­ nullï¼‰
        /// </summary>
        public decimal? UnitPrice { get; set; }
        
        /// <summary>
        /// æŠ˜æ‰£ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼Œé è¨­ 0ï¼‰
        /// </summary>
        public decimal DiscountPercentage { get; set; } = 0;
        
        /// <summary>
        /// ç¨…ç‡ï¼ˆnullableï¼Œé è¨­ nullï¼‰
        /// </summary>
        public decimal? TaxRate { get; set; }
        
        public string Remarks { get; set; } = string.Empty;
        public int? WarehouseId { get; set; }
        public int? WarehouseLocationId { get; set; }
        
        /// <summary>
        /// å°è¨ˆé‡‘é¡ï¼ˆè¨ˆç®—å±¬æ€§ï¼‰
        /// </summary>
        public decimal SubtotalAmount => (DeliveryQuantity ?? 0) * (UnitPrice ?? 0);
        
        public TDetailEntity? ExistingDetailEntity { get; set; }
        
        /// <summary>
        /// å³æ™‚åº«å­˜é‡ï¼ˆä¸å„²å­˜åˆ°è³‡æ–™åº«ï¼‰
        /// </summary>
        public int? CurrentStockQuantity { get; set; }
        
        /// <summary>
        /// åº«å­˜æ˜ç´°IDï¼ˆç”¨æ–¼é¸æ“‡å€‰åº«-åº«ä½ï¼‰
        /// </summary>
        public int? InventoryStockDetailId { get; set; }
        
        /// <summary>
        /// å¯ç”¨çš„å€‰åº«ä½ç½®æ¸…å–®ï¼ˆåƒ…é¡¯ç¤ºæœ‰åº«å­˜çš„ä½ç½®ï¼‰
        /// </summary>
        public List<InventoryStockDetail> AvailableWarehouseLocations { get; set; } = new();
    }
}
