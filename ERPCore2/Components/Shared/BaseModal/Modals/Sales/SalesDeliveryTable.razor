@* éŠ·è²¨å‡ºè²¨æ˜ç´°ç®¡ç†çµ„ä»¶ - ä½¿ç”¨ InteractiveTableComponent çµ±ä¸€UI *@

@inject IProductService ProductService
@inject INotificationService NotificationService
@inject IInventoryStockService InventoryStockService

@typeparam TMainEntity where TMainEntity : BaseEntity
@typeparam TDetailEntity where TDetailEntity : BaseEntity, new()

@if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
            <p class="text-muted mb-0">è«‹å…ˆé¸æ“‡å®¢æˆ¶</p>
        </div>
    </div>
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="DeliveryItem"
                                      Items="@DeliveryItems"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      ShowHeader="true"
                                      ShowRowNumbers="true"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="true"
                                      IsReadOnly="@IsReadOnly"
                                      DeleteButtonTitle="åˆªé™¤"
                                      EmptyMessage="@EmptyMessage"
                                      OnItemDelete="@HandleItemDelete"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"
                                      EnableAutoEmptyRow="true"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@(() => new DeliveryItem())" />
        </div>
    </div>
}

@code {
    // ===== InteractiveTableComponent åƒè€ƒ =====
    private InteractiveTableComponent<DeliveryItem>? tableComponent;
    
    // ===== è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜ =====
    private bool _dataLoadCompleted = true;  // è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜
    
    // ===== åŸºæœ¬åƒæ•¸ =====
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public EventCallback<List<DeliveryItem>> OnDeliveryItemsChanged { get; set; }
    
    // ===== å®¢æˆ¶éæ¿¾åƒæ•¸ =====
    [Parameter] public int? SelectedCustomerId { get; set; }
    
    // ===== æ³›å‹åƒæ•¸ =====
    [Parameter] public TMainEntity? MainEntity { get; set; }
    [Parameter] public List<TDetailEntity> ExistingDetails { get; set; } = new List<TDetailEntity>();
    [Parameter] public EventCallback<List<TDetailEntity>> OnDetailsChanged { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    
    // ===== æ¬„ä½æ˜ å°„åƒæ•¸ =====
    [Parameter] public string MainEntityIdPropertyName { get; set; } = string.Empty;
    [Parameter] public string QuantityPropertyName { get; set; } = "DeliveryQuantity";
    [Parameter] public string UnitPricePropertyName { get; set; } = "UnitPrice";
    [Parameter] public string RemarksPropertyName { get; set; } = "Remarks";
    [Parameter] public string? UnitIdPropertyName { get; set; }
    [Parameter] public string? WarehouseIdPropertyName { get; set; }
    [Parameter] public string? WarehouseLocationIdPropertyName { get; set; }
    
    // ===== é¡¯ç¤ºæ§åˆ¶åƒæ•¸ =====
    [Parameter] public bool ShowWarehouse { get; set; } = true;
    [Parameter] public bool ShowWarehouseLocation { get; set; } = true;
    
    // ===== é¡¯ç¤ºæ¨™ç±¤åƒæ•¸ =====
    [Parameter] public string QuantityLabel { get; set; } = "å‡ºè²¨æ•¸é‡";
    [Parameter] public string PriceLabel { get; set; } = "å–®åƒ¹";
    [Parameter] public string RemarksLabel { get; set; } = "å‚™è¨»";
    [Parameter] public string WarehouseLabel { get; set; } = "å€‰åº«";
    [Parameter] public string WarehouseLocationLabel { get; set; } = "åº«ä½";
    
    // ===== é¡¯ç¤ºè¨­å®š =====
    [Parameter] public string Title { get; set; } = "å‡ºè²¨æ˜ç´°";
    [Parameter] public string EmptyMessage { get; set; } = "å°šæœªæ–°å¢å‡ºè²¨å•†å“";
    
    // ===== å”¯è®€æ¨¡å¼åƒæ•¸ =====
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== ä¸‹æ‹‰é¸é …åƒæ•¸ =====
    [Parameter] public List<Warehouse> Warehouses { get; set; } = new List<Warehouse>();
    [Parameter] public List<WarehouseLocation> WarehouseLocations { get; set; } = new List<WarehouseLocation>();

    private List<DeliveryItem> DeliveryItems { get; set; } = new List<DeliveryItem>();
    private List<Product> AvailableProducts { get; set; } = new List<Product>();
    private List<int> _deletedDetailIds { get; set; } = new List<int>();

    protected override async Task OnInitializedAsync()
    {
        await LoadAvailableProductsAsync();
        await LoadExistingDetailsAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        // å®¢æˆ¶è®Šæ›´æ™‚é‡æ–°è¼‰å…¥å¯ç”¨å•†å“
        if (SelectedCustomerId.HasValue)
        {
            await LoadAvailableProductsAsync();
        }
    }
    
    /// <summary>
    /// å…¬é–‹çš„åˆ·æ–°æ–¹æ³•ï¼Œç”¨æ–¼å¤–éƒ¨è§¸ç™¼æ˜ç´°åˆ·æ–°ï¼ˆä¾‹å¦‚ï¼šä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼‰
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadAvailableProductsAsync();
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }

    // ===== InteractiveTableComponent æ–¹æ³• =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>
        {
            // å•†å“é¸æ“‡æ¬„ä½
            new InteractiveColumnDefinition
            {
                PropertyName = nameof(DeliveryItem.ProductId),
                Title = "å•†å“åç¨±",
                ColumnType = InteractiveColumnType.Select,
                Width = "250px",
                IsRequired = true,
                Options = GetProductOptions(),
                OnSelectionChanged = EventCallback.Factory.Create<(object, object?)>(this, 
                    async args => await OnProductChanged((DeliveryItem)args.Item1, args.Item2))
            },
            
            // å‡ºè²¨æ•¸é‡æ¬„ä½
            new InteractiveColumnDefinition
            {
                PropertyName = nameof(DeliveryItem.DeliveryQuantity),
                Title = QuantityLabel,
                ColumnType = InteractiveColumnType.Number,
                Width = "120px",
                IsRequired = true,
                MinValue = 0,
                OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this,
                    async args => await OnQuantityInput((DeliveryItem)args.Item1, args.Item2))
            },
            
            // å–®åƒ¹æ¬„ä½
            new InteractiveColumnDefinition
            {
                PropertyName = nameof(DeliveryItem.UnitPrice),
                Title = PriceLabel,
                ColumnType = InteractiveColumnType.Number,
                Width = "120px",
                IsRequired = true,
                MinValue = 0,
                OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this,
                    async args => await OnUnitPriceInput((DeliveryItem)args.Item1, args.Item2))
            },
            
            // å°è¨ˆæ¬„ä½ï¼ˆå”¯è®€ï¼‰
            new InteractiveColumnDefinition
            {
                PropertyName = nameof(DeliveryItem.SubtotalAmount),
                Title = "å°è¨ˆ",
                ColumnType = InteractiveColumnType.Display,
                Width = "120px",
                DisplayFormatter = item =>
                {
                    if (item is DeliveryItem deliveryItem)
                    {
                        return deliveryItem.SubtotalAmount.ToString("N2");
                    }
                    return "0.00";
                }
            }
        };

        // å€‰åº« - åº«ä½é¸æ“‡æ¬„ä½ï¼ˆåˆä½µé¡¯ç¤ºï¼Œåƒ…é¡¯ç¤ºæœ‰åº«å­˜çš„ä½ç½®ï¼‰
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å€‰åº« - åº«ä½", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "200px",
            Tooltip = "é¸æ“‡å‡ºè²¨çš„å€‰åº«å’Œåº«ä½ï¼ˆåƒ…é¡¯ç¤ºæœ‰åº«å­˜çš„ä½ç½®ï¼‰",
            CustomTemplate = item => 
            {
                var deliveryItem = (DeliveryItem)item;
                var selectedValue = deliveryItem.InventoryStockDetailId?.ToString() ?? "";
                var isDisabled = IsReadOnly || deliveryItem.ProductId <= 0 || !deliveryItem.AvailableWarehouseLocations.Any();
                
                if (IsReadOnly && deliveryItem.WarehouseId.HasValue)
                {
                    // å”¯è®€æ¨¡å¼ï¼šé¡¯ç¤ºç´”æ–‡å­—
                    var warehouse = Warehouses.FirstOrDefault(w => w.Id == deliveryItem.WarehouseId);
                    var locationName = deliveryItem.WarehouseLocationId.HasValue 
                        ? deliveryItem.AvailableWarehouseLocations
                            .FirstOrDefault(d => d.Id == deliveryItem.InventoryStockDetailId)
                            ?.WarehouseLocation?.Name ?? "é è¨­ä½ç½®"
                        : "é è¨­ä½ç½®";
                    var displayText = warehouse != null 
                        ? $"{warehouse.Name} - {locationName}"
                        : "æœªè¨­å®š";
                    
                    return @<span class="text-muted">
                        @displayText
                    </span>;
                }
                else
                {
                    // å¯ç·¨è¼¯æ¨¡å¼ï¼šé¡¯ç¤ºä¸‹æ‹‰é¸å–®
                    return @<select class="form-select form-select-sm"
                                   value="@selectedValue"
                                   disabled="@isDisabled"
                                   @onchange="@(async (e) => await OnWarehouseLocationChanged(deliveryItem, e.Value))">
                        <option value="">è«‹é¸æ“‡</option>
                        @foreach (var stockDetail in deliveryItem.AvailableWarehouseLocations)
                        {
                            var warehouseName = stockDetail.Warehouse?.Name ?? "æœªçŸ¥å€‰åº«";
                            var locationName = stockDetail.WarehouseLocation?.Name ?? "é è¨­ä½ç½®";
                            var displayText = $"{warehouseName} - {locationName} (å¯ç”¨: {stockDetail.AvailableStock})";
                            <option value="@stockDetail.Id">@displayText</option>
                        }
                    </select>;
                }
            }
        });
        
        // åº«å­˜é‡æ¬„ä½ (åªè®€é¡¯ç¤ºï¼Œä¸å„²å­˜åˆ°è³‡æ–™åº«)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "åº«å­˜é‡", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "100px",
            Tooltip = "é¸æ“‡å€‰åº«å¾Œé¡¯ç¤ºè©²å•†å“çš„å³æ™‚å¯ç”¨åº«å­˜é‡ï¼ˆå”¯è®€ï¼‰",
            CustomTemplate = item => 
            {
                var deliveryItem = (DeliveryItem)item;
                
                // åªæœ‰ç•¶é¸æ“‡äº†å•†å“å’Œå€‰åº«æ™‚æ‰é¡¯ç¤ºåº«å­˜é‡
                if (deliveryItem.ProductId <= 0 || !deliveryItem.WarehouseId.HasValue)
                {
                    return @<span class="text-muted">-</span>;
                }
                
                // é¡¯ç¤ºåº«å­˜é‡ï¼ˆæœ‰å¯èƒ½å°šæœªè¼‰å…¥ï¼‰
                if (deliveryItem.CurrentStockQuantity.HasValue)
                {
                    var stockQty = deliveryItem.CurrentStockQuantity.Value;
                    var textColor = stockQty <= 0 ? "text-danger" : 
                                   stockQty < 10 ? "text-warning" : "text-success";
                    
                    return @<span class="@textColor fw-bold" title="å³æ™‚å¯ç”¨åº«å­˜">
                        @stockQty.ToString("N0")
                    </span>;
                }
                else
                {
                    // è¼‰å…¥ä¸­
                    return @<span class="text-muted">
                        <i class="bi bi-hourglass-split"></i>
                    </span>;
                }
            }
        });

        // å‚™è¨»æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        {
            PropertyName = nameof(DeliveryItem.Remarks),
            Title = RemarksLabel,
            ColumnType = InteractiveColumnType.Input,
            Width = "200px",
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this,
                async args => await OnRemarksInput((DeliveryItem)args.Item1, args.Item2))
        });

        return columns;
    }

    private RenderFragment<DeliveryItem> GetCustomActionsTemplate => item => __builder =>
    {
        // æœªä¾†å¯ä»¥åœ¨æ­¤åŠ å…¥è‡ªè¨‚æ“ä½œæŒ‰éˆ•ï¼ˆå¦‚æŸ¥çœ‹ç›¸é—œå–®æ“šç­‰ï¼‰
    };

    private async Task HandleItemDelete(DeliveryItem item)
    {
        var index = DeliveryItems.IndexOf(item);
        if (index >= 0)
        {
            // å¦‚æœæ˜¯å·²å­˜åœ¨çš„æ˜ç´°ï¼ˆæœ‰IDï¼‰ï¼ŒåŠ å…¥åˆªé™¤æ¸…å–®
            if (item.ExistingDetailEntity != null)
            {
                var detailId = GetExistingDetailId(item.ExistingDetailEntity);
                if (detailId > 0 && !_deletedDetailIds.Contains(detailId))
                {
                    _deletedDetailIds.Add(detailId);
                    await NotifyDeletedDetailsChanged();
                }
            }
            
            DeliveryItems.RemoveAt(index);
            await NotifyDetailsChanged();
        }
    }

    // ===== å…§éƒ¨æ–¹æ³• =====
    private Task LoadAvailableProductsAsync()
    {
        if (SelectedCustomerId.HasValue && SelectedCustomerId.Value > 0)
        {
            AvailableProducts = Products.Where(p => p.Status == EntityStatus.Active).ToList();
        }
        else
        {
            AvailableProducts = new List<Product>();
        }
        
        return Task.CompletedTask;
    }

    private Task LoadExistingDetailsAsync()
    {
        if (ExistingDetails == null || !ExistingDetails.Any())
        {
            DeliveryItems.Clear();
            return Task.CompletedTask;
        }

        // ğŸ”‘ é–‹å§‹è¼‰å…¥è³‡æ–™
        _dataLoadCompleted = false;
        
        DeliveryItems.Clear();
        foreach (var detail in ExistingDetails)
        {
            var productId = GetPropertyValue<int>(detail, nameof(DeliveryItem.ProductId));
            var quantity = GetPropertyValue<decimal>(detail, QuantityPropertyName);
            var unitPrice = GetPropertyValue<decimal>(detail, UnitPricePropertyName);
            var remarks = GetPropertyValue<string>(detail, RemarksPropertyName);
            var warehouseId = !string.IsNullOrEmpty(WarehouseIdPropertyName) 
                ? GetPropertyValue<int?>(detail, WarehouseIdPropertyName) 
                : null;
            var warehouseLocationId = !string.IsNullOrEmpty(WarehouseLocationIdPropertyName) 
                ? GetPropertyValue<int?>(detail, WarehouseLocationIdPropertyName) 
                : null;

            var deliveryItem = new DeliveryItem
            {
                ProductId = productId,
                DeliveryQuantity = quantity,
                UnitPrice = unitPrice,
                Remarks = remarks ?? string.Empty,
                WarehouseId = warehouseId,
                WarehouseLocationId = warehouseLocationId,
                ExistingDetailEntity = detail
            };

            // éåŒæ­¥è¼‰å…¥åº«å­˜è³‡è¨Šï¼ˆä¸ç­‰å¾…ï¼Œè®“ UI å…ˆé¡¯ç¤ºï¼‰
            _ = Task.Run(async () =>
            {
                await LoadStockQuantityAsync(deliveryItem);
                await InvokeAsync(StateHasChanged);
            });

            DeliveryItems.Add(deliveryItem);
        }
        
        // ğŸ”‘ è³‡æ–™è¼‰å…¥å®Œæˆ
        _dataLoadCompleted = true;
        StateHasChanged();
        
        return Task.CompletedTask;
    }

    private List<TDetailEntity> ConvertToDetailEntities()
    {
        var validItems = DeliveryItems.Where(item => item.ProductId > 0).ToList();
        var detailEntities = new List<TDetailEntity>();

        foreach (var item in validItems)
        {
            TDetailEntity detailEntity;
            
            if (item.ExistingDetailEntity != null)
            {
                detailEntity = item.ExistingDetailEntity;
            }
            else
            {
                detailEntity = new TDetailEntity();
            }

            // è¨­å®šå•†å“ID
            SetPropertyValue(detailEntity, nameof(DeliveryItem.ProductId), item.ProductId);
            
            // è¨­å®šæ•¸é‡
            SetPropertyValue(detailEntity, QuantityPropertyName, item.DeliveryQuantity);
            
            // è¨­å®šå–®åƒ¹
            SetPropertyValue(detailEntity, UnitPricePropertyName, item.UnitPrice);
            
            // è¨­å®šå‚™è¨»
            SetPropertyValue(detailEntity, RemarksPropertyName, item.Remarks);
            
            // è¨­å®šå€‰åº«ï¼ˆå¦‚æœæœ‰ï¼‰
            if (!string.IsNullOrEmpty(WarehouseIdPropertyName))
            {
                SetPropertyValue(detailEntity, WarehouseIdPropertyName, item.WarehouseId);
            }

            detailEntities.Add(detailEntity);
        }

        return detailEntities;
    }

    private async Task NotifyDetailsChanged()
    {
        var detailEntities = ConvertToDetailEntities();
        
        if (OnDetailsChanged.HasDelegate)
        {
            await OnDetailsChanged.InvokeAsync(detailEntities);
        }
        
        StateHasChanged();
    }

    private async Task NotifyDeletedDetailsChanged()
    {
        if (OnDeletedDetailsChanged.HasDelegate)
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds);
        }
    }

    private T? GetPropertyValue<T>(object obj, string propertyName)
    {
        if (obj == null || string.IsNullOrEmpty(propertyName))
            return default;

        var property = obj.GetType().GetProperty(propertyName);
        if (property == null)
            return default;

        var value = property.GetValue(obj);
        return value == null ? default : (T)value;
    }

    private void SetPropertyValue(object obj, string propertyName, object? value)
    {
        if (obj == null || string.IsNullOrEmpty(propertyName))
            return;

        var property = obj.GetType().GetProperty(propertyName);
        if (property != null && property.CanWrite)
        {
            try
            {
                if (value == null && property.PropertyType.IsValueType && 
                    Nullable.GetUnderlyingType(property.PropertyType) == null)
                {
                    return;
                }
                
                property.SetValue(obj, value);
            }
            catch
            {
                // å¿½ç•¥è¨­å®šå¤±æ•—
            }
        }
    }

    // ===== äº‹ä»¶è™•ç†æ–¹æ³• =====
    private async Task OnProductChanged(DeliveryItem item, object? value)
    {
        if (value != null && int.TryParse(value.ToString(), out var productId))
        {
            item.ProductId = productId;
            
            // è¼‰å…¥å•†å“é è¨­è³‡è¨Š
            if (productId > 0)
            {
                var product = Products.FirstOrDefault(p => p.Id == productId);
                if (product != null)
                {
                    // æ³¨æ„ï¼šProduct å¯¦é«”æ²’æœ‰ SalesPrice å±¬æ€§ï¼Œé€™è£¡æš«æ™‚è¨­ç‚º 0
                    // å¯¦éš›æ‡‰è©²å¾åƒ¹æ ¼æ­·å²æˆ–å…¶ä»–åœ°æ–¹å–å¾—éŠ·å”®åƒ¹æ ¼
                    item.UnitPrice = 0;
                }
                
                // è¼‰å…¥è©²å•†å“çš„åº«å­˜è³‡è¨Š
                await LoadStockQuantityAsync(item);
            }
            
            await NotifyDetailsChanged();
        }
    }

    private async Task OnWarehouseLocationChanged(DeliveryItem item, object? value)
    {
        if (value == null || !int.TryParse(value.ToString(), out int detailId))
        {
            item.WarehouseId = null;
            item.WarehouseLocationId = null;
            item.InventoryStockDetailId = null;
            item.CurrentStockQuantity = null;
        }
        else
        {
            // å¾é¸æ“‡çš„åº«å­˜æ˜ç´°ä¸­å–å¾—å€‰åº«å’Œåº«ä½è³‡è¨Š
            var selectedDetail = item.AvailableWarehouseLocations.FirstOrDefault(d => d.Id == detailId);
            if (selectedDetail != null)
            {
                item.WarehouseId = selectedDetail.WarehouseId;
                item.WarehouseLocationId = selectedDetail.WarehouseLocationId;
                item.InventoryStockDetailId = detailId;
                item.CurrentStockQuantity = selectedDetail.AvailableStock;
            }
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    /// <summary>
    /// è¼‰å…¥æŒ‡å®šé …ç›®çš„åº«å­˜é‡
    /// </summary>
    private async Task LoadStockQuantityAsync(DeliveryItem item)
    {
        try
        {
            if (item.ProductId <= 0)
            {
                item.AvailableWarehouseLocations.Clear();
                item.CurrentStockQuantity = null;
                return;
            }

            // è¼‰å…¥è©²å•†å“çš„åº«å­˜ï¼ˆåŒ…å«æ˜ç´°ï¼‰
            var inventoryStocks = await InventoryStockService.GetByProductIdAsync(item.ProductId);
            
            // å¾åº«å­˜ä¸»æª”ä¸­æå–æ‰€æœ‰åº«å­˜æ˜ç´°
            var stockDetails = inventoryStocks
                .SelectMany(s => s.InventoryStockDetails ?? new List<InventoryStockDetail>())
                .Where(d => d.AvailableStock > 0) // åªä¿ç•™æœ‰åº«å­˜çš„ä½ç½®
                .OrderByDescending(d => d.AvailableStock)
                .ToList();
            
            item.AvailableWarehouseLocations = stockDetails;

            // å¦‚æœä¹‹å‰æœ‰é¸æ“‡å€‰åº«å’Œåº«ä½ï¼Œæ›´æ–°åº«å­˜é‡
            if (item.InventoryStockDetailId.HasValue)
            {
                var selectedDetail = item.AvailableWarehouseLocations
                    .FirstOrDefault(d => d.Id == item.InventoryStockDetailId.Value);
                if (selectedDetail != null)
                {
                    item.CurrentStockQuantity = selectedDetail.AvailableStock;
                }
            }
        }
        catch (Exception)
        {
            // å¿½ç•¥éŒ¯èª¤ï¼Œåº«å­˜é‡è¼‰å…¥å¤±æ•—ä¸å½±éŸ¿ä¸»è¦æµç¨‹
            item.AvailableWarehouseLocations.Clear();
            item.CurrentStockQuantity = null;
        }
    }

    private async Task OnQuantityInput(DeliveryItem item, string? value)
    {
        if (decimal.TryParse(value, out var quantity))
        {
            item.DeliveryQuantity = quantity;
            await NotifyDetailsChanged();
        }
    }

    private async Task OnUnitPriceInput(DeliveryItem item, string? value)
    {
        if (decimal.TryParse(value, out var price))
        {
            item.UnitPrice = price;
            await NotifyDetailsChanged();
        }
    }

    private async Task OnWarehouseChanged(DeliveryItem item, object? value)
    {
        if (value != null && int.TryParse(value.ToString(), out var warehouseId))
        {
            item.WarehouseId = warehouseId > 0 ? warehouseId : null;
            await NotifyDetailsChanged();
        }
    }

    private async Task OnRemarksInput(DeliveryItem item, string? value)
    {
        item.Remarks = value ?? string.Empty;
        await NotifyDetailsChanged();
    }

    private List<Product> GetAvailableProducts()
    {
        return AvailableProducts;
    }

    private List<InteractiveSelectOption> GetProductOptions()
    {
        var options = new List<InteractiveSelectOption>
        {
            new InteractiveSelectOption { Text = "-- è«‹é¸æ“‡å•†å“ --", Value = 0 }
        };
        
        options.AddRange(GetAvailableProducts().Select(p => new InteractiveSelectOption
        {
            Text = p.Name,
            Value = p.Id
        }));
        
        return options;
    }

    private List<InteractiveSelectOption> GetWarehouseOptions()
    {
        var options = new List<InteractiveSelectOption>
        {
            new InteractiveSelectOption { Text = "-- è«‹é¸æ“‡å€‰åº« --", Value = 0 }
        };
        
        options.AddRange(Warehouses.Select(w => new InteractiveSelectOption
        {
            Text = w.Name,
            Value = w.Id
        }));
        
        return options;
    }

    private int GetExistingDetailId(TDetailEntity entity)
    {
        var idProperty = entity.GetType().GetProperty("Id");
        if (idProperty != null)
        {
            var id = idProperty.GetValue(entity);
            if (id != null && int.TryParse(id.ToString(), out var intId))
            {
                return intId;
            }
        }
        return 0;
    }

    private decimal GetTotalAmount()
    {
        return DeliveryItems
            .Where(item => item.ProductId > 0)
            .Sum(item => item.SubtotalAmount);
    }

    public async Task<bool> ValidateAsync()
    {
        var nonEmptyItems = DeliveryItems.Where(item => item.ProductId > 0).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("è«‹è‡³å°‘æ–°å¢ä¸€ç­†å‡ºè²¨æ˜ç´°");
            return false;
        }

        foreach (var item in nonEmptyItems)
        {
            if (item.ProductId <= 0)
            {
                await NotificationService.ShowWarningAsync("è«‹é¸æ“‡å•†å“");
                return false;
            }

            if (item.DeliveryQuantity <= 0)
            {
                await NotificationService.ShowWarningAsync("å‡ºè²¨æ•¸é‡å¿…é ˆå¤§æ–¼ 0");
                return false;
            }

            if (item.UnitPrice < 0)
            {
                await NotificationService.ShowWarningAsync("å–®åƒ¹ä¸èƒ½ç‚ºè² æ•¸");
                return false;
            }
        }

        return true;
    }

    public class DeliveryItem
    {
        public int ProductId { get; set; }
        public decimal DeliveryQuantity { get; set; }
        public decimal UnitPrice { get; set; }
        public string Remarks { get; set; } = string.Empty;
        public int? WarehouseId { get; set; }
        public int? WarehouseLocationId { get; set; }
        public decimal SubtotalAmount => DeliveryQuantity * UnitPrice;
        public TDetailEntity? ExistingDetailEntity { get; set; }
        
        /// <summary>
        /// å³æ™‚åº«å­˜é‡ï¼ˆä¸å„²å­˜åˆ°è³‡æ–™åº«ï¼‰
        /// </summary>
        public int? CurrentStockQuantity { get; set; }
        
        /// <summary>
        /// åº«å­˜æ˜ç´°IDï¼ˆç”¨æ–¼é¸æ“‡å€‰åº«-åº«ä½ï¼‰
        /// </summary>
        public int? InventoryStockDetailId { get; set; }
        
        /// <summary>
        /// å¯ç”¨çš„å€‰åº«ä½ç½®æ¸…å–®ï¼ˆåƒ…é¡¯ç¤ºæœ‰åº«å­˜çš„ä½ç½®ï¼‰
        /// </summary>
        public List<InventoryStockDetail> AvailableWarehouseLocations { get; set; } = new();
    }
}
