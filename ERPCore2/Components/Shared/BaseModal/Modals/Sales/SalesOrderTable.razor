@* éŠ·è²¨è¨‚å–®æ˜ç´°ç®¡ç†çµ„ä»¶ - ä½¿ç”¨ InteractiveTableComponent çµ±ä¸€UI ä¸¦æ•´åˆè‡ªå‹•ç©ºè¡ŒåŠŸèƒ½ *@

@using ERPCore2.Models
@inject IProductService ProductService
@inject ISalesOrderDetailService SalesOrderDetailService
@inject ISalesReturnDetailService SalesReturnDetailService
@inject INotificationService NotificationService
@inject RelatedDocumentsHelper RelatedDocumentsHelper
@inject IInventoryStockService InventoryStockService

@typeparam TMainEntity where TMainEntity : BaseEntity
@typeparam TDetailEntity where TDetailEntity : BaseEntity, new()

@if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="customer-warning">
                <i class="bi bi-exclamation-triangle text-warning fs-1 mb-3"></i>
                <p class="text-muted">è«‹å…ˆé¸æ“‡å®¢æˆ¶æ‰èƒ½æ–°å¢éŠ·è²¨æ˜ç´°</p>
            </div>
        </div>
    </div>
}
else
{
    @* è­¦å‘Šè¨Šæ¯ï¼šé¡¯ç¤ºæœªå¯©æ ¸çš„å ±åƒ¹å–®æ˜ç´° *@
    @if (IsApprovalEnabled && GetUnapprovedItemsCount() > 0)
    {
        <div class="alert alert-warning mb-3" role="alert">
            <div class="d-flex align-items-start">
                <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                <div>
                    <strong>æ³¨æ„ï¼š</strong>ç›®å‰æœ‰ <strong>@GetUnapprovedItemsCount()</strong> é …æ˜ç´°ä¾†è‡ªæœªå¯©æ ¸çš„å ±åƒ¹å–®ã€‚
                    <br/>
                    <small class="text-muted">é€™äº›æ˜ç´°å°‡ç„¡æ³•å„²å­˜ï¼Œè«‹ç¢ºèªç›¸é—œå ±åƒ¹å–®å·²å®Œæˆå¯©æ ¸å¾Œå†é€²è¡ŒéŠ·è²¨ä½œæ¥­ã€‚</small>
                </div>
            </div>
        </div>
    }
    
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="SalesItem" 
                                      Items="SalesItems"
                                      ColumnDefinitions="GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"
                                      ShowRowNumbers="false"
                                      EmptyMessage="@EmptyMessage"
                                      ShowBuiltInActions="@(!IsReadOnly)"
                                      ShowBuiltInDeleteButton="false"
                                      CustomActionsTemplate="GetCustomActionsTemplate"
                                      ActionsColumnWidth = "60px"
                                      OnItemDelete="HandleItemDelete"
                                      EnableAutoEmptyRow="true"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@(() => new SalesItem())"/>
        </div>

        <div class="card-footer">
            <div class="d-flex justify-content-between">
                <div>
                    @if (CanLoadSmartOrder)
                    {
                        <GenericButtonComponent Text="æ™ºèƒ½ä¸‹å–®"
                                              Variant="ButtonVariant.Primary"
                                              OnClick="LoadSmartOrderItems" />
                    }
                </div>
                <div class="d-flex gap-2">
                    <GenericButtonComponent Text="æ¸…é™¤æ˜ç´°"
                                          Variant="ButtonVariant.Danger"
                                          OnClick="ClearAllDetails"
                                          IsDisabled="@IsReadOnly" />
                </div>
            </div>
        </div>
    </div>
}

<!-- ç›¸é—œå–®æ“šæŸ¥çœ‹ Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

@code {
    // ===== InteractiveTableComponent åƒè€ƒ =====
    private InteractiveTableComponent<SalesItem>? tableComponent;
    
    // ===== è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜ =====
    private bool _dataLoadCompleted = true;  // è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜
    
    // ===== åŸºæœ¬åƒæ•¸ =====
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public EventCallback<List<SalesItem>> OnSalesItemsChanged { get; set; }
    
    // ===== å®¢æˆ¶éæ¿¾åƒæ•¸ =====
    [Parameter] public int? SelectedCustomerId { get; set; }
    
    // ===== ç¯©é¸åƒæ•¸ =====
    [Parameter] public int? FilterProductId { get; set; }
    
    // ===== æ³›å‹åƒæ•¸ =====
    [Parameter] public TMainEntity? MainEntity { get; set; }
    [Parameter] public List<TDetailEntity> ExistingDetails { get; set; } = new List<TDetailEntity>();
    [Parameter] public EventCallback<List<TDetailEntity>> OnDetailsChanged { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    [Parameter] public EventCallback<SalesItem> OnItemRemoved { get; set; }
    
    /// <summary>
    /// ç‹€æ…‹é€šçŸ¥åƒæ•¸ - é€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
    /// </summary>
    [Parameter] public EventCallback<bool> OnHasUndeletableDetailsChanged { get; set; }
    
    // ===== ç›¸é—œå–®æ“šé–‹å•Ÿäº‹ä»¶ =====
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }
    
    // ===== æ¬„ä½æ˜ å°„åƒæ•¸ =====
    [Parameter] public string MainEntityIdPropertyName { get; set; } = string.Empty;
    [Parameter] public string QuantityPropertyName { get; set; } = "OrderQuantity";
    [Parameter] public string UnitPricePropertyName { get; set; } = "UnitPrice";
    [Parameter] public string RemarksPropertyName { get; set; } = "DetailRemarks";
    [Parameter] public string? UnitIdPropertyName { get; set; }
    [Parameter] public string? WarehouseIdPropertyName { get; set; }
    [Parameter] public string? DiscountPercentagePropertyName { get; set; } = "DiscountPercentage";
    [Parameter] public string? SubtotalPropertyName { get; set; } = "Subtotal";    

    
    // ===== é¡¯ç¤ºè¨­å®š =====
    [Parameter] public string Title { get; set; } = "éŠ·è²¨æ˜ç´°";
    [Parameter] public string Subtitle { get; set; } = "";
    [Parameter] public string Icon { get; set; } = "cart-plus";
    [Parameter] public string ItemDisplayName { get; set; } = "å•†å“";
    [Parameter] public string EmptyIcon { get; set; } = "cart";
    [Parameter] public string EmptyMessage { get; set; } = "å°šæœªæ–°å¢éŠ·è²¨å•†å“";
    
    // ===== å”¯è®€æ¨¡å¼åƒæ•¸ =====
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== ä¸‹æ‹‰é¸é …åƒæ•¸ =====
    [Parameter] public List<Warehouse> Warehouses { get; set; } = new List<Warehouse>();
    
    // ===== å¯©æ ¸ç®¡ç†åƒæ•¸ =====
    [Parameter] public bool IsApprovalEnabled { get; set; } = false; // æ˜¯å¦å•Ÿç”¨å ±åƒ¹å–®å¯©æ ¸ï¼ˆå¾ç³»çµ±åƒæ•¸è¼‰å…¥ï¼‰
    [Parameter] public int? SourceQuotationId { get; set; } // ä¾†æºå ±åƒ¹å–®IDï¼ˆç”¨æ–¼å¾å ±åƒ¹å–®è½‰å–®æ™‚ï¼‰
    [Parameter] public bool? IsSourceQuotationApproved { get; set; } // ä¾†æºå ±åƒ¹å–®æ˜¯å¦å·²å¯©æ ¸

    private List<SalesItem> SalesItems { get; set; } = new List<SalesItem>();
    private List<Product> AvailableProducts { get; set; } = new List<Product>();
    private int? _previousSelectedCustomerId = null;
    private int? _previousFilterProductId = null;
    private List<int> _deletedDetailIds { get; set; } = new List<int>();
    
    // ===== é€€è²¨æ•¸é‡ç®¡ç† =====
    private Dictionary<int, decimal> _returnedQuantities = new(); // Key: SalesOrderDetailId, Value: å·²é€€è²¨æ•¸é‡

    // ===== ç›¸é—œå–®æ“šæŸ¥çœ‹ =====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;
    
    // ===== è¨ˆç®—å±¬æ€§ =====
    
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦è™•æ–¼ç·¨è¼¯æ¨¡å¼ï¼ˆæœ‰ç¾æœ‰çš„å·²å„²å­˜æ˜ç´°ï¼‰
    /// </summary>
    private bool IsEditMode => ExistingDetails?.Any() == true;
    
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦å¯ä»¥ä½¿ç”¨ã€Œæ™ºèƒ½ä¸‹å–®ã€åŠŸèƒ½
    /// è¦å‰‡ï¼š
    /// 1. å¿…é ˆé¸æ“‡å®¢æˆ¶
    /// 2. ä¸å¯åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹ä½¿ç”¨ï¼ˆé¿å…è¦†è“‹ç¾æœ‰è³‡æ–™ï¼‰
    /// </summary>
    private bool CanLoadSmartOrder => 
        SelectedCustomerId.HasValue && 
        SelectedCustomerId.Value > 0 &&
        !IsReadOnly &&
        !IsEditMode; // ç·¨è¼¯æ¨¡å¼ä¸‹éš±è—æ­¤æŒ‰éˆ•
    
    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦æœ‰è¢«é–å®šçš„æ˜ç´°ï¼ˆæœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„çš„æ˜ç´°ï¼‰
    /// </summary>
    private bool HasLockedDetails()
    {
        return SalesItems.Any(item => 
            item.SelectedProduct != null &&
            (HasReturnRecord(item) || HasPaymentRecord(item)));
    }
    
    /// <summary>
    /// å–å¾—æœªå¯©æ ¸çš„æ˜ç´°æ•¸é‡
    /// </summary>
    private int GetUnapprovedItemsCount()
    {
        if (!IsApprovalEnabled)
            return 0;
        
        return SalesItems
            .Where(item => item.SelectedProduct != null &&
                          item.SourceQuotationId.HasValue &&
                          !(item.IsQuotationApproved ?? false))
            .Count();
    }

    protected override async Task OnInitializedAsync()
    {
        // åˆå§‹åŒ–è¿½è¹¤è®Šæ•¸ (åœ¨è¼‰å…¥è³‡æ–™å‰è¨­å®šï¼Œé¿å… OnParametersSetAsync èª¤åˆ¤)
        _previousSelectedCustomerId = SelectedCustomerId;
        _previousFilterProductId = FilterProductId;
        
        await LoadAvailableProductsAsync();
        await LoadExistingDetailsAsync();
        await LoadReturnedQuantitiesAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        
        // æª¢æŸ¥ç¯©é¸åƒæ•¸æ˜¯å¦è®Šæ›´
        bool customerChanged = _previousSelectedCustomerId != SelectedCustomerId;
        bool productFilterChanged = _previousFilterProductId != FilterProductId;
        
        // å¦‚æœå®¢æˆ¶è®Šæ›´ï¼Œéœ€è¦é‡æ–°è¼‰å…¥æ‰€æœ‰è³‡æ–™
        if (customerChanged)
        {
            _previousSelectedCustomerId = SelectedCustomerId;
            _previousFilterProductId = FilterProductId;
            
            await LoadAvailableProductsAsync();
            
            // å®¢æˆ¶è®Šæ›´æ™‚æ¸…ç©ºç¾æœ‰é¸é …ä¸¦é‡æ–°è¼‰å…¥
            SalesItems.Clear();
            await LoadExistingDetailsAsync();
            return;
        }
        
        // å¦‚æœåªæ˜¯å•†å“ç¯©é¸è®Šæ›´ï¼Œåªéœ€è¦æ›´æ–°ç¯©é¸ç‹€æ…‹ä¸¦é‡æ–°æ¸²æŸ“
        if (productFilterChanged)
        {
            _previousFilterProductId = FilterProductId;
            StateHasChanged();
            return;
        }
    }

    // ===== é€€è²¨æ•¸é‡ç®¡ç†æ–¹æ³• =====
    
    /// <summary>
    /// è¼‰å…¥æ‰€æœ‰éŠ·è²¨è¨‚å–®æ˜ç´°çš„é€€è²¨æ•¸é‡ï¼ˆå…¬é–‹æ–¹æ³•ï¼Œä¾›çˆ¶çµ„ä»¶å‘¼å«ï¼‰
    /// ç”¨æ–¼å­å–®æ“šå„²å­˜å¾Œï¼Œé‡æ–°è¼‰å…¥æ˜ç´°ä»¥æ›´æ–°é€€è²¨æ•¸é‡
    /// </summary>
    public async Task LoadReturnedQuantitiesAsync()
    {
        _returnedQuantities.Clear();
        
        // å…ˆè¤‡è£½è¦è™•ç†çš„é …ç›®åˆ°åˆ—è¡¨ä¸­ï¼Œé¿å…åœ¨è¿­ä»£æ™‚ä¿®æ”¹é›†åˆ
        var itemsToProcess = SalesItems
            .Where(item => item.ExistingDetailEntity is SalesOrderDetail detail && detail.Id > 0)
            .ToList();
        
        foreach (var item in itemsToProcess)
        {
            try
            {
                if (item.ExistingDetailEntity is SalesOrderDetail detail && detail.Id > 0)
                {
                    // ä½¿ç”¨æœå‹™æŸ¥è©¢è©²éŠ·è²¨è¨‚å–®æ˜ç´°çš„å·²é€€è²¨æ•¸é‡
                    var returnedQty = await SalesReturnDetailService.GetReturnedQuantityByOrderDetailAsync(detail.Id);
                    
                    if (returnedQty > 0)
                    {
                        _returnedQuantities[detail.Id] = returnedQty;
                    }
                }
            }
            catch (Exception ex)
            {
                await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadReturnedQuantitiesAsync), GetType());
            }
        }
        
        // è¼‰å…¥é€€è²¨æ•¸é‡å¾Œï¼Œé€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
        await NotifyHasUndeletableDetailsChanged();
        
        // å¼·åˆ¶ UI æ›´æ–°
        StateHasChanged();
    }
    
    /// <summary>
    /// æª¢æŸ¥æŒ‡å®šçš„éŠ·è²¨è¨‚å–®æ˜ç´°é …ç›®æ˜¯å¦æœ‰é€€è²¨è¨˜éŒ„
    /// </summary>
    private bool HasReturnRecord(SalesItem item)
    {
        if (item.ExistingDetailEntity is SalesOrderDetail detail && detail.Id > 0)
        {
            return _returnedQuantities.ContainsKey(detail.Id);
        }
        return false;
    }
    
    /// <summary>
    /// å–å¾—æŒ‡å®šéŠ·è²¨è¨‚å–®æ˜ç´°é …ç›®çš„å·²é€€è²¨æ•¸é‡
    /// </summary>
    private decimal GetReturnedQuantity(SalesItem item)
    {
        if (item.ExistingDetailEntity is SalesOrderDetail detail && detail.Id > 0)
        {
            return _returnedQuantities.TryGetValue(detail.Id, out var qty) ? qty : 0;
        }
        return 0;
    }
    
    /// <summary>
    /// æª¢æŸ¥æŒ‡å®šçš„éŠ·è²¨è¨‚å–®æ˜ç´°é …ç›®æ˜¯å¦æœ‰æ²–æ¬¾è¨˜éŒ„
    /// æª¢æŸ¥é‚è¼¯ï¼š
    /// - è³‡æ–™è¡¨ï¼šSalesOrderDetail
    /// - æ¬„ä½ï¼šTotalReceivedAmount (ç´¯è¨ˆæ”¶æ¬¾é‡‘é¡)
    /// - æ¢ä»¶ï¼šTotalReceivedAmount > 0 è¡¨ç¤ºå·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œä¸å¯åˆªé™¤
    /// </summary>
    /// <param name="item">è¦æª¢æŸ¥çš„éŠ·è²¨è¨‚å–®æ˜ç´°é …ç›®</param>
    /// <returns>true è¡¨ç¤ºæœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œfalse è¡¨ç¤ºæ²’æœ‰</returns>
    private bool HasPaymentRecord(SalesItem item)
    {
        if (item.ExistingDetailEntity is SalesOrderDetail detail && detail.Id > 0)
        {
            return detail.TotalReceivedAmount > 0;
        }
        return false;
    }
    
    /// <summary>
    /// å–å¾—æŒ‡å®šéŠ·è²¨è¨‚å–®æ˜ç´°é …ç›®çš„å·²æ”¶æ¬¾é‡‘é¡
    /// </summary>
    /// <param name="item">è¦æª¢æŸ¥çš„éŠ·è²¨è¨‚å–®æ˜ç´°é …ç›®</param>
    /// <returns>å·²æ”¶æ¬¾é‡‘é¡</returns>
    private decimal GetReceivedAmount(SalesItem item)
    {
        if (item.ExistingDetailEntity is SalesOrderDetail detail && detail.Id > 0)
        {
            return detail.TotalReceivedAmount;
        }
        return 0;
    }
    
    /// <summary>
    /// æª¢æŸ¥é …ç›®æ˜¯å¦å¯ä»¥åˆªé™¤
    /// ç¶œåˆæª¢æŸ¥ä»¥ä¸‹æ¢ä»¶ï¼š
    /// 1. é€€è²¨è¨˜éŒ„æª¢æŸ¥ (HasReturnRecord)
    ///    - è³‡æ–™ä¾†æºï¼šé€é SalesReturnDetailService.GetReturnedQuantityByOrderDetailAsync() æŸ¥è©¢
    ///    - æª¢æŸ¥è³‡æ–™è¡¨ï¼šSalesReturnDetail (éŠ·è²¨é€€å›æ˜ç´°)
    ///    - æª¢æŸ¥æ¬„ä½ï¼šSalesOrderDetailId (é—œè¯çš„éŠ·è²¨è¨‚å–®æ˜ç´°ID)
    ///    - é™åˆ¶åŸå› ï¼šå·²æœ‰é€€è²¨è¨˜éŒ„çš„éŠ·è²¨è¨‚å–®æ˜ç´°ä¸å¯åˆªé™¤ï¼Œä»¥ä¿æŒè³‡æ–™ä¸€è‡´æ€§
    /// 
    /// 2. æ²–æ¬¾è¨˜éŒ„æª¢æŸ¥ (HasPaymentRecord)
    ///    - è³‡æ–™ä¾†æºï¼šç›´æ¥è®€å– SalesOrderDetail å¯¦é«”
    ///    - æª¢æŸ¥è³‡æ–™è¡¨ï¼šSalesOrderDetail (éŠ·è²¨è¨‚å–®æ˜ç´°)
    ///    - æª¢æŸ¥æ¬„ä½ï¼šTotalReceivedAmount (ç´¯è¨ˆæ”¶æ¬¾é‡‘é¡)
    ///    - é™åˆ¶åŸå› ï¼šå·²æ”¶æ¬¾çš„éŠ·è²¨è¨‚å–®æ˜ç´°ä¸å¯åˆªé™¤ï¼Œé¿å…è²¡å‹™è³‡æ–™éŒ¯äº‚
    /// </summary>
    /// <param name="item">è¦æª¢æŸ¥çš„é …ç›®</param>
    /// <param name="reason">ä¸å¯åˆªé™¤çš„åŸå› ï¼ˆè¼¸å‡ºåƒæ•¸ï¼‰</param>
    /// <returns>true è¡¨ç¤ºå¯ä»¥åˆªé™¤ï¼Œfalse è¡¨ç¤ºä¸å¯åˆªé™¤</returns>
    private bool CanDeleteItem(SalesItem item, out string reason)
    {
        // æª¢æŸ¥ 1ï¼šé€€è²¨è¨˜éŒ„
        if (HasReturnRecord(item))
        {
            var returnedQty = GetReturnedQuantity(item);
            reason = $"æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„ï¼ˆå·²é€€è²¨ {returnedQty} å€‹ï¼‰ï¼Œç„¡æ³•åˆªé™¤";
            return false;
        }
        
        // æª¢æŸ¥ 2ï¼šæ²‰æ¬¾è¨˜éŒ„
        if (HasPaymentRecord(item))
        {
            var receivedAmount = GetReceivedAmount(item);
            reason = $"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ”¶æ¬¾ {receivedAmount:N0} å…ƒï¼‰ï¼Œç„¡æ³•åˆªé™¤";
            return false;
        }
        
        reason = string.Empty;
        return true;
    }

    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼‰
    /// </summary>
    private bool HasUndeletableDetails()
    {
        return SalesItems.Any(item => 
            item.SelectedProduct != null && !CanDeleteItem(item, out _));
    }

    /// <summary>
    /// é€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
    /// </summary>
    private async Task NotifyHasUndeletableDetailsChanged()
    {
        if (OnHasUndeletableDetailsChanged.HasDelegate)
        {
            var hasUndeletableDetails = HasUndeletableDetails();
            await OnHasUndeletableDetailsChanged.InvokeAsync(hasUndeletableDetails);
        }
    }

    // ===== å»ºç«‹ç©ºé …ç›®æ–¹æ³• =====
    
    private Task LoadAvailableProductsAsync()
    {
        try
        {
            if (SelectedCustomerId.HasValue && SelectedCustomerId.Value > 0)
            {
                // åªé¡¯ç¤ºç”¢å“é¡åˆ¥æ¨™è¨˜ç‚ºå¯è²©å”®çš„å•†å“
                AvailableProducts = Products
                    .Where(p => p.ProductCategory != null && 
                               p.ProductCategory.IsSaleable)
                    .ToList();
            }
            else
            {
                AvailableProducts = new List<Product>();
            }
        }
        catch (Exception)
        {
            AvailableProducts = new List<Product>();
        }
        
        return Task.CompletedTask;
    }

    /// <summary>
    /// å…¬é–‹çš„åˆ·æ–°æ–¹æ³•ï¼Œç”¨æ–¼å¤–éƒ¨è§¸ç™¼æ˜ç´°åˆ·æ–°ï¼ˆä¾‹å¦‚ï¼šä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼‰
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadExistingDetailsAsync();
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }
    
    private async Task LoadExistingDetailsAsync()
    {
        if (ExistingDetails?.Any() != true) 
        {
            return;
        }

        // ğŸ”‘ é–‹å§‹è¼‰å…¥è³‡æ–™
        _dataLoadCompleted = false;
        
        SalesItems.Clear();
        
        foreach (var detail in ExistingDetails)
        {
            // è½‰æ›ç‚ºæ­£ç¢ºçš„å¯¦é«”é¡å‹
            if (detail is SalesOrderDetail salesDetail)
            {
                var salesItem = new SalesItem
                {
                    SelectedProduct = salesDetail.Product ?? Products.FirstOrDefault(p => p.Id == salesDetail.ProductId),
                    OrderQuantity = salesDetail.OrderQuantity,
                    UnitPrice = salesDetail.UnitPrice,
                    DiscountPercentage = salesDetail.DiscountPercentage,
                    Subtotal = salesDetail.SubtotalAmount,
                    DetailRemarks = salesDetail.Remarks ?? "",
                    SelectedWarehouse = salesDetail.Warehouse ?? Warehouses.FirstOrDefault(w => w.Id == salesDetail.WarehouseId),
                    WarehouseLocationId = salesDetail.WarehouseLocationId,
                    ExistingDetailEntity = detail
                };
                
                // è¼‰å…¥è©²å•†å“çš„å¯ç”¨å€‰åº«ä½ç½®æ¸…å–®
                if (salesItem.SelectedProduct != null)
                {
                    salesItem.AvailableWarehouseLocations = await InventoryStockService.GetAvailableWarehouseLocationsByProductAsync(salesItem.SelectedProduct.Id);
                    
                    // æ‰¾åˆ°å°æ‡‰çš„åº«å­˜æ˜ç´°ID
                    if (salesItem.SelectedWarehouse != null)
                    {
                        var stockDetail = salesItem.AvailableWarehouseLocations.FirstOrDefault(d => 
                            d.WarehouseId == salesItem.SelectedWarehouse.Id && 
                            d.WarehouseLocationId == salesItem.WarehouseLocationId);
                        
                        if (stockDetail != null)
                        {
                            salesItem.InventoryStockDetailId = stockDetail.Id;
                            salesItem.CurrentStockQuantity = stockDetail.AvailableStock;
                        }
                    }
                }
                
                SalesItems.Add(salesItem);
            }
            else
            {
                // é€šç”¨è½‰æ›é‚è¼¯
                var salesItem = new SalesItem
                {
                    ExistingDetailEntity = detail
                };
                
                // ä½¿ç”¨åå°„è¨­å®šå±¬æ€§
                var productId = GetPropertyValue<int>(detail, "ProductId");
                salesItem.SelectedProduct = Products.FirstOrDefault(p => p.Id == productId);
                
                salesItem.OrderQuantity = GetPropertyValue<decimal>(detail, QuantityPropertyName);
                salesItem.UnitPrice = GetPropertyValue<decimal>(detail, UnitPricePropertyName);
                salesItem.DetailRemarks = GetPropertyValue<string>(detail, RemarksPropertyName) ?? "";
                
                if (!string.IsNullOrEmpty(DiscountPercentagePropertyName))
                    salesItem.DiscountPercentage = GetPropertyValue<decimal>(detail, DiscountPercentagePropertyName);
                    
                if (!string.IsNullOrEmpty(SubtotalPropertyName))
                    salesItem.Subtotal = GetPropertyValue<decimal>(detail, SubtotalPropertyName);
                
                if (!string.IsNullOrEmpty(WarehouseIdPropertyName))
                {
                    var warehouseId = GetPropertyValue<int?>(detail, WarehouseIdPropertyName);
                    if (warehouseId.HasValue)
                        salesItem.SelectedWarehouse = Warehouses.FirstOrDefault(w => w.Id == warehouseId.Value);
                }
                
                // å˜—è©¦å–å¾— WarehouseLocationId
                var warehouseLocationId = GetPropertyValue<int?>(detail, "WarehouseLocationId");
                if (warehouseLocationId.HasValue)
                    salesItem.WarehouseLocationId = warehouseLocationId;
                
                // è¼‰å…¥è©²å•†å“çš„å¯ç”¨å€‰åº«ä½ç½®æ¸…å–®
                if (salesItem.SelectedProduct != null)
                {
                    salesItem.AvailableWarehouseLocations = await InventoryStockService.GetAvailableWarehouseLocationsByProductAsync(salesItem.SelectedProduct.Id);
                    
                    // æ‰¾åˆ°å°æ‡‰çš„åº«å­˜æ˜ç´°ID
                    if (salesItem.SelectedWarehouse != null)
                    {
                        var stockDetail = salesItem.AvailableWarehouseLocations.FirstOrDefault(d => 
                            d.WarehouseId == salesItem.SelectedWarehouse.Id && 
                            d.WarehouseLocationId == salesItem.WarehouseLocationId);
                        
                        if (stockDetail != null)
                        {
                            salesItem.InventoryStockDetailId = stockDetail.Id;
                            salesItem.CurrentStockQuantity = stockDetail.AvailableStock;
                        }
                    }
                }
                
                SalesItems.Add(salesItem);
            }
        }
        
        // è¼‰å…¥æ‰€æœ‰é …ç›®çš„åº«å­˜é‡ï¼ˆå·²åœ¨ä¸Šé¢å–®ç¨è™•ç†ï¼Œé€™è£¡å¯ä»¥ç§»é™¤æˆ–ä¿ç•™ä½œç‚ºå‚™ç”¨ï¼‰
        // await LoadAllStockQuantitiesAsync();
        
        // ğŸ”‘ è³‡æ–™è¼‰å…¥å®Œæˆ
        _dataLoadCompleted = true;
        StateHasChanged();
    }

    private List<TDetailEntity> ConvertToDetailEntities()
    {
        var details = new List<TDetailEntity>();
        
        foreach (var item in SalesItems.Where(x => x.SelectedProduct != null))
        {
            TDetailEntity detail;
            
            if (item.ExistingDetailEntity != null)
            {
                // æ›´æ–°ç¾æœ‰æ˜ç´°
                detail = item.ExistingDetailEntity;
                
                // æ›´æ–°åŸºæœ¬è³‡è¨Š
                SetPropertyValue(detail, "ProductId", item.SelectedProduct!.Id);
                SetPropertyValue(detail, QuantityPropertyName, item.OrderQuantity);
                SetPropertyValue(detail, UnitPricePropertyName, item.UnitPrice);
                SetPropertyValue(detail, RemarksPropertyName, item.DetailRemarks);
                
                // æ›´æ–°å¯é¸å±¬æ€§
                if (!string.IsNullOrEmpty(DiscountPercentagePropertyName))
                    SetPropertyValue(detail, DiscountPercentagePropertyName, item.DiscountPercentage);
                    
                if (!string.IsNullOrEmpty(SubtotalPropertyName))
                    SetPropertyValue(detail, SubtotalPropertyName, item.Subtotal);
                
                if (!string.IsNullOrEmpty(WarehouseIdPropertyName))
                    SetPropertyValue(detail, WarehouseIdPropertyName, item.SelectedWarehouse?.Id);
                
                // æ›´æ–°å€‰åº«ä½ç½®ID
                SetPropertyValue(detail, "WarehouseLocationId", item.WarehouseLocationId);
                
                // æ›´æ–°å ±åƒ¹å–®æ˜ç´°ä¾†æºï¼ˆå¦‚æœæœ‰ï¼‰
                if (item.SourceQuotationDetailId.HasValue)
                    SetPropertyValue(detail, "QuotationDetailId", item.SourceQuotationDetailId.Value);
            }
            else
            {
                // æ–°å¢æ˜ç´°
                detail = new TDetailEntity();
                
                // è¨­å®šä¸»å¯¦é«”é—œè¯
                if (MainEntity != null)
                    SetPropertyValue(detail, MainEntityIdPropertyName, GetPropertyValue<int>(MainEntity, "Id"));
                
                // è¨­å®šåŸºæœ¬è³‡è¨Š
                SetPropertyValue(detail, "ProductId", item.SelectedProduct!.Id);
                SetPropertyValue(detail, QuantityPropertyName, item.OrderQuantity);
                SetPropertyValue(detail, UnitPricePropertyName, item.UnitPrice);
                SetPropertyValue(detail, RemarksPropertyName, item.DetailRemarks);
                
                // è¨­å®šå¯é¸å±¬æ€§
                if (!string.IsNullOrEmpty(DiscountPercentagePropertyName))
                    SetPropertyValue(detail, DiscountPercentagePropertyName, item.DiscountPercentage);
                    
                if (!string.IsNullOrEmpty(SubtotalPropertyName))
                    SetPropertyValue(detail, SubtotalPropertyName, item.Subtotal);
                
                if (!string.IsNullOrEmpty(WarehouseIdPropertyName))
                    SetPropertyValue(detail, WarehouseIdPropertyName, item.SelectedWarehouse?.Id);
                
                // è¨­å®šå€‰åº«ä½ç½®ID
                SetPropertyValue(detail, "WarehouseLocationId", item.WarehouseLocationId);
                
                // è¨­å®šå ±åƒ¹å–®æ˜ç´°ä¾†æºï¼ˆå¦‚æœæœ‰ï¼‰
                if (item.SourceQuotationDetailId.HasValue)
                    SetPropertyValue(detail, "QuotationDetailId", item.SourceQuotationDetailId.Value);
            }
            
            details.Add(detail);
        }
        
        return details;
    }

    private async Task NotifyDetailsChanged()
    {
        var details = ConvertToDetailEntities();
        await OnDetailsChanged.InvokeAsync(details);
        
        // é€šçŸ¥å·²åˆªé™¤çš„æ˜ç´° ID
        if (OnDeletedDetailsChanged.HasDelegate && _deletedDetailIds.Any())
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds.ToList());
            _deletedDetailIds.Clear(); // æ¸…ç©ºå·²é€šçŸ¥çš„åˆªé™¤ID
        }
        
        // é€šçŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
        await NotifyHasUndeletableDetailsChanged();
    }

    private T? GetPropertyValue<T>(object obj, string propertyName)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property == null) return default(T);
        
        var value = property.GetValue(obj);
        if (value == null) return default(T);
        
        if (typeof(T) == typeof(object)) return (T)value;
        
        return (T)Convert.ChangeType(value, typeof(T));
    }

    private void SetPropertyValue(object obj, string propertyName, object? value)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property != null && property.CanWrite)
        {
            if (value != null && property.PropertyType != value.GetType())
            {
                // è™•ç†é¡å‹è½‰æ›
                if (property.PropertyType.IsGenericType && property.PropertyType.GetGenericTypeDefinition() == typeof(Nullable<>))
                {
                    var underlyingType = Nullable.GetUnderlyingType(property.PropertyType);
                    value = underlyingType != null ? Convert.ChangeType(value, underlyingType) : value;
                }
                else
                {
                    value = Convert.ChangeType(value, property.PropertyType);
                }
            }
            property.SetValue(obj, value);
        }
    }

    // ===== InteractiveTableComponent æ–¹æ³• =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // å•†å“é¸æ“‡æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å•†å“",
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "250px",
            Tooltip = "é¸æ“‡è¦éŠ·å”®çš„å•†å“ã€‚å·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„çš„å•†å“å°‡ç„¡æ³•è®Šæ›´",
            CustomTemplate = item =>
            {
                var salesItem = (SalesItem)item;
                var hasReturnRecord = HasReturnRecord(salesItem);
                var hasPaymentRecord = HasPaymentRecord(salesItem);
                var isFieldReadOnly = IsReadOnly || hasReturnRecord || hasPaymentRecord;
                var selectedValue = salesItem.SelectedProduct?.Id.ToString() ?? "";
                
                // æª¢æŸ¥ç•¶å‰æ˜ç´°çš„å¯©æ ¸ç‹€æ…‹
                var isApproved = salesItem.IsQuotationApproved ?? true;
                var needsApproval = IsApprovalEnabled && salesItem.SourceQuotationId.HasValue && !isApproved;

                // çµ„åˆ tooltip è¨Šæ¯
                var tooltipMessages = new List<string>();
                if (hasReturnRecord)
                {
                    var returnedQty = GetReturnedQuantity(salesItem);
                    tooltipMessages.Add($"æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„ï¼ˆå·²é€€è²¨ {returnedQty} å€‹ï¼‰");
                }
                if (hasPaymentRecord)
                {
                    var receivedAmount = GetReceivedAmount(salesItem);
                    tooltipMessages.Add($"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ”¶æ¬¾ {receivedAmount:N0} å…ƒï¼‰");
                }
                if (needsApproval)
                {
                    tooltipMessages.Add($"ä¾†è‡ªå ±åƒ¹å–® (ID: {salesItem.SourceQuotationId}) å°šæœªå¯©æ ¸");
                }
                var title = tooltipMessages.Any()
                    ? string.Join("ï¼›", tooltipMessages) + (isFieldReadOnly ? "ï¼Œç„¡æ³•ä¿®æ”¹å•†å“é¸æ“‡" : "")
                    : "";

                // å¦‚æœæ˜¯å”¯è®€ç‹€æ…‹ï¼Œç›´æ¥é¡¯ç¤ºæ ¼å¼åŒ–çš„å•†å“åç¨±
                if (isFieldReadOnly && salesItem.SelectedProduct != null)
                {
                    var displayText = $"[{salesItem.SelectedProduct.Code}] {salesItem.SelectedProduct.Name}";
                    return @<div class="position-relative d-flex align-items-center" style="min-height: 31px;">
                        <span class="text-muted" title="@title">@displayText</span>
                    </div>;
                }

                // å–å¾—å¯ç”¨çš„å•†å“åˆ—è¡¨
                var availableProducts = GetAvailableProducts();
                
                // ç¢ºä¿ç•¶å‰é¸ä¸­çš„å•†å“ä¹Ÿåœ¨åˆ—è¡¨ä¸­ï¼ˆå³ä½¿å®ƒå¯èƒ½å·²è¢«ç¯©é¸æ‰ï¼‰
                if (salesItem.SelectedProduct != null && 
                    !availableProducts.Any(p => p.Id == salesItem.SelectedProduct.Id))
                {
                    // å¦‚æœç•¶å‰é¸ä¸­çš„å•†å“ä¸åœ¨å¯ç”¨åˆ—è¡¨ä¸­ï¼Œå»ºç«‹ä¸€å€‹åŒ…å«å®ƒçš„æ–°åˆ—è¡¨
                    availableProducts = new List<Product>(availableProducts) 
                    { 
                        salesItem.SelectedProduct 
                    };
                }

                return @<div class="position-relative">
                    @* å¦‚æœå•Ÿç”¨å¯©æ ¸ä¸”æ˜ç´°æœªå¯©æ ¸ï¼Œé¡¯ç¤ºè­¦å‘Šæ¨™è¨˜ *@
                    @if (needsApproval && salesItem.SelectedProduct != null)
                    {
                        <div class="d-flex align-items-center mb-1">
                            <span class="badge bg-warning text-dark" style="font-size: 0.7rem;">
                                <i class="fas fa-exclamation-triangle me-1"></i>æœªå¯©æ ¸
                            </span>
                        </div>
                    }
                    
                    <select class="form-select form-select-sm @(needsApproval ? "border-warning" : "")" 
                            value="@selectedValue"
                            disabled="@isFieldReadOnly"
                            title="@title"
                            @onchange="@(async (e) => await OnProductChanged(salesItem, e.Value))">
                        <option value="">è«‹é¸æ“‡å•†å“</option>
                        @foreach (var product in availableProducts)
                        {
                            <option value="@product.Id">[@product.Code] @product.Name</option>
                        }
                    </select>
                    
                    @if (hasReturnRecord || hasPaymentRecord)
                    {
                        <div class="position-absolute" style="top: 2px; right: 30px; pointer-events: none;">
                            <i title="@title"></i>
                        </div>
                    }
                </div>;
            }
        });

        // å€‰åº« - åº«ä½é¸æ“‡æ¬„ä½ï¼ˆåˆä½µé¡¯ç¤ºï¼Œåƒ…é¡¯ç¤ºæœ‰åº«å­˜çš„ä½ç½®ï¼‰
        columns.Add(new InteractiveColumnDefinition
            { 
                Title = "å€‰åº« - åº«ä½", 
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "200px",
                HideOnMobile = true,
                Tooltip = "é¸æ“‡å‡ºè²¨çš„å€‰åº«å’Œåº«ä½ï¼ˆåƒ…é¡¯ç¤ºæœ‰åº«å­˜çš„ä½ç½®ï¼‰ã€‚å·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„çš„å•†å“å°‡ç„¡æ³•è®Šæ›´",
                CustomTemplate = item => 
                {
                    var salesItem = (SalesItem)item;
                    var hasReturnRecord = HasReturnRecord(salesItem);
                    var hasPaymentRecord = HasPaymentRecord(salesItem);
                    var isFieldReadOnly = IsReadOnly || hasReturnRecord || hasPaymentRecord;
                    var selectedValue = salesItem.InventoryStockDetailId?.ToString() ?? "";
                    var isDisabled = isFieldReadOnly || salesItem.SelectedProduct == null || !salesItem.AvailableWarehouseLocations.Any();
                    
                    // çµ„åˆ tooltip è¨Šæ¯
                    var tooltipMessages = new List<string>();
                    if (hasReturnRecord)
                        tooltipMessages.Add("æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„");
                    if (hasPaymentRecord)
                    {
                        var receivedAmount = GetReceivedAmount(salesItem);
                        tooltipMessages.Add($"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ”¶æ¬¾ {receivedAmount:N0} å…ƒï¼‰");
                    }
                    var title = tooltipMessages.Any()
                        ? string.Join("ï¼›", tooltipMessages) + "ï¼Œç„¡æ³•ä¿®æ”¹å€‰åº«è¨­å®š"
                        : "";
                    
                    if (isFieldReadOnly && salesItem.SelectedWarehouse != null)
                    {
                        // å”¯è®€æ¨¡å¼ï¼šé¡¯ç¤ºç´”æ–‡å­—
                        var locationName = salesItem.WarehouseLocationId.HasValue 
                            ? salesItem.AvailableWarehouseLocations
                                .FirstOrDefault(d => d.Id == salesItem.InventoryStockDetailId)
                                ?.WarehouseLocation?.Name ?? "é è¨­ä½ç½®"
                            : "é è¨­ä½ç½®";
                        var displayText = $"{salesItem.SelectedWarehouse.Name} - {locationName}";
                        
                        return @<span class="text-muted" title="@title">
                            @displayText
                        </span>;
                    }
                    else
                    {
                        // å¯ç·¨è¼¯æ¨¡å¼ï¼šé¡¯ç¤ºä¸‹æ‹‰é¸å–®
                        return @<select class="form-select form-select-sm"
                                       value="@selectedValue"
                                       disabled="@isDisabled"
                                       @onchange="@(async (e) => await OnWarehouseLocationChanged(salesItem, e.Value))">
                            <option value="">è«‹é¸æ“‡</option>
                            @foreach (var stockDetail in salesItem.AvailableWarehouseLocations)
                            {
                                var warehouseName = stockDetail.Warehouse?.Name ?? "æœªçŸ¥å€‰åº«";
                                var locationName = stockDetail.WarehouseLocation?.Name ?? "é è¨­ä½ç½®";
                                var displayText = $"{warehouseName} - {locationName} (å¯ç”¨: {stockDetail.AvailableStock})";
                                <option value="@stockDetail.Id">@displayText</option>
                            }
                        </select>;
                    }
                }
        });
        
        // åº«å­˜é‡æ¬„ä½ (åªè®€é¡¯ç¤ºï¼Œä¸å„²å­˜åˆ°è³‡æ–™åº«)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "åº«å­˜é‡", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "100px",
            HideOnMobile = true,
            Tooltip = "é¸æ“‡å€‰åº«å¾Œé¡¯ç¤ºè©²å•†å“çš„å³æ™‚å¯ç”¨åº«å­˜é‡ï¼ˆå”¯è®€ï¼‰",
            CustomTemplate = item => 
            {
                var salesItem = (SalesItem)item;
                
                // åªæœ‰ç•¶é¸æ“‡äº†å•†å“å’Œå€‰åº«æ™‚æ‰é¡¯ç¤ºåº«å­˜é‡
                if (salesItem.SelectedProduct == null || salesItem.SelectedWarehouse == null)
                {
                    return @<span class="text-muted">-</span>;
                }
                
                // é¡¯ç¤ºåº«å­˜é‡ï¼ˆæœ‰å¯èƒ½å°šæœªè¼‰å…¥ï¼‰
                if (salesItem.CurrentStockQuantity.HasValue)
                {
                    var stockQty = salesItem.CurrentStockQuantity.Value;
                    var textColor = stockQty <= 0 ? "text-danger" : 
                                   stockQty < 10 ? "text-warning" : "text-success";
                    
                    return @<span class="@textColor fw-bold" title="å³æ™‚å¯ç”¨åº«å­˜">
                        @stockQty.ToString("N0")
                    </span>;
                }
                else
                {
                    // è¼‰å…¥ä¸­
                    return @<span class="text-muted">
                        <i class="bi bi-hourglass-split"></i>
                    </span>;
                }
            }
        });
        
        // è¨‚å–®æ•¸é‡æ¬„ä½ - æª¢æŸ¥æ˜¯å¦æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼Œå¦‚æœæœ‰å‰‡é–å®š
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "è¨‚å–®æ•¸é‡", 
            PropertyName = nameof(SalesItem.OrderQuantity),
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            Tooltip = "éŠ·å”®çš„å•†å“æ•¸é‡ã€‚å·²é€€è²¨æˆ–å·²æ”¶æ¬¾çš„å•†å“å°‡ç„¡æ³•ä¿®æ”¹æ•¸é‡",
            IsDisabledFunc = item =>
            {
                var salesItem = (SalesItem)item;
                return HasReturnRecord(salesItem) || HasPaymentRecord(salesItem);
            },
            TooltipFunc = item =>
            {
                var salesItem = (SalesItem)item;
                var hasReturnRecord = HasReturnRecord(salesItem);
                var hasPaymentRecord = HasPaymentRecord(salesItem);
                if (!hasReturnRecord && !hasPaymentRecord) return null;
                
                var tooltipMessages = new List<string>();
                if (hasReturnRecord)
                    tooltipMessages.Add("æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„");
                if (hasPaymentRecord)
                {
                    var receivedAmount = GetReceivedAmount(salesItem);
                    tooltipMessages.Add($"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ”¶æ¬¾ {receivedAmount:N0} å…ƒï¼‰");
                }
                return string.Join("ï¼›", tooltipMessages) + "ï¼Œç„¡æ³•ä¿®æ”¹è¨‚å–®æ•¸é‡";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnOrderQuantityInput((SalesItem)item, valueString);
            })
        });

        // å–®åƒ¹æ¬„ä½ - æª¢æŸ¥æ˜¯å¦æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼Œå¦‚æœæœ‰å‰‡é–å®š
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å–®åƒ¹", 
            PropertyName = nameof(SalesItem.UnitPrice),
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            Tooltip = "å•†å“çš„éŠ·å”®å–®åƒ¹ã€‚å·²é€€è²¨æˆ–å·²æ”¶æ¬¾çš„å•†å“å°‡ç„¡æ³•ä¿®æ”¹åƒ¹æ ¼",
            IsDisabledFunc = item =>
            {
                var salesItem = (SalesItem)item;
                return HasReturnRecord(salesItem) || HasPaymentRecord(salesItem);
            },
            TooltipFunc = item =>
            {
                var salesItem = (SalesItem)item;
                var hasReturnRecord = HasReturnRecord(salesItem);
                var hasPaymentRecord = HasPaymentRecord(salesItem);
                if (!hasReturnRecord && !hasPaymentRecord) return null;
                
                var tooltipMessages = new List<string>();
                if (hasReturnRecord)
                    tooltipMessages.Add("æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„");
                if (hasPaymentRecord)
                {
                    var receivedAmount = GetReceivedAmount(salesItem);
                    tooltipMessages.Add($"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ”¶æ¬¾ {receivedAmount:N0} å…ƒï¼‰");
                }
                return string.Join("ï¼›", tooltipMessages) + "ï¼Œç„¡æ³•ä¿®æ”¹å–®åƒ¹";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnUnitPriceInput((SalesItem)item, valueString);
            })
        });        

        // æŠ˜æ‰£æ¬„ä½ - æª¢æŸ¥æ˜¯å¦æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼Œå¦‚æœæœ‰å‰‡é–å®š
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "æŠ˜æ‰£%", 
            PropertyName = nameof(SalesItem.DiscountPercentage),
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            HideOnMobile = true,
            Tooltip = "æŠ˜æ‰£ç™¾åˆ†æ¯”ï¼ˆ0-100%ï¼‰ã€‚å·²é€€è²¨æˆ–å·²æ”¶æ¬¾çš„å•†å“å°‡ç„¡æ³•ä¿®æ”¹æŠ˜æ‰£",
            IsDisabledFunc = item =>
            {
                var salesItem = (SalesItem)item;
                return HasReturnRecord(salesItem) || HasPaymentRecord(salesItem);
            },
            TooltipFunc = item =>
            {
                var salesItem = (SalesItem)item;
                var hasReturnRecord = HasReturnRecord(salesItem);
                var hasPaymentRecord = HasPaymentRecord(salesItem);
                if (!hasReturnRecord && !hasPaymentRecord) return null;
                
                var tooltipMessages = new List<string>();
                if (hasReturnRecord)
                    tooltipMessages.Add("æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„");
                if (hasPaymentRecord)
                {
                    var receivedAmount = GetReceivedAmount(salesItem);
                    tooltipMessages.Add($"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ”¶æ¬¾ {receivedAmount:N0} å…ƒï¼‰");
                }
                return string.Join("ï¼›", tooltipMessages) + "ï¼Œç„¡æ³•ä¿®æ”¹æŠ˜æ‰£";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnDiscountPercentageInput((SalesItem)item, valueString);
            })
        });
        

        // å°è¨ˆæ¬„ä½ (åªè®€é¡¯ç¤º)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å°è¨ˆ", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            Tooltip = "è¨‚å–®é‡‘é¡å°è¨ˆï¼ˆæ•¸é‡ Ã— å–®åƒ¹ Ã— (1 - æŠ˜æ‰£%)ï¼‰",
            CustomTemplate = item => 
            {
                var salesItem = (SalesItem)item;
                
                return @<div class="text-end fw-bold text-success">
                    @salesItem.Subtotal.ToString("C")
                </div>;
            }
        });

        // å‚™è¨»æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å‚™è¨»", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "150px",
            HideOnMobile = true,
            Tooltip = "é¸å¡«ã€‚å¯è¨˜éŒ„éŠ·è²¨ç›¸é—œçš„å‚™è¨»è³‡è¨Š",
            CustomTemplate = item => 
            {
                var salesItem = (SalesItem)item;
                
                return @<input type="text" class="form-control "
                              value="@salesItem.DetailRemarks"
                              @oninput="(e) => OnRemarksInput(salesItem, e.Value?.ToString())"
                              readonly="@IsReadOnly"
                              placeholder="å‚™è¨»..." />;
            }
        });

        return columns;
    }

    private RenderFragment<SalesItem> GetCustomActionsTemplate => item => __builder =>
    {
        // æª¢æŸ¥é …ç›®æ˜¯å¦å¯ä»¥åˆªé™¤ï¼ˆç¶œåˆé€€è²¨è¨˜éŒ„å’Œæ²–æ¬¾è¨˜éŒ„æª¢æŸ¥ï¼‰
        var canDelete = CanDeleteItem(item, out _);
        
        if (canDelete)
        {
            // å¯ä»¥åˆªé™¤ï¼šé¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Danger"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="@IsReadOnly"
                                   Title="åˆªé™¤"
                                   OnClick="async () => await HandleItemDelete(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else
        {
            // ä¸èƒ½åˆªé™¤ï¼šé¡¯ç¤ºæŸ¥çœ‹æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Info"
                                   IconClass="bi bi-eye text-white"
                                   Size="ButtonSize.Large"
                                   Title="æŸ¥çœ‹ç›¸é—œå–®æ“š"
                                   OnClick="async () => await ShowRelatedDocuments(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
    };

    private async Task HandleItemDelete(SalesItem item)
    {
        // ä½¿ç”¨ç¶œåˆæª¢æŸ¥æ–¹æ³•ï¼Œç¢ºèªæ˜¯å¦å¯ä»¥åˆªé™¤
        if (!CanDeleteItem(item, out string reason))
        {
            await NotificationService.ShowWarningAsync(reason, "æ“ä½œé™åˆ¶");
            return;
        }
        
        var index = SalesItems.IndexOf(item);
        await RemoveItemAsync(index);
    }

    /// <summary>
    /// é¡¯ç¤ºç›¸é—œå–®æ“šï¼ˆé€€è²¨å–®å’Œæ²–æ¬¾å–®ï¼‰
    /// </summary>
    private async Task ShowRelatedDocuments(SalesItem item)
    {
        // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰çš„æ˜ç´°å¯¦é«” ID
        if (item.ExistingDetailEntity is not SalesOrderDetail detail || detail.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("æ­¤é …ç›®å°šæœªå„²å­˜ï¼Œç„¡æ³•æŸ¥çœ‹ç›¸é—œå–®æ“š", "æç¤º");
            return;
        }

        // è¨­å®šå•†å“åç¨±
        selectedProductName = item.SelectedProduct?.Name ?? "æœªçŸ¥å•†å“";

        // é¡¯ç¤º Modal ä¸¦é–‹å§‹è¼‰å…¥
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            // æŸ¥è©¢ç›¸é—œå–®æ“š
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsForSalesOrderDetailAsync(detail.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ç›¸é—œå–®æ“šå¤±æ•—ï¼š{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// è™•ç†é»æ“Šç›¸é—œå–®æ“šçš„äº‹ä»¶
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // è§¸ç™¼äº‹ä»¶ï¼Œè®“çˆ¶çµ„ä»¶ï¼ˆEditModalï¼‰è™•ç†é–‹å•Ÿç›¸é—œå–®æ“š
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            // å¦‚æœçˆ¶çµ„ä»¶æ²’æœ‰è™•ç†ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
            await NotificationService.ShowInfoAsync(
                $"è«‹åœ¨ä¸»ç•«é¢ä¸­é–‹å•Ÿ {document.TypeDisplayName}: {document.DocumentNumber}", 
                "æç¤º"
            );
        }
    }

    private List<Product> GetAvailableProducts()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
        {
            return new List<Product>();
        }
        
        return AvailableProducts;
    }

    private decimal GetTotalAmount()
    {
        return SalesItems
            .Where(item => item.SelectedProduct != null)
            .Sum(item => item.Subtotal);
    }

    public class SalesItem
    {
        public Product? SelectedProduct { get; set; }
        public decimal OrderQuantity { get; set; } = 0;
        public decimal UnitPrice { get; set; } = 0;
        public decimal DiscountPercentage { get; set; } = 0;
        public decimal Subtotal { get; set; } = 0;
        public string DetailRemarks { get; set; } = string.Empty;
        public Warehouse? SelectedWarehouse { get; set; }
        public TDetailEntity? ExistingDetailEntity { get; set; }
        
        // === å ±åƒ¹å–®ä¾†æºç›¸é—œå±¬æ€§ ===
        public int? SourceQuotationId { get; set; }
        public int? SourceQuotationDetailId { get; set; }
        public bool? IsQuotationApproved { get; set; }
        
        /// <summary>
        /// å³æ™‚åº«å­˜é‡ï¼ˆä¸å„²å­˜åˆ°è³‡æ–™åº«ï¼‰
        /// </summary>
        public int? CurrentStockQuantity { get; set; }
        
        /// <summary>
        /// åº«å­˜æ˜ç´°IDï¼ˆç”¨æ–¼é¸æ“‡å€‰åº«-åº«ä½ï¼‰
        /// </summary>
        public int? InventoryStockDetailId { get; set; }
        
        /// <summary>
        /// å€‰åº«ä½ç½®ID
        /// </summary>
        public int? WarehouseLocationId { get; set; }
        
        /// <summary>
        /// å¯ç”¨çš„å€‰åº«ä½ç½®æ¸…å–®ï¼ˆåƒ…é¡¯ç¤ºæœ‰åº«å­˜çš„ä½ç½®ï¼‰
        /// </summary>
        public List<InventoryStockDetail> AvailableWarehouseLocations { get; set; } = new();
        
        /// <summary>
        /// è¨ˆç®—å°è¨ˆ
        /// </summary>
        public void CalculateSubtotal()
        {
            // å°è¨ˆ = æ•¸é‡ Ã— å–®åƒ¹ Ã— (1 - æŠ˜æ‰£% / 100)
            // ä¾‹å¦‚ï¼š50 Ã— 62 Ã— (1 - 1/100) = 50 Ã— 62 Ã— 0.99 = 3069
            Subtotal = Math.Round(OrderQuantity * UnitPrice * (1 - DiscountPercentage / 100), 2);
            
            // ç¢ºä¿å°è¨ˆä¸ç‚ºè² æ•¸
            if (Subtotal < 0) Subtotal = 0;
        }
        
        /// <summary>
        /// å–å¾—é¡¯ç¤ºç”¨çš„å•†å“åç¨±
        /// </summary>
        public string DisplayName => 
            SelectedProduct != null 
                ? $"{SelectedProduct.Code} - {SelectedProduct.Name}" 
                : "";
    }

    // ===== äº‹ä»¶è™•ç†æ–¹æ³• =====
    
    // ===== å•†å“é¸æ“‡äº‹ä»¶è™•ç† =====
    private async Task OnProductChanged(SalesItem item, object? value)
    {
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹
        if (!CanDeleteItem(item, out string reason))
        {
            await NotificationService.ShowWarningAsync(
                "ç„¡æ³•ä¿®æ”¹å•†å“",
                reason
            );
            StateHasChanged(); // å¼·åˆ¶é‡æ–°æ¸²æŸ“ä»¥æ¢å¾©åŸå€¼
            return;
        }
        
        var productIdStr = value?.ToString();
        if (string.IsNullOrEmpty(productIdStr))
        {
            item.SelectedProduct = null;
            item.CurrentStockQuantity = null; // æ¸…ç©ºåº«å­˜é‡
            item.AvailableWarehouseLocations = new List<InventoryStockDetail>();
            item.InventoryStockDetailId = null;
            item.SelectedWarehouse = null;
            item.WarehouseLocationId = null;
        }
        else if (int.TryParse(productIdStr, out var productId))
        {
            var product = GetAvailableProducts().FirstOrDefault(p => p.Id == productId);
            item.SelectedProduct = product;
            
            // è¼‰å…¥è©²å•†å“çš„å¯ç”¨å€‰åº«ä½ç½®æ¸…å–®ï¼ˆåƒ…æœ‰åº«å­˜çš„ä½ç½®ï¼‰
            if (product != null)
            {
                item.AvailableWarehouseLocations = await InventoryStockService.GetAvailableWarehouseLocationsByProductAsync(product.Id);
                
                // é‡ç½®å€‰åº«é¸æ“‡
                item.InventoryStockDetailId = null;
                item.SelectedWarehouse = null;
                item.WarehouseLocationId = null;
                item.CurrentStockQuantity = null;
            }
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnOrderQuantityInput(SalesItem item, string? value)
    {
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹
        if (!CanDeleteItem(item, out string reason))
        {
            var friendlyMessage = HasReturnRecord(item)
                ? "æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹æ•¸é‡"
                : "æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹æ•¸é‡";
            
            await NotificationService.ShowWarningAsync(friendlyMessage, "æ“ä½œé™åˆ¶");
            return;
        }
        
        if (string.IsNullOrEmpty(value))
        {
            item.OrderQuantity = 0;
        }
        else if (decimal.TryParse(value, out var quantity))
        {
            item.OrderQuantity = quantity;
        }
        
        item.CalculateSubtotal();
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnUnitPriceInput(SalesItem item, string? value)
    {
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹
        if (!CanDeleteItem(item, out string reason))
        {
            var friendlyMessage = HasReturnRecord(item)
                ? "æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹å–®åƒ¹"
                : "æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹å–®åƒ¹";
            
            await NotificationService.ShowWarningAsync(friendlyMessage, "æ“ä½œé™åˆ¶");
            return;
        }
        
        if (string.IsNullOrEmpty(value))
        {
            item.UnitPrice = 0;
        }
        else if (decimal.TryParse(value, out var price))
        {
            item.UnitPrice = price;
        }
        
        item.CalculateSubtotal();
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnDiscountPercentageInput(SalesItem item, string? value)
    {
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹
        if (!CanDeleteItem(item, out string reason))
        {
            var friendlyMessage = HasReturnRecord(item)
                ? "æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹æŠ˜æ‰£"
                : "æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹æŠ˜æ‰£";
            
            await NotificationService.ShowWarningAsync(friendlyMessage, "æ“ä½œé™åˆ¶");
            return;
        }
        
        if (string.IsNullOrEmpty(value))
        {
            item.DiscountPercentage = 0;
        }
        else if (decimal.TryParse(value, out var percentage))
        {
            // é™åˆ¶æŠ˜æ‰£ç™¾åˆ†æ¯”åœ¨ 0-100 ä¹‹é–“
            item.DiscountPercentage = Math.Max(0, Math.Min(100, percentage));
        }
        
        // é‡æ–°è¨ˆç®—å°è¨ˆï¼ˆæœƒæ ¹æ“šæŠ˜æ‰£ç™¾åˆ†æ¯”è¨ˆç®—ï¼‰
        item.CalculateSubtotal();
        
        // é€šçŸ¥çˆ¶çµ„ä»¶è³‡æ–™å·²è®Šæ›´ï¼ˆé€™æœƒè§¸ç™¼ HandleDetailsChangedï¼‰
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnWarehouseLocationChanged(SalesItem item, object? value)
    {
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹
        if (!CanDeleteItem(item, out string reason))
        {
            var friendlyMessage = HasReturnRecord(item)
                ? "æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹å€‰åº«è¨­å®š"
                : "æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹å€‰åº«è¨­å®š";
            
            await NotificationService.ShowWarningAsync(friendlyMessage, "æ“ä½œé™åˆ¶");
            return;
        }
        
        if (value == null || !int.TryParse(value.ToString(), out int detailId))
        {
            item.InventoryStockDetailId = null;
            item.SelectedWarehouse = null;
            item.WarehouseLocationId = null;
            item.CurrentStockQuantity = null;
        }
        else
        {
            item.InventoryStockDetailId = detailId;
            
            // å¾å¯ç”¨ä½ç½®æ¸…å–®ä¸­æ‰¾åˆ°å°æ‡‰çš„æ˜ç´°
            var selectedDetail = item.AvailableWarehouseLocations.FirstOrDefault(d => d.Id == detailId);
            if (selectedDetail != null)
            {
                item.SelectedWarehouse = selectedDetail.Warehouse;
                item.WarehouseLocationId = selectedDetail.WarehouseLocationId;
                item.CurrentStockQuantity = selectedDetail.AvailableStock;
            }
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnRemarksInput(SalesItem item, string? value)
    {
        item.DetailRemarks = value ?? string.Empty;
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    public async Task RemoveItemAsync(int index)
    {
        if (IsReadOnly || index < 0 || index >= SalesItems.Count) return;
        
        var removedItem = SalesItems[index];
        
        // è¨˜éŒ„è¦åˆªé™¤çš„è³‡æ–™åº«å¯¦é«”ID
        if (removedItem.ExistingDetailEntity != null)
        {
            var entityId = GetExistingDetailId(removedItem.ExistingDetailEntity!);
            if (entityId > 0)
            {
                _deletedDetailIds.Add(entityId);
            }
        }
        
        // é€šçŸ¥çˆ¶çµ„ä»¶é …ç›®å³å°‡è¢«ç§»é™¤
        if (OnItemRemoved.HasDelegate)
        {
            await OnItemRemoved.InvokeAsync(removedItem);
        }
        
        SalesItems.RemoveAt(index);
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    /// <summary>
    /// å–å¾—ç¾æœ‰æ˜ç´°å¯¦é«”çš„ID
    /// </summary>
    private int GetExistingDetailId(TDetailEntity entity)
    {
        if (entity == null) return 0;
        
        // å‡è¨­æ‰€æœ‰çš„ BaseEntity éƒ½æœ‰ Id å±¬æ€§
        var idProperty = entity.GetType().GetProperty("Id");
        if (idProperty != null && idProperty.PropertyType == typeof(int))
        {
            return (int)(idProperty.GetValue(entity) ?? 0);
        }
        
        return 0;
    }

    // ===== æ¥­å‹™é‚è¼¯æ–¹æ³• =====
    
    /// <summary>
    /// è¼‰å…¥æŒ‡å®šé …ç›®çš„åº«å­˜é‡
    /// </summary>
    private async Task LoadStockQuantityAsync(SalesItem item)
    {
        try
        {
            // æª¢æŸ¥æ˜¯å¦æœ‰é¸æ“‡å•†å“å’Œå€‰åº«
            if (item.SelectedProduct == null || item.SelectedWarehouse == null)
            {
                item.CurrentStockQuantity = null;
                return;
            }
            
            // æŸ¥è©¢åº«å­˜é‡
            var stockQuantity = await InventoryStockService.GetTotalAvailableStockByWarehouseAsync(
                item.SelectedProduct.Id, 
                item.SelectedWarehouse.Id
            );
            
            item.CurrentStockQuantity = stockQuantity;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadStockQuantityAsync), GetType());
            item.CurrentStockQuantity = null;
        }
    }
    
    /// <summary>
    /// è¼‰å…¥æ‰€æœ‰æ˜ç´°é …ç›®çš„åº«å­˜é‡
    /// </summary>
    private async Task LoadAllStockQuantitiesAsync()
    {
        var tasks = new List<Task>();
        
        foreach (var item in SalesItems.Where(x => x.SelectedProduct != null))
        {
            if (item.SelectedProduct != null && item.SelectedWarehouse != null)
            {
                tasks.Add(LoadStockQuantityAsync(item));
            }
        }
        
        if (tasks.Any())
        {
            await Task.WhenAll(tasks);
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// çµ±ä¸€è¨­å®šæ‰€æœ‰æ˜ç´°é …ç›®çš„å€‰åº«ï¼ˆåªè™•ç†æœªé–å®šçš„æ˜ç´°ï¼‰
    /// </summary>
    /// <summary>
    /// æ¸…ç©ºæ‰€æœ‰éŠ·è²¨æ˜ç´°ï¼ˆåªç§»é™¤æœªé–å®šçš„æ˜ç´°ï¼Œä¿ç•™å·²é–å®šçš„ï¼‰
    /// </summary>
    private async Task ClearAllDetails()
    {
        if (IsReadOnly) return;
        
        try
        {
            var nonEmptyItems = SalesItems.Where(item => item.SelectedProduct != null).ToList();
            
            if (!nonEmptyItems.Any())
            {
                await NotificationService.ShowWarningAsync("æ²’æœ‰å¯ç§»é™¤çš„æ˜ç´°é …ç›®", "æç¤º");
                return;
            }
            
            // å€åˆ†å¯åˆªé™¤å’Œè¢«é–å®šçš„æ˜ç´°
            var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
            var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
            
            if (!unlocked.Any())
            {
                await NotificationService.ShowWarningAsync(
                    "æ‰€æœ‰æ˜ç´°éƒ½å·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ç§»é™¤", 
                    "æ“ä½œé™åˆ¶");
                return;
            }
            
            // é€šçŸ¥çˆ¶çµ„ä»¶é …ç›®å³å°‡è¢«ç§»é™¤
            if (OnItemRemoved.HasDelegate)
            {
                foreach (var item in unlocked)
                {
                    await OnItemRemoved.InvokeAsync(item);
                }
            }
            
            // è¨˜éŒ„æ‰€æœ‰è¦åˆªé™¤çš„ç¾æœ‰æ˜ç´° ID
            foreach (var item in unlocked.Where(item => item.ExistingDetailEntity != null))
            {
                var entityId = GetExistingDetailId(item.ExistingDetailEntity!);
                if (entityId > 0)
                {
                    _deletedDetailIds.Add(entityId);
                }
            }
            
            // å¾åˆ—è¡¨ä¸­ç§»é™¤æœªé–å®šçš„é …ç›®ï¼Œä¿ç•™å·²é–å®šçš„é …ç›®
            foreach (var item in unlocked)
            {
                SalesItems.Remove(item);
            }
            
            await NotifyDetailsChanged();
            
            var message = $"å·²ç§»é™¤ {unlocked.Count} é …æ˜ç´°";
            if (locked.Any())
            {
                message += $"\nï¼ˆå·²ä¿ç•™ {locked.Count} é …å·²é–å®šçš„æ˜ç´°ï¼‰";
            }
            await NotificationService.ShowSuccessAsync(message);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ClearAllDetails), GetType());
            await NotificationService.ShowErrorAsync("æ¸…ç©ºéŠ·è²¨æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤", "éŒ¯èª¤");
        }
    }

    /// <summary>
    /// è¼‰å…¥æ™ºèƒ½ä¸‹å–®é …ç›® - æ ¹æ“šå®¢æˆ¶æœ€è¿‘ä¸€æ¬¡å®Œæ•´çš„éŠ·è²¨è¨‚å–®
    /// </summary>
    private async Task LoadSmartOrderItems()
    {
        if (IsReadOnly || !SelectedCustomerId.HasValue) return;
        
        try
        {
            // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰è³‡æ–™
            var hasExistingData = SalesItems.Any(item => item.SelectedProduct != null);
            
            if (hasExistingData)
            {
                if (!await ShowConfirmationAsync("è¼‰å…¥æ™ºèƒ½ä¸‹å–®", "æ­¤æ“ä½œå°‡è¦†è“‹ç¾æœ‰çš„éŠ·è²¨æ˜ç´°ï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ"))
                {
                    return;
                }
            }

            // å¾æœå‹™ç²å–å®¢æˆ¶çš„æœ€è¿‘ä¸€æ¬¡å®Œæ•´éŠ·è²¨
            var lastSalesDetails = await SalesOrderDetailService.GetLastCompleteSalesAsync(SelectedCustomerId.Value);
            
            if (!lastSalesDetails.Any())
            {
                await NotificationService.ShowInfoAsync("è©²å®¢æˆ¶æ²’æœ‰éŠ·è²¨æ­·å²ç´€éŒ„å¯åƒè€ƒ", "æ™ºèƒ½ä¸‹å–®");
                return;
            }

            // æ¸…ç©ºç¾æœ‰é …ç›®
            SalesItems.Clear();
            _deletedDetailIds.Clear();

            // å°‡æ­·å²éŠ·è²¨è½‰æ›ç‚ºæ–°çš„éŠ·è²¨é …ç›®
            foreach (var detail in lastSalesDetails)
            {
                var salesItem = new SalesItem
                {
                    SelectedProduct = detail.Product,
                    OrderQuantity = detail.OrderQuantity,
                    UnitPrice = detail.UnitPrice,
                    DetailRemarks = detail.Remarks ?? "",
                    // è¤‡è£½å€‰åº«è¨­å®šä½œç‚ºåƒè€ƒ
                    SelectedWarehouse = detail.Warehouse ?? (detail.WarehouseId.HasValue ? 
                        Warehouses.FirstOrDefault(w => w.Id == detail.WarehouseId.Value) : null)
                };
                
                salesItem.CalculateSubtotal();
                SalesItems.Add(salesItem);
            }
            
            // è¼‰å…¥æ‰€æœ‰é …ç›®çš„åº«å­˜é‡
            await LoadAllStockQuantitiesAsync();
            
            await NotifyDetailsChanged();
            await NotificationService.ShowSuccessAsync($"å·²è¼‰å…¥ {lastSalesDetails.Count} é …å•†å“ä½œç‚ºåƒè€ƒ", "æ™ºèƒ½ä¸‹å–®å®Œæˆ");
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSmartOrderItems), GetType());
            await NotificationService.ShowErrorAsync("è¼‰å…¥æ™ºèƒ½ä¸‹å–®æ™‚ç™¼ç”ŸéŒ¯èª¤", "éŒ¯èª¤");
        }
    }

    /// <summary>
    /// å¾å ±åƒ¹å–®è¼‰å…¥æ˜ç´°ï¼ˆå…¬é–‹æ–¹æ³•ï¼Œä¾›çˆ¶çµ„ä»¶å‘¼å«ï¼‰
    /// </summary>
    /// <param name="quotationDetails">å ±åƒ¹å–®æ˜ç´°åˆ—è¡¨</param>
    /// <param name="quotationId">å ±åƒ¹å–®ID</param>
    /// <param name="isQuotationApproved">å ±åƒ¹å–®æ˜¯å¦å·²å¯©æ ¸</param>
    public async Task LoadQuotationDetails(List<QuotationDetail> quotationDetails, int quotationId, bool isQuotationApproved)
    {
        if (IsReadOnly) return;
        
        try
        {
            if (quotationDetails == null || !quotationDetails.Any())
            {
                await NotificationService.ShowWarningAsync("å ±åƒ¹å–®æ²’æœ‰æ˜ç´°è³‡æ–™", "è¼‰å…¥å¤±æ•—");
                return;
            }

            // æ¸…ç©ºç¾æœ‰é …ç›®
            SalesItems.Clear();

            // å°‡å ±åƒ¹å–®æ˜ç´°è½‰æ›ç‚ºéŠ·è²¨é …ç›®
            foreach (var quotationDetail in quotationDetails)
            {
                // ğŸ”‘ é—œéµä¿®æ”¹ï¼šåªè¼‰å…¥å°šæœªè½‰å–®çš„æ•¸é‡ï¼ˆå ±åƒ¹æ•¸é‡ - å·²è½‰æ•¸é‡ï¼‰
                var pendingQuantity = quotationDetail.Quantity - quotationDetail.ConvertedQuantity;
                
                // å¦‚æœè©²æ˜ç´°å·²ç¶“å…¨éƒ¨è½‰å®Œï¼Œè·³éä¸è¼‰å…¥
                if (pendingQuantity <= 0)
                {
                    continue;
                }
                
                var salesItem = new SalesItem
                {
                    SelectedProduct = quotationDetail.Product,
                    OrderQuantity = pendingQuantity,  // ä½¿ç”¨å‰©é¤˜æ•¸é‡ï¼Œè€Œéå…¨éƒ¨æ•¸é‡
                    UnitPrice = quotationDetail.UnitPrice,
                    DiscountPercentage = quotationDetail.DiscountPercentage,
                    DetailRemarks = quotationDetail.Remarks ?? "",
                    // è¨­å®šå ±åƒ¹å–®ä¾†æºè³‡è¨Šï¼ˆç”¨æ–¼å¯©æ ¸æª¢æŸ¥å’Œè½‰å–®è¿½è¹¤ï¼‰
                    SourceQuotationId = quotationId,
                    SourceQuotationDetailId = quotationDetail.Id,
                    IsQuotationApproved = isQuotationApproved
                };
                
                // è¨ˆç®—å°è¨ˆ
                salesItem.CalculateSubtotal();
                
                // è¼‰å…¥è©²å•†å“çš„å¯ç”¨å€‰åº«ä½ç½®æ¸…å–®
                if (salesItem.SelectedProduct != null)
                {
                    salesItem.AvailableWarehouseLocations = await InventoryStockService.GetAvailableWarehouseLocationsByProductAsync(salesItem.SelectedProduct.Id);
                }
                
                SalesItems.Add(salesItem);
            }
            
            await NotifyDetailsChanged();
            
            // è¨ˆç®—å¯¦éš›è¼‰å…¥çš„æ˜ç´°æ•¸é‡
            var loadedCount = SalesItems.Count(item => item.SelectedProduct != null);
            if (loadedCount > 0)
            {
                await NotificationService.ShowSuccessAsync($"å·²è¼‰å…¥ {loadedCount} é …æœªè½‰å®Œçš„å ±åƒ¹æ˜ç´°", "è¼‰å…¥æˆåŠŸ");
            }
            else
            {
                await NotificationService.ShowInfoAsync("æ‰€æœ‰å ±åƒ¹æ˜ç´°éƒ½å·²å®Œæˆè½‰å–®ï¼Œç„¡éœ€å†è½‰å–®", "æç¤º");
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadQuotationDetails), GetType());
            await NotificationService.ShowErrorAsync("è¼‰å…¥å ±åƒ¹å–®æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤", "éŒ¯èª¤");
        }
    }

    /// <summary>
    /// é¡¯ç¤ºç¢ºèªå°è©±æ¡†
    /// </summary>
    private async Task<bool> ShowConfirmationAsync(string title, string message)
    {
        // æš«æ™‚ä½¿ç”¨ç°¡å–®çš„é€šçŸ¥ï¼Œç­‰å¾…ç¢ºèªå¾ŒåŸ·è¡Œ
        // åœ¨å¯¦éš›å°ˆæ¡ˆä¸­å¯èƒ½æœƒä½¿ç”¨æ›´ç²¾ç¾çš„å°è©±æ¡†çµ„ä»¶
        try 
        {
            await NotificationService.ShowInfoAsync(message, title);
            return true;
        }
        catch
        {
            return false;
        }
    }

    /// <summary>
    /// é©—è­‰éŠ·è²¨æ˜ç´°
    /// </summary>
    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        // æª¢æŸ¥æ˜¯å¦è‡³å°‘æœ‰ä¸€é …éç©ºæ˜ç´°
        if (!SalesItems.Any(item => item.SelectedProduct != null))
        {
            errors.Add("è‡³å°‘éœ€è¦ä¸€é …éŠ·è²¨æ˜ç´°");
        }
        else
        {
            // === å¯©æ ¸æª¢æŸ¥ ===
            if (IsApprovalEnabled)
            {
                var unapprovedItems = SalesItems
                    .Where(item => item.SelectedProduct != null &&
                                  item.SourceQuotationId.HasValue &&
                                  !(item.IsQuotationApproved ?? false))
                    .ToList();
                
                if (unapprovedItems.Any())
                {
                    errors.Add($"æœ‰ {unapprovedItems.Count} é …æ˜ç´°ä¾†è‡ªæœªå¯©æ ¸çš„å ±åƒ¹å–®ï¼Œç„¡æ³•å„²å­˜ã€‚è«‹å…ˆå®Œæˆå ±åƒ¹å–®å¯©æ ¸ã€‚");
                }
            }
            
            var lineNumber = 1;
            foreach (var item in SalesItems.Where(x => x.SelectedProduct != null))
            {
                if (item.SelectedProduct == null)
                {
                    errors.Add($"ç¬¬ {lineNumber} è¡Œï¼šè«‹é¸æ“‡å•†å“");
                }

                if (item.OrderQuantity <= 0)
                {
                    errors.Add($"ç¬¬ {lineNumber} è¡Œï¼šè¨‚å–®æ•¸é‡å¿…é ˆå¤§æ–¼ 0");
                }

                if (item.UnitPrice < 0)
                {
                    errors.Add($"ç¬¬ {lineNumber} è¡Œï¼šå–®åƒ¹ä¸å¯ç‚ºè² æ•¸");
                }

                if (item.DiscountPercentage < 0 || item.DiscountPercentage > 100)
                {
                    errors.Add($"ç¬¬ {lineNumber} è¡Œï¼šæŠ˜æ‰£æ¯”ä¾‹å¿…é ˆä»‹æ–¼ 0-100 ä¹‹é–“");
                }

                lineNumber++;
            }
        }
          
        if (errors.Any())
        {
            await NotificationService.ShowErrorAsync(string.Join("\n", errors), "éŠ·è²¨æ˜ç´°é©—è­‰å¤±æ•—");
            return false;
        }
        
        return true;
    }
}
