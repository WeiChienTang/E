@* 銷貨訂單明細管理組件 - 使用 InteractiveTableComponent 統一UI 並整合自動空行功能 *@

@using ERPCore2.Models
@using ERPCore2.Data.Enums
@inject IProductService ProductService
@inject ISalesOrderDetailService SalesOrderDetailService
@inject ISalesReturnDetailService SalesReturnDetailService
@inject INotificationService NotificationService
@inject RelatedDocumentsHelper RelatedDocumentsHelper
@inject IInventoryStockService InventoryStockService
@inject ISystemParameterService SystemParameterService
@inject IQuotationService QuotationService
@inject ISalesOrderCompositionDetailService SalesOrderCompositionDetailService
@inject IQuotationCompositionDetailService QuotationCompositionDetailService
@inject IProductCompositionService ProductCompositionService

@using ERPCore2.Helpers

@typeparam TMainEntity where TMainEntity : BaseEntity
@typeparam TDetailEntity where TDetailEntity : BaseEntity, new()

@if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="customer-warning">
                <i class="bi bi-exclamation-triangle text-warning fs-1 mb-3"></i>
                <p class="text-muted">請先選擇客戶才能新增銷貨明細</p>
            </div>
        </div>
    </div>
}
else
{
    @* 警告訊息：顯示未審核的報價單明細 *@
    @if (IsApprovalEnabled && GetUnapprovedItemsCount() > 0)
    {
        <div class="alert alert-warning mb-3" role="alert">
            <div class="d-flex align-items-start">
                <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                <div>
                    <strong>注意：</strong>目前有 <strong>@GetUnapprovedItemsCount()</strong> 項明細來自未審核的報價單。
                    <br/>
                    <small class="text-muted">這些明細將無法儲存，請確認相關報價單已完成審核後再進行銷貨作業。</small>
                </div>
            </div>
        </div>
    }
    
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="SalesItem" 
                                      Items="SalesItems"
                                      ColumnDefinitions="GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"
                                      ShowRowNumbers="false"
                                      EmptyMessage="@EmptyMessage"
                                      ShowBuiltInActions="@(!IsReadOnly)"
                                      ShowBuiltInDeleteButton="false"
                                      CustomActionsTemplate="GetCustomActionsTemplate"
                                      ActionsColumnWidth = "60px"
                                      OnItemDelete="HandleItemDelete"
                                      EnableAutoEmptyRow="true"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@(() => new SalesItem())"/>
        </div>

        <div class="card-footer">
            <div class="d-flex justify-content-between">
                <div class="d-flex gap-2">
                    <GenericButtonComponent Text="智能下單"
                                          Variant="ButtonVariant.DarkBlue"
                                          Icon="fas fa-magic"
                                          OnClick="LoadSmartOrderItems"
                                          IsDisabled="@(!CanLoadSmartOrder)"
                                          Title="@GetSmartOrderTooltip()" />
                    <GenericButtonComponent Text="載入報價"
                                          Variant="ButtonVariant.DarkBlue"
                                          Icon="fas fa-file-invoice"
                                          OnClick="LoadQuotationItems"
                                          IsDisabled="@(!CanLoadQuotation)"
                                          Title="@GetLoadQuotationTooltip()" />
                </div>
                <div class="d-flex gap-2">
                    <GenericButtonComponent Text="清除明細"
                                          Variant="ButtonVariant.Red"
                                          OnClick="ClearAllDetails"
                                          IsDisabled="@IsReadOnly" />
                </div>
            </div>
        </div>
    </div>
}

<!-- 相關單據查看 Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

<!-- BOM 組合編輯/查看 Modal -->
<SalesOrderCompositionEditModal IsVisible="@showCompositionModal"
                               IsVisibleChanged="@((bool visible) => showCompositionModal = visible)"
                               SalesOrderDetailId="@GetSelectedSalesOrderDetailId()"
                               SalesOrderId="@(MainEntity?.Id)"
                               SalesOrderCode="@(MainEntity?.Code)"
                               ProductName="@selectedCompositionProductName"
                               ProductId="@selectedCompositionProductId"
                               OrderQuantity="@GetSelectedCompositionOrderQuantity()"
                               IsReadOnly="@GetCompositionModalReadOnlyState()"
                               OnSave="@HandleCompositionSave"
                               OnCancel="@(() => showCompositionModal = false)"
                               OnRequestCachedData="@GetCachedCompositionData" />

@code {
    // ===== InteractiveTableComponent 參考 =====
    private InteractiveTableComponent<SalesItem>? tableComponent;
    
    // ===== 資料載入完成標記 =====
    private bool _dataLoadCompleted = true;  // 資料載入完成標記
    
    // ===== 基本參數 =====
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public EventCallback<List<SalesItem>> OnSalesItemsChanged { get; set; }
    
    // ===== 客戶過濾參數 =====
    [Parameter] public int? SelectedCustomerId { get; set; }
    
    // ===== 報價單參數 =====
    [Parameter] public int? SelectedQuotationId { get; set; }
    
    // ===== 篩選參數 =====
    [Parameter] public int? FilterProductId { get; set; }
    
    // ===== 泛型參數 =====
    [Parameter] public TMainEntity? MainEntity { get; set; }
    [Parameter] public List<TDetailEntity> ExistingDetails { get; set; } = new List<TDetailEntity>();
    [Parameter] public EventCallback<List<TDetailEntity>> OnDetailsChanged { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    [Parameter] public EventCallback<SalesItem> OnItemRemoved { get; set; }
    
    /// <summary>
    /// 狀態通知參數 - 通知父組件是否有不可刪除的明細
    /// </summary>
    [Parameter] public EventCallback<bool> OnHasUndeletableDetailsChanged { get; set; }
    
    // ===== 相關單據開啟事件 =====
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }
    
    // ===== 欄位映射參數 =====
    [Parameter] public string MainEntityIdPropertyName { get; set; } = string.Empty;
    [Parameter] public string QuantityPropertyName { get; set; } = "OrderQuantity";
    [Parameter] public string UnitPricePropertyName { get; set; } = "UnitPrice";
    [Parameter] public string RemarksPropertyName { get; set; } = "DetailRemarks";
    [Parameter] public string? UnitIdPropertyName { get; set; }
    [Parameter] public string? WarehouseIdPropertyName { get; set; }
    [Parameter] public string? DiscountPercentagePropertyName { get; set; } = "DiscountPercentage";
    [Parameter] public string? SubtotalPropertyName { get; set; } = "Subtotal";    

    
    // ===== 顯示設定 =====
    [Parameter] public string Title { get; set; } = "銷貨明細";
    [Parameter] public string Subtitle { get; set; } = "";
    [Parameter] public string Icon { get; set; } = "cart-plus";
    [Parameter] public string ItemDisplayName { get; set; } = "商品";
    [Parameter] public string EmptyIcon { get; set; } = "cart";
    [Parameter] public string EmptyMessage { get; set; } = "尚未新增銷貨商品";
    
    // ===== 唯讀模式參數 =====
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== 下拉選項參數 =====
    [Parameter] public List<Warehouse> Warehouses { get; set; } = new List<Warehouse>();
    
    // ===== 稅別參數（新增）=====
    [Parameter] public TaxCalculationMethod TaxCalculationMethod { get; set; } = TaxCalculationMethod.TaxExclusive;

    // ===== 輔助計算屬性 =====
    private bool IsTaxCalculationMethodNoTax => TaxCalculationMethod == TaxCalculationMethod.NoTax;
    
    // ===== 審核管理參數 =====
    [Parameter] public bool IsApprovalEnabled { get; set; } = false; // 是否啟用報價單審核（從系統參數載入）
    [Parameter] public int? SourceQuotationId { get; set; } // 來源報價單ID（用於從報價單轉單時）
    [Parameter] public bool? IsSourceQuotationApproved { get; set; } // 來源報價單是否已審核

    private List<SalesItem> SalesItems { get; set; } = new List<SalesItem>();
    private List<Product> AvailableProducts { get; set; } = new List<Product>();
    private int? _previousSelectedCustomerId = null;
    private int? _previousFilterProductId = null;
    private List<int> _deletedDetailIds { get; set; } = new List<int>();
    private int _previousExistingDetailsCount = 0;  // 追蹤 ExistingDetails 數量變化
    
    // ===== 退貨數量管理 =====
    private Dictionary<int, decimal> _returnedQuantities = new(); // Key: SalesOrderDetailId, Value: 已退貨數量

    // ===== 相關單據查看 =====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;
    
    // ===== BOM 組合編輯相關 =====
    private bool showCompositionModal = false;
    private int? selectedSalesItemIndex = null;
    private string selectedCompositionProductName = string.Empty;
    private int? selectedCompositionProductId = null;
    private Dictionary<int, List<SalesOrderCompositionDetail>> compositionDetailsCache = new();
    private HashSet<int> productsWithComposition = new();  // 快取有 BOM 的商品 ID
    
    // ===== 計算屬性 =====
    
    /// <summary>
    /// 判斷是否處於編輯模式（有現有的已儲存明細）
    /// </summary>
    private bool IsEditMode => ExistingDetails?.Any() == true;
    
    /// <summary>
    /// 判斷是否可以使用「智能下單」功能
    /// 規則：
    /// 1. 必須選擇客戶
    /// 2. 不可在編輯模式下使用（避免覆蓋現有資料）
    /// </summary>
    private bool CanLoadSmartOrder => 
        SelectedCustomerId.HasValue && 
        SelectedCustomerId.Value > 0 &&
        !IsReadOnly &&
        !IsEditMode; // 編輯模式下禁用此按鈕
    
    /// <summary>
    /// 取得「智能下單」按鈕的提示文字
    /// </summary>
    private string GetSmartOrderTooltip()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
            return "請先選擇客戶";
        
        if (IsReadOnly)
            return "唯讀模式下無法使用智能下單";
        
        if (IsEditMode)
            return "編輯模式下無法使用此功能，請在新增模式時使用";
        
        return "載入該客戶上次訂購的商品明細";
    }
    
    /// <summary>
    /// 判斷是否可以使用「載入報價」功能
    /// 規則：
    /// 1. 必須選擇客戶
    /// 2. 必須選擇報價單
    /// 3. 不可在唯讀模式
    /// 4. 不可在編輯模式下使用（避免覆蓋現有資料）
    /// </summary>
    private bool CanLoadQuotation => 
        SelectedCustomerId.HasValue && 
        SelectedCustomerId.Value > 0 &&
        SelectedQuotationId.HasValue &&
        SelectedQuotationId.Value > 0 &&
        !IsReadOnly &&
        !IsEditMode;
    
    /// <summary>
    /// 取得「載入報價」按鈕的提示文字
    /// </summary>
    private string GetLoadQuotationTooltip()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
            return "請先選擇客戶";
        
        if (!SelectedQuotationId.HasValue || SelectedQuotationId.Value <= 0)
            return "請先選擇報價單";
        
        if (IsReadOnly)
            return "唯讀模式下無法載入報價";
        
        if (IsEditMode)
            return "編輯模式下無法使用此功能，請在新增模式時使用";
        
        return "載入所選報價單的明細資料（僅載入尚未轉單的數量）";
    }
    
    /// <summary>
    /// 檢查是否有被鎖定的明細（有退貨或沖款記錄的明細）
    /// </summary>
    private bool HasLockedDetails()
    {
        return SalesItems.Any(item => 
            item.SelectedProduct != null &&
            (HasReturnRecord(item) || HasPaymentRecord(item)));
    }
    
    /// <summary>
    /// 取得未審核的明細數量
    /// </summary>
    private int GetUnapprovedItemsCount()
    {
        if (!IsApprovalEnabled)
            return 0;
        
        return SalesItems
            .Where(item => item.SelectedProduct != null &&
                          item.SourceQuotationId.HasValue &&
                          !(item.IsQuotationApproved ?? false))
            .Count();
    }

    protected override async Task OnInitializedAsync()
    {
        // 初始化追蹤變數 (在載入資料前設定，避免 OnParametersSetAsync 誤判)
        _previousSelectedCustomerId = SelectedCustomerId;
        _previousFilterProductId = FilterProductId;
        _previousExistingDetailsCount = ExistingDetails?.Count ?? 0;
        
        await LoadAvailableProductsAsync();
        await LoadExistingDetailsAsync();
        
        // 載入有 BOM 組成的商品列表
        await LoadProductCompositionsAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        
        // 檢查篩選參數是否變更
        bool customerChanged = _previousSelectedCustomerId != SelectedCustomerId;
        bool productFilterChanged = _previousFilterProductId != FilterProductId;
        int currentExistingDetailsCount = ExistingDetails?.Count ?? 0;
        bool existingDetailsChanged = _previousExistingDetailsCount != currentExistingDetailsCount;
        
        //  關鍵：如果 ExistingDetails 有變化（例如從編輯模式返回），不要清空資料
        // 只在真正的客戶變更時才重新載入
        if (customerChanged && !existingDetailsChanged)
        {
            _previousSelectedCustomerId = SelectedCustomerId;
            _previousFilterProductId = FilterProductId;
            _previousExistingDetailsCount = currentExistingDetailsCount;
            
            await LoadAvailableProductsAsync();
            
            // 客戶變更時清空現有選項並重新載入
            SalesItems.Clear();
            await LoadExistingDetailsAsync();
            return;
        }
        
        // 更新追蹤變數
        if (existingDetailsChanged)
        {
            _previousExistingDetailsCount = currentExistingDetailsCount;
        }
        
        // 如果只是商品篩選變更，只需要更新篩選狀態並重新渲染
        if (productFilterChanged)
        {
            _previousFilterProductId = FilterProductId;
            StateHasChanged();
            return;
        }
    }

    // ===== 退貨數量管理方法 =====
    
    /// <summary>
    /// 載入所有銷貨訂單明細的退貨數量（公開方法，供父組件呼叫）
    /// 用於子單據儲存後，重新載入明細以更新退貨數量
    /// </summary>
    public async Task LoadReturnedQuantitiesAsync()
    {
        _returnedQuantities.Clear();
        
        // 只處理有現有實體的項目
        var itemsToProcess = SalesItems
            .Where(x => x.ExistingDetailEntity != null)
            .ToList();
        
        foreach (var item in itemsToProcess)
        {
            if (item.ExistingDetailEntity is SalesOrderDetail detail && detail.Id > 0)
            {
                // TODO: 退貨現在從出貨單產生，不直接從訂單
                // var returnedQty = await SalesReturnDetailService.GetReturnedQuantityByDeliveryDetailAsync(detail.Id);
                // if (returnedQty > 0)
                // {
                //     _returnedQuantities[detail.Id] = returnedQty;
                // }
            }
        }
        
        // 載入退貨數量後，通知父組件是否有不可刪除的明細
        await NotifyHasUndeletableDetailsChanged();
        
        StateHasChanged();
    }
    
    /// <summary>
    /// 檢查指定的銷貨訂單明細項目是否有退貨記錄
    /// </summary>
    private bool HasReturnRecord(SalesItem item)
    {
        if (item.ExistingDetailEntity is SalesOrderDetail detail && detail.Id > 0)
        {
            return _returnedQuantities.ContainsKey(detail.Id);
        }
        return false;
    }
    
    /// <summary>
    /// 取得指定銷貨訂單明細項目的已退貨數量
    /// </summary>
    private decimal GetReturnedQuantity(SalesItem item)
    {
        if (item.ExistingDetailEntity is SalesOrderDetail detail && detail.Id > 0)
        {
            return _returnedQuantities.TryGetValue(detail.Id, out var qty) ? qty : 0;
        }
        return 0;
    }
    
    /// <summary>
    /// 檢查指定的銷貨訂單明細項目是否有沖款記錄
    /// 檢查邏輯：
    /// - 資料表：SalesOrderDetail
    /// - 欄位：TotalReceivedAmount (累計收款金額)
    /// - 條件：TotalReceivedAmount > 0 表示已有沖款記錄，不可刪除
    /// </summary>
    /// <param name="item">要檢查的銷貨訂單明細項目</param>
    /// <returns>true 表示有沖款記錄，false 表示沒有</returns>
    private bool HasPaymentRecord(SalesItem item)
    {
        if (item.ExistingDetailEntity is SalesOrderDetail detail && detail.Id > 0)
        {
            return detail.TotalReceivedAmount > 0;
        }
        return false;
    }
    
    /// <summary>
    /// 取得指定銷貨訂單明細項目的已收款金額
    /// </summary>
    /// <param name="item">要檢查的銷貨訂單明細項目</param>
    /// <returns>已收款金額</returns>
    private decimal GetReceivedAmount(SalesItem item)
    {
        if (item.ExistingDetailEntity is SalesOrderDetail detail && detail.Id > 0)
        {
            return detail.TotalReceivedAmount;
        }
        return 0;
    }
    
    /// <summary>
    /// 檢查項目是否可以刪除
    /// 綜合檢查以下條件：
    /// 1. 退貨記錄檢查 (HasReturnRecord)
    ///    - 資料來源：透過 SalesReturnDetailService.GetReturnedQuantityByOrderDetailAsync() 查詢
    ///    - 檢查資料表：SalesReturnDetail (銷貨退回明細)
    ///    - 檢查欄位：SalesOrderDetailId (關聯的銷貨訂單明細ID)
    ///    - 限制原因：已有退貨記錄的銷貨訂單明細不可刪除，以保持資料一致性
    /// 
    /// 2. 沖款記錄檢查 (HasPaymentRecord)
    ///    - 資料來源：直接讀取 SalesOrderDetail 實體
    ///    - 檢查資料表：SalesOrderDetail (銷貨訂單明細)
    ///    - 檢查欄位：TotalReceivedAmount (累計收款金額)
    ///    - 限制原因：已收款的銷貨訂單明細不可刪除，避免財務資料錯亂
    /// </summary>
    /// <param name="item">要檢查的項目</param>
    /// <param name="reason">不可刪除的原因（輸出參數）</param>
    /// <returns>true 表示可以刪除，false 表示不可刪除</returns>
    private bool CanDeleteItem(SalesItem item, out string reason)
    {
        // 檢查 1：退貨記錄
        if (HasReturnRecord(item))
        {
            var returnedQty = GetReturnedQuantity(item);
            reason = $"此商品已有退貨記錄（已退貨 {returnedQty} 個），無法刪除";
            return false;
        }
        
        // 檢查 2：沉款記錄
        if (HasPaymentRecord(item))
        {
            var receivedAmount = GetReceivedAmount(item);
            reason = $"此商品已有沖款記錄（已收款 {receivedAmount:N0} 元），無法刪除";
            return false;
        }
        
        reason = string.Empty;
        return true;
    }

    /// <summary>
    /// 檢查是否有不可刪除的明細（已有退貨或沖款記錄）
    /// </summary>
    private bool HasUndeletableDetails()
    {
        return SalesItems.Any(item => 
            item.SelectedProduct != null && !CanDeleteItem(item, out _));
    }

    /// <summary>
    /// 通知父組件是否有不可刪除的明細
    /// </summary>
    private async Task NotifyHasUndeletableDetailsChanged()
    {
        if (OnHasUndeletableDetailsChanged.HasDelegate)
        {
            var hasUndeletableDetails = HasUndeletableDetails();
            await OnHasUndeletableDetailsChanged.InvokeAsync(hasUndeletableDetails);
        }
    }

    // ===== BOM 組合編輯相關方法 =====
    
    /// <summary>
    /// 載入有 BOM 組成的商品列表（用於快取檢查）
    /// </summary>
    private async Task LoadProductCompositionsAsync()
    {
        try
        {
            // 載入所有有 BOM 組成的商品 ID
            var allCompositions = await ProductCompositionService.GetAllAsync();
            productsWithComposition = allCompositions
                .Select(pc => pc.ParentProductId)
                .ToHashSet();
        }
        catch (Exception ex)
        {
            // 載入失敗不影響主流程
            await NotificationService.ShowErrorAsync($"載入 BOM 資料失敗：{ex.Message}");
            productsWithComposition = new HashSet<int>();
        }
    }
    
    /// <summary>
    /// 檢查商品是否有 BOM 組成
    /// </summary>
    private bool HasProductComposition(int productId)
    {
        return productsWithComposition.Contains(productId);
    }
    
    /// <summary>
    /// 顯示 BOM 組合編輯器
    /// </summary>
    private void ShowCompositionEditor(SalesItem item)
    {
        if (item.SelectedProduct == null)
            return;
        
        // 找出 SalesItem 的索引
        selectedSalesItemIndex = SalesItems.IndexOf(item);
        selectedCompositionProductName = item.SelectedProduct.Name;
        selectedCompositionProductId = item.SelectedProduct.Id;
        
        showCompositionModal = true;
        StateHasChanged();
    }
    
    /// <summary>
    /// 取得 BOM 編輯 Modal 的唯讀狀態
    /// 如果全域唯讀或當前選中的明細已轉單/有退貨/有沖款，則 Modal 應該為唯讀
    /// </summary>
    private bool GetCompositionModalReadOnlyState()
    {
        // 全域唯讀模式
        if (IsReadOnly) return true;
        
        // 檢查選中的項目
        if (!selectedSalesItemIndex.HasValue || selectedSalesItemIndex.Value >= SalesItems.Count)
            return false;
        
        var item = SalesItems[selectedSalesItemIndex.Value];
        
        // 檢查是否有退貨記錄
        if (HasReturnRecord(item)) return true;
        
        // 檢查是否有沖款記錄
        if (HasPaymentRecord(item)) return true;
        
        // 檢查是否已轉下一步（已出貨）
        if (item.DeliveredQuantity > 0) return true;
        
        // 其他情況可編輯
        return false;
    }
    
    /// <summary>
    /// 取得選中的銷貨訂單明細 ID（用於 Modal）
    /// </summary>
    private int? GetSelectedSalesOrderDetailId()
    {
        if (!selectedSalesItemIndex.HasValue || selectedSalesItemIndex.Value >= SalesItems.Count)
            return null;
        
        var item = SalesItems[selectedSalesItemIndex.Value];
        return (item.ExistingDetailEntity as SalesOrderDetail)?.Id;
    }
    
    /// <summary>
    /// 取得選中的銷貨訂單明細的訂購數量（供 BOM 編輯器傳遞給轉排程功能）
    /// </summary>
    private decimal GetSelectedCompositionOrderQuantity()
    {
        if (!selectedSalesItemIndex.HasValue || selectedSalesItemIndex.Value >= SalesItems.Count)
            return 1;
        
        var item = SalesItems[selectedSalesItemIndex.Value];
        return item.OrderQuantity;
    }
    
    /// <summary>
    /// 處理 BOM 組合儲存
    /// </summary>
    private async Task HandleCompositionSave(List<SalesOrderCompositionDetail> compositionDetails)
    {
        if (!selectedSalesItemIndex.HasValue || !selectedCompositionProductId.HasValue)
            return;
            
        try
        {
            // 暫存到快取（實際儲存會在銷貨訂單儲存時一併處理）
            var item = SalesItems[selectedSalesItemIndex.Value];
            item.CustomCompositionDetails = compositionDetails;
            
            await NotificationService.ShowSuccessAsync("BOM 組成已更新（將在銷貨訂單儲存時一併保存）");
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"儲存 BOM 組成失敗：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 取得快取的組合明細資料（供 Modal 使用）
    /// </summary>
    private List<SalesOrderCompositionDetail>? GetCachedCompositionData()
    {
        if (!selectedSalesItemIndex.HasValue)
        {
            return null;
        }
        
        if (selectedSalesItemIndex.Value >= SalesItems.Count)
        {
            return null;
        }
        
        var item = SalesItems[selectedSalesItemIndex.Value];
        
        return item.CustomCompositionDetails;
    }

    // ===== 建立空項目方法 =====
    
    private Task LoadAvailableProductsAsync()
    {
        try
        {
            if (SelectedCustomerId.HasValue && SelectedCustomerId.Value > 0)
            {
                // 只顯示商品類別標記為可販售的商品
                AvailableProducts = Products
                    .Where(p => p.ProductCategory != null && 
                               p.ProductCategory.IsSaleable)
                    .ToList();
            }
            else
            {
                AvailableProducts = new List<Product>();
            }
        }
        catch (Exception)
        {
            AvailableProducts = new List<Product>();
        }
        
        return Task.CompletedTask;
    }

    /// <summary>
    /// 公開的刷新方法，用於外部觸發明細刷新（例如：上下筆切換時）
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadExistingDetailsAsync();
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }
    
    /// <summary>
    /// 取得所有銷貨訂單組合明細資料（供父組件儲存使用）
    /// </summary>
    public Dictionary<int, List<SalesOrderCompositionDetail>> GetCompositionDetails()
    {
        var result = new Dictionary<int, List<SalesOrderCompositionDetail>>();
        
        foreach (var item in SalesItems.Where(x => x.SelectedProduct != null))
        {
            // 只處理有自訂 BOM 組成的項目
            if (item.CustomCompositionDetails != null && item.CustomCompositionDetails.Any())
            {
                // 使用商品 ID 作為鍵值（在儲存時會轉換為實際的 SalesOrderDetailId）
                result[item.SelectedProduct!.Id] = item.CustomCompositionDetails;
            }
        }
        
        return result;
    }
    
    private async Task LoadExistingDetailsAsync()
    {
        if (ExistingDetails?.Any() != true) 
        {
            SalesItems.Clear();
            _dataLoadCompleted = true;
            tableComponent?.RefreshEmptyRow();
            StateHasChanged();
            return;
        }
        
        //  開始載入資料 - 設定為未完成
        _dataLoadCompleted = false;
        
        SalesItems.Clear();
        
        foreach (var detail in ExistingDetails)
        {
            // 轉換為正確的實體類型
            if (detail is SalesOrderDetail salesDetail)
            {
                var systemTaxRate = await SystemParameterService.GetTaxRateAsync();
                var finalTaxRate = salesDetail.TaxRate ?? salesDetail.Product?.TaxRate ?? systemTaxRate;
                
                var salesItem = new SalesItem
                {
                    SelectedProduct = salesDetail.Product ?? Products.FirstOrDefault(p => p.Id == salesDetail.ProductId),
                    OrderQuantity = salesDetail.OrderQuantity,
                    DeliveredQuantity = salesDetail.DeliveredQuantity,
                    UnitPrice = salesDetail.UnitPrice,
                    DiscountPercentage = salesDetail.DiscountPercentage,
                    TaxRate = finalTaxRate,
                    Subtotal = salesDetail.SubtotalAmount,
                    DetailRemarks = salesDetail.Remarks ?? "",
                    SelectedWarehouse = salesDetail.Warehouse ?? Warehouses.FirstOrDefault(w => w.Id == salesDetail.WarehouseId),
                    WarehouseLocationId = salesDetail.WarehouseLocationId,
                    ExistingDetailEntity = detail
                };
                
                // 初始化 ProductSearchValue
                if (salesItem.SelectedProduct != null)
                {
                    salesItem.ProductSearchValue = FormatProductDisplayText(salesItem.SelectedProduct);
                }
                
                // 載入該商品的可用倉庫位置清單
                if (salesItem.SelectedProduct != null)
                {
                    salesItem.AvailableWarehouseLocations = await InventoryStockService.GetAvailableWarehouseLocationsByProductAsync(salesItem.SelectedProduct.Id);
                    
                    // 找到對應的庫存明細ID
                    if (salesItem.SelectedWarehouse != null)
                    {
                        var stockDetail = salesItem.AvailableWarehouseLocations.FirstOrDefault(d => 
                            d.WarehouseId == salesItem.SelectedWarehouse.Id && 
                            d.WarehouseLocationId == salesItem.WarehouseLocationId);
                        
                        if (stockDetail != null)
                        {
                            salesItem.InventoryStockDetailId = stockDetail.Id;
                            salesItem.CurrentStockQuantity = stockDetail.AvailableStock;
                        }
                    }
                }
                
                SalesItems.Add(salesItem);
            }
            else
            {
                // 通用轉換邏輯
                var salesItem = new SalesItem
                {
                    ExistingDetailEntity = detail
                };
                
                // 使用反射設定屬性
                var productId = GetPropertyValue<int>(detail, "ProductId");
                salesItem.SelectedProduct = Products.FirstOrDefault(p => p.Id == productId);
                
                // 初始化 ProductSearchValue
                if (salesItem.SelectedProduct != null)
                {
                    salesItem.ProductSearchValue = FormatProductDisplayText(salesItem.SelectedProduct);
                }
                
                salesItem.OrderQuantity = GetPropertyValue<decimal>(detail, QuantityPropertyName);
                salesItem.UnitPrice = GetPropertyValue<decimal>(detail, UnitPricePropertyName);
                salesItem.DetailRemarks = GetPropertyValue<string>(detail, RemarksPropertyName) ?? "";
                
                if (!string.IsNullOrEmpty(DiscountPercentagePropertyName))
                    salesItem.DiscountPercentage = GetPropertyValue<decimal>(detail, DiscountPercentagePropertyName);
                    
                if (!string.IsNullOrEmpty(SubtotalPropertyName))
                    salesItem.Subtotal = GetPropertyValue<decimal>(detail, SubtotalPropertyName);
                
                // 設定稅率（優先使用明細稅率，其次商品稅率，最後系統預設值）
                var detailTaxRate = GetPropertyValue<decimal?>(detail, "TaxRate");
                var systemTaxRate2 = await SystemParameterService.GetTaxRateAsync();
                salesItem.TaxRate = detailTaxRate ?? salesItem.SelectedProduct?.TaxRate ?? systemTaxRate2;
                
                if (!string.IsNullOrEmpty(WarehouseIdPropertyName))
                {
                    var warehouseId = GetPropertyValue<int?>(detail, WarehouseIdPropertyName);
                    if (warehouseId.HasValue)
                        salesItem.SelectedWarehouse = Warehouses.FirstOrDefault(w => w.Id == warehouseId.Value);
                }
                
                // 嘗試取得 WarehouseLocationId
                var warehouseLocationId = GetPropertyValue<int?>(detail, "WarehouseLocationId");
                if (warehouseLocationId.HasValue)
                    salesItem.WarehouseLocationId = warehouseLocationId;
                
                // 載入該商品的可用倉庫位置清單
                if (salesItem.SelectedProduct != null)
                {
                    salesItem.AvailableWarehouseLocations = await InventoryStockService.GetAvailableWarehouseLocationsByProductAsync(salesItem.SelectedProduct.Id);
                    
                    // 找到對應的庫存明細ID
                    if (salesItem.SelectedWarehouse != null)
                    {
                        var stockDetail = salesItem.AvailableWarehouseLocations.FirstOrDefault(d => 
                            d.WarehouseId == salesItem.SelectedWarehouse.Id && 
                            d.WarehouseLocationId == salesItem.WarehouseLocationId);
                        
                        if (stockDetail != null)
                        {
                            salesItem.InventoryStockDetailId = stockDetail.Id;
                            salesItem.CurrentStockQuantity = stockDetail.AvailableStock;
                        }
                    }
                }
                
                SalesItems.Add(salesItem);
            }
        }
        
        // 載入退貨數量資訊（不觸發 StateHasChanged）
        await LoadReturnedQuantitiesAsync();
        
        //  資料載入完成 - 觸發空行檢查
        _dataLoadCompleted = true;
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }

    private List<TDetailEntity> ConvertToDetailEntities()
    {
        var details = new List<TDetailEntity>();
        
        foreach (var item in SalesItems.Where(x => x.SelectedProduct != null))
        {
            TDetailEntity detail;
            
            if (item.ExistingDetailEntity != null)
            {
                // 更新現有明細
                detail = item.ExistingDetailEntity;
                
                // 更新基本資訊
                SetPropertyValue(detail, "ProductId", item.SelectedProduct!.Id);
                SetPropertyValue(detail, QuantityPropertyName, item.OrderQuantity);
                SetPropertyValue(detail, UnitPricePropertyName, item.UnitPrice);
                SetPropertyValue(detail, RemarksPropertyName, item.DetailRemarks);
                
                // 更新可選屬性
                if (!string.IsNullOrEmpty(DiscountPercentagePropertyName))
                    SetPropertyValue(detail, DiscountPercentagePropertyName, item.DiscountPercentage);
                    
                if (!string.IsNullOrEmpty(SubtotalPropertyName))
                    SetPropertyValue(detail, SubtotalPropertyName, item.Subtotal);
                
                if (!string.IsNullOrEmpty(WarehouseIdPropertyName))
                    SetPropertyValue(detail, WarehouseIdPropertyName, item.SelectedWarehouse?.Id);
                
                // 更新倉庫位置ID
                SetPropertyValue(detail, "WarehouseLocationId", item.WarehouseLocationId);
                
                // 更新稅率
                SetPropertyValue(detail, "TaxRate", item.TaxRate);
                
                // 更新報價單明細來源（如果有）
                if (item.SourceQuotationDetailId.HasValue)
                    SetPropertyValue(detail, "QuotationDetailId", item.SourceQuotationDetailId.Value);
            }
            else
            {
                // 新增明細
                detail = new TDetailEntity();
                
                // 設定主實體關聯
                if (MainEntity != null)
                    SetPropertyValue(detail, MainEntityIdPropertyName, GetPropertyValue<int>(MainEntity, "Id"));
                
                // 設定基本資訊
                SetPropertyValue(detail, "ProductId", item.SelectedProduct!.Id);
                SetPropertyValue(detail, QuantityPropertyName, item.OrderQuantity);
                SetPropertyValue(detail, UnitPricePropertyName, item.UnitPrice);
                SetPropertyValue(detail, RemarksPropertyName, item.DetailRemarks);
                
                // 設定可選屬性
                if (!string.IsNullOrEmpty(DiscountPercentagePropertyName))
                    SetPropertyValue(detail, DiscountPercentagePropertyName, item.DiscountPercentage);
                    
                if (!string.IsNullOrEmpty(SubtotalPropertyName))
                    SetPropertyValue(detail, SubtotalPropertyName, item.Subtotal);
                
                if (!string.IsNullOrEmpty(WarehouseIdPropertyName))
                    SetPropertyValue(detail, WarehouseIdPropertyName, item.SelectedWarehouse?.Id);
                
                // 設定倉庫位置ID
                SetPropertyValue(detail, "WarehouseLocationId", item.WarehouseLocationId);
                
                // 設定稅率
                SetPropertyValue(detail, "TaxRate", item.TaxRate);
                
                // 設定報價單明細來源（如果有）
                if (item.SourceQuotationDetailId.HasValue)
                    SetPropertyValue(detail, "QuotationDetailId", item.SourceQuotationDetailId.Value);
            }
            
            details.Add(detail);
        }
        
        return details;
    }

    private async Task NotifyDetailsChanged()
    {
        var details = ConvertToDetailEntities();
        await OnDetailsChanged.InvokeAsync(details);
        
        // 通知已刪除的明細 ID
        if (OnDeletedDetailsChanged.HasDelegate && _deletedDetailIds.Any())
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds.ToList());
            _deletedDetailIds.Clear(); // 清空已通知的刪除ID
        }
        
        // 通知是否有不可刪除的明細
        await NotifyHasUndeletableDetailsChanged();
    }

    private T? GetPropertyValue<T>(object obj, string propertyName)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property == null) return default(T);
        
        var value = property.GetValue(obj);
        if (value == null) return default(T);
        
        if (typeof(T) == typeof(object)) return (T)value;
        
        return (T)Convert.ChangeType(value, typeof(T));
    }

    private void SetPropertyValue(object obj, string propertyName, object? value)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property != null && property.CanWrite)
        {
            if (value != null && property.PropertyType != value.GetType())
            {
                // 處理類型轉換
                if (property.PropertyType.IsGenericType && property.PropertyType.GetGenericTypeDefinition() == typeof(Nullable<>))
                {
                    var underlyingType = Nullable.GetUnderlyingType(property.PropertyType);
                    value = underlyingType != null ? Convert.ChangeType(value, underlyingType) : value;
                }
                else
                {
                    value = Convert.ChangeType(value, property.PropertyType);
                }
            }
            property.SetValue(obj, value);
        }
    }

    // ===== InteractiveTableComponent 方法 =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // 商品選擇欄位 - 使用 SearchableSelect 類型
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "商品編號/名稱",
            PropertyName = "ProductSearchValue",
            EmptyCheckPropertyName = "SelectedProduct",
            TriggerEmptyRowOnFilled = true,
            ColumnType = InteractiveColumnType.SearchableSelect,
            Width = "250px",
            Tooltip = "搜尋並選擇要銷售的商品。已有退貨或沖款記錄的商品將無法變更",
            Placeholder = "請輸入商品編號或名稱",
            SearchValuePropertyName = nameof(SalesItem.ProductSearchValue),
            FilteredItemsPropertyName = nameof(SalesItem.FilteredProducts),
            ShowDropdownPropertyName = nameof(SalesItem.ShowProductDropdown),
            SelectedIndexPropertyName = nameof(SalesItem.ProductSelectedIndex),
            ItemDisplayFormatter = (item) =>
            {
                var product = (Product)item;
                return FormatProductDisplayText(product);
            },
            IsDisabledFunc = item =>
            {
                var salesItem = (SalesItem)item;
                return IsReadOnly || !CanDeleteItem(salesItem, out _);
            },
            TooltipFunc = item =>
            {
                var salesItem = (SalesItem)item;
                if (!CanDeleteItem(salesItem, out string reason))
                    return reason;
                return null;
            },
            OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, (tuple) =>
            {
                var (item, searchValue) = tuple;
                OnProductSearchInput((SalesItem)item, searchValue);
            }),
            OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
            {
                var (item, selectedItem) = tuple;
                await OnProductSelectItem((SalesItem)item, (Product?)selectedItem);
            }),
            OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnProductFocus((SalesItem)item);
            }),
            OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnProductBlur((SalesItem)item);
            }),
            EnableKeyboardNavigation = true,
            GetDropdownItems = (item) => ((SalesItem)item).FilteredProducts,
            GetSelectedIndex = (item) => ((SalesItem)item).ProductSelectedIndex,
            SetSelectedIndex = (item, index) => ((SalesItem)item).ProductSelectedIndex = index,
            GetShowDropdown = (item) => ((SalesItem)item).ShowProductDropdown,
            SetShowDropdown = (item, show) => ((SalesItem)item).ShowProductDropdown = show,
            MaxDisplayItems = 20
        });

        // 倉庫 - 庫位選擇欄位（合併顯示，僅顯示有庫存的位置）
        columns.Add(new InteractiveColumnDefinition
            { 
                Title = "倉庫 - 庫位", 
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "200px",
                HideOnMobile = true,
                Tooltip = "選擇出貨的倉庫和庫位（僅顯示有庫存的位置）。已有退貨或沖款記錄的商品將無法變更",
                CustomTemplate = item => 
                {
                    var salesItem = (SalesItem)item;
                    var hasReturnRecord = HasReturnRecord(salesItem);
                    var hasPaymentRecord = HasPaymentRecord(salesItem);
                    var isFieldReadOnly = IsReadOnly || hasReturnRecord || hasPaymentRecord;
                    var selectedValue = salesItem.InventoryStockDetailId?.ToString() ?? "";
                    var isDisabled = isFieldReadOnly || salesItem.SelectedProduct == null || !salesItem.AvailableWarehouseLocations.Any();
                    
                    // 組合 tooltip 訊息
                    var tooltipMessages = new List<string>();
                    if (hasReturnRecord)
                        tooltipMessages.Add("此商品已有退貨記錄");
                    if (hasPaymentRecord)
                    {
                        var receivedAmount = GetReceivedAmount(salesItem);
                        tooltipMessages.Add($"此商品已有沖款記錄（已收款 {receivedAmount:N0} 元）");
                    }
                    var title = tooltipMessages.Any()
                        ? string.Join("；", tooltipMessages) + "，無法修改倉庫設定"
                        : "";
                    
                    if (isFieldReadOnly && salesItem.SelectedWarehouse != null)
                    {
                        // 唯讀模式：顯示純文字
                        var locationName = salesItem.WarehouseLocationId.HasValue 
                            ? salesItem.AvailableWarehouseLocations
                                .FirstOrDefault(d => d.Id == salesItem.InventoryStockDetailId)
                                ?.WarehouseLocation?.Name ?? "預設位置"
                            : "預設位置";
                        var displayText = $"{salesItem.SelectedWarehouse.Name} - {locationName}";
                        
                        return @<span class="text-muted" title="@title">
                            @displayText
                        </span>;
                    }
                    else
                    {
                        // 可編輯模式：顯示下拉選單
                        return @<select class="form-select form-select-sm"
                                       value="@selectedValue"
                                       disabled="@isDisabled"
                                       @onchange="@(async (e) => await OnWarehouseLocationChanged(salesItem, e.Value))">
                            <option value="">請選擇</option>
                            @foreach (var stockDetail in salesItem.AvailableWarehouseLocations)
                            {
                                var warehouseName = stockDetail.Warehouse?.Name ?? "未知倉庫";
                                var locationName = stockDetail.WarehouseLocation?.Name ?? "預設位置";
                                var displayText = $"{warehouseName} - {locationName} (可用: {stockDetail.AvailableStock})";
                                <option value="@stockDetail.Id">@displayText</option>
                            }
                        </select>;
                    }
                }
        });
        
        // 庫存量欄位 (只讀顯示，不儲存到資料庫，加入排程狀態提示)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "庫存", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            HideOnMobile = true,
            Tooltip = "選擇倉庫後顯示該商品的即時可用庫存量（唯讀），並標示是否需要排程生產",
            CustomTemplate = item => 
            {
                var salesItem = (SalesItem)item;
                
                // 只有當選擇了商品和倉庫時才顯示庫存量
                if (salesItem.SelectedProduct == null || salesItem.SelectedWarehouse == null)
                {
                    return @<span class="text-muted">-</span>;
                }
                
                // 顯示庫存量（有可能尚未載入）
                if (salesItem.CurrentStockQuantity.HasValue)
                {
                    var stockQty = salesItem.CurrentStockQuantity.Value;
                    var orderQty = salesItem.OrderQuantity;
                    var canSchedule = salesItem.SelectedProduct.CanSchedule;
                    var isStockEnough = stockQty >= orderQty;
                    
                    // 顏色邏輯：庫存足夠=綠色，不足=紅色
                    var textColor = isStockEnough ? "text-success" : "text-danger";
                    
                    return @<div class="d-flex align-items-center gap-2">
                        <span class="@textColor fw-bold" title="即時可用庫存">
                            @stockQty.ToString("N0")
                        </span>
                        
                        @* 可排程商品才顯示徽章 *@
                        @if (canSchedule)
                        {
                            if (isStockEnough)
                            {
                                <span class="badge bg-success" style="font-size: 0.65rem" title="庫存充足，可直接出貨">
                                    <i class="bi bi-check-circle"></i>
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-warning text-dark" style="font-size: 0.65rem" title="庫存不足，需要排程生產">
                                    <i class="bi bi-calendar-event"></i>
                                </span>
                            }
                        }
                    </div>;
                }
                else
                {
                    // 載入中
                    return @<span class="text-muted">
                        <i class="bi bi-hourglass-split"></i>
                    </span>;
                }
            }
        });
        
        // 訂單數量欄位 - 檢查是否有退貨或沖款記錄，如果有則鎖定
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "訂單數量", 
            PropertyName = nameof(SalesItem.OrderQuantity),
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            Tooltip = "銷售的商品數量。已退貨或已收款的商品將無法修改數量",
            IsDisabledFunc = item =>
            {
                var salesItem = (SalesItem)item;
                return HasReturnRecord(salesItem) || HasPaymentRecord(salesItem);
            },
            TooltipFunc = item =>
            {
                var salesItem = (SalesItem)item;
                var hasReturnRecord = HasReturnRecord(salesItem);
                var hasPaymentRecord = HasPaymentRecord(salesItem);
                if (!hasReturnRecord && !hasPaymentRecord) return null;
                
                var tooltipMessages = new List<string>();
                if (hasReturnRecord)
                    tooltipMessages.Add("此商品已有退貨記錄");
                if (hasPaymentRecord)
                {
                    var receivedAmount = GetReceivedAmount(salesItem);
                    tooltipMessages.Add($"此商品已有沖款記錄（已收款 {receivedAmount:N0} 元）");
                }
                return string.Join("；", tooltipMessages) + "，無法修改訂單數量";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnOrderQuantityInput((SalesItem)item, valueString);
            })
        });

        // 銷貨數量欄位（已出貨數量）- 唯讀顯示
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "銷貨數量",
            PropertyName = nameof(SalesItem.DeliveredQuantity),
            ColumnType = InteractiveColumnType.Display,
            Width = "100px",
            SmartDecimalDisplay = true,
            TextAlign = "right",
            HideOnMobile = true,
            Tooltip = "已出貨的數量（唯讀）"
        });

        // 單價欄位 - 檢查是否有退貨或沖款記錄，如果有則鎖定
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "單價", 
            PropertyName = nameof(SalesItem.UnitPrice),
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            Tooltip = "商品的銷售單價。已退貨或已收款的商品將無法修改價格",
            IsDisabledFunc = item =>
            {
                var salesItem = (SalesItem)item;
                return HasReturnRecord(salesItem) || HasPaymentRecord(salesItem);
            },
            TooltipFunc = item =>
            {
                var salesItem = (SalesItem)item;
                var hasReturnRecord = HasReturnRecord(salesItem);
                var hasPaymentRecord = HasPaymentRecord(salesItem);
                if (!hasReturnRecord && !hasPaymentRecord) return null;
                
                var tooltipMessages = new List<string>();
                if (hasReturnRecord)
                    tooltipMessages.Add("此商品已有退貨記錄");
                if (hasPaymentRecord)
                {
                    var receivedAmount = GetReceivedAmount(salesItem);
                    tooltipMessages.Add($"此商品已有沖款記錄（已收款 {receivedAmount:N0} 元）");
                }
                return string.Join("；", tooltipMessages) + "，無法修改單價";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnUnitPriceInput((SalesItem)item, valueString);
            })
        });        

        // 折扣欄位 - 檢查是否有退貨或沖款記錄，如果有則鎖定
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "折扣%", 
            PropertyName = nameof(SalesItem.DiscountPercentage),
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            HideOnMobile = true,
            Tooltip = "折扣百分比（0-100%）。已退貨或已收款的商品將無法修改折扣",
            IsDisabledFunc = item =>
            {
                var salesItem = (SalesItem)item;
                return HasReturnRecord(salesItem) || HasPaymentRecord(salesItem);
            },
            TooltipFunc = item =>
            {
                var salesItem = (SalesItem)item;
                var hasReturnRecord = HasReturnRecord(salesItem);
                var hasPaymentRecord = HasPaymentRecord(salesItem);
                if (!hasReturnRecord && !hasPaymentRecord) return null;
                
                var tooltipMessages = new List<string>();
                if (hasReturnRecord)
                    tooltipMessages.Add("此商品已有退貨記錄");
                if (hasPaymentRecord)
                {
                    var receivedAmount = GetReceivedAmount(salesItem);
                    tooltipMessages.Add($"此商品已有沖款記錄（已收款 {receivedAmount:N0} 元）");
                }
                return string.Join("；", tooltipMessages) + "，無法修改折扣";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnDiscountPercentageInput((SalesItem)item, valueString);
            })
        });
        
        // 稅率欄位 - 根據稅別決定是否啟用
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "稅率%", 
            PropertyName = nameof(SalesItem.TaxRate),
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            HideOnMobile = true,
            Tooltip = "稅率百分比（0-100%）",
            IsDisabledFunc = item =>
            {
                var salesItem = (SalesItem)item;
                return IsTaxCalculationMethodNoTax || HasReturnRecord(salesItem) || HasPaymentRecord(salesItem);
            },
            TooltipFunc = item =>
            {
                var salesItem = (SalesItem)item;
                
                // 免稅時顯示特殊提示
                if (IsTaxCalculationMethodNoTax)
                    return "主檔設定為「不含稅」，稅率欄位已禁用";
                
                var hasReturnRecord = HasReturnRecord(salesItem);
                var hasPaymentRecord = HasPaymentRecord(salesItem);
                if (!hasReturnRecord && !hasPaymentRecord) return null;
                
                var tooltipMessages = new List<string>();
                if (hasReturnRecord)
                    tooltipMessages.Add("此商品已有退貨記錄");
                if (hasPaymentRecord)
                {
                    var receivedAmount = GetReceivedAmount(salesItem);
                    tooltipMessages.Add($"此商品已有沖款記錄（已收款 {receivedAmount:N0} 元）");
                }
                return string.Join("；", tooltipMessages) + "，無法修改稅率";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnTaxRateInput((SalesItem)item, valueString);
            })
        });

        // 小計欄位（根據稅別計算）
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "小計",
            Tooltip = GetSubtotalTooltip(),
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item =>
            {
                var salesItem = (SalesItem)item;
                var subtotal = CalculateItemSubtotal(salesItem);
                var displayValue = NumberFormatHelper.FormatSmartZeroAsEmpty(subtotal);
                return @<div class="text-end fw-bold text-success">@displayValue</div>;
            }
        });

        // 備註欄位
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "備註", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "150px",
            HideOnMobile = true,
            Tooltip = "選填。可記錄銷貨相關的備註資訊",
            CustomTemplate = item => 
            {
                var salesItem = (SalesItem)item;
                
                return @<input type="text" class="form-control "
                              value="@salesItem.DetailRemarks"
                              @oninput="(e) => OnRemarksInput(salesItem, e.Value?.ToString())"
                              readonly="@IsReadOnly"
                              placeholder="備註..." />;
            }
        });

        return columns;
    }

    private RenderFragment<SalesItem> GetCustomActionsTemplate => item => __builder =>
    {
        var salesItem = (SalesItem)item;
        var isEmptyRow = salesItem.SelectedProduct == null;
        var canDelete = CanDeleteItem(item, out _);
        var hasComposition = salesItem.SelectedProduct != null && HasProductComposition(salesItem.SelectedProduct.Id);
        var isCompositionReadOnly = GetCompositionModalReadOnlyState();
        
        <div class="d-flex gap-1">
            @* BOM 編輯/查看按鈕（如果商品有 BOM 組成） *@
            @if (hasComposition && !isEmptyRow)
            {
                var buttonTitle = isCompositionReadOnly ? "查看 BOM 組成" : "編輯 BOM 組成";
                var buttonVariant = isCompositionReadOnly ? ButtonVariant.Blue : ButtonVariant.DarkBlue;
                
                <GenericButtonComponent Variant="@buttonVariant"
                                       IconClass="bi bi-diagram-3 text-white"
                                       Size="ButtonSize.Large"
                                       Title="@buttonTitle"
                                       OnClick="() => ShowCompositionEditor(salesItem)"
                                       StopPropagation="true"
                                       CssClass="btn-square" />
            }
            
            @* 原有的刪除/查看按鈕 *@
            @if (canDelete)
            {
                // 可以刪除：顯示刪除按鈕
                <GenericButtonComponent Variant="ButtonVariant.Red"
                                       IconClass="bi bi-trash text-white"
                                       Size="ButtonSize.Large"
                                       IsDisabled="@IsReadOnly"
                                       Title="刪除"
                                       OnClick="async () => await HandleItemDelete(item)"
                                       StopPropagation="true"
                                       CssClass="btn-square" />
            }
            else
            {
                // 不能刪除：顯示查看按鈕
                <GenericButtonComponent Variant="ButtonVariant.Blue"
                                       IconClass="bi bi-eye text-white"
                                       Size="ButtonSize.Large"
                                       Title="查看相關單據"
                                       OnClick="async () => await ShowRelatedDocuments(item)"
                                       StopPropagation="true"
                                       CssClass="btn-square" />
            }
        </div>
    };

    private async Task HandleItemDelete(SalesItem item)
    {
        // 使用綜合檢查方法，確認是否可以刪除
        if (!CanDeleteItem(item, out string reason))
        {
            await NotificationService.ShowWarningAsync(reason, "操作限制");
            return;
        }
        
        var index = SalesItems.IndexOf(item);
        await RemoveItemAsync(index);
    }

    /// <summary>
    /// 顯示相關單據（退貨單和沖款單）
    /// </summary>
    private async Task ShowRelatedDocuments(SalesItem item)
    {
        // 檢查是否有現有的明細實體 ID
        if (item.ExistingDetailEntity is not SalesOrderDetail detail || detail.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("此項目尚未儲存，無法查看相關單據", "提示");
            return;
        }

        // 設定商品名稱
        selectedProductName = item.SelectedProduct?.Name ?? "未知商品";

        // 顯示 Modal 並開始載入
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            // 查詢相關單據
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsForSalesOrderDetailAsync(detail.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入相關單據失敗：{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// 處理點擊相關單據的事件
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // 觸發事件，讓父組件（EditModal）處理開啟相關單據
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            // 如果父組件沒有處理，顯示提示訊息
            await NotificationService.ShowInfoAsync(
                $"請在主畫面中開啟 {document.TypeDisplayName}: {document.DocumentNumber}", 
                "提示"
            );
        }
    }

    private List<Product> GetAvailableProducts()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
        {
            return new List<Product>();
        }
        
        return AvailableProducts;
    }

    private decimal GetTotalAmount()
    {
        return SalesItems
            .Where(item => item.SelectedProduct != null)
            .Sum(item => item.Subtotal);
    }

    public class SalesItem
    {
        public Product? SelectedProduct { get; set; }
        public decimal OrderQuantity { get; set; } = 0;
        public decimal DeliveredQuantity { get; set; } = 0;
        public decimal UnitPrice { get; set; } = 0;
        public decimal DiscountPercentage { get; set; } = 0;
        public decimal Subtotal { get; set; } = 0;
        public decimal TaxRate { get; set; } = 0;
        public string DetailRemarks { get; set; } = string.Empty;
        public Warehouse? SelectedWarehouse { get; set; }
        public TDetailEntity? ExistingDetailEntity { get; set; }
        
        // === 報價單來源相關屬性 ===
        public int? SourceQuotationId { get; set; }
        public int? SourceQuotationDetailId { get; set; }
        public bool? IsQuotationApproved { get; set; }
        
        /// <summary>
        /// 即時庫存量（不儲存到資料庫）
        /// </summary>
        public int? CurrentStockQuantity { get; set; }
        
        /// <summary>
        /// 庫存明細ID（用於選擇倉庫-庫位）
        /// </summary>
        public int? InventoryStockDetailId { get; set; }
        
        /// <summary>
        /// 倉庫位置ID
        /// </summary>
        public int? WarehouseLocationId { get; set; }
        
        /// <summary>
        /// 可用的倉庫位置清單（僅顯示有庫存的位置）
        /// </summary>
        public List<InventoryStockDetail> AvailableWarehouseLocations { get; set; } = new();
        
        /// <summary>
        /// 自訂的 BOM 組合明細（用於暫存編輯結果）
        /// </summary>
        public List<SalesOrderCompositionDetail>? CustomCompositionDetails { get; set; }
        
        // === SearchableSelect 支援屬性 ===
        public string ProductSearchValue { get; set; } = string.Empty;
        public List<Product> FilteredProducts { get; set; } = new();
        public bool ShowProductDropdown { get; set; } = false;
        public int ProductSelectedIndex { get; set; } = -1;
        
        /// <summary>
        /// 計算小計
        /// </summary>
        public void CalculateSubtotal()
        {
            // 小計 = 數量 × 單價 × (1 - 折扣% / 100)
            // 例如：50 × 62 × (1 - 1/100) = 50 × 62 × 0.99 = 3069
            Subtotal = Math.Round(OrderQuantity * UnitPrice * (1 - DiscountPercentage / 100), 2);
            
            // 確保小計不為負數
            if (Subtotal < 0) Subtotal = 0;
        }
        
        /// <summary>
        /// 取得顯示用的商品名稱
        /// </summary>
        public string DisplayName => 
            SelectedProduct != null 
                ? $"{SelectedProduct.Code} - {SelectedProduct.Name}" 
                : "";
    }

    // ===== 事件處理方法 =====
    
    // ===== 商品 SearchableSelect 事件處理 =====
    
    /// <summary>
    /// 商品搜尋輸入處理
    /// </summary>
    private void OnProductSearchInput(SalesItem item, string? searchValue)
    {
        item.ProductSearchValue = searchValue ?? string.Empty;
        
        var availableProducts = GetAvailableProducts();
        
        // 確保當前選中的商品也在列表中
        if (item.SelectedProduct != null && 
            !availableProducts.Any(p => p.Id == item.SelectedProduct.Id))
        {
            availableProducts = new List<Product>(availableProducts) { item.SelectedProduct };
        }
        
        if (string.IsNullOrWhiteSpace(searchValue))
        {
            item.FilteredProducts = availableProducts.Take(20).ToList();
        }
        else
        {
            item.FilteredProducts = availableProducts
                .Where(p => 
                    (p.Code?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (p.Name?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false))
                .Take(20)
                .ToList();
        }
        
        item.ShowProductDropdown = true;
        item.ProductSelectedIndex = -1;
        StateHasChanged();
    }
    
    /// <summary>
    /// 商品輸入框獲得焦點
    /// </summary>
    private void OnProductFocus(SalesItem item)
    {
        var availableProducts = GetAvailableProducts();
        
        // 確保當前選中的商品也在列表中
        if (item.SelectedProduct != null && 
            !availableProducts.Any(p => p.Id == item.SelectedProduct.Id))
        {
            availableProducts = new List<Product>(availableProducts) { item.SelectedProduct };
        }
        
        item.FilteredProducts = availableProducts.Take(20).ToList();
        item.ShowProductDropdown = true;
        item.ProductSelectedIndex = -1;
        StateHasChanged();
    }
    
    /// <summary>
    /// 商品輸入框失去焦點
    /// </summary>
    private void OnProductBlur(SalesItem item)
    {
        Task.Delay(200).ContinueWith(_ =>
        {
            item.ShowProductDropdown = false;
            InvokeAsync(StateHasChanged);
        });
    }
    
    /// <summary>
    /// 選擇商品項目
    /// </summary>
    private async Task OnProductSelectItem(SalesItem item, Product? selectedProduct)
    {
        if (selectedProduct == null)
        {
            item.SelectedProduct = null;
            item.ProductSearchValue = string.Empty;
            item.ShowProductDropdown = false;
            item.ProductSelectedIndex = -1;
            item.CurrentStockQuantity = null;
            item.AvailableWarehouseLocations = new List<InventoryStockDetail>();
            item.InventoryStockDetailId = null;
            item.SelectedWarehouse = null;
            item.WarehouseLocationId = null;
            await NotifyDetailsChanged();
            return;
        }
        
        item.SelectedProduct = selectedProduct;
        item.ProductSearchValue = FormatProductDisplayText(selectedProduct);
        item.ShowProductDropdown = false;
        item.ProductSelectedIndex = -1;
        
        // 自動帶入商品稅率（優先使用商品稅率，沒有則使用系統預設值）
        item.TaxRate = selectedProduct.TaxRate ?? await SystemParameterService.GetTaxRateAsync();
        
        // 載入該商品的可用倉庫位置清單（僅有庫存的位置）
        item.AvailableWarehouseLocations = await InventoryStockService.GetAvailableWarehouseLocationsByProductAsync(selectedProduct.Id);
        
        // 重置倉庫選擇
        item.InventoryStockDetailId = null;
        item.SelectedWarehouse = null;
        item.WarehouseLocationId = null;
        item.CurrentStockQuantity = null;
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }
    
    /// <summary>
    /// 格式化商品顯示文字（用於下拉選單）
    /// </summary>
    private string FormatProductDisplayText(Product product)
    {
        if (product == null) return "";
        
        return !string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name)
            ? $"[{product.Code}] {product.Name}"
            : (!string.IsNullOrEmpty(product.Code) ? $"[{product.Code}]" : product.Name ?? "");
    }
    
    // ===== 商品選擇事件處理（舊方法，保留以防其他地方使用） =====
    private async Task OnProductChanged(SalesItem item, object? value)
    {
        // 檢查是否可以修改
        if (!CanDeleteItem(item, out string reason))
        {
            await NotificationService.ShowWarningAsync(
                "無法修改商品",
                reason
            );
            StateHasChanged(); // 強制重新渲染以恢復原值
            return;
        }
        
        var productIdStr = value?.ToString();
        if (string.IsNullOrEmpty(productIdStr))
        {
            item.SelectedProduct = null;
            item.CurrentStockQuantity = null; // 清空庫存量
            item.AvailableWarehouseLocations = new List<InventoryStockDetail>();
            item.InventoryStockDetailId = null;
            item.SelectedWarehouse = null;
            item.WarehouseLocationId = null;
        }
        else if (int.TryParse(productIdStr, out var productId))
        {
            var product = GetAvailableProducts().FirstOrDefault(p => p.Id == productId);
            item.SelectedProduct = product;
            
            // 載入該商品的可用倉庫位置清單（僅有庫存的位置）
            if (product != null)
            {
                item.AvailableWarehouseLocations = await InventoryStockService.GetAvailableWarehouseLocationsByProductAsync(product.Id);
                
                // 重置倉庫選擇
                item.InventoryStockDetailId = null;
                item.SelectedWarehouse = null;
                item.WarehouseLocationId = null;
                item.CurrentStockQuantity = null;
            }
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnOrderQuantityInput(SalesItem item, string? value)
    {
        // 檢查是否可以修改
        if (!CanDeleteItem(item, out string reason))
        {
            var friendlyMessage = HasReturnRecord(item)
                ? "此商品已有退貨記錄，無法修改數量"
                : "此商品已有沖款記錄，無法修改數量";
            
            await NotificationService.ShowWarningAsync(friendlyMessage, "操作限制");
            return;
        }
        
        if (string.IsNullOrEmpty(value))
        {
            item.OrderQuantity = 0;
        }
        else if (decimal.TryParse(value, out var quantity))
        {
            item.OrderQuantity = quantity;
        }
        
        item.CalculateSubtotal();
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnUnitPriceInput(SalesItem item, string? value)
    {
        // 檢查是否可以修改
        if (!CanDeleteItem(item, out string reason))
        {
            var friendlyMessage = HasReturnRecord(item)
                ? "此商品已有退貨記錄，無法修改單價"
                : "此商品已有沖款記錄，無法修改單價";
            
            await NotificationService.ShowWarningAsync(friendlyMessage, "操作限制");
            return;
        }
        
        if (string.IsNullOrEmpty(value))
        {
            item.UnitPrice = 0;
        }
        else if (decimal.TryParse(value, out var price))
        {
            item.UnitPrice = price;
        }
        
        item.CalculateSubtotal();
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnDiscountPercentageInput(SalesItem item, string? value)
    {
        // 檢查是否可以修改
        if (!CanDeleteItem(item, out string reason))
        {
            var friendlyMessage = HasReturnRecord(item)
                ? "此商品已有退貨記錄，無法修改折扣"
                : "此商品已有沖款記錄，無法修改折扣";
            
            await NotificationService.ShowWarningAsync(friendlyMessage, "操作限制");
            return;
        }
        
        if (string.IsNullOrEmpty(value))
        {
            item.DiscountPercentage = 0;
        }
        else if (decimal.TryParse(value, out var percentage))
        {
            // 限制折扣百分比在 0-100 之間
            item.DiscountPercentage = Math.Max(0, Math.Min(100, percentage));
        }
        
        // 重新計算小計（會根據折扣百分比計算）
        item.CalculateSubtotal();
        
        // 通知父組件資料已變更（這會觸發 HandleDetailsChanged）
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    /// <summary>
    /// 處理稅率輸入
    /// </summary>
    private async Task OnTaxRateInput(SalesItem item, string? valueString)
    {
        // 檢查是否可以修改
        if (!CanDeleteItem(item, out string reason))
        {
            var friendlyMessage = HasReturnRecord(item)
                ? "此商品已有退貨記錄，無法修改稅率"
                : "此商品已有沖款記錄，無法修改稅率";
            
            await NotificationService.ShowWarningAsync(friendlyMessage, "操作限制");
            return;
        }
        
        if (string.IsNullOrWhiteSpace(valueString))
        {
            item.TaxRate = 0;
        }
        else if (decimal.TryParse(valueString, out var rate))
        {
            // 限制稅率在 0-100 之間
            item.TaxRate = Math.Max(0, Math.Min(100, rate));
        }
        
        // 通知父組件資料已變更
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// 計算明細項目的小計（根據稅別，四捨五入到整數）
    /// </summary>
    private decimal CalculateItemSubtotal(SalesItem item)
    {
        if (item.SelectedProduct == null || item.OrderQuantity <= 0 || item.UnitPrice <= 0)
            return 0;

        // 計算未稅金額
        var baseAmount = item.OrderQuantity * item.UnitPrice * (1 - item.DiscountPercentage / 100);

        switch (TaxCalculationMethod)
        {
            case TaxCalculationMethod.TaxExclusive:
                // 外加稅：小計 = 基礎金額 × (1 + 稅率%)
                var amountWithTax = baseAmount * (1 + item.TaxRate / 100);
                return Math.Round(amountWithTax, 0, MidpointRounding.AwayFromZero);

            case TaxCalculationMethod.TaxInclusive:
                // 內含稅：小計 = 基礎金額（單價已含稅，直接四捨五入）
                return Math.Round(baseAmount, 0, MidpointRounding.AwayFromZero);

            case TaxCalculationMethod.NoTax:
                // 免稅：小計 = 基礎金額（不計稅）
                return Math.Round(baseAmount, 0, MidpointRounding.AwayFromZero);

            default:
                return Math.Round(baseAmount, 0, MidpointRounding.AwayFromZero);
        }
    }

    /// <summary>
    /// 取得小計欄位的提示文字
    /// </summary>
    private string GetSubtotalTooltip()
    {
        return TaxCalculationMethod switch
        {
            TaxCalculationMethod.TaxExclusive => "小計（含稅）= 數量 × 單價 × (1 - 折扣%) × (1 + 稅率%)",
            TaxCalculationMethod.TaxInclusive => "小計（含稅）= 數量 × 單價 × (1 - 折扣%)（單價已內含稅）",
            TaxCalculationMethod.NoTax => "小計（未稅）= 數量 × 單價 × (1 - 折扣%)（免稅）",
            _ => "小計"
        };
    }

    private async Task OnWarehouseLocationChanged(SalesItem item, object? value)
    {
        // 檢查是否可以修改
        if (!CanDeleteItem(item, out string reason))
        {
            var friendlyMessage = HasReturnRecord(item)
                ? "此商品已有退貨記錄，無法修改倉庫設定"
                : "此商品已有沖款記錄，無法修改倉庫設定";
            
            await NotificationService.ShowWarningAsync(friendlyMessage, "操作限制");
            return;
        }
        
        if (value == null || !int.TryParse(value.ToString(), out int detailId))
        {
            item.InventoryStockDetailId = null;
            item.SelectedWarehouse = null;
            item.WarehouseLocationId = null;
            item.CurrentStockQuantity = null;
        }
        else
        {
            item.InventoryStockDetailId = detailId;
            
            // 從可用位置清單中找到對應的明細
            var selectedDetail = item.AvailableWarehouseLocations.FirstOrDefault(d => d.Id == detailId);
            if (selectedDetail != null)
            {
                item.SelectedWarehouse = selectedDetail.Warehouse;
                item.WarehouseLocationId = selectedDetail.WarehouseLocationId;
                item.CurrentStockQuantity = selectedDetail.AvailableStock;
            }
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnRemarksInput(SalesItem item, string? value)
    {
        item.DetailRemarks = value ?? string.Empty;
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    public async Task RemoveItemAsync(int index)
    {
        if (IsReadOnly || index < 0 || index >= SalesItems.Count) return;
        
        var removedItem = SalesItems[index];
        
        // 記錄要刪除的資料庫實體ID
        if (removedItem.ExistingDetailEntity != null)
        {
            var entityId = GetExistingDetailId(removedItem.ExistingDetailEntity!);
            if (entityId > 0)
            {
                _deletedDetailIds.Add(entityId);
            }
        }
        
        // 通知父組件項目即將被移除
        if (OnItemRemoved.HasDelegate)
        {
            await OnItemRemoved.InvokeAsync(removedItem);
        }
        
        SalesItems.RemoveAt(index);
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    /// <summary>
    /// 取得現有明細實體的ID
    /// </summary>
    private int GetExistingDetailId(TDetailEntity entity)
    {
        if (entity == null) return 0;
        
        // 假設所有的 BaseEntity 都有 Id 屬性
        var idProperty = entity.GetType().GetProperty("Id");
        if (idProperty != null && idProperty.PropertyType == typeof(int))
        {
            return (int)(idProperty.GetValue(entity) ?? 0);
        }
        
        return 0;
    }

    // ===== 業務邏輯方法 =====
    
    /// <summary>
    /// 載入指定項目的庫存量
    /// </summary>
    private async Task LoadStockQuantityAsync(SalesItem item)
    {
        // 檢查是否有選擇商品和倉庫
        if (item.SelectedProduct == null || item.SelectedWarehouse == null)
        {
            item.CurrentStockQuantity = null;
            return;
        }
        
        // 查詢庫存量
        var stockQuantity = await InventoryStockService.GetTotalAvailableStockByWarehouseAsync(
            item.SelectedProduct.Id, 
            item.SelectedWarehouse.Id
        );
        
        item.CurrentStockQuantity = stockQuantity;
    }
    
    /// <summary>
    /// 載入所有明細項目的庫存量
    /// </summary>
    private async Task LoadAllStockQuantitiesAsync()
    {
        var tasks = new List<Task>();
        
        foreach (var item in SalesItems.Where(x => x.SelectedProduct != null))
        {
            if (item.SelectedProduct != null && item.SelectedWarehouse != null)
            {
                tasks.Add(LoadStockQuantityAsync(item));
            }
        }
        
        if (tasks.Any())
        {
            await Task.WhenAll(tasks);
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// 統一設定所有明細項目的倉庫（只處理未鎖定的明細）
    /// </summary>
    /// <summary>
    /// 清空所有銷貨明細（只移除未鎖定的明細，保留已鎖定的）
    /// </summary>
    private async Task ClearAllDetails()
    {
        if (IsReadOnly) return;
        
        var nonEmptyItems = SalesItems.Where(item => item.SelectedProduct != null).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("沒有可移除的明細項目", "提示");
            return;
        }
        
        // 區分可刪除和被鎖定的明細
        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
        
        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "所有明細都已有退貨或沖款記錄，無法移除", 
                "操作限制");
            return;
        }
        
        // 通知父組件項目即將被移除
        if (OnItemRemoved.HasDelegate)
        {
            foreach (var item in unlocked)
            {
                await OnItemRemoved.InvokeAsync(item);
            }
        }
        
        // 記錄所有要刪除的現有明細 ID
        foreach (var item in unlocked.Where(item => item.ExistingDetailEntity != null))
        {
            var entityId = GetExistingDetailId(item.ExistingDetailEntity!);
            if (entityId > 0)
            {
                _deletedDetailIds.Add(entityId);
            }
        }
        
        // 從列表中移除未鎖定的項目，保留已鎖定的項目
        foreach (var item in unlocked)
        {
            SalesItems.Remove(item);
        }
        
        await NotifyDetailsChanged();
        
        var message = $"已移除 {unlocked.Count} 項明細";
        if (locked.Any())
        {
            message += $"\n（已保留 {locked.Count} 項已鎖定的明細）";
        }
        await NotificationService.ShowSuccessAsync(message);
    }

    /// <summary>
    /// 載入智能下單項目 - 根據客戶最近一次完整的銷貨訂單
    /// </summary>
    /// <summary>
    /// 載入報價單明細到銷貨訂單明細表
    /// </summary>
    private async Task LoadQuotationItems()
    {
        if (IsReadOnly || !SelectedCustomerId.HasValue || !SelectedQuotationId.HasValue) return;
        
        try
        {
            // 檢查是否有現有資料
            var hasExistingData = SalesItems.Any(item => item.SelectedProduct != null);
            
            if (hasExistingData)
            {
                if (!await ShowConfirmationAsync("載入報價明細", "此操作將覆蓋現有的銷貨明細，是否繼續？"))
                {
                    return;
                }
            }

            // 從服務獲取報價單資料
            var quotation = await QuotationService.GetWithDetailsAsync(SelectedQuotationId.Value);
            
            if (quotation == null)
            {
                await NotificationService.ShowWarningAsync("找不到指定的報價單", "載入失敗");
                return;
            }
            
            // 驗證報價單的客戶是否與選擇的客戶一致
            if (quotation.CustomerId != SelectedCustomerId.Value)
            {
                await NotificationService.ShowWarningAsync("報價單的客戶與當前選擇的客戶不一致", "載入失敗");
                return;
            }
            
            if (quotation.QuotationDetails == null || !quotation.QuotationDetails.Any())
            {
                await NotificationService.ShowInfoAsync("報價單沒有明細資料", "載入失敗");
                return;
            }

            // 清空現有項目
            SalesItems.Clear();
            _deletedDetailIds.Clear();

            // 將報價單明細轉換為銷貨項目
            var loadedCount = 0;
            foreach (var quotationDetail in quotation.QuotationDetails)
            {
                // 只載入尚未轉單的數量（報價數量 - 已轉數量）
                var pendingQuantity = quotationDetail.Quantity - quotationDetail.ConvertedQuantity;
                
                // 如果該明細已經全部轉完，跳過不載入
                if (pendingQuantity <= 0)
                {
                    continue;
                }
                
                var salesItem = new SalesItem
                {
                    SelectedProduct = quotationDetail.Product,
                    OrderQuantity = pendingQuantity,
                    UnitPrice = quotationDetail.UnitPrice,
                    DiscountPercentage = quotationDetail.DiscountPercentage,
                    TaxRate = quotationDetail.TaxRate ?? quotationDetail.Product?.TaxRate ?? await SystemParameterService.GetTaxRateAsync(),
                    DetailRemarks = quotationDetail.Remarks ?? "",
                    // 設定報價單來源資訊
                    SourceQuotationId = SelectedQuotationId.Value,
                    SourceQuotationDetailId = quotationDetail.Id,
                    IsQuotationApproved = quotation.IsApproved
                };
                
                // 初始化 ProductSearchValue
                if (salesItem.SelectedProduct != null)
                {
                    salesItem.ProductSearchValue = FormatProductDisplayText(salesItem.SelectedProduct);
                }
                
                // 計算小計
                salesItem.CalculateSubtotal();
                
                // 載入該商品的可用倉庫位置清單
                if (salesItem.SelectedProduct != null)
                {
                    salesItem.AvailableWarehouseLocations = await InventoryStockService.GetAvailableWarehouseLocationsByProductAsync(salesItem.SelectedProduct.Id);
                }
                
                SalesItems.Add(salesItem);
                loadedCount++;
            }
            
            // 載入所有項目的庫存量
            await LoadAllStockQuantitiesAsync();
            
            await NotifyDetailsChanged();
            
            if (loadedCount > 0)
            {
                await NotificationService.ShowSuccessAsync($"已載入 {loadedCount} 項未轉完的報價明細", "載入成功");
            }
            else
            {
                await NotificationService.ShowInfoAsync("所有報價明細都已完成轉單，無需再轉單", "提示");
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadQuotationItems), GetType());
            await NotificationService.ShowErrorAsync("載入報價單明細時發生錯誤", "錯誤");
        }
    }
    
    private async Task LoadSmartOrderItems()
    {
        if (IsReadOnly || !SelectedCustomerId.HasValue) return;
        
        // 檢查是否有現有資料
        var hasExistingData = SalesItems.Any(item => item.SelectedProduct != null);
        
        if (hasExistingData)
        {
            if (!await ShowConfirmationAsync("載入智能下單", "此操作將覆蓋現有的銷貨明細，是否繼續？"))
            {
                return;
            }
        }

        // 從服務獲取客戶的最近一次完整銷貨
        var lastSalesDetails = await SalesOrderDetailService.GetLastCompleteSalesAsync(SelectedCustomerId.Value);
        
        if (!lastSalesDetails.Any())
        {
            await NotificationService.ShowInfoAsync("該客戶沒有銷貨歷史紀錄可參考", "智能下單");
            return;
        }

        // 清空現有項目
        SalesItems.Clear();
        _deletedDetailIds.Clear();

        // 將歷史銷貨轉換為新的銷貨項目
        foreach (var detail in lastSalesDetails)
        {
            var salesItem = new SalesItem
            {
                SelectedProduct = detail.Product,
                OrderQuantity = detail.OrderQuantity,
                UnitPrice = detail.UnitPrice,
                TaxRate = detail.TaxRate ?? detail.Product?.TaxRate ?? await SystemParameterService.GetTaxRateAsync(),
                DetailRemarks = detail.Remarks ?? "",
                SelectedWarehouse = detail.Warehouse ?? (detail.WarehouseId.HasValue ? 
                    Warehouses.FirstOrDefault(w => w.Id == detail.WarehouseId.Value) : null)
            };
            
            // 初始化 ProductSearchValue
            if (salesItem.SelectedProduct != null)
            {
                salesItem.ProductSearchValue = FormatProductDisplayText(salesItem.SelectedProduct);
            }
            
            salesItem.CalculateSubtotal();
            SalesItems.Add(salesItem);
        }
        
        // 載入所有項目的庫存量
        await LoadAllStockQuantitiesAsync();
        
        await NotifyDetailsChanged();
        await NotificationService.ShowSuccessAsync($"已載入 {lastSalesDetails.Count} 項商品作為參考", "智能下單完成");
        
        StateHasChanged();
    }

    /// <summary>
    /// 從報價單載入明細（公開方法，供父組件呼叫）
    /// </summary>
    /// <param name="quotationDetails">報價單明細列表</param>
    /// <param name="quotationId">報價單ID</param>
    /// <param name="isQuotationApproved">報價單是否已審核</param>
    public async Task LoadQuotationDetails(List<QuotationDetail> quotationDetails, int quotationId, bool isQuotationApproved)
    {
        if (IsReadOnly) return;
        
        try
        {
            if (quotationDetails == null || !quotationDetails.Any())
            {
                await NotificationService.ShowWarningAsync("報價單沒有明細資料", "載入失敗");
                return;
            }

            // 清空現有項目
            SalesItems.Clear();

            // 將報價單明細轉換為銷貨項目
            foreach (var quotationDetail in quotationDetails)
            {
                //  關鍵修改：只載入尚未轉單的數量（報價數量 - 已轉數量）
                var pendingQuantity = quotationDetail.Quantity - quotationDetail.ConvertedQuantity;
                
                // 如果該明細已經全部轉完，跳過不載入
                if (pendingQuantity <= 0)
                {
                    continue;
                }
                
                var salesItem = new SalesItem
                {
                    SelectedProduct = quotationDetail.Product,
                    OrderQuantity = pendingQuantity,  // 使用剩餘數量，而非全部數量
                    UnitPrice = quotationDetail.UnitPrice,
                    DiscountPercentage = quotationDetail.DiscountPercentage,
                    TaxRate = quotationDetail.TaxRate ?? quotationDetail.Product?.TaxRate ?? await SystemParameterService.GetTaxRateAsync(),
                    DetailRemarks = quotationDetail.Remarks ?? "",
                    // 設定報價單來源資訊（用於審核檢查和轉單追蹤）
                    SourceQuotationId = quotationId,
                    SourceQuotationDetailId = quotationDetail.Id,
                    IsQuotationApproved = isQuotationApproved
                };
                
                // 🔑 載入報價單明細的 BOM 組成並轉換為銷貨訂單 BOM 組成
                try
                {
                    var quotationCompositions = await QuotationCompositionDetailService.GetByQuotationDetailIdAsync(quotationDetail.Id);
                    
                    if (quotationCompositions?.Any() == true)
                    {
                        // 轉換 QuotationCompositionDetail 為 SalesOrderCompositionDetail
                        salesItem.CustomCompositionDetails = quotationCompositions.Select(qc => new SalesOrderCompositionDetail
                        {
                            ComponentProductId = qc.ComponentProductId,
                            ComponentProduct = qc.ComponentProduct,
                            Quantity = qc.Quantity,
                            UnitId = qc.UnitId,
                            Unit = qc.Unit,
                            ComponentCost = qc.ComponentCost,
                            Remarks = qc.Remarks,
                            Status = qc.Status
                        }).ToList();
                    }
                }
                catch
                {
                    // BOM 載入失敗不影響主流程，僅記錄錯誤
                }
                
                // 初始化 ProductSearchValue
                if (salesItem.SelectedProduct != null)
                {
                    salesItem.ProductSearchValue = FormatProductDisplayText(salesItem.SelectedProduct);
                }
                
                // 計算小計
                salesItem.CalculateSubtotal();
                
                // 載入該商品的可用倉庫位置清單
                if (salesItem.SelectedProduct != null)
                {
                    salesItem.AvailableWarehouseLocations = await InventoryStockService.GetAvailableWarehouseLocationsByProductAsync(salesItem.SelectedProduct.Id);
                }
                
                SalesItems.Add(salesItem);
            }
            
            await NotifyDetailsChanged();
            
            // 計算實際載入的明細數量
            var loadedCount = SalesItems.Count(item => item.SelectedProduct != null);
            if (loadedCount > 0)
            {
                await NotificationService.ShowSuccessAsync($"已載入 {loadedCount} 項未轉完的報價明細", "載入成功");
            }
            else
            {
                await NotificationService.ShowInfoAsync("所有報價明細都已完成轉單，無需再轉單", "提示");
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadQuotationDetails), GetType());
            await NotificationService.ShowErrorAsync("載入報價單明細時發生錯誤", "錯誤");
        }
    }

    /// <summary>
    /// 顯示確認對話框
    /// </summary>
    private async Task<bool> ShowConfirmationAsync(string title, string message)
    {
        // 暫時使用簡單的通知，等待確認後執行
        // 在實際專案中可能會使用更精美的對話框組件
        try 
        {
            await NotificationService.ShowInfoAsync(message, title);
            return true;
        }
        catch
        {
            return false;
        }
    }

    /// <summary>
    /// 驗證銷貨明細
    /// </summary>
    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        // 檢查是否至少有一項非空明細
        if (!SalesItems.Any(item => item.SelectedProduct != null))
        {
            errors.Add("至少需要一項銷貨明細");
        }
        else
        {
            // === 審核檢查 ===
            if (IsApprovalEnabled)
            {
                var unapprovedItems = SalesItems
                    .Where(item => item.SelectedProduct != null &&
                                  item.SourceQuotationId.HasValue &&
                                  !(item.IsQuotationApproved ?? false))
                    .ToList();
                
                if (unapprovedItems.Any())
                {
                    errors.Add($"有 {unapprovedItems.Count} 項明細來自未審核的報價單，無法儲存。請先完成報價單審核。");
                }
            }
            
            var lineNumber = 1;
            foreach (var item in SalesItems.Where(x => x.SelectedProduct != null))
            {
                if (item.SelectedProduct == null)
                {
                    errors.Add($"第 {lineNumber} 行：請選擇商品");
                }

                if (item.OrderQuantity <= 0)
                {
                    errors.Add($"第 {lineNumber} 行：訂單數量必須大於 0");
                }

                if (item.UnitPrice < 0)
                {
                    errors.Add($"第 {lineNumber} 行：單價不可為負數");
                }

                if (item.DiscountPercentage < 0 || item.DiscountPercentage > 100)
                {
                    errors.Add($"第 {lineNumber} 行：折扣比例必須介於 0-100 之間");
                }

                lineNumber++;
            }
        }
          
        if (errors.Any())
        {
            await NotificationService.ShowErrorAsync(string.Join("\n", errors), "銷貨明細驗證失敗");
            return false;
        }
        
        return true;
    }
}
