@* 轉排程確認 Modal - 從銷貨訂單 BOM 轉換為生產排程 *@
@using ERPCore2.Components.Shared.GenericComponent.Button
@using ERPCore2.Data.Entities
@using ERPCore2.Data.Enums
@inject IProductionScheduleService ProductionScheduleService
@inject IProductionScheduleItemService ProductionScheduleItemService
@inject IProductionScheduleDetailService ProductionScheduleDetailService
@inject ISalesOrderDetailService SalesOrderDetailService
@inject IProductService ProductService
@inject IWarehouseService WarehouseService
@inject IEmployeeService EmployeeService
@inject IInventoryStockService InventoryStockService
@inject INotificationService NotificationService

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@GetModalTitle()"
                   Icon="bi bi-calendar-plus"
                   HeaderColor="BaseModalComponent.HeaderVariant.Warning"
                   ShowFooter="false"
                   CloseOnBackdropClick="false"
                   CloseOnEscape="true"
                   IsLoading="@isLoading"
                   LoadingMessage="處理中..."
                   HeaderButtons="@HeaderButtons"
                   BodyContent="@BodyContent" />

@code {
    // ===== 參數定義 =====
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    
    /// <summary>
    /// 來源銷售訂單明細 ID
    /// </summary>
    [Parameter] public int? SalesOrderDetailId { get; set; }
    
    /// <summary>
    /// 來源銷售訂單 ID（用於顯示資訊）
    /// </summary>
    [Parameter] public int? SalesOrderId { get; set; }
    
    /// <summary>
    /// 銷售訂單代碼（用於顯示）
    /// </summary>
    [Parameter] public string? SalesOrderCode { get; set; }
    
    /// <summary>
    /// 商品名稱（用於顯示）
    /// </summary>
    [Parameter] public string? ProductName { get; set; }
    
    /// <summary>
    /// 商品 ID
    /// </summary>
    [Parameter] public int? ProductId { get; set; }
    
    /// <summary>
    /// 訂單數量
    /// </summary>
    [Parameter] public decimal OrderQuantity { get; set; }
    
    /// <summary>
    /// 已排程數量
    /// </summary>
    [Parameter] public decimal ScheduledQuantity { get; set; }
    
    /// <summary>
    /// BOM 組成明細（來自 SalesOrderCompositionDetail）
    /// </summary>
    [Parameter] public List<SalesOrderCompositionDetail>? CompositionDetails { get; set; }
    
    /// <summary>
    /// 轉排程成功的回調
    /// </summary>
    [Parameter] public EventCallback<ProductionSchedule> OnScheduleCreated { get; set; }
    
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== 私有欄位 =====
    private bool isLoading = false;
#pragma warning disable CS0414
    private bool _dataLoadCompleted = true;
#pragma warning restore CS0414
    
    // 排程設定
    private DateTime scheduleDate = DateTime.Today;
    private int? selectedWarehouseId;
    private int? createdByEmployeeId;
    private decimal quantityToSchedule = 0;
    
    // 組件預覽列表（含庫存資訊）
    private List<ComponentPreviewItem> componentPreviews = new();
    
    // 參考資料
    private List<Warehouse> availableWarehouses = new();
    private List<Employee> availableEmployees = new();
    private Dictionary<int, decimal> productStockQuantities = new();

    // ===== 內部類別 =====
    private class ComponentPreviewItem
    {
        public int ComponentProductId { get; set; }
        public string? ComponentName { get; set; }
        public string? ComponentCode { get; set; }
        public decimal QuantityPerUnit { get; set; }
        public decimal TotalQuantity { get; set; }
        public decimal CurrentStock { get; set; }
        public decimal Shortage { get; set; }
        public bool NeedsProduction { get; set; }
        public int? UnitId { get; set; }
        public string? UnitName { get; set; }
    }

    // ===== 計算屬性 =====
    private decimal PendingQuantity => OrderQuantity - ScheduledQuantity;
    private bool CanSubmit => quantityToSchedule > 0 && quantityToSchedule <= PendingQuantity && componentPreviews.Any();

    // ===== 生命週期 =====
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible)
        {
            await LoadDataAsync();
        }
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        _dataLoadCompleted = false;
        StateHasChanged();

        try
        {
            // 載入參考資料
            availableWarehouses = await WarehouseService.GetAllAsync();
            availableEmployees = await EmployeeService.GetAllAsync();
            
            // 設定預設排程數量為待排程數量
            quantityToSchedule = PendingQuantity;
            
            // 載入庫存資訊
            await LoadStockQuantitiesAsync();
            
            // 計算組件預覽
            CalculateComponentPreviews();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入失敗：{ex.Message}");
        }
        finally
        {
            isLoading = false;
            _dataLoadCompleted = true;
            StateHasChanged();
        }
    }

    private async Task LoadStockQuantitiesAsync()
    {
        try
        {
            productStockQuantities.Clear();
            
            if (CompositionDetails == null || !CompositionDetails.Any())
                return;

            var productIds = CompositionDetails.Select(c => c.ComponentProductId).Distinct();
            
            foreach (var productId in productIds)
            {
                var stocks = await InventoryStockService.GetByProductIdAsync(productId);
                var totalStock = stocks.Sum(s => s.TotalAvailableStock);
                productStockQuantities[productId] = totalStock;
            }
        }
        catch
        {
            // 忽略庫存載入錯誤
        }
    }

    private void CalculateComponentPreviews()
    {
        componentPreviews.Clear();
        
        if (CompositionDetails == null || !CompositionDetails.Any())
            return;

        foreach (var detail in CompositionDetails.Where(d => d.ComponentProductId > 0))
        {
            var currentStock = productStockQuantities.GetValueOrDefault(detail.ComponentProductId, 0);
            var totalNeeded = detail.Quantity * quantityToSchedule;
            var shortage = Math.Max(0, totalNeeded - currentStock);
            
            componentPreviews.Add(new ComponentPreviewItem
            {
                ComponentProductId = detail.ComponentProductId,
                ComponentName = detail.ComponentProduct?.Name ?? "未知商品",
                ComponentCode = detail.ComponentProduct?.Code,
                QuantityPerUnit = detail.Quantity,
                TotalQuantity = totalNeeded,
                CurrentStock = currentStock,
                Shortage = shortage,
                NeedsProduction = shortage > 0 && (detail.ComponentProduct?.CanSchedule ?? false),
                UnitId = detail.UnitId,
                UnitName = detail.Unit?.Name
            });
        }
    }

    private void OnQuantityChanged(ChangeEventArgs e)
    {
        if (decimal.TryParse(e.Value?.ToString(), out var value))
        {
            quantityToSchedule = Math.Max(0, Math.Min(value, PendingQuantity));
            CalculateComponentPreviews();
            StateHasChanged();
        }
    }

    private string GetModalTitle()
    {
        return $"轉排程 - {ProductName ?? "商品"}";
    }

    // ===== Header Buttons =====
    private RenderFragment HeaderButtons => __builder =>
    {
        <div class="w-100 d-flex align-items-center px-2">
            <div class="d-flex gap-2 ms-auto">
                <GenericButtonComponent Text="取消"
                                      Variant="ButtonVariant.Gray"
                                      Size="ButtonSize.Small"
                                      OnClick="@HandleCancel" />
                <GenericButtonComponent Text="確認轉排程"
                                      Variant="ButtonVariant.Yellow"
                                      Size="ButtonSize.Small"
                                      IsDisabled="@(!CanSubmit)"
                                      OnClick="@HandleSubmit" />
            </div>
        </div>
    };

    // ===== Body Content =====
    private RenderFragment BodyContent => __builder =>
    {
        <div class="container-fluid">
            @* 來源資訊 *@
            <div class="card mb-3">
                <div class="card-header bg-light py-2">
                    <i class="bi bi-info-circle me-2"></i>來源訂單資訊
                </div>
                <div class="card-body py-2">
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted">訂單單號</small>
                            <div class="fw-bold">@(SalesOrderCode ?? "-")</div>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">商品</small>
                            <div class="fw-bold">@(ProductName ?? "-")</div>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">訂單數量 / 已排程 / 待排程</small>
                            <div>
                                <span class="fw-bold">@OrderQuantity.ToString("N2")</span>
                                <span class="text-muted mx-1">/</span>
                                <span class="text-primary">@ScheduledQuantity.ToString("N2")</span>
                                <span class="text-muted mx-1">/</span>
                                <span class="text-warning fw-bold">@PendingQuantity.ToString("N2")</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @* 排程設定 *@
            <div class="card mb-3">
                <div class="card-header bg-light py-2">
                    <i class="bi bi-gear me-2"></i>排程設定
                </div>
                <div class="card-body py-2">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label small">排程數量 <span class="text-danger">*</span></label>
                            <input type="number" 
                                   class="form-control form-control-sm" 
                                   value="@quantityToSchedule"
                                   min="0.01"
                                   max="@PendingQuantity"
                                   step="0.01"
                                   @onchange="OnQuantityChanged" />
                            <small class="text-muted">最多可排程：@PendingQuantity.ToString("N2")</small>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">排程日期</label>
                            <input type="date" 
                                   class="form-control form-control-sm" 
                                   @bind="scheduleDate" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">入庫倉庫</label>
                            <select class="form-select form-select-sm" @bind="selectedWarehouseId">
                                <option value="">-- 請選擇 --</option>
                                @foreach (var wh in availableWarehouses)
                                {
                                    <option value="@wh.Id">@wh.Name</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">製單人員</label>
                            <select class="form-select form-select-sm" @bind="createdByEmployeeId">
                                <option value="">-- 請選擇 --</option>
                                @foreach (var emp in availableEmployees)
                                {
                                    <option value="@emp.Id">[@emp.Code] @emp.Name</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            @* 組件需求預覽 *@
            <div class="card">
                <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-list-check me-2"></i>組件需求預覽</span>
                    <small class="text-muted">共 @componentPreviews.Count 個組件</small>
                </div>
                <div class="card-body p-0">
                    @if (componentPreviews.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 30%">組件名稱</th>
                                        <th class="text-end" style="width: 12%">單位用量</th>
                                        <th class="text-end" style="width: 12%">總需求</th>
                                        <th class="text-end" style="width: 12%">現有庫存</th>
                                        <th class="text-end" style="width: 12%">缺料</th>
                                        <th class="text-center" style="width: 12%">狀態</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in componentPreviews)
                                    {
                                        <tr>
                                            <td>
                                                <span class="text-muted small">[@(item.ComponentCode ?? "-")]</span>
                                                @item.ComponentName
                                            </td>
                                            <td class="text-end">@item.QuantityPerUnit.ToString("N2")</td>
                                            <td class="text-end fw-bold">@item.TotalQuantity.ToString("N2")</td>
                                            <td class="text-end @(item.CurrentStock >= item.TotalQuantity ? "text-success" : "text-danger")">
                                                @item.CurrentStock.ToString("N2")
                                            </td>
                                            <td class="text-end @(item.Shortage > 0 ? "text-danger fw-bold" : "")">
                                                @(item.Shortage > 0 ? item.Shortage.ToString("N2") : "-")
                                            </td>
                                            <td class="text-center">
                                                @if (item.Shortage <= 0)
                                                {
                                                    <span class="badge bg-success">庫存充足</span>
                                                }
                                                else if (item.NeedsProduction)
                                                {
                                                    <span class="badge bg-warning text-dark">需排程</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-danger">庫存不足</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1"></i>
                            <p class="mt-2">尚無 BOM 組成資料</p>
                        </div>
                    }
                </div>
            </div>
            
            @* 提示訊息 *@
            @if (componentPreviews.Any(c => c.Shortage > 0))
            {
                <div class="alert alert-warning mt-3 mb-0 py-2">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>注意：</strong>部分組件庫存不足。開始生產時將扣除組件庫存（InProductionStock），完成後成品將入庫。
                </div>
            }
        </div>
    };

    // ===== 事件處理 =====
    private async Task HandleSubmit()
    {
        if (!CanSubmit)
            return;

        isLoading = true;
        StateHasChanged();

        try
        {
            // 1. 建立生產排程主檔
            var schedule = new ProductionSchedule
            {
                Code = await EntityCodeGenerationHelper.GenerateForEntity<ProductionSchedule, IProductionScheduleService>(
                    ProductionScheduleService, "PS"),
                ScheduleDate = scheduleDate,
                SalesOrderId = SalesOrderId,
                SourceDocumentType = "SalesOrder",
                SourceDocumentId = SalesOrderId,
                CreatedByEmployeeId = createdByEmployeeId,
                Status = EntityStatus.Active,
                CreatedAt = DateTime.Now
            };

            var scheduleResult = await ProductionScheduleService.CreateAsync(schedule);
            if (!scheduleResult.IsSuccess)
            {
                await NotificationService.ShowErrorAsync($"建立排程失敗：{scheduleResult.ErrorMessage}");
                return;
            }

            // 2. 建立生產排程項目
            var scheduleItem = new ProductionScheduleItem
            {
                ProductionScheduleId = schedule.Id,
                ProductId = ProductId ?? 0,
                SalesOrderDetailId = SalesOrderDetailId,
                ScheduledQuantity = quantityToSchedule,
                CompletedQuantity = 0,
                ProductionItemStatus = ProductionItemStatus.Pending,
                WarehouseId = selectedWarehouseId,
                Status = EntityStatus.Active,
                CreatedAt = DateTime.Now
            };

            var itemResult = await ProductionScheduleItemService.CreateAsync(scheduleItem);
            if (!itemResult.IsSuccess)
            {
                await NotificationService.ShowErrorAsync($"建立排程項目失敗：{itemResult.ErrorMessage}");
                return;
            }

            // 3. 建立生產排程明細（組件需求）
            if (CompositionDetails != null && CompositionDetails.Any())
            {
                var scheduleDetails = CompositionDetails
                    .Where(c => c.ComponentProductId > 0)
                    .Select(c => new ProductionScheduleDetail
                    {
                        ProductionScheduleItemId = scheduleItem.Id,
                        ComponentProductId = c.ComponentProductId,
                        RequiredQuantity = c.Quantity * quantityToSchedule,
                        WarehouseId = selectedWarehouseId,
                        Status = EntityStatus.Active,
                        CreatedAt = DateTime.Now
                    }).ToList();

                var detailsResult = await ProductionScheduleDetailService.CreateDetailsForItemAsync(
                    scheduleItem.Id, scheduleDetails);
                    
                if (!detailsResult.IsSuccess)
                {
                    await NotificationService.ShowWarningAsync($"建立組件明細時發生問題：{detailsResult.ErrorMessage}");
                }
            }

            // 4. 更新銷售訂單明細的已排程數量
            if (SalesOrderDetailId.HasValue)
            {
                var salesOrderDetail = await SalesOrderDetailService.GetByIdAsync(SalesOrderDetailId.Value);
                if (salesOrderDetail != null)
                {
                    salesOrderDetail.ScheduledQuantity += quantityToSchedule;
                    await SalesOrderDetailService.UpdateAsync(salesOrderDetail);
                }
            }

            await NotificationService.ShowSuccessAsync($"成功建立生產排程：{schedule.Code}");

            // 通知父組件
            if (OnScheduleCreated.HasDelegate)
            {
                await OnScheduleCreated.InvokeAsync(schedule);
            }

            await CloseModal();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"轉排程失敗：{ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleCancel()
    {
        if (OnCancel.HasDelegate)
        {
            await OnCancel.InvokeAsync();
        }

        await CloseModal();
    }

    private async Task CloseModal()
    {
        // 重置狀態
        quantityToSchedule = 0;
        selectedWarehouseId = null;
        createdByEmployeeId = null;
        componentPreviews.Clear();
        
        await IsVisibleChanged.InvokeAsync(false);
    }
}
