@* BOM çµ„åˆç·¨è¼¯ Modal - ç·¨è¼¯éŠ·è²¨è¨‚å–®æ˜ç´°çš„ BOM çµ„æˆï¼ˆå®¢è£½åŒ–ï¼‰ *@
@using ERPCore2.Components.Shared.SubCollections
@using ERPCore2.Components.Shared.GenericComponent.Button
@using ERPCore2.Data.Entities
@inject ISalesOrderCompositionDetailService SalesOrderCompositionDetailService
@inject IProductService ProductService
@inject IUnitService UnitService
@inject IInventoryStockService InventoryStockService
@inject INotificationService NotificationService

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@GetModalTitle()"
                   Icon="bi bi-diagram-3"
                   HeaderColor="BaseModalComponent.HeaderVariant.Info"
                   ShowFooter="false"
                   CloseOnBackdropClick="false"
                   CloseOnEscape="true"
                   IsLoading="@isLoading"
                   LoadingMessage="è¼‰å…¥ä¸­..."
                   HeaderButtons="@HeaderButtons"
                   BodyContent="@BodyContent" />

@code {
    // ===== åƒæ•¸å®šç¾© =====
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SalesOrderDetailId { get; set; }
    [Parameter] public string ProductName { get; set; } = string.Empty;
    [Parameter] public int? ProductId { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;
    [Parameter] public EventCallback<List<SalesOrderCompositionDetail>> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public Func<List<SalesOrderCompositionDetail>?>? OnRequestCachedData { get; set; }

    // ===== ç§æœ‰æ¬„ä½ =====
    private bool isLoading = false;
    private bool _dataLoadCompleted = true;
    private List<SalesOrderCompositionDetail> compositionDetails = new();
    private List<ERPCore2.Data.Entities.Product> availableProducts = new();
    private List<ERPCore2.Data.Entities.Unit> availableUnits = new();
    private Dictionary<int, decimal> productStockQuantities = new(); // å•†å“åº«å­˜å¿«å–
    private InteractiveTableComponent<SalesOrderCompositionDetail>? tableComponent;

    // ===== ç”Ÿå‘½é€±æœŸ =====
    protected override async Task OnParametersSetAsync()
    {
        // ğŸ”‘ é‡è¦ï¼šå³ä½¿ SalesOrderDetailId ç‚º nullï¼ˆæ–°å¢æ™‚ï¼‰ï¼Œä¹Ÿè¦å˜—è©¦å¾å¿«å–è¼‰å…¥è³‡æ–™
        // ä¾‹å¦‚ï¼šå ±åƒ¹å–®è½‰éŠ·è²¨è¨‚å–®æ™‚ï¼Œæ˜ç´°é‚„æ²’å„²å­˜ï¼Œä½† BOM è³‡æ–™å·²ç¶“åœ¨è¨˜æ†¶é«”ä¸­
        if (IsVisible)
        {
            await LoadDataAsync();
        }
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        _dataLoadCompleted = false;
        StateHasChanged();

        try
        {
            // è¼‰å…¥å¯ç”¨çš„å•†å“å’Œå–®ä½
            availableProducts = await ProductService.GetAllAsync();
            availableUnits = await UnitService.GetAllAsync();

            // è¼‰å…¥åº«å­˜è³‡è¨Šï¼ˆç”¨æ–¼é¡¯ç¤ºåº«å­˜ç‹€æ…‹ï¼‰
            await LoadStockQuantitiesAsync();

            // å„ªå…ˆå¾çˆ¶çµ„ä»¶çš„å¿«å–è¼‰å…¥ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            if (OnRequestCachedData != null)
            {
                var cachedData = OnRequestCachedData();
                
                if (cachedData?.Any() == true)
                {
                    compositionDetails = cachedData;
                    
                    // æ‰‹å‹•å¡«å……å°èˆªå±¬æ€§
                    foreach (var detail in compositionDetails)
                    {
                        if (detail.ComponentProductId > 0 && detail.ComponentProduct == null)
                        {
                            detail.ComponentProduct = availableProducts.FirstOrDefault(p => p.Id == detail.ComponentProductId)!;
                        }
                        if (detail.UnitId.HasValue && detail.Unit == null)
                        {
                            detail.Unit = availableUnits.FirstOrDefault(u => u.Id == detail.UnitId.Value);
                        }
                    }
                    
                    return;
                }
            }

            // ğŸ”‘ é—œéµä¿®æ­£ï¼šåªæœ‰åœ¨æœ‰ SalesOrderDetailId æ™‚æ‰å¾è³‡æ–™åº«è¼‰å…¥
            // å¦‚æœæ˜¯æ–°å¢ï¼ˆSalesOrderDetailId ç‚º nullï¼‰ï¼Œå‰‡ä¸åŸ·è¡Œè³‡æ–™åº«æŸ¥è©¢ï¼Œé¿å…è¦†è“‹å¿«å–
            if (SalesOrderDetailId.HasValue && SalesOrderDetailId.Value > 0)
            {
                var existingDetails = await SalesOrderCompositionDetailService.GetBySalesOrderDetailIdAsync(SalesOrderDetailId.Value);

                if (existingDetails.Any())
                {
                    // å·²æœ‰å„²å­˜çš„çµ„åˆæ˜ç´°ï¼ˆå¾è³‡æ–™åº«è¼‰å…¥ï¼‰
                    compositionDetails = existingDetails;
                }
                else if (ProductId.HasValue)
                {
                    // è³‡æ–™åº«æ²’æœ‰è³‡æ–™ï¼Œä½†æœ‰ç”¢å“ IDï¼Œå¾ç”¢å“åˆæˆè¡¨è¤‡è£½é è¨­ BOM
                    // âš ï¸ æ³¨æ„ï¼šé€™è£¡ä¸æœƒè¦†è“‹å¿«å–è³‡æ–™ï¼Œå› ç‚ºå¿«å–æª¢æŸ¥åœ¨å‰é¢å·²ç¶“ return äº†
                    compositionDetails = await SalesOrderCompositionDetailService.CopyFromProductCompositionAsync(
                        SalesOrderDetailId.Value,
                        ProductId.Value
                    );
                    
                    // æ‰‹å‹•å¡«å……å°èˆªå±¬æ€§
                    foreach (var detail in compositionDetails)
                    {
                        if (detail.ComponentProductId > 0 && detail.ComponentProduct == null)
                        {
                            detail.ComponentProduct = availableProducts.FirstOrDefault(p => p.Id == detail.ComponentProductId)!;
                        }
                        if (detail.UnitId.HasValue && detail.Unit == null)
                        {
                            detail.Unit = availableUnits.FirstOrDefault(u => u.Id == detail.UnitId.Value);
                        }
                    }
                }
                else
                {
                    compositionDetails = new List<SalesOrderCompositionDetail>();
                }
            }
            else
            {
                // æ–°å¢æ¨¡å¼ï¼ˆæ²’æœ‰ SalesOrderDetailIdï¼‰ï¼Œä½†ä¹Ÿæ²’æœ‰å¿«å–è³‡æ–™
                // åªæœ‰åœ¨æœ‰ ProductId æ™‚æ‰å¾é è¨­ BOM è¤‡è£½
                if (ProductId.HasValue)
                {
                    compositionDetails = await SalesOrderCompositionDetailService.CopyFromProductCompositionAsync(
                        0, // æš«æ™‚ç”¨ 0ï¼Œå„²å­˜æ™‚æœƒè¨­å®šæ­£ç¢ºçš„ ID
                        ProductId.Value
                    );
                    
                    // æ‰‹å‹•å¡«å……å°èˆªå±¬æ€§
                    foreach (var detail in compositionDetails)
                    {
                        if (detail.ComponentProductId > 0 && detail.ComponentProduct == null)
                        {
                            detail.ComponentProduct = availableProducts.FirstOrDefault(p => p.Id == detail.ComponentProductId)!;
                        }
                        if (detail.UnitId.HasValue && detail.Unit == null)
                        {
                        }
                    }
                }
                else
                {
                    compositionDetails = new List<SalesOrderCompositionDetail>();
                }
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å¤±æ•—ï¼š{ex.Message}");
            compositionDetails = new List<SalesOrderCompositionDetail>();
        }
        finally
        {
            isLoading = false;
            _dataLoadCompleted = true;
            StateHasChanged();
        }
    }

    /// <summary>
    /// è¼‰å…¥æ‰€æœ‰å•†å“çš„åº«å­˜æ•¸é‡ï¼ˆç”¨æ–¼é¡¯ç¤ºå’Œæ’ç¨‹åˆ¤æ–·ï¼‰
    /// </summary>
    private async Task LoadStockQuantitiesAsync()
    {
        try
        {
            productStockQuantities.Clear();
            
            foreach (var product in availableProducts)
            {
                // å–å¾—è©²ç”¢å“åœ¨æ‰€æœ‰å€‰åº«çš„åº«å­˜ä¸¦åŠ ç¸½
                var stocks = await InventoryStockService.GetByProductIdAsync(product.Id);
                var totalStock = stocks.Sum(s => s.TotalCurrentStock);
                productStockQuantities[product.Id] = totalStock;
            }
        }
        catch
        {
        }
    }

    private string GetModalTitle()
    {
        return string.IsNullOrEmpty(ProductName) 
            ? "ç·¨è¼¯ BOM çµ„æˆ" 
            : $"ç·¨è¼¯ BOM çµ„æˆ - {ProductName}";
    }

    // ===== Header Buttons =====
    private RenderFragment HeaderButtons => __builder =>
    {
        <div class="w-100 d-flex align-items-center px-2">
            <div class="d-flex gap-2 ms-auto">
                @if (!IsReadOnly)
                {
                    <GenericButtonComponent Text="å„²å­˜"
                                          Variant="ButtonVariant.Green"
                                          Size="ButtonSize.Small"
                                          OnClick="@HandleSave" />
                }
            </div>
        </div>
    };

    // ===== Body Content =====
    private RenderFragment BodyContent => __builder =>
    {
        <div class="container-fluid">
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="SalesOrderCompositionDetail"
                                      Items="@compositionDetails"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"
                                      ShowHeader="true"
                                      ShowActions="false"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="true"
                                      OnItemDelete="@HandleItemDelete"
                                      EnableAutoEmptyRow="true"
                                      CreateEmptyItem="@CreateEmptyItem"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      IsStriped="true"
                                      IsHoverable="true"
                                      IsBordered="true"
                                      EmptyMessage="å°šæœªæ–°å¢çµ„ä»¶" />
        </div>
    };

    // ===== InteractiveTable é…ç½® =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // çµ„ä»¶ç”¢å“ï¼ˆåŠ å…¥åº«å­˜è³‡è¨Šï¼‰
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å“é …",
            PropertyName = "ComponentProductId",
            EmptyCheckPropertyName = "ComponentProduct",
            ColumnType = InteractiveColumnType.Select,
            Width = "35%",
            Options = availableProducts.Select(p => new InteractiveSelectOption
            {
                Value = p.Id,
                Text = GetProductDisplayText(p)
            }).ToList(),
            TriggerEmptyRowOnFilled = true,
            OnSelectionChanged = EventCallback.Factory.Create<(object, object?)>(this, (args) =>
            {
                var (item, value) = args;
                if (item is SalesOrderCompositionDetail detail && value != null)
                {
                    var productId = Convert.ToInt32(value);
                    var product = availableProducts.FirstOrDefault(p => p.Id == productId);
                    
                    if (product != null)
                    {
                        detail.ComponentProduct = product;
                        detail.UnitId = product.UnitId;
                        
                        if (detail.Quantity == 0)
                        {
                            detail.Quantity = 1;
                        }
                        
                        StateHasChanged();
                    }
                }
            })
        });

        // æ•¸é‡
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "æ•¸é‡",
            PropertyName = "Quantity",
            ColumnType = InteractiveColumnType.Number,
            Width = "13%",
            MinValue = 0.01m,
            NumberFormat = "N2",
            TextAlign = "right",
            ExcludeFromEmptyCheck = true
        });

        // å–®ä½
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å–®ä½",
            PropertyName = "UnitId",
            ColumnType = InteractiveColumnType.Select,
            Width = "12%",
            Options = availableUnits.Select(u => new InteractiveSelectOption
            {
                Value = u.Id,
                Text = u.Name
            }).ToList()
        });

        // åº«å­˜ç‹€æ…‹ï¼ˆå”¯è®€ï¼Œé¡¯ç¤ºç”¨ï¼‰
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "åº«å­˜",
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "15%",
            CustomTemplate = item =>
            {
                var detail = (SalesOrderCompositionDetail)item;
                if (detail.ComponentProduct == null)
                    return @<span class="text-muted">-</span>;
                
                var stockQty = productStockQuantities.GetValueOrDefault(detail.ComponentProductId, 0);
                var isEnough = stockQty >= detail.Quantity;
                var canSchedule = detail.ComponentProduct.CanSchedule;
                
                return @<div class="d-flex align-items-center gap-2">
                    <span class="@(isEnough ? "text-success" : "text-danger") fw-bold">
                        @stockQty.ToString("N0")
                    </span>
                    @if (canSchedule && !isEnough)
                    {
                        <span class="badge bg-warning text-dark" style="font-size: 0.65rem" title="åº«å­˜ä¸è¶³ï¼Œéœ€è¦æ’ç¨‹ç”Ÿç”¢">
                            <i class="bi bi-calendar-event"></i>
                        </span>
                    }
                </div>;
            }
        });

        // çµ„ä»¶æˆæœ¬
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "çµ„ä»¶æˆæœ¬",
            PropertyName = "ComponentCost",
            ColumnType = InteractiveColumnType.Number,
            Width = "13%",
            NumberFormat = "N2",
            TextAlign = "right"
        });

        // å‚™è¨»
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å‚™è¨»",
            PropertyName = "Remarks",
            ColumnType = InteractiveColumnType.Input,
            Width = "12%"
        });

        return columns;
    }

    /// <summary>
    /// å–å¾—å•†å“é¡¯ç¤ºæ–‡å­—ï¼ˆåŒ…å«åº«å­˜æç¤ºï¼‰
    /// </summary>
    private string GetProductDisplayText(Product product)
    {
        var stockQty = productStockQuantities.GetValueOrDefault(product.Id, 0);
        return $"[{product.Code}] {product.Name} (åº«å­˜: {stockQty:N0})";
    }

    private SalesOrderCompositionDetail CreateEmptyItem()
    {
        return new SalesOrderCompositionDetail
        {
            SalesOrderDetailId = SalesOrderDetailId ?? 0
        };
    }

    // ===== äº‹ä»¶è™•ç† =====
    private void HandleItemDelete(SalesOrderCompositionDetail item)
    {
        compositionDetails.Remove(item);
        StateHasChanged();
    }

    private async Task HandleSave()
    {
        try
        {
            // éæ¿¾æ‰ç©ºè¡Œï¼ˆæ²’æœ‰é¸æ“‡çµ„ä»¶çš„ï¼‰
            var validDetails = compositionDetails
                .Where(x => x.ComponentProductId > 0 && x.Quantity > 0)
                .ToList();

            // æª¢æŸ¥æ˜¯å¦è‡³å°‘æœ‰ä¸€å€‹æ˜ç´°
            if (!validDetails.Any())
            {
                await NotificationService.ShowWarningAsync("è«‹è‡³å°‘æ–°å¢ä¸€å€‹çµ„ä»¶æ˜ç´°");
                return;
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡çš„çµ„ä»¶
            var duplicates = validDetails
                .GroupBy(x => x.ComponentProductId)
                .Where(g => g.Count() > 1)
                .Select(g => g.First().ComponentProduct?.Name)
                .ToList();

            if (duplicates.Any())
            {
                await NotificationService.ShowWarningAsync($"çµ„ä»¶é‡è¤‡ï¼š{string.Join("ã€", duplicates)}");
                return;
            }

            // æª¢æŸ¥åº«å­˜ä¸è¶³çš„çµ„ä»¶ï¼ˆåƒ…æç¤ºï¼Œä¸é˜»æ­¢å„²å­˜ï¼‰
            var insufficientStockItems = validDetails
                .Where(d => d.ComponentProduct != null &&
                           productStockQuantities.GetValueOrDefault(d.ComponentProductId, 0) < d.Quantity)
                .Select(d => d.ComponentProduct!.Name)
                .ToList();

            if (insufficientStockItems.Any())
            {
                var message = $"ä»¥ä¸‹çµ„ä»¶åº«å­˜ä¸è¶³ï¼š{string.Join("ã€", insufficientStockItems)}ã€‚\n" +
                             "ç³»çµ±å°‡è‡ªå‹•æ¨™è¨˜éœ€è¦æ’ç¨‹ç”Ÿç”¢ã€‚";
                await NotificationService.ShowWarningAsync(message);
            }

            // å„²å­˜
            if (OnSave.HasDelegate)
            {
                await OnSave.InvokeAsync(validDetails);
            }

            await CloseModal();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å„²å­˜å¤±æ•—ï¼š{ex.Message}");
        }
    }

    private async Task HandleCancel()
    {
        if (OnCancel.HasDelegate)
        {
            await OnCancel.InvokeAsync();
        }

        await CloseModal();
    }

    private async Task CloseModal()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }
}
