@* 
    批次列印篩選 Modal 組件（重構版）
    提供統一的框架，所有篩選內容由父組件透過 ChildContent 提供
    操作按鈕位於 Header，符合 Index 頁面設計慣例
*@
@using ERPCore2.Components.Shared.Buttons
@using ERPCore2.Components.Shared.Modals
@inject INotificationService NotificationService

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@Title"
                   Icon="bi-printer"
                   Size="BaseModalComponent.ModalSize.ExtraLarge"
                   HeaderColor="BaseModalComponent.HeaderVariant.ProjectPrimary"
                   UseWhiteCloseButton="true"
                   BodyCssClass="p-4"
                   OnClose="@HandleCancel">
    
    <HeaderButtons>
        @* 按鈕組 *@
        <div class="d-flex gap-2">
            <GenericButtonComponent Variant="ButtonVariant.Primary" 
                                  Size="ButtonSize.Small"
                                  Text="@ConfirmButtonText" 
                                  OnClick="HandleConfirm"
                                  Title="確認並執行列印" />
            <GenericButtonComponent Variant="ButtonVariant.Danger" 
                                  Size="ButtonSize.Small"
                                  Text="@CancelButtonText" 
                                  OnClick="HandleCancel"
                                  Title="取消並關閉" />
        </div>
    </HeaderButtons>
    
    <BodyContent>
        @if (ChildContent != null)
        {
            @ChildContent
        }
        else
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                尚未設定篩選條件
            </div>
        }
    </BodyContent>
    
</BaseModalComponent>

@code {
    // ===== 參數定義 =====
    
    /// <summary>
    /// Modal 是否顯示
    /// </summary>
    [Parameter]
    public bool IsVisible { get; set; }
    
    /// <summary>
    /// Modal 顯示狀態變更事件
    /// </summary>
    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }
    
    /// <summary>
    /// Modal 標題
    /// </summary>
    [Parameter]
    public string Title { get; set; } = "批次列印條件";
    
    /// <summary>
    /// 確認按鈕文字
    /// </summary>
    [Parameter]
    public string ConfirmButtonText { get; set; } = "列印";
    
    /// <summary>
    /// 取消按鈕文字
    /// </summary>
    [Parameter]
    public string CancelButtonText { get; set; } = "取消";
    
    /// <summary>
    /// 確認事件
    /// </summary>
    [Parameter]
    public EventCallback OnConfirm { get; set; }
    
    /// <summary>
    /// 取消事件
    /// </summary>
    [Parameter]
    public EventCallback OnCancel { get; set; }

    /// <summary>
    /// 子內容（由父組件提供所有篩選條件）
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }
    
    // ===== 事件處理方法 =====

    /// <summary>
    /// 處理確認按鈕點擊
    /// </summary>
    private async Task HandleConfirm()
    {
        try
        {
            if (OnConfirm.HasDelegate)
            {
                await OnConfirm.InvokeAsync();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"確認列印時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 處理取消按鈕點擊
    /// </summary>
    private async Task HandleCancel()
    {
        try
        {
            if (IsVisibleChanged.HasDelegate)
            {
                await IsVisibleChanged.InvokeAsync(false);
            }
            
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"取消操作時發生錯誤：{ex.Message}");
        }
    }
}
