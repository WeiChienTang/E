@* é ˜è²¨æ˜ç´°ç®¡ç†çµ„ä»¶ - ä½¿ç”¨æ¢ç¢¼æƒæå’Œ InteractiveTableComponent *@

@inject IProductService ProductService
@inject IInventoryStockService InventoryStockService
@inject INotificationService NotificationService

@using ERPCore2.Data.Entities
@using ERPCore2.Helpers
@using ERPCore2.Components.Shared.SubCollections

<div class="material-issue-detail-manager">
    <!-- æ¢ç¢¼æƒæå€ -->
    <div class="card mb-3 border-0 shadow-sm">
        <div class="card-body">
            <div class="row g-3">
                <!-- æ¢ç¢¼è¼¸å…¥æ¬„ä½ -->
                <div class="col-md-12">
                    <label class="form-label">
                        <i class="bi bi-upc-scan me-2"></i>æ¢ç¢¼æƒæ
                    </label>
                    <input type="text" 
                           class="form-control form-control" 
                           placeholder="è«‹æƒææˆ–è¼¸å…¥å•†å“æ¢ç¢¼ï¼ŒæŒ‰ Enter æ–°å¢..."
                           @bind="barcodeInput"
                           @bind:event="oninput"
                           @onkeydown="HandleBarcodeKeyDown"
                           @ref="barcodeInputElement"
                           disabled="@IsReadOnly" />
                    <small class="text-muted">æƒææ¢ç¢¼å¾ŒæŒ‰ Enter è‡ªå‹•æ–°å¢å•†å“ï¼Œæˆ–ç›´æ¥åœ¨ä¸‹æ–¹è¡¨æ ¼æ‰‹å‹•è¼¸å…¥</small>
                </div>
            </div>
        </div>
    </div>

    <!-- æ˜ç´°è¡¨æ ¼ -->
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent @ref="tableComponent"
                                     TItem="DetailItem"
                                     Items="@DetailItems"
                                     ColumnDefinitions="@GetColumnDefinitions()"
                                     IsReadOnly="@IsReadOnly"
                                     ShowRowNumbers="true"
                                     EmptyMessage="å°šæœªæ–°å¢å•†å“"
                                     ShowBuiltInActions="true"
                                     ShowBuiltInDeleteButton="false"
                                     ActionsColumnWidth="80px"
                                     CustomActionsTemplate="@GetCustomActionsTemplate"
                                     EnableAutoEmptyRow="true"
                                     DataLoadCompleted="@_dataLoadCompleted"
                                     CreateEmptyItem="@CreateEmptyItem" />
        </div>
    </div>
</div>

@code {
    // ===== InteractiveTableComponent åƒè€ƒ =====
    private InteractiveTableComponent<DetailItem>? tableComponent;
    
    // ===== è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜ =====
    private bool _dataLoadCompleted = true;  // è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜
    
    // ===== åƒæ•¸ =====
    [Parameter] public List<MaterialIssueDetail> Details { get; set; } = new();
    [Parameter] public EventCallback<List<MaterialIssueDetail>> DetailsChanged { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;

    // ===== ç§æœ‰æ¬„ä½ =====
    private ElementReference barcodeInputElement;
    private string barcodeInput = string.Empty;
    
    private List<Product> allProducts = new();
    
    private List<DetailItem> DetailItems = new();

    // ===== å…§éƒ¨ Item é¡åˆ¥ =====
    private class DetailItem
    {
        public int? ProductId { get; set; }
        public Product? SelectedProduct { get; set; }
        public int? WarehouseId { get; set; }
        public int? WarehouseLocationId { get; set; }
        public int? InventoryStockDetailId { get; set; } // æ–°å¢ï¼šåº«å­˜æ˜ç´°ID
        public int IssueQuantity { get; set; }
        public decimal UnitCost { get; set; }
        public int? AvailableStock { get; set; }
        
        // SearchableSelect æ”¯æ´å±¬æ€§
        public string ProductSearchValue { get; set; } = string.Empty;
        public List<Product> FilteredProducts { get; set; } = new();
        public bool ShowProductDropdown { get; set; }
        public int ProductSelectedIndex { get; set; } = -1;
        
        // å€‰åº«åº«ä½çµ„åˆé¸é …
        public List<InventoryStockDetail> AvailableWarehouseLocations { get; set; } = new();
    }

    // ===== ç”Ÿå‘½é€±æœŸæ–¹æ³• =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadRelatedDataAsync();
            await LoadExistingDetailsAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(OnInitializedAsync), GetType(), 
                additionalData: "åˆå§‹åŒ–é ˜è²¨æ˜ç´°ç®¡ç†å™¨å¤±æ•—");
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–æ˜ç´°ç®¡ç†å™¨å¤±æ•—");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await barcodeInputElement.FocusAsync();
            }
            catch
            {
                // å¿½ç•¥ Focus å¤±æ•—
            }
        }
    }

    // ===== è³‡æ–™è¼‰å…¥æ–¹æ³• =====

    private async Task LoadRelatedDataAsync()
    {
        try
        {
            allProducts = await ProductService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadRelatedDataAsync), GetType(), 
                additionalData: "è¼‰å…¥ç›¸é—œè³‡æ–™å¤±æ•—");
            await NotificationService.ShowErrorAsync("è¼‰å…¥ç›¸é—œè³‡æ–™å¤±æ•—");
            
            allProducts = new List<Product>();
        }
    }

    /// <summary>
    /// å…¬é–‹çš„åˆ·æ–°æ–¹æ³•ï¼Œç”¨æ–¼å¤–éƒ¨è§¸ç™¼æ˜ç´°åˆ·æ–°ï¼ˆä¾‹å¦‚ï¼šä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼‰
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadExistingDetailsAsync();
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }
    
    private async Task LoadExistingDetailsAsync()
    {
        try
        {
            // ğŸ”‘ é–‹å§‹è¼‰å…¥è³‡æ–™
            _dataLoadCompleted = false;
            
            DetailItems.Clear();
            
            foreach (var detail in Details)
            {
                var product = allProducts.FirstOrDefault(p => p.Id == detail.ProductId);
                
                var item = new DetailItem
                {
                    ProductId = detail.ProductId,
                    SelectedProduct = product,
                    WarehouseId = detail.WarehouseId,
                    WarehouseLocationId = detail.WarehouseLocationId,
                    IssueQuantity = detail.IssueQuantity,
                    UnitCost = detail.UnitCost ?? 0m,
                    ProductSearchValue = product != null ? $"[{product.Code}] {product.Name}" : ""
                };

                // è¼‰å…¥è©²å•†å“çš„å¯ç”¨å€‰åº«ä½ç½®æ¸…å–®
                if (item.ProductId.HasValue)
                {
                    item.AvailableWarehouseLocations = await InventoryStockService.GetAvailableWarehouseLocationsByProductAsync(item.ProductId.Value);
                    
                    // æ‰¾åˆ°å°æ‡‰çš„åº«å­˜æ˜ç´°ID
                    if (item.WarehouseId.HasValue)
                    {
                        var stockDetail = item.AvailableWarehouseLocations.FirstOrDefault(d => 
                            d.WarehouseId == item.WarehouseId.Value && 
                            d.WarehouseLocationId == item.WarehouseLocationId);
                        
                        if (stockDetail != null)
                        {
                            item.InventoryStockDetailId = stockDetail.Id;
                            item.AvailableStock = stockDetail.AvailableStock;
                        }
                    }
                }

                DetailItems.Add(item);
            }
            
            // ğŸ”‘ è³‡æ–™è¼‰å…¥å®Œæˆ
            _dataLoadCompleted = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _dataLoadCompleted = true;  // é€™è£¡ä¹Ÿè¦è¨­ç‚º true
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadExistingDetailsAsync), GetType(), 
                additionalData: "è¼‰å…¥ç¾æœ‰æ˜ç´°å¤±æ•—");
            DetailItems = new List<DetailItem>();
        }
    }

    // ===== InteractiveTableComponent æ¬„ä½å®šç¾© =====

    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // å•†å“æ¬„ä½ - ä½¿ç”¨ SearchableSelect
        columns.Add(new()
        {
            Title = "å•†å“",
            PropertyName = "ProductId",
            EmptyCheckPropertyName = "SelectedProduct",
            TriggerEmptyRowOnFilled = true,
            ColumnType = InteractiveColumnType.SearchableSelect,
            Width = "250px",
            Tooltip = "æœå°‹ä¸¦é¸æ“‡å•†å“",
            Placeholder = "è«‹è¼¸å…¥å•†å“ç·¨è™Ÿæˆ–åç¨±",
            SearchValuePropertyName = nameof(DetailItem.ProductSearchValue),
            FilteredItemsPropertyName = nameof(DetailItem.FilteredProducts),
            ShowDropdownPropertyName = nameof(DetailItem.ShowProductDropdown),
            SelectedIndexPropertyName = nameof(DetailItem.ProductSelectedIndex),
            ItemDisplayFormatter = (item) =>
            {
                var product = (Product)item;
                return $"[{product.Code}] {product.Name}";
            },
            OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, (tuple) =>
            {
                var (item, searchValue) = tuple;
                OnProductSearchChanged((DetailItem)item, searchValue);
            }),
            OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
            {
                var (item, selectedItem) = tuple;
                await OnProductSelected((DetailItem)item, (Product?)selectedItem);
            }),
            OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
            {
                var detailItem = (DetailItem)item;
                detailItem.FilteredProducts = allProducts.Take(20).ToList();
                detailItem.ShowProductDropdown = true;
                detailItem.ProductSelectedIndex = -1;
                StateHasChanged();
            }),
            OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
            {
                Task.Delay(200).ContinueWith(_ =>
                {
                    var detailItem = (DetailItem)item;
                    detailItem.ShowProductDropdown = false;
                    InvokeAsync(StateHasChanged);
                });
            }),
            EnableKeyboardNavigation = true,
            GetDropdownItems = (item) => ((DetailItem)item).FilteredProducts,
            GetShowDropdown = (item) => ((DetailItem)item).ShowProductDropdown,
            GetSelectedIndex = (item) => ((DetailItem)item).ProductSelectedIndex,
            SetSelectedIndex = (item, index) => ((DetailItem)item).ProductSelectedIndex = index,
            SetShowDropdown = (item, show) => ((DetailItem)item).ShowProductDropdown = show
        });

        // å€‰åº« - åº«ä½æ¬„ä½ï¼ˆåˆä½µé¡¯ç¤ºï¼‰
        columns.Add(new()
        {
            Title = "å€‰åº« - åº«ä½",
            PropertyName = "InventoryStockDetailId",
            ColumnType = InteractiveColumnType.Custom,
            Width = "200px",
            Tooltip = "é¸æ“‡å€‰åº«å’Œåº«ä½ï¼ˆåƒ…é¡¯ç¤ºæœ‰åº«å­˜çš„ä½ç½®ï¼‰",
            CustomTemplate = item =>
            {
                var detailItem = (DetailItem)item;
                var selectedValue = detailItem.InventoryStockDetailId?.ToString() ?? "";
                var isDisabled = IsReadOnly || !detailItem.ProductId.HasValue || !detailItem.AvailableWarehouseLocations.Any();

                return @<select class="form-select form-select-sm"
                                value="@selectedValue"
                                disabled="@isDisabled"
                                @onchange="@(async (e) => await OnWarehouseLocationChanged(detailItem, e.Value))">
                    <option value="">è«‹é¸æ“‡</option>
                    @foreach (var stockDetail in detailItem.AvailableWarehouseLocations)
                    {
                        var warehouseName = stockDetail.Warehouse?.Name ?? "æœªçŸ¥å€‰åº«";
                        var locationName = stockDetail.WarehouseLocation?.Name ?? "é è¨­ä½ç½®";
                        var displayText = $"{warehouseName} - {locationName}";
                        <option value="@stockDetail.Id">@displayText</option>
                    }
                </select>;
            }
        });

        // å¯ç”¨åº«å­˜æ¬„ä½
        columns.Add(new()
        {
            Title = "å¯ç”¨åº«å­˜",
            PropertyName = "AvailableStock",
            ColumnType = InteractiveColumnType.Display,
            Width = "100px",
            Tooltip = "ç•¶å‰å¯ç”¨åº«å­˜æ•¸é‡",
            DisplayFormatter = (value) =>
            {
                if (value == null) return "<span class='badge bg-secondary'>-</span>";
                var qty = (int)value;
                var badgeClass = qty == 0 ? "bg-danger" : qty < 10 ? "bg-warning" : "bg-success";
                return $"<span class='badge {badgeClass}'>{qty}</span>";
            }
        });

        // é ˜è²¨æ•¸é‡æ¬„ä½
        columns.Add(new()
        {
            Title = "é ˜è²¨æ•¸é‡",
            PropertyName = "IssueQuantity",
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            Tooltip = "è¼¸å…¥é ˜è²¨æ•¸é‡",
            MinValue = 1,
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnIssueQuantityChanged((DetailItem)item, valueString);
            })
        });

        return columns;
    }

    // ===== äº‹ä»¶è™•ç†æ–¹æ³• =====

    private async Task HandleBarcodeKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await HandleBarcodeScanned();
        }
    }

    private async Task HandleBarcodeScanned()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(barcodeInput))
            {
                await NotificationService.ShowWarningAsync("è«‹è¼¸å…¥æ¢ç¢¼");
                return;
            }

            var product = await ProductService.GetByBarcodeAsync(barcodeInput.Trim());
            
            if (product == null)
            {
                await NotificationService.ShowWarningAsync($"æ‰¾ä¸åˆ°æ¢ç¢¼ {barcodeInput} çš„å•†å“");
                barcodeInput = string.Empty;
                return;
            }

            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (DetailItems.Any(item => item.ProductId == product.Id))
            {
                await NotificationService.ShowWarningAsync($"å•†å“ {product.Name} å·²å­˜åœ¨æ˜ç´°ä¸­");
                barcodeInput = string.Empty;
                return;
            }

            // è¼‰å…¥å¯ç”¨å€‰åº«ä½ç½®
            var availableLocations = await InventoryStockService.GetAvailableWarehouseLocationsByProductAsync(product.Id);

            // å»ºç«‹æ–°æ˜ç´°é …ç›®
            var newItem = new DetailItem
            {
                ProductId = product.Id,
                SelectedProduct = product,
                ProductSearchValue = $"[{product.Code}] {product.Name}",
                IssueQuantity = 0, // é è¨­ç‚º0ï¼ˆç©ºç™½ï¼‰
                UnitCost = 0m, // Product å¯¦é«”ä¸­æ²’æœ‰ Cost å±¬æ€§,é è¨­ç‚º 0
                AvailableWarehouseLocations = availableLocations
            };

            // å°‡æ–°é …ç›®åŠ åˆ°åˆ—è¡¨
            DetailItems.Add(newItem);
            
            await SyncToDetails();
            await NotificationService.ShowSuccessAsync($"å·²æ–°å¢å•†å“: {product.Name}");
            
            barcodeInput = string.Empty;
            await barcodeInputElement.FocusAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleBarcodeScanned), GetType(), 
                additionalData: $"è™•ç†æ¢ç¢¼æƒæå¤±æ•— - æ¢ç¢¼: {barcodeInput}");
            await NotificationService.ShowErrorAsync("è™•ç†æ¢ç¢¼æƒæå¤±æ•—");
            barcodeInput = string.Empty;
        }
    }

    private void OnProductSearchChanged(DetailItem item, string? searchValue)
    {
        item.ProductSearchValue = searchValue ?? "";
        
        if (string.IsNullOrWhiteSpace(searchValue))
        {
            item.FilteredProducts = allProducts.Take(20).ToList();
        }
        else
        {
            var search = searchValue.ToLower();
            item.FilteredProducts = allProducts
                .Where(p => (p.Code?.ToLower().Contains(search) ?? false) || 
                           (p.Name?.ToLower().Contains(search) ?? false) ||
                           (p.Barcode?.ToLower().Contains(search) ?? false))
                .Take(20)
                .ToList();
        }
        
        item.ShowProductDropdown = true;
        item.ProductSelectedIndex = -1;
        
        StateHasChanged();
    }

    private async Task OnProductSelected(DetailItem item, Product? product)
    {
        if (product == null) return;

        item.ProductId = product.Id;
        item.SelectedProduct = product;
        item.ProductSearchValue = $"[{product.Code}] {product.Name}";
        item.ShowProductDropdown = false;
        item.UnitCost = 0m; // Product å¯¦é«”ä¸­æ²’æœ‰ Cost å±¬æ€§,é è¨­ç‚º 0
        
        // è¼‰å…¥è©²å•†å“çš„å¯ç”¨å€‰åº«ä½ç½®æ¸…å–®
        item.AvailableWarehouseLocations = await InventoryStockService.GetAvailableWarehouseLocationsByProductAsync(product.Id);
        
        // é‡ç½®é¸æ“‡
        item.InventoryStockDetailId = null;
        item.WarehouseId = null;
        item.WarehouseLocationId = null;
        item.AvailableStock = null;
        
        await SyncToDetails();
        StateHasChanged();
    }

    private async Task OnWarehouseLocationChanged(DetailItem item, object? value)
    {
        if (value == null || !int.TryParse(value.ToString(), out int detailId))
        {
            item.InventoryStockDetailId = null;
            item.WarehouseId = null;
            item.WarehouseLocationId = null;
            item.AvailableStock = null;
        }
        else
        {
            item.InventoryStockDetailId = detailId;
            
            // å¾å¯ç”¨ä½ç½®æ¸…å–®ä¸­æ‰¾åˆ°å°æ‡‰çš„æ˜ç´°
            var selectedDetail = item.AvailableWarehouseLocations.FirstOrDefault(d => d.Id == detailId);
            if (selectedDetail != null)
            {
                item.WarehouseId = selectedDetail.WarehouseId;
                item.WarehouseLocationId = selectedDetail.WarehouseLocationId;
                item.AvailableStock = selectedDetail.AvailableStock;
            }
        }
        
        await SyncToDetails();
        StateHasChanged();
    }

    private async Task OnIssueQuantityChanged(DetailItem item, object? value)
    {
        if (string.IsNullOrWhiteSpace(value?.ToString()))
        {
            item.IssueQuantity = 0;
        }
        else if (int.TryParse(value?.ToString(), out int quantity))
        {
            item.IssueQuantity = quantity;
        }
        
        await SyncToDetails();
        StateHasChanged();
    }

    private async Task HandleItemDelete(DetailItem item)
    {
        try
        {
            if (IsReadOnly) return;
            
            DetailItems.Remove(item);
            
            await SyncToDetails();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleItemDelete), GetType(), 
                additionalData: "åˆªé™¤æ˜ç´°å¤±æ•—");
            await NotificationService.ShowErrorAsync("åˆªé™¤æ˜ç´°å¤±æ•—");
        }
    }

    // ===== å»ºç«‹ç©ºé …ç›®æ–¹æ³• =====
    
    private DetailItem CreateEmptyItem()
    {
        return new DetailItem
        {
            FilteredProducts = new List<Product>()
        };
    }

    private RenderFragment<DetailItem> GetCustomActionsTemplate => item => __builder =>
    {
        // å¦‚æœæ˜¯ç©ºè¡Œï¼Œä¸é¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
        if (item.SelectedProduct != null)
        {
            <GenericButtonComponent 
                IconClass="bi bi-trash text-white"
                Title="åˆªé™¤"
                Variant="ButtonVariant.Red"
                Size="ButtonSize.Small"
                OnClick="async () => await HandleItemDelete(item)"
                IsDisabled="@IsReadOnly" />
        }
    };

    // ===== è¼”åŠ©æ–¹æ³• =====

    private async Task SyncToDetails()
    {
        Details.Clear();
        
        foreach (var item in DetailItems)
        {
            // åªæœ‰åœ¨æœ‰å•†å“IDã€å€‰åº«IDã€ä¸”é ˜è²¨æ•¸é‡å¤§æ–¼0æ™‚æ‰åŠ å…¥
            if (item.ProductId.HasValue && item.WarehouseId.HasValue && item.IssueQuantity > 0)
            {
                Details.Add(new MaterialIssueDetail
                {
                    ProductId = item.ProductId.Value,
                    WarehouseId = item.WarehouseId.Value,
                    WarehouseLocationId = item.WarehouseLocationId,
                    IssueQuantity = item.IssueQuantity,
                    UnitCost = item.UnitCost
                });
            }
        }
        
        await DetailsChanged.InvokeAsync(Details);
    }
}
