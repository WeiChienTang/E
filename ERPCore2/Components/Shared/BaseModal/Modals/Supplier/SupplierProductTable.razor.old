@* ä¾›æ‡‰å•†å•†å“ç¶å®šç®¡ç†çµ„ä»¶ - ä½¿ç”¨ InteractiveTableComponent *@
@inject INotificationService NotificationService
@using ERPCore2.Helpers
@using ERPCore2.Data.Entities

<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <InteractiveTableComponent TItem="ProductSupplier" 
                                  Items="@Items"
                                  ColumnDefinitions="@GetColumnDefinitions()"
                                  ShowHeader="true"
                                  ShowRowNumbers="true"
                                  IsStriped="true"
                                  IsHoverable="true"
                                  IsBordered="true"
                                  ShowBuiltInActions="true"
                                  ShowBuiltInDeleteButton="true"
                                  DeleteButtonVariant="ButtonVariant.Red"
                                  OnItemDelete="@HandleDeleteItem"
                                  EnableAutoEmptyRow="true"
                                  AllowAddNewRow="true"
                                  DataLoadCompleted="@DataLoadCompleted"
                                  CreateEmptyItem="@CreateEmptyItem"
                                  EmptyMessage="@EmptyMessage" />
    </div>
</div>

@code {
    // ===== åƒæ•¸ =====
    [Parameter] public List<ProductSupplier> Items { get; set; } = new();
    [Parameter] public EventCallback<List<ProductSupplier>> ItemsChanged { get; set; }
    [Parameter] public List<Product> AvailableProducts { get; set; } = new();
    [Parameter] public int SupplierId { get; set; }
    [Parameter] public bool DataLoadCompleted { get; set; } = true;
    [Parameter] public string EmptyMessage { get; set; } = "å°šæœªè¨­å®šä¾›æ‡‰å•†å“";
    [Parameter] public EventCallback<ProductSupplier> OnItemDeleted { get; set; }

    /// <summary>
    /// å»ºç«‹ä¾›æ‡‰å•†å“ç®¡ç†çš„æ¬„ä½å®šç¾©
    /// </summary>
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            // å•†å“é¸æ“‡ï¼ˆå¿…å¡«ï¼ŒSearchableSelectï¼‰
            new InteractiveColumnDefinition
            {
                Title = "å•†å“",
                PropertyName = "ProductSearchValue",
                EmptyCheckPropertyName = nameof(ProductSupplier.ProductId),
                ColumnType = InteractiveColumnType.SearchableSelect,
                Width = "25%",
                IsRequired = true,
                Placeholder = "è«‹è¼¸å…¥å•†å“ç·¨è™Ÿæˆ–åç¨±",
                TriggerEmptyRowOnFilled = true,
                SearchValuePropertyName = nameof(ProductSupplier.SearchText),
                FilteredItemsPropertyName = "FilteredProducts",
                ShowDropdownPropertyName = "ShowProductDropdown",
                SelectedIndexPropertyName = "ProductSelectedIndex",
                ItemDisplayFormatter = (item) =>
                {
                    var product = (Product)item;
                    return $"[{product.Code}] {product.Name}";
                },
                OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, (tuple) =>
                {
                    var (item, searchValue) = tuple;
                    OnProductSearchChanged((ProductSupplier)item, searchValue);
                }),
                OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
                {
                    var (item, selectedItem) = tuple;
                    await OnProductSelected((ProductSupplier)item, (Product?)selectedItem);
                }),
                OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
                {
                    OnProductFocus((ProductSupplier)item);
                }),
                OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
                {
                    OnProductBlur((ProductSupplier)item);
                })
            },
            
            // ä¾›æ‡‰å•†æ–™è™Ÿ
            new InteractiveColumnDefinition
            {
                Title = "ä¾›æ‡‰å•†æ–™è™Ÿ",
                PropertyName = nameof(ProductSupplier.SupplierProductCode),
                ColumnType = InteractiveColumnType.Input,
                Width = "15%",
                Placeholder = "ä¾›æ‡‰å•†æ–™è™Ÿ",
                Tooltip = "ä¾›æ‡‰å•†è‡ªå·±çš„å•†å“ç·¨è™Ÿ"
            },
            
            // å¸¸ç”¨æ¨™è¨˜
            new InteractiveColumnDefinition
            {
                Title = "å¸¸ç”¨",
                PropertyName = nameof(ProductSupplier.IsPreferred),
                ColumnType = InteractiveColumnType.Checkbox,
                Width = "8%",
                TextAlign = "center",
                Tooltip = "å‹¾é¸ç‚ºå¸¸ç”¨ä¾›æ‡‰å•†ï¼Œå„ªå…ˆæ¨è–¦"
            },
            
            // å„ªå…ˆé †åº
            new InteractiveColumnDefinition
            {
                Title = "å„ªå…ˆé †åº",
                PropertyName = nameof(ProductSupplier.Priority),
                ColumnType = InteractiveColumnType.Number,
                Width = "10%",
                Placeholder = "999",
                MinValue = 1,
                MaxValue = 999,
                Tooltip = "æ•¸å­—è¶Šå°è¶Šå„ªå…ˆï¼ˆ1=æœ€å„ªå…ˆï¼‰",
                CellCssClass = "text-center"
            },
            
            // é è¨ˆäº¤è²¨å¤©æ•¸
            new InteractiveColumnDefinition
            {
                Title = "äº¤è²¨å¤©æ•¸",
                PropertyName = nameof(ProductSupplier.LeadTimeDays),
                ColumnType = InteractiveColumnType.Number,
                Width = "10%",
                Placeholder = "å¤©æ•¸",
                MinValue = 0,
                Tooltip = "é è¨ˆäº¤è²¨å¤©æ•¸",
                CellCssClass = "text-center"
            },
            
            // æœ€è¿‘æ¡è³¼åƒ¹æ ¼ï¼ˆå”¯è®€ï¼Œå¾æ¡è³¼æ­·å²è¼‰å…¥ï¼‰
            new InteractiveColumnDefinition
            {
                Title = "æœ€è¿‘åƒ¹æ ¼",
                PropertyName = nameof(ProductSupplier.LastPurchasePrice),
                ColumnType = InteractiveColumnType.Display,
                Width = "12%",
                IsReadOnly = true,
                CellCssClass = "text-end text-muted",
                DisplayFormatter = (value) =>
                {
                    if (value is decimal price && price > 0)
                    {
                        return $"NT$ {price:N0}";
                    }
                    return "-";
                },
                Tooltip = "ç³»çµ±è‡ªå‹•æ›´æ–°"
            },
            
            // å‚™è¨»
            new InteractiveColumnDefinition
            {
                Title = "å‚™è¨»",
                PropertyName = nameof(ProductSupplier.Remarks),
                ColumnType = InteractiveColumnType.Input,
                Width = "20%",
                Placeholder = "æ¡è³¼æ³¨æ„äº‹é …"
            }
        };
    }

    /// <summary>
    /// å‰µå»ºç©ºçš„ ProductSupplier
    /// </summary>
    private ProductSupplier CreateEmptyItem()
    {
        return new ProductSupplier
        {
            SupplierId = SupplierId,
            ProductId = 0,
            IsPreferred = false,
            Priority = 999,
            Status = EntityStatus.Active,
            SearchText = "",
            FilteredProducts = new List<Product>(),
            ShowProductDropdown = false,
            ProductSelectedIndex = -1
        };
    }

    /// <summary>
    /// å•†å“æœå°‹è¼¸å…¥è®Šæ›´äº‹ä»¶
    /// </summary>
    private void OnProductSearchChanged(ProductSupplier productSupplier, string? searchValue)
    {
        productSupplier.SearchText = searchValue ?? "";
        
        if (string.IsNullOrWhiteSpace(searchValue))
        {
            productSupplier.FilteredProducts = new List<Product>();
            productSupplier.ShowProductDropdown = false;
        }
        else
        {
            var searchLower = searchValue.Trim().ToLower();
            productSupplier.FilteredProducts = AvailableProducts
                .Where(p => (p.Code?.ToLower().Contains(searchLower) ?? false) || 
                           (p.Name?.ToLower().Contains(searchLower) ?? false))
                .Take(20)
                .ToList();
            productSupplier.ShowProductDropdown = productSupplier.FilteredProducts.Any();
        }
        
        productSupplier.ProductSelectedIndex = -1;
        StateHasChanged();
    }

    /// <summary>
    /// å•†å“é¸æ“‡äº‹ä»¶
    /// </summary>
    private async Task OnProductSelected(ProductSupplier productSupplier, Product? selectedProduct)
    {
        if (selectedProduct == null) return;

        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå•†å“
        var existingBinding = Items.FirstOrDefault(ps => 
            ps != productSupplier && 
            ps.ProductId == selectedProduct.Id);

        if (existingBinding != null)
        {
            await NotificationService.ShowWarningAsync($"å•†å“ã€Œ{selectedProduct.Name}ã€å·²ç¶“ç¶å®šæ­¤ä¾›æ‡‰å•†");
            productSupplier.ProductId = 0;
            productSupplier.SearchText = "";
            productSupplier.FilteredProducts = new List<Product>();
            productSupplier.ShowProductDropdown = false;
            return;
        }

        productSupplier.ProductId = selectedProduct.Id;
        productSupplier.Product = selectedProduct;
        productSupplier.SearchText = $"[{selectedProduct.Code}] {selectedProduct.Name}";
        productSupplier.FilteredProducts = new List<Product>();
        productSupplier.ShowProductDropdown = false;
        
        StateHasChanged();
    }

    /// <summary>
    /// å•†å“è¼¸å…¥æ¡†ç²å¾—ç„¦é»
    /// </summary>
    private void OnProductFocus(ProductSupplier productSupplier)
    {
        if (productSupplier.ProductId > 0)
        {
            // å·²é¸æ“‡å•†å“æ™‚ï¼Œé¡¯ç¤ºæ‰€æœ‰å•†å“ä¾›é‡æ–°é¸æ“‡
            productSupplier.FilteredProducts = AvailableProducts.Take(20).ToList();
            productSupplier.ShowProductDropdown = true;
        }
        StateHasChanged();
    }

    /// <summary>
    /// å•†å“è¼¸å…¥æ¡†å¤±å»ç„¦é»
    /// </summary>
    private void OnProductBlur(ProductSupplier productSupplier)
    {
        // å»¶é²é—œé–‰ä¸‹æ‹‰é¸å–®ï¼Œè®“é»æ“Šäº‹ä»¶èƒ½æ­£å¸¸è§¸ç™¼
        Task.Delay(200).ContinueWith(_ =>
        {
            productSupplier.ShowProductDropdown = false;
            InvokeAsync(StateHasChanged);
        });
    }

    /// <summary>
    /// åˆªé™¤ä¾›æ‡‰å•†å“ç¶å®š
    /// </summary>
    private async Task HandleDeleteItem(ProductSupplier item)
    {
        Items.Remove(item);
        await ItemsChanged.InvokeAsync(Items);
        await OnItemDeleted.InvokeAsync(item);
        await InvokeAsync(StateHasChanged);
    }
}
    [Parameter] public Func<TProductSupplierEntity, decimal?> GetSupplierPrice { get; set; } = item => null;
    [Parameter] public Func<TProductSupplierEntity, int?> GetLeadTime { get; set; } = item => null;
    [Parameter] public Func<TProductSupplierEntity, int?> GetMinOrderQuantity { get; set; } = item => null;
    [Parameter] public Func<TProductSupplierEntity, int?> GetUnitId { get; set; } = item => null;
    [Parameter] public Func<TProductEntity, int> GetProductOptionId { get; set; } = product => product.Id;
    [Parameter] public Func<TProductEntity, string> GetProductOptionDisplayText { get; set; } = product => 
    {
        // æª¢æŸ¥æ˜¯å¦æœ‰ Name å’Œ Code å±¬æ€§ä¸¦å–å¾—å…¶å€¼
        var nameProperty = product.GetType().GetProperty("Name");
        var codeProperty = product.GetType().GetProperty("Code");
        
        var name = nameProperty?.GetValue(product) as string ?? "";
        var code = codeProperty?.GetValue(product) as string ?? "";
        
        if (!string.IsNullOrEmpty(code) && !string.IsNullOrEmpty(name))
        {
            return $"{code} - {name}";
        }
        else if (!string.IsNullOrEmpty(name))
        {
            return name;
        }
        else if (!string.IsNullOrEmpty(code))
        {
            return code;
        }
        
        return product.ToString() ?? "";
    };
    [Parameter] public Func<Unit, int> GetUnitOptionId { get; set; } = unit => unit.Id;
    [Parameter] public Func<Unit, string> GetUnitOptionDisplayText { get; set; } = unit => unit.Name;
    
    // ===== å§”æ´¾åƒæ•¸ - Setter =====
    [Parameter] public Action<TProductSupplierEntity, int?> SetProductId { get; set; } = (item, productId) => { };
    [Parameter] public Action<TProductSupplierEntity, string?> SetSupplierProductCode { get; set; } = (item, value) => { };
    [Parameter] public Action<TProductSupplierEntity, decimal?> SetSupplierPrice { get; set; } = (item, value) => { };
    [Parameter] public Action<TProductSupplierEntity, int?> SetLeadTime { get; set; } = (item, value) => { };
    [Parameter] public Action<TProductSupplierEntity, int?> SetMinOrderQuantity { get; set; } = (item, value) => { };
    [Parameter] public Action<TProductSupplierEntity, int?> SetUnitId { get; set; } = (item, value) => { };
    [Parameter] public Action<TProductSupplierEntity, int> SetSupplierId { get; set; } = (item, supplierId) => { }; // è¨­å®šä¾›æ‡‰å•†ID
    
    // ===== äº‹ä»¶åƒæ•¸ =====
    [Parameter] public EventCallback<List<TProductSupplierEntity>> ItemsChanged { get; set; }
    [Parameter] public EventCallback<TProductSupplierEntity> ItemAdded { get; set; }
    [Parameter] public EventCallback<TProductSupplierEntity> ItemRemoved { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; } // ğŸ†• æ–°å¢
    
    protected override void OnParametersSet()
    {
        base.OnParametersSet();
    }

    // ===== å»ºç«‹ç©ºé …ç›®æ–¹æ³• =====
    
    /// <summary>
    /// å‰µå»ºç©ºçš„ä¾›æ‡‰å•†å•†å“é …ç›®
    /// </summary>
    private TProductSupplierEntity CreateEmptyItem()
    {
        var newItem = new TProductSupplierEntity();
        SetSupplierId(newItem, ParentEntityId); // è¨­å®šä¾›æ‡‰å•†ID
        return newItem;
    }

    // ===== InteractiveTableComponent æ–¹æ³• =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            // å•†å“é¸æ“‡æ¬„ä½
            new() 
            { 
                Title = "å•†å“", 
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "25%",
                Tooltip = "é¸æ“‡æ­¤ä¾›æ‡‰å•†ä¾›æ‡‰çš„å•†å“",
                CustomTemplate = item => 
                {
                    var productSupplier = (TProductSupplierEntity)item;
                    var productId = GetProductId(productSupplier);
                    var selectedValue = productId?.ToString() ?? "";
                    
                    return @<select class="form-select form-select-sm" 
                                    value="@selectedValue"
                                    disabled="@IsReadOnly"
                                    title="é¸æ“‡æ­¤ä¾›æ‡‰å•†ä¾›æ‡‰çš„å•†å“"
                                    @onchange="@(async (e) => await OnProductChanged((productSupplier, e.Value)))">
                        <option value="">è«‹é¸æ“‡å•†å“</option>
                        @foreach (var product in ProductOptions)
                        {
                            <option value="@GetProductOptionId(product)">@GetProductOptionDisplayText(product)</option>
                        }
                    </select>;
                }
            },
            
            // ä¾›æ‡‰å•†å•†å“ä»£ç¢¼ - æ–‡å­—è¼¸å…¥
            new() 
            { 
                Title = "ä¾›æ‡‰å•†å•†å“ä»£ç¢¼", 
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "20%",
                Tooltip = "è¼¸å…¥ä¾›æ‡‰å•†å°æ­¤å•†å“çš„å•†å“ä»£ç¢¼æˆ–æ–™è™Ÿ",
                CustomTemplate = item => 
                {
                    var productSupplier = (TProductSupplierEntity)item;
                    var value = GetSupplierProductCode(productSupplier) ?? "";
                    
                    return @<input type="text" 
                                   class="form-control " 
                                   value="@value"
                                   placeholder="è«‹è¼¸å…¥ä»£ç¢¼"
                                   title="è¼¸å…¥ä¾›æ‡‰å•†å°æ­¤å•†å“çš„å•†å“ä»£ç¢¼æˆ–æ–™è™Ÿ"
                                   disabled="@IsReadOnly"
                                   @oninput="@(async (e) => await OnSupplierProductCodeChanged((productSupplier, e.Value?.ToString())))" />;
                }
            },
            
            // å ±åƒ¹ - æ•¸å­—è¼¸å…¥
            new() 
            { 
                Title = "å ±åƒ¹", 
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "15%",
                Tooltip = "è¼¸å…¥ä¾›æ‡‰å•†å°æ­¤å•†å“çš„å ±åƒ¹é‡‘é¡",
                CustomTemplate = item => 
                {
                    var productSupplier = (TProductSupplierEntity)item;
                    var value = GetSupplierPrice(productSupplier)?.ToString("F0") ?? "";
                    
                    return @<input type="number" 
                                   class="form-control " 
                                   value="@value"
                                   min="0"
                                   step="1"
                                   title="è¼¸å…¥ä¾›æ‡‰å•†å°æ­¤å•†å“çš„å ±åƒ¹é‡‘é¡"
                                   disabled="@IsReadOnly"
                                   @oninput="@(async (e) => await OnSupplierPriceChanged((productSupplier, e.Value?.ToString())))" />;
                }
            },
            
            // äº¤æœŸ - æ•¸å­—è¼¸å…¥
            new() 
            { 
                Title = "äº¤æœŸ(å¤©)", 
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "15%",
                Tooltip = "è¼¸å…¥ä¾›æ‡‰å•†çš„äº¤è²¨æ™‚é–“ï¼ˆä»¥å¤©ç‚ºå–®ä½ï¼‰",
                CustomTemplate = item => 
                {
                    var productSupplier = (TProductSupplierEntity)item;
                    var value = GetLeadTime(productSupplier)?.ToString() ?? "";
                    
                    return @<input type="number" 
                                   class="form-control " 
                                   value="@value"
                                   min="0"
                                   title="è¼¸å…¥ä¾›æ‡‰å•†çš„äº¤è²¨æ™‚é–“ï¼ˆä»¥å¤©ç‚ºå–®ä½ï¼‰"
                                   disabled="@IsReadOnly"
                                   @oninput="@(async (e) => await OnLeadTimeChanged((productSupplier, e.Value?.ToString())))" />;
                }
            },
            
            // æœ€å°è¨‚è³¼é‡ - æ•¸å­—è¼¸å…¥
            new() 
            { 
                Title = "æœ€å°è¨‚è³¼é‡", 
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "15%",
                Tooltip = "è¼¸å…¥ä¾›æ‡‰å•†è¦æ±‚çš„æœ€å°è¨‚è³¼æ•¸é‡",
                CustomTemplate = item => 
                {
                    var productSupplier = (TProductSupplierEntity)item;
                    var value = GetMinOrderQuantity(productSupplier)?.ToString() ?? "";
                    
                    return @<input type="number" 
                                   class="form-control " 
                                   value="@value"
                                   min="0"
                                   title="è¼¸å…¥ä¾›æ‡‰å•†è¦æ±‚çš„æœ€å°è¨‚è³¼æ•¸é‡"
                                   disabled="@IsReadOnly"
                                   @oninput="@(async (e) => await OnMinOrderQuantityChanged((productSupplier, e.Value?.ToString())))" />;
                }
            },
            
            // å–®ä½é¸æ“‡æ¬„ä½
            new() 
            { 
                Title = "å–®ä½", 
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "15%",
                Tooltip = "é¸æ“‡ä¾›æ‡‰å•†ä¾›æ‡‰æ­¤å•†å“çš„è¨ˆé‡å–®ä½",
                CustomTemplate = item => 
                {
                    var productSupplier = (TProductSupplierEntity)item;
                    var unitId = GetUnitId(productSupplier);
                    var selectedValue = unitId?.ToString() ?? "";
                    
                    return @<select class="form-select form-select-sm" 
                                    value="@selectedValue"
                                    disabled="@IsReadOnly"
                                    title="é¸æ“‡ä¾›æ‡‰å•†ä¾›æ‡‰æ­¤å•†å“çš„è¨ˆé‡å–®ä½"
                                    @onchange="@(async (e) => await OnUnitChanged((productSupplier, e.Value)))">
                        <option value="">è«‹é¸æ“‡å–®ä½</option>
                        @foreach (var unit in UnitOptions)
                        {
                            <option value="@GetUnitOptionId(unit)">@GetUnitOptionDisplayText(unit)</option>
                        }
                    </select>;
                }
            }
        };
    }

    private async Task HandleItemDelete(TProductSupplierEntity item)
    {
        var index = Items.IndexOf(item);
        await RemoveItemAsync(index);
    }

    // ===== å…§éƒ¨æ–¹æ³• =====

    private string GetProductDisplayText(TProductSupplierEntity item)
    {
        var productId = GetProductId(item);
        if (productId.HasValue)
        {
            var product = ProductOptions.FirstOrDefault(p => GetProductOptionId(p) == productId.Value);
            if (product != null)
            {
                return GetProductOptionDisplayText(product);
            }
        }
        return "æœªçŸ¥å•†å“";
    }

    private string GetUnitDisplayText(TProductSupplierEntity item)
    {
        var unitId = GetUnitId(item);
        if (unitId.HasValue)
        {
            var unit = UnitOptions.FirstOrDefault(u => GetUnitOptionId(u) == unitId.Value);
            if (unit != null)
            {
                return GetUnitOptionDisplayText(unit);
            }
        }
        return "-";
    }

    // ===== InteractiveTableComponent äº‹ä»¶è™•ç† =====
    private async Task OnProductChanged((object item, object? value) args)
    {
        var productSupplier = (TProductSupplierEntity)args.item;
    
        if (args.value != null && !string.IsNullOrEmpty(args.value.ToString()) && int.TryParse(args.value.ToString(), out var productId) && productId > 0)
        {
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå•†å“
            var existingProductIds = Items.Where(i => i != productSupplier).Select(item => GetProductId(item)).Where(id => id.HasValue && id.Value > 0);
            if (existingProductIds.Any(id => id!.Value == productId))
            {
                await NotificationService.ShowErrorAsync("æ­¤å•†å“å·²å­˜åœ¨ï¼Œè«‹é¸æ“‡å…¶ä»–å•†å“");
                SetProductId(productSupplier, null);
            }
            else
            {
                SetProductId(productSupplier, productId);
                await DetailSyncHelper.SyncToParentAsync(Items, ItemsChanged);
            }
        }
        else
        {
            SetProductId(productSupplier, null);
            await DetailSyncHelper.SyncToParentAsync(Items, ItemsChanged);
        }
        StateHasChanged();
    }

    private async Task OnSupplierProductCodeChanged((object item, string? value) args)
    {
        var productSupplier = (TProductSupplierEntity)args.item;
        
        SetSupplierProductCode(productSupplier, args.value);
        
        await DetailSyncHelper.SyncToParentAsync(Items, ItemsChanged);
        StateHasChanged();
    }

    private async Task OnSupplierPriceChanged((object item, string? value) args)
    {
        var productSupplier = (TProductSupplierEntity)args.item;
        
        if (string.IsNullOrEmpty(args.value))
        {
            SetSupplierPrice(productSupplier, null);
        }
        else
        {
            var price = InputEventHelper.HandleIntegerInput(args.value);
            SetSupplierPrice(productSupplier, (decimal)price);
        }
        
        await DetailSyncHelper.SyncToParentAsync(Items, ItemsChanged);
        StateHasChanged();
    }

    private async Task OnLeadTimeChanged((object item, string? value) args)
    {
        var productSupplier = (TProductSupplierEntity)args.item;
        var leadTime = string.IsNullOrEmpty(args.value) ? (int?)null : InputEventHelper.HandleIntegerInput(args.value);
        SetLeadTime(productSupplier, leadTime);
        
        await DetailSyncHelper.SyncToParentAsync(Items, ItemsChanged);
        StateHasChanged();
    }

    private async Task OnMinOrderQuantityChanged((object item, string? value) args)
    {
        var productSupplier = (TProductSupplierEntity)args.item;
        var quantity = string.IsNullOrEmpty(args.value) ? (int?)null : InputEventHelper.HandleIntegerInput(args.value);
        SetMinOrderQuantity(productSupplier, quantity);
        
        await DetailSyncHelper.SyncToParentAsync(Items, ItemsChanged);
        StateHasChanged();
    }

    private async Task OnUnitChanged((object item, object? value) args)
    {
        var productSupplier = (TProductSupplierEntity)args.item;
        
        if (args.value != null && !string.IsNullOrEmpty(args.value.ToString()) && int.TryParse(args.value.ToString(), out var unitId))
        {
            SetUnitId(productSupplier, unitId);
        }
        else
        {
            SetUnitId(productSupplier, null);
        }
        
        await DetailSyncHelper.SyncToParentAsync(Items, ItemsChanged);
        StateHasChanged();
    }
    
    public async Task RemoveItemAsync(int index)
    {
        if (IsReadOnly || index < 0 || index >= Items.Count) return;
        
        var removedItem = Items[index];
        if (removedItem == null) return;
        
        // ğŸ†• è¨˜éŒ„è¦åˆªé™¤çš„è³‡æ–™åº«å¯¦é«”ID
        if (removedItem.Id > 0)
        {
            _deletedDetailIds.Add(removedItem.Id);
        }
        
        Items.Remove(removedItem);
        
        await ItemRemoved.InvokeAsync(removedItem);
        await DetailSyncHelper.SyncToParentAsync(Items, ItemsChanged);
        
        // ğŸ†• é€šçŸ¥å·²åˆªé™¤çš„æ˜ç´°ID
        await NotifyDeletedDetailsChanged();
        
        StateHasChanged();
    }
    
    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        // å–å¾—éç©ºçš„é …ç›®
        var nonEmptyItems = Items.Where(item => {
            var productId = GetProductId(item);
            return productId.HasValue && productId.Value > 0;
        }).ToList();
        
        if (!nonEmptyItems.Any())
        {
            errors.Add("è‡³å°‘éœ€è¦ä¸€å€‹å•†å“");
        }
        else
        {
            // æª¢æŸ¥é‡è¤‡å•†å“
            var productIds = nonEmptyItems.Select(item => GetProductId(item)).Where(id => id.HasValue).ToList();
            if (productIds.Count != productIds.Distinct().Count())
            {
                errors.Add("å­˜åœ¨é‡è¤‡çš„å•†å“");
            }
        }
          
        if (errors.Any())
        {
            var errorMessage = string.Join("\n", errors);
            await NotificationService.ShowErrorAsync(errorMessage);
            return false;
        }
        
        return true;
    }
    
    /// <summary>
    /// é€šçŸ¥å·²åˆªé™¤çš„æ˜ç´°ID
    /// </summary>
    private async Task NotifyDeletedDetailsChanged()
    {
        if (OnDeletedDetailsChanged.HasDelegate && _deletedDetailIds.Any())
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds.ToList());
            _deletedDetailIds.Clear(); // æ¸…ç©ºå·²é€šçŸ¥çš„åˆªé™¤ID
        }
    }
}
