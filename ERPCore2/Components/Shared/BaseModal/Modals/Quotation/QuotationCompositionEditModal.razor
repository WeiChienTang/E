@* BOM çµ„åˆç·¨è¼¯ Modal - ç·¨è¼¯å ±åƒ¹å–®æ˜ç´°çš„ BOM çµ„æˆï¼ˆå®¢è£½åŒ–ï¼‰ *@
@using ERPCore2.Components.Shared.SubCollections
@using ERPCore2.Components.Shared.GenericComponent.Button
@using ERPCore2.Data.Entities
@inject IQuotationCompositionDetailService QuotationCompositionDetailService
@inject IProductService ProductService
@inject IUnitService UnitService
@inject INotificationService NotificationService

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@GetModalTitle()"
                   Icon="bi bi-diagram-3"
                   HeaderColor="BaseModalComponent.HeaderVariant.Info"
                   ShowFooter="false"
                   CloseOnBackdropClick="false"
                   CloseOnEscape="true"
                   IsLoading="@isLoading"
                   LoadingMessage="è¼‰å…¥ä¸­..."
                   HeaderButtons="@HeaderButtons"
                   BodyContent="@BodyContent" />

@code {
    // ===== åƒæ•¸å®šç¾© =====
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? QuotationDetailId { get; set; }
    [Parameter] public string ProductName { get; set; } = string.Empty;
    [Parameter] public int? ProductId { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;
    [Parameter] public EventCallback<List<QuotationCompositionDetail>> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public Func<List<QuotationCompositionDetail>?>? OnRequestCachedData { get; set; }

    // ===== ç§æœ‰æ¬„ä½ =====
    private bool isLoading = false;
    private bool _dataLoadCompleted = true;  // è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜ï¼ˆé è¨­ true ä¿æŒå‘ä¸‹å…¼å®¹ï¼‰
    private List<QuotationCompositionDetail> compositionDetails = new();
    private List<ERPCore2.Data.Entities.Product> availableProducts = new();
    private List<ERPCore2.Data.Entities.Unit> availableUnits = new();
    private InteractiveTableComponent<QuotationCompositionDetail>? tableComponent;

    // ===== ç”Ÿå‘½é€±æœŸ =====
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && QuotationDetailId.HasValue)
        {
            await LoadDataAsync();
        }
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        _dataLoadCompleted = false;  //  é–‹å§‹è¼‰å…¥è³‡æ–™ - è¨­å®šç‚ºæœªå®Œæˆ
        StateHasChanged();

        try
        {
            // è¼‰å…¥å¯ç”¨çš„å•†å“å’Œå–®ä½
            availableProducts = await ProductService.GetAllAsync();
            availableUnits = await UnitService.GetAllAsync();

            //  å„ªå…ˆå¾çˆ¶çµ„ä»¶çš„å¿«å–è¼‰å…¥ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            if (OnRequestCachedData != null)
            {
                var cachedData = OnRequestCachedData();
                if (cachedData?.Any() == true)
                {
                    compositionDetails = cachedData;
                    
                    // æ‰‹å‹•å¡«å……å°èˆªå±¬æ€§
                    foreach (var detail in compositionDetails)
                    {
                        if (detail.ComponentProductId > 0 && detail.ComponentProduct == null)
                        {
                            detail.ComponentProduct = availableProducts.FirstOrDefault(p => p.Id == detail.ComponentProductId)!;
                        }
                        if (detail.UnitId.HasValue && detail.Unit == null)
                        {
                            detail.Unit = availableUnits.FirstOrDefault(u => u.Id == detail.UnitId.Value);
                        }
                    }
                    
                    // ä½¿ç”¨å¿«å–è³‡æ–™ï¼Œä¸å†å¾è³‡æ–™åº«è¼‰å…¥
                    return;
                }
            }

            // æ²’æœ‰å¿«å–è³‡æ–™æ™‚æ‰å¾è³‡æ–™åº«è¼‰å…¥
            var existingDetails = await QuotationCompositionDetailService.GetByQuotationDetailIdAsync(QuotationDetailId!.Value);

            if (existingDetails.Any())
            {
                // å·²æœ‰è‡ªè¨‚çš„çµ„åˆæ˜ç´°
                compositionDetails = existingDetails;
            }
            else if (ProductId.HasValue)
            {
                // å¾ç”¢å“åˆæˆè¡¨è¤‡è£½
                compositionDetails = await QuotationCompositionDetailService.CopyFromProductCompositionAsync(
                    QuotationDetailId!.Value,
                    ProductId.Value
                );
                
                //  æ‰‹å‹•å¡«å……å°èˆªå±¬æ€§ï¼ˆå› ç‚º CopyFromProductCompositionAsync åªè¤‡è£½ IDï¼‰
                foreach (var detail in compositionDetails)
                {
                    if (detail.ComponentProductId > 0 && detail.ComponentProduct == null)
                    {
                        detail.ComponentProduct = availableProducts.FirstOrDefault(p => p.Id == detail.ComponentProductId)!;
                    }
                    if (detail.UnitId.HasValue && detail.Unit == null)
                    {
                        detail.Unit = availableUnits.FirstOrDefault(u => u.Id == detail.UnitId.Value);
                    }
                }
            }
            else
            {
                compositionDetails = new List<QuotationCompositionDetail>();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å¤±æ•—ï¼š{ex.Message}");
            compositionDetails = new List<QuotationCompositionDetail>();
        }
        finally
        {
            isLoading = false;
            _dataLoadCompleted = true;  //  è³‡æ–™è¼‰å…¥å®Œæˆ - è§¸ç™¼ç©ºè¡Œæª¢æŸ¥
            StateHasChanged();
        }
    }

    private string GetModalTitle()
    {
        return string.IsNullOrEmpty(ProductName) 
            ? "ç·¨è¼¯ BOM çµ„æˆ" 
            : $"ç·¨è¼¯ BOM çµ„æˆ - {ProductName}";
    }

    // ===== Header Buttons =====
    private RenderFragment HeaderButtons => __builder =>
    {
        <div class="w-100 d-flex align-items-center px-2">
            <div class="d-flex gap-2 ms-auto">
                @if (!IsReadOnly)
                {
                    <GenericButtonComponent Text="å„²å­˜"
                                          Variant="ButtonVariant.Green"
                                          Size="ButtonSize.Small"
                                          OnClick="@HandleSave" />
                }
            </div>
        </div>
    };

    // ===== Body Content =====
    private RenderFragment BodyContent => __builder =>
    {
        <div class="container-fluid">
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="QuotationCompositionDetail"
                                      Items="@compositionDetails"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"
                                      ShowHeader="true"
                                      ShowActions="false"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="true"
                                      OnItemDelete="@HandleItemDelete"
                                      EnableAutoEmptyRow="true"
                                      CreateEmptyItem="@CreateEmptyItem"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      IsStriped="true"
                                      IsHoverable="true"
                                      IsBordered="true"
                                      EmptyMessage="å°šæœªæ–°å¢çµ„ä»¶" />
        </div>
    };

    // ===== InteractiveTable é…ç½® =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // çµ„ä»¶ç”¢å“
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å“é …",
            PropertyName = "ComponentProductId",
            EmptyCheckPropertyName = "ComponentProduct",  //  æª¢æŸ¥ç‰©ä»¶å±¬æ€§è€Œé ID
            ColumnType = InteractiveColumnType.Select,
            Width = "40%",
            Options = availableProducts.Select(p => new InteractiveSelectOption
            {
                Value = p.Id,
                Text = $"[{p.Code}] {p.Name}"
            }).ToList(),
            TriggerEmptyRowOnFilled = true,
            OnSelectionChanged = EventCallback.Factory.Create<(object, object?)>(this, (args) =>
            {
                var (item, value) = args;
                if (item is QuotationCompositionDetail detail && value != null)
                {
                    var productId = Convert.ToInt32(value);
                    var product = availableProducts.FirstOrDefault(p => p.Id == productId);
                    
                    if (product != null)
                    {
                        detail.ComponentProduct = product;
                        detail.UnitId = product.UnitId;
                        
                        //  åªæœ‰ç•¶å“é …æœ‰è³‡æ–™æ™‚æ‰å¡«å…¥æ•¸é‡é è¨­å€¼
                        if (detail.Quantity == 0)
                        {
                            detail.Quantity = 1;
                        }
                        
                        StateHasChanged();
                    }
                }
            })
        });

        // æ•¸é‡
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "æ•¸é‡",
            PropertyName = "Quantity",
            ColumnType = InteractiveColumnType.Number,
            Width = "15%",
            MinValue = 0.01m,
            NumberFormat = "N2",
            TextAlign = "right",
            ExcludeFromEmptyCheck = true  // ğŸ”‘ æ•¸é‡æ¬„ä½ä¸åƒèˆ‡ç©ºè¡Œåˆ¤æ–·
        });

        // å–®ä½
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å–®ä½",
            PropertyName = "UnitId",
            ColumnType = InteractiveColumnType.Select,
            Width = "15%",
            Options = availableUnits.Select(u => new InteractiveSelectOption
            {
                Value = u.Id,
                Text = u.Name
            }).ToList()
        });

        // çµ„ä»¶æˆæœ¬
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "çµ„ä»¶æˆæœ¬",
            PropertyName = "ComponentCost",
            ColumnType = InteractiveColumnType.Number,
            Width = "15%",
            NumberFormat = "N2",
            TextAlign = "right"
        });

        // å‚™è¨»
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å‚™è¨»",
            PropertyName = "Remarks",
            ColumnType = InteractiveColumnType.Input,
            Width = "15%"
        });

        return columns;
    }

    private QuotationCompositionDetail CreateEmptyItem()
    {
        //  è¿”å›å®Œå…¨ç©ºçš„ç‰©ä»¶ï¼Œä¸è¨­å®šé è¨­å€¼ï¼ˆé¿å…è¢«èª¤åˆ¤ç‚ºæœ‰å€¼ï¼‰
        return new QuotationCompositionDetail
        {
            QuotationDetailId = QuotationDetailId ?? 0
            // Quantity ä¸è¨­å®šé è¨­å€¼ï¼Œä¿æŒ null æˆ– 0ï¼ˆä¾æ“šè³‡æ–™æ¨¡å‹ï¼‰
        };
    }

    // ===== äº‹ä»¶è™•ç† =====
    private void HandleItemDelete(QuotationCompositionDetail item)
    {
        compositionDetails.Remove(item);
        StateHasChanged();
    }

    private async Task HandleSave()
    {
        try
        {
            // éæ¿¾æ‰ç©ºè¡Œï¼ˆæ²’æœ‰é¸æ“‡çµ„ä»¶çš„ï¼‰
            var validDetails = compositionDetails
                .Where(x => x.ComponentProductId > 0 && x.Quantity > 0)
                .ToList();

            // æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡çš„çµ„ä»¶
            var duplicates = validDetails
                .GroupBy(x => x.ComponentProductId)
                .Where(g => g.Count() > 1)
                .Select(g => g.First().ComponentProduct?.Name)
                .ToList();

            if (duplicates.Any())
            {
                await NotificationService.ShowWarningAsync($"çµ„ä»¶é‡è¤‡ï¼š{string.Join("ã€", duplicates)}");
                return;
            }

            // å„²å­˜
            if (OnSave.HasDelegate)
            {
                await OnSave.InvokeAsync(validDetails);
            }

            await CloseModal();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å„²å­˜å¤±æ•—ï¼š{ex.Message}");
        }
    }

    private async Task HandleCancel()
    {
        if (OnCancel.HasDelegate)
        {
            await OnCancel.InvokeAsync();
        }

        await CloseModal();
    }

    private async Task CloseModal()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }
}
