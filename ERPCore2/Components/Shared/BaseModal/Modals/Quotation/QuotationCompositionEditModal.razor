@* BOM çµ„åˆç·¨è¼¯ Modal - ç·¨è¼¯å ±åƒ¹å–®æ˜ç´°çš„ BOM çµ„æˆï¼ˆå®¢è£½åŒ–ï¼‰ *@
@using ERPCore2.Components.Shared.SubCollections
@using ERPCore2.Components.Shared.GenericComponent.Button
@using ERPCore2.Data.Entities
@inject IQuotationCompositionDetailService QuotationCompositionDetailService
@inject IProductService ProductService
@inject IUnitService UnitService
@inject INotificationService NotificationService

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@GetModalTitle()"
                   Icon="bi bi-diagram-3"
                   HeaderColor="BaseModalComponent.HeaderVariant.Info"
                   ShowFooter="false"
                   CloseOnBackdropClick="false"
                   CloseOnEscape="true"
                   IsLoading="@isLoading"
                   LoadingMessage="è¼‰å…¥ä¸­..."
                   HeaderButtons="@HeaderButtons"
                   BodyContent="@BodyContent" />

@code {
    // ===== åƒæ•¸å®šç¾© =====
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? QuotationDetailId { get; set; }
    [Parameter] public string ProductName { get; set; } = string.Empty;
    [Parameter] public int? ProductId { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;
    [Parameter] public EventCallback<List<QuotationCompositionDetail>> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public Func<List<QuotationCompositionDetail>?>? OnRequestCachedData { get; set; }
    [Parameter] public int? SelectedCompositionId { get; set; }  // é¸ä¸­çš„é…æ–¹ ID
    [Parameter] public bool IsCustomMode { get; set; } = false;  // æ˜¯å¦ç‚ºè‡ªå®šç¾©æ¨¡å¼

    // ===== ç§æœ‰æ¬„ä½ =====
    private bool isLoading = false;
    private bool _dataLoadCompleted = true;  // è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜ï¼ˆé è¨­ true ä¿æŒå‘ä¸‹å…¼å®¹ï¼‰
    private List<QuotationCompositionDetail> compositionDetails = new();
    private List<ERPCore2.Data.Entities.Product> availableProducts = new();
    private List<ERPCore2.Data.Entities.Unit> availableUnits = new();
    private InteractiveTableComponent<QuotationCompositionDetail>? tableComponent;
    
    // ===== è‡ªå®šç¾©æ¨¡å¼ç›¸é—œ =====
    private string componentSearchTerm = string.Empty;
    private HashSet<int> selectedComponentIds = new();
    private bool showComponentSelector = false;

    // ===== ç”Ÿå‘½é€±æœŸ =====
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && QuotationDetailId.HasValue)
        {
            await LoadDataAsync();
        }
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        _dataLoadCompleted = false;  //  é–‹å§‹è¼‰å…¥è³‡æ–™ - è¨­å®šç‚ºæœªå®Œæˆ
        StateHasChanged();

        try
        {
            // è¼‰å…¥å¯ç”¨çš„å•†å“å’Œå–®ä½
            availableProducts = await ProductService.GetAllAsync();
            availableUnits = await UnitService.GetAllAsync();

            //  å„ªå…ˆå¾çˆ¶çµ„ä»¶çš„å¿«å–è¼‰å…¥ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            if (OnRequestCachedData != null)
            {
                var cachedData = OnRequestCachedData();
                if (cachedData?.Any() == true)
                {
                    compositionDetails = cachedData;
                    
                    // æ‰‹å‹•å¡«å……å°èˆªå±¬æ€§
                    foreach (var detail in compositionDetails)
                    {
                        if (detail.ComponentProductId > 0 && detail.ComponentProduct == null)
                        {
                            detail.ComponentProduct = availableProducts.FirstOrDefault(p => p.Id == detail.ComponentProductId)!;
                        }
                        if (detail.UnitId.HasValue && detail.Unit == null)
                        {
                            detail.Unit = availableUnits.FirstOrDefault(u => u.Id == detail.UnitId.Value);
                        }
                    }
                    
                    // ä½¿ç”¨å¿«å–è³‡æ–™ï¼Œä¸å†å¾è³‡æ–™åº«è¼‰å…¥
                    return;
                }
            }

            // æ²’æœ‰å¿«å–è³‡æ–™æ™‚æ‰å¾è³‡æ–™åº«è¼‰å…¥
            var existingDetails = await QuotationCompositionDetailService.GetByQuotationDetailIdAsync(QuotationDetailId!.Value);

            if (existingDetails.Any())
            {
                // å·²æœ‰è‡ªè¨‚çš„çµ„åˆæ˜ç´°
                compositionDetails = existingDetails;
            }
            else if (SelectedCompositionId.HasValue)
            {
                // å¾æŒ‡å®šçš„é…æ–¹è¤‡è£½
                compositionDetails = await QuotationCompositionDetailService.CopyFromCompositionAsync(
                    QuotationDetailId!.Value,
                    SelectedCompositionId.Value
                );
                
                //  æ‰‹å‹•å¡«å……å°èˆªå±¬æ€§ï¼ˆå› ç‚º CopyFromCompositionAsync åªè¤‡è£½ IDï¼‰
                foreach (var detail in compositionDetails)
                {
                    if (detail.ComponentProductId > 0 && detail.ComponentProduct == null)
                    {
                        detail.ComponentProduct = availableProducts.FirstOrDefault(p => p.Id == detail.ComponentProductId)!;
                    }
                    if (detail.UnitId.HasValue && detail.Unit == null)
                    {
                        detail.Unit = availableUnits.FirstOrDefault(u => u.Id == detail.UnitId.Value);
                    }
                }
            }
            else if (IsCustomMode)
            {
                // è‡ªå®šç¾©æ¨¡å¼ - é¡¯ç¤ºçµ„ä»¶é¸æ“‡å™¨
                compositionDetails = new List<QuotationCompositionDetail>();
                showComponentSelector = true;
            }
            else if (ProductId.HasValue)
            {
                // å‘å¾Œç›¸å®¹ï¼šå¾ç”¢å“åˆæˆè¡¨è¤‡è£½ï¼ˆä½¿ç”¨æœ€æ–°çš„ï¼‰
                compositionDetails = await QuotationCompositionDetailService.CopyFromProductCompositionAsync(
                    QuotationDetailId!.Value,
                    ProductId.Value
                );
                
                //  æ‰‹å‹•å¡«å……å°èˆªå±¬æ€§ï¼ˆå› ç‚º CopyFromProductCompositionAsync åªè¤‡è£½ IDï¼‰
                foreach (var detail in compositionDetails)
                {
                    if (detail.ComponentProductId > 0 && detail.ComponentProduct == null)
                    {
                        detail.ComponentProduct = availableProducts.FirstOrDefault(p => p.Id == detail.ComponentProductId)!;
                    }
                    if (detail.UnitId.HasValue && detail.Unit == null)
                    {
                        detail.Unit = availableUnits.FirstOrDefault(u => u.Id == detail.UnitId.Value);
                    }
                }
            }
            else
            {
                compositionDetails = new List<QuotationCompositionDetail>();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å¤±æ•—ï¼š{ex.Message}");
            compositionDetails = new List<QuotationCompositionDetail>();
        }
        finally
        {
            isLoading = false;
            _dataLoadCompleted = true;  //  è³‡æ–™è¼‰å…¥å®Œæˆ - è§¸ç™¼ç©ºè¡Œæª¢æŸ¥
            StateHasChanged();
        }
    }

    private string GetModalTitle()
    {
        return string.IsNullOrEmpty(ProductName) 
            ? "ç·¨è¼¯ BOM çµ„æˆ" 
            : $"ç·¨è¼¯ BOM çµ„æˆ - {ProductName}";
    }

    // ===== Header Buttons =====
    private RenderFragment HeaderButtons => __builder =>
    {
        <div class="w-100 d-flex align-items-center px-2">
            <div class="d-flex gap-2 ms-auto">
                @if (!IsReadOnly)
                {
                    <GenericButtonComponent Text="å„²å­˜"
                                          Variant="ButtonVariant.Green"
                                          Size="ButtonSize.Small"
                                          OnClick="@HandleSave" />
                }
            </div>
        </div>
    };

    // ===== Body Content =====
    private RenderFragment BodyContent => __builder =>
    {
        <div class="container-fluid">
            @* è‡ªå®šç¾©æ¨¡å¼çš„çµ„ä»¶é¸æ“‡å™¨ *@
            @if (IsCustomMode && showComponentSelector && !compositionDetails.Any())
            {
                <div class="alert alert-info mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-stars me-2"></i>
                        <h6 class="mb-0">è‡ªå®šç¾©æ¨¡å¼ - é¸æ“‡çµ„ä»¶</h6>
                    </div>
                    <p class="mb-3 small">è«‹å¾ä¸‹æ–¹é¸æ“‡è¦åŠ å…¥çš„çµ„ä»¶ï¼Œå‹¾é¸å¾Œå¯åœ¨ä¸‹æ–¹è¡¨æ ¼ç·¨è¼¯æ•¸é‡èˆ‡å–®ä½ã€‚</p>
                    
                    <!-- æœå°‹æ¡† -->
                    <div class="mb-2">
                        <input type="text"
                               class="form-control form-control-sm"
                               placeholder="æœå°‹çµ„ä»¶ä»£ç¢¼æˆ–åç¨±..."
                               @bind="componentSearchTerm"
                               @bind:event="oninput" />
                    </div>
                    
                    <!-- çµ„ä»¶é¸æ“‡æ¸…å–® -->
                    <div class="row g-2" style="max-height: 250px; overflow-y: auto;">
                        @foreach (var product in FilteredAvailableProducts)
                        {
                            <div class="col-md-6 col-lg-4">
                                <div class="form-check">
                                    <input class="form-check-input" 
                                           type="checkbox"
                                           id="product_@product.Id"
                                           checked="@selectedComponentIds.Contains(product.Id)"
                                           @onchange="(e) => ToggleComponent(product, (bool)e.Value!)">
                                    <label class="form-check-label small" for="product_@product.Id">
                                        [@product.Code] @product.Name
                                    </label>
                                </div>
                            </div>
                        }
                    </div>
                    
                    @if (!FilteredAvailableProducts.Any())
                    {
                        <div class="text-center text-muted small mt-2">
                            <i class="bi bi-search me-1"></i>
                            æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„çµ„ä»¶
                        </div>
                    }
                    
                    <!-- æ“ä½œæŒ‰éˆ• -->
                    <div class="mt-3 d-flex gap-2">
                        <GenericButtonComponent Text="å®Œæˆé¸æ“‡"
                                              Variant="ButtonVariant.Green"
                                              Size="ButtonSize.Small"
                                              IconClass="bi bi-check-circle"
                                              OnClick="@(() => showComponentSelector = false)" />
                        <GenericButtonComponent Text="å…¨éƒ¨æ¸…é™¤"
                                              Variant="ButtonVariant.OutlineRed"
                                              Size="ButtonSize.Small"
                                              IconClass="bi bi-x-circle"
                                              OnClick="@ClearAllComponents" />
                    </div>
                </div>
            }
            
            @* å·²é¸çµ„ä»¶æç¤º *@
            @if (IsCustomMode && compositionDetails.Any() && showComponentSelector)
            {
                <div class="alert alert-success mb-3 d-flex align-items-center justify-content-between">
                    <span>
                        <i class="bi bi-check-circle me-2"></i>
                        å·²é¸æ“‡ <strong>@compositionDetails.Count</strong> å€‹çµ„ä»¶
                    </span>
                    <GenericButtonComponent Text="ç¹¼çºŒé¸æ“‡"
                                          Variant="ButtonVariant.OutlineGreen"
                                          Size="ButtonSize.Small"
                                          IconClass="bi bi-plus-circle"
                                          OnClick="@(() => showComponentSelector = true)" />
                </div>
            }
            
            @* çµ„ä»¶æ˜ç´°è¡¨æ ¼ *@
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="QuotationCompositionDetail"
                                      Items="@compositionDetails"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"
                                      ShowHeader="true"
                                      ShowActions="false"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="true"
                                      OnItemDelete="@HandleItemDelete"
                                      EnableAutoEmptyRow="@(!IsCustomMode)"
                                      CreateEmptyItem="@CreateEmptyItem"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      IsStriped="true"
                                      IsHoverable="true"
                                      IsBordered="true"
                                      EmptyMessage="@GetEmptyMessage()" />
            
            @* è‡ªå®šç¾©æ¨¡å¼çš„æ–°å¢çµ„ä»¶æŒ‰éˆ• *@
            @if (IsCustomMode && !showComponentSelector && !IsReadOnly)
            {
                <div class="mt-2 text-center">
                    <GenericButtonComponent Text="æ–°å¢çµ„ä»¶"
                                          Variant="ButtonVariant.OutlineDarkBlue"
                                          Size="ButtonSize.Small"
                                          IconClass="bi bi-plus-circle"
                                          OnClick="@(() => showComponentSelector = true)" />
                </div>
            }
        </div>
    };

    // ===== InteractiveTable é…ç½® =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // çµ„ä»¶ç”¢å“
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å“é …",
            PropertyName = "ComponentProductId",
            EmptyCheckPropertyName = "ComponentProduct",  //  æª¢æŸ¥ç‰©ä»¶å±¬æ€§è€Œé ID
            ColumnType = InteractiveColumnType.Select,
            Width = "40%",
            Options = availableProducts.Select(p => new InteractiveSelectOption
            {
                Value = p.Id,
                Text = $"[{p.Code}] {p.Name}"
            }).ToList(),
            TriggerEmptyRowOnFilled = true,
            OnSelectionChanged = EventCallback.Factory.Create<(object, object?)>(this, (args) =>
            {
                var (item, value) = args;
                if (item is QuotationCompositionDetail detail && value != null)
                {
                    var productId = Convert.ToInt32(value);
                    var product = availableProducts.FirstOrDefault(p => p.Id == productId);
                    
                    if (product != null)
                    {
                        detail.ComponentProduct = product;
                        detail.UnitId = product.UnitId;
                        
                        //  åªæœ‰ç•¶å“é …æœ‰è³‡æ–™æ™‚æ‰å¡«å…¥æ•¸é‡é è¨­å€¼
                        if (detail.Quantity == 0)
                        {
                            detail.Quantity = 1;
                        }
                        
                        StateHasChanged();
                    }
                }
            })
        });

        // æ•¸é‡
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "æ•¸é‡",
            PropertyName = "Quantity",
            ColumnType = InteractiveColumnType.Number,
            Width = "15%",
            MinValue = 0.01m,
            NumberFormat = "N2",
            TextAlign = "right",
            ExcludeFromEmptyCheck = true  // ğŸ”‘ æ•¸é‡æ¬„ä½ä¸åƒèˆ‡ç©ºè¡Œåˆ¤æ–·
        });

        // å–®ä½
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å–®ä½",
            PropertyName = "UnitId",
            ColumnType = InteractiveColumnType.Select,
            Width = "15%",
            Options = availableUnits.Select(u => new InteractiveSelectOption
            {
                Value = u.Id,
                Text = u.Name
            }).ToList()
        });

        // çµ„ä»¶æˆæœ¬
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "çµ„ä»¶æˆæœ¬",
            PropertyName = "ComponentCost",
            ColumnType = InteractiveColumnType.Number,
            Width = "15%",
            NumberFormat = "N2",
            TextAlign = "right"
        });

        // å‚™è¨»
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å‚™è¨»",
            PropertyName = "Remarks",
            ColumnType = InteractiveColumnType.Input,
            Width = "15%"
        });

        return columns;
    }

    private QuotationCompositionDetail CreateEmptyItem()
    {
        //  è¿”å›å®Œå…¨ç©ºçš„ç‰©ä»¶ï¼Œä¸è¨­å®šé è¨­å€¼ï¼ˆé¿å…è¢«èª¤åˆ¤ç‚ºæœ‰å€¼ï¼‰
        return new QuotationCompositionDetail
        {
            QuotationDetailId = QuotationDetailId ?? 0
            // Quantity ä¸è¨­å®šé è¨­å€¼ï¼Œä¿æŒ null æˆ– 0ï¼ˆä¾æ“šè³‡æ–™æ¨¡å‹ï¼‰
        };
    }

    // ===== äº‹ä»¶è™•ç† =====
    private void HandleItemDelete(QuotationCompositionDetail item)
    {
        compositionDetails.Remove(item);
        StateHasChanged();
    }

    private async Task HandleSave()
    {
        try
        {
            // éæ¿¾æ‰ç©ºè¡Œï¼ˆæ²’æœ‰é¸æ“‡çµ„ä»¶çš„ï¼‰
            var validDetails = compositionDetails
                .Where(x => x.ComponentProductId > 0 && x.Quantity > 0)
                .ToList();

            // æª¢æŸ¥æ˜¯å¦è‡³å°‘æœ‰ä¸€å€‹æ˜ç´°
            if (!validDetails.Any())
            {
                await NotificationService.ShowWarningAsync("è«‹è‡³å°‘æ–°å¢ä¸€å€‹çµ„ä»¶æ˜ç´°");
                return;
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡çš„çµ„ä»¶
            var duplicates = validDetails
                .GroupBy(x => x.ComponentProductId)
                .Where(g => g.Count() > 1)
                .Select(g => g.First().ComponentProduct?.Name)
                .ToList();

            if (duplicates.Any())
            {
                await NotificationService.ShowWarningAsync($"çµ„ä»¶é‡è¤‡ï¼š{string.Join("ã€", duplicates)}");
                return;
            }

            // å„²å­˜
            if (OnSave.HasDelegate)
            {
                await OnSave.InvokeAsync(validDetails);
            }

            await CloseModal();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å„²å­˜å¤±æ•—ï¼š{ex.Message}");
        }
    }

    private async Task HandleCancel()
    {
        if (OnCancel.HasDelegate)
        {
            await OnCancel.InvokeAsync();
        }

        await CloseModal();
    }

    private async Task CloseModal()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }
    
    // ===== è‡ªå®šç¾©æ¨¡å¼ç›¸é—œæ–¹æ³• =====
    
    /// <summary>
    /// éæ¿¾å¯ç”¨çš„çµ„ä»¶ç”¢å“
    /// </summary>
    private List<ERPCore2.Data.Entities.Product> FilteredAvailableProducts
    {
        get
        {
            var products = availableProducts.AsEnumerable();
            
            if (!string.IsNullOrWhiteSpace(componentSearchTerm))
            {
                products = products.Where(p =>
                    (p.Code?.Contains(componentSearchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (p.Name?.Contains(componentSearchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
                );
            }
            
            return products.OrderBy(p => p.Code).ToList();
        }
    }
    
    /// <summary>
    /// åˆ‡æ›çµ„ä»¶é¸æ“‡
    /// </summary>
    private void ToggleComponent(Product product, bool isChecked)
    {
        if (isChecked)
        {
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (!compositionDetails.Any(d => d.ComponentProductId == product.Id))
            {
                // æ–°å¢çµ„ä»¶
                var newDetail = new QuotationCompositionDetail
                {
                    QuotationDetailId = QuotationDetailId ?? 0,
                    ComponentProductId = product.Id,
                    ComponentProduct = product,
                    Quantity = 1,
                    UnitId = product.UnitId,
                    Unit = product.Unit
                };
                compositionDetails.Add(newDetail);
                selectedComponentIds.Add(product.Id);
            }
        }
        else
        {
            // ç§»é™¤çµ„ä»¶
            var detail = compositionDetails.FirstOrDefault(d => d.ComponentProductId == product.Id);
            if (detail != null)
            {
                compositionDetails.Remove(detail);
                selectedComponentIds.Remove(product.Id);
            }
        }
        
        StateHasChanged();
    }
    
    /// <summary>
    /// æ¸…é™¤æ‰€æœ‰çµ„ä»¶
    /// </summary>
    private void ClearAllComponents()
    {
        compositionDetails.Clear();
        selectedComponentIds.Clear();
        StateHasChanged();
    }
    
    /// <summary>
    /// å–å¾—ç©ºè¨Šæ¯
    /// </summary>
    private string GetEmptyMessage()
    {
        if (IsCustomMode)
        {
            return "è«‹é»æ“Šä¸Šæ–¹ã€Œæ–°å¢çµ„ä»¶ã€æŒ‰éˆ•é¸æ“‡è¦åŠ å…¥çš„çµ„ä»¶";
        }
        return "å°šæœªæ–°å¢çµ„ä»¶";
    }
}
