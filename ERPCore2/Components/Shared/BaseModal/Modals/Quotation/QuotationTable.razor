@* 報價單明細管理組件 - 使用 InteractiveTableComponent 統一UI *@

@using ERPCore2.Helpers.InteractiveTableComponentHelper
@inject IProductService ProductService
@inject IQuotationDetailService QuotationDetailService
@inject INotificationService NotificationService
@inject RelatedDocumentsHelper RelatedDocumentsHelper

@typeparam TMainEntity where TMainEntity : BaseEntity
@typeparam TDetailEntity where TDetailEntity : BaseEntity, new()

@if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
{
    <div class="alert alert-info text-center" role="alert">
        <i class="fas fa-info-circle me-2"></i>
        請先選擇客戶後再進行報價明細管理
    </div>
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent TItem="QuotationItem" 
                                      Items="@QuotationItems"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"
                                      ShowRowNumbers="false"
                                      EmptyMessage="@EmptyMessage"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="false"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"
                                      ActionsColumnWidth = "60px"
                                      EnableAutoEmptyRow="true"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@CreateEmptyItem" />
        </div>

        <div class="card-footer">
            <div class="d-flex justify-content-between">
                <div class="d-flex gap-2">
                    <GenericButtonComponent Text="智能下單"
                                          Variant="ButtonVariant.DarkBlue"
                                          OnClick="SmartQuotation"
                                          IsDisabled="@(!CanUseSmartQuotation || IsReadOnly)"
                                          Title="@(CanUseSmartQuotation ? "根據該客戶上次報價單載入明細" : "請先選擇客戶")" />
                </div>
                <div class="d-flex gap-2">
                    <GenericButtonComponent Text="清除明細"
                                          Variant="ButtonVariant.Red"
                                          OnClick="ClearAllDetails"
                                          IsDisabled="@IsReadOnly" />
                </div>
            </div>
        </div>
    </div>
}

<!-- 相關單據查看 Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

@code {
    // ===== 私有欄位 =====
    private bool _dataLoadCompleted = true;  // 資料載入完成標記
    
    // ===== 基本參數 =====
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public List<Unit> Units { get; set; } = new List<Unit>();
    [Parameter] public EventCallback<List<QuotationItem>> OnQuotationItemsChanged { get; set; }
    
    // ===== 客戶過濾參數 =====
    [Parameter] public int? SelectedCustomerId { get; set; }
    
    // ===== 泛型參數 =====
    [Parameter] public TMainEntity? MainEntity { get; set; }
    [Parameter] public List<TDetailEntity> ExistingDetails { get; set; } = new List<TDetailEntity>();
    [Parameter] public EventCallback<List<TDetailEntity>> OnDetailsChanged { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    [Parameter] public EventCallback<QuotationItem> OnItemRemoved { get; set; }
    
    // ===== 欄位映射參數 =====
    [Parameter] public string MainEntityIdPropertyName { get; set; } = string.Empty;
    [Parameter] public string QuantityPropertyName { get; set; } = "Quantity";
    [Parameter] public string UnitPricePropertyName { get; set; } = "UnitPrice";
    [Parameter] public string DiscountPercentagePropertyName { get; set; } = "DiscountPercentage";
    [Parameter] public string RemarksPropertyName { get; set; } = "Remarks";
    [Parameter] public string? UnitIdPropertyName { get; set; }
    
    // ===== 顯示設定 =====
    [Parameter] public string Title { get; set; } = "報價明細";
    [Parameter] public string EmptyMessage { get; set; } = "尚未新增報價商品";
    
    // ===== 唯讀模式參數 =====
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== 相關單據開啟事件 =====
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }

    private List<QuotationItem> QuotationItems { get; set; } = new List<QuotationItem>();
    private int? _previousSelectedCustomerId = null;
    private List<int> _deletedDetailIds { get; set; } = new List<int>();
    
    // ===== 相關單據查看 =====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadExistingDetailsAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        
        // 檢查客戶是否變更
        bool customerChanged = _previousSelectedCustomerId != SelectedCustomerId;
        
        // 如果客戶變更，需要重新載入所有資料
        if (customerChanged)
        {
            _previousSelectedCustomerId = SelectedCustomerId;
            
            // 客戶變更時清空現有選項並重新載入
            QuotationItems.Clear();
            await LoadExistingDetailsAsync();
            return;
        }
    }

    // ===== 建立空項目方法 =====
    
    private QuotationItem CreateEmptyItem()
    {
        return new QuotationItem();
    }

    // ===== InteractiveTableComponent 方法 =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // 商品選擇欄位 - 觸發欄位（第一個欄位預設為觸發欄位）
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "項目名稱/規格", 
            PropertyName = "ProductSearchValue",
            EmptyCheckPropertyName = "SelectedProduct",  // 檢查 SelectedProduct 物件
            TriggerEmptyRowOnFilled = true,  // 選擇商品後自動新增空行
            ColumnType = InteractiveColumnType.SearchableSelect,
            Width = "300px",
            Tooltip = "搜尋並選擇商品（輸入編號或名稱）。已轉銷貨的商品將無法變更",
            Placeholder = "請輸入商品編號或名稱",
            SearchValuePropertyName = nameof(QuotationItem.ProductSearchValue),
            FilteredItemsPropertyName = nameof(QuotationItem.FilteredProducts),
            ShowDropdownPropertyName = nameof(QuotationItem.ShowProductDropdown),
            SelectedIndexPropertyName = nameof(QuotationItem.ProductSelectedIndex),
            ItemDisplayFormatter = (item) =>
            {
                var product = (Product)item;
                return $"[{product.Code}] {product.Name}";
            },
            IsDisabledFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                return IsReadOnly || !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true);
            },
            TooltipFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                return !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) 
                    ? "此商品已轉銷貨，無法修改商品選擇" : null;
            },
            OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, (tuple) =>
            {
                var (item, searchValue) = tuple;
                OnProductSearchChanged((QuotationItem)item, searchValue);
            }),
            OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
            {
                var (item, selectedItem) = tuple;
                await OnProductSelected((QuotationItem)item, (Product?)selectedItem);
            }),
            OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
            {
                var quotationItem = (QuotationItem)item;
                quotationItem.FilteredProducts = Products.Take(20).ToList();
                quotationItem.ShowProductDropdown = true;
                quotationItem.ProductSelectedIndex = -1;
                StateHasChanged();
            }),
            OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
            {
                Task.Delay(200).ContinueWith(_ =>
                {
                    var quotationItem = (QuotationItem)item;
                    quotationItem.ShowProductDropdown = false;
                    InvokeAsync(StateHasChanged);
                });
            }),
            EnableKeyboardNavigation = true,
            GetDropdownItems = (item) => ((QuotationItem)item).FilteredProducts,
            GetSelectedIndex = (item) => ((QuotationItem)item).ProductSelectedIndex,
            SetSelectedIndex = (item, index) => ((QuotationItem)item).ProductSelectedIndex = index,
            GetShowDropdown = (item) => ((QuotationItem)item).ShowProductDropdown,
            SetShowDropdown = (item, show) => ((QuotationItem)item).ShowProductDropdown = show,
            MaxDisplayItems = 20
        });

        // 單位欄位
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "單位", 
            PropertyName = "UnitId",
            ColumnType = InteractiveColumnType.Select,
            Width = "100px",
            Placeholder = "請選擇單位",
            Tooltip = "選擇報價單位",
            Options = Units.Select(u => new InteractiveSelectOption 
            { 
                Value = u.Id.ToString(), 
                Text = u.Name ?? "" 
            }).ToList(),
            IsDisabledFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                return IsReadOnly || (!DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow);
            },
            TooltipFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                if (!DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow)
                    return "此商品已轉銷貨，無法修改單位";
                return "選擇報價單位";
            },
            OnSelectionChanged = EventCallback.Factory.Create<(object, object?)>(this, async args =>
            {
                var (item, value) = args;
                await OnUnitSelectionChanged((QuotationItem)item, value?.ToString());
            })
        });

        // 數量欄位
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "數量", 
            PropertyName = "Quantity",
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            Tooltip = "輸入數量",
            CellCssClass = "text-end",
            MinValue = 0,
            IsDisabledFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                return !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow;
            },
            TooltipFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                if (!DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow)
                    return "此商品已轉銷貨，無法修改數量";
                return "輸入數量";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var quotationItem = (QuotationItem)args.Item1;
                await OnQuantityInput(quotationItem, args.Item2);
            })
        });

        // 單價欄位
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "單價", 
            PropertyName = "UnitPrice",
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            Tooltip = "輸入報價單價",
            CellCssClass = "text-end",
            MinValue = 0,
            IsDisabledFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                return !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow;
            },
            TooltipFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                if (!DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow)
                    return "此商品已轉銷貨，無法修改單價";
                return "輸入報價單價";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var quotationItem = (QuotationItem)args.Item1;
                await OnUnitPriceInput(quotationItem, args.Item2);
            })
        });

        // 折扣欄位
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "折扣(%)", 
            PropertyName = "DiscountPercentage",
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            Tooltip = "輸入折扣百分比",
            CellCssClass = "text-end",
            MinValue = 0,
            MaxValue = 100,
            IsDisabledFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                return !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow;
            },
            TooltipFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                if (!DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow)
                    return "此商品已轉銷貨，無法修改折扣";
                return "輸入折扣百分比";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var quotationItem = (QuotationItem)args.Item1;
                await OnDiscountPercentageInput(quotationItem, args.Item2);
            })
        });

        // 小計欄位
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "小計",
            Tooltip = "數量 × 單價 × (1 - 折扣%) 的總計",
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item =>
            {
                var quotationItem = (QuotationItem)item;
                var subtotal = quotationItem.Quantity * quotationItem.UnitPrice * (1 - quotationItem.DiscountPercentage / 100);
                var displayValue = NumberFormatHelper.FormatSmartZeroAsEmpty(subtotal);
                return @<div class="text-end fw-bold text-success">@displayValue</div>;
            }
        });

        // 備註欄位 - 即使已轉銷貨也可編輯（用於記錄執行狀況）
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "備註", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "150px",
            HideOnMobile = true,
            Tooltip = "選填。可記錄報價相關的備註資訊",
            CustomTemplate = item => 
            {
                var quotationItem = (QuotationItem)item;
                
                // 如果是唯讀狀態，直接顯示 span
                if (IsReadOnly)
                {
                    var displayText = string.IsNullOrEmpty(quotationItem.Remarks) ? "無備註" : quotationItem.Remarks;
                    return @<div class="d-flex align-items-center" style="min-height: 31px;">
                        <span class="text-muted">@displayText</span>
                    </div>;
                }
                
                // 可編輯狀態，顯示輸入框
                return @<input type="text" class="form-control " 
                               value="@quotationItem.Remarks"
                               @oninput="(e) => OnRemarksInput(quotationItem, e.Value?.ToString())"
                               placeholder="選填..." />;
            }
        });

        return columns;
    }

    private RenderFragment<QuotationItem> GetCustomActionsTemplate => item => __builder =>
    {
        var quotationItem = (QuotationItem)item;
        var isEmptyRow = quotationItem.SelectedProduct == null;
        var canDelete = DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true);
        
        if (IsReadOnly)
        {
            // 唯讀模式：所有項目都顯示檢視按鈕
            <GenericButtonComponent Variant="ButtonVariant.Blue"
                                   IconClass="bi bi-eye text-white"
                                   Size="ButtonSize.Large"
                                   Title="查看相關單據"
                                   OnClick="async () => await ShowRelatedDocuments(quotationItem)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else if (canDelete || isEmptyRow)
        {
            // 可編輯模式且未轉銷貨（或是空行）：顯示刪除按鈕
            <GenericButtonComponent Variant="ButtonVariant.Red"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   Title="刪除"
                                   OnClick="async () => await HandleItemDelete(quotationItem)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else
        {
            // 已轉銷貨且非空行：顯示查看相關單據按鈕
            <GenericButtonComponent Variant="ButtonVariant.Blue"
                                   IconClass="bi bi-eye text-white"
                                   Size="ButtonSize.Large"
                                   Title="查看相關單據"
                                   OnClick="async () => await ShowRelatedDocuments(quotationItem)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
    };

    private async Task HandleItemDelete(QuotationItem item)
    {
        var index = QuotationItems.IndexOf(item);
        await RemoveItemAsync(index);
    }

    /// <summary>
    /// 顯示相關單據（銷貨訂單）
    /// </summary>
    private async Task ShowRelatedDocuments(QuotationItem item)
    {
        if (item.ExistingDetailEntity is not QuotationDetail detail || detail.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("此明細尚未儲存，無法查看相關單據", "提示");
            return;
        }

        selectedProductName = item.SelectedProduct?.Name ?? "未知商品";
        
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsByQuotationDetailAsync(detail.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入相關單據時發生錯誤：{ex.Message}", "錯誤");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// 處理點擊相關單據的事件
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // 觸發事件，讓父組件（EditModal）處理開啟相關單據
        // 注意：不關閉 RelatedDocumentsModal，讓使用者可以繼續查看列表
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            // 如果父組件沒有處理此事件，則顯示提示訊息
            await NotificationService.ShowInfoAsync(
                $"請在父組件中實作 OnOpenRelatedDocument 事件處理器以開啟 {document.TypeDisplayName}",
                "提示"
            );
        }
    }

    // ===== 內部方法 =====
    /// <summary>
    /// 公開方法：刷新明細資料（供父組件呼叫）
    /// 用於銷貨訂單儲存後，重新載入明細以更新轉單數量
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        // 重新載入現有明細（會從 ExistingDetails 參數重新載入）
        await LoadExistingDetailsAsync();
        
        // 強制 UI 更新
        StateHasChanged();
    }
    
    /// <summary>
    /// 從現有明細資料載入到 QuotationItems
    /// </summary>
    private Task LoadExistingDetailsAsync()
    {
        if (ExistingDetails?.Any() != true) 
        {
            return Task.CompletedTask;
        }

        QuotationItems.Clear();
        
        foreach (var detail in ExistingDetails)
        {
            // 轉換為正確的實體類型
            if (detail is QuotationDetail quotationDetail)
            {
                var item = new QuotationItem
                {
                    // 直接使用 Navigation Properties
                    SelectedProduct = quotationDetail.Product,
                    SelectedUnit = quotationDetail.Unit,
                    
                    // 設定搜尋顯示值（修正編輯模式顯示問題）
                    ProductSearchValue = quotationDetail.Product != null ? 
                        $"[{quotationDetail.Product.Code}] {quotationDetail.Product.Name}" : string.Empty,
                    
                    // 直接使用屬性值
                    Quantity = quotationDetail.Quantity,
                    UnitPrice = quotationDetail.UnitPrice,
                    DiscountPercentage = quotationDetail.DiscountPercentage,
                    ConvertedQuantity = quotationDetail.ConvertedQuantity,
                    Remarks = string.Empty,
                    ExistingDetailEntity = detail
                };
                
                QuotationItems.Add(item);
            }
            else
            {
                // 對於非 QuotationDetail 類型，保留原有的泛型邏輯作為後備
                var productId = GetPropertyValue<int>(detail, "ProductId");
                var product = Products.FirstOrDefault(p => p.Id == productId);
                
                if (product != null)
                {
                    var item = new QuotationItem
                    {
                        SelectedProduct = product,
                        ProductSearchValue = $"[{product.Code}] {product.Name}",  // 設定搜尋顯示值
                        Quantity = Convert.ToDecimal(GetPropertyValue<object>(detail, QuantityPropertyName) ?? 0m),
                        UnitPrice = Convert.ToDecimal(GetPropertyValue<object>(detail, UnitPricePropertyName) ?? 0m),
                        DiscountPercentage = Convert.ToDecimal(GetPropertyValue<object>(detail, DiscountPercentagePropertyName) ?? 0m),
                        ConvertedQuantity = Convert.ToDecimal(GetPropertyValue<object>(detail, "ConvertedQuantity") ?? 0m),
                        Remarks = GetPropertyValue<string>(detail, RemarksPropertyName) ?? string.Empty,
                        ExistingDetailEntity = detail
                    };
                    
                    // 載入單位資訊
                    if (!string.IsNullOrEmpty(UnitIdPropertyName))
                    {
                        var unitId = GetPropertyValue<int?>(detail, UnitIdPropertyName);
                        if (unitId.HasValue)
                        {
                            item.SelectedUnit = Units.FirstOrDefault(u => u.Id == unitId.Value);
                        }
                    }
                    
                    QuotationItems.Add(item);
                }
            }
        }
        
        return Task.CompletedTask;
    }

    private List<TDetailEntity> ConvertToDetailEntities()
    {
        var details = new List<TDetailEntity>();
        
        // 只處理非空行、有選擇商品且數量大於 0 的項目
        foreach (var item in QuotationItems.Where(x => x.SelectedProduct != null &&
                                                        x.Quantity > 0))
        {
            TDetailEntity detail;
            
            if (item.ExistingDetailEntity != null)
            {
                detail = item.ExistingDetailEntity;
                
                // 如果是 QuotationDetail 類型，直接設置屬性
                if (detail is QuotationDetail quotationDetail)
                {
                    quotationDetail.Quantity = item.Quantity;
                    quotationDetail.UnitPrice = item.UnitPrice;
                    quotationDetail.DiscountPercentage = item.DiscountPercentage;
                    // ConvertedQuantity 不應在此更新，它由轉單流程控制
                    
                    if (item.SelectedUnit != null)
                        quotationDetail.UnitId = item.SelectedUnit.Id;
                    
                    if (item.SelectedProduct != null)
                        quotationDetail.ProductId = item.SelectedProduct.Id;
                }
                else
                {
                    // 對於其他類型，使用反射
                    SetPropertyValue(detail, QuantityPropertyName, item.Quantity);
                    SetPropertyValue(detail, UnitPricePropertyName, item.UnitPrice);
                    SetPropertyValue(detail, DiscountPercentagePropertyName, item.DiscountPercentage);
                    SetPropertyValue(detail, RemarksPropertyName, item.Remarks);
                    
                    if (!string.IsNullOrEmpty(UnitIdPropertyName) && item.SelectedUnit != null)
                    {
                        SetPropertyValue(detail, UnitIdPropertyName, item.SelectedUnit.Id);
                    }
                }
            }
            else
            {
                detail = new TDetailEntity();
                
                if (MainEntity != null && !string.IsNullOrEmpty(MainEntityIdPropertyName))
                {
                    SetPropertyValue(detail, MainEntityIdPropertyName, MainEntity.Id);
                }
                
                // 設定商品ID
                if (item.SelectedProduct != null)
                {
                    SetPropertyValue(detail, "ProductId", item.SelectedProduct.Id);
                }
                
                SetPropertyValue(detail, QuantityPropertyName, item.Quantity);
                SetPropertyValue(detail, UnitPricePropertyName, item.UnitPrice);
                SetPropertyValue(detail, DiscountPercentagePropertyName, item.DiscountPercentage);
                SetPropertyValue(detail, RemarksPropertyName, item.Remarks);
                
                if (!string.IsNullOrEmpty(UnitIdPropertyName) && item.SelectedUnit != null)
                {
                    SetPropertyValue(detail, UnitIdPropertyName, item.SelectedUnit.Id);
                }
                
                // 新增的明細，ConvertedQuantity 預設為 0
                if (detail is QuotationDetail newQuotationDetail)
                {
                    newQuotationDetail.ConvertedQuantity = 0;
                }
            }
            
            details.Add(detail);
        }
        
        return details;
    }

    private async Task NotifyDetailsChanged()
    {
        var details = ConvertToDetailEntities();
        await OnDetailsChanged.InvokeAsync(details);
        
        // 通知已刪除的明細 ID
        if (OnDeletedDetailsChanged.HasDelegate && _deletedDetailIds.Any())
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds.ToList());
            _deletedDetailIds.Clear();
        }
    }

    private T? GetPropertyValue<T>(object obj, string propertyName)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property == null) return default(T);
        
        var value = property.GetValue(obj);
        if (value == null) return default(T);
        
        if (typeof(T) == typeof(object)) return (T)value;
        
        return (T)Convert.ChangeType(value, typeof(T));
    }

    private void SetPropertyValue(object obj, string propertyName, object? value)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property != null && property.CanWrite)
        {
            if (value != null && property.PropertyType != value.GetType())
            {
                if (property.PropertyType.IsGenericType && property.PropertyType.GetGenericTypeDefinition() == typeof(Nullable<>))
                {
                    var underlyingType = Nullable.GetUnderlyingType(property.PropertyType);
                    value = Convert.ChangeType(value, underlyingType!);
                }
                else
                {
                    value = Convert.ChangeType(value, property.PropertyType);
                }
            }
            property.SetValue(obj, value);
        }
    }

    // ===== 事件處理方法 =====

    /// <summary>
    /// 商品搜尋輸入變更事件（SearchableSelect）
    /// </summary>
    private void OnProductSearchChanged(QuotationItem item, string? searchValue)
    {
        item.ProductSearchValue = searchValue ?? string.Empty;
        
        if (string.IsNullOrWhiteSpace(searchValue))
        {
            // 空白搜尋：顯示前20筆
            item.FilteredProducts = Products.Take(20).ToList();
        }
        else
        {
            // 篩選符合的商品（編號或名稱包含搜尋字串）
            item.FilteredProducts = Products
                .Where(p => (p.Code?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                           (p.Name?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false))
                .Take(20)
                .ToList();
        }
        
        item.ShowProductDropdown = true;
        item.ProductSelectedIndex = -1;
        StateHasChanged();
    }
    
    /// <summary>
    /// 商品選擇事件（SearchableSelect）
    /// </summary>
    private async Task OnProductSelected(QuotationItem item, Product? selectedProduct)
    {
        if (selectedProduct != null)
        {
            item.SelectedProduct = selectedProduct;
            item.ProductSearchValue = $"[{selectedProduct.Code}] {selectedProduct.Name}";
            
            // 自動設定預設單位（如果商品有預設單位）
            if (selectedProduct.Unit != null)
            {
                item.SelectedUnit = selectedProduct.Unit;
            }
        }
        else
        {
            item.SelectedProduct = null;
            item.ProductSearchValue = string.Empty;
            item.SelectedUnit = null;
        }
        
        item.ShowProductDropdown = false;
        item.ProductSelectedIndex = -1;
        
        await NotifyDetailsChanged();
    }

    private async Task OnUnitSelectionChanged(QuotationItem item, string? unitIdStr)
    {
        // 檢查全域唯讀或個別明細已轉銷貨
        var hasConverted = item.ConvertedQuantity > 0;
        var isEmptyRow = item.SelectedProduct == null;
        if (IsReadOnly || (hasConverted && !isEmptyRow)) return;
        
        if (string.IsNullOrEmpty(unitIdStr) || !int.TryParse(unitIdStr, out var unitId))
        {
            item.SelectedUnit = null;
        }
        else
        {
            item.SelectedUnit = Units.FirstOrDefault(u => u.Id == unitId);
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnQuantityInput(QuotationItem item, string? value)
    {
        // 檢查全域唯讀或個別明細已轉銷貨
        var hasConverted = item.ConvertedQuantity > 0;
        var isEmptyRow = item.SelectedProduct == null;
        if (IsReadOnly || (hasConverted && !isEmptyRow)) return;
        
        if (string.IsNullOrEmpty(value))
        {
            item.Quantity = 0;
        }
        else if (decimal.TryParse(value, out var quantity))
        {
            item.Quantity = quantity;
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnUnitPriceInput(QuotationItem item, string? value)
    {
        // 檢查全域唯讀或個別明細已轉銷貨
        var hasConverted = item.ConvertedQuantity > 0;
        var isEmptyRow = item.SelectedProduct == null;
        if (IsReadOnly || (hasConverted && !isEmptyRow)) return;
        
        if (string.IsNullOrEmpty(value))
        {
            item.UnitPrice = 0;
        }
        else if (decimal.TryParse(value, out var unitPrice))
        {
            item.UnitPrice = unitPrice;
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnDiscountPercentageInput(QuotationItem item, string? value)
    {
        // 檢查全域唯讀或個別明細已轉銷貨
        var hasConverted = item.ConvertedQuantity > 0;
        var isEmptyRow = item.SelectedProduct == null;
        if (IsReadOnly || (hasConverted && !isEmptyRow)) return;
        
        if (string.IsNullOrEmpty(value))
        {
            item.DiscountPercentage = 0;
        }
        else if (decimal.TryParse(value, out var discount))
        {
            // 限制折扣百分比在 0-100 之間
            // 如果輸入值超過100，直接設為100並強制更新UI
            var limitedDiscount = Math.Max(0, Math.Min(100, discount));
            item.DiscountPercentage = limitedDiscount;
            
            // 如果值被限制了，強制刷新UI以顯示修正後的值
            if (limitedDiscount != discount)
            {
                StateHasChanged();
            }
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnRemarksInput(QuotationItem item, string? value)
    {
        item.Remarks = value ?? string.Empty;
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    public async Task RemoveItemAsync(int index)
    {
        if (IsReadOnly || index < 0 || index >= QuotationItems.Count) return;
        
        var removedItem = QuotationItems[index];
        
        // 檢查是否已轉銷貨，已轉銷貨的項目不允許刪除
        if (removedItem.ConvertedQuantity > 0)
        {
            await NotificationService.ShowWarningAsync("此明細已轉銷貨，無法刪除", "操作失敗");
            return;
        }
        
        // 記錄要刪除的資料庫實體ID
        if (removedItem.ExistingDetailEntity != null)
        {
            var entityId = GetExistingDetailId(removedItem.ExistingDetailEntity);
            if (entityId > 0)
            {
                _deletedDetailIds.Add(entityId);
            }
        }
        
        // 通知父組件項目即將被移除
        if (OnItemRemoved.HasDelegate)
        {
            await OnItemRemoved.InvokeAsync(removedItem);
        }
        
        QuotationItems.Remove(removedItem);
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    /// <summary>
    /// 取得現有明細實體的ID
    /// </summary>
    private int GetExistingDetailId(TDetailEntity entity)
    {
        if (entity == null) return 0;
        
        var idProperty = entity.GetType().GetProperty("Id");
        if (idProperty != null && idProperty.PropertyType == typeof(int))
        {
            var value = idProperty.GetValue(entity);
            return value != null ? (int)value : 0;
        }
        
        return 0;
    }

    /// <summary>
    /// 清除明細
    /// </summary>
    private async Task ClearAllDetails()
    {
        // 只清除未轉銷貨的項目
        var nonEmptyItems = QuotationItems.Where(item => item.SelectedProduct != null).ToList();
        var itemsToRemove = nonEmptyItems.Where(item => item.ConvertedQuantity == 0).ToList();
        var convertedItems = nonEmptyItems.Where(item => item.ConvertedQuantity > 0).ToList();
        
        if (!itemsToRemove.Any())
        {
            if (convertedItems.Any())
            {
                await NotificationService.ShowWarningAsync("所有明細項目都已轉銷貨，無法清除", "提示");
            }
            else
            {
                await NotificationService.ShowWarningAsync("沒有可清除的明細項目", "提示");
            }
            return;
        }
        
        // 通知父組件項目即將被移除
        if (OnItemRemoved.HasDelegate)
        {
            foreach (var item in itemsToRemove)
            {
                await OnItemRemoved.InvokeAsync(item);
            }
        }
        
        // 記錄所有要刪除的現有明細 ID
        foreach (var item in itemsToRemove.Where(item => item.ExistingDetailEntity != null))
        {
            var entityId = GetExistingDetailId(item.ExistingDetailEntity!);
            if (entityId > 0)
            {
                _deletedDetailIds.Add(entityId);
            }
        }
        
        // 從列表中移除所有可刪除的項目
        foreach (var item in itemsToRemove)
        {
            QuotationItems.Remove(item);
        }
        
        await NotifyDetailsChanged();
        
        var message = $"已清除 {itemsToRemove.Count} 項明細";
        if (convertedItems.Any())
        {
            message += $"，保留 {convertedItems.Count} 項已轉銷貨的明細";
        }
        await NotificationService.ShowSuccessAsync(message);
    }

    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        var nonEmptyItems = QuotationItems
            .Where(item => item.SelectedProduct != null)
            .ToList();
        
        if (nonEmptyItems.Count == 0)
        {
            errors.Add("至少需要一個報價商品");
        }
        else
        {
            // 檢查是否有選擇商品
            var itemsWithoutProduct = nonEmptyItems.Where(item => item.SelectedProduct == null).ToList();
            if (itemsWithoutProduct.Any())
            {
                errors.Add("所有明細都必須選擇商品");
            }
            
            // 檢查數量
            var itemsWithZeroQuantity = nonEmptyItems.Where(item => item.Quantity <= 0).ToList();
            if (itemsWithZeroQuantity.Any())
            {
                var productNames = itemsWithZeroQuantity
                    .Select(item => item.SelectedProduct?.Name ?? "未知商品")
                    .ToList();
                errors.Add($"以下商品的數量必須大於0：{string.Join("、", productNames)}");
            }
            
            // 檢查單價
            var itemsWithZeroPrice = nonEmptyItems.Where(item => item.UnitPrice <= 0).ToList();
            if (itemsWithZeroPrice.Any())
            {
                var productNames = itemsWithZeroPrice
                    .Select(item => item.SelectedProduct?.Name ?? "未知商品")
                    .ToList();
                errors.Add($"以下商品的單價必須大於0：{string.Join("、", productNames)}");
            }
        }
          
        if (errors.Any())
        {
            var errorMessage = string.Join("\n\n", errors);
            await NotificationService.ShowErrorAsync(errorMessage);
            return false;
        }
        
        return true;
    }

    // ===== 智能下單功能 =====
    
    /// <summary>
    /// 計算屬性：是否可以使用智能下單
    /// </summary>
    private bool CanUseSmartQuotation => 
        SelectedCustomerId.HasValue && 
        SelectedCustomerId.Value > 0;

    /// <summary>
    /// 智能下單主要方法
    /// </summary>
    private async Task SmartQuotation()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
        {
            await NotificationService.ShowWarningAsync("請先選擇客戶後再使用智能下單");
            return;
        }

        try
        {
            // 獲取該客戶最近一次的報價記錄
            var lastQuotationDetails = await QuotationDetailService.GetLastCompleteQuotationAsync(SelectedCustomerId.Value);
            
            if (!lastQuotationDetails.Any())
            {
                await NotificationService.ShowInfoAsync("該客戶沒有歷史報價記錄，無法使用智能下單");
                return;
            }

            // 檢查是否有現有資料
            var hasExistingData = QuotationItems.Any(item => item.SelectedProduct != null);
            
            if (hasExistingData)
            {
                // 使用確認對話框
                var confirmed = await ShowConfirmationAsync(
                    "確認覆蓋", 
                    "目前已有報價明細資料，是否要清除並載入上次的報價記錄？"
                );
                
                if (!confirmed)
                    return;
            }

            await LoadLastQuotationDetailsInternal(lastQuotationDetails);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"智能下單失敗：{ex.Message}");
        }
    }

    /// <summary>
    /// 顯示確認對話框
    /// </summary>
    private async Task<bool> ShowConfirmationAsync(string title, string message)
    {
        // 暫時使用簡單的通知，等待確認後執行
        // 在實際專案中可能會使用更精美的對話框組件
        try 
        {
            // 先顯示警告訊息，讓使用者知道將要進行的操作
            await NotificationService.ShowWarningAsync($"{title}: {message}");
            return true; // 暫時直接返回 true，實際應該實作確認對話框
        }
        catch
        {
            return false;
        }
    }

    /// <summary>
    /// 內部方法：載入上次報價明細
    /// </summary>
    private async Task LoadLastQuotationDetailsInternal(List<QuotationDetail> lastQuotationDetails)
    {
        try
        {
            // 開始載入資料 - 設定為未完成
            _dataLoadCompleted = false;
            
            // 清空現有項目
            QuotationItems.Clear();

            // 載入上次報價的所有商品明細
            foreach (var detail in lastQuotationDetails)
            {
                var item = new QuotationItem
                {
                    SelectedProduct = detail.Product,
                    SelectedUnit = detail.Unit,
                    ProductSearchValue = detail.Product != null ? 
                        $"[{detail.Product.Code}] {detail.Product.Name}" : string.Empty,
                    Quantity = detail.Quantity,
                    UnitPrice = detail.UnitPrice,
                    DiscountPercentage = detail.DiscountPercentage,
                    ConvertedQuantity = 0,  // 新報價單，轉單數量為0
                    Remarks = string.Empty,
                    ExistingDetailEntity = null  // 新項目，沒有現有實體
                };
                
                QuotationItems.Add(item);
            }

            // 通知父組件明細已變更
            await NotifyDetailsChanged();
            
            // 資料載入完成 - 觸發空行檢查
            _dataLoadCompleted = true;
            StateHasChanged();
            
            await NotificationService.ShowSuccessAsync(
                $"已成功載入上次報價的 {lastQuotationDetails.Count} 項商品明細"
            );
        }
        catch (Exception ex)
        {
            // 發生錯誤也要恢復載入完成狀態
            _dataLoadCompleted = true;
            await NotificationService.ShowErrorAsync($"載入上次報價明細失敗：{ex.Message}");
        }
    }

        public class QuotationItem
    {
        public Product? SelectedProduct { get; set; }
        public Unit? SelectedUnit { get; set; }
        public decimal Quantity { get; set; } = 0;
        public decimal UnitPrice { get; set; } = 0;
        public decimal DiscountPercentage { get; set; } = 0;
        public decimal ConvertedQuantity { get; set; } = 0;
        public string Remarks { get; set; } = string.Empty;
        public TDetailEntity? ExistingDetailEntity { get; set; }
        
        // SearchableSelect 支援屬性
        public string ProductSearchValue { get; set; } = string.Empty;
        public List<Product> FilteredProducts { get; set; } = new();
        public bool ShowProductDropdown { get; set; } = false;
        public int ProductSelectedIndex { get; set; } = -1;
        
        // Select 欄位綁定的 ID 屬性
        public string? UnitId
        {
            get => SelectedUnit?.Id.ToString();
            set
            {
                // 這個 setter 主要用於 InteractiveTableComponent 的 Select 綁定
                // 實際的 SelectedUnit 物件會在 OnUnitSelectionChanged 中設定
            }
        }
        
        /// <summary>
        /// 計算屬性：小計金額（數量 × 單價 × 折扣）
        /// </summary>
        public decimal SubtotalAmount => Quantity * UnitPrice * (1 - DiscountPercentage / 100);
        
        /// <summary>
        /// 計算屬性：未轉單數量
        /// </summary>
        public decimal RemainingQuantity => Quantity - ConvertedQuantity;
        
        /// <summary>
        /// 計算屬性：是否已完全轉單
        /// </summary>
        public bool IsFullyConverted => ConvertedQuantity >= Quantity;
        
        /// <summary>
        /// 計算屬性：顯示名稱（用於唯讀模式）
        /// </summary>
        public string DisplayName
        {
            get
            {
                if (SelectedProduct == null) return string.Empty;
                
                var parts = new List<string>();
                
                if (!string.IsNullOrEmpty(SelectedProduct.Code))
                    parts.Add($"[{SelectedProduct.Code}]");
                
                if (!string.IsNullOrEmpty(SelectedProduct.Name))
                    parts.Add(SelectedProduct.Name);
                
                return string.Join(" ", parts);
            }
        }
    }
}
