@* 沖款預收付款項管理組件 - 管理預收付款項的使用記錄 *@

@using ERPCore2.Helpers.NumericHelpers
@inject ISetoffPrepaymentService SetoffPrepaymentService
@inject ISetoffPrepaymentUsageService SetoffPrepaymentUsageService
@inject IPrepaymentTypeService PrepaymentTypeService
@inject INotificationService NotificationService
@inject RelatedDocumentsHelper RelatedDocumentsHelper

<div class="card-body p-0">
    <InteractiveTableComponent TItem="SetoffPrepaymentItem" 
                                Items="@PrepaymentItems"
                                ColumnDefinitions="@GetPrepaymentColumnDefinitions()"
                                IsReadOnly="@IsReadOnly"
                                ShowRowNumbers="false"
                                EmptyMessage="尚未新增預收付款項記錄"
                                ShowBuiltInActions="true"
                                ShowBuiltInDeleteButton="false"
                                CustomActionsTemplate="@GetCustomActionsTemplate"
                                OnItemDelete="@HandleRemovePrepaymentRecord"
                                ActionsColumnWidth = "60px"
                                EnableAutoEmptyRow="true"
                                DataLoadCompleted="@_dataLoadCompleted"
                                CreateEmptyItem="@CreateEmptyItem" />
</div>

<!-- 相關單據查看 Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedPrepaymentName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

@code {
    // ===== 私有欄位 =====
    private bool _dataLoadCompleted = true;  // 資料載入完成標記
    
    // ===== 參數定義 =====
    [Parameter] public int? SetoffDocumentId { get; set; }
    [Parameter] public int? CustomerId { get; set; }
    [Parameter] public int? SupplierId { get; set; }
    [Parameter] public SetoffType SetoffType { get; set; } // 新增：沖款類型（應收/應付）
    [Parameter] public string? SetoffDocumentNumber { get; set; } // 沖款單號（用於設定來源單號）
    
    // 資料綁定
    [Parameter] public List<SetoffPrepayment> ExistingPrepayments { get; set; } = new();
    [Parameter] public EventCallback<List<SetoffPrepayment>> OnPrepaymentsChanged { get; set; }
    
    // 顯示控制
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== 相關單據開啟事件 =====
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }
    
    // ===== 內部狀態 =====
    private List<SetoffPrepaymentItem> PrepaymentItems { get; set; } = new();
    private List<SetoffPrepayment> AvailablePrepayments { get; set; } = new();
    private List<PrepaymentType> AllPrepaymentTypes { get; set; } = new();
    private List<PrepaymentType> FilteredPrepaymentTypes { get; set; } = new();
    
    // 用於追蹤參數變更，避免不必要的重新載入
    private int? _previousCustomerId;
    private int? _previousSupplierId;
    private int _previousExistingPrepaymentsCount;

    // ===== 相關單據查看 =====
    private bool showRelatedDocumentsModal = false;
    private string selectedPrepaymentName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;

    // ===== 計算屬性 =====
    /// <summary>
    /// 取得總金額（預收/預付類型的 Amount + 轉沖款類型的 UsedAmount）
    /// </summary>
    private decimal TotalUsedAmount => PrepaymentItems
        .Where(p => p.PrepaymentTypeId.HasValue && p.PrepaymentTypeId.Value > 0)
        .Sum(p =>
        {
            // 判斷是否為轉沖款類型
            if (p.PrepaymentTypeId.HasValue)
            {
                var selectedType = FilteredPrepaymentTypes.FirstOrDefault(pt => pt.Id == p.PrepaymentTypeId.Value);
                if (selectedType != null && IsTransferType(selectedType.Name))
                {
                    // 轉沖款類型：計算 UsedAmount
                    return p.UsedAmount;
                }
            }
            // 預收/預付類型：計算 Amount
            return p.Amount;
        });

    // ===== 生命週期方法 =====
    protected override async Task OnInitializedAsync()
    {
        await LoadPrepaymentTypesAsync();
        // 此時不篩選類型，因為 SetoffType 參數可能還未設定
        // FilterPrepaymentTypes() 會在 OnParametersSetAsync() 中執行
        await LoadAvailablePrepaymentsAsync();
        LoadExistingPrepayments();
        
        // 初始化追蹤變數
        _previousCustomerId = CustomerId;
        _previousSupplierId = SupplierId;
        _previousExistingPrepaymentsCount = ExistingPrepayments?.Count ?? 0;
    }

    protected override async Task OnParametersSetAsync()
    {
        // 篩選預收付類型（確保 SetoffType 已正確設定）
        FilterPrepaymentTypes();
        
        // 只有當 CustomerId 或 SupplierId 真正變更時，才重新載入可用的預收付款項
        if (_previousCustomerId != CustomerId || _previousSupplierId != SupplierId)
        {
            await LoadAvailablePrepaymentsAsync();
            _previousCustomerId = CustomerId;
            _previousSupplierId = SupplierId;
        }
        
        // 只有當 ExistingPrepayments 真正變更時（數量不同），才重新載入資料
        var currentCount = ExistingPrepayments?.Count ?? 0;
        if (_previousExistingPrepaymentsCount != currentCount)
        {
            LoadExistingPrepayments();
            _previousExistingPrepaymentsCount = currentCount;
        }
        
        await base.OnParametersSetAsync();
    }

    // ===== 建立空項目方法 =====
    
    /// <summary>
    /// 創建空的預收付款項記錄項目
    /// </summary>
    private SetoffPrepaymentItem CreateEmptyItem()
    {
        return new SetoffPrepaymentItem
        {
            Id = 0,
            PrepaymentTypeId = null,
            SourcePrepaymentId = null,
            SourceDocumentCode = string.Empty,
            Amount = 0,
            UsedAmount = 0,
            Remarks = null,
            ExistingPrepayment = null
        };
    }

    // ===== 資料載入方法 =====
    
    /// <summary>
    /// 載入所有預收付類型
    /// </summary>
    private async Task LoadPrepaymentTypesAsync()
    {
        try
        {
            AllPrepaymentTypes = await PrepaymentTypeService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入預收付類型失敗：{ex.Message}");
            AllPrepaymentTypes = new List<PrepaymentType>();
            FilteredPrepaymentTypes = new List<PrepaymentType>();
        }
    }
    
    /// <summary>
    /// 根據沖款類型篩選預收付類型
    /// 應收：顯示「預收」和「預收轉沖款」
    /// 應付：顯示「預付」和「預付轉沖款」
    /// </summary>
    private void FilterPrepaymentTypes()
    {
        if (AllPrepaymentTypes == null || !AllPrepaymentTypes.Any())
        {
            FilteredPrepaymentTypes = new List<PrepaymentType>();
            return;
        }
        
        if (SetoffType == SetoffType.AccountsReceivable)
        {
            // 應收帳款：顯示所有「預收」相關類型（包括預收和預收轉沖款）
            FilteredPrepaymentTypes = AllPrepaymentTypes
                .Where(pt => pt.Name.Contains("預收"))
                .ToList();
        }
        else if (SetoffType == SetoffType.AccountsPayable)
        {
            // 應付帳款：顯示所有「預付」相關類型（包括預付和預付轉沖款）
            FilteredPrepaymentTypes = AllPrepaymentTypes
                .Where(pt => pt.Name.Contains("預付"))
                .ToList();
        }
        else
        {
            FilteredPrepaymentTypes = new List<PrepaymentType>();
        }
    }
    
    private async Task LoadAvailablePrepaymentsAsync()
    {
        try
        {
            // 根據客戶或供應商載入可用的預收付款項
            if (CustomerId.HasValue && CustomerId.Value > 0)
            {
                AvailablePrepayments = await SetoffPrepaymentService.GetAvailableByCustomerIdAsync(CustomerId.Value);
            }
            else if (SupplierId.HasValue && SupplierId.Value > 0)
            {
                AvailablePrepayments = await SetoffPrepaymentService.GetAvailableBySupplierIdAsync(SupplierId.Value);
            }
            else
            {
                AvailablePrepayments = new List<SetoffPrepayment>();
            }
            
            //  載入可用預收付款項後，自動比對並設定編輯模式下的 SourcePrepaymentId
            MatchSourcePrepaymentIds();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入可用預收付款項失敗：{ex.Message}");
            AvailablePrepayments = new List<SetoffPrepayment>();
        }
    }
    
    /// <summary>
    /// 自動比對並設定 SourcePrepaymentId（編輯模式用）
    /// </summary>
    private void MatchSourcePrepaymentIds()
    {
        if (!PrepaymentItems.Any() || !AvailablePrepayments.Any())
            return;
        
        foreach (var item in PrepaymentItems)
        {
            // 只處理轉沖款類型且尚未設定 SourcePrepaymentId 的項目
            if (!item.PrepaymentTypeId.HasValue)
                continue;
            
            var selectedType = FilteredPrepaymentTypes?.FirstOrDefault(pt => pt.Id == item.PrepaymentTypeId.Value);
            if (selectedType == null || !IsTransferType(selectedType.Name))
                continue;
            
            // 如果已經有 SourcePrepaymentId，不需要再比對
            if (item.SourcePrepaymentId.HasValue && item.SourcePrepaymentId.Value > 0)
                continue;
            
            // 根據 SourceDocumentCode 查詢對應的來源預收付款項
            if (!string.IsNullOrEmpty(item.SourceDocumentCode))
            {
                var sourcePrepayment = AvailablePrepayments.FirstOrDefault(p => p.SourceDocumentCode == item.SourceDocumentCode);
                if (sourcePrepayment != null)
                {
                    item.SourcePrepaymentId = sourcePrepayment.Id;
                    
                    // 同時設定 Amount（來源的總金額，用於顯示）
                    if (item.Amount == 0)
                    {
                        item.Amount = sourcePrepayment.Amount;
                    }
                }
            }
        }
    }

    private void LoadExistingPrepayments()
    {
        if (ExistingPrepayments?.Any() == true)
        {
            // 編輯模式：載入已存在的預收付款項記錄
            
            PrepaymentItems = ExistingPrepayments.Select((prepayment, index) => 
            {
                //  直接使用 SourcePrepaymentId 欄位（不再從 Remarks 解析）
                var item = new SetoffPrepaymentItem
                {
                    Id = prepayment.Id,
                    PrepaymentTypeId = prepayment.PrepaymentTypeId,
                    SourcePrepaymentId = prepayment.SourcePrepaymentId,  //  直接使用資料庫欄位
                    SourceDocumentCode = prepayment.SourceDocumentCode,
                    Amount = prepayment.Amount,
                    UsedAmount = prepayment.UsedAmount,
                    Remarks = prepayment.Remarks,
                    ExistingPrepayment = prepayment
                };
                
                return item;
            }).ToList();
            
            //  載入後立即嘗試比對 SourcePrepaymentId（如果 AvailablePrepayments 已載入）
            if (AvailablePrepayments?.Any() == true)
            {
                MatchSourcePrepaymentIds();
            }
        }
        else
        {
            // 新增模式：初始化為空列表
            PrepaymentItems = new List<SetoffPrepaymentItem>();
        }
    }

    // ===== InteractiveTable 欄位定義 =====
    private List<InteractiveColumnDefinition> GetPrepaymentColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = "預收付類型",
                Tooltip = "選擇預收款、預付款或轉沖款類型",
                PropertyName = nameof(SetoffPrepaymentItem.PrepaymentTypeId),
                ColumnType = InteractiveColumnType.Select,
                Width = "180px",
                Options = new List<InteractiveSelectOption> 
                { 
                    new InteractiveSelectOption { Value = 0, Text = "請選擇類型.." } 
                }
                .Concat((FilteredPrepaymentTypes ?? new List<PrepaymentType>()).Select(pt => new InteractiveSelectOption
                { 
                    Value = pt.Id, 
                    Text = pt.Name 
                })).ToList(),
                OnSelectionChanged = EventCallback.Factory.Create<(object, object?)>(this, async args =>
                {
                    var (itemObj, value) = args;
                    var item = (SetoffPrepaymentItem)itemObj;
                    
                    if (value != null && int.TryParse(value.ToString(), out int typeId) && typeId > 0)
                    {
                        item.PrepaymentTypeId = typeId;
                        
                        // 判斷是否需要顯示來源單號欄位
                        var selectedType = FilteredPrepaymentTypes!.FirstOrDefault(pt => pt.Id == typeId);
                        if (selectedType != null && !IsTransferType(selectedType.Name))
                        {
                            // 非轉沖款類型：清空來源相關欄位，設定來源單號為沖款單號
                            item.SourcePrepaymentId = null;
                            item.SourceDocumentCode = SetoffDocumentNumber ?? string.Empty;
                            item.Amount = 0;
                        }
                    }
                    else
                    {
                        item.PrepaymentTypeId = null;
                        item.SourcePrepaymentId = null;
                        item.SourceDocumentCode = string.Empty;
                        item.Amount = 0;
                        item.UsedAmount = 0;
                    }
                    
                    await NotifyPrepaymentsChanged();
                    StateHasChanged();
                })
            },

            new()
            {
                Title = "來源單號",
                Tooltip = "預收/預付類型：顯示沖款單號；轉沖款類型：選擇要使用的預收付款項來源單據",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "250px",
                CustomTemplate = item =>
                {
                    var prepaymentItem = (SetoffPrepaymentItem)item;
                    
                    // 如果未選擇類型，顯示 "-"
                    if (!prepaymentItem.PrepaymentTypeId.HasValue)
                        return @<span class="text-muted">-</span>;
                    
                    var selectedType = FilteredPrepaymentTypes!.FirstOrDefault(pt => pt.Id == prepaymentItem.PrepaymentTypeId.Value);
                    if (selectedType == null)
                        return @<span class="text-muted">-</span>;
                    
                    // 判斷是否為轉沖款類型
                    if (!IsTransferType(selectedType.Name))
                    {
                        // 預收/預付類型：顯示來源單號（沖款單號）
                        var sourceCode = string.IsNullOrEmpty(prepaymentItem.SourceDocumentCode) 
                            ? "-" 
                            : prepaymentItem.SourceDocumentCode;
                        return @<span class="text-muted">@sourceCode</span>;
                    }
                    
                    // 轉沖款類型：顯示下拉選單
                    // 建立下拉選單選項
                    var options = new List<InteractiveSelectOption> 
                    { 
                        new InteractiveSelectOption { Value = 0, Text = "請選擇預收付款項.." } 
                    };
                    
                    // 加入可用的預收付款項
                    var availableOptions = AvailablePrepayments.Select(p => new InteractiveSelectOption
                    { 
                        Value = p.Id, 
                        Text = $"{p.SourceDocumentCode} (金額: {NumberFormatHelper.FormatSmart(p.Amount)}, 剩餘: {NumberFormatHelper.FormatSmart(p.AvailableBalance)})" 
                    });
                    options.AddRange(availableOptions);
                    
                    var currentValue = prepaymentItem.SourcePrepaymentId ?? 0;
                    
                    //  編輯模式：如果當前選中的項目不在 AvailablePrepayments 中，需要加入到選項清單
                    // 這種情況發生在：來源預收付款項已經用完，不再顯示在可用清單中
                    if (currentValue > 0 && !options.Any(o => o.Value.Equals(currentValue)))
                    {
                        // 使用 SourceDocumentCode 和 Amount 顯示（因為 AvailablePrepayments 中找不到）
                        var displayText = !string.IsNullOrEmpty(prepaymentItem.SourceDocumentCode)
                            ? $"{prepaymentItem.SourceDocumentCode} (金額: {NumberFormatHelper.FormatSmart(prepaymentItem.Amount)})"
                            : "未知來源";
                        
                        // 插入到第二個位置（"請選擇..."之後）
                        options.Insert(1, new InteractiveSelectOption
                        {
                            Value = currentValue,
                            Text = displayText
                        });
                    }
                    
                    // 直接綁定到 item 的屬性，不使用局部變數
                    return @<select class="form-select form-select-sm" 
                                    value="@currentValue"
                                    disabled="@IsReadOnly"
                                    @onchange="@(async e => await OnSourcePrepaymentChangedAsync(prepaymentItem, e.Value?.ToString()))">
                        @foreach (var option in options)
                        {
                            <option value="@option.Value">@option.Text</option>
                        }
                    </select>;
                }
            },
            new()
            {
                Title = "總金額",
                Tooltip = "預收/預付類型：本次收付的總金額；轉沖款類型：來源預收付款項的原始總金額",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "120px",
                CustomTemplate = item =>
                {
                    var prepaymentItem = (SetoffPrepaymentItem)item;
                    
                    // 如果未選擇類型，顯示 "-"
                    if (!prepaymentItem.PrepaymentTypeId.HasValue)
                        return @<span class="text-muted">-</span>;
                    
                    var selectedType = FilteredPrepaymentTypes!.FirstOrDefault(pt => pt.Id == prepaymentItem.PrepaymentTypeId.Value);
                    if (selectedType == null)
                        return @<span class="text-muted">-</span>;
                    
                    if (IsTransferType(selectedType.Name))
                    {
                        // 轉沖款類型：顯示來源預收付款項的總金額
                        // 優先使用 item.Amount（編輯模式時已經設定好）
                        // 如果 Amount 為 0，則從 AvailablePrepayments 查詢（新增模式）
                        var amount = prepaymentItem.Amount;
                        if (amount == 0 && prepaymentItem.SourcePrepaymentId.HasValue)
                        {
                            var sourcePrepayment = AvailablePrepayments.FirstOrDefault(p => p.Id == prepaymentItem.SourcePrepaymentId);
                            amount = sourcePrepayment?.Amount ?? 0;
                        }
                        return @<span class="text-muted">@NumberFormatHelper.FormatSmart(amount)</span>;
                    }
                    else
                    {
                        // 預收/預付類型：顯示本次收付的金額（即 Amount）
                        return @<span class="text-muted">@NumberFormatHelper.FormatSmart(prepaymentItem.Amount)</span>;
                    }
                }
            },
            new()
            {
                Title = "可用餘額",
                Tooltip = "預收/預付類型（編輯模式）：顯示此預收付款項的剩餘可用金額；轉沖款類型：顯示來源預收付款項的可用餘額（編輯模式下會動態調整）",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "120px",
                CustomTemplate = item =>
                {
                    var prepaymentItem = (SetoffPrepaymentItem)item;
                    
                    // 檢查是否選擇了類型
                    if (!prepaymentItem.PrepaymentTypeId.HasValue)
                        return @<span class="text-muted">-</span>;
                    
                    var selectedType = FilteredPrepaymentTypes!.FirstOrDefault(pt => pt.Id == prepaymentItem.PrepaymentTypeId.Value);
                    if (selectedType == null)
                        return @<span class="text-muted">-</span>;

                    if (IsTransferType(selectedType.Name))
                    {
                        // 轉沖款類型：使用 AdjustedBalanceHelper 計算動態調整後的可用餘額
                        var sourcePrepayment = AvailablePrepayments.FirstOrDefault(p => p.Id == prepaymentItem.SourcePrepaymentId);
                        if (sourcePrepayment == null)
                            return @<span class="text-muted">-</span>;
                        
                        var baseAvailableBalance = sourcePrepayment.AvailableBalance;
                        var originalUsedAmount = prepaymentItem.ExistingPrepayment?.UsedAmount ?? 0;
                        var currentUsedAmount = prepaymentItem.UsedAmount;
                        
                        var adjustedBalance = AdjustedBalanceHelper.CalculateAdjustedBalance(
                            baseAvailableBalance,
                            originalUsedAmount,
                            currentUsedAmount,
                            IsEditMode());
                        
                        return @<span class="text-primary fw-bold">@NumberFormatHelper.FormatSmart(adjustedBalance)</span>;
                    }
                    else
                    {
                        // 預收/預付類型：只在編輯模式下顯示此預收付款項的可用餘額
                        if (IsEditMode() && prepaymentItem.ExistingPrepayment != null)
                        {
                            // 編輯模式：計算可用餘額 = 總金額 - 已用金額
                            var availableBalance = prepaymentItem.ExistingPrepayment.Amount - prepaymentItem.ExistingPrepayment.UsedAmount;
                            return @<span class="text-success fw-bold">@NumberFormatHelper.FormatSmart(availableBalance)</span>;
                        }
                        else
                        {
                            // 新增模式：顯示 "-"（因為還沒建立，沒有可用餘額的概念）
                            return @<span class="text-muted">-</span>;
                        }
                    }
                }
            },
            new()
            {
                Title = "金額",
                Tooltip = "預收/預付類型：輸入本次收付金額；轉沖款類型：輸入本次使用金額",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "150px",
                CustomTemplate = item =>
                {
                    var prepaymentItem = (SetoffPrepaymentItem)item;
                    
                    // 檢查是否為轉沖款類型
                    bool isTransferType = false;
                    if (prepaymentItem.PrepaymentTypeId.HasValue)
                    {
                        var selectedType = FilteredPrepaymentTypes!.FirstOrDefault(pt => pt.Id == prepaymentItem.PrepaymentTypeId.Value);
                        isTransferType = selectedType != null && IsTransferType(selectedType.Name);
                    }
                    
                    // 根據類型決定顯示的值
                    var displayValue = isTransferType ? prepaymentItem.UsedAmount : prepaymentItem.Amount;
                    var formattedValue = NumberFormatHelper.FormatForInput(displayValue);
                    
                    return @<input type="number" 
                                   class="form-control  text-end" 
                                   value="@formattedValue" 
                                   onkeydown="if(['e','E','+','-'].includes(event.key)) event.preventDefault();"
                                   disabled="@IsReadOnly"
                                   step="1"
                                   min="0"
                                   placeholder=""
                                   @oninput="@(e => OnAmountInput(prepaymentItem, e.Value?.ToString()))" />;
                }
            },
            new()
            {
                Title = "備註",
                Tooltip = "備註說明",
                PropertyName = nameof(SetoffPrepaymentItem.Remarks),
                ColumnType = InteractiveColumnType.Input,
                Width = "200px",
                IsRequired = false,
                OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
                {
                    var (itemObj, value) = args;
                    var item = (SetoffPrepaymentItem)itemObj;
                    
                    item.Remarks = value;
                    
                    // 備註變更時也需要通知父組件，以便正確追蹤變更
                    await NotifyPrepaymentsChanged();
                    StateHasChanged();
                })
            }
        };

        return columns;
    }
    
    private RenderFragment<SetoffPrepaymentItem> GetCustomActionsTemplate => item => __builder =>
    {
        // 檢查項目是否可以刪除（只在編輯模式下才需要檢查）
        bool canDelete = !IsEditMode();
        
        // 檢查是否可以查看相關單據（只有「預收/預付」類型且已儲存的記錄）
        bool canViewRelated = false;
        if (item.PrepaymentTypeId.HasValue && item.Id > 0)
        {
            var selectedType = FilteredPrepaymentTypes?.FirstOrDefault(pt => pt.Id == item.PrepaymentTypeId.Value);
            canViewRelated = selectedType != null && !IsTransferType(selectedType.Name);
        }
        
        if (canDelete)
        {
            // 可以刪除：顯示刪除按鈕
            <GenericButtonComponent Variant="ButtonVariant.Danger"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="@IsReadOnly"
                                   Title="刪除"
                                   OnClick="async () => await HandleRemovePrepaymentRecord(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else if (canViewRelated)
        {
            // 編輯模式且可以查看相關單據：顯示查看按鈕
            <GenericButtonComponent Variant="ButtonVariant.Info"
                                   IconClass="bi bi-eye text-white"
                                   Size="ButtonSize.Large"
                                   Title="查看相關沖款單"
                                   OnClick="async () => await ShowRelatedDocuments(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else
        {
            // 編輯模式但不能查看相關單據：顯示空白或禁用狀態
            <span class="text-muted">-</span>
        }
    };
    
    /// <summary>
    /// 判斷是否為轉沖款類型（預收轉沖款、預付轉沖款）
    /// </summary>
    private bool IsTransferType(string typeName)
    {
        return typeName.Contains("轉沖款");
    }
    
    /// <summary>
    /// 處理來源預收付款項變更
    /// </summary>
    private async Task OnSourcePrepaymentChangedAsync(SetoffPrepaymentItem item, string? value)
    {
        if (value != null && int.TryParse(value, out int prepaymentId) && prepaymentId > 0)
        {
            item.SourcePrepaymentId = prepaymentId;
            
            // 自動帶入來源預收付款項的資訊
            var selectedPrepayment = AvailablePrepayments.FirstOrDefault(p => p.Id == prepaymentId);
            if (selectedPrepayment != null)
            {
                item.SourceDocumentCode = selectedPrepayment.SourceDocumentCode;
                //  轉沖款類型：Amount 為來源的總金額（用於顯示），UsedAmount 為可用餘額
                item.Amount = selectedPrepayment.Amount;  // 設定來源的總金額
                item.UsedAmount = selectedPrepayment.AvailableBalance;
            }
        }
        else
        {
            item.SourcePrepaymentId = null;
            item.SourceDocumentCode = string.Empty;
            item.Amount = 0;
            item.UsedAmount = 0;
        }
        
        await NotifyPrepaymentsChanged();
        // 不呼叫 StateHasChanged()，讓 Blazor 自動處理渲染
    }

    // ===== 事件處理方法 =====
    private async Task HandleRemovePrepaymentRecord(SetoffPrepaymentItem item)
    {
        if (IsReadOnly) return;
        
        PrepaymentItems.Remove(item);
        
        await NotificationService.ShowInfoAsync("已移除預收付款項記錄");
        await NotifyPrepaymentsChanged();
        StateHasChanged();
    }

    private async Task OnAmountInput(SetoffPrepaymentItem item, string? value)
    {
        // 判斷是否為轉沖款類型
        bool isTransferType = false;
        if (item.PrepaymentTypeId.HasValue)
        {
            var selectedType = FilteredPrepaymentTypes.FirstOrDefault(pt => pt.Id == item.PrepaymentTypeId.Value);
            isTransferType = selectedType != null && IsTransferType(selectedType.Name);
        }
        
        if (decimal.TryParse(value, out var amount))
        {
            if (isTransferType)
            {
                // 轉沖款類型：輸入的是 UsedAmount，使用 AdjustedBalanceHelper 驗證
                var sourcePrepayment = AvailablePrepayments.FirstOrDefault(p => p.Id == item.SourcePrepaymentId);
                if (sourcePrepayment != null)
                {
                    var originalUsedAmount = item.ExistingPrepayment?.UsedAmount ?? 0;
                    
                    // 使用 AdjustedBalanceHelper 驗證金額
                    var isValid = AdjustedBalanceHelper.ValidateAmount(
                        amount,
                        sourcePrepayment.AvailableBalance,
                        originalUsedAmount,
                        IsEditMode());
                    
                    if (!isValid)
                    {
                        // 計算最大可用金額
                        var maxAvailable = AdjustedBalanceHelper.CalculateAdjustedBalance(
                            sourcePrepayment.AvailableBalance,
                            originalUsedAmount,
                            0,
                            IsEditMode());
                        
                        // 不允許超過可用餘額，直接設為最大可用金額
                        item.UsedAmount = maxAvailable;
                        await NotificationService.ShowWarningAsync($"使用金額不能超過可用餘額 {NumberFormatHelper.FormatSmart(maxAvailable)}");
                    }
                    else if (amount < 0)
                    {
                        // 不允許負數
                        item.UsedAmount = 0;
                        await NotificationService.ShowWarningAsync("使用金額不能小於 0");
                    }
                    else
                    {
                        item.UsedAmount = amount;
                    }
                }
                else
                {
                    item.UsedAmount = amount;
                }
            }
            else
            {
                // 預收/預付類型：輸入的是 Amount
                if (amount < 0)
                {
                    item.Amount = 0;
                    await NotificationService.ShowWarningAsync("金額不能小於 0");
                }
                else
                {
                    item.Amount = amount;
                }
            }
        }
        else if (string.IsNullOrWhiteSpace(value))
        {
            // 如果輸入為空白，設為0
            if (isTransferType)
            {
                item.UsedAmount = 0;
            }
            else
            {
                item.Amount = 0;
            }
        }
        
        await NotifyPrepaymentsChanged();
        StateHasChanged();
    }

    private async Task NotifyPrepaymentsChanged()
    {
        // 只傳遞非空行的預收付款項記錄
        // ✅ 修正：直接使用 item 的欄位值，不要從 AvailablePrepayments 重新查詢，避免資料被覆蓋
        var prepayments = PrepaymentItems
            .Where(item => item.PrepaymentTypeId.HasValue && item.PrepaymentTypeId.Value > 0)
            .Select(item => new SetoffPrepayment
            {
                // 統一使用 ExistingPrepayment?.Id，與 SetoffPaymentTable 保持一致
                Id = item.ExistingPrepayment?.Id ?? 0,
                SetoffDocumentId = SetoffDocumentId ?? 0,
                PrepaymentTypeId = item.PrepaymentTypeId ?? 0,
                SourceDocumentCode = item.SourceDocumentCode,  // ✅ 直接使用 item 的值
                SourcePrepaymentId = item.SourcePrepaymentId,
                Amount = item.Amount,  // ✅ 直接使用 item 的值
                UsedAmount = item.UsedAmount,  // ✅ 直接使用 item 的值
                CustomerId = CustomerId,  // ✅ 使用參數傳入的值
                SupplierId = SupplierId,  // ✅ 使用參數傳入的值
                Remarks = item.Remarks,
                // 重要：不設定導航屬性，避免 EF Core 追蹤衝突
                PrepaymentType = null!,
                Customer = null,
                Supplier = null,
                SetoffDocument = null,
                SourcePrepayment = null
            })
            .ToList();

        await OnPrepaymentsChanged.InvokeAsync(prepayments);
    }

    // ===== 公開方法（供父組件調用）=====
    
    /// <summary>
    /// 取得總使用金額
    /// </summary>
    public decimal GetTotalUsedAmount() => TotalUsedAmount;

    /// <summary>
    /// 驗證預收付款項記錄
    /// </summary>
    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        var nonEmptyItems = PrepaymentItems
            .Where(item => item.PrepaymentTypeId.HasValue && item.PrepaymentTypeId.Value > 0)
            .ToList();
        
        foreach (var item in nonEmptyItems)
        {
            // 檢查是否選擇了預收付類型
            if (!item.PrepaymentTypeId.HasValue || item.PrepaymentTypeId.Value <= 0)
            {
                errors.Add("請選擇預收付類型");
                continue;
            }
            
            var selectedType = FilteredPrepaymentTypes.FirstOrDefault(pt => pt.Id == item.PrepaymentTypeId.Value);
            if (selectedType != null && IsTransferType(selectedType.Name))
            {
                // 轉沖款類型：必須選擇來源預收付款項
                if (!item.SourcePrepaymentId.HasValue || item.SourcePrepaymentId.Value <= 0)
                {
                    errors.Add("轉沖款類型必須選擇來源預收付款項");
                    continue;
                }
                
                // 使用 AdjustedBalanceHelper 檢查使用金額是否超過可用餘額
                var sourcePrepayment = AvailablePrepayments.FirstOrDefault(p => p.Id == item.SourcePrepaymentId);
                if (sourcePrepayment != null)
                {
                    var originalUsedAmount = item.ExistingPrepayment?.UsedAmount ?? 0;
                    
                    var isValid = AdjustedBalanceHelper.ValidateAmount(
                        item.UsedAmount,
                        sourcePrepayment.AvailableBalance,
                        originalUsedAmount,
                        IsEditMode());
                    
                    if (!isValid)
                    {
                        var maxAvailable = AdjustedBalanceHelper.CalculateAdjustedBalance(
                            sourcePrepayment.AvailableBalance,
                            originalUsedAmount,
                            0,
                            IsEditMode());
                        
                        errors.Add($"來源單號 {sourcePrepayment.SourceDocumentCode} 的使用金額超過可用餘額（最大可用：{NumberFormatHelper.FormatSmart(maxAvailable)}）");
                    }
                }
                
                // 轉沖款類型：檢查 UsedAmount 必須大於 0
                if (item.UsedAmount <= 0)
                {
                    errors.Add("使用金額必須大於 0");
                }
            }
            else if (selectedType != null)
            {
                //  預收/預付類型：檢查 Amount 必須大於 0
                if (item.Amount <= 0)
                {
                    errors.Add("金額必須大於 0");
                }
            }
        }
        
        if (errors.Any())
        {
            var errorMessage = string.Join("\n", errors);
            await NotificationService.ShowErrorAsync(errorMessage);
            return false;
        }
        
        return true;
    }
    
    /// <summary>
    /// 判斷是否為編輯模式（編輯模式下不允許刪除明細）
    /// </summary>
    private bool IsEditMode()
    {
        return SetoffDocumentId.HasValue && SetoffDocumentId.Value > 0;
    }

    // ===== 相關單據查看方法 =====
    
    /// <summary>
    /// 顯示相關單據（使用此預收付款項的沖款單）
    /// </summary>
    private async Task ShowRelatedDocuments(SetoffPrepaymentItem item)
    {
        // 檢查是否有有效的 ID
        if (item.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("此記錄尚未儲存，無法查詢相關單據");
            return;
        }
        
        // 設定顯示名稱
        var typeName = FilteredPrepaymentTypes?.FirstOrDefault(pt => pt.Id == item.PrepaymentTypeId)?.Name ?? "預收付款項";
        selectedPrepaymentName = $"{typeName} - {item.SourceDocumentCode}";
        
        // 顯示 Modal 並開始載入
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();
        
        try
        {
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsForPrepaymentAsync(item.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入相關單據失敗：{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// 處理點擊相關單據的事件
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // 觸發事件，讓父組件（EditModal）處理開啟相關單據
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            await NotificationService.ShowInfoAsync(
                $"請在父組件中實作 OnOpenRelatedDocument 事件來開啟 {document.TypeDisplayName}：{document.DocumentNumber}");
        }
    }

    // ===== 內部資料類別 =====
    private class SetoffPrepaymentItem : BaseEntity
    {
        public int? PrepaymentTypeId { get; set; }
        public int? SourcePrepaymentId { get; set; }
        public string SourceDocumentCode { get; set; } = string.Empty;
        public decimal Amount { get; set; }
        public decimal UsedAmount { get; set; }
        public SetoffPrepayment? ExistingPrepayment { get; set; }
        // Remarks 繼承自 BaseEntity
    }
}
