@* æ²–éŠ·å•†å“æ˜ç´°ç®¡ç†çµ„ä»¶ - æ”¯æ´æ‡‰æ”¶/æ‡‰ä»˜é›™æ¨¡å¼ *@

@inject ISetoffProductDetailService SetoffProductDetailService
@inject IProductService ProductService
@inject INotificationService NotificationService
@using ERPCore2.Components.Shared.SubCollections

@if (!RelatedPartyId.HasValue || RelatedPartyId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="warning-message">
                <i class="bi bi-exclamation-triangle text-warning fs-1 mb-3"></i>
                <p class="text-muted">@GetRelatedPartyWarningMessage()</p>
            </div>
        </div>
    </div>
}
else
{
    @* æœ¬æ¬¡æ²–æ¬¾æ˜ç´°ç·¨è¼¯ - ç›´æ¥é¡¯ç¤ºæ‰€æœ‰æœªçµæ¸…æ˜ç´° *@
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent TItem="SetoffProductDetailItem" 
                                      Items="@SetoffItems"
                                      ColumnDefinitions="@GetSetoffColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"
                                      ShowRowNumbers="false"
                                      EmptyMessage="@GetUnsettledEmptyMessage()"
                                      ShowBuiltInActions="@(!IsEditMode())"
                                      ShowBuiltInDeleteButton="@(!IsEditMode())"
                                      OnItemDelete="@HandleRemoveItem"
                                      ShowActions="false"
                                      ActionsColumnWidth = "60px" />
        </div>

        <div class="card-footer">
            <div class="d-flex justify-content-end gap-2">
                <GenericButtonComponent Text="å…¨éƒ¨æ²–æ¬¾"
                                      Variant="ButtonVariant.Green"
                                      OnClick="FillAllSetoffAmounts"
                                      IsDisabled="@(SetoffItems.Count == 0 || IsReadOnly || !SetoffItems.Any())" />
                <GenericButtonComponent Text="æ²–æ¬¾æ¸…ç©º"
                                      Variant="ButtonVariant.Red"
                                      OnClick="ClearAllSetoffAmounts"
                                      IsDisabled="@(SetoffItems.Count == 0 || IsReadOnly || !SetoffItems.Any())" />
            </div>
        </div>
    </div>
}

@code {
    // ===== åƒæ•¸å®šç¾© =====
    [Parameter] public int? SetoffDocumentId { get; set; }
    [Parameter] public SetoffType SetoffType { get; set; }
    [Parameter] public int? RelatedPartyId { get; set; }
    [Parameter] public string RelatedPartyType { get; set; } = string.Empty;
    [Parameter] public DateTime? StartDate { get; set; }
    [Parameter] public DateTime? EndDate { get; set; }
    
    // è³‡æ–™ç¶å®š
    [Parameter] public List<SetoffProductDetail> ExistingDetails { get; set; } = new();
    [Parameter] public EventCallback<List<SetoffProductDetail>> OnDetailsChanged { get; set; }
    
    // é¡¯ç¤ºæ§åˆ¶
    [Parameter] public bool IsReadOnly { get; set; } = false;
    [Parameter] public bool ShowAllowance { get; set; } = true;
    
    // ===== å…§éƒ¨ç‹€æ…‹ =====
    private List<UnsettledDetailDto> UnsettledDetails { get; set; } = new();
    private List<SetoffProductDetailItem> SetoffItems { get; set; } = new();
    private List<Product> Products { get; set; } = new();

    // ===== ç”Ÿå‘½é€±æœŸæ–¹æ³• =====
    protected override async Task OnInitializedAsync()
    {
        await LoadProductsAsync();
        await LoadUnsettledDetailsAsync();
        LoadExistingDetails();
    }

    private int? _lastRelatedPartyId;
    private DateTime? _lastStartDate;
    private DateTime? _lastEndDate;
    
    protected override async Task OnParametersSetAsync()
    {
        // åªæœ‰ç•¶é—œè¯æ–¹æˆ–æ—¥æœŸç¯©é¸çœŸæ­£è®Šæ›´æ™‚ï¼Œæ‰é‡æ–°è¼‰å…¥æœªçµæ¸…æ˜ç´°
        bool relatedPartyChanged = _lastRelatedPartyId != RelatedPartyId;
        bool dateFilterChanged = _lastStartDate != StartDate || _lastEndDate != EndDate;
        
        if (relatedPartyChanged)
        {
            await LoadUnsettledDetailsAsync();
            LoadExistingDetails();
            _lastRelatedPartyId = RelatedPartyId;
        }
        else if (dateFilterChanged)
        {
            // æ—¥æœŸç¯©é¸è®Šæ›´æ™‚ï¼Œåªéœ€é‡æ–°å¥—ç”¨ç¯©é¸ï¼Œä¸éœ€é‡æ–°è¼‰å…¥æœªçµæ¸…æ˜ç´°
            LoadExistingDetails();
            _lastStartDate = StartDate;
            _lastEndDate = EndDate;
        }
        
        await base.OnParametersSetAsync();
    }

    // ===== è³‡æ–™è¼‰å…¥æ–¹æ³• =====
    private async Task LoadProductsAsync()
    {
        try
        {
            Products = await ProductService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å•†å“è³‡æ–™å¤±æ•—ï¼š{ex.Message}");
            Products = new List<Product>();
        }
    }

    private async Task LoadUnsettledDetailsAsync()
    {
        if (!RelatedPartyId.HasValue || RelatedPartyId.Value <= 0)
        {
            UnsettledDetails = new List<UnsettledDetailDto>();
            return;
        }

        try
        {
            UnsettledDetails = SetoffType == SetoffType.AccountsReceivable
                ? await SetoffProductDetailService.GetUnsettledReceivableDetailsAsync(RelatedPartyId.Value)
                : await SetoffProductDetailService.GetUnsettledPayableDetailsAsync(RelatedPartyId.Value);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥æœªçµæ¸…æ˜ç´°å¤±æ•—ï¼š{ex.Message}");
            UnsettledDetails = new List<UnsettledDetailDto>();
        }
    }

    private void LoadExistingDetails()
    {
        // åˆ¤æ–·æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼ï¼ˆSetoffDocumentId æœ‰å€¼ä¸”å¤§æ–¼ 0ï¼‰
        bool isEditMode = SetoffDocumentId.HasValue && SetoffDocumentId.Value > 0;
        
        // å¦‚æœæœ‰å·²å­˜åœ¨çš„æ˜ç´°ï¼ˆç·¨è¼¯æ¨¡å¼ï¼‰ï¼Œå‰‡é¡¯ç¤ºå·²å­˜åœ¨çš„æ˜ç´°
        if (ExistingDetails.Any())
        {
            SetoffItems = ExistingDetails.Select(detail =>
            {
                // å˜—è©¦å¾æœªçµæ¸…æ˜ç´°ä¸­æ‰¾åˆ°å°æ‡‰çš„ä¾†æºæ˜ç´°è³‡è¨Š
                var unsettledDetail = UnsettledDetails.FirstOrDefault(u => 
                    u.SourceDetailType == detail.SourceDetailType && 
                    u.SourceDetailId == detail.SourceDetailId);
                
                return new SetoffProductDetailItem
                {
                    SourceDetailType = detail.SourceDetailType,
                    SourceDetailId = detail.SourceDetailId,
                    ProductId = detail.ProductId,
                    Product = Products.FirstOrDefault(p => p.Id == detail.ProductId),
                    CurrentSetoffAmount = detail.CurrentSetoffAmount,
                    CurrentAllowanceAmount = detail.CurrentAllowanceAmount,
                    Remarks = detail.Remarks,
                    ExistingDetail = detail,
                    UnsettledDetail = unsettledDetail, // ä¿ç•™æœªçµæ¸…æ˜ç´°è³‡è¨Šä»¥é¡¯ç¤ºä¾†æºå–®è™Ÿç­‰è³‡æ–™
                    NeedsSourceDetailLoad = unsettledDetail == null // æ¨™è¨˜éœ€è¦é¡å¤–è¼‰å…¥ä¾†æºæ˜ç´°
                };
            }).ToList();
            
            // å°æ–¼éœ€è¦è¼‰å…¥ä¾†æºæ˜ç´°çš„é …ç›®ï¼ŒéåŒæ­¥è¼‰å…¥
            _ = LoadMissingSourceDetailsAsync();
        }
        else if (!isEditMode)
        {
            // æ–°å¢æ¨¡å¼ï¼šå°‡æ‰€æœ‰æœªçµæ¸…æ˜ç´°è½‰æ›ç‚º SetoffItemsï¼Œé è¨­æœ¬æ¬¡æ²–æ¬¾å’ŒæŠ˜è®“ç‚º0
            SetoffItems = UnsettledDetails
                .Where(d => !StartDate.HasValue || d.DocumentDate >= StartDate.Value)
                .Where(d => !EndDate.HasValue || d.DocumentDate <= EndDate.Value)
                .Select(detail => new SetoffProductDetailItem
                {
                    SourceDetailType = detail.SourceDetailType,
                    SourceDetailId = detail.SourceDetailId,
                    ProductId = detail.ProductId,
                    Product = Products.FirstOrDefault(p => p.Id == detail.ProductId),
                    CurrentSetoffAmount = 0, // é è¨­ç‚º0
                    CurrentAllowanceAmount = 0, // é è¨­ç‚º0
                    Remarks = null,
                    ExistingDetail = null,
                    UnsettledDetail = detail, // ä¿ç•™æœªçµæ¸…æ˜ç´°è³‡è¨Š
                    NeedsSourceDetailLoad = false
                }).ToList();
        }
        else
        {
            // ç·¨è¼¯æ¨¡å¼ä½†æ²’æœ‰ä»»ä½•å·²å„²å­˜çš„å•†å“æ˜ç´°ï¼šé¡¯ç¤ºç©ºåˆ—è¡¨
            SetoffItems = new List<SetoffProductDetailItem>();
        }
    }
    
    /// <summary>
    /// è¼‰å…¥ç¼ºå°‘çš„ä¾†æºæ˜ç´°è³‡è¨Šï¼ˆé‡å°å·²çµæ¸…çš„æ˜ç´°ï¼‰
    /// </summary>
    private async Task LoadMissingSourceDetailsAsync()
    {
        var itemsNeedingLoad = SetoffItems.Where(i => i.NeedsSourceDetailLoad).ToList();
        
        foreach (var item in itemsNeedingLoad)
        {
            try
            {
                var sourceDetail = await SetoffProductDetailService.GetSourceDetailInfoAsync(
                    item.SourceDetailType, 
                    item.SourceDetailId);
                
                if (sourceDetail != null)
                {
                    item.UnsettledDetail = sourceDetail;
                    item.NeedsSourceDetailLoad = false;
                }
            }
            catch (Exception ex)
            {
                await NotificationService.ShowErrorAsync($"è¼‰å…¥ä¾†æºæ˜ç´°å¤±æ•—ï¼š{ex.Message}");
            }
        }
        
        // å¼·åˆ¶é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºè¼‰å…¥çš„è³‡æ–™
        StateHasChanged();
    }

    // ===== UI è¼”åŠ©æ–¹æ³• =====
    private string GetRelatedPartyWarningMessage()
    {
        return SetoffType == SetoffType.AccountsReceivable
            ? "è«‹å…ˆé¸æ“‡å®¢æˆ¶æ‰èƒ½ç®¡ç†æ‡‰æ”¶æ²–æ¬¾æ˜ç´°"
            : "è«‹å…ˆé¸æ“‡å» å•†æ‰èƒ½ç®¡ç†æ‡‰ä»˜æ²–æ¬¾æ˜ç´°";
    }

    private string GetUnsettledEmptyMessage()
    {
        return SetoffType == SetoffType.AccountsReceivable
            ? "è©²å®¢æˆ¶æ²’æœ‰æœªçµæ¸…çš„æ‡‰æ”¶å¸³æ¬¾"
            : "è©²å» å•†æ²’æœ‰æœªçµæ¸…çš„æ‡‰ä»˜å¸³æ¬¾";
    }

    // ===== InteractiveTable æ¬„ä½å®šç¾© =====
    private List<InteractiveColumnDefinition> GetSetoffColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = "ä¾†æºå–®è™Ÿ",
                Tooltip = "åŸå§‹éŠ·å”®æˆ–é€²è²¨å–®æ“šçš„å–®è™Ÿ",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "150px",
                CustomTemplate = item =>
                {
                    var setoffItem = (SetoffProductDetailItem)item;
                    return @<div class="text-start">@setoffItem.UnsettledDetail?.SourceDocumentNumber</div>;
                }
            },
            new()
            {
                Title = "å•†å“ç·¨è™Ÿ/åç¨±",
                Tooltip = "é¡¯ç¤ºå•†å“çš„ç·¨è™Ÿèˆ‡åç¨±",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "200px",
                CustomTemplate = item =>
                {
                    var setoffItem = (SetoffProductDetailItem)item;
                    return @<div>@setoffItem.Product?.Code @setoffItem.Product?.Name</div>;
                }
            },
            new()
            {
                Title = "æ‡‰æ”¶/ä»˜é‡‘é¡",
                Tooltip = "ä¾†æºå–®æ“šçš„åŸå§‹æ‡‰æ”¶æˆ–æ‡‰ä»˜é‡‘é¡ï¼ˆé€€è²¨å–®é¡¯ç¤ºç‚ºè² æ•¸ï¼‰",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "150px",
                CustomTemplate = item =>
                {
                    var setoffItem = (SetoffProductDetailItem)item;
                    var detail = setoffItem.UnsettledDetail;
                    var cssClass = detail?.IsReturn == true ? "text-danger" : "text-success";
                    var amount = detail?.TotalAmount ?? 0;
                    var displayAmount = detail?.IsReturn == true ? -amount : amount;
                    var formattedValue = NumberFormatHelper.FormatSmart(displayAmount);
                    return @<div class="text-end fw-bold @cssClass">@formattedValue</div>;
                }
            },
            new()
            {
                Title = "æœªæ²–æ¬¾é¤˜é¡",
                Tooltip = "å°šæœªæ²–éŠ·çš„é¤˜é¡é‡‘é¡ï¼ˆç·¨è¼¯æ¨¡å¼ä¸‹æœƒå‹•æ…‹èª¿æ•´ï¼‰",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "150px",
                CustomTemplate = item =>
                {
                    var setoffItem = (SetoffProductDetailItem)item;
                    var detail = setoffItem.UnsettledDetail;
                    var baseRemainingAmount = detail?.RemainingAmount ?? 0;
                    
                    // ä½¿ç”¨ AdjustedBalanceHelper è¨ˆç®—å‹•æ…‹èª¿æ•´å¾Œçš„æœªæ²–æ¬¾é¤˜é¡
                    var originalTotalUsed = 0m;
                    var currentOtherFieldsUsed = 0m;
                    
                    if (IsEditMode() && setoffItem.ExistingDetail != null)
                    {
                        // ç·¨è¼¯æ¨¡å¼ï¼šåŸæœ‰çš„ç¸½ä½¿ç”¨é‡‘é¡ï¼ˆæ²–æ¬¾ + æŠ˜è®“ï¼‰
                        originalTotalUsed = setoffItem.ExistingDetail.CurrentSetoffAmount + 
                                          setoffItem.ExistingDetail.CurrentAllowanceAmount;
                    }
                    
                    // ç„¡è«–æ–°å¢æˆ–ç·¨è¼¯æ¨¡å¼ï¼Œéƒ½è¨ˆç®—ç•¶å‰ä½¿ç”¨é‡‘é¡ä»¥å‹•æ…‹é¡¯ç¤ºæœªæ²–æ¬¾é¤˜é¡
                    currentOtherFieldsUsed = setoffItem.CurrentSetoffAmount + 
                                            setoffItem.CurrentAllowanceAmount;
                    
                    var adjustedRemainingAmount = AdjustedBalanceHelper.CalculateAdjustedBalance(
                        baseRemainingAmount,
                        originalTotalUsed,
                        currentOtherFieldsUsed,
                        IsEditMode());
                    
                    var displayAmount = detail?.IsReturn == true ? -adjustedRemainingAmount : adjustedRemainingAmount;
                    var cssClass = adjustedRemainingAmount > 0 ? "text-warning fw-bold" : 
                                   adjustedRemainingAmount < 0 ? "text-danger fw-bold" : "text-muted";
                    var formattedValue = NumberFormatHelper.FormatSmart(displayAmount);
                    return @<div class="text-end @cssClass">@formattedValue</div>;
                }
            },
            new()
            {
                Title = "æœ¬æ¬¡æ²–æ¬¾",
                Tooltip = "æœ¬æ¬¡è¦æ²–éŠ·çš„é‡‘é¡ï¼ˆä¸å¯è¶…éæœªæ²–æ¬¾é¤˜é¡ï¼‰ğŸ’¡ é›™æ“Šå¯å¿«é€Ÿå¡«å…¥æœªæ²–æ¬¾é¤˜é¡",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = ShowAllowance ? "150px" : "200px",
                CustomTemplate = item =>
                {
                    var setoffItem = (SetoffProductDetailItem)item;
                    var isReturn = setoffItem.UnsettledDetail?.IsReturn == true;
                    var displayValue = NumberFormatHelper.FormatForInput(setoffItem.CurrentSetoffAmount, isReturn);
                    return @<input type="number"
                                  class="form-control  text-end"
                                  min="0"
                                  step="1"
                                  value="@displayValue"
                                  placeholder=""
                                  @oninput="@(e => OnSetoffAmountInput(setoffItem, e.Value?.ToString()))"
                                  @ondblclick="@(async () => await OnSetoffAmountDoubleClick(setoffItem))"
                                  readonly="@IsReadOnly" />;
                }
            }
        };

        if (ShowAllowance)
        {
            columns.Add(new InteractiveColumnDefinition
            {
                Title = "æœ¬æ¬¡æŠ˜è®“",
                Tooltip = "æœ¬æ¬¡çµ¦äºˆçš„æŠ˜è®“é‡‘é¡ï¼ˆä¸è¨ˆå…¥å¯¦éš›æ”¶ä»˜æ¬¾ï¼‰ğŸ’¡ é›™æ“Šå¯å¿«é€Ÿå¡«å…¥æœªæ²–æ¬¾é¤˜é¡",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "150px",
                CustomTemplate = item =>
                {
                    var setoffItem = (SetoffProductDetailItem)item;
                    var isReturn = setoffItem.UnsettledDetail?.IsReturn == true;
                    var displayValue = NumberFormatHelper.FormatForInput(setoffItem.CurrentAllowanceAmount, isReturn);
                    return @<input type="number"
                                  class="form-control  text-end"
                                  min="0"
                                  step="1"
                                  value="@displayValue"
                                  placeholder=""
                                  @oninput="@(e => OnAllowanceAmountInput(setoffItem, e.Value?.ToString()))"
                                  @ondblclick="@(async () => await OnAllowanceAmountDoubleClick(setoffItem))"
                                  readonly="@IsReadOnly" />;
                }
            });
        }

        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å°è¨ˆ",
            Tooltip = "æœ¬æ¬¡æ²–æ¬¾ + æœ¬æ¬¡æŠ˜è®“çš„ç¸½è¨ˆé‡‘é¡",
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "150px",
            CustomTemplate = item =>
            {
                var setoffItem = (SetoffProductDetailItem)item;
                var subtotal = setoffItem.CurrentSetoffAmount + setoffItem.CurrentAllowanceAmount;
                // å¦‚æœæ˜¯é€€è²¨å–®æ“šï¼Œå°è¨ˆéœ€è¦é¡¯ç¤ºç‚ºè² æ•¸
                var isReturn = setoffItem.UnsettledDetail?.IsReturn == true;
                var displaySubtotal = isReturn ? -subtotal : subtotal;
                var displayValue = NumberFormatHelper.FormatSmartZeroAsEmpty(displaySubtotal);
                // æ ¹æ“šæ­£è² æ•¸æ±ºå®šé¡è‰²ï¼šæ­£æ•¸ç‚ºç¶ è‰²ï¼Œè² æ•¸ç‚ºç´…è‰²
                var cssClass = displaySubtotal >= 0 ? "text-success" : "text-danger";
                return @<div class="text-end fw-bold @cssClass">@displayValue</div>;
            }
        });

        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å‚™è¨»",
            Tooltip = "å‚™è¨»èªªæ˜",
            PropertyName = nameof(SetoffProductDetailItem.Remarks),
            ColumnType = InteractiveColumnType.Input,
            Width = "200px",
            IsRequired = false,
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (itemObj, value) = args;
                var item = (SetoffProductDetailItem)itemObj;
                item.Remarks = value;
                await NotifyDetailsChanged();
            })
        });

        return columns;
    }


    // ===== äº‹ä»¶è™•ç†æ–¹æ³• =====
    private async Task OnSetoffAmountInput(SetoffProductDetailItem item, string? value)
    {
        var amount = InputEventHelper.HandlePriceInput(value);
        // å°‡è¼¸å…¥çš„é‡‘é¡è½‰ç‚ºçµ•å°å€¼å„²å­˜ï¼ˆç„¡è«–ç”¨æˆ¶è¼¸å…¥æ­£æ•¸æˆ–è² æ•¸ï¼‰
        item.CurrentSetoffAmount = Math.Abs(amount);
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// é›™æ“Šæœ¬æ¬¡æ²–æ¬¾è¼¸å…¥æ¡†æ™‚ï¼Œè‡ªå‹•å¡«å…¥æœªæ²–æ¬¾é¤˜é¡
    /// </summary>
    private async Task OnSetoffAmountDoubleClick(SetoffProductDetailItem item)
    {
        // å¦‚æœæ˜¯å”¯è®€æ¨¡å¼ï¼Œä¸åŸ·è¡Œä»»ä½•æ“ä½œ
        if (IsReadOnly) return;

        try
        {
            var detail = item.UnsettledDetail;
            if (detail == null) return;

            var baseRemainingAmount = detail.RemainingAmount;
            
            // ä½¿ç”¨ AdjustedBalanceHelper è¨ˆç®—å¯å¡«å…¥çš„æœ€å¤§é‡‘é¡
            var originalTotalUsed = 0m;
            var otherFieldsUsed = item.CurrentAllowanceAmount; // æœ¬æ¬¡æŠ˜è®“
            
            if (IsEditMode() && item.ExistingDetail != null)
            {
                // åŸæœ‰çš„ç¸½ä½¿ç”¨é‡‘é¡ï¼ˆæ²–æ¬¾ + æŠ˜è®“ï¼‰
                originalTotalUsed = item.ExistingDetail.CurrentSetoffAmount + 
                                  item.ExistingDetail.CurrentAllowanceAmount;
            }
            
            var maxFillableAmount = AdjustedBalanceHelper.GetMaxFillableAmount(
                baseRemainingAmount,
                originalTotalUsed,
                otherFieldsUsed,
                IsEditMode());
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å¯å¡«å…¥çš„é‡‘é¡
            if (maxFillableAmount <= 0)
            {
                await NotificationService.ShowInfoAsync("æ²’æœ‰å¯å¡«å…¥çš„æœªæ²–æ¬¾é¤˜é¡", "æç¤º");
                return;
            }
            
            // å¡«å…¥é‡‘é¡ï¼ˆçµ•å°å€¼ï¼‰
            item.CurrentSetoffAmount = Math.Abs(maxFillableAmount);
            await NotifyDetailsChanged();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å¡«å…¥é‡‘é¡å¤±æ•—ï¼š{ex.Message}", "éŒ¯èª¤");
        }
    }

    private async Task OnAllowanceAmountInput(SetoffProductDetailItem item, string? value)
    {
        var amount = InputEventHelper.HandlePriceInput(value);
        // å°‡è¼¸å…¥çš„é‡‘é¡è½‰ç‚ºçµ•å°å€¼å„²å­˜ï¼ˆç„¡è«–ç”¨æˆ¶è¼¸å…¥æ­£æ•¸æˆ–è² æ•¸ï¼‰
        item.CurrentAllowanceAmount = Math.Abs(amount);
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// é›™æ“Šæœ¬æ¬¡æŠ˜è®“è¼¸å…¥æ¡†æ™‚ï¼Œè‡ªå‹•å¡«å…¥æœªæ²–æ¬¾é¤˜é¡
    /// </summary>
    private async Task OnAllowanceAmountDoubleClick(SetoffProductDetailItem item)
    {
        // å¦‚æœæ˜¯å”¯è®€æ¨¡å¼ï¼Œä¸åŸ·è¡Œä»»ä½•æ“ä½œ
        if (IsReadOnly) return;

        try
        {
            var detail = item.UnsettledDetail;
            if (detail == null) return;

            var baseRemainingAmount = detail.RemainingAmount;
            
            // ä½¿ç”¨ AdjustedBalanceHelper è¨ˆç®—å¯å¡«å…¥çš„æœ€å¤§é‡‘é¡
            var originalTotalUsed = 0m;
            var otherFieldsUsed = item.CurrentSetoffAmount; // æœ¬æ¬¡æ²–æ¬¾
            
            if (IsEditMode() && item.ExistingDetail != null)
            {
                // åŸæœ‰çš„ç¸½ä½¿ç”¨é‡‘é¡ï¼ˆæ²–æ¬¾ + æŠ˜è®“ï¼‰
                originalTotalUsed = item.ExistingDetail.CurrentSetoffAmount + 
                                  item.ExistingDetail.CurrentAllowanceAmount;
            }
            
            var maxFillableAmount = AdjustedBalanceHelper.GetMaxFillableAmount(
                baseRemainingAmount,
                originalTotalUsed,
                otherFieldsUsed,
                IsEditMode());
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å¯å¡«å…¥çš„é‡‘é¡
            if (maxFillableAmount <= 0)
            {
                await NotificationService.ShowInfoAsync("æ²’æœ‰å¯å¡«å…¥çš„æœªæ²–æ¬¾é¤˜é¡", "æç¤º");
                return;
            }
            
            // å¡«å…¥é‡‘é¡ï¼ˆçµ•å°å€¼ï¼‰
            item.CurrentAllowanceAmount = Math.Abs(maxFillableAmount);
            await NotifyDetailsChanged();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å¡«å…¥é‡‘é¡å¤±æ•—ï¼š{ex.Message}", "éŒ¯èª¤");
        }
    }

    /// <summary>
    /// å…¨éƒ¨æ²–æ¬¾ - å°‡æ‰€æœ‰æœªçµæ¸…é …ç›®çš„æœ¬æ¬¡æ²–æ¬¾å¡«æ»¿è‡³æœªæ²–æ¬¾é¤˜é¡
    /// </summary>
    private async Task FillAllSetoffAmounts()
    {
        if (IsReadOnly) return;

        try
        {
            int filledCount = 0;
            
            foreach (var item in SetoffItems)
            {
                if (item.UnsettledDetail != null)
                {
                    var baseRemainingAmount = item.UnsettledDetail.RemainingAmount;
                    
                    // ä½¿ç”¨ AdjustedBalanceHelper è¨ˆç®—å¯å¡«å…¥çš„æœ€å¤§é‡‘é¡
                    var originalTotalUsed = 0m;
                    
                    if (IsEditMode() && item.ExistingDetail != null)
                    {
                        // åŸæœ‰çš„ç¸½ä½¿ç”¨é‡‘é¡ï¼ˆæ²–æ¬¾ + æŠ˜è®“ï¼‰
                        originalTotalUsed = item.ExistingDetail.CurrentSetoffAmount + 
                                          item.ExistingDetail.CurrentAllowanceAmount;
                    }
                    
                    var maxFillableAmount = AdjustedBalanceHelper.GetMaxFillableAmount(
                        baseRemainingAmount,
                        originalTotalUsed,
                        0, // ä¸è€ƒæ…®å…¶ä»–æ¬„ä½ï¼Œç›´æ¥å¡«æ»¿
                        IsEditMode());
                    
                    // åªæœ‰ç•¶å¯å¡«å…¥é‡‘é¡å¤§æ–¼0æ™‚æ‰å¡«å…¥
                    if (maxFillableAmount > 0)
                    {
                        item.CurrentSetoffAmount = maxFillableAmount;
                        item.CurrentAllowanceAmount = 0; // æ¸…ç©ºæŠ˜è®“
                        filledCount++;
                    }
                }
            }

            await NotifyDetailsChanged();
            
            if (filledCount > 0)
            {
                await NotificationService.ShowSuccessAsync($"å·²è‡ªå‹•å¡«å…¥ {filledCount} é …æ²–æ¬¾é‡‘é¡", "å…¨éƒ¨æ²–æ¬¾å®Œæˆ");
            }
            else
            {
                await NotificationService.ShowInfoAsync("æ²’æœ‰å¯å¡«å…¥çš„æ²–æ¬¾é …ç›®", "æç¤º");
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å…¨éƒ¨æ²–æ¬¾å¤±æ•—ï¼š{ex.Message}", "éŒ¯èª¤");
        }
    }

    /// <summary>
    /// æ²–æ¬¾æ¸…ç©º - æ¸…ç©ºæ‰€æœ‰æœ¬æ¬¡æ²–æ¬¾å’Œæœ¬æ¬¡æŠ˜è®“é‡‘é¡
    /// </summary>
    private async Task ClearAllSetoffAmounts()
    {
        if (IsReadOnly) return;

        try
        {
            int clearedCount = 0;
            
            foreach (var item in SetoffItems)
            {
                if (item.CurrentSetoffAmount > 0 || item.CurrentAllowanceAmount > 0)
                {
                    item.CurrentSetoffAmount = 0;
                    item.CurrentAllowanceAmount = 0;
                    clearedCount++;
                }
            }

            await NotifyDetailsChanged();
            
            if (clearedCount > 0)
            {
                await NotificationService.ShowSuccessAsync($"å·²æ¸…ç©º {clearedCount} é …æ²–æ¬¾é‡‘é¡", "æ²–æ¬¾æ¸…ç©ºå®Œæˆ");
            }
            else
            {
                await NotificationService.ShowInfoAsync("æ²’æœ‰éœ€è¦æ¸…ç©ºçš„æ²–æ¬¾é …ç›®", "æç¤º");
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æ²–æ¬¾æ¸…ç©ºå¤±æ•—ï¼š{ex.Message}", "éŒ¯èª¤");
        }
    }

    private async Task NotifyDetailsChanged()
    {
        var details = SetoffItems
            .Where(item => 
                item.CurrentSetoffAmount > 0 || 
                item.CurrentAllowanceAmount > 0 || 
                !string.IsNullOrWhiteSpace(item.Remarks) || // åŒ…å«æœ‰å‚™è¨»çš„é …ç›®
                item.ExistingDetail != null) // ç·¨è¼¯æ¨¡å¼ä¸‹åŒ…å«æ‰€æœ‰å·²å­˜åœ¨çš„æ˜ç´°
            .Select(item => new SetoffProductDetail
            {
                Id = item.ExistingDetail?.Id ?? 0,
                SetoffDocumentId = SetoffDocumentId ?? 0,
                ProductId = item.ProductId,
                SourceDetailType = item.SourceDetailType,
                SourceDetailId = item.SourceDetailId,
                CurrentSetoffAmount = item.CurrentSetoffAmount,
                CurrentAllowanceAmount = item.CurrentAllowanceAmount,
                TotalSetoffAmount = item.ExistingDetail?.TotalSetoffAmount ?? 0,
                TotalAllowanceAmount = item.ExistingDetail?.TotalAllowanceAmount ?? 0,
                Remarks = item.Remarks
            }).ToList();

        await DetailSyncHelper.SyncToParentAsync(details, OnDetailsChanged);
    }
    
    /// <summary>
    /// å–å¾—æœ¬æœŸæ²–éŠ·ç¸½é¡ï¼ˆåªè¨ˆç®—æœ¬æ¬¡æ²–æ¬¾ï¼Œä¸åŒ…å«æŠ˜è®“ï¼Œè€ƒæ…®é€€è²¨ç‚ºè² æ•¸ï¼‰
    /// </summary>
    public decimal GetCurrentSetoffTotal()
    {
        return SetoffItems
            .Where(item => item.CurrentSetoffAmount > 0 || item.CurrentAllowanceAmount > 0)
            .Sum(item =>
            {
                var total = item.CurrentSetoffAmount; // åªè¨ˆç®—æœ¬æ¬¡æ²–æ¬¾
                // å¦‚æœæ˜¯é€€è²¨å–®æ“šï¼Œé‡‘é¡å–è² å€¼
                var isReturn = item.SourceDetailType == SetoffDetailType.SalesReturnDetail || 
                              item.SourceDetailType == SetoffDetailType.PurchaseReturnDetail;
                return isReturn ? -total : total;
            });
    }
    
    /// <summary>
    /// å–å¾—æœ¬æœŸæŠ˜è®“ç¸½é¡ï¼ˆè€ƒæ…®é€€è²¨ç‚ºè² æ•¸ï¼‰
    /// </summary>
    public decimal GetCurrentAllowanceTotal()
    {
        return SetoffItems
            .Where(item => item.CurrentSetoffAmount > 0 || item.CurrentAllowanceAmount > 0)
            .Sum(item =>
            {
                var total = item.CurrentAllowanceAmount;
                // å¦‚æœæ˜¯é€€è²¨å–®æ“šï¼Œé‡‘é¡å–è² å€¼
                var isReturn = item.SourceDetailType == SetoffDetailType.SalesReturnDetail || 
                              item.SourceDetailType == SetoffDetailType.PurchaseReturnDetail;
                return isReturn ? -total : total;
            });
    }
    
    /// <summary>
    /// è™•ç†ç§»é™¤æ˜ç´°é …ç›®
    /// </summary>
    private async Task HandleRemoveItem(SetoffProductDetailItem item)
    {
        // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ä¸­çš„å·²å­˜åœ¨æ˜ç´°ï¼Œå°‡é‡‘é¡æ¸…é›¶è€Œä¸ç§»é™¤é …ç›®ï¼ˆä¿ç•™åœ¨åˆ—è¡¨ä¸­ä»¥ä¾¿æ¢å¾©ï¼‰
        if (item.ExistingDetail != null)
        {
            item.CurrentSetoffAmount = 0;
            item.CurrentAllowanceAmount = 0;
            await NotificationService.ShowInfoAsync("å·²æ¸…é™¤æ­¤é …ç›®çš„æ²–æ¬¾é‡‘é¡");
        }
        else
        {
            // æ–°å¢æ¨¡å¼ä¸‹çš„é …ç›®å¯ä»¥ç›´æ¥ç§»é™¤ï¼ˆå¯¦éš›ä¸Šæ˜¯å°‡é‡‘é¡æ¸…é›¶ï¼‰
            item.CurrentSetoffAmount = 0;
            item.CurrentAllowanceAmount = 0;
            await NotificationService.ShowInfoAsync("å·²æ¸…é™¤æ­¤é …ç›®çš„æ²–æ¬¾é‡‘é¡");
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }
    
    /// <summary>
    /// å–å¾—ç•¶å‰é¸ä¸­æ˜ç´°çš„ä¾†æºç¸½é‡‘é¡ï¼ˆç”¨æ–¼è¨ˆç®—æœ¬æœŸæ‡‰æ”¶ï¼‰
    /// é€€è²¨å–®æ“šæœƒä»¥è² æ•¸è¨ˆç®—
    /// </summary>
    public decimal GetSourceTotalAmount()
    {
        return SetoffItems
            .Where(item => item.CurrentSetoffAmount > 0 || item.CurrentAllowanceAmount > 0)
            .Sum(item => 
            {
                var amount = item.SourceTotalAmount;
                // å¦‚æœæ˜¯é€€è²¨å–®æ“šï¼Œé‡‘é¡å–è² å€¼
                return item.UnsettledDetail?.IsReturn == true ? -amount : amount;
            });
    }
    
    /// <summary>
    /// å…¬é–‹çš„åˆ·æ–°æ–¹æ³•ï¼Œç”¨æ–¼å¤–éƒ¨è§¸ç™¼æ˜ç´°åˆ·æ–°ï¼ˆä¾‹å¦‚ï¼šä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼‰
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadUnsettledDetailsAsync();
        LoadExistingDetails();
        StateHasChanged();
    }
    
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼ï¼ˆç·¨è¼¯æ¨¡å¼ä¸‹ä¸å…è¨±åˆªé™¤æ˜ç´°ï¼‰
    /// </summary>
    private bool IsEditMode()
    {
        return SetoffDocumentId.HasValue && SetoffDocumentId.Value > 0;
    }

    // ===== å…§éƒ¨è³‡æ–™é¡åˆ¥ =====
    private class SetoffProductDetailItem
    {
        public SetoffDetailType SourceDetailType { get; set; }
        public int SourceDetailId { get; set; }
        public int ProductId { get; set; }
        public Product? Product { get; set; }
        public decimal CurrentSetoffAmount { get; set; }
        public decimal CurrentAllowanceAmount { get; set; }
        public string? Remarks { get; set; }
        public SetoffProductDetail? ExistingDetail { get; set; }
        public UnsettledDetailDto? UnsettledDetail { get; set; } // ä¿ç•™æœªçµæ¸…æ˜ç´°è³‡è¨Š
        public bool NeedsSourceDetailLoad { get; set; } // æ¨™è¨˜æ˜¯å¦éœ€è¦é¡å¤–è¼‰å…¥ä¾†æºæ˜ç´°ï¼ˆé‡å°å·²çµæ¸…çš„æ˜ç´°ï¼‰
        
        /// <summary>
        /// ä¾†æºæ˜ç´°çš„åŸå§‹ç¸½é‡‘é¡ï¼ˆç”¨æ–¼è¨ˆç®—æœ¬æœŸæ‡‰æ”¶ï¼‰
        /// </summary>
        public decimal SourceTotalAmount => UnsettledDetail?.TotalAmount ?? 0;
    }
}
