@* åº«å­˜æ˜ç´°ç®¡ç†çµ„ä»¶ - ä½¿ç”¨ InteractiveTableComponent çµ±ä¸€UI *@
@using ERPCore2.Data.Entities
@using ERPCore2.Services
@using ERPCore2.Helpers
@inject IWarehouseService WarehouseService
@inject IWarehouseLocationService WarehouseLocationService
@inject IInventoryStockDetailService InventoryStockDetailService
@inject INotificationService NotificationService

@typeparam TMainEntity where TMainEntity : BaseEntity
@typeparam TDetailEntity where TDetailEntity : BaseEntity, new()

    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="StockDetailItem" 
                                      Items="@StockDetailItems"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      ShowHeader="true"
                                      ShowActions="false"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="false"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"
                                      IsReadOnly="@IsReadOnly"
                                      OnItemDelete="@HandleItemDelete"
                                      CssClass="mb-0"
                                      EnableAutoEmptyRow="true"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@CreateEmptyItem" />
        </div>
    </div>


@code {
    // ===== InteractiveTableComponent åƒè€ƒ =====
    private InteractiveTableComponent<StockDetailItem>? tableComponent;
    
    // ===== ç§æœ‰æ¬„ä½ =====
    private bool _dataLoadCompleted = true;  // è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜
    
    // ===== åŸºæœ¬åƒæ•¸ =====
    [Parameter] public List<Warehouse> Warehouses { get; set; } = new List<Warehouse>();
    [Parameter] public List<WarehouseLocation> WarehouseLocations { get; set; } = new List<WarehouseLocation>();
    [Parameter] public EventCallback<List<StockDetailItem>> OnStockDetailItemsChanged { get; set; }
    
    // ===== åº«å­˜ä¸»æª”IDåƒæ•¸ =====
    [Parameter] public int? SelectedInventoryStockId { get; set; }
    
    // ===== æ³›å‹åƒæ•¸ =====
    [Parameter] public TMainEntity? MainEntity { get; set; }
    [Parameter] public List<TDetailEntity> ExistingDetails { get; set; } = new List<TDetailEntity>();
    [Parameter] public EventCallback<List<TDetailEntity>> OnDetailsChanged { get; set; }
    
    // ===== æ¬„ä½æ˜ å°„åƒæ•¸ =====
    [Parameter] public string MainEntityIdPropertyName { get; set; } = "InventoryStockId";
    [Parameter] public string CurrentStockPropertyName { get; set; } = "CurrentStock";
    [Parameter] public string ReservedStockPropertyName { get; set; } = "ReservedStock";
    [Parameter] public string InTransitStockPropertyName { get; set; } = "InTransitStock";
    [Parameter] public string AverageCostPropertyName { get; set; } = "AverageCost";
    [Parameter] public string MinStockLevelPropertyName { get; set; } = "MinStockLevel";
    [Parameter] public string MaxStockLevelPropertyName { get; set; } = "MaxStockLevel";
    [Parameter] public string BatchNumberPropertyName { get; set; } = "BatchNumber";
    [Parameter] public string BatchDatePropertyName { get; set; } = "BatchDate";
    [Parameter] public string ExpiryDatePropertyName { get; set; } = "ExpiryDate";
    [Parameter] public string WarehouseIdPropertyName { get; set; } = "WarehouseId";
    [Parameter] public string WarehouseLocationIdPropertyName { get; set; } = "WarehouseLocationId";
    
    // ===== é¡¯ç¤ºè¨­å®š =====
    [Parameter] public string Title { get; set; } = "åº«å­˜æ˜ç´°";
    [Parameter] public string Subtitle { get; set; } = "";
    [Parameter] public string Icon { get; set; } = "boxes";
    [Parameter] public string ItemDisplayName { get; set; } = "æ˜ç´°";
    [Parameter] public string EmptyIcon { get; set; } = "box-open";
    [Parameter] public string EmptyMessage { get; set; } = "å°šæœªæ–°å¢åº«å­˜æ˜ç´°";
    
    // ===== é¡¯ç¤ºæ§åˆ¶åƒæ•¸ =====
    [Parameter] public bool ShowBatchTracking { get; set; } = true;
    [Parameter] public bool ShowAverageCost { get; set; } = true;
    
    // ===== å”¯è®€æ¨¡å¼åƒæ•¸ =====
    [Parameter] public bool IsReadOnly { get; set; } = false;

    private List<StockDetailItem> StockDetailItems { get; set; } = new List<StockDetailItem>();
    private int? _previousSelectedInventoryStockId = null;
    private bool _isInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        _previousSelectedInventoryStockId = SelectedInventoryStockId;
        await LoadExistingDetailsAsync();
        _isInitialized = true;
    }

    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        
        if (!_isInitialized)
        {
            return;
        }
        
        // æª¢æŸ¥åº«å­˜ä¸»æª”æ˜¯å¦è®Šæ›´ï¼ˆåŒ…å«å¾nullåˆ°nullçš„æ–°å¢æ¨¡å¼åˆ‡æ›ï¼‰
        if (_previousSelectedInventoryStockId != SelectedInventoryStockId)
        {
            _previousSelectedInventoryStockId = SelectedInventoryStockId;
            StockDetailItems.Clear();
            await LoadExistingDetailsAsync();
            return;
        }
        
        // ç‰¹æ®Šè™•ç†ï¼šç•¶éƒ½æ˜¯æ–°å¢æ¨¡å¼(null)ä½†ExistingDetailså·²æ¸…ç©ºæ™‚ï¼Œä¹Ÿè¦é‡ç½®æ˜ç´°
        if (!SelectedInventoryStockId.HasValue && 
            (ExistingDetails == null || !ExistingDetails.Any()) && 
            StockDetailItems.Any(item => item.SelectedWarehouseId.HasValue && item.SelectedWarehouseId.Value > 0))
        {
            StockDetailItems.Clear();
            await LoadExistingDetailsAsync();
            return;
        }
    }

    // ===== å»ºç«‹ç©ºé …ç›®æ–¹æ³• =====
    
    private StockDetailItem CreateEmptyItem()
    {
        return new StockDetailItem();
    }

    // ===== InteractiveTableComponent æ–¹æ³• =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // å€‰åº«é¸æ“‡æ¬„ä½
        columns.Add(new() 
        { 
            Title = "å€‰åº«", 
            PropertyName = "SelectedWarehouseId",
            ColumnType = InteractiveColumnType.Select,
            TriggerEmptyRowOnFilled = true,
            Width = "150px",
            Placeholder = "è«‹é¸æ“‡...",
            Options = GetWarehouseOptions(),
            OnSelectionChanged = EventCallback.Factory.Create<(object, object?)>(this, async args =>
            {
                var (item, value) = args;
                await OnWarehouseChanged((StockDetailItem)item, value);
            })
        });
        
        // åº«ä½é¸æ“‡æ¬„ä½
        columns.Add(new() 
        { 
            Title = "åº«ä½", 
            PropertyName = "SelectedWarehouseLocationId",
            ColumnType = InteractiveColumnType.Custom,
            Width = "150px",
            CustomTemplate = item => 
            {
                var stockItem = (StockDetailItem)item;
                var selectedValue = stockItem.SelectedWarehouseLocationId?.ToString() ?? "";
                var isDisabled = IsReadOnly || !stockItem.SelectedWarehouseId.HasValue;
                
                return @<select class="form-select form-select-sm"
                                value="@selectedValue"
                                @onchange="@(async e => await OnWarehouseLocationChanged(stockItem, e.Value))"
                                disabled="@isDisabled">
                    <option value="">è«‹é¸æ“‡...</option>
                    @foreach (var location in GetAvailableLocations(stockItem.SelectedWarehouseId))
                    {
                        <option value="@location.Id">@location.Name</option>
                    }
                </select>;
            }
        });

        // ç¾æœ‰åº«å­˜æ¬„ä½
        columns.Add(new() 
        { 
            Title = "ç¾æœ‰åº«å­˜", 
            PropertyName = "CurrentStock",
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            CellCssClass = "text-end",
            MinValue = 0,
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnCurrentStockInput((StockDetailItem)item, valueString);
            })
        });

        // å¹³å‡æˆæœ¬æ¬„ä½ï¼ˆæ¢ä»¶é¡¯ç¤ºï¼‰
        if (ShowAverageCost)
        {
            columns.Add(new() 
            { 
                Title = "å¹³å‡æˆæœ¬", 
                PropertyName = "AverageCost",
                ColumnType = InteractiveColumnType.Number,
                Width = "120px",
                CellCssClass = "text-end",
                MinValue = 0,
                OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
                {
                    var (item, valueString) = args;
                    await OnAverageCostInput((StockDetailItem)item, valueString);
                })
            });
        }

        // æœ€ä½åº«å­˜è­¦æˆ’ç·šæ¬„ä½
        columns.Add(new() 
        { 
            Title = "æœ€ä½è­¦æˆ’ç·š", 
            PropertyName = "MinStockLevel",
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            CellCssClass = "text-end",
            MinValue = 0,
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnMinStockLevelInput((StockDetailItem)item, valueString);
            })
        });

        // æœ€é«˜åº«å­˜è­¦æˆ’ç·šæ¬„ä½
        columns.Add(new() 
        { 
            Title = "æœ€é«˜è­¦æˆ’ç·š", 
            PropertyName = "MaxStockLevel",
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            CellCssClass = "text-end",
            MinValue = 0,
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnMaxStockLevelInput((StockDetailItem)item, valueString);
            })
        });

        return columns;
    }

    private RenderFragment<StockDetailItem> GetCustomActionsTemplate => item => __builder =>
    {
        <GenericButtonComponent Variant="ButtonVariant.Danger"
                               IconClass="bi bi-trash text-white"
                               Size="ButtonSize.Large"
                               OnClick="@(() => HandleItemDelete(item))"
                               Title="åˆªé™¤"
                               IsDisabled="@(IsReadOnly || !CanDeleteItem(item, out _))"
                               StopPropagation="true"
                               CssClass="btn-square" />
    };

    private async Task HandleItemDelete(StockDetailItem item)
    {
        var index = StockDetailItems.IndexOf(item);
        await RemoveItemAsync(index);
    }

    // ===== å…§éƒ¨æ–¹æ³• =====

    private async Task LoadExistingDetailsAsync()
    {
        if (ExistingDetails?.Any() != true) 
        {
            return;
        }

        // ğŸ”‘ é–‹å§‹è¼‰å…¥è³‡æ–™ - è¨­å®šç‚ºæœªå®Œæˆ
        _dataLoadCompleted = false;
        
        StockDetailItems.Clear();
        
        foreach (var detail in ExistingDetails)
        {
            var warehouseId = GetPropertyValue<int>(detail, WarehouseIdPropertyName);
            var warehouseLocationId = GetPropertyValue<int?>(detail, WarehouseLocationIdPropertyName);
            
            var item = new StockDetailItem
            {
                SelectedWarehouseId = warehouseId,
                SelectedWarehouseLocationId = warehouseLocationId,
                CurrentStock = GetPropertyValue<int>(detail, CurrentStockPropertyName),
                ReservedStock = GetPropertyValue<int>(detail, ReservedStockPropertyName),
                InTransitStock = GetPropertyValue<int>(detail, InTransitStockPropertyName),
                AverageCost = GetPropertyValue<decimal?>(detail, AverageCostPropertyName),
                MinStockLevel = GetPropertyValue<int?>(detail, MinStockLevelPropertyName),
                MaxStockLevel = GetPropertyValue<int?>(detail, MaxStockLevelPropertyName),
                BatchNumber = GetPropertyValue<string>(detail, BatchNumberPropertyName),
                BatchDate = GetPropertyValue<DateTime?>(detail, BatchDatePropertyName),
                ExpiryDate = GetPropertyValue<DateTime?>(detail, ExpiryDatePropertyName),
                ExistingDetailEntity = detail
            };
            
            StockDetailItems.Add(item);
        }
        
        // ğŸ”‘ è³‡æ–™è¼‰å…¥å®Œæˆ - è§¸ç™¼ç©ºè¡Œæª¢æŸ¥
        _dataLoadCompleted = true;
        
        await Task.CompletedTask;
    }

    private List<TDetailEntity> ConvertToDetailEntities()
    {
        var details = new List<TDetailEntity>();
        
        foreach (var item in StockDetailItems.Where(x => x.SelectedWarehouseId.HasValue && x.SelectedWarehouseId.Value > 0))
        {
            TDetailEntity detail;
            
            if (item.ExistingDetailEntity != null)
            {
                detail = item.ExistingDetailEntity;
            }
            else
            {
                detail = new TDetailEntity();
                
                if (MainEntity != null)
                {
                    var mainEntityIdProperty = typeof(TDetailEntity).GetProperty(MainEntityIdPropertyName);
                    if (mainEntityIdProperty != null && mainEntityIdProperty.CanWrite)
                    {
                        mainEntityIdProperty.SetValue(detail, SelectedInventoryStockId);
                    }
                }
            }
            
            SetPropertyValue(detail, WarehouseIdPropertyName, item.SelectedWarehouseId);
            SetPropertyValue(detail, WarehouseLocationIdPropertyName, item.SelectedWarehouseLocationId);
            SetPropertyValue(detail, CurrentStockPropertyName, item.CurrentStock);
            SetPropertyValue(detail, ReservedStockPropertyName, item.ReservedStock);
            SetPropertyValue(detail, InTransitStockPropertyName, item.InTransitStock);
            SetPropertyValue(detail, AverageCostPropertyName, item.AverageCost);
            SetPropertyValue(detail, MinStockLevelPropertyName, item.MinStockLevel);
            SetPropertyValue(detail, MaxStockLevelPropertyName, item.MaxStockLevel);
            SetPropertyValue(detail, BatchNumberPropertyName, item.BatchNumber);
            SetPropertyValue(detail, BatchDatePropertyName, item.BatchDate);
            SetPropertyValue(detail, ExpiryDatePropertyName, item.ExpiryDate);
            
            details.Add(detail);
        }
        
        return details;
    }

    private async Task NotifyDetailsChanged()
    {
        var details = ConvertToDetailEntities();
        await OnDetailsChanged.InvokeAsync(details);
    }

    private T? GetPropertyValue<T>(object obj, string propertyName)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property == null) return default(T);
        
        var value = property.GetValue(obj);
        if (value == null) return default(T);
        
        if (typeof(T) == typeof(object)) return (T)value;
        
        // è™•ç†å¯ç©ºå‹åˆ¥çš„è½‰æ›
        var targetType = Nullable.GetUnderlyingType(typeof(T)) ?? typeof(T);
        
        // å¦‚æœå€¼çš„å‹åˆ¥èˆ‡ç›®æ¨™å‹åˆ¥ç›¸åŒæˆ–å¯ç›´æ¥è½‰æ›
        if (targetType.IsAssignableFrom(value.GetType()))
        {
            return (T)value;
        }
        
        try
        {
            return (T)Convert.ChangeType(value, targetType);
        }
        catch
        {
            return default(T);
        }
    }

    private void SetPropertyValue(object obj, string propertyName, object? value)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property != null && property.CanWrite)
        {
            if (value != null && property.PropertyType != value.GetType())
            {
                var targetType = Nullable.GetUnderlyingType(property.PropertyType) ?? property.PropertyType;
                try
                {
                    value = Convert.ChangeType(value, targetType);
                }
                catch
                {
                    value = null;
                }
            }
            property.SetValue(obj, value);
        }
    }

    // ===== æ¬„ä½è®Šæ›´äº‹ä»¶è™•ç† =====

    private async Task OnWarehouseChanged(StockDetailItem item, object? value)
    {
        var warehouseIdStr = value?.ToString();
        if (string.IsNullOrEmpty(warehouseIdStr))
        {
            item.SelectedWarehouseId = null;
            item.SelectedWarehouseLocationId = null;
        }
        else if (int.TryParse(warehouseIdStr, out var warehouseId))
        {
            item.SelectedWarehouseId = warehouseId;
            item.SelectedWarehouseLocationId = null;
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnWarehouseLocationChanged(StockDetailItem item, object? value)
    {
        var locationIdStr = value?.ToString();
        if (string.IsNullOrEmpty(locationIdStr))
        {
            item.SelectedWarehouseLocationId = null;
        }
        else if (int.TryParse(locationIdStr, out var locationId))
        {
            item.SelectedWarehouseLocationId = locationId;
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnCurrentStockInput(StockDetailItem item, string? value)
    {
        if (string.IsNullOrEmpty(value))
        {
            item.CurrentStock = 0;
        }
        else if (int.TryParse(value, out var stock))
        {
            item.CurrentStock = stock;
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnReservedStockInput(StockDetailItem item, string? value)
    {
        if (string.IsNullOrEmpty(value))
        {
            item.ReservedStock = 0;
        }
        else if (int.TryParse(value, out var stock))
        {
            item.ReservedStock = stock;
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnInTransitStockInput(StockDetailItem item, string? value)
    {
        if (string.IsNullOrEmpty(value))
        {
            item.InTransitStock = 0;
        }
        else if (int.TryParse(value, out var stock))
        {
            item.InTransitStock = stock;
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnAverageCostInput(StockDetailItem item, string? value)
    {
        if (string.IsNullOrEmpty(value))
        {
            item.AverageCost = null;
        }
        else if (decimal.TryParse(value, out var cost))
        {
            item.AverageCost = cost;
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnMinStockLevelInput(StockDetailItem item, string? value)
    {
        if (string.IsNullOrEmpty(value))
        {
            item.MinStockLevel = null;
        }
        else if (int.TryParse(value, out var level))
        {
            item.MinStockLevel = level;
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnMaxStockLevelInput(StockDetailItem item, string? value)
    {
        if (string.IsNullOrEmpty(value))
        {
            item.MaxStockLevel = null;
        }
        else if (int.TryParse(value, out var level))
        {
            item.MaxStockLevel = level;
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnBatchNumberInput(StockDetailItem item, string? value)
    {
        item.BatchNumber = value ?? string.Empty;
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnBatchDateChanged(StockDetailItem item, string? value)
    {
        if (string.IsNullOrEmpty(value))
        {
            item.BatchDate = null;
        }
        else if (DateTime.TryParse(value, out var date))
        {
            item.BatchDate = date;
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnExpiryDateChanged(StockDetailItem item, string? value)
    {
        if (string.IsNullOrEmpty(value))
        {
            item.ExpiryDate = null;
        }
        else if (DateTime.TryParse(value, out var date))
        {
            item.ExpiryDate = date;
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    public async Task RemoveItemAsync(int index)
    {
        if (IsReadOnly || index < 0 || index >= StockDetailItems.Count) return;
        
        var removedItem = StockDetailItems[index];
        
        StockDetailItems.Remove(removedItem);
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private List<InteractiveSelectOption> GetWarehouseOptions()
    {
        var options = new List<InteractiveSelectOption>();
        
        foreach (var warehouse in Warehouses)
        {
            options.Add(new InteractiveSelectOption
            {
                Value = warehouse.Id,
                Text = warehouse.Name
            });
        }
        
        return options;
    }

    private List<WarehouseLocation> GetAvailableLocations(int? warehouseId)
    {
        if (!warehouseId.HasValue || warehouseId.Value <= 0)
        {
            return new List<WarehouseLocation>();
        }
        
        return WarehouseLocations.Where(l => l.WarehouseId == warehouseId.Value).ToList();
    }

    private int GetValidItemCount()
    {
        return StockDetailItems.Count(item => item.SelectedWarehouseId.HasValue && item.SelectedWarehouseId.Value > 0);
    }

    private int GetTotalCurrentStock()
    {
        return StockDetailItems
            .Where(item => item.SelectedWarehouseId.HasValue && item.SelectedWarehouseId.Value > 0)
            .Sum(item => item.CurrentStock);
    }

    private int GetTotalAvailableStock()
    {
        return StockDetailItems
            .Where(item => item.SelectedWarehouseId.HasValue && item.SelectedWarehouseId.Value > 0)
            .Sum(item => item.CurrentStock - item.ReservedStock);
    }

    private int GetTotalInTransitStock()
    {
        return StockDetailItems
            .Where(item => item.SelectedWarehouseId.HasValue && item.SelectedWarehouseId.Value > 0)
            .Sum(item => item.InTransitStock);
    }

    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        var nonEmptyItems = StockDetailItems
            .Where(item => item.SelectedWarehouseId.HasValue && item.SelectedWarehouseId.Value > 0)
            .ToList();
        
        if (nonEmptyItems.Count == 0)
        {
            errors.Add("è‡³å°‘éœ€è¦ä¸€ç­†åº«å­˜æ˜ç´°");
        }
        else
        {
            // æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡çš„å€‰åº«+åº«ä½çµ„åˆ
            var duplicates = nonEmptyItems
                .GroupBy(item => new { item.SelectedWarehouseId, item.SelectedWarehouseLocationId })
                .Where(g => g.Count() > 1)
                .ToList();
                
            if (duplicates.Any())
            {
                errors.Add("å­˜åœ¨é‡è¤‡çš„å€‰åº«èˆ‡åº«ä½çµ„åˆï¼Œè«‹ç¢ºèªå¾Œå†è©¦");
            }
            
            // æª¢æŸ¥é ç•™åº«å­˜æ˜¯å¦è¶…éç¾æœ‰åº«å­˜
            var invalidReserved = nonEmptyItems
                .Where(item => item.ReservedStock > item.CurrentStock)
                .ToList();
                
            if (invalidReserved.Any())
            {
                errors.Add("é ç•™åº«å­˜ä¸å¯è¶…éç¾æœ‰åº«å­˜");
            }
        }
          
        if (errors.Any())
        {
            var errorMessage = string.Join("\n", errors);
            await NotificationService.ShowErrorAsync(errorMessage);
            return false;
        }
        
        return true;
    }

    private bool CanDeleteItem(StockDetailItem item, out string reason)
    {
        if (item.ExistingDetailEntity == null || item.ExistingDetailEntity.Id <= 0)
        {
            reason = string.Empty;
            return true;
        }
        
        reason = string.Empty;
        return true;
    }

    private async Task ClearAllDetails()
    {
        StockDetailItems.Clear();
        
        await OnStockDetailItemsChanged.InvokeAsync(StockDetailItems);
        await NotifyDetailsChanged();
        
        await NotificationService.ShowSuccessAsync("å·²æ¸…ç©ºæ‰€æœ‰åº«å­˜æ˜ç´°");
    }

    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡çš„å€‰åº«+åº«ä½çµ„åˆ
    /// </summary>
    public (bool HasDuplicates, List<string> DuplicateInfo) CheckForDuplicates()
    {
        var nonEmptyItems = StockDetailItems
            .Where(item => item.SelectedWarehouseId.HasValue && item.SelectedWarehouseId.Value > 0)
            .ToList();
        
        var duplicates = nonEmptyItems
            .GroupBy(item => new { item.SelectedWarehouseId, item.SelectedWarehouseLocationId })
            .Where(g => g.Count() > 1)
            .Select(g => new
            {
                g.Key.SelectedWarehouseId,
                g.Key.SelectedWarehouseLocationId,
                Count = g.Count(),
                Items = g.ToList()
            })
            .ToList();

        if (!duplicates.Any())
        {
            return (false, new List<string>());
        }

        var duplicateInfo = new List<string>();
        foreach (var dup in duplicates)
        {
            var warehouseName = Warehouses.FirstOrDefault(w => w.Id == dup.SelectedWarehouseId)?.Name ?? $"å€‰åº«ID {dup.SelectedWarehouseId}";
            var locationName = dup.SelectedWarehouseLocationId.HasValue
                ? WarehouseLocations.FirstOrDefault(l => l.Id == dup.SelectedWarehouseLocationId)?.Name ?? $"åº«ä½ID {dup.SelectedWarehouseLocationId}"
                : "ï¼ˆç„¡æŒ‡å®šåº«ä½ï¼‰";
            
            duplicateInfo.Add($"{warehouseName} - {locationName}ï¼ˆå…± {dup.Count} ç­†ï¼‰");
        }

        return (true, duplicateInfo);
    }

    /// <summary>
    /// åˆä½µé‡è¤‡çš„å€‰åº«+åº«ä½çµ„åˆ
    /// </summary>
    public async Task<bool> MergeDuplicatesAsync()
    {
        try
        {
            var nonEmptyItems = StockDetailItems
                .Where(item => item.SelectedWarehouseId.HasValue && item.SelectedWarehouseId.Value > 0)
                .ToList();
            
            // æ‰¾å‡ºæ‰€æœ‰é‡è¤‡çš„çµ„åˆ
            var groupedItems = nonEmptyItems
                .GroupBy(item => new { item.SelectedWarehouseId, item.SelectedWarehouseLocationId })
                .ToList();

            var mergedItems = new List<StockDetailItem>();
            var hasMerged = false;

            foreach (var group in groupedItems)
            {
                if (group.Count() > 1)
                {
                    // æœ‰é‡è¤‡ï¼Œéœ€è¦åˆä½µ
                    hasMerged = true;
                    
                    var firstItem = group.First();
                    var mergedItem = new StockDetailItem
                    {
                        SelectedWarehouseId = firstItem.SelectedWarehouseId,
                        SelectedWarehouseLocationId = firstItem.SelectedWarehouseLocationId,
                        CurrentStock = group.Sum(i => i.CurrentStock),
                        ReservedStock = group.Sum(i => i.ReservedStock),
                        InTransitStock = group.Sum(i => i.InTransitStock),
                        // å¹³å‡æˆæœ¬ï¼šåŠ æ¬Šå¹³å‡
                        AverageCost = CalculateWeightedAverageCost(group.ToList()),
                        // æ‰¹è™Ÿï¼šåˆä½µï¼ˆå¦‚æœæœ‰å¤šå€‹ä¸åŒçš„æ‰¹è™Ÿï¼‰
                        BatchNumber = MergeBatchNumbers(group.Select(i => i.BatchNumber).ToList()),
                        // æ—¥æœŸï¼šå–æœ€æ—©çš„
                        BatchDate = group.Where(i => i.BatchDate.HasValue).OrderBy(i => i.BatchDate).FirstOrDefault()?.BatchDate,
                        ExpiryDate = group.Where(i => i.ExpiryDate.HasValue).OrderBy(i => i.ExpiryDate).FirstOrDefault()?.ExpiryDate,
                        // ä¿ç•™ç¬¬ä¸€å€‹çš„ ExistingDetailEntityï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                        ExistingDetailEntity = firstItem.ExistingDetailEntity
                    };
                    
                    mergedItems.Add(mergedItem);
                }
                else
                {
                    // æ²’æœ‰é‡è¤‡ï¼Œç›´æ¥åŠ å…¥
                    mergedItems.Add(group.First());
                }
            }

            if (hasMerged)
            {
                StockDetailItems.Clear();
                StockDetailItems.AddRange(mergedItems);
                
                await NotifyDetailsChanged();
                StateHasChanged();
                
                await NotificationService.ShowSuccessAsync("å·²æˆåŠŸåˆä½µé‡è¤‡çš„å€‰åº«èˆ‡åº«ä½");
                return true;
            }

            return false;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"åˆä½µæ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// è¨ˆç®—åŠ æ¬Šå¹³å‡æˆæœ¬
    /// </summary>
    private decimal? CalculateWeightedAverageCost(List<StockDetailItem> items)
    {
        var itemsWithCost = items.Where(i => i.AverageCost.HasValue && i.AverageCost.Value > 0).ToList();
        if (!itemsWithCost.Any()) return null;
        
        var totalCost = itemsWithCost.Sum(i => i.AverageCost!.Value * i.CurrentStock);
        var totalStock = itemsWithCost.Sum(i => i.CurrentStock);
        
        return totalStock > 0 ? totalCost / totalStock : null;
    }

    /// <summary>
    /// åˆä½µæ‰¹è™Ÿï¼ˆå¦‚æœæœ‰å¤šå€‹ä¸åŒæ‰¹è™Ÿï¼‰
    /// </summary>
    private string? MergeBatchNumbers(List<string?> batchNumbers)
    {
        var validBatchNumbers = batchNumbers
            .Where(b => !string.IsNullOrWhiteSpace(b))
            .Distinct()
            .ToList();
        
        if (!validBatchNumbers.Any()) return null;
        if (validBatchNumbers.Count == 1) return validBatchNumbers[0];
        
        // å¤šå€‹æ‰¹è™Ÿï¼Œç”¨é€—è™Ÿé€£æ¥
        return string.Join(", ", validBatchNumbers);
    }

    /// <summary>
    /// å…¬é–‹çš„åˆ·æ–°æ–¹æ³•ï¼Œç”¨æ–¼å¤–éƒ¨è§¸ç™¼æ˜ç´°åˆ·æ–°ï¼ˆä¾‹å¦‚ï¼šä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼‰
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadExistingDetailsAsync();
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }

    public class StockDetailItem
    {
        public int? SelectedWarehouseId { get; set; }
        public int? SelectedWarehouseLocationId { get; set; }
        public int CurrentStock { get; set; } = 0;
        public int ReservedStock { get; set; } = 0;
        public int InTransitStock { get; set; } = 0;
        public decimal? AverageCost { get; set; }
        public int? MinStockLevel { get; set; }
        public int? MaxStockLevel { get; set; }
        public string? BatchNumber { get; set; }
        public DateTime? BatchDate { get; set; }
        public DateTime? ExpiryDate { get; set; }
        public TDetailEntity? ExistingDetailEntity { get; set; }
    }
}
