@*
    庫存警戒檢視 Modal 組件
    用於顯示低庫存或庫存過多的商品清單（唯讀）
*@
@using ERPCore2.Data.Entities
@using ERPCore2.Services
@using ERPCore2.Components.Shared.Modals
@using ERPCore2.Components.Shared.SubCollections
@using ERPCore2.Models
@inject IInventoryStockService InventoryStockService
@inject INotificationService NotificationService

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@GetTitle()"
                   Icon="@GetHeaderIcon()"
                   Size="BaseModalComponent.ModalSize.ExtraLarge"
                   HeaderColor="@GetHeaderColor()"
                   UseWhiteCloseButton="@(AlertType == StockAlertType.OverStock)"
                   IsLoading="@isLoading"
                   LoadingMessage="正在載入庫存警戒資訊..."
                   BodyCssClass="p-4"
                   OnClose="@HandleClose">
    
    <BodyContent>
        @if (!stockAlertItems.Any())
        {
            <div class="alert @GetAlertCssClass() mb-0">
                <i class="bi bi-check-circle me-2"></i>
                @GetEmptyMessage()
            </div>
        }
        else
        {
            <div class="alert @GetAlertCssClass() mb-3">
                <i class="bi @GetAlertIcon() me-2"></i>
                共發現 <strong>@stockAlertItems.Count</strong> 筆 @GetAlertTypeText() 的商品
            </div>
            
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <InteractiveTableComponent TItem="StockAlertViewItem"
                                             Items="@stockAlertItems"
                                             ColumnDefinitions="@GetColumnDefinitions()"
                                             ShowHeader="true"
                                             ShowActions="false"
                                             ShowRowNumbers="true"
                                             IsStriped="true"
                                             IsHoverable="true"
                                             IsBordered="true"
                                             CssClass="mb-0" />
                </div>
            </div>
        }
    </BodyContent>
    
</BaseModalComponent>

@code {
    // ===== 參數定義 =====

    /// <summary>
    /// Modal 是否顯示
    /// </summary>
    [Parameter]
    public bool IsVisible { get; set; }

    /// <summary>
    /// Modal 顯示狀態變更事件
    /// </summary>
    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    /// <summary>
    /// 警戒類型：LowStock（低庫存）或 OverStock（庫存過多）
    /// </summary>
    [Parameter]
    public StockAlertType AlertType { get; set; } = StockAlertType.LowStock;

    // ===== 私有欄位 =====
    private bool isLoading = false;
    private List<StockAlertViewItem> stockAlertItems = new();

    // ===== 生命週期方法 =====

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isLoading && !stockAlertItems.Any())
        {
            await LoadStockAlertDataAsync();
        }
    }

    // ===== 資料載入方法 =====

    /// <summary>
    /// 載入庫存警戒資料
    /// </summary>
    private async Task LoadStockAlertDataAsync()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            List<InventoryStockDetail> details;
            
            if (AlertType == StockAlertType.LowStock)
            {
                details = await InventoryStockService.GetLowStockDetailsAsync();
            }
            else
            {
                details = await InventoryStockService.GetOverStockDetailsAsync();
            }
            
            stockAlertItems = details.Select(d => new StockAlertViewItem
            {
                DetailId = d.Id,
                ProductName = d.InventoryStock?.Product?.Name ?? "未知商品",
                WarehouseName = d.Warehouse?.Name ?? "未知倉庫",
                WarehouseLocationName = d.WarehouseLocation?.Name ?? "未指定",
                CurrentStock = d.CurrentStock,
                MinStockLevel = d.MinStockLevel ?? 0,
                MaxStockLevel = d.MaxStockLevel ?? 0,
                AlertType = AlertType
            }).ToList();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入庫存警戒資訊失敗：{ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // ===== 表格欄位定義 =====

    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = "商品名稱",
                PropertyName = nameof(StockAlertViewItem.ProductName),
                ColumnType = InteractiveColumnType.Display,
                Width = "20%"
            },
            new()
            {
                Title = "倉庫",
                PropertyName = nameof(StockAlertViewItem.WarehouseName),
                ColumnType = InteractiveColumnType.Display,
                Width = "12%"
            },
            new()
            {
                Title = "倉庫位置",
                PropertyName = nameof(StockAlertViewItem.WarehouseLocationName),
                ColumnType = InteractiveColumnType.Display,
                Width = "12%"
            },
            new()
            {
                Title = "當前數量",
                PropertyName = nameof(StockAlertViewItem.CurrentStock),
                ColumnType = InteractiveColumnType.Display,
                Width = "10%",
                CellCssClass = "text-end fw-bold"
            },
            new()
            {
                Title = "最低量",
                PropertyName = nameof(StockAlertViewItem.MinStockLevel),
                ColumnType = InteractiveColumnType.Display,
                Width = "10%",
                CellCssClass = "text-end"
            },
            new()
            {
                Title = "最高量",
                PropertyName = nameof(StockAlertViewItem.MaxStockLevel),
                ColumnType = InteractiveColumnType.Display,
                Width = "10%",
                CellCssClass = "text-end"
            },
            new()
            {
                Title = "警戒狀態",
                PropertyName = nameof(StockAlertViewItem.AlertStatus),
                ColumnType = InteractiveColumnType.Display,
                Width = "18%",
                CellCssClass = AlertType == StockAlertType.LowStock ? "text-warning fw-bold" : "text-info fw-bold"
            }
        };

        return columns;
    }

    // ===== UI 輔助方法 =====

    private BaseModalComponent.HeaderVariant GetHeaderColor()
    {
        return AlertType == StockAlertType.LowStock 
            ? BaseModalComponent.HeaderVariant.Warning
            : BaseModalComponent.HeaderVariant.Info;
    }

    private string GetHeaderIcon()
    {
        return AlertType == StockAlertType.LowStock 
            ? "bi-exclamation-triangle" 
            : "bi-inbox-fill";
    }

    private string GetTitle()
    {
        return AlertType == StockAlertType.LowStock 
            ? "低庫存警戒商品清單" 
            : "庫存過多警戒商品清單";
    }

    private string GetAlertCssClass()
    {
        return AlertType == StockAlertType.LowStock 
            ? "alert-warning" 
            : "alert-info";
    }

    private string GetAlertIcon()
    {
        return AlertType == StockAlertType.LowStock 
            ? "bi-exclamation-triangle-fill" 
            : "bi-info-circle-fill";
    }

    private string GetAlertTypeText()
    {
        return AlertType == StockAlertType.LowStock 
            ? "低庫存" 
            : "庫存過多";
    }

    private string GetEmptyMessage()
    {
        return AlertType == StockAlertType.LowStock 
            ? "太棒了！目前沒有低於警戒線的商品。" 
            : "太棒了！目前沒有超過警戒線的商品。";
    }

    // ===== 事件處理方法 =====

    /// <summary>
    /// 處理關閉 Modal
    /// </summary>
    private void HandleClose()
    {
        stockAlertItems.Clear();
    }

    // ===== 列舉與內部類別 =====

    /// <summary>
    /// 庫存警戒類型
    /// </summary>
    public enum StockAlertType
    {
        /// <summary>
        /// 低庫存（當前數量 < 最低量）
        /// </summary>
        LowStock,
        
        /// <summary>
        /// 庫存過多（當前數量 > 最高量）
        /// </summary>
        OverStock
    }

    /// <summary>
    /// 庫存警戒檢視項目
    /// </summary>
    public class StockAlertViewItem
    {
        public int DetailId { get; set; }
        public string ProductName { get; set; } = string.Empty;
        public string WarehouseName { get; set; } = string.Empty;
        public string WarehouseLocationName { get; set; } = string.Empty;
        public int CurrentStock { get; set; }
        public int MinStockLevel { get; set; }
        public int MaxStockLevel { get; set; }
        public StockAlertType AlertType { get; set; }

        /// <summary>
        /// 警戒狀態文字
        /// </summary>
        public string AlertStatus
        {
            get
            {
                if (AlertType == StockAlertType.LowStock)
                {
                    var shortage = MinStockLevel - CurrentStock;
                    return $"低於警戒線 {shortage} 個";
                }
                else
                {
                    var excess = CurrentStock - MaxStockLevel;
                    return $"超出警戒線 {excess} 個";
                }
            }
        }
    }
}
