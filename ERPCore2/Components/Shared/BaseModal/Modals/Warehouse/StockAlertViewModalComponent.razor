@*
    庫存警戒檢視 Modal 組件
    用於顯示低庫存或庫存過多的商品清單（唯讀）
*@
@using ERPCore2.Data.Entities
@using ERPCore2.Services
@using ERPCore2.Components.Shared.Modals
@using ERPCore2.Components.Shared.SubCollections
@using ERPCore2.Components.Pages.Purchase
@using ERPCore2.Models
@inject IInventoryStockService InventoryStockService
@inject ISupplierRecommendationService SupplierRecommendationService
@inject INotificationService NotificationService

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@GetTitle()"
                   Icon="@GetHeaderIcon()"
                   Size="BaseModalComponent.ModalSize.ExtraLarge"
                   HeaderColor="@GetHeaderColor()"
                   UseWhiteCloseButton="@(AlertType == StockAlertType.OverStock)"
                   IsLoading="@isLoading"
                   LoadingMessage="正在載入庫存警戒資訊..."
                   BodyCssClass="p-4"
                   OnClose="@HandleClose">
    
    <BodyContent>
        @if (!stockAlertItems.Any())
        {
            <div class="alert @GetAlertCssClass() mb-0">
                <i class="bi bi-check-circle me-2"></i>
                @GetEmptyMessage()
            </div>
        }
        else
        {
            <div class="alert @GetAlertCssClass() mb-3">
                <i class="bi @GetAlertIcon() me-2"></i>
                共發現 <strong>@stockAlertItems.Count</strong> 筆 @GetAlertTypeText() 的商品
            </div>
            
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <InteractiveTableComponent TItem="StockAlertViewItem"
                                             Items="@stockAlertItems"
                                             ColumnDefinitions="@GetColumnDefinitions()"
                                             ShowHeader="true"
                                             ShowActions="false"
                                             ShowRowNumbers="true"
                                             IsStriped="true"
                                             IsHoverable="true"
                                             IsBordered="true"
                                             CssClass="mb-0" />
                </div>
            </div>
        }
    </BodyContent>
    
</BaseModalComponent>

@* 供應商推薦 Modal *@
<RelatedDocumentsModalComponent IsVisible="@showSupplierRecommendationModal"
                               IsVisibleChanged="@((bool visible) => showSupplierRecommendationModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@supplierRecommendations"
                               IsLoading="@isLoadingRecommendations"
                               OnDocumentClick="@HandleSupplierClick"
                               OnAddNew="@HandleCreatePurchaseOrder" />

@* 採購單編輯 Modal *@
<PurchaseOrderEditModalComponent @ref="purchaseOrderEditModal"
                                IsVisible="@showPurchaseOrderModal"
                                IsVisibleChanged="@((bool visible) => showPurchaseOrderModal = visible)"
                                PurchaseOrderId="@selectedPurchaseOrderId"
                                OnPurchaseOrderSaved="@HandlePurchaseOrderSaved"
                                OnCancel="@(() => showPurchaseOrderModal = false)" />

@code {
    // ===== 參數定義 =====

    /// <summary>
    /// Modal 是否顯示
    /// </summary>
    [Parameter]
    public bool IsVisible { get; set; }

    /// <summary>
    /// Modal 顯示狀態變更事件
    /// </summary>
    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    /// <summary>
    /// 警戒類型：LowStock（低庫存）或 OverStock（庫存過多）
    /// </summary>
    [Parameter]
    public StockAlertType AlertType { get; set; } = StockAlertType.LowStock;

    // ===== 私有欄位 =====
    private bool isLoading = false;
    private List<StockAlertViewItem> stockAlertItems = new();
    
    // 供應商推薦相關
    private bool showSupplierRecommendationModal = false;
    private bool isLoadingRecommendations = false;
    private string selectedProductName = string.Empty;
    private int selectedProductId = 0;
    private List<RelatedDocument> supplierRecommendations = new();
    
    // 採購單相關
    private PurchaseOrderEditModalComponent? purchaseOrderEditModal;
    private bool showPurchaseOrderModal = false;
    private int? selectedPurchaseOrderId = null;

    // ===== 生命週期方法 =====

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isLoading && !stockAlertItems.Any())
        {
            await LoadStockAlertDataAsync();
        }
    }

    // ===== 資料載入方法 =====

    /// <summary>
    /// 載入庫存警戒資料
    /// </summary>
    private async Task LoadStockAlertDataAsync()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            List<InventoryStockDetail> details;
            
            if (AlertType == StockAlertType.LowStock)
            {
                details = await InventoryStockService.GetLowStockDetailsAsync();
            }
            else
            {
                details = await InventoryStockService.GetOverStockDetailsAsync();
            }
            
            stockAlertItems = details.Select(d => new StockAlertViewItem
            {
                DetailId = d.Id,
                ProductId = d.InventoryStock?.ProductId ?? 0,
                ProductName = d.InventoryStock?.Product?.Name ?? "未知商品",
                WarehouseName = d.Warehouse?.Name ?? "未知倉庫",
                WarehouseLocationName = d.WarehouseLocation?.Name ?? "未指定",
                CurrentStock = d.CurrentStock,
                MinStockLevel = d.MinStockLevel ?? 0,
                MaxStockLevel = d.MaxStockLevel ?? 0,
                AlertType = AlertType
            }).ToList();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入庫存警戒資訊失敗：{ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // ===== 表格欄位定義 =====

    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = "商品名稱",
                PropertyName = nameof(StockAlertViewItem.ProductName),
                ColumnType = InteractiveColumnType.Display,
                Width = "200px"
            },
            new()
            {
                Title = "倉庫",
                PropertyName = nameof(StockAlertViewItem.WarehouseName),
                ColumnType = InteractiveColumnType.Display,
                Width = "120px"
            },
            new()
            {
                Title = "倉庫位置",
                PropertyName = nameof(StockAlertViewItem.WarehouseLocationName),
                ColumnType = InteractiveColumnType.Display,
                Width = "120px"
            },
            new()
            {
                Title = "當前數量",
                PropertyName = nameof(StockAlertViewItem.CurrentStock),
                ColumnType = InteractiveColumnType.Display,
                Width = "100px",
                CellCssClass = "text-end fw-bold"
            },
            new()
            {
                Title = "最低量",
                PropertyName = nameof(StockAlertViewItem.MinStockLevel),
                ColumnType = InteractiveColumnType.Display,
                Width = "100px",
                CellCssClass = "text-end"
            },
            new()
            {
                Title = "最高量",
                PropertyName = nameof(StockAlertViewItem.MaxStockLevel),
                ColumnType = InteractiveColumnType.Display,
                Width = "100px",
                CellCssClass = "text-end"
            },
            new()
            {
                Title = "警戒狀態",
                PropertyName = nameof(StockAlertViewItem.AlertStatus),
                ColumnType = InteractiveColumnType.Display,
                Width = "180px",
                CellCssClass = AlertType == StockAlertType.LowStock ? "text-warning" : "text-info"
            }
        };
        
        // 如果是低庫存警戒，加入「尋找供應商」按鈕欄位
        if (AlertType == StockAlertType.LowStock)
        {
            columns.Add(new InteractiveColumnDefinition
            {
                Title = "操作",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "80px",
                CustomTemplate = item =>
                {
                    var stockItem = (StockAlertViewItem)item;
                    return @<GenericButtonComponent
                                                  Text="下單"
                                                   Variant="ButtonVariant.Green"
                                                   Size="ButtonSize.Small"
                                                   Title="立即下單"
                                                   OnClick="@(async () => await HandleFindSuppliers(stockItem))" />;
                }
            });
        }

        return columns;
    }

    // ===== UI 輔助方法 =====

    private BaseModalComponent.HeaderVariant GetHeaderColor()
    {
        return AlertType == StockAlertType.LowStock 
            ? BaseModalComponent.HeaderVariant.Warning
            : BaseModalComponent.HeaderVariant.Info;
    }

    private string GetHeaderIcon()
    {
        return AlertType == StockAlertType.LowStock 
            ? "bi-exclamation-triangle" 
            : "bi-inbox-fill";
    }

    private string GetTitle()
    {
        return AlertType == StockAlertType.LowStock 
            ? "低庫存警戒商品清單" 
            : "庫存過多警戒商品清單";
    }

    private string GetAlertCssClass()
    {
        return AlertType == StockAlertType.LowStock 
            ? "alert-warning" 
            : "alert-info";
    }

    private string GetAlertIcon()
    {
        return AlertType == StockAlertType.LowStock 
            ? "bi-exclamation-triangle-fill" 
            : "bi-info-circle-fill";
    }

    private string GetAlertTypeText()
    {
        return AlertType == StockAlertType.LowStock 
            ? "低庫存" 
            : "庫存過多";
    }

    private string GetEmptyMessage()
    {
        return AlertType == StockAlertType.LowStock 
            ? "太棒了！目前沒有低於警戒線的商品。" 
            : "太棒了！目前沒有超過警戒線的商品。";
    }

    // ===== 事件處理方法 =====

    /// <summary>
    /// 處理關閉 Modal
    /// </summary>
    private void HandleClose()
    {
        stockAlertItems.Clear();
    }

    /// <summary>
    /// 處理「尋找供應商」按鈕點擊
    /// </summary>
    private async Task HandleFindSuppliers(StockAlertViewItem item)
    {
        try
        {
            isLoadingRecommendations = true;
            selectedProductName = item.ProductName;
            selectedProductId = item.ProductId;
            showSupplierRecommendationModal = true;
            
            // 載入供應商推薦
            var recommendations = await SupplierRecommendationService.GetRecommendedSuppliersAsync(selectedProductId);
            
            supplierRecommendations = recommendations.Select(r => new RelatedDocument
            {
                DocumentId = r.SupplierId,
                DocumentType = RelatedDocumentType.SupplierRecommendation,
                DocumentNumber = $"{r.SupplierCode} - {r.SupplierName}",
                DocumentDate = r.LastPurchaseDate ?? DateTime.Now,
                Quantity = r.PurchaseCount,
                UnitPrice = r.LastPurchasePrice,
                Amount = r.AveragePrice,
                CurrentAmount = r.LowestPrice,
                TotalAmount = r.HighestPrice,
                Remarks = GetSupplierRemarks(r)
            }).ToList();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入供應商推薦失敗：{ex.Message}");
        }
        finally
        {
            isLoadingRecommendations = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// 產生供應商備註資訊
    /// </summary>
    private string GetSupplierRemarks(SupplierRecommendation recommendation)
    {
        var remarks = new List<string>();
        
        if (recommendation.IsPreferred)
        {
            remarks.Add($"⭐ 常用供應商 (優先順序: {recommendation.Priority})");
        }
        
        if (recommendation.LeadTimeDays.HasValue)
        {
            remarks.Add($"交貨: {recommendation.LeadTimeDays}天");
        }
        
        if (!string.IsNullOrEmpty(recommendation.SupplierProductCode))
        {
            remarks.Add($"料號: {recommendation.SupplierProductCode}");
        }
        
        if (recommendation.PurchaseCount > 0)
        {
            remarks.Add($"採購次數: {recommendation.PurchaseCount}次");
        }
        
        return string.Join(" | ", remarks);
    }

    /// <summary>
    /// 處理供應商點擊（開啟採購單並預填供應商和商品）
    /// </summary>
    private async Task HandleSupplierClick(RelatedDocument document)
    {
        try
        {
            // 關閉供應商推薦Modal
            showSupplierRecommendationModal = false;
            
            // 開啟採購單並預填資料
            if (purchaseOrderEditModal != null)
            {
                await purchaseOrderEditModal.ShowAddModalWithPrefilledData(
                    supplierId: document.DocumentId,
                    productId: selectedProductId,
                    suggestedUnitPrice: document.UnitPrice
                );
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"開啟採購單失敗：{ex.Message}");
        }
    }

    /// <summary>
    /// 處理「立即採購」按鈕（從供應商推薦Modal的新增按鈕）
    /// </summary>
    private async Task HandleCreatePurchaseOrder()
    {
        try
        {
            // 關閉供應商推薦Modal
            showSupplierRecommendationModal = false;
            
            // 開啟空白採購單（讓用戶自行選擇供應商）
            selectedPurchaseOrderId = null;
            showPurchaseOrderModal = true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"開啟採購單失敗：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 處理採購單儲存成功
    /// </summary>
    private async Task HandlePurchaseOrderSaved(PurchaseOrder savedOrder)
    {
        showPurchaseOrderModal = false;
        await NotificationService.ShowSuccessAsync($"採購單 {savedOrder.Code} 已建立成功");
        
        // 可選：重新載入庫存警戒資料
        // await LoadStockAlertDataAsync();
    }

    // ===== 列舉與內部類別 =====

    /// <summary>
    /// 庫存警戒類型
    /// </summary>
    public enum StockAlertType
    {
        /// <summary>
        /// 低庫存（當前數量 < 最低量）
        /// </summary>
        LowStock,
        
        /// <summary>
        /// 庫存過多（當前數量 > 最高量）
        /// </summary>
        OverStock
    }

    /// <summary>
    /// 庫存警戒檢視項目
    /// </summary>
    public class StockAlertViewItem
    {
        public int DetailId { get; set; }
        public int ProductId { get; set; }
        public string ProductName { get; set; } = string.Empty;
        public string WarehouseName { get; set; } = string.Empty;
        public string WarehouseLocationName { get; set; } = string.Empty;
        public int CurrentStock { get; set; }
        public int MinStockLevel { get; set; }
        public int MaxStockLevel { get; set; }
        public StockAlertType AlertType { get; set; }

        /// <summary>
        /// 警戒狀態文字
        /// </summary>
        public string AlertStatus
        {
            get
            {
                if (AlertType == StockAlertType.LowStock)
                {
                    var shortage = MinStockLevel - CurrentStock;
                    return $"低於警戒線 {shortage} 個";
                }
                else
                {
                    var excess = CurrentStock - MaxStockLevel;
                    return $"超出警戒線 {excess} 個";
                }
            }
        }
    }
}
