@* 商品合成明細管理組件 - 管理配方的材料清單 - 使用 InteractiveTableComponent 統一UI *@

@inject INotificationService NotificationService
@inject IProductService ProductService
@inject IUnitService UnitService
@using ERPCore2.Helpers
@using ERPCore2.Data.Entities

<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <InteractiveTableComponent TItem="ProductCompositionDetail" 
                                  Items="@Items"
                                  ColumnDefinitions="@GetColumnDefinitions()"
                                  IsReadOnly="@IsReadOnly"
                                  ShowRowNumbers="true"
                                  EmptyMessage="@EmptyMessage"
                                  ShowBuiltInActions="true"
                                  ShowBuiltInDeleteButton="true"
                                  OnItemDelete="@HandleItemDelete"
                                  EnableAutoEmptyRow="true"
                                  DataLoadCompleted="@_dataLoadCompleted"
                                  CreateEmptyItem="@CreateEmptyItem" />
    </div>
</div>

@code {
    // ===== 私有欄位 =====
    private readonly HashSet<int> _deletedDetailIds = new HashSet<int>();
    private bool _dataLoadCompleted = true;  // 資料載入完成標記

    // ===== 基本參數 =====
    [Parameter] public List<ProductCompositionDetail> Items { get; set; } = new();
    [Parameter] public List<Product> AvailableProducts { get; set; } = new(); // 可選擇的商品清單
    [Parameter] public List<Unit> AvailableUnits { get; set; } = new(); // 可選擇的單位清單
    [Parameter] public int ParentEntityId { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== 現有明細（用於編輯模式） =====
    [Parameter] public List<ProductCompositionDetail>? ExistingDetails { get; set; }
    
    // ===== 顯示設定 =====
    [Parameter] public string Title { get; set; } = "材料清單";
    [Parameter] public string Subtitle { get; set; } = "";
    [Parameter] public string Icon { get; set; } = "box-seam";
    [Parameter] public string ItemDisplayName { get; set; } = "材料";
    [Parameter] public string EmptyIcon { get; set; } = "box-seam-x";
    [Parameter] public string EmptyMessage { get; set; } = "尚未新增材料";
    
    // ===== 事件參數 =====
    [Parameter] public EventCallback<List<ProductCompositionDetail>> ItemsChanged { get; set; }
    [Parameter] public EventCallback<ProductCompositionDetail> ItemAdded { get; set; }
    [Parameter] public EventCallback<ProductCompositionDetail> ItemRemoved { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    
    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        
        // 載入可用的商品和單位清單
        await LoadAvailableDataAsync();
        
        // 載入現有明細（編輯模式）
        await LoadExistingDetailsAsync();
    }

    // ===== 資料載入 =====
    private async Task LoadAvailableDataAsync()
    {
        try
        {
            if (!AvailableProducts.Any())
            {
                AvailableProducts = await ProductService.GetAllAsync();
            }
            
            if (!AvailableUnits.Any())
            {
                AvailableUnits = await UnitService.GetAllAsync();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入資料時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 載入現有明細（編輯模式）
    /// </summary>
    private Task LoadExistingDetailsAsync()
    {
        if (ExistingDetails?.Any() != true) return Task.CompletedTask;

        //  開始載入資料 - 設定為未完成
        _dataLoadCompleted = false;
        
        Items.Clear();
        
        foreach (var detail in ExistingDetails)
        {
            Items.Add(detail);
        }
        
        //  資料載入完成 - 觸發空行檢查
        _dataLoadCompleted = true;
        StateHasChanged();
        
        return Task.CompletedTask;
    }

    // ===== 建立空項目方法 =====
    
    /// <summary>
    /// 創建空的明細項目
    /// </summary>
    private ProductCompositionDetail CreateEmptyItem()
    {
        var newItem = new ProductCompositionDetail
        {
            ProductCompositionId = ParentEntityId,
            ComponentProductId = 0,      // ID 預設 0 (新增時會被覆蓋)
            Quantity = 0,                 // 預設 0 (新增時會被覆蓋)
            UnitId = null,
            ComponentProduct = null!      //  Navigation Property 為 null，用於空行判斷
        };
        return newItem;
    }

    // ===== InteractiveTableComponent 方法 =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            // 材料商品選擇欄位
            new() 
            { 
                Title = "材料名稱", 
                Tooltip = "選擇配方所需的材料或半成品",
                PropertyName = nameof(ProductCompositionDetail.ComponentProductId),
                EmptyCheckPropertyName = nameof(ProductCompositionDetail.ComponentProduct), //  檢查 Navigation Property
                TriggerEmptyRowOnFilled = true,  //  設定為觸發欄位
                ColumnType = InteractiveColumnType.Select,
                Width = "300px",
                Options = AvailableProducts.Select(p => new InteractiveSelectOption 
                { 
                    Value = p.Id.ToString(), 
                    Text = GetProductDisplayText(p) 
                }).ToList(),
                OnSelectionChanged = EventCallback.Factory.Create<(object, object?)>(this, async args =>
                {
                    await OnProductChanged(args);
                })
            },
            
            // 所需數量 - 數字輸入
            new() 
            { 
                Title = "所需數量", 
                Tooltip = "輸入此材料所需的數量",
                PropertyName = nameof(ProductCompositionDetail.Quantity),
                ColumnType = InteractiveColumnType.Number,
                Width = "120px",
                CellCssClass = "text-end",
                MinValue = 0,
                OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
                {
                    await OnQuantityChanged(args);
                })
            },
            
            // 單位選擇欄位 -  改用內建 Select 類型
            new() 
            { 
                Title = "單位", 
                Tooltip = "選擇材料的計量單位",
                PropertyName = nameof(ProductCompositionDetail.UnitId),
                ColumnType = InteractiveColumnType.Select,
                Width = "120px",
                Options = AvailableUnits.Select(u => new InteractiveSelectOption 
                { 
                    Value = u.Id.ToString(), 
                    Text = u.Name 
                }).ToList(),
                OnSelectionChanged = EventCallback.Factory.Create<(object, object?)>(this, async args =>
                {
                    await OnUnitChanged(args);
                })
            }
        };
    }

    private async Task HandleItemDelete(ProductCompositionDetail item)
    {
        var index = Items.IndexOf(item);
        await RemoveItemAsync(index);
    }

    // ===== 內部方法 =====

    private string GetProductDisplayText(Product product)
    {
        if (!string.IsNullOrWhiteSpace(product.Code))
        {
            return $"{product.Code} - {product.Name}";
        }
        return product.Name;
    }

    // ===== InteractiveTableComponent 事件處理 =====
    private async Task OnProductChanged((object item, object? value) args)
    {
        var detail = (ProductCompositionDetail)args.item;
    
        if (args.value != null && !string.IsNullOrEmpty(args.value.ToString()) && int.TryParse(args.value.ToString(), out var productId) && productId > 0)
        {
            // 檢查是否已存在相同材料（檢查 ComponentProduct 而非 ComponentProductId）
            var existingProductIds = Items.Where(i => i != detail && i.ComponentProduct != null).Select(i => i.ComponentProductId);
            if (existingProductIds.Any(id => id == productId))
            {
                await NotificationService.ShowErrorAsync("此材料已存在，請選擇其他材料");
                detail.ComponentProductId = 0;
                detail.ComponentProduct = null!;  //  清空 Navigation Property
            }
            else
            {
                detail.ComponentProductId = productId;
                
                //  同步更新 Navigation Property
                var selectedProduct = AvailableProducts.FirstOrDefault(p => p.Id == productId);
                if (selectedProduct != null)
                {
                    detail.ComponentProduct = selectedProduct;
                    
                    // 自動設定該商品的預設單位
                    if (selectedProduct.UnitId.HasValue)
                    {
                        detail.UnitId = selectedProduct.UnitId;
                        detail.Unit = await UnitService.GetByIdAsync(selectedProduct.UnitId.Value);
                    }
                }
                
                await ItemsChanged.InvokeAsync(Items);
            }
        }
        else
        {
            detail.ComponentProductId = 0;
            detail.ComponentProduct = null!;  //  清空 Navigation Property
            await ItemsChanged.InvokeAsync(Items);
        }
        StateHasChanged();
    }

    private async Task OnQuantityChanged((object item, string? value) args)
    {
        var detail = (ProductCompositionDetail)args.item;
        
        if (!string.IsNullOrWhiteSpace(args.value) && decimal.TryParse(args.value, out var quantity))
        {
            detail.Quantity = quantity;
        }
        else
        {
            detail.Quantity = 0;
        }
        
        await ItemsChanged.InvokeAsync(Items);
        StateHasChanged();
    }

    private async Task OnUnitChanged((object item, object? value) args)
    {
        var detail = (ProductCompositionDetail)args.item;
        
        if (args.value != null && !string.IsNullOrEmpty(args.value.ToString()) && int.TryParse(args.value.ToString(), out var unitId) && unitId > 0)
        {
            detail.UnitId = unitId;
            
            //  同步更新 Navigation Property
            detail.Unit = await UnitService.GetByIdAsync(unitId);
        }
        else
        {
            detail.UnitId = null;
            detail.Unit = null;  //  清空 Navigation Property
        }
        
        await ItemsChanged.InvokeAsync(Items);
        StateHasChanged();
    }
    
    public async Task RemoveItemAsync(int index)
    {
        if (IsReadOnly || index < 0 || index >= Items.Count) return;
        
        var removedItem = Items[index];
        if (removedItem == null) return;
        
        // 記錄要刪除的資料庫實體ID
        if (removedItem.Id > 0)
        {
            _deletedDetailIds.Add(removedItem.Id);
        }
        
        Items.Remove(removedItem);
        
        await ItemRemoved.InvokeAsync(removedItem);
        await ItemsChanged.InvokeAsync(Items);
        
        // 通知已刪除的明細ID
        await NotifyDeletedDetailsChanged();
        
        StateHasChanged();
    }
    
    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        //  取得非空的項目（檢查 ComponentProduct Navigation Property）
        var nonEmptyItems = Items.Where(item => item.ComponentProduct != null).ToList();
        
        if (!nonEmptyItems.Any())
        {
            errors.Add("至少需要一個材料");
        }
        else
        {
            // 檢查重複材料
            var productIds = nonEmptyItems.Select(item => item.ComponentProductId).ToList();
            if (productIds.Count != productIds.Distinct().Count())
            {
                errors.Add("存在重複的材料");
            }
            
            // 檢查數量是否有效
            var invalidQuantities = nonEmptyItems.Where(item => item.Quantity <= 0).ToList();
            if (invalidQuantities.Any())
            {
                errors.Add("所有材料的數量必須大於 0");
            }
        }
          
        if (errors.Any())
        {
            var errorMessage = string.Join("\n", errors);
            await NotificationService.ShowErrorAsync(errorMessage);
            return false;
        }
        
        return true;
    }
    
    /// <summary>
    /// 通知已刪除的明細ID
    /// </summary>
    private async Task NotifyDeletedDetailsChanged()
    {
        if (OnDeletedDetailsChanged.HasDelegate && _deletedDetailIds.Any())
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds.ToList());
            _deletedDetailIds.Clear(); // 清空已通知的刪除ID
        }
    }
    
    /// <summary>
    /// 公開的刷新方法，用於外部觸發明細刷新（例如：上下筆切換時）
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadExistingDetailsAsync();
        StateHasChanged();
    }
    
    /// <summary>
    /// 取得非空的明細項目（供父組件使用）
    /// </summary>
    public List<ProductCompositionDetail> GetNonEmptyItems()
    {
        //  檢查 ComponentProduct Navigation Property
        return Items.Where(item => item.ComponentProduct != null).ToList();
    }
    
    /// <summary>
    /// 取得已刪除的明細ID清單（供父組件使用）
    /// </summary>
    public List<int> GetDeletedDetailIds()
    {
        return _deletedDetailIds.ToList();
    }
}
