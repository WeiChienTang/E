@inject IUnitConversionService UnitConversionService
@inject IUnitService UnitService
@inject INotificationService NotificationService

<BaseModalComponent Title="å–®ä½æ›ç®—ç®¡ç†"
                   Size="BaseModalComponent.ModalSize.Large"
                   IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   ShowFooter="false"
                   OnClose="@HandleModalClose"
                   @ref="modalRef">
    
    <HeaderButtons>
        <div class="d-flex gap-2 align-items-center">
            <GenericButtonComponent Text="å„²å­˜"
                                  Variant="ButtonVariant.Green"
                                  Size="ButtonSize.Small"
                                  OnClick="@HandleSaveAll" />
        </div>
    </HeaderButtons>
    
    <BodyContent>
        <!-- èªªæ˜æç¤º -->
        <div class="alert alert-info mb-3">
            <i class="bi bi-info-circle me-1"></i>
            ğŸ’¡ åœ¨ä¸‹æ–¹è¡¨æ ¼è¼¸å…¥æ›ç®—è¦å‰‡ï¼Œå®Œæˆå¾Œè«‹é»æ“Šã€Œå„²å­˜ã€æŒ‰éˆ•ã€‚èªªæ˜: 1å€‹ä¾†æºå–®ä½ = Nå€‹ç›®æ¨™å–®ä½ï¼ˆä¾‹å¦‚: 1 åŒ… = 30 å…¬æ–¤ï¼Œå‰‡æ›ç®—ä¿‚æ•¸ç‚º 30ï¼‰
        </div>
        
        <!-- è³‡æ–™è¡¨ -->
        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                <InteractiveTableComponent TItem="UnitConversionItem"
                                         Items="@conversions"
                                         ColumnDefinitions="@GetColumnDefinitions()"
                                         EnableAutoEmptyRow="true"
                                         CreateEmptyItem="@CreateEmptyConversion"
                                         ShowRowNumbers="false"
                                         EmptyMessage="å°šç„¡æ›ç®—è¦å‰‡ï¼Œè«‹åœ¨ä¸‹æ–¹ç©ºè¡Œè¼¸å…¥æ–°è¦å‰‡"
                                         OnItemDelete="@HandleItemDelete" />
            </div>
        </div>
    </BodyContent>
    
</BaseModalComponent>

@code {
    // === Parameters ===
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public EventCallback OnRefreshRequired { get; set; }
    
    // === References ===
    private BaseModalComponent? modalRef;
    
    // === Data ===
    private List<UnitConversionItem> conversions = new();
    private List<Unit> allUnits = new();
    private List<UnitConversion> pendingDeletions = new();  // å¾…åˆªé™¤çš„ç¾æœ‰å¯¦é«”
    
    // === åŒ…è£é¡åˆ¥ï¼ˆä½¿ç”¨ nullable é¡å‹ç¢ºä¿ç©ºå€¼åˆ¤æ–·æ­£ç¢ºï¼‰===
    public class UnitConversionItem
    {
        public int? FromUnitId { get; set; }
        public int? ToUnitId { get; set; }
        public decimal? ConversionRate { get; set; }
        public bool IsActive { get; set; } = true;
        public UnitConversion? ExistingEntity { get; set; }
    }
    
    // === Lifecycle Methods ===
    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        
        if (IsVisible)
        {
            await LoadDataAsync();
        }
    }
    
    private async Task LoadDataAsync()
    {
        try
        {
            // è¼‰å…¥å–®ä½è³‡æ–™
            allUnits = await UnitService.GetAllAsync();
            
            // è¼‰å…¥æ›ç®—è¦å‰‡ä¸¦è½‰æ›ç‚º UnitConversionItem
            var dbConversions = await UnitConversionService.GetAllAsync();
            conversions = dbConversions.Select(c => new UnitConversionItem
            {
                FromUnitId = c.FromUnitId,
                ToUnitId = c.ToUnitId,
                ConversionRate = c.ConversionRate,
                IsActive = c.IsActive,
                ExistingEntity = c
            }).ToList();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥è³‡æ–™å¤±æ•—: {ex.Message}");
        }
    }
    
    private UnitConversionItem CreateEmptyConversion()
    {
        return new UnitConversionItem
        {
            FromUnitId = null,
            ToUnitId = null,
            ConversionRate = null,
            IsActive = true,
            ExistingEntity = null
        };
    }
    
    // === Event Handlers ===
    private async Task HandleToggleActive(UnitConversionItem item)
    {
        if (item.ExistingEntity == null) return;
        
        var conversion = item.ExistingEntity;
        
        try
        {
            conversion.IsActive = item.IsActive;
            conversion.UpdatedAt = DateTime.Now;
            conversion.UpdatedBy = "System";
            
            var result = await UnitConversionService.UpdateAsync(conversion);
            
            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync($"å·²{(conversion.IsActive ? "å•Ÿç”¨" : "åœç”¨")}æ›ç®—è¦å‰‡");
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage);
                conversion.IsActive = !conversion.IsActive;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æ“ä½œå¤±æ•—: {ex.Message}");
            conversion.IsActive = !conversion.IsActive;
        }
        
        StateHasChanged();
    }
    
    private Task HandleItemDelete(UnitConversionItem item)
    {
        if (item.ExistingEntity != null)
        {
            // ç¾æœ‰é …ç›®ï¼šåŠ å…¥å¾…åˆªé™¤åˆ—è¡¨
            pendingDeletions.Add(item.ExistingEntity);
        }
        
        // ç„¡è«–æ˜¯æ–°å¢é‚„æ˜¯ç¾æœ‰é …ç›®ï¼Œéƒ½ç›´æ¥å¾åˆ—è¡¨ç§»é™¤ï¼ˆç«‹å³å¾UIä¸Šéš±è—ï¼‰
        conversions.Remove(item);
        
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    /// <summary>
    /// æ‰¹é‡å„²å­˜æ‰€æœ‰æ–°å¢ã€ç·¨è¼¯çš„æ›ç®—è¦å‰‡ä¸¦åˆªé™¤æ¨™è¨˜ç‚ºå¾…åˆªé™¤çš„é …ç›®
    /// </summary>
    private async Task HandleSaveAll()
    {
        try
        {
            // æ‰¾å‡ºæ‰€æœ‰æ–°å¢çš„é …ç›®ï¼ˆæœ‰å®Œæ•´è³‡æ–™ï¼‰
            var newItems = conversions.Where(c => 
                c.ExistingEntity == null && 
                c.FromUnitId.HasValue && 
                c.ToUnitId.HasValue && 
                c.ConversionRate.HasValue).ToList();
            
            // æ‰¾å‡ºæ‰€æœ‰è¢«ä¿®æ”¹çš„é …ç›®
            var modifiedItems = conversions.Where(c => 
                c.ExistingEntity != null && 
                HasChanges(c)).ToList();
            
            // ä½¿ç”¨å¾…åˆªé™¤åˆ—è¡¨
            var itemsToDelete = pendingDeletions.ToList();
            
            int successCount = 0;
            int updateCount = 0;
            int deleteCount = 0;
            
            // è™•ç†æ–°å¢
            foreach (var item in newItems)
            {
                if (!ValidateItem(item, out var error))
                {
                    await NotificationService.ShowWarningAsync(error);
                    continue;
                }
                
                var conversion = new UnitConversion
                {
                    FromUnitId = item.FromUnitId!.Value,
                    ToUnitId = item.ToUnitId!.Value,
                    ConversionRate = item.ConversionRate!.Value,
                    IsActive = item.IsActive,
                    CreatedAt = DateTime.Now,
                    CreatedBy = "System"
                };
                
                var validateResult = await UnitConversionService.ValidateAsync(conversion);
                if (!validateResult.IsSuccess)
                {
                    await NotificationService.ShowWarningAsync(validateResult.ErrorMessage);
                    continue;
                }
                
                var result = await UnitConversionService.CreateAsync(conversion);
                if (result.IsSuccess)
                {
                    successCount++;
                    // ğŸ”‘ æ›´æ–°åŒ…è£ç‰©ä»¶ï¼Œè®“å®ƒæŒ‡å‘æ–°å»ºç«‹çš„ Entity
                    item.ExistingEntity = result.Data;
                }
            }
            
            // è™•ç†ä¿®æ”¹
            foreach (var item in modifiedItems)
            {
                if (!ValidateItem(item, out var error))
                {
                    await NotificationService.ShowWarningAsync(error);
                    continue;
                }
                
                var conversion = item.ExistingEntity!;
                conversion.FromUnitId = item.FromUnitId!.Value;
                conversion.ToUnitId = item.ToUnitId!.Value;
                conversion.ConversionRate = item.ConversionRate!.Value;
                conversion.IsActive = item.IsActive;
                conversion.UpdatedAt = DateTime.Now;
                conversion.UpdatedBy = "System";
                
                var result = await UnitConversionService.UpdateAsync(conversion);
                if (result.IsSuccess)
                {
                    updateCount++;
                }
            }
            
            // è™•ç†åˆªé™¤
            foreach (var entity in itemsToDelete)
            {
                var result = await UnitConversionService.DeleteAsync(entity.Id);
                if (result.IsSuccess)
                {
                    deleteCount++;
                    // å¾å¾…åˆªé™¤åˆ—è¡¨ä¸­ç§»é™¤å·²æˆåŠŸåˆªé™¤çš„é …ç›®
                    pendingDeletions.Remove(entity);
                }
            }
            
            // é¡¯ç¤ºçµæœ
            if (successCount > 0 || updateCount > 0 || deleteCount > 0)
            {
                var messages = new List<string>();
                if (successCount > 0) messages.Add($"æ–°å¢ {successCount} ç­†");
                if (updateCount > 0) messages.Add($"ä¿®æ”¹ {updateCount} ç­†");
                if (deleteCount > 0) messages.Add($"åˆªé™¤ {deleteCount} ç­†");
                
                await NotificationService.ShowSuccessAsync($"å„²å­˜å®Œæˆï¼š{string.Join("ï¼Œ", messages)}");
                
                // ğŸ”‘ ä¸é‡æ–°è¼‰å…¥è³‡æ–™ï¼Œä¿ç•™é ç•™ç©ºè¡Œ
                // æ”¹ç‚ºæ‰‹å‹•è§¸ç™¼ UI æ›´æ–°
                StateHasChanged();
                
                if (OnRefreshRequired.HasDelegate)
                {
                    await OnRefreshRequired.InvokeAsync();
                }
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å„²å­˜å¤±æ•—ï¼š{ex.Message}");
        }
    }
    
    private bool HasChanges(UnitConversionItem item)
    {
        if (item.ExistingEntity == null) return false;
        
        return item.FromUnitId != item.ExistingEntity.FromUnitId ||
               item.ToUnitId != item.ExistingEntity.ToUnitId ||
               item.ConversionRate != item.ExistingEntity.ConversionRate;
    }
    
    private bool ValidateItem(UnitConversionItem item, out string error)
    {
        error = string.Empty;
        
        if (!item.FromUnitId.HasValue || !item.ToUnitId.HasValue)
        {
            error = "è«‹é¸æ“‡ä¾†æºå–®ä½å’Œç›®æ¨™å–®ä½";
            return false;
        }
        
        if (!item.ConversionRate.HasValue || item.ConversionRate.Value <= 0)
        {
            error = "æ›ç®—ä¿‚æ•¸å¿…é ˆå¤§æ–¼ 0";
            return false;
        }
        
        if (item.FromUnitId == item.ToUnitId)
        {
            error = "ä¾†æºå–®ä½å’Œç›®æ¨™å–®ä½ä¸èƒ½ç›¸åŒ";
            return false;
        }
        
        return true;
    }
    
    // === Column Configuration ===
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            new InteractiveColumnDefinition
            {
                Title = "ä¾†æºå–®ä½",
                PropertyName = nameof(UnitConversionItem.FromUnitId),
                ColumnType = InteractiveColumnType.Select,
                Width = "25%",
                TriggerEmptyRowOnFilled = true,
                Options = allUnits.Select(u => new InteractiveSelectOption 
                { 
                    Value = u.Id, 
                    Text = string.IsNullOrWhiteSpace(u.EnglishName) ? u.Name : $"{u.Name} ({u.EnglishName})" 
                }).ToList(),
                Placeholder = "è«‹é¸æ“‡ä¾†æºå–®ä½"
            },
            
            new InteractiveColumnDefinition
            {
                Title = "",
                PropertyName = "Arrow",
                ColumnType = InteractiveColumnType.Custom,
                Width = "5%",
                ExcludeFromEmptyCheck = true,
                CustomTemplate = item => builder =>
                {
                    builder.OpenElement(0, "div");
                    builder.AddAttribute(1, "class", "text-center");
                    builder.OpenElement(2, "i");
                    builder.AddAttribute(3, "class", "bi bi-arrow-right-short fs-4");
                    builder.CloseElement();
                    builder.CloseElement();
                }
            },
            
            new InteractiveColumnDefinition
            {
                Title = "ç›®æ¨™å–®ä½",
                PropertyName = nameof(UnitConversionItem.ToUnitId),
                ColumnType = InteractiveColumnType.Select,
                Width = "25%",
                Options = allUnits.Select(u => new InteractiveSelectOption 
                { 
                    Value = u.Id, 
                    Text = string.IsNullOrWhiteSpace(u.EnglishName) ? u.Name : $"{u.Name} ({u.EnglishName})" 
                }).ToList(),
                Placeholder = "è«‹é¸æ“‡ç›®æ¨™å–®ä½"
            },
            
            new InteractiveColumnDefinition
            {
                Title = "æ›ç®—ä¿‚æ•¸",
                PropertyName = nameof(UnitConversionItem.ConversionRate),
                ColumnType = InteractiveColumnType.Number,
                Width = "20%",
                Step = 0.000001m,
                Placeholder = "è«‹è¼¸å…¥æ›ç®—ä¿‚æ•¸",
                TextAlign = "right"
            },
            
            new InteractiveColumnDefinition
            {
                Title = "å•Ÿç”¨",
                PropertyName = nameof(UnitConversionItem.IsActive),
                ColumnType = InteractiveColumnType.Checkbox,
                Width = "10%",
                ExcludeFromEmptyCheck = true,
                IsDisabledFunc = item =>
                {
                    var conversionItem = item as UnitConversionItem;
                    return conversionItem?.ExistingEntity == null;
                },
                OnCheckboxChanged = EventCallback.Factory.Create<(object item, bool isChecked)>(this, 
                    async args =>
                    {
                        var item = args.item as UnitConversionItem;
                        if (item?.ExistingEntity != null)
                        {
                            item.IsActive = args.isChecked;
                            await HandleToggleActive(item);
                        }
                    })
            },
            
            new InteractiveColumnDefinition
            {
                Title = "æ“ä½œ",
                PropertyName = "Delete",
                ColumnType = InteractiveColumnType.Custom,
                Width = "50px",
                ExcludeFromEmptyCheck = true,
                TextAlign = "center",
                CustomTemplate = item => GetDeleteButtonTemplate((UnitConversionItem)item) 
            }
        };
    }
    
    // === è‡ªè¨‚æ“ä½œæŒ‰éˆ•æ¨¡æ¿ ===
    private RenderFragment<UnitConversionItem> GetDeleteButtonTemplate => item => __builder =>
    {
        if (item == null) return;
        
        var isDisabled = item.ExistingEntity == null;
        
        <GenericButtonComponent Variant="ButtonVariant.Red"
                               IconClass="bi bi-trash text-white"
                               Size="ButtonSize.Large"
                               IsDisabled="@isDisabled"
                               Title="åˆªé™¤"
                               OnClick="async () => await HandleItemDelete(item)"
                               StopPropagation="true"
                               CssClass="btn-square" />
    };
    
    // === Public Methods ===
    public async Task OpenAsync()
    {
        if (!IsVisible && IsVisibleChanged.HasDelegate)
        {
            await IsVisibleChanged.InvokeAsync(true);
        }
    }
    
    public async Task CloseAsync()
    {
        if (IsVisible && IsVisibleChanged.HasDelegate)
        {
            await IsVisibleChanged.InvokeAsync(false);
        }
    }
    
    private async Task HandleModalClose()
    {
        if (IsVisibleChanged.HasDelegate)
        {
            await IsVisibleChanged.InvokeAsync(false);
        }
    }
}
