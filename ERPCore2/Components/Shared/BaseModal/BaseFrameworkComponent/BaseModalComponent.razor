@*
    基礎 Modal 模板組件
    提供統一的 Modal 外觀和行為，包含：
    1. 標準化的 Header（標題 + 圖示）
    2. 可自訂的按鈕區（Header 右側）
    3. 完全自訂的內容區
    4. 可選的 Footer（顯示審計資訊）
    5. 內建 ESC 鍵關閉功能
    6. 點擊背景關閉功能
*@
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@implements IDisposable

@if (IsVisible)
{
    <div class="modal fade show" 
         tabindex="-1" 
         style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: @GetModalZIndex(); overflow: hidden;"
         @onclick="@HandleBackdropClick">
        
        <div class="modal-dialog @GetModalSizeClass()" 
             style="position: relative; margin: 1.5rem auto; max-height: calc(100vh - 3rem);"
             @onclick:stopPropagation="true">
            <div class="modal-content shadow-lg">
                
                @* ===== Modal Header ===== *@
                <div class="modal-header @GetHeaderCssClass()" style="@GetHeaderStyle()">
                    <h5 class="modal-title fw-bold">
                        @if (!string.IsNullOrEmpty(Icon))
                        {
                            <i class="@Icon me-2"></i>
                        }
                        @Title
                    </h5>
                    
                    @* 關閉按鈕 *@
                    @if (ShowCloseButton)
                    {
                        <button type="button" 
                                class="btn-close @(UseWhiteCloseButton ? "btn-close-white" : "")" 
                                @onclick="HandleClose" 
                                title="關閉"
                                aria-label="關閉"></button>
                    }
                </div>

                @* ===== Modal Actions (按鈕區) ===== *@
                @if (HeaderButtons != null)
                {
                    <div class="border-bottom px-3 py-2 d-flex align-items-center gap-2 bg-light mb-2">
                        @HeaderButtons
                    </div>
                }

                @* ===== Modal Body ===== *@
                <div class="modal-body @BodyCssClass">
                    @if (IsLoading)
                    {
                        <div class="d-flex justify-content-center align-items-center py-5">
                            <div class="spinner-border text-primary me-2" style="width: 1.2rem; height: 1.2rem; border-width: 0.15em;" role="status">
                                <span class="visually-hidden">載入中...</span>
                            </div>
                            <span class="fs-6">@LoadingMessage</span>
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            <h6 class="alert-heading">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                錯誤
                            </h6>
                            @ErrorMessage
                        </div>
                    }
                    else if (BodyContent != null)
                    {
                        @BodyContent
                    }
                    else
                    {
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-inbox fs-1 d-block mb-3"></i>
                            <p class="mb-0">暫無內容</p>
                        </div>
                    }
                </div>

                @* ===== Modal Footer (Custom Content) ===== *@
                @if (ShowFooter && FooterContent != null)
                {
                    <div class="modal-footer border-top bg-light">
                        @FooterContent
                    </div>
                }
                
                @* ===== Modal Metadata (Audit Info) ===== *@
                @if (ShowFooter && AuditInfo != null)
                {
                    <div class="modal-metadata border-top bg-light px-3 py-2">
                        <div class="text-muted small d-flex flex-wrap gap-3">
                            @if (AuditInfo.CreatedAt.HasValue)
                            {
                                <span>
                                    <strong>建立時間：</strong>
                                    @AuditInfo.CreatedAt.Value.ToString("yyyy/MM/dd HH:mm:ss")
                                </span>
                            }
                            @if (!string.IsNullOrEmpty(AuditInfo.CreatedBy))
                            {
                                <span>
                                    <strong>創建者：</strong>
                                    @AuditInfo.CreatedBy
                                </span>
                            }
                            @if (AuditInfo.UpdatedAt.HasValue)
                            {
                                <span>
                                    <strong>最後更新時間：</strong>
                                    @AuditInfo.UpdatedAt.Value.ToString("yyyy/MM/dd HH:mm:ss")
                                </span>
                            }
                            @if (!string.IsNullOrEmpty(AuditInfo.UpdatedBy))
                            {
                                <span>
                                    <strong>最後修改者：</strong>
                                    @AuditInfo.UpdatedBy
                                </span>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
    
    @* Modal Backdrop *@
    <div class="modal-backdrop fade show" style="z-index: @GetBackdropZIndex();"></div>
}

@code {
    // ===== 參數定義 =====
    
    /// <summary>
    /// Modal 是否顯示
    /// </summary>
    [Parameter]
    public bool IsVisible { get; set; }
    
    /// <summary>
    /// Modal 顯示狀態變更事件
    /// </summary>
    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }
    
    /// <summary>
    /// Modal 標題
    /// </summary>
    [Parameter]
    public string Title { get; set; } = "視窗";
    
    /// <summary>
    /// 標題圖示 (Bootstrap Icons 或 Font Awesome)
    /// 例如: "bi bi-pencil" 或 "fas fa-edit"
    /// </summary>
    [Parameter]
    public string Icon { get; set; } = string.Empty;
    
    /// <summary>
    /// Modal 尺寸
    /// </summary>
    [Parameter]
    public ModalSize Size { get; set; } = ModalSize.Large;
    
    /// <summary>
    /// Header 顏色變體
    /// </summary>
    [Parameter]
    public HeaderVariant HeaderColor { get; set; } = HeaderVariant.Default;
    
    /// <summary>
    /// 自訂 Header 背景顏色（HEX 格式，例如 "#1F2937"）
    /// 當設定此值時，將覆蓋 HeaderColor 的預設顏色
    /// </summary>
    [Parameter]
    public string? CustomHeaderColor { get; set; }
    
    /// <summary>
    /// 自訂 Header 文字顏色（HEX 格式，預設為白色 "#FFFFFF"）
    /// 僅在設定 CustomHeaderColor 時有效
    /// </summary>
    [Parameter]
    public string CustomHeaderTextColor { get; set; } = "#FFFFFF";
    
    /// <summary>
    /// 是否顯示關閉按鈕
    /// </summary>
    [Parameter]
    public bool ShowCloseButton { get; set; } = true;
    
    /// <summary>
    /// 點擊背景是否關閉 Modal
    /// </summary>
    [Parameter]
    public bool CloseOnBackdropClick { get; set; } = true;
    
    /// <summary>
    /// 按下 ESC 鍵是否關閉 Modal
    /// </summary>
    [Parameter]
    public bool CloseOnEscape { get; set; } = true;
    
    /// <summary>
    /// 是否使用白色關閉按鈕（用於深色 Header）
    /// </summary>
    [Parameter]
    public bool UseWhiteCloseButton { get; set; } = false;
    
    /// <summary>
    /// 是否顯示載入中狀態
    /// </summary>
    [Parameter]
    public bool IsLoading { get; set; } = false;
    
    /// <summary>
    /// 載入中訊息
    /// </summary>
    [Parameter]
    public string LoadingMessage { get; set; } = "載入中...";
    
    /// <summary>
    /// 錯誤訊息（如果有值會顯示錯誤畫面）
    /// </summary>
    [Parameter]
    public string ErrorMessage { get; set; } = string.Empty;
    
    /// <summary>
    /// 是否顯示 Footer
    /// </summary>
    [Parameter]
    public bool ShowFooter { get; set; } = false;
    
    /// <summary>
    /// Body 額外 CSS 類別
    /// </summary>
    [Parameter]
    public string BodyCssClass { get; set; } = string.Empty;
    
    /// <summary>
    /// 審計資訊（用於 Footer 顯示）
    /// </summary>
    [Parameter]
    public ModalAuditInfo? AuditInfo { get; set; }
    
    // ===== RenderFragment 參數 =====
    
    /// <summary>
    /// Header 自訂按鈕區（顯示在標題右側、關閉按鈕左側）
    /// </summary>
    [Parameter]
    public RenderFragment? HeaderButtons { get; set; }
    
    /// <summary>
    /// Modal 主要內容區（必填）
    /// </summary>
    [Parameter]
    public RenderFragment? BodyContent { get; set; }
    
    /// <summary>
    /// Footer 自訂內容（優先於 AuditInfo）
    /// </summary>
    [Parameter]
    public RenderFragment? FooterContent { get; set; }
    
    // ===== 事件回呼 =====
    
    /// <summary>
    /// Modal 關閉事件
    /// </summary>
    [Parameter]
    public EventCallback OnClose { get; set; }
    
    /// <summary>
    /// Modal 開啟前事件
    /// </summary>
    [Parameter]
    public EventCallback OnOpening { get; set; }
    
    /// <summary>
    /// Modal 開啟後事件
    /// </summary>
    [Parameter]
    public EventCallback OnOpened { get; set; }
    
    // ===== 私有欄位 =====
    
    private bool _lastVisible = false;
    private DotNetObjectReference<BaseModalComponent>? _escKeyDotNetRef;
    private bool _isEscKeyListenerActive = false;
    private bool _isDisposed = false;
    private readonly object _escKeyLock = new object();
    
    // z-index 管理（靜態變數，所有 Modal 共享）
    private static int _currentZIndexBase = 1050;
    private static readonly object _zIndexLock = new object();
    private int _myZIndex = 1050;
    
    // ===== 生命週期方法 =====
    
    protected override async Task OnParametersSetAsync()
    {
        // Modal 剛打開
        if (IsVisible && !_lastVisible)
        {
            _lastVisible = true;
            
            // 分配新的 z-index
            lock (_zIndexLock)
            {
                _currentZIndexBase += 10; // 每個新 Modal 增加 10，留出空間給 backdrop
                _myZIndex = _currentZIndexBase;
            }
            
            if (OnOpening.HasDelegate)
            {
                await OnOpening.InvokeAsync();
            }
        }
        // Modal 剛關閉
        else if (!IsVisible && _lastVisible)
        {
            _lastVisible = false;
            
            // 釋放 z-index（遞減回去）
            lock (_zIndexLock)
            {
                _currentZIndexBase -= 10;
                // 確保不會低於基礎值
                if (_currentZIndexBase < 1050)
                {
                    _currentZIndexBase = 1050;
                }
            }
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsVisible)
        {
            // 設置 ESC 鍵監聽器
            if (CloseOnEscape)
            {
                bool shouldSetup;
                lock (_escKeyLock)
                {
                    shouldSetup = !_isEscKeyListenerActive;
                }
                
                if (shouldSetup)
                {
                    await SetupEscKeyListenerAsync();
                }
            }
            
            // 觸發開啟後事件
            if (firstRender && OnOpened.HasDelegate)
            {
                await OnOpened.InvokeAsync();
            }
        }
        else
        {
            // 清理 ESC 鍵監聽器
            bool shouldCleanup;
            lock (_escKeyLock)
            {
                shouldCleanup = _isEscKeyListenerActive;
            }
            
            if (shouldCleanup)
            {
                await CleanupEscKeyListenerAsync();
            }
        }
    }
    
    // ===== 事件處理方法 =====
    
    /// <summary>
    /// 處理關閉按鈕點擊
    /// </summary>
    private async Task HandleClose()
    {
        await CloseModal();
    }
    
    /// <summary>
    /// 處理背景點擊
    /// </summary>
    private async Task HandleBackdropClick()
    {
        if (CloseOnBackdropClick)
        {
            await CloseModal();
        }
    }
    
    /// <summary>
    /// 關閉 Modal
    /// </summary>
    private async Task CloseModal()
    {
        try
        {
            if (_isDisposed)
            {
                return;
            }
            
            if (OnClose.HasDelegate)
            {
                await OnClose.InvokeAsync();
            }
            
            if (IsVisibleChanged.HasDelegate)
            {
                await IsVisibleChanged.InvokeAsync(false);
            }
        }
        catch (ObjectDisposedException)
        {
            // 忽略已釋放物件的錯誤
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"CloseModal Error: {ex.Message}");
        }
    }
    
    // ===== ESC 鍵處理 =====
    
    /// <summary>
    /// 設置 ESC 鍵監聽器
    /// </summary>
    private async Task SetupEscKeyListenerAsync()
    {
        try
        {
            lock (_escKeyLock)
            {
                if (_isEscKeyListenerActive && _escKeyDotNetRef != null)
                {
                    return;
                }
                
                _isEscKeyListenerActive = true;
            }
            
            lock (_escKeyLock)
            {
                _escKeyDotNetRef = DotNetObjectReference.Create(this);
            }
            
            await JSRuntime.InvokeVoidAsync("setupEscKeyListener", _escKeyDotNetRef);
        }
        catch (Exception ex)
        {
            lock (_escKeyLock)
            {
                _isEscKeyListenerActive = false;
            }
            LogError("SetupEscKeyListener", ex);
        }
    }
    
    /// <summary>
    /// 清理 ESC 鍵事件監聽器
    /// </summary>
    private async Task CleanupEscKeyListenerAsync()
    {
        DotNetObjectReference<BaseModalComponent>? refToDispose = null;
        
        lock (_escKeyLock)
        {
            if (!_isEscKeyListenerActive)
            {
                return;
            }
            
            _isEscKeyListenerActive = false;
            refToDispose = _escKeyDotNetRef;
            _escKeyDotNetRef = null;
        }
        
        try
        {
            await JSRuntime.InvokeVoidAsync("cleanupEscKeyListener");
            await Task.Delay(200);
            
            if (refToDispose != null)
            {
                try
                {
                    refToDispose.Dispose();
                }
                catch (ObjectDisposedException)
                {
                    // 對象已被釋放，這是正常的
                }
                catch (Exception ex)
                {
                    LogError($"DotNetObjectReference dispose warning (safe to ignore): {ex.Message}", ex);
                }
            }
        }
        catch (JSDisconnectedException)
        {
            // Blazor 連接已斷開，這是正常的
        }
        catch (TaskCanceledException)
        {
            // 任務被取消，這是正常的
        }
        catch (Exception ex)
        {
            LogError("CleanupEscKeyListener", ex);
        }
    }
    
    /// <summary>
    /// 處理 ESC 鍵按下事件（由 JavaScript 調用）
    /// </summary>
    [JSInvokable]
    public async Task HandleEscapeKey()
    {
        try
        {
            if (_isDisposed)
            {
                return;
            }
            
            if (IsVisible && CloseOnEscape)
            {
                await HandleClose();
            }
        }
        catch (ObjectDisposedException)
        {
            // 忽略已釋放物件的錯誤
        }
        catch (InvalidOperationException)
        {
            // 忽略無效操作錯誤
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"ESC Error: {ex.Message}");
        }
    }
    
    // ===== 輔助方法 =====
    
    /// <summary>
    /// 取得 Modal 的 z-index
    /// </summary>
    private int GetModalZIndex()
    {
        return _myZIndex;
    }
    
    /// <summary>
    /// 取得 Backdrop 的 z-index（比 Modal 少 1）
    /// </summary>
    private int GetBackdropZIndex()
    {
        return _myZIndex - 1;
    }
    
    /// <summary>
    /// 取得 Modal 尺寸 CSS 類別
    /// </summary>
    private string GetModalSizeClass()
    {
        return Size switch
        {
            ModalSize.Small => "modal-sm",
            ModalSize.Default => "",
            ModalSize.Large => "modal-lg",
            ModalSize.ExtraLarge => "modal-xl",
            ModalSize.Desktop => "modal-xl modal-desktop",
            _ => "modal-lg"
        };
    }
    
    /// <summary>
    /// 取得 Header CSS 類別
    /// </summary>
    private string GetHeaderCssClass()
    {
        // 如果使用自訂顏色，不使用 Bootstrap 的背景色類別
        if (!string.IsNullOrEmpty(CustomHeaderColor))
        {
            return string.Empty;
        }
        
        var cssClass = HeaderColor switch
        {
            HeaderVariant.Primary => "bg-primary text-white",
            HeaderVariant.Secondary => "bg-secondary text-white",
            HeaderVariant.Success => "bg-success text-white",
            HeaderVariant.Danger => "bg-danger text-white",
            HeaderVariant.Warning => "bg-warning text-dark",
            HeaderVariant.Info => "bg-info text-white",
            HeaderVariant.Dark => "bg-dark text-white",
            HeaderVariant.ProjectPrimary => "text-white",  // 專案主色
            _ => ""
        };
        
        return cssClass;
    }
    
    /// <summary>
    /// 取得 Header 內聯樣式
    /// </summary>
    private string GetHeaderStyle()
    {
        if (!string.IsNullOrEmpty(CustomHeaderColor))
        {
            return $"background-color: {CustomHeaderColor}; color: {CustomHeaderTextColor};";
        }
        
        // 專案主色 #1F2937
        if (HeaderColor == HeaderVariant.ProjectPrimary)
        {
            return "background-color: #1F2937; color: #FFFFFF;";
        }
        
        return string.Empty;
    }
    
    /// <summary>
    /// 記錄錯誤
    /// </summary>
    private void LogError(string method, Exception ex)
    {
        System.Diagnostics.Debug.WriteLine($"[BaseModalComponent.{method}] 錯誤：{ex.Message}");
    }
    
    // ===== 資源清理 =====
    
    public void Dispose()
    {
        try
        {
            DotNetObjectReference<BaseModalComponent>? refToDispose = null;
            
            lock (_escKeyLock)
            {
                _isDisposed = true;
                _isEscKeyListenerActive = false;
                refToDispose = _escKeyDotNetRef;
                _escKeyDotNetRef = null;
            }
            
            refToDispose?.Dispose();
            
            _ = Task.Run(async () =>
            {
                try
                {
                    await CleanupEscKeyListenerAsync();
                }
                catch
                {
                    // 忽略清理過程中的錯誤
                }
            });
        }
        catch
        {
            // 忽略清理過程中的錯誤
        }
    }
    
    // ===== 列舉定義 =====
    
    /// <summary>
    /// Modal 尺寸列舉
    /// </summary>
    public enum ModalSize
    {
        Small,          // 小型 (modal-sm)
        Default,        // 預設 (無額外類別)
        Large,          // 大型 (modal-lg)
        ExtraLarge,     // 超大型 (modal-xl)
        Desktop         // 桌面尺寸 (modal-xl modal-desktop)
    }
    
    /// <summary>
    /// Header 顏色變體列舉
    /// </summary>
    public enum HeaderVariant
    {
        Default,        // 預設白底黑字
        Primary,        // Bootstrap 藍色
        Secondary,      // Bootstrap 灰色
        Success,        // Bootstrap 綠色
        Danger,         // Bootstrap 紅色
        Warning,        // Bootstrap 黃色
        Info,           // Bootstrap 淺藍色
        Dark,           // Bootstrap 深色
        ProjectPrimary  // 專案主色 #1F2937
    }
    
    /// <summary>
    /// 審計資訊類別（用於 Footer 顯示）
    /// </summary>
    public class ModalAuditInfo
    {
        public DateTime? CreatedAt { get; set; }
        public string? CreatedBy { get; set; }
        public DateTime? UpdatedAt { get; set; }
        public string? UpdatedBy { get; set; }
    }
}
