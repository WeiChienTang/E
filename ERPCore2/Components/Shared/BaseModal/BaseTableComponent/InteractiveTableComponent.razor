@* äº’å‹•å¼è¡¨æ ¼çµ„ä»¶ - æ”¯æ´å¤šç¨®è¼¸å…¥æ§ä»¶å’Œçµ±ä¸€çš„UIé¢¨æ ¼ *@
@using System.Reflection
@using System.Web
@inject IJSRuntime JSRuntime
@typeparam TItem

<div class="table-responsive table-container-hover interactive-table-container">
    <table class="table @GetTableClass() interactive-table">
        @if (ShowHeader && ColumnDefinitions != null && ColumnDefinitions.Any())
        {
            <thead class="@GetHeaderClass()">
                <tr>
                    @if (ShowRowNumbers)
                    {
                        <th scope="col" class="text-center" style="width: 60px;">#</th>
                    }
                    @foreach (var column in ColumnDefinitions)
                    {
                        var headerStyle = GetColumnWidthStyle(column);
                        if (!string.IsNullOrEmpty(column.Tooltip))
                        {
                            headerStyle = (headerStyle ?? "") + (string.IsNullOrEmpty(headerStyle) ? "" : " ") + "cursor: help;";
                        }
                        
                        <th scope="col" 
                            class="@column.HeaderCssClass @(column.HideOnMobile ? "d-none d-md-table-cell" : "")" 
                            style="@headerStyle"
                            title="@column.Tooltip">
                            @if (!string.IsNullOrEmpty(column.IconClass))
                            {
                                <i class="@column.IconClass me-1"></i>
                            }
                            @column.Title
                            @if (column.IsRequired)
                            {
                                <span class="text-danger ms-1">*</span>
                            }
                        </th>
                    }
                    @if (ShowActions && ActionsTemplate != null)
                    {
                        <th scope="col" class="text-center table-actions-column" style="@GetActionsColumnStyle()">@ActionsHeader</th>
                    }
                    @if (ShowBuiltInActions)
                    {
                        <th scope="col" class="text-center table-actions-column" style="@GetActionsColumnStyle()">@ActionsHeader</th>
                    }
                </tr>
            </thead>
        }
        <tbody>
            @if (Items != null && Items.Any())
            {
                var itemIndex = 0;
                @foreach (var item in Items)
                {
                    var currentIndex = itemIndex;
                    <tr class="@GetRowClass(item, currentIndex)" 
                        @onclick="() => HandleRowClick(item)"
                        style="@(EnableRowClick || EnableRowSelection ? $"cursor: {RowClickCursor};" : "")">
                        
                        @if (ShowRowNumbers)
                        {
                            <td class="text-center text-muted">
                                <small>@(currentIndex + 1)</small>
                            </td>
                        }
                        
                        @foreach (var column in ColumnDefinitions ?? new List<InteractiveColumnDefinition>())
                        {
                            <td class="@column.CellCssClass @(column.HideOnMobile ? "d-none d-md-table-cell" : "")"
                                style="@(GetColumnWidthStyle(column))"
                                @onclick:stopPropagation="@(column.ColumnType != InteractiveColumnType.Display)">
                                
                                @* æ ¹æ“šæ¬„ä½é¡å‹æ¸²æŸ“ä¸åŒçš„æ§ä»¶ *@
                                @if (column.ColumnType == InteractiveColumnType.Display)
                                {
                                    @* ç´”é¡¯ç¤ºæ–‡å­— *@
                                    var value = GetPropertyValue(item, column.PropertyName);
                                    string displayText;
                                    
                                    if (value == null)
                                    {
                                        displayText = column.NullDisplayText ?? "-";
                                    }
                                    else if (column.DisplayFormatter != null)
                                    {
                                        displayText = column.DisplayFormatter(value);
                                    }
                                    else
                                    {
                                        displayText = HttpUtility.HtmlEncode(value.ToString() ?? "");
                                    }

                                    <span style="font-size: 0.875rem;">@((MarkupString)displayText)</span>
                                }
                                else if (column.ColumnType == InteractiveColumnType.Input)
                                {
                                    @* æ–‡å­—è¼¸å…¥æ¡† *@
                                    var value = GetPropertyValue(item, column.PropertyName);
                                    var stringValue = value?.ToString() ?? "";
                                    var isDisabled = IsReadOnly || column.IsDisabled;
                                    var validationClass = GetValidationCssClass(item, column.PropertyName);
                                    
                                    <input type="text" 
                                           class="form-control @validationClass" 
                                           value="@stringValue"
                                           placeholder="@column.Placeholder"
                                           title="@column.Tooltip"
                                           disabled="@isDisabled"
                                           readonly="@column.IsReadOnly"
                                           @oninput="async (e) => await HandleInputChange(column, item, e.Value?.ToString())" />
                                }
                                else if (column.ColumnType == InteractiveColumnType.Number)
                                {
                                    @* æ•¸å­—è¼¸å…¥æ¡† - æ™ºèƒ½æ ¼å¼åŒ–ï¼šæ•´æ•¸ä¸é¡¯ç¤ºå°æ•¸é» *@
                                    var value = GetPropertyValue(item, column.PropertyName);
                                    var stringValue = "";
                                    
                                    // æ™ºèƒ½æ ¼å¼åŒ–æ•¸å­—ï¼šå¦‚æœæ˜¯æ•´æ•¸å‰‡ä¸é¡¯ç¤ºå°æ•¸é»ï¼Œæœ‰å°æ•¸æ‰é¡¯ç¤º
                                    if (value != null && decimal.TryParse(value.ToString(), out var decimalValue))
                                    {
                                        if (decimalValue != 0)
                                        {
                                            stringValue = decimalValue % 1 == 0 
                                                ? decimalValue.ToString("F0") 
                                                : decimalValue.ToString();
                                        }
                                    }
                                    
                                    var isDisabled = IsReadOnly || column.IsDisabled || (column.IsDisabledFunc?.Invoke(item!) ?? false);
                                    var validationClass = GetValidationCssClass(item, column.PropertyName);
                                    var tooltip = column.TooltipFunc?.Invoke(item!) ?? column.Tooltip;
                                    
                                    <input type="number" 
                                           class="form-control @validationClass" 
                                           value="@stringValue"
                                           placeholder="@column.Placeholder"
                                           title="@tooltip"
                                           min="@column.MinValue"
                                           max="@column.MaxValue"
                                           step="any"
                                           disabled="@isDisabled"
                                           readonly="@column.IsReadOnly"
                                           onkeydown="if(['e','E','+','-'].includes(event.key)) event.preventDefault();"
                                           @oninput="async (e) => await HandleInputChange(column, item, e.Value?.ToString())" />
                                }
                                else if (column.ColumnType == InteractiveColumnType.Select)
                                {
                                    @* ä¸‹æ‹‰é¸å–® *@
                                    var value = GetPropertyValue(item, column.PropertyName);
                                    var selectedValue = value?.ToString() ?? "";
                                    var isDisabled = IsReadOnly || column.IsDisabled;
                                    var validationClass = GetValidationCssClass(item, column.PropertyName);
                                    
                                    <select class="form-select @validationClass"
                                            value="@selectedValue"
                                            title="@column.Title"
                                            disabled="@isDisabled"
                                            @onchange="async (e) => await HandleSelectionChange(column, item, e.Value)">
                                        
                                        @if (!string.IsNullOrEmpty(column.Placeholder))
                                        {
                                            <option value="">@column.Placeholder</option>
                                        }
                                        
                                        @if (column.Options != null)
                                        {
                                            @foreach (var option in column.Options)
                                            {
                                                <option value="@option.Value" disabled="@option.IsDisabled">
                                                    @option.Text
                                                </option>
                                            }
                                        }
                                    </select>
                                }
                                else if (column.ColumnType == InteractiveColumnType.SearchableSelect)
                                {
                                    @* å¯æœå°‹ä¸‹æ‹‰é¸å–® *@
                                    var searchValue = GetPropertyValue(item, column.SearchValuePropertyName ?? "")?.ToString() ?? "";
                                    var selectedItem = GetPropertyValue(item, column.SelectedItemPropertyName ?? "");
                                    var filteredItems = GetPropertyValue(item, column.FilteredItemsPropertyName ?? "") as IEnumerable<object> ?? new List<object>();
                                    var showDropdown = GetPropertyValue(item, column.ShowDropdownPropertyName ?? "") is bool showValue && showValue;
                                    var selectedIndex = GetPropertyValue(item, column.SelectedIndexPropertyName ?? "") is int indexValue ? indexValue : -1;
                                    var isDisabled = IsReadOnly || column.IsDisabled;
                                    var validationClass = GetValidationCssClass(item, column.PropertyName);
                                    
                                    <div class="position-relative">
                                        <input type="text" 
                                               class="form-control @validationClass" 
                                               value="@searchValue"
                                               placeholder="@column.Placeholder"
                                               title="@column.Tooltip"
                                               disabled="@isDisabled"
                                               readonly="@column.IsReadOnly"
                                               @oninput="async (e) => await HandleSearchableSelectInput(column, item, e.Value?.ToString())"
                                               @onfocus="async () => await HandleSearchableSelectFocus(column, item)"
                                               @onblur="async () => await HandleSearchableSelectBlur(column, item)"
                                               @onkeydown="async (e) => await HandleSearchableSelectKeyDown(column, item, e)" />
                                        
                                        @if (showDropdown && filteredItems.Any() && !isDisabled)
                                        {
                                            var dropdownId = $"dropdown-{GetHashCode()}-{currentIndex}";
                                            <div class="dropdown-menu show position-absolute w-auto shadow searchable-dropdown" 
                                                 id="@dropdownId"
                                                 style="z-index: 10000; max-height: @column.DropdownMaxHeight; overflow-y: auto; overflow-x: hidden; border: 1px solid #dee2e6; min-width: @column.DropdownMinWidth; max-width: @column.DropdownMaxWidth;"
                                                 @onmousedown:preventDefault="true">
                                                @{
                                                    var dropdownItemIndex = 0;
                                                }
                                                @foreach (var dropdownItem in filteredItems.Take(column.MaxDisplayItems))
                                                {
                                                    var currentDropdownIndex = dropdownItemIndex;
                                                    var isSelected = selectedIndex == currentDropdownIndex;
                                                    var displayText = column.ItemDisplayFormatter?.Invoke(dropdownItem) ?? dropdownItem.ToString() ?? "";
                                                    var itemId = $"dropdown-item-{GetHashCode()}-{currentIndex}-{currentDropdownIndex}";
                                                    
                                                    <a class="dropdown-item @(isSelected ? "active bg-primary text-white" : "")" 
                                                       id="@itemId"
                                                       href="#" 
                                                       @onclick="async () => await HandleSearchableSelectItemClick(column, item, dropdownItem)" 
                                                       @onclick:preventDefault="true"
                                                       style="cursor: pointer; padding: 8px 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                                                       @onmouseenter="async () => await HandleSearchableSelectItemMouseEnter(column, item, currentDropdownIndex)">
                                                        @((MarkupString)displayText)
                                                    </a>
                                                    dropdownItemIndex++;
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                                else if (column.ColumnType == InteractiveColumnType.Checkbox)
                                {
                                    @* å‹¾é¸æ¡† *@
                                    var value = GetPropertyValue(item, column.PropertyName);
                                    var isChecked = value is bool boolValue && boolValue;
                                    var isDisabled = IsReadOnly || column.IsDisabled;
                                    
                                    <div class="form-check form-switch d-flex justify-content-center">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               checked="@isChecked"
                                               title="@column.Title"
                                               disabled="@isDisabled"
                                               @onchange="async (e) => await HandleCheckboxChange(column, item, e.Value)" />
                                    </div>
                                    
                                    @if (!string.IsNullOrEmpty(column.CheckedText) || !string.IsNullOrEmpty(column.UncheckedText))
                                    {
                                        <small class="@(isChecked ? "text-success" : "text-muted")">
                                            @(isChecked ? column.CheckedText : column.UncheckedText)
                                        </small>
                                    }
                                }
                                else if (column.ColumnType == InteractiveColumnType.Button)
                                {
                                    @* æŒ‰éˆ• *@
                                    var isDisabled = IsReadOnly || column.IsDisabled;
                                    var buttonDisabled = isDisabled || (column.IsButtonDisabled?.Invoke(item!) ?? false);
                                    
                                    <GenericButtonComponent Text="@column.ButtonText"
                                                           IconClass="@column.ButtonIcon"
                                                           Variant="@column.ButtonVariant"
                                                           Size="@column.ButtonSize"
                                                           IsDisabled="@buttonDisabled"
                                                           Title="@column.Title"
                                                           OnClick="async () => await HandleButtonClick(column, item)" />
                                }
                                else if (column.ColumnType == InteractiveColumnType.Custom && column.CustomTemplate != null)
                                {
                                    @* è‡ªè¨‚æ¨¡æ¿ - æ”¯æ´éµç›¤å°èˆª *@
                                    @if (column.EnableKeyboardNavigation)
                                    {
                                        <div @onkeydown="async (e) => await HandleKeyboardNavigation(column, item, e)">
                                            @column.CustomTemplate(item!)
                                        </div>
                                    }
                                    else
                                    {
                                        @column.CustomTemplate(item!)
                                    }
                                }
                            </td>
                        }
                        
                        @if (ShowActions && ActionsTemplate != null)
                        {
                            <td class="text-center table-actions-column" style="@GetActionsColumnStyle()" @onclick:stopPropagation="true">
                                @ActionsTemplate(item)
                            </td>
                        }
                        @if (ShowBuiltInActions)
                        {
                            <td class="text-center table-actions-column" style="@GetActionsColumnStyle()" @onclick:stopPropagation="true">
                                @GetBuiltInActionsTemplate()(item)
                            </td>
                        }
                    </tr>
                    itemIndex++;
                }
            }
            else
            {
                <tr>
                    <td colspan="@GetColspan()" class="text-center py-4 text-light-custom">
                        @if (EmptyTemplate != null)
                        {
                            @EmptyTemplate
                        }
                        else
                        {
                            <i class="fas fa-inbox fa-2x mb-2 text-light-custom"></i>
                            <br />
                            @EmptyMessage
                        }
                    </td>
                </tr>
            }
        </tbody>
        @if (ShowTotalRow && Items != null && Items.Any())
        {
            <tfoot>
                <tr class="table-info">
                    @if (ShowRowNumbers)
                    {
                        <th></th>
                    }
                    @foreach (var column in ColumnDefinitions ?? new List<InteractiveColumnDefinition>())
                    {
                        <th class="@(column.HideOnMobile ? "d-none d-md-table-cell" : "")" 
                            style="@(GetColumnWidthStyle(column))">
                            @if (TotalRowTemplate != null)
                            {
                                @TotalRowTemplate(column)
                            }
                        </th>
                    }
                    @if (ShowActions)
                    {
                        <th style="@GetActionsColumnStyle()"></th>
                    }
                    @if (ShowBuiltInActions)
                    {
                        <th style="@GetActionsColumnStyle()"></th>
                    }
                </tr>
            </tfoot>
        }
    </table>
</div>

@code {
    #region åƒæ•¸å®šç¾©
    [Parameter] public List<TItem>? Items { get; set; }  // æ”¹ç”¨ List ä»¥æ”¯æ´è‡ªå‹•ç©ºè¡Œç®¡ç†
    [Parameter] public List<InteractiveColumnDefinition>? ColumnDefinitions { get; set; }
    [Parameter] public RenderFragment<TItem>? ActionsTemplate { get; set; }
    [Parameter] public RenderFragment? EmptyTemplate { get; set; }
    [Parameter] public RenderFragment<InteractiveColumnDefinition>? TotalRowTemplate { get; set; }
    
    // è‡ªå‹•ç©ºè¡Œç®¡ç†åƒæ•¸
    [Parameter] public bool EnableAutoEmptyRow { get; set; } = false;
    [Parameter] public Func<TItem>? CreateEmptyItem { get; set; }
    
    // è¡¨æ ¼æ¨£å¼è¨­å®š
    [Parameter] public bool ShowHeader { get; set; } = true;
    [Parameter] public bool ShowActions { get; set; } = false;
    [Parameter] public bool ShowRowNumbers { get; set; } = false;
    [Parameter] public bool ShowTotalRow { get; set; } = false;
    [Parameter] public bool IsStriped { get; set; } = true;
    [Parameter] public bool IsHoverable { get; set; } = true;
    [Parameter] public bool IsBordered { get; set; } = true;
    [Parameter] public bool IsReadOnly { get; set; } = false;
    [Parameter] public string CssClass { get; set; } = string.Empty;
    [Parameter] public string EmptyMessage { get; set; } = "æ²’æœ‰æ‰¾åˆ°è³‡æ–™";
    [Parameter] public string ActionsHeader { get; set; } = "æ“ä½œ";
    [Parameter] public string ActionsColumnWidth { get; set; } = "auto"; // æ“ä½œæ¬„ä½å¯¬åº¦åƒæ•¸ï¼šå¯è¨­å®šå›ºå®šå€¼(å¦‚"120px")ã€ç™¾åˆ†æ¯”(å¦‚"10%")ï¼Œæˆ–"auto"è‡ªå‹•è¨ˆç®—
    
    // è¡Œäº’å‹•è¨­å®š
    [Parameter] public Func<TItem, int, string>? GetRowCssClass { get; set; }
    [Parameter] public EventCallback<TItem> OnRowClick { get; set; }
    [Parameter] public bool EnableRowClick { get; set; } = false;
    [Parameter] public string RowClickCursor { get; set; } = "pointer";
    
    // è¡Œé¸å–åŠŸèƒ½è¨­å®š
    [Parameter] public bool EnableRowSelection { get; set; } = false;
    [Parameter] public bool AllowMultipleSelection { get; set; } = false;
    [Parameter] public HashSet<TItem>? SelectedItems { get; set; }
    [Parameter] public EventCallback<HashSet<TItem>> OnSelectionChanged { get; set; }
    
    // é©—è­‰ç›¸é—œ
    [Parameter] public EventCallback<(TItem item, string propertyName, string? errorMessage)> OnValidationFailed { get; set; }
    [Parameter] public Dictionary<string, string>? ValidationErrors { get; set; }
    
    // å…§å»ºæ“ä½œæŒ‰éˆ•ç›¸é—œ
    [Parameter] public bool ShowBuiltInActions { get; set; } = false;
    [Parameter] public bool ShowBuiltInDeleteButton { get; set; } = true;
    [Parameter] public string DeleteButtonIcon { get; set; } = "bi bi-trash text-white";
    [Parameter] public ButtonVariant DeleteButtonVariant { get; set; } = ButtonVariant.Danger;
    [Parameter] public ButtonSize DeleteButtonSize { get; set; } = ButtonSize.Large;
    [Parameter] public string DeleteButtonTitle { get; set; } = "åˆªé™¤";
    [Parameter] public Func<TItem, bool>? IsDeleteDisabled { get; set; }
    [Parameter] public EventCallback<TItem> OnItemDelete { get; set; }
    [Parameter] public RenderFragment<TItem>? CustomActionsTemplate { get; set; }
    #endregion

    #region ç§æœ‰æ¬„ä½
    
    // è¨˜éŒ„æœ€å¾Œä¸€å€‹ç©ºè¡Œçš„åƒè€ƒ
    private TItem? _lastEmptyRow = default;
    
    #endregion

    #region ç”Ÿå‘½é€±æœŸæ–¹æ³•
    
    protected override void OnInitialized()
    {
        base.OnInitialized();
        
        // åªåœ¨åˆå§‹åŒ–æ™‚æª¢æŸ¥ä¸€æ¬¡
        if (EnableAutoEmptyRow)
        {
            CheckAndAddEmptyRowIfNeeded();
        }
    }
    
    #endregion

    #region ç§æœ‰æ–¹æ³•
    private string GetTableClass()
    {
        var classes = new List<string>();
        
        if (IsStriped) classes.Add("table-striped");
        if (IsHoverable) classes.Add("table-hover");
        if (IsBordered) classes.Add("table-bordered");
        classes.Add("table-with-column-borders");
        
        if (!string.IsNullOrEmpty(CssClass))
            classes.Add(CssClass);
            
        return string.Join(" ", classes.Where(c => !string.IsNullOrEmpty(c)));
    }

    private string GetHeaderClass()
    {
        return "table-header-primary";
    }

    private string GetRowClass(TItem item, int index)
    {
        var classes = new List<string>();
        
        // ä½¿ç”¨è€…è‡ªè¨‚çš„ CSS class
        if (GetRowCssClass != null)
        {
            var customClass = GetRowCssClass(item, index);
            if (!string.IsNullOrEmpty(customClass))
                classes.Add(customClass);
        }
        
        // å¦‚æœå•Ÿç”¨é¸å–åŠŸèƒ½ï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºé¸å–çš„é …ç›®
        if (EnableRowSelection && SelectedItems != null && SelectedItems.Contains(item))
        {
            classes.Add("row-selected");
        }
        
        return string.Join(" ", classes);
    }

    private string? GetColumnWidthStyle(InteractiveColumnDefinition column)
    {
        return !string.IsNullOrEmpty(column.Width) ? $"width: {column.Width};" : null;
    }

    private string? GetActionsColumnStyle()
    {
        // å¦‚æœæœ‰æ˜ç¢ºè¨­å®šå¯¬åº¦ï¼Œç›´æ¥ä½¿ç”¨
        if (!string.IsNullOrEmpty(ActionsColumnWidth) && ActionsColumnWidth != "auto")
        {
            return $"width: {ActionsColumnWidth};";
        }
        
        // è‡ªå‹•è¨ˆç®—å‰©é¤˜å¯¬åº¦
        if (ColumnDefinitions != null && ColumnDefinitions.Any())
        {
            var totalUsedPercentage = 0m;
            var hasPercentageColumns = false;
            
            foreach (var column in ColumnDefinitions)
            {
                if (!string.IsNullOrEmpty(column.Width) && column.Width.EndsWith("%"))
                {
                    hasPercentageColumns = true;
                    var percentageStr = column.Width.Replace("%", "");
                    if (decimal.TryParse(percentageStr, out var percentage))
                    {
                        totalUsedPercentage += percentage;
                    }
                }
            }
            
            // å¦‚æœæœ‰ä½¿ç”¨ç™¾åˆ†æ¯”çš„æ¬„ä½ï¼Œè¨ˆç®—å‰©é¤˜ç©ºé–“
            if (hasPercentageColumns)
            {
                var remainingPercentage = 100 - totalUsedPercentage;
                
                // ç¢ºä¿è‡³å°‘æœ‰ 5% çš„ç©ºé–“çµ¦æ“ä½œæ¬„ä½ï¼Œæœ€å¤šä¸è¶…é 15%
                var actionsPercentage = Math.Max(5, Math.Min(15, remainingPercentage));
                
                return $"width: {actionsPercentage}%;";
            }
        }
        
        // é è¨­æƒ…æ³ï¼šä½¿ç”¨å›ºå®šå¯¬åº¦
        return "width: 120px;";
    }

    private int GetColspan()
    {
        var columnCount = ColumnDefinitions?.Count ?? 0;
        if (ShowRowNumbers) columnCount++;
        if (ShowActions) columnCount++;
        if (ShowBuiltInActions) columnCount++;
        return columnCount;
    }

    private async Task HandleRowClick(TItem item)
    {
        // è™•ç†è¡Œé¸å–åŠŸèƒ½
        if (EnableRowSelection)
        {
            if (SelectedItems == null)
            {
                SelectedItems = new HashSet<TItem>();
            }
            
            if (AllowMultipleSelection)
            {
                // å¤šé¸æ¨¡å¼ï¼šåˆ‡æ›é¸å–ç‹€æ…‹
                if (SelectedItems.Contains(item))
                {
                    SelectedItems.Remove(item);
                }
                else
                {
                    SelectedItems.Add(item);
                }
            }
            else
            {
                // å–®é¸æ¨¡å¼ï¼šæ¸…é™¤å…¶ä»–é¸å–ï¼Œåªé¸å–ç•¶å‰é …ç›®
                if (SelectedItems.Contains(item) && SelectedItems.Count == 1)
                {
                    // å¦‚æœé»æ“Šå·²é¸å–çš„å”¯ä¸€é …ç›®ï¼Œå‰‡å–æ¶ˆé¸å–
                    SelectedItems.Clear();
                }
                else
                {
                    SelectedItems.Clear();
                    SelectedItems.Add(item);
                }
            }
            
            // é€šçŸ¥çˆ¶çµ„ä»¶é¸å–ç‹€æ…‹å·²æ”¹è®Š
            if (OnSelectionChanged.HasDelegate)
            {
                await OnSelectionChanged.InvokeAsync(SelectedItems);
            }
            
            StateHasChanged();
        }
        
        // åŸæœ‰çš„ OnRowClick äº‹ä»¶
        if (EnableRowClick && OnRowClick.HasDelegate)
        {
            await OnRowClick.InvokeAsync(item);
        }
    }

    private object? GetPropertyValue(TItem item, string propertyName)
    {
        if (item == null || string.IsNullOrEmpty(propertyName))
            return null;

        // æ”¯æ´å·¢ç‹€å±¬æ€§ ä¾‹å¦‚: "Customer.Name"
        var parts = propertyName.Split('.');
        object? currentValue = item;
        
        foreach (var part in parts)
        {
            if (currentValue == null) return null;
            
            var currentType = currentValue.GetType();
            var property = currentType.GetProperty(part);
            
            if (property == null) return null;
            
            currentValue = property.GetValue(currentValue);
        }
        
        return currentValue;
    }

    private void SetPropertyValue(TItem item, string propertyName, object? value)
    {
        if (item == null || string.IsNullOrEmpty(propertyName))
            return;

        try
        {
            var parts = propertyName.Split('.');
            object? currentObj = item;
            
            // æ‰¾åˆ°æœ€å¾Œä¸€å€‹ç‰©ä»¶
            for (int i = 0; i < parts.Length - 1; i++)
            {
                if (currentObj == null) return;
                
                var property = currentObj.GetType().GetProperty(parts[i]);
                if (property == null) return;
                
                currentObj = property.GetValue(currentObj);
            }
            
            if (currentObj == null) return;
            
            // è¨­å®šæœ€å¾Œçš„å±¬æ€§å€¼
            var finalProperty = currentObj.GetType().GetProperty(parts.Last());
            if (finalProperty != null && finalProperty.CanWrite)
            {
                // å‹åˆ¥è½‰æ›
                var convertedValue = ConvertValue(value, finalProperty.PropertyType);
                finalProperty.SetValue(currentObj, convertedValue);
            }
        }
        catch
        {
            // å¿½ç•¥è¨­å®šå±¬æ€§å€¼å¤±æ•—
        }
    }

    private object? ConvertValue(object? value, Type targetType)
    {
        if (value == null)
            return targetType.IsValueType ? Activator.CreateInstance(targetType) : null;

        if (targetType.IsAssignableFrom(value.GetType()))
            return value;

        // è™•ç† Nullable å‹åˆ¥
        var underlyingType = Nullable.GetUnderlyingType(targetType) ?? targetType;

        try
        {
            if (underlyingType == typeof(bool) && value is string strValue)
            {
                return bool.TryParse(strValue, out var boolResult) ? boolResult : false;
            }

            return Convert.ChangeType(value, underlyingType);
        }
        catch
        {
            return targetType.IsValueType ? Activator.CreateInstance(targetType) : null;
        }
    }

    private async Task ValidateField(TItem item, InteractiveColumnDefinition column, string? value)
    {
        if (column.IsRequired && string.IsNullOrWhiteSpace(value))
        {
            await OnValidationFailed.InvokeAsync((item, column.PropertyName, $"{column.Title} ç‚ºå¿…å¡«æ¬„ä½"));
            return;
        }

        if (!string.IsNullOrEmpty(column.ValidationPattern) && !string.IsNullOrWhiteSpace(value))
        {
            var regex = new System.Text.RegularExpressions.Regex(column.ValidationPattern);
            if (!regex.IsMatch(value))
            {
                await OnValidationFailed.InvokeAsync((item, column.PropertyName, $"{column.Title} æ ¼å¼ä¸æ­£ç¢º"));
                return;
            }
        }

        if (column.ColumnType == InteractiveColumnType.Number && !string.IsNullOrWhiteSpace(value))
        {
            if (decimal.TryParse(value, out var numValue))
            {
                if (column.MinValue.HasValue && numValue < column.MinValue.Value)
                {
                    await OnValidationFailed.InvokeAsync((item, column.PropertyName, $"{column.Title} ä¸èƒ½å°æ–¼ {column.MinValue.Value}"));
                    return;
                }

                if (column.MaxValue.HasValue && numValue > column.MaxValue.Value)
                {
                    await OnValidationFailed.InvokeAsync((item, column.PropertyName, $"{column.Title} ä¸èƒ½å¤§æ–¼ {column.MaxValue.Value}"));
                    return;
                }
            }
            else
            {
                await OnValidationFailed.InvokeAsync((item, column.PropertyName, $"{column.Title} å¿…é ˆç‚ºæœ‰æ•ˆæ•¸å­—"));
                return;
            }
        }
    }

    private string GetValidationCssClass(TItem item, string propertyName)
    {
        if (ValidationErrors?.ContainsKey($"{item?.GetHashCode()}_{propertyName}") == true)
        {
            return "is-invalid";
        }
        return "";
    }
    
    #region è‡ªå‹•ç©ºè¡Œç®¡ç†æ–¹æ³•
    
    /// <summary>
    /// æª¢æŸ¥æŒ‡å®šé …ç›®æ˜¯å¦ç‚ºç©ºè¡Œ
    /// è¦å‰‡ï¼š
    /// 1. å¦‚æœæœ‰æ¬„ä½è¨­å®š TriggerEmptyRowOnFilledï¼Œåªæª¢æŸ¥é€™äº›ã€Œè§¸ç™¼æ¬„ä½ã€æ˜¯å¦éƒ½ç‚ºç©º
    /// 2. å¦‚æœæ²’æœ‰è§¸ç™¼æ¬„ä½ï¼Œå‰‡æª¢æŸ¥æ‰€æœ‰å¯ç·¨è¼¯ä¸”æœªæ’é™¤çš„æ¬„ä½
    /// </summary>
    private bool IsRowEmpty(TItem item)
    {
        if (item == null || ColumnDefinitions == null) return true;
        
        // ğŸ”‘ å„ªå…ˆæª¢æŸ¥æ˜¯å¦æœ‰è¨­å®š TriggerEmptyRowOnFilled çš„æ¬„ä½
        var triggerFields = ColumnDefinitions
            .Where(c => c.TriggerEmptyRowOnFilled)
            .ToList();
        
        if (triggerFields.Any())
        {
            Console.WriteLine($"[IsRowEmpty] ä½¿ç”¨ TriggerEmptyRowOnFilled æ¨¡å¼ï¼Œæª¢æŸ¥ {triggerFields.Count} å€‹è§¸ç™¼æ¬„ä½");
            
            // ğŸ”‘ æª¢æŸ¥æ‰€æœ‰è§¸ç™¼æ¬„ä½ï¼šå¿…é ˆæ‰€æœ‰è§¸ç™¼æ¬„ä½éƒ½æœ‰å€¼ï¼Œæ‰ä¸æ˜¯ç©ºè¡Œ
            foreach (var field in triggerFields)
            {
                var propertyName = !string.IsNullOrEmpty(field.EmptyCheckPropertyName)
                    ? field.EmptyCheckPropertyName
                    : field.PropertyName;
                
                if (string.IsNullOrEmpty(propertyName))
                {
                    Console.WriteLine($"[IsRowEmpty] è·³é: {field.Title} (ç„¡å±¬æ€§åç¨±)");
                    continue;
                }
                
                var value = GetPropertyValue(item, propertyName);
                var isEmpty = IsValueNullOrEmpty(value);
                
                Console.WriteLine($"[IsRowEmpty] è§¸ç™¼æ¬„ä½ {field.Title}: value={value}, isEmpty={isEmpty}");
                
                // ğŸ”‘ åªè¦æœ‰ä¸€å€‹è§¸ç™¼æ¬„ä½æ˜¯ç©ºçš„ï¼Œæ•´è¡Œå°±æ˜¯ç©ºè¡Œ
                if (isEmpty)
                {
                    Console.WriteLine($"[IsRowEmpty] Result: true (è§¸ç™¼æ¬„ä½ {field.Title} æ˜¯ç©ºçš„)");
                    return true;
                }
            }
            
            // ğŸ”‘ æ‰€æœ‰è§¸ç™¼æ¬„ä½éƒ½æœ‰å€¼ï¼Œæ‰ä¸æ˜¯ç©ºè¡Œ
            Console.WriteLine($"[IsRowEmpty] Result: false (æ‰€æœ‰è§¸ç™¼æ¬„ä½éƒ½æœ‰å€¼)");
            return false;
        }
        
        // ğŸ”‘ æ²’æœ‰è§¸ç™¼æ¬„ä½ï¼Œä½¿ç”¨åŸæœ‰é‚è¼¯ï¼šæª¢æŸ¥æ‰€æœ‰å¯ç·¨è¼¯ä¸”æœªæ’é™¤çš„æ¬„ä½
        var columnsToCheck = ColumnDefinitions
            .Where(c => !c.IsReadOnly && !c.ExcludeFromEmptyCheck)
            .ToList();
        
        Console.WriteLine($"[IsRowEmpty] ä½¿ç”¨å‚³çµ±æ¨¡å¼ï¼Œæª¢æŸ¥ {columnsToCheck.Count} å€‹æ¬„ä½");
        
        // æ²’æœ‰å¯æª¢æŸ¥çš„æ¬„ä½ï¼Œè¦–ç‚ºéç©ºè¡Œ
        if (!columnsToCheck.Any()) return false;
        
        // æª¢æŸ¥æ¯å€‹æ¬„ä½
        foreach (var column in columnsToCheck)
        {
            var propertyNameToCheck = !string.IsNullOrEmpty(column.EmptyCheckPropertyName)
                ? column.EmptyCheckPropertyName
                : column.PropertyName;
            
            if (string.IsNullOrEmpty(propertyNameToCheck)) continue;
            
            var value = GetPropertyValue(item, propertyNameToCheck);
            
            // åªè¦æœ‰ä¸€å€‹æ¬„ä½æœ‰å€¼ï¼Œå°±ä¸æ˜¯ç©ºè¡Œ
            if (!IsValueNullOrEmpty(value))
            {
                Console.WriteLine($"[IsRowEmpty] Result: false ({column.Title} æœ‰å€¼)");
                return false;
            }
        }
        
        // æ‰€æœ‰æ¬„ä½éƒ½ç©ºï¼Œæ‰æ˜¯ç©ºè¡Œ
        Console.WriteLine($"[IsRowEmpty] Result: true (æ‰€æœ‰æ¬„ä½éƒ½ç©º)");
        return true;
    }
    
    /// <summary>
    /// åˆ¤æ–·å€¼æ˜¯å¦ç‚º null æˆ– empty
    /// è¦å‰‡ï¼š
    /// - null â†’ ç©º
    /// - string: "" æˆ– whitespace â†’ ç©º
    /// - æ•¸å­—é¡å‹: 0 â†’ ç©ºï¼ˆå› ç‚ºæ•¸å­—æ¬„ä½é è¨­å€¼æ˜¯ 0ï¼Œæ‡‰è¦–ç‚ºæœªå¡«å¯«ï¼‰
    /// - å¸ƒæ—: false â†’ ç©º
    /// - å…¶ä»–é¡å‹ï¼šåªè¦ä¸æ˜¯ null å°±ç®—æœ‰å€¼
    /// <summary>
    /// åˆ¤æ–·å€¼æ˜¯å¦ç‚º null æˆ– empty
    /// è¦å‰‡ï¼š
    /// - null â†’ ç©º
    /// - string: "" æˆ– whitespace â†’ ç©º
    /// - å…¶ä»–é¡å‹ï¼šåªè¦ä¸æ˜¯ null å°±ç®—æœ‰å€¼
    /// </summary>
    private bool IsValueNullOrEmpty(object? value)
    {
        if (value == null) return true;
        if (value is string str) return string.IsNullOrWhiteSpace(str);
        
        // å…¶ä»–é¡å‹ï¼šä¸æ˜¯ null å°±ç®—æœ‰å€¼ï¼ˆæ•¸å­— 0ã€false ç­‰éƒ½ç®—æœ‰å€¼ï¼‰
        // å› ç‚ºä½¿ç”¨ TriggerEmptyRowOnFilledï¼Œä¸å†éœ€è¦å°‡ 0 è¦–ç‚ºç©ºå€¼
        return false;
    }
    
    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦æœ‰ç©ºè¡Œå­˜åœ¨
    /// </summary>
    private bool HasEmptyRow()
    {
        return Items?.Any(IsRowEmpty) ?? false;
    }
    
    /// <summary>
    /// çµ±ä¸€çš„ç©ºè¡Œæª¢æŸ¥å’Œæ–°å¢æ–¹æ³•
    /// æ ¸å¿ƒé‚è¼¯ï¼šç¢ºä¿å§‹çµ‚è‡³å°‘æœ‰ä¸€å€‹ç©ºè¡Œ
    /// </summary>
    private void CheckAndAddEmptyRowIfNeeded()
    {
        if (!EnableAutoEmptyRow || CreateEmptyItem == null || Items == null) 
        {
            return;
        }
        
        // ğŸ”‘ ç°¡åŒ–é‚è¼¯ï¼šåªæª¢æŸ¥æ˜¯å¦å­˜åœ¨ç©ºè¡Œï¼Œä¸å­˜åœ¨å°±æ–°å¢
        if (!HasEmptyRow())
        {
            Console.WriteLine($"[CheckAndAddEmptyRowIfNeeded] ç„¡ç©ºè¡Œï¼Œæ–°å¢ä¸€å€‹ - Items.Count={Items.Count}");
            
            var newEmptyRow = CreateEmptyItem();
            Items.Add(newEmptyRow);
            _lastEmptyRow = newEmptyRow; // è¨˜éŒ„æœ€å¾Œä¸€å€‹ç©ºè¡Œçš„åƒè€ƒï¼ˆç”¨æ–¼å…¶ä»–å¯èƒ½çš„æª¢æŸ¥ï¼‰
        }
    }
    
    /// <summary>
    /// ç¢ºä¿è‡³å°‘æœ‰ä¸€å€‹ç©ºè¡Œï¼ˆå‘ä¸‹å…¼å®¹ï¼‰
    /// </summary>
    private void EnsureOneEmptyRow()
    {
        CheckAndAddEmptyRowIfNeeded();
    }
    
    /// <summary>
    /// åœ¨è¼¸å…¥è®Šæ›´å¾Œï¼Œè‡ªå‹•æª¢æŸ¥ä¸¦æ–°å¢ç©ºè¡Œ
    /// </summary>
    private void AutoAddEmptyRowIfNeeded()
    {
        CheckAndAddEmptyRowIfNeeded();
    }
    
    #endregion
    
    #region å…¬é–‹æ–¹æ³•
    
    /// <summary>
    /// å…¬é–‹æ–¹æ³•ï¼šæ‰‹å‹•åˆ·æ–°ç©ºè¡Œæª¢æŸ¥
    /// é©ç”¨æ–¼çˆ¶çµ„ä»¶æ‰¹é‡è¼‰å…¥æˆ–æ¸…ç©ºè³‡æ–™å¾Œï¼Œéœ€è¦ç¢ºä¿ç©ºè¡Œå­˜åœ¨çš„å ´æ™¯
    /// </summary>
    public void RefreshEmptyRow()
    {
        if (!EnableAutoEmptyRow) return;
        
        Console.WriteLine($"[RefreshEmptyRow] è¢«å‘¼å« - Items.Count={Items?.Count ?? 0}");
        
        // é‡ç½®æœ€å¾Œç©ºè¡Œçš„åƒè€ƒ
        _lastEmptyRow = default;
        
        // åŸ·è¡Œç©ºè¡Œæª¢æŸ¥
        CheckAndAddEmptyRowIfNeeded();
        
        // æ‰‹å‹•è§¸ç™¼æ›´æ–°ï¼ˆå› ç‚ºæ˜¯å¤–éƒ¨å‘¼å«ï¼‰
        StateHasChanged();
    }
    
    #endregion
    
    #endregion
    #region äº‹ä»¶è™•ç†æ–¹æ³•
    private async Task HandleInputChange(InteractiveColumnDefinition column, TItem item, string? value)
    {
        // è¨˜éŒ„è®Šæ›´å‰çš„ç‹€æ…‹
        var wasEmpty = EnableAutoEmptyRow ? IsRowEmpty(item) : false;
        var fieldWasEmpty = EnableAutoEmptyRow && column.TriggerEmptyRowOnFilled 
            ? IsValueNullOrEmpty(GetPropertyValue(item, column.PropertyName)) 
            : false;
        
        Console.WriteLine($"[HandleInputChange] Column={column.Title}, Value={value}, wasEmpty={wasEmpty}, fieldWasEmpty={fieldWasEmpty}, TriggerOnFilled={column.TriggerEmptyRowOnFilled}");
        
        await ValidateField(item, column, value);
        SetPropertyValue(item, column.PropertyName, value);
        
        if (column.OnInputChanged.HasValue)
        {
            await column.OnInputChanged.Value.InvokeAsync((item!, value));
        }
        
        // ğŸ”‘ æ–°é‚è¼¯ï¼šå¦‚æœé€™å€‹æ¬„ä½è¨­å®šç‚ºè§¸ç™¼æ¬„ä½ï¼Œå„ªå…ˆä½¿ç”¨æ¬„ä½ç´šåˆ¥çš„è§¸ç™¼
        if (EnableAutoEmptyRow && column.TriggerEmptyRowOnFilled)
        {
            var fieldHasValueNow = !IsValueNullOrEmpty(value);
            Console.WriteLine($"[HandleInputChange] TriggerMode: fieldHasValueNow={fieldHasValueNow}, willTrigger={wasEmpty && fieldWasEmpty && fieldHasValueNow}");
            
            // æ•´è¡ŒåŸæœ¬æ˜¯ç©ºçš„ && é€™å€‹æ¬„ä½åŸæœ¬æ˜¯ç©ºçš„ && é€™å€‹æ¬„ä½ç¾åœ¨æœ‰å€¼ â†’ è§¸ç™¼æ–°å¢ç©ºè¡Œ
            if (wasEmpty && fieldWasEmpty && fieldHasValueNow)
            {
                Console.WriteLine($"[HandleInputChange] âœ… è§¸ç™¼ AutoAddEmptyRowIfNeeded (æ¬„ä½è§¸ç™¼æ¨¡å¼)");
                AutoAddEmptyRowIfNeeded();
                return;
            }
        }
        
        // æª¢æŸ¥è®Šæ›´å¾Œçš„æ•´è¡Œç‹€æ…‹
        var isEmptyNow = EnableAutoEmptyRow ? IsRowEmpty(item) : false;
        Console.WriteLine($"[HandleInputChange] NormalMode: isEmptyNow={isEmptyNow}, willAddRow={wasEmpty && !isEmptyNow}");
        
        // ğŸ”‘ åŸæœ‰é‚è¼¯ï¼šæ•´è¡Œå¾ç©ºè®Šéç©ºæ™‚ï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦æ–°å¢ç©ºè¡Œ
        if (EnableAutoEmptyRow && wasEmpty && !isEmptyNow)
        {
            Console.WriteLine($"[HandleInputChange] âœ… è§¸ç™¼ AutoAddEmptyRowIfNeeded (æ•´è¡Œè§¸ç™¼æ¨¡å¼)");
            AutoAddEmptyRowIfNeeded();
        }
    }

    private async Task HandleSelectionChange(InteractiveColumnDefinition column, TItem item, object? value)
    {
        // è¨˜éŒ„è®Šæ›´å‰çš„ç‹€æ…‹
        var wasEmpty = EnableAutoEmptyRow ? IsRowEmpty(item) : false;
        var fieldWasEmpty = EnableAutoEmptyRow && column.TriggerEmptyRowOnFilled 
            ? IsValueNullOrEmpty(GetPropertyValue(item, column.PropertyName)) 
            : false;
        
        SetPropertyValue(item, column.PropertyName, value);
        
        if (column.OnSelectionChanged.HasValue)
        {
            await column.OnSelectionChanged.Value.InvokeAsync((item!, value));
        }
        
        // ğŸ”‘ å¦‚æœé€™å€‹æ¬„ä½è¨­å®šç‚ºè§¸ç™¼æ¬„ä½ï¼Œå„ªå…ˆä½¿ç”¨æ¬„ä½ç´šåˆ¥çš„è§¸ç™¼
        if (EnableAutoEmptyRow && column.TriggerEmptyRowOnFilled)
        {
            var fieldHasValueNow = !IsValueNullOrEmpty(value);
            
            // æ•´è¡ŒåŸæœ¬æ˜¯ç©ºçš„ && é€™å€‹æ¬„ä½åŸæœ¬æ˜¯ç©ºçš„ && é€™å€‹æ¬„ä½ç¾åœ¨æœ‰å€¼ â†’ è§¸ç™¼æ–°å¢ç©ºè¡Œ
            if (wasEmpty && fieldWasEmpty && fieldHasValueNow)
            {
                AutoAddEmptyRowIfNeeded();
                return;
            }
        }
        
        // ğŸ”‘ åŸæœ‰é‚è¼¯ï¼šæ•´è¡Œå¾ç©ºè®Šéç©ºæ™‚ï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦æ–°å¢ç©ºè¡Œ
        var isEmptyNow = EnableAutoEmptyRow ? IsRowEmpty(item) : false;
        if (EnableAutoEmptyRow && wasEmpty && !isEmptyNow)
        {
            AutoAddEmptyRowIfNeeded();
        }
    }

    private async Task HandleCheckboxChange(InteractiveColumnDefinition column, TItem item, object? value)
    {
        // ğŸ”‘ è¨˜éŒ„è®Šæ›´å‰çš„ç‹€æ…‹
        var wasEmpty = EnableAutoEmptyRow ? IsRowEmpty(item) : false;
        
        var isChecked = value is bool boolValue && boolValue;
        SetPropertyValue(item, column.PropertyName, isChecked);
        
        if (column.OnCheckboxChanged.HasValue)
        {
            await column.OnCheckboxChanged.Value.InvokeAsync((item!, isChecked));
        }
        
        // ğŸ”‘ åªæœ‰ç•¶é€™ä¸€è¡Œå¾ç©ºè®Šéç©ºæ™‚ï¼Œæ‰æª¢æŸ¥æ˜¯å¦éœ€è¦æ–°å¢ç©ºè¡Œ
        if (EnableAutoEmptyRow && wasEmpty && !IsRowEmpty(item))
        {
            AutoAddEmptyRowIfNeeded();
        }
    }

    private async Task HandleButtonClick(InteractiveColumnDefinition column, TItem item)
    {
        if (column.OnButtonClick.HasValue)
        {
            await column.OnButtonClick.Value.InvokeAsync(item!);
        }
    }
    
    private RenderFragment<TItem> GetBuiltInActionsTemplate()
    {
        return item => __builder =>
        {
            <div class="d-flex align-items-center justify-content-center h-100">
                @if (CustomActionsTemplate != null)
                {
                    @CustomActionsTemplate(item)
                }
                @if (ShowBuiltInDeleteButton)
                {
                    var isDeleteDisabled = IsReadOnly || (IsDeleteDisabled?.Invoke(item) ?? false);
                    <GenericButtonComponent Variant="@DeleteButtonVariant"
                                           IconClass="@DeleteButtonIcon"
                                           Size="@DeleteButtonSize"
                                           IsDisabled="@isDeleteDisabled"
                                           Title="@DeleteButtonTitle"
                                           OnClick="async () => await HandleBuiltInDelete(item)"
                                           StopPropagation="true"
                                           CssClass="btn-square" />
                }
            </div>
        };
    }
    
    private async Task HandleBuiltInDelete(TItem item)
    {
        if (OnItemDelete.HasDelegate)
        {
            await OnItemDelete.InvokeAsync(item);
            
            // è‡ªå‹•ç©ºè¡Œç®¡ç†ï¼šç¢ºä¿åˆªé™¤å¾Œé‚„æœ‰ç©ºè¡Œ
            EnsureOneEmptyRow();
        }
    }
    
    #region éµç›¤å°èˆªç›¸é—œæ–¹æ³•
    /// <summary>
    /// è™•ç†éµç›¤å°èˆªäº‹ä»¶
    /// </summary>
    private async Task HandleKeyboardNavigation(InteractiveColumnDefinition column, TItem item, KeyboardEventArgs e)
    {
        if (!column.EnableKeyboardNavigation || column.GetDropdownItems == null || 
            column.GetShowDropdown == null || column.SetSelectedIndex == null || 
            column.GetSelectedIndex == null || column.SetShowDropdown == null)
            return;

        var dropdownItems = column.GetDropdownItems(item!).ToList();
        var showDropdown = column.GetShowDropdown(item!);
        var selectedIndex = column.GetSelectedIndex(item!);

        if (!showDropdown || !dropdownItems.Any())
            return;

        switch (e.Key)
        {
            case "ArrowDown":
                var newDownIndex = Math.Min(selectedIndex + 1, dropdownItems.Count - 1);
                column.SetSelectedIndex(item!, newDownIndex);
                await ScrollSelectedItemIntoView(column, item, newDownIndex);
                StateHasChanged();
                break;
                
            case "ArrowUp":
                var newUpIndex = Math.Max(selectedIndex - 1, 0);
                column.SetSelectedIndex(item!, newUpIndex);
                await ScrollSelectedItemIntoView(column, item, newUpIndex);
                StateHasChanged();
                break;
                
            case "Enter":
                if (selectedIndex >= 0 && selectedIndex < dropdownItems.Count)
                {
                    var selectedItem = dropdownItems[selectedIndex];
                    if (column.OnDropdownItemSelected.HasValue)
                    {
                        await column.OnDropdownItemSelected.Value.InvokeAsync((item!, selectedItem));
                    }
                }
                break;
                
            case "Escape":
                column.SetShowDropdown(item!, false);
                column.SetSelectedIndex(item!, -1);
                StateHasChanged();
                break;
        }
    }

    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦ç‚ºå°èˆªæŒ‰éµï¼ˆç”¨æ–¼ preventDefaultï¼‰
    /// </summary>
    private bool IsNavigationKey(KeyboardEventArgs e)
    {
        return e.Key is "ArrowDown" or "ArrowUp" or "Enter" or "Escape";
    }

    /// <summary>
    /// å°‡é¸ä¸­çš„é …ç›®æ²å‹•åˆ°å¯è¦–ç¯„åœå…§
    /// </summary>
    private async Task ScrollSelectedItemIntoView(InteractiveColumnDefinition column, TItem item, int selectedIndex)
    {
        try
        {
            var currentIndex = Items?.ToList().IndexOf(item) ?? 0;
            var dropdownId = $"dropdown-{GetHashCode()}-{currentIndex}";
            var itemId = $"dropdown-item-{GetHashCode()}-{currentIndex}-{selectedIndex}";
            
            await JSRuntime.InvokeVoidAsync("scrollDropdownItemIntoView", dropdownId, itemId);
        }
        catch (Exception)
        {
            // å¿½ç•¥ JavaScript éŒ¯èª¤
        }
    }
    #endregion
    #endregion
    
    #region SearchableSelect äº‹ä»¶è™•ç†æ–¹æ³•
    private async Task HandleSearchableSelectInput(InteractiveColumnDefinition column, TItem item, string? value)
    {
        // ğŸ”‘ è¨˜éŒ„è®Šæ›´å‰çš„ç‹€æ…‹
        var wasEmpty = EnableAutoEmptyRow ? IsRowEmpty(item) : false;
        
        // å„ªå…ˆä½¿ç”¨ Action å§”è¨—ï¼ˆä¾†è‡ª SearchableSelectHelperï¼‰
        if (column.SearchInputChangedAction != null)
        {
            column.SearchInputChangedAction(item!, value);
        }
        else if (column.SearchInputChangedCallback.HasValue)
        {
            await column.SearchInputChangedCallback.Value.InvokeAsync((item!, value));
        }
        else if (column.OnSearchInputChanged.HasValue)
        {
            await column.OnSearchInputChanged.Value.InvokeAsync((item!, value));
        }
        
        // ğŸ”‘ åªæœ‰ç•¶é€™ä¸€è¡Œå¾ç©ºè®Šéç©ºæ™‚ï¼Œæ‰æª¢æŸ¥æ˜¯å¦éœ€è¦æ–°å¢ç©ºè¡Œ
        // æ³¨æ„ï¼šSearchableSelect é€šå¸¸ä¸æœƒåœ¨è¼¸å…¥æ™‚å°±æ”¹è®Šç©ºè¡Œç‹€æ…‹ï¼Œè€Œæ˜¯åœ¨é¸æ“‡é …ç›®æ™‚
        if (EnableAutoEmptyRow && wasEmpty && !IsRowEmpty(item))
        {
            AutoAddEmptyRowIfNeeded();
        }
    }
    
    private async Task HandleSearchableSelectFocus(InteractiveColumnDefinition column, TItem item)
    {
        // å„ªå…ˆä½¿ç”¨ Action å§”è¨—ï¼ˆä¾†è‡ª SearchableSelectHelperï¼‰
        if (column.InputFocusAction != null)
        {
            column.InputFocusAction(item!);
        }
        else if (column.InputFocusCallback.HasValue)
        {
            await column.InputFocusCallback.Value.InvokeAsync(item!);
        }
        else if (column.OnInputFocus.HasValue)
        {
            await column.OnInputFocus.Value.InvokeAsync(item!);
        }
    }
    
    private async Task HandleSearchableSelectBlur(InteractiveColumnDefinition column, TItem item)
    {
        // å„ªå…ˆä½¿ç”¨ Action å§”è¨—ï¼ˆä¾†è‡ª SearchableSelectHelperï¼‰
        if (column.InputBlurAction != null)
        {
            column.InputBlurAction(item!);
        }
        else if (column.InputBlurCallback.HasValue)
        {
            await column.InputBlurCallback.Value.InvokeAsync(item!);
        }
        else if (column.OnInputBlur.HasValue)
        {
            await column.OnInputBlur.Value.InvokeAsync(item!);
        }
    }
    
    private async Task HandleSearchableSelectItemClick(InteractiveColumnDefinition column, TItem item, object selectedItem)
    {
        // ğŸ”‘ è¨˜éŒ„è®Šæ›´å‰çš„ç‹€æ…‹
        var wasEmpty = EnableAutoEmptyRow ? IsRowEmpty(item) : false;
        
        // å„ªå…ˆä½¿ç”¨ Action å§”è¨—ï¼ˆä¾†è‡ª SearchableSelectHelperï¼‰
        if (column.ItemSelectedAction != null)
        {
            column.ItemSelectedAction(item!, selectedItem);
        }
        else if (column.ItemSelectedCallback.HasValue)
        {
            await column.ItemSelectedCallback.Value.InvokeAsync((item!, selectedItem));
        }
        else if (column.OnItemSelected.HasValue)
        {
            await column.OnItemSelected.Value.InvokeAsync((item!, selectedItem));
        }
        
        // ğŸ”‘ åªæœ‰ç•¶é€™ä¸€è¡Œå¾ç©ºè®Šéç©ºæ™‚ï¼Œæ‰æª¢æŸ¥æ˜¯å¦éœ€è¦æ–°å¢ç©ºè¡Œ
        if (EnableAutoEmptyRow && wasEmpty && !IsRowEmpty(item))
        {
            AutoAddEmptyRowIfNeeded();
        }
    }
    
    private async Task HandleSearchableSelectItemMouseEnter(InteractiveColumnDefinition column, TItem item, int index)
    {
        // å„ªå…ˆä½¿ç”¨ Action å§”è¨—ï¼ˆä¾†è‡ª SearchableSelectHelperï¼‰
        if (column.ItemMouseEnterAction != null)
        {
            column.ItemMouseEnterAction(item!, index);
        }
        else if (column.ItemMouseEnterCallback.HasValue)
        {
            await column.ItemMouseEnterCallback.Value.InvokeAsync((item!, index));
        }
        else if (column.OnItemMouseEnter.HasValue)
        {
            await column.OnItemMouseEnter.Value.InvokeAsync((item!, index));
        }
    }
    
    private async Task HandleSearchableSelectKeyDown(InteractiveColumnDefinition column, TItem item, KeyboardEventArgs e)
    {
        if (column.EnableKeyboardNavigation)
        {
            // é˜²æ­¢é è¨­è¡Œç‚ºï¼ˆå°å°èˆªéµï¼‰
            if (IsNavigationKey(e))
            {
                await HandleKeyboardNavigation(column, item, e);
            }
        }
    }
    #endregion
}

<script>
    // æœå°‹ä¸‹æ‹‰é¸å–®å‹•æ…‹å®šä½è…³æœ¬
    function positionSearchableDropdown() {
        const dropdowns = document.querySelectorAll('.searchable-dropdown.show');
        
        dropdowns.forEach(dropdown => {
            const input = dropdown.previousElementSibling;
            if (!input) return;
            
            const inputRect = input.getBoundingClientRect();
            const dropdownRect = dropdown.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            
            // è¨ˆç®—æœ€ä½³ä½ç½®
            let top = inputRect.bottom + window.scrollY;
            let left = inputRect.left + window.scrollX;
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦å‘ä¸Šé¡¯ç¤ºï¼ˆç©ºé–“ä¸è¶³æ™‚ï¼‰
            if (inputRect.bottom + dropdownRect.height > viewportHeight) {
                if (inputRect.top > dropdownRect.height) {
                    top = inputRect.top + window.scrollY - dropdownRect.height;
                }
            }
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦èª¿æ•´æ°´å¹³ä½ç½®ï¼ˆé¿å…è¶…å‡ºè¢å¹•ï¼‰
            if (left + dropdownRect.width > viewportWidth) {
                left = viewportWidth - dropdownRect.width - 10;
                if (left < 10) left = 10;
            }
            
            // æ‡‰ç”¨è¨ˆç®—å‡ºçš„ä½ç½®
            dropdown.style.position = 'fixed';
            dropdown.style.top = (top - window.scrollY) + 'px';
            dropdown.style.left = (left - window.scrollX) + 'px';
            dropdown.style.width = Math.max(inputRect.width, 200) + 'px';
        });
    }
    
    // ç•¶é é¢è¼‰å…¥å®Œæˆæˆ–ä¸‹æ‹‰é¸å–®é¡¯ç¤ºæ™‚åŸ·è¡Œå®šä½
    document.addEventListener('DOMContentLoaded', positionSearchableDropdown);
    
    // ä½¿ç”¨ MutationObserver ç›£è½ä¸‹æ‹‰é¸å–®çš„é¡¯ç¤º/éš±è—
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                const target = mutation.target;
                if (target.classList.contains('searchable-dropdown') && target.classList.contains('show')) {
                    setTimeout(positionSearchableDropdown, 10);
                }
            } else if (mutation.type === 'childList') {
                const addedNodes = Array.from(mutation.addedNodes);
                addedNodes.forEach(node => {
                    if (node.nodeType === 1 && node.classList && 
                        node.classList.contains('searchable-dropdown') && 
                        node.classList.contains('show')) {
                        setTimeout(positionSearchableDropdown, 10);
                    }
                });
            }
        });
    });
    
    // é–‹å§‹è§€å¯Ÿæ•´å€‹æ–‡æª”
    observer.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['class']
    });
    
    // æ»¾å‹•å’Œè¦–çª—å¤§å°è®ŠåŒ–æ™‚é‡æ–°å®šä½
    window.addEventListener('scroll', positionSearchableDropdown);
    window.addEventListener('resize', positionSearchableDropdown);
    
    // å°‡é¸ä¸­çš„ä¸‹æ‹‰é¸å–®é …ç›®æ»¾å‹•åˆ°å¯è¦–ç¯„åœå…§
    window.scrollDropdownItemIntoView = function(dropdownId, itemId) {
        try {
            const dropdown = document.getElementById(dropdownId);
            const item = document.getElementById(itemId);
            
            if (!dropdown || !item) {
                return;
            }
            
            const dropdownRect = dropdown.getBoundingClientRect();
            const itemRect = item.getBoundingClientRect();
            
            // è¨ˆç®—é …ç›®ç›¸å°æ–¼ä¸‹æ‹‰å®¹å™¨çš„ä½ç½®
            const itemTop = item.offsetTop;
            const itemBottom = itemTop + item.offsetHeight;
            const dropdownScrollTop = dropdown.scrollTop;
            const dropdownHeight = dropdown.clientHeight;
            
            // æª¢æŸ¥é …ç›®æ˜¯å¦åœ¨å¯è¦–ç¯„åœå…§
            const isItemVisible = itemTop >= dropdownScrollTop && 
                                itemBottom <= dropdownScrollTop + dropdownHeight;
            
            if (!isItemVisible) {
                // å¦‚æœé …ç›®åœ¨å¯è¦–ç¯„åœä¸Šæ–¹ï¼Œæ»¾å‹•åˆ°é …ç›®é ‚éƒ¨
                if (itemTop < dropdownScrollTop) {
                    dropdown.scrollTop = itemTop;
                }
                // å¦‚æœé …ç›®åœ¨å¯è¦–ç¯„åœä¸‹æ–¹ï¼Œæ»¾å‹•åˆ°é …ç›®åº•éƒ¨
                else if (itemBottom > dropdownScrollTop + dropdownHeight) {
                    dropdown.scrollTop = itemBottom - dropdownHeight;
                }
            }
        } catch (error) {
            console.warn('Error scrolling dropdown item into view:', error);
        }
    };
</script>
