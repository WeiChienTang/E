@namespace ERPCore2.Components.Shared.Modals
@typeparam TEntity where TEntity : class, new()
@using ERPCore2.Data.Entities
@using ERPCore2.Services.Interfaces
@using static ERPCore2.Components.Shared.Buttons.ButtonComponent
@using static ERPCore2.Components.Shared.Alerts.AlertComponent

@inject IJSRuntime JSRuntime

@* 通用管理模態視窗 - 可用於管理各種類型的實體資料 *@

<div class="modal fade" id="@ModalId" tabindex="-1" aria-labelledby="@($"{ModalId}Label")" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="@($"{ModalId}Label")">
                    <i class="@IconClass me-2"></i>
                    @Title
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="關閉" @onclick="CloseModal"></button>
            </div>
            
            <div class="modal-body">
                <LoadingComponent IsLoading="@isLoading" 
                                LoadingText="@LoadingText" 
                                ShowText="true" />

                @if (!isLoading)
                {
                    <!-- 新增表單 -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-plus text-primary me-2"></i>
                                新增@EntityDisplayName
                            </h6>
                        </div>
                        <div class="card-body">
                            <EditForm Model="@newEntity" OnValidSubmit="@CreateEntity">
                                <DataAnnotationsValidator />
                                
                                @CreateFormContent(newEntity)
                                
                                <div class="d-flex justify-content-end mt-3">
                                    <ButtonComponent Text="新增" 
                                                   Variant="ButtonVariant.Primary" 
                                                   IconClass="fas fa-plus"
                                                   IsDisabled="@isSubmitting"
                                                   IsSubmit="true" />
                                </div>
                            </EditForm>
                        </div>
                    </div>

                    <!-- 現有資料列表 -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-list text-info me-2"></i>
                                現有@EntityDisplayName
                                <span class="badge bg-info">@entities.Count</span>
                            </h6>
                        </div>
                        <div class="card-body">
                            @if (entities.Any())
                            {                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                @TableHeaders
                                                <th class="text-end">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var entity in entities)
                                            {
                                                <tr class="@(GetEntityStatus(entity) == EntityStatus.Inactive ? "table-secondary" : "")">
                                                    @TableRowContent(entity)
                                                    <td class="text-end">
                                                        <div class="btn-group btn-group-sm" role="group">
                                                            @if (GetEntityStatus(entity) == EntityStatus.Active)
                                                            {
                                                                <ButtonComponent Text="" 
                                                                               Variant="ButtonVariant.OutlineSecondary" 
                                                                               Size="ButtonSize.Small"
                                                                               IconClass="fas fa-pause"
                                                                               Title="停用"
                                                                               OnClick="@(() => ToggleEntityStatus(GetEntityId(entity), EntityStatus.Inactive))" />
                                                            }                                            
                                                            else
                                                            {
                                                                <ButtonComponent Text="" 
                                                                            Variant="ButtonVariant.Success" 
                                                                            Size="ButtonSize.Small"
                                                                            IconClass="fas fa-play"
                                                                            Title="啟用"
                                                                            OnClick="@(() => ToggleEntityStatus(GetEntityId(entity), EntityStatus.Active))" />
                                                            }
                                                            
                                                            <ButtonComponent Text="" 
                                                                           Variant="ButtonVariant.OutlineDanger" 
                                                                           Size="ButtonSize.Small"
                                                                           IconClass="fas fa-trash"
                                                                           Title="刪除"
                                                                           OnClick="@(() => DeleteEntity(GetEntityId(entity)))" />
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-4">
                                    <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                                    <p class="text-muted">尚未建立任何@EntityDisplayName</p>
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- 錯誤訊息顯示 -->
                @if (!string.IsNullOrWhiteSpace(errorMessage))
                {
                    <AlertComponent Type="AlertType.Danger" 
                                  Message="@errorMessage" 
                                  IconClass="fas fa-exclamation-triangle"
                                  OnDismiss="ClearError" />
                }

                <!-- 成功訊息顯示 -->
                @if (!string.IsNullOrWhiteSpace(successMessage))
                {
                    <AlertComponent Type="AlertType.Success" 
                                  Message="@successMessage" 
                                  IconClass="fas fa-check-circle"
                                  OnDismiss="ClearSuccess" />
                }
            </div>
            
            <div class="modal-footer">
                <ButtonComponent Text="關閉" 
                               Variant="ButtonVariant.Secondary" 
                               IconClass="fas fa-times"
                               OnClick="CloseModal" />
            </div>
        </div>
    </div>
</div>

@code {
    // 必要參數
    [Parameter] public string ModalId { get; set; } = "genericModal";
    [Parameter] public string Title { get; set; } = "資料管理";
    [Parameter] public string EntityDisplayName { get; set; } = "資料";
    [Parameter] public string IconClass { get; set; } = "fas fa-cog";
    [Parameter] public string LoadingText { get; set; } = "載入資料中...";
    [Parameter] public IGenericManagementService<TEntity> Service { get; set; } = default!;
    [Parameter] public EventCallback OnDataChanged { get; set; }

    // 內容渲染委派
    [Parameter] public RenderFragment<TEntity> CreateFormContent { get; set; } = default!;
    [Parameter] public RenderFragment TableHeaders { get; set; } = default!;
    [Parameter] public RenderFragment<TEntity> TableRowContent { get; set; } = default!;

    // 實體特定委派
    [Parameter] public Func<TEntity, int> GetEntityId { get; set; } = default!;
    [Parameter] public Func<TEntity, EntityStatus> GetEntityStatus { get; set; } = default!;
    [Parameter] public Action<TEntity, string> SetCreatedBy { get; set; } = default!;
    [Parameter] public Action<TEntity, EntityStatus> SetEntityStatus { get; set; } = default!;

    private List<TEntity> entities = new();
    private TEntity newEntity = new();
    private bool isLoading = true;
    private bool isSubmitting = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadEntities();
    }    public async Task ShowModal()
    {
        // 重新載入最新資料
        await LoadEntities();
        
        // 使用自定義的 JavaScript 函數顯示模態視窗
        await JSRuntime.InvokeVoidAsync("bootstrapHelpers.showModal", ModalId);
    }

    private async Task CloseModal()
    {
        // 使用自定義的 JavaScript 函數隱藏模態視窗
        await JSRuntime.InvokeVoidAsync("bootstrapHelpers.hideModal", ModalId);
        
        // 通知父組件資料已變更
        if (OnDataChanged.HasDelegate)
        {
            await OnDataChanged.InvokeAsync();
        }
    }

    private async Task LoadEntities()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            entities = await Service.GetAllAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"載入{EntityDisplayName}時發生錯誤：{ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task CreateEntity()
    {
        try
        {
            isSubmitting = true;
            ClearMessages();
            StateHasChanged();

            // 設定預設值
            SetCreatedBy(newEntity, "系統管理員"); // 實際應用中應該從使用者身份取得
            SetEntityStatus(newEntity, EntityStatus.Active);

            var result = await Service.CreateAsync(newEntity);
            
            if (result.IsSuccess)
            {
                successMessage = $"{EntityDisplayName}新增成功！";
                newEntity = new TEntity(); // 重置表單
                await LoadEntities(); // 重新載入列表
            }
            else
            {
                errorMessage = result.ErrorMessage ?? $"新增{EntityDisplayName}失敗";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"新增{EntityDisplayName}時發生錯誤：{ex.Message}";
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private async Task ToggleEntityStatus(int entityId, EntityStatus newStatus)
    {
        try
        {
            ClearMessages();

            var result = await Service.ToggleStatusAsync(entityId, newStatus);
            
            if (result.IsSuccess)
            {
                successMessage = $"{EntityDisplayName}狀態已更新為{GetStatusText(newStatus)}";
                await LoadEntities(); // 重新載入列表
            }
            else
            {
                errorMessage = result.ErrorMessage ?? $"更新{EntityDisplayName}狀態失敗";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"更新{EntityDisplayName}狀態時發生錯誤：{ex.Message}";
        }

        StateHasChanged();
    }

    private async Task DeleteEntity(int entityId)
    {
        try
        {
            // 使用 JavaScript 確認對話框
            bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"確定要刪除此{EntityDisplayName}嗎？此操作無法復原。");
            
            if (!confirmed)
                return;

            ClearMessages();

            var result = await Service.DeleteAsync(entityId);
            
            if (result.IsSuccess)
            {
                successMessage = $"{EntityDisplayName}已刪除";
                await LoadEntities(); // 重新載入列表
            }
            else
            {
                errorMessage = result.ErrorMessage ?? $"刪除{EntityDisplayName}失敗";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"刪除{EntityDisplayName}時發生錯誤：{ex.Message}";
        }

        StateHasChanged();
    }

    private string GetStatusText(EntityStatus status)
    {
        return status switch
        {
            EntityStatus.Active => "啟用",
            EntityStatus.Inactive => "停用",
            EntityStatus.Deleted => "已刪除",
            _ => "未知"
        };
    }

    private void ClearMessages()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;
    }

    private void ClearError()
    {
        errorMessage = string.Empty;
    }

    private void ClearSuccess()
    {
        successMessage = string.Empty;
    }
}
