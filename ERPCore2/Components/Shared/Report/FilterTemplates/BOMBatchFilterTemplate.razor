@*
    物料清單報表篩選模板
    實作 IFilterTemplateComponent 介面，提供物料清單報表的篩選 UI
    設計原則：緊湊單欄式佈局，樣式由 GenericReportFilterModalComponent 統一控制
*@

@using ERPCore2.Models
@using ERPCore2.Models.Enums
@using ERPCore2.Models.Reports.FilterCriteria
@using ERPCore2.Models.Reports.FilterTemplates
@implements IFilterTemplateComponent
@inject IProductCompositionService ProductCompositionService
@inject INotificationService NotificationService

<div>
    <FilterFieldRow Label="指定成品">
        <SearchSelectFilterComponent TItem="ProductDisplayItem"
                                   Items="@availableProducts"
                                   @bind-SelectedItems="@selectedProducts"
                                   DisplayProperty="DisplayName"
                                   ValueProperty="Id"
                                   Placeholder="搜尋成品品號或品名..."
                                   EmptyMessage="未選擇成品（查詢全部）" />
    </FilterFieldRow>

    <FilterFieldRow Label="關鍵字">
        <div class="d-flex align-items-center gap-2">
            <input type="text" class="form-control" placeholder="搜尋配方編號、成品品號、成品品名..."
                   @bind="keyword" />
            <div class="form-check text-nowrap">
                <input class="form-check-input" type="checkbox" id="bomActiveOnly" @bind="activeOnly">
                <label class="form-check-label" for="bomActiveOnly">僅啟用</label>
            </div>
        </div>
    </FilterFieldRow>
</div>

@code {
    // ===== 內部狀態 =====

    private List<ProductDisplayItem> availableProducts = new();
    private List<ProductDisplayItem> selectedProducts = new();
    private string? keyword = null;
    private bool activeOnly = true;

    // ===== 生命週期方法 =====

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            // 從現有物料清單中取得不重複的成品清單
            var compositions = await ProductCompositionService.GetAllAsync();
            availableProducts = compositions
                .Where(c => c.ParentProduct != null)
                .Select(c => new ProductDisplayItem
                {
                    Id = c.ParentProductId,
                    DisplayName = $"{c.ParentProduct!.Code} - {c.ParentProduct.Name}"
                })
                .GroupBy(p => p.Id)
                .Select(g => g.First())
                .OrderBy(p => p.DisplayName)
                .ToList();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDataAsync), GetType());
            await NotificationService.ShowErrorAsync("載入物料清單資料失敗");
            availableProducts = new List<ProductDisplayItem>();
        }
    }

    // ===== IFilterTemplateComponent 實作 =====

    public IReportFilterCriteria GetCriteria()
    {
        return new BOMReportCriteria
        {
            ParentProductIds = selectedProducts.Select(p => p.Id).ToList(),
            Keyword = keyword,
            ActiveOnly = activeOnly
        };
    }

    public void Reset()
    {
        selectedProducts = new();
        keyword = null;
        activeOnly = true;
        StateHasChanged();
    }

    // ===== 內部模型 =====

    /// <summary>
    /// 成品顯示項目（用於 MultiSelect）
    /// </summary>
    private class ProductDisplayItem
    {
        public int Id { get; set; }
        public string DisplayName { get; set; } = "";
    }
}
