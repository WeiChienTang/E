@*
    員工名冊表篩選模板
    實作 IFilterTemplateComponent 介面，提供員工名冊表的篩選 UI
    設計原則：使用 FilterSectionGroup + FilterSectionColumn 三欄佈局
*@

@using ERPCore2.Models
@using ERPCore2.Models.Reports.FilterCriteria
@using ERPCore2.Models.Reports.FilterTemplates
@using ERPCore2.Data.Entities
@implements IFilterTemplateComponent
@inject IEmployeeService EmployeeService
@inject IDepartmentService DepartmentService
@inject IEmployeePositionService EmployeePositionService
@inject IRoleService RoleService
@inject INotificationService NotificationService

<FilterSectionGroup>

    @* ===== 欄 1：人員基本篩選 ===== *@
    <FilterSectionColumn Title="基本篩選" Icon="bi bi-people">
        <FilterFieldRow Label="指定員工">
            <SearchSelectFilterComponent TItem="DisplayItem"
                                         Items="@availableEmployees"
                                         @bind-SelectedItems="@selectedEmployees"
                                         DisplayProperty="DisplayName"
                                         ValueProperty="Id"
                                         Placeholder="搜尋員工編號或姓名..."
                                         EmptyMessage="未選擇員工（查詢全部）" />
        </FilterFieldRow>

        <FilterFieldRow Label="部門">
            <SearchSelectFilterComponent TItem="DisplayItem"
                                         Items="@availableDepartments"
                                         @bind-SelectedItems="@selectedDepartments"
                                         DisplayProperty="DisplayName"
                                         ValueProperty="Id"
                                         Placeholder="搜尋部門..."
                                         EmptyMessage="未選擇部門（查詢全部）" />
        </FilterFieldRow>

        <FilterFieldRow Label="職位">
            <SearchSelectFilterComponent TItem="DisplayItem"
                                         Items="@availablePositions"
                                         @bind-SelectedItems="@selectedPositions"
                                         DisplayProperty="DisplayName"
                                         ValueProperty="Id"
                                         Placeholder="搜尋職位..."
                                         EmptyMessage="未選擇職位（查詢全部）" />
        </FilterFieldRow>

        <FilterFieldRow Label="在職狀態">
            <SearchSelectFilterComponent TItem="DisplayItem"
                                         Items="@availableStatuses"
                                         @bind-SelectedItems="@selectedStatuses"
                                         DisplayProperty="DisplayName"
                                         ValueProperty="Id"
                                         Placeholder="搜尋狀態..."
                                         EmptyMessage="未選擇狀態（查詢全部）" />
        </FilterFieldRow>

        <FilterFieldRow Label="權限組">
            <SearchSelectFilterComponent TItem="DisplayItem"
                                         Items="@availableRoles"
                                         @bind-SelectedItems="@selectedRoles"
                                         DisplayProperty="DisplayName"
                                         ValueProperty="Id"
                                         Placeholder="搜尋權限組..."
                                         EmptyMessage="未選擇權限組（查詢全部）" />
        </FilterFieldRow>
    </FilterSectionColumn>

    @* ===== 欄 2：日期範圍篩選 ===== *@
    <FilterSectionColumn Title="日期範圍" Icon="bi bi-calendar-range">
        <FilterFieldRow Label="到職日期">
            <DateRangeFilterComponent @bind-StartDate="hireDateStart"
                                       @bind-EndDate="hireDateEnd"
                                       StartDateLabel="起始"
                                       EndDateLabel="結束"
                                       ShowQuickSelectors="true"
                                       AutoValidate="true"
                                       ShowValidationMessage="true" />
        </FilterFieldRow>

        <FilterFieldRow Label="離職日期">
            <DateRangeFilterComponent @bind-StartDate="resignationDateStart"
                                       @bind-EndDate="resignationDateEnd"
                                       StartDateLabel="起始"
                                       EndDateLabel="結束"
                                       ShowQuickSelectors="true"
                                       AutoValidate="true"
                                       ShowValidationMessage="true" />
        </FilterFieldRow>

        <FilterFieldRow Label="生日">
            <DateRangeFilterComponent @bind-StartDate="birthDateStart"
                                       @bind-EndDate="birthDateEnd"
                                       StartDateLabel="起始"
                                       EndDateLabel="結束"
                                       ShowQuickSelectors="true"
                                       AutoValidate="true"
                                       ShowValidationMessage="true" />
        </FilterFieldRow>
    </FilterSectionColumn>

    @* ===== 欄 3：快速條件 ===== *@
    <FilterSectionColumn Title="快速條件" Icon="bi bi-search">
        <FilterFieldRow Label="關鍵字">
            <input type="text" class="form-control" placeholder="搜尋員工編號、姓名..."
                   @bind="keyword" />
        </FilterFieldRow>

        <FilterFieldRow Label="在職篩選">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="empActiveOnly" @bind="activeOnly">
                <label class="form-check-label" for="empActiveOnly">僅顯示在職員工</label>
            </div>
        </FilterFieldRow>
    </FilterSectionColumn>

</FilterSectionGroup>

@code {
    // ===== 內部狀態 =====

    private List<DisplayItem> availableEmployees = new();
    private List<DisplayItem> selectedEmployees = new();
    private List<DisplayItem> availableDepartments = new();
    private List<DisplayItem> selectedDepartments = new();
    private List<DisplayItem> availablePositions = new();
    private List<DisplayItem> selectedPositions = new();
    private List<DisplayItem> availableStatuses = new();
    private List<DisplayItem> selectedStatuses = new();
    private List<DisplayItem> availableRoles = new();
    private List<DisplayItem> selectedRoles = new();
    private DateTime? hireDateStart;
    private DateTime? hireDateEnd;
    private DateTime? resignationDateStart;
    private DateTime? resignationDateEnd;
    private DateTime? birthDateStart;
    private DateTime? birthDateEnd;
    private string? keyword = null;
    private bool activeOnly = true;

    // ===== 生命週期方法 =====

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            var employeesTask = EmployeeService.GetAllAsync();
            var departmentsTask = DepartmentService.GetAllAsync();
            var positionsTask = EmployeePositionService.GetAllAsync();
            var rolesTask = RoleService.GetAllAsync();
            await Task.WhenAll(employeesTask, departmentsTask, positionsTask, rolesTask);

            var allEmployees = await employeesTask;
            availableEmployees = allEmployees
                .Where(e => !e.IsSuperAdmin)
                .Select(e => new DisplayItem
                {
                    Id = e.Id,
                    DisplayName = !string.IsNullOrEmpty(e.Name)
                        ? $"{e.Code} - {e.Name}"
                        : e.Code ?? $"員工{e.Id}"
                })
                .OrderBy(e => e.DisplayName)
                .ToList();

            var allDepartments = await departmentsTask;
            availableDepartments = allDepartments
                .Where(d => d.Status == EntityStatus.Active)
                .Select(d => new DisplayItem
                {
                    Id = d.Id,
                    DisplayName = !string.IsNullOrEmpty(d.Name) ? d.Name : d.Code ?? $"部門{d.Id}"
                })
                .OrderBy(d => d.DisplayName)
                .ToList();

            var allPositions = await positionsTask;
            availablePositions = allPositions
                .Where(p => p.Status == EntityStatus.Active)
                .Select(p => new DisplayItem
                {
                    Id = p.Id,
                    DisplayName = !string.IsNullOrEmpty(p.Name) ? p.Name : p.Code ?? $"職位{p.Id}"
                })
                .OrderBy(p => p.DisplayName)
                .ToList();

            var allRoles = await rolesTask;
            availableRoles = allRoles
                .Where(r => r.Status == EntityStatus.Active)
                .Select(r => new DisplayItem
                {
                    Id = r.Id,
                    DisplayName = !string.IsNullOrEmpty(r.Name) ? r.Name : r.Code ?? $"權限組{r.Id}"
                })
                .OrderBy(r => r.DisplayName)
                .ToList();

            availableStatuses = new List<DisplayItem>
            {
                new() { Id = (int)EmployeeStatus.Probation, DisplayName = "試用期" },
                new() { Id = (int)EmployeeStatus.Active, DisplayName = "在職" },
                new() { Id = (int)EmployeeStatus.LeaveOfAbsence, DisplayName = "留職停薪" },
                new() { Id = (int)EmployeeStatus.Resigned, DisplayName = "已離職" },
                new() { Id = (int)EmployeeStatus.Inactive, DisplayName = "停用" }
            };
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDataAsync), GetType());
            await NotificationService.ShowErrorAsync("載入篩選資料失敗");
        }
    }

    // ===== IFilterTemplateComponent 實作 =====

    public IReportFilterCriteria GetCriteria()
    {
        return new EmployeeRosterCriteria
        {
            EmployeeIds = selectedEmployees.Select(e => e.Id).ToList(),
            DepartmentIds = selectedDepartments.Select(d => d.Id).ToList(),
            PositionIds = selectedPositions.Select(p => p.Id).ToList(),
            EmploymentStatuses = selectedStatuses.Select(s => (EmployeeStatus)s.Id).ToList(),
            RoleIds = selectedRoles.Select(r => r.Id).ToList(),
            HireDateStart = hireDateStart,
            HireDateEnd = hireDateEnd,
            ResignationDateStart = resignationDateStart,
            ResignationDateEnd = resignationDateEnd,
            BirthDateStart = birthDateStart,
            BirthDateEnd = birthDateEnd,
            Keyword = keyword,
            ActiveOnly = activeOnly
        };
    }

    public void Reset()
    {
        selectedEmployees = new();
        selectedDepartments = new();
        selectedPositions = new();
        selectedStatuses = new();
        selectedRoles = new();
        hireDateStart = null;
        hireDateEnd = null;
        resignationDateStart = null;
        resignationDateEnd = null;
        birthDateStart = null;
        birthDateEnd = null;
        keyword = null;
        activeOnly = true;
        StateHasChanged();
    }

    // ===== 內部模型 =====

    private class DisplayItem
    {
        public int Id { get; set; }
        public string DisplayName { get; set; } = "";
    }
}
