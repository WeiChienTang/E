@* 
    é€šç”¨å ±è¡¨ç¯©é¸ Modal
    æ ¹æ“š ReportId å‹•æ…‹è¼‰å…¥å°æ‡‰çš„ç¯©é¸æ¨¡æ¿ï¼Œç¢ºèªå¾Œå¯ç›´æ¥å‘¼å«å ±è¡¨æœå‹™ç”¢ç”Ÿå ±è¡¨
*@

@using ERPCore2.Models.Reports
@using ERPCore2.Models.Reports.FilterCriteria
@using ERPCore2.Models.Reports.FilterTemplates
@using ERPCore2.Services.Reports.Interfaces
@using ERPCore2.Data.Entities
@inject INotificationService NotificationService
@inject IServiceProvider ServiceProvider

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@HandleVisibilityChanged"
                   Title="@GetTitle()"
                   Icon="@GetIcon()"
                   Size="BaseModalComponent.ModalSize.Desktop"
                   HeaderColor="BaseModalComponent.HeaderVariant.ProjectPrimary"
                   UseWhiteCloseButton="true"
                   BodyCssClass="p-4"
                   IsLoading="@isLoading"
                   LoadingMessage="@loadingMessage"
                   OnClose="@HandleCancel">
    
    <HeaderButtons>
        <div class="d-flex gap-2">
            <GenericButtonComponent Variant="ButtonVariant.Green" 
                                  Size="ButtonSize.Small"
                                  Text="é è¦½åˆ—å°" 
                                  OnClick="HandleConfirmAsync"
                                  IsDisabled="@isLoading"
                                  Title="ç¢ºèªç¯©é¸æ¢ä»¶ä¸¦é è¦½å ±è¡¨" />
            <GenericButtonComponent Variant="ButtonVariant.Red" 
                                  Size="ButtonSize.Small"
                                  Text="å–æ¶ˆ" 
                                  OnClick="HandleCancel"
                                  IsDisabled="@isLoading"
                                  Title="å–æ¶ˆä¸¦é—œé–‰" />
        </div>
    </HeaderButtons>
    
    <BodyContent>
        @if (filterConfig == null)
        {
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                æ‰¾ä¸åˆ°å ±è¡¨ IDã€Œ@ReportIdã€çš„ç¯©é¸é…ç½®
            </div>
        }
        else if (filterConfig.GetFilterTemplateType() != typeof(object))
        {
            <DynamicComponent Type="@filterConfig.GetFilterTemplateType()" 
                             @ref="dynamicComponentRef"
                             Parameters="@GetTemplateParameters()" />
        }
        else
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                æ­¤å ±è¡¨å°šæœªé…ç½®ç¯©é¸æ¨¡æ¿
            </div>
        }
    </BodyContent>
    
</BaseModalComponent>

@* å ±è¡¨é è¦½ Modal *@
<ReportPreviewModalComponent @ref="reportPreviewModal"
                            IsVisible="@showPreview"
                            IsVisibleChanged="@((bool v) => showPreview = v)"
                            Title="@(filterConfig?.PreviewTitle ?? "å ±è¡¨é è¦½")"
                            PreviewImages="@previewImages"
                            FormattedDocument="@formattedDocument"
                            ReportId="@savedReportId"
                            DocumentName="@documentName"
                            OnPrintSuccess="@HandlePrintSuccess"
                            OnCancel="@HandlePreviewCancel"
                            OnPaperSettingChanged="@HandlePaperSettingChanged" />

@code {
    // ===== åƒæ•¸å®šç¾© =====
    
    /// <summary>
    /// Modal æ˜¯å¦é¡¯ç¤º
    /// </summary>
    [Parameter]
    public bool IsVisible { get; set; }
    
    /// <summary>
    /// Modal é¡¯ç¤ºç‹€æ…‹è®Šæ›´äº‹ä»¶
    /// </summary>
    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }
    
    /// <summary>
    /// å ±è¡¨è­˜åˆ¥ç¢¼ï¼ˆå°æ‡‰ FilterTemplateRegistry ä¸­çš„é…ç½®ï¼‰
    /// </summary>
    [Parameter]
    public string ReportId { get; set; } = string.Empty;
    
    /// <summary>
    /// åˆ—å°æˆåŠŸäº‹ä»¶
    /// </summary>
    [Parameter]
    public EventCallback OnPrintSuccess { get; set; }
    
    /// <summary>
    /// å–æ¶ˆäº‹ä»¶
    /// </summary>
    [Parameter]
    public EventCallback OnCancel { get; set; }
    
    // ===== ç§æœ‰æ¬„ä½ =====
    
    private ReportFilterConfig? filterConfig;
    private DynamicComponent? dynamicComponentRef;
    private ReportPreviewModalComponent? reportPreviewModal;
    
    private bool isLoading = false;
    private string loadingMessage = "è™•ç†ä¸­...";
    private bool showPreview = false;
    
    private List<byte[]>? previewImages;
    private FormattedDocument? formattedDocument;
    private string documentName = "";
    
    // ä¿å­˜ ReportId çš„æœ¬åœ°å‰¯æœ¬ï¼Œé¿å…é—œé–‰ç¯©é¸ Modal æ™‚åƒæ•¸è¢«å¤–éƒ¨æ¸…ç©º
    private string savedReportId = string.Empty;
    
    // ä¿å­˜ç•¶å‰çš„å ±è¡¨æœå‹™å’Œç¯©é¸æ¢ä»¶ï¼Œç”¨æ–¼ç´™å¼µè®Šæ›´æ™‚é‡æ–°ç”¢ç”Ÿé è¦½
    private object? currentReportService;
    private BatchPrintCriteria? currentBatchCriteria;
    
    // ===== ç”Ÿå‘½é€±æœŸæ–¹æ³• =====
    
    protected override void OnParametersSet()
    {
        if (IsVisible && !string.IsNullOrEmpty(ReportId))
        {
            // ä¿å­˜ ReportId çš„æœ¬åœ°å‰¯æœ¬ï¼Œé¿å…é—œé–‰ç¯©é¸ Modal æ™‚åƒæ•¸è¢«å¤–éƒ¨æ¸…ç©º
            savedReportId = ReportId;
            LoadFilterConfig();
        }
    }
    
    // ===== ç§æœ‰æ–¹æ³• =====
    
    private void LoadFilterConfig()
    {
        filterConfig = FilterTemplateRegistry.GetConfig(ReportId);
        if (filterConfig == null)
        {
            // å˜—è©¦å»ºç«‹é è¨­é…ç½®ï¼ˆç”¨æ–¼å°šæœªè¨»å†Šçš„å ±è¡¨ï¼‰
            var reportDef = Data.ReportRegistry.GetReportById(ReportId);
            if (reportDef != null)
            {
                filterConfig = new ReportFilterConfig
                {
                    ReportId = ReportId,
                    FilterTitle = $"{reportDef.Name}ç¯©é¸æ¢ä»¶",
                    PreviewTitle = $"{reportDef.Name}é è¦½",
                    IconClass = reportDef.IconClass
                };
            }
        }
    }
    
    private string GetTitle()
    {
        return filterConfig?.FilterTitle ?? "å ±è¡¨ç¯©é¸æ¢ä»¶";
    }
    
    private string GetIcon()
    {
        return filterConfig?.IconClass ?? "bi-funnel";
    }
    
    private Dictionary<string, object> GetTemplateParameters()
    {
        return new Dictionary<string, object>
        {
            // æ¨¡æ¿å¯èƒ½éœ€è¦çš„åƒæ•¸å¯ä»¥åœ¨é€™è£¡å‚³é
        };
    }
    
    // ===== äº‹ä»¶è™•ç†æ–¹æ³• =====
    
    private async Task HandleVisibilityChanged(bool visible)
    {
        if (!visible)
        {
            // æ¸…ç†ç‹€æ…‹
            previewImages = null;
            formattedDocument = null;
        }
        
        await IsVisibleChanged.InvokeAsync(visible);
    }
    
    private async Task HandleConfirmAsync()
    {
        try
        {
            // å–å¾—ç¯©é¸æ¢ä»¶
            IReportFilterCriteria criteria;
            
            // å¾ DynamicComponent å–å¾—æ¨¡æ¿å¯¦ä¾‹
            var templateInstance = dynamicComponentRef?.Instance;
            
            if (templateInstance is IFilterTemplateComponent templateComponent)
            {
                criteria = templateComponent.GetCriteria();
            }
            else
            {
                // ä½¿ç”¨é è¨­ç©ºç¯©é¸æ¢ä»¶
                criteria = filterConfig?.CreateDefaultCriteria() ?? new EmptyFilterCriteria();
            }
            
            // é©—è­‰ç¯©é¸æ¢ä»¶
            if (!criteria.Validate(out var errorMessage))
            {
                await NotificationService.ShowWarningAsync(errorMessage!);
                return;
            }
            
            isLoading = true;
            loadingMessage = "æ­£åœ¨ç”¢ç”Ÿå ±è¡¨...";
            StateHasChanged();
            
            // ç”¢ç”Ÿæ–‡ä»¶åç¨±
            documentName = filterConfig?.GetDocumentName?.Invoke(criteria) 
                          ?? $"å ±è¡¨-{DateTime.Now:yyyyMMddHHmmss}";
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å°æ‡‰çš„å ±è¡¨æœå‹™
            if (filterConfig?.ReportServiceType != null)
            {
                // å‹•æ…‹å–å¾—å ±è¡¨æœå‹™
                var reportService = ServiceProvider.GetService(filterConfig.ReportServiceType);
                
                if (reportService == null)
                {
                    await NotificationService.ShowErrorAsync($"ç„¡æ³•å–å¾—å ±è¡¨æœå‹™ï¼š{filterConfig.ReportServiceType.Name}");
                    return;
                }
                
                // è½‰æ›ç¯©é¸æ¢ä»¶ç‚º BatchPrintCriteria
                BatchPrintCriteria batchCriteria;
                
                // å˜—è©¦ä½¿ç”¨ ToBatchPrintCriteria æ–¹æ³•è½‰æ›
                var toBatchMethod = criteria.GetType().GetMethod("ToBatchPrintCriteria");
                if (toBatchMethod != null)
                {
                    batchCriteria = (BatchPrintCriteria)toBatchMethod.Invoke(criteria, null)!;
                }
                else
                {
                    // ä½¿ç”¨é è¨­è½‰æ›
                    batchCriteria = ConvertToBatchCriteria(criteria);
                }
                
                // å‘¼å«æ‰¹æ¬¡é è¦½æ–¹æ³•
                var renderMethod = reportService.GetType().GetMethod("RenderBatchToImagesAsync");
                if (renderMethod != null)
                {
                    loadingMessage = "æ­£åœ¨ç”¢ç”Ÿé è¦½åœ–ç‰‡...";
                    StateHasChanged();
                    
                    var task = (Task<BatchPreviewResult>)renderMethod.Invoke(reportService, new object[] { batchCriteria })!;
                    var result = await task;
                    
                    if (!result.IsSuccess)
                    {
                        await NotificationService.ShowWarningAsync(result.ErrorMessage ?? "ç”¢ç”Ÿé è¦½å¤±æ•—");
                        return;
                    }
                    
                    // è¨­å®šé è¦½è³‡æ–™
                    previewImages = result.PreviewImages;
                    formattedDocument = result.MergedDocument;
                    
                    // ä¿å­˜å ±è¡¨æœå‹™å’Œç¯©é¸æ¢ä»¶ï¼Œç”¨æ–¼ç´™å¼µè®Šæ›´æ™‚é‡æ–°ç”¢ç”Ÿé è¦½
                    currentReportService = reportService;
                    currentBatchCriteria = batchCriteria;
                    
                    // é—œé–‰ç¯©é¸ Modalï¼Œé–‹å•Ÿé è¦½ Modal
                    await IsVisibleChanged.InvokeAsync(false);
                    showPreview = true;
                    
                    await NotificationService.ShowSuccessAsync($"å·²ç”¢ç”Ÿ {result.DocumentCount} ç­†å–®æ“šçš„é è¦½ï¼Œå…± {result.TotalPages} é ");
                }
                else
                {
                    await NotificationService.ShowWarningAsync($"å ±è¡¨æœå‹™ {filterConfig.ReportServiceType.Name} å°šæœªå¯¦ä½œæ‰¹æ¬¡é è¦½æ–¹æ³•");
                }
            }
            else
            {
                // å°šç„¡æœå‹™ï¼Œé¡¯ç¤ºç¯©é¸çµæœ
                await NotificationService.ShowInfoAsync(
                    $"ğŸ“Š ç¯©é¸æ¢ä»¶ï¼š\n" +
                    $"{System.Text.Json.JsonSerializer.Serialize(criteria.ToQueryParameters(), new System.Text.Json.JsonSerializerOptions { WriteIndented = true })}\n\n" +
                    $"ï¼ˆå ±è¡¨æœå‹™å°šæœªé…ç½®ï¼‰");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleConfirmAsync), GetType());
            await NotificationService.ShowErrorAsync($"ç”¢ç”Ÿå ±è¡¨å¤±æ•—ï¼š{ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task HandleCancel()
    {
        await IsVisibleChanged.InvokeAsync(false);
        
        if (OnCancel.HasDelegate)
        {
            await OnCancel.InvokeAsync();
        }
    }
    
    private async Task HandlePrintSuccess()
    {
        showPreview = false;
        await IsVisibleChanged.InvokeAsync(false);
        
        if (OnPrintSuccess.HasDelegate)
        {
            await OnPrintSuccess.InvokeAsync();
        }
    }
    
    private void HandlePreviewCancel()
    {
        showPreview = false;
        // ä¿æŒç¯©é¸ Modal é–‹å•Ÿï¼Œè®“ä½¿ç”¨è€…å¯ä»¥ä¿®æ”¹æ¢ä»¶
    }
    
    /// <summary>
    /// è™•ç†ç´™å¼µè¨­å®šè®Šæ›´äº‹ä»¶
    /// ç•¶ä½¿ç”¨è€…åœ¨é è¦½ Modal ä¸­è®Šæ›´ç´™å¼µæ™‚ï¼Œé‡æ–°æ¸²æŸ“é è¦½åœ–ç‰‡
    /// </summary>
    private async Task HandlePaperSettingChanged(PaperSetting paperSetting)
    {
        try
        {
            if (currentReportService == null || currentBatchCriteria == null) return;
            
            isLoading = true;
            loadingMessage = "æ­£åœ¨æ›´æ–°é è¦½...";
            StateHasChanged();
            
            // æ›´æ–°æ‰¹æ¬¡ç¯©é¸æ¢ä»¶çš„ç´™å¼µè¨­å®š
            currentBatchCriteria.PaperSetting = paperSetting;
            
            // æ›´æ–° FormattedDocument çš„ç´™å¼µå°ºå¯¸
            if (formattedDocument != null)
            {
                formattedDocument.PageSettings.PageWidth = (float)paperSetting.Width;
                formattedDocument.PageSettings.PageHeight = (float)paperSetting.Height;
                formattedDocument.PageSettings.LeftMargin = (float)(paperSetting.LeftMargin ?? 1.0m);
                formattedDocument.PageSettings.TopMargin = (float)(paperSetting.TopMargin ?? 1.0m);
                formattedDocument.PageSettings.RightMargin = (float)(paperSetting.RightMargin ?? 1.0m);
                formattedDocument.PageSettings.BottomMargin = (float)(paperSetting.BottomMargin ?? 1.0m);
            }
            
            // å‘¼å«æ‰¹æ¬¡é è¦½æ–¹æ³•ï¼ˆä½¿ç”¨æ–°çš„ç´™å¼µè¨­å®šï¼‰
            var renderMethod = currentReportService.GetType().GetMethod("RenderBatchToImagesAsync");
            if (renderMethod != null)
            {
                var task = (Task<BatchPreviewResult>)renderMethod.Invoke(currentReportService, new object[] { currentBatchCriteria })!;
                var result = await task;
                
                if (result.IsSuccess)
                {
                    previewImages = result.PreviewImages;
                    formattedDocument = result.MergedDocument;
                }
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æ›´æ–°é è¦½æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// å°‡ IReportFilterCriteria è½‰æ›ç‚º BatchPrintCriteriaï¼ˆé è¨­å¯¦ä½œï¼‰
    /// </summary>
    private BatchPrintCriteria ConvertToBatchCriteria(IReportFilterCriteria criteria)
    {
        var batchCriteria = new BatchPrintCriteria();
        var queryParams = criteria.ToQueryParameters();
        
        // å˜—è©¦å¾æŸ¥è©¢åƒæ•¸ä¸­å–å¾—å¸¸ç”¨æ¬„ä½
        if (queryParams.TryGetValue("startDate", out var startDate) && startDate is DateTime start)
        {
            batchCriteria.StartDate = start;
        }
        
        if (queryParams.TryGetValue("endDate", out var endDate) && endDate is DateTime end)
        {
            batchCriteria.EndDate = end;
        }
        
        if (queryParams.TryGetValue("supplierIds", out var supplierIds) && supplierIds is List<int> ids)
        {
            batchCriteria.RelatedEntityIds = ids;
        }
        
        if (queryParams.TryGetValue("maxResults", out var maxResults) && maxResults is int max)
        {
            batchCriteria.MaxResults = max;
        }
        
        return batchCriteria;
    }
}
