@* 
    é€šç”¨å ±è¡¨ç¯©é¸ Modal
    æ ¹æ“š ReportId å‹•æ…‹è¼‰å…¥å°æ‡‰çš„ç¯©é¸æ¨¡æ¿ï¼Œç¢ºèªå¾Œå¯ç›´æ¥å‘¼å«å ±è¡¨æœå‹™ç”¢ç”Ÿå ±è¡¨
*@

@using ERPCore2.Models.Reports
@using ERPCore2.Models.Reports.FilterCriteria
@using ERPCore2.Models.Reports.FilterTemplates
@using ERPCore2.Services.Reports.Interfaces
@using ERPCore2.Data.Entities
@using ERPCore2.Components.Shared.Report.FilterTemplates
@inject INotificationService NotificationService
@inject IServiceProvider ServiceProvider

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@HandleVisibilityChanged"
                   Title="@GetTitle()"
                   Icon="@GetIcon()"
                   Size="BaseModalComponent.ModalSize.Desktop"
                   HeaderColor="BaseModalComponent.HeaderVariant.ProjectPrimary"
                   UseWhiteCloseButton="true"
                   BodyCssClass="p-4"
                   OnClose="@HandleCancel">
    
    <HeaderButtons>
        <div class="d-flex gap-2">
            <GenericButtonComponent Variant="ButtonVariant.Green" 
                                  Size="ButtonSize.Small"
                                  Text="é è¦½åˆ—å°" 
                                  OnClick="HandleConfirmAsync"
                                  IsDisabled="@isLoading"
                                  Title="ç¢ºèªç¯©é¸æ¢ä»¶ä¸¦é è¦½å ±è¡¨" />
            <GenericButtonComponent Variant="ButtonVariant.Red" 
                                  Size="ButtonSize.Small"
                                  Text="å–æ¶ˆ" 
                                  OnClick="HandleCancel"
                                  IsDisabled="@isLoading"
                                  Title="å–æ¶ˆä¸¦é—œé–‰" />
        </div>
    </HeaderButtons>
    
    <BodyContent>
        <div class="filter-body-wrapper">
            @if (filterConfig == null)
            {
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    æ‰¾ä¸åˆ°å ±è¡¨ IDã€Œ@ReportIdã€çš„ç¯©é¸é…ç½®
                </div>
            }
            else if (filterConfig.GetFilterTemplateType() != typeof(object))
            {
                <DynamicComponent Type="@filterConfig.GetFilterTemplateType()"
                                 @ref="dynamicComponentRef"
                                 Parameters="@GetTemplateParameters()" />
            }
            else
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    æ­¤å ±è¡¨å°šæœªé…ç½®ç¯©é¸æ¨¡æ¿
                </div>
            }

            @* é è¦½ç”¢ç”Ÿé€²åº¦æ¢ Overlay *@
            @if (_showPreviewProgress)
            {
                <div class="filter-progress-overlay">
                    <div class="filter-progress-card">
                        <div class="filter-progress-message">@_previewProgressMessage</div>
                        <div class="progress filter-progress-bar" role="progressbar"
                             aria-valuenow="@_previewProgressValue" aria-valuemin="0" aria-valuemax="100">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                 style="width: @(_previewProgressValue)%">
                                @_previewProgressValue%
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </BodyContent>
    
</BaseModalComponent>

@* å ±è¡¨é è¦½ Modal *@
<ReportPreviewModalComponent @ref="reportPreviewModal"
                            IsVisible="@showPreview"
                            IsVisibleChanged="@((bool v) => showPreview = v)"
                            Title="@(filterConfig?.PreviewTitle ?? "å ±è¡¨é è¦½")"
                            PreviewImages="@previewImages"
                            FormattedDocument="@formattedDocument"
                            ReportId="@savedReportId"
                            DocumentName="@documentName"
                            OnPrintSuccess="@HandlePrintSuccess"
                            OnCancel="@HandlePreviewCancel"
                            OnPaperSettingChanged="@HandlePaperSettingChanged" />

@code {
    // ===== åƒæ•¸å®šç¾© =====
    
    /// <summary>
    /// Modal æ˜¯å¦é¡¯ç¤º
    /// </summary>
    [Parameter]
    public bool IsVisible { get; set; }
    
    /// <summary>
    /// Modal é¡¯ç¤ºç‹€æ…‹è®Šæ›´äº‹ä»¶
    /// </summary>
    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }
    
    /// <summary>
    /// å ±è¡¨è­˜åˆ¥ç¢¼ï¼ˆå°æ‡‰ FilterTemplateRegistry ä¸­çš„é…ç½®ï¼‰
    /// </summary>
    [Parameter]
    public string ReportId { get; set; } = string.Empty;
    
    /// <summary>
    /// åˆ—å°æˆåŠŸäº‹ä»¶
    /// </summary>
    [Parameter]
    public EventCallback OnPrintSuccess { get; set; }
    
    /// <summary>
    /// å–æ¶ˆäº‹ä»¶
    /// </summary>
    [Parameter]
    public EventCallback OnCancel { get; set; }
    
    // ===== ç§æœ‰æ¬„ä½ =====
    
    private ReportFilterConfig? filterConfig;
    private DynamicComponent? dynamicComponentRef;
    private ReportPreviewModalComponent? reportPreviewModal;
    
    private bool isLoading = false;
    private bool showPreview = false;

    // é è¦½ç”¢ç”Ÿé€²åº¦æ¢
    private bool _showPreviewProgress = false;
    private int _previewProgressValue = 0;
    private string _previewProgressMessage = "";
    
    private List<byte[]>? previewImages;
    private FormattedDocument? formattedDocument;
    private string documentName = "";
    
    // ä¿å­˜ ReportId çš„æœ¬åœ°å‰¯æœ¬ï¼Œé¿å…é—œé–‰ç¯©é¸ Modal æ™‚åƒæ•¸è¢«å¤–éƒ¨æ¸…ç©º
    private string savedReportId = string.Empty;
    
    // ä¿å­˜ç•¶å‰çš„å ±è¡¨æœå‹™å’Œç¯©é¸æ¢ä»¶ï¼Œç”¨æ–¼ç´™å¼µè®Šæ›´æ™‚é‡æ–°ç”¢ç”Ÿé è¦½
    private object? currentReportService;
    private BatchPrintCriteria? currentBatchCriteria;
    private IReportFilterCriteria? currentTypedCriteria; // å…·é«”é¡å‹çš„ Criteriaï¼ˆç”¨æ–¼æ¢ç¢¼ç­‰ç‰¹æ®Šå ±è¡¨ï¼‰
    
    // ===== ç”Ÿå‘½é€±æœŸæ–¹æ³• =====
    
    protected override void OnParametersSet()
    {
        if (IsVisible && !string.IsNullOrEmpty(ReportId))
        {
            // ä¿å­˜ ReportId çš„æœ¬åœ°å‰¯æœ¬ï¼Œé¿å…é—œé–‰ç¯©é¸ Modal æ™‚åƒæ•¸è¢«å¤–éƒ¨æ¸…ç©º
            savedReportId = ReportId;
            LoadFilterConfig();
        }
    }
    
    // ===== ç§æœ‰æ–¹æ³• =====
    
    private void LoadFilterConfig()
    {
        filterConfig = FilterTemplateRegistry.GetConfig(ReportId);
        if (filterConfig == null)
        {
            // å˜—è©¦å»ºç«‹é è¨­é…ç½®ï¼ˆç”¨æ–¼å°šæœªè¨»å†Šçš„å ±è¡¨ï¼‰
            var reportDef = Data.ReportRegistry.GetReportById(ReportId);
            if (reportDef != null)
            {
                filterConfig = new ReportFilterConfig
                {
                    ReportId = ReportId,
                    FilterTitle = $"{reportDef.Name}ç¯©é¸æ¢ä»¶",
                    PreviewTitle = $"{reportDef.Name}é è¦½",
                    IconClass = reportDef.IconClass
                };
            }
        }
    }
    
    private string GetTitle()
    {
        return filterConfig?.FilterTitle ?? "å ±è¡¨ç¯©é¸æ¢ä»¶";
    }
    
    private string GetIcon()
    {
        return filterConfig?.IconClass ?? "bi-funnel";
    }
    
    private Dictionary<string, object> GetTemplateParameters()
    {
        var parameters = new Dictionary<string, object>();

        // DynamicFilterTemplate éœ€è¦çŸ¥é“è¦ç”¢ç”Ÿå“ªå€‹ Criteria çš„ UI
        if (filterConfig != null &&
            filterConfig.GetFilterTemplateType() == typeof(DynamicFilterTemplate))
        {
            parameters["CriteriaType"] = filterConfig.CriteriaType;
        }

        return parameters;
    }
    
    // ===== é è¦½é€²åº¦æ¢ =====

    private async Task SetPreviewProgress(int value, string message)
    {
        _previewProgressValue = value;
        _previewProgressMessage = message;
        StateHasChanged();
        await Task.Delay(10);
    }

    // ===== äº‹ä»¶è™•ç†æ–¹æ³• =====

    private async Task HandleVisibilityChanged(bool visible)
    {
        if (!visible)
        {
            // æ¸…ç†ç‹€æ…‹
            previewImages = null;
            formattedDocument = null;
        }
        
        await IsVisibleChanged.InvokeAsync(visible);
    }
    
    private async Task HandleConfirmAsync()
    {
        try
        {
            // å–å¾—ç¯©é¸æ¢ä»¶
            IReportFilterCriteria criteria;
            
            // å¾ DynamicComponent å–å¾—æ¨¡æ¿å¯¦ä¾‹
            var templateInstance = dynamicComponentRef?.Instance;
            
            if (templateInstance is IFilterTemplateComponent templateComponent)
            {
                criteria = templateComponent.GetCriteria();
            }
            else
            {
                // ä½¿ç”¨é è¨­ç©ºç¯©é¸æ¢ä»¶
                criteria = filterConfig?.CreateDefaultCriteria() ?? new EmptyFilterCriteria();
            }
            
            // é©—è­‰ç¯©é¸æ¢ä»¶
            if (!criteria.Validate(out var errorMessage))
            {
                await NotificationService.ShowWarningAsync(errorMessage!);
                return;
            }
            
            isLoading = true;
            _showPreviewProgress = true;
            await SetPreviewProgress(10, "æ­£åœ¨æº–å‚™ç¯©é¸æ¢ä»¶...");

            // ç”¢ç”Ÿæ–‡ä»¶åç¨±
            documentName = filterConfig?.GetDocumentName?.Invoke(criteria) 
                          ?? $"å ±è¡¨-{DateTime.Now:yyyyMMddHHmmss}";
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å°æ‡‰çš„å ±è¡¨æœå‹™
            if (filterConfig?.ReportServiceType != null)
            {
                // å‹•æ…‹å–å¾—å ±è¡¨æœå‹™
                var reportService = ServiceProvider.GetService(filterConfig.ReportServiceType);
                
                if (reportService == null)
                {
                    await NotificationService.ShowErrorAsync($"ç„¡æ³•å–å¾—å ±è¡¨æœå‹™ï¼š{filterConfig.ReportServiceType.Name}");
                    return;
                }
                
                // å˜—è©¦æ‰¾æ¥å—å…·é«” Criteria é¡å‹çš„ RenderBatchToImagesAsync æ–¹æ³•
                // é€™æ¨£ç‰¹æ®Šå ±è¡¨ï¼ˆå¦‚æ¢ç¢¼åˆ—å°ï¼‰å¯ä»¥ç›´æ¥æ¥æ”¶å…¶å°ˆå±¬çš„ Criteria é¡å‹
                var criteriaType = criteria.GetType();
                var typedRenderMethod = reportService.GetType().GetMethods()
                    .FirstOrDefault(m => m.Name == "RenderBatchToImagesAsync" && 
                                        m.GetParameters().Length == 1 &&
                                        m.GetParameters()[0].ParameterType == criteriaType);
                
                if (typedRenderMethod != null)
                {
                    // ä½¿ç”¨å…·é«”é¡å‹çš„ RenderBatchToImagesAsync æ–¹æ³•
                    await SetPreviewProgress(30, "æ­£åœ¨ç”¢ç”Ÿå ±è¡¨...");

                    var task = (Task<BatchPreviewResult>)typedRenderMethod.Invoke(reportService, new object[] { criteria })!;
                    var result = await task;

                    if (!result.IsSuccess)
                    {
                        await NotificationService.ShowWarningAsync(result.ErrorMessage ?? "ç”¢ç”Ÿé è¦½å¤±æ•—");
                        return;
                    }

                    await SetPreviewProgress(90, "æ­£åœ¨æº–å‚™é è¦½...");

                    // è¨­å®šé è¦½è³‡æ–™
                    previewImages = result.PreviewImages;
                    formattedDocument = result.MergedDocument;

                    // ä¿å­˜å ±è¡¨æœå‹™å’Œå…·é«”é¡å‹çš„ Criteriaï¼ˆç´™å¼µè®Šæ›´æ™‚ç”¨ï¼‰
                    currentReportService = reportService;
                    currentBatchCriteria = null;
                    currentTypedCriteria = criteria;

                    await SetPreviewProgress(100, "å®Œæˆï¼");
                    await Task.Delay(400);

                    // é—œé–‰ç¯©é¸ Modalï¼Œé–‹å•Ÿé è¦½ Modal
                    await IsVisibleChanged.InvokeAsync(false);
                    showPreview = true;

                    await NotificationService.ShowSuccessAsync($"å·²ç”¢ç”Ÿ {result.DocumentCount} ç­†è³‡æ–™çš„é è¦½ï¼Œå…± {result.TotalPages} é ");
                }
                else
                {
                    // é™ç´šä½¿ç”¨ BatchPrintCriteria æ–¹å¼
                    // è½‰æ›ç¯©é¸æ¢ä»¶ç‚º BatchPrintCriteria
                    BatchPrintCriteria batchCriteria;
                    
                    // å˜—è©¦ä½¿ç”¨ ToBatchPrintCriteria æ–¹æ³•è½‰æ›
                    var toBatchMethod = criteriaType.GetMethod("ToBatchPrintCriteria");
                    if (toBatchMethod != null)
                    {
                        batchCriteria = (BatchPrintCriteria)toBatchMethod.Invoke(criteria, null)!;
                    }
                    else
                    {
                        // ä½¿ç”¨é è¨­è½‰æ›
                        batchCriteria = ConvertToBatchCriteria(criteria);
                    }
                    
                    // å‘¼å«æ‰¹æ¬¡é è¦½æ–¹æ³•
                    var renderMethod = reportService.GetType().GetMethod("RenderBatchToImagesAsync", 
                        new[] { typeof(BatchPrintCriteria) });
                    if (renderMethod != null)
                    {
                        await SetPreviewProgress(30, "æ­£åœ¨ç”¢ç”Ÿå ±è¡¨...");

                        var task = (Task<BatchPreviewResult>)renderMethod.Invoke(reportService, new object[] { batchCriteria })!;
                        var result = await task;

                        if (!result.IsSuccess)
                        {
                            await NotificationService.ShowWarningAsync(result.ErrorMessage ?? "ç”¢ç”Ÿé è¦½å¤±æ•—");
                            return;
                        }

                        await SetPreviewProgress(90, "æ­£åœ¨æº–å‚™é è¦½...");

                        // è¨­å®šé è¦½è³‡æ–™
                        previewImages = result.PreviewImages;
                        formattedDocument = result.MergedDocument;

                        // ä¿å­˜å ±è¡¨æœå‹™å’Œç¯©é¸æ¢ä»¶ï¼Œç”¨æ–¼ç´™å¼µè®Šæ›´æ™‚é‡æ–°ç”¢ç”Ÿé è¦½
                        currentReportService = reportService;
                        currentBatchCriteria = batchCriteria;

                        await SetPreviewProgress(100, "å®Œæˆï¼");
                        await Task.Delay(400);

                        // é—œé–‰ç¯©é¸ Modalï¼Œé–‹å•Ÿé è¦½ Modal
                        await IsVisibleChanged.InvokeAsync(false);
                        showPreview = true;

                        await NotificationService.ShowSuccessAsync($"å·²ç”¢ç”Ÿ {result.DocumentCount} ç­†å–®æ“šçš„é è¦½ï¼Œå…± {result.TotalPages} é ");
                    }
                    else
                    {
                        await NotificationService.ShowWarningAsync($"å ±è¡¨æœå‹™ {filterConfig.ReportServiceType.Name} å°šæœªå¯¦ä½œæ‰¹æ¬¡é è¦½æ–¹æ³•");
                    }
                }
            }
            else
            {
                // å°šç„¡æœå‹™ï¼Œé¡¯ç¤ºç¯©é¸çµæœ
                await NotificationService.ShowInfoAsync(
                    $"ğŸ“Š ç¯©é¸æ¢ä»¶ï¼š\n" +
                    $"{System.Text.Json.JsonSerializer.Serialize(criteria.ToQueryParameters(), new System.Text.Json.JsonSerializerOptions { WriteIndented = true })}\n\n" +
                    $"ï¼ˆå ±è¡¨æœå‹™å°šæœªé…ç½®ï¼‰");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleConfirmAsync), GetType());
            await NotificationService.ShowErrorAsync($"ç”¢ç”Ÿå ±è¡¨å¤±æ•—ï¼š{ex.Message}");
        }
        finally
        {
            isLoading = false;
            _showPreviewProgress = false;
            StateHasChanged();
        }
    }
    
    private async Task HandleCancel()
    {
        await IsVisibleChanged.InvokeAsync(false);
        
        if (OnCancel.HasDelegate)
        {
            await OnCancel.InvokeAsync();
        }
    }
    
    private async Task HandlePrintSuccess()
    {
        showPreview = false;
        await IsVisibleChanged.InvokeAsync(false);
        
        if (OnPrintSuccess.HasDelegate)
        {
            await OnPrintSuccess.InvokeAsync();
        }
    }
    
    private void HandlePreviewCancel()
    {
        showPreview = false;
        // ä¿æŒç¯©é¸ Modal é–‹å•Ÿï¼Œè®“ä½¿ç”¨è€…å¯ä»¥ä¿®æ”¹æ¢ä»¶
    }
    
    /// <summary>
    /// è™•ç†ç´™å¼µè¨­å®šè®Šæ›´äº‹ä»¶
    /// ç•¶ä½¿ç”¨è€…åœ¨é è¦½ Modal ä¸­è®Šæ›´ç´™å¼µæ™‚ï¼Œé‡æ–°æ¸²æŸ“é è¦½åœ–ç‰‡
    /// </summary>
    private async Task HandlePaperSettingChanged(PaperSetting paperSetting)
    {
        try
        {
            if (currentReportService == null) return;

            // å¿…é ˆæœ‰ BatchPrintCriteria æˆ– TypedCriteria å…¶ä¸­ä¸€å€‹
            if (currentBatchCriteria == null && currentTypedCriteria == null) return;

            isLoading = true;
            _showPreviewProgress = true;
            await SetPreviewProgress(10, "æ­£åœ¨æ›´æ–°ç´™å¼µè¨­å®š...");
            
            BatchPreviewResult? result = null;
            
            if (currentTypedCriteria != null)
            {
                // ä½¿ç”¨å…·é«”é¡å‹çš„ Criteriaï¼ˆå¦‚ ProductBarcodeBatchPrintCriteriaï¼‰
                // é€éåå°„è¨­å®š PaperSetting å±¬æ€§
                var paperSettingProp = currentTypedCriteria.GetType().GetProperty("PaperSetting");
                if (paperSettingProp != null && paperSettingProp.CanWrite)
                {
                    paperSettingProp.SetValue(currentTypedCriteria, paperSetting);
                }
                
                // å‘¼å«å…·é«”é¡å‹çš„ RenderBatchToImagesAsync æ–¹æ³•
                var criteriaType = currentTypedCriteria.GetType();
                var typedRenderMethod = currentReportService.GetType().GetMethods()
                    .FirstOrDefault(m => m.Name == "RenderBatchToImagesAsync" && 
                                        m.GetParameters().Length == 1 &&
                                        m.GetParameters()[0].ParameterType == criteriaType);
                
                if (typedRenderMethod != null)
                {
                    await SetPreviewProgress(30, "æ­£åœ¨é‡æ–°æ¸²æŸ“...");
                    var task = (Task<BatchPreviewResult>)typedRenderMethod.Invoke(currentReportService, new object[] { currentTypedCriteria })!;
                    result = await task;
                }
            }
            else if (currentBatchCriteria != null)
            {
                // ä½¿ç”¨æ¨™æº– BatchPrintCriteria
                currentBatchCriteria.PaperSetting = paperSetting;

                // æ›´æ–° FormattedDocument çš„ç´™å¼µå°ºå¯¸
                if (formattedDocument != null)
                {
                    formattedDocument.PageSettings.PageWidth = (float)paperSetting.Width;
                    formattedDocument.PageSettings.PageHeight = (float)paperSetting.Height;
                    formattedDocument.PageSettings.LeftMargin = (float)(paperSetting.LeftMargin ?? 1.0m);
                    formattedDocument.PageSettings.TopMargin = (float)(paperSetting.TopMargin ?? 1.0m);
                    formattedDocument.PageSettings.RightMargin = (float)(paperSetting.RightMargin ?? 1.0m);
                    formattedDocument.PageSettings.BottomMargin = (float)(paperSetting.BottomMargin ?? 1.0m);
                }

                // å‘¼å«æ‰¹æ¬¡é è¦½æ–¹æ³•
                var renderMethod = currentReportService.GetType().GetMethod("RenderBatchToImagesAsync",
                    new[] { typeof(BatchPrintCriteria) });
                if (renderMethod != null)
                {
                    await SetPreviewProgress(30, "æ­£åœ¨é‡æ–°æ¸²æŸ“...");
                    var task = (Task<BatchPreviewResult>)renderMethod.Invoke(currentReportService, new object[] { currentBatchCriteria })!;
                    result = await task;
                }
            }

            // æ›´æ–°é è¦½åœ–ç‰‡
            if (result != null && result.IsSuccess)
            {
                await SetPreviewProgress(100, "æ›´æ–°å®Œæˆï¼");
                await Task.Delay(300);
                previewImages = result.PreviewImages;
                formattedDocument = result.MergedDocument;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æ›´æ–°é è¦½æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
        finally
        {
            isLoading = false;
            _showPreviewProgress = false;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// å°‡ IReportFilterCriteria è½‰æ›ç‚º BatchPrintCriteriaï¼ˆé è¨­å¯¦ä½œï¼‰
    /// </summary>
    private BatchPrintCriteria ConvertToBatchCriteria(IReportFilterCriteria criteria)
    {
        var batchCriteria = new BatchPrintCriteria();
        var queryParams = criteria.ToQueryParameters();
        
        // å˜—è©¦å¾æŸ¥è©¢åƒæ•¸ä¸­å–å¾—å¸¸ç”¨æ¬„ä½
        if (queryParams.TryGetValue("startDate", out var startDate) && startDate is DateTime start)
        {
            batchCriteria.StartDate = start;
        }
        
        if (queryParams.TryGetValue("endDate", out var endDate) && endDate is DateTime end)
        {
            batchCriteria.EndDate = end;
        }
        
        if (queryParams.TryGetValue("supplierIds", out var supplierIds) && supplierIds is List<int> ids)
        {
            batchCriteria.RelatedEntityIds = ids;
        }
        
        if (queryParams.TryGetValue("maxResults", out var maxResults) && maxResults is int max)
        {
            batchCriteria.MaxResults = max;
        }
        
        return batchCriteria;
    }
}
