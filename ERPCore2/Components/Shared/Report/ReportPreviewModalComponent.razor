@* 通用報表預覽 Modal - 整合預覽與列印功能 *@
@* 設計理念：使用者先預覽報表內容，確認無誤後再按「列印」發送到印表機 *@
@* 統一使用格式化模式：圖片預覽，支援表格線、圖片 *@

@using ERPCore2.Services.Reports
@using ERPCore2.Services.Reports.Interfaces
@using ERPCore2.Helpers
@using ERPCore2.Models.Reports
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> L
@inject INotificationService NotificationService
@inject IFormattedPrintService FormattedPrintService
@inject IExcelExportService ExcelExportService
@inject IPdfExportService PdfExportService
@inject IJSRuntime JSRuntime
@inject IReportPrintConfigurationService ReportPrintConfigurationService
@inject IPrinterConfigurationService PrinterConfigurationService
@inject IPaperSettingService PaperSettingService

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@GetModalTitle()"
                   Icon="fas fa-file-alt"
                   Size="BaseModalComponent.ModalSize.Desktop"
                   HeaderColor="BaseModalComponent.HeaderVariant.ProjectPrimary"
                   CloseOnEscape="true"
                   CloseOnBackdropClick="false"
                   ShowCloseButton="true"
                   IsLoading="@IsLoading"
                   LoadingMessage="@LoadingMessage"
                   ShowFooter="false"
                   BodyCssClass="p-0 report-preview-modal-body"
                   OnClose="@HandleCancel">
    
    <HeaderButtons>
        <div class="w-100 d-flex flex-wrap align-items-center px-2 modal-buttons-container">
            @* 右側：操作按鈕 *@
            <div class="d-flex gap-2 ms-auto">
                <GenericButtonComponent Text="@L["Button.ExportExcel"]"
                                      Variant="ButtonVariant.Green"
                                      OnClick="HandleExportExcel"
                                      IsDisabled="@(IsLoading || IsPrinting || IsExporting || _isGeneratingPdf || FormattedDocument == null)" />

                <GenericButtonComponent Text="@L["Button.DownloadPdf"]"
                                      Variant="ButtonVariant.Orange"
                                      OnClick="HandleExportPdf"
                                      IsDisabled="@(IsLoading || IsPrinting || IsExporting || _isGeneratingPdf || FormattedDocument == null)" />

                <GenericButtonComponent Text="@L["Button.BrowserPrint"]"
                                      Variant="ButtonVariant.Cyan"
                                      OnClick="HandleBrowserPrint"
                                      IsDisabled="@(IsLoading || IsPrinting || _isGeneratingPdf || PreviewImages == null || !PreviewImages.Any())" />

                <GenericButtonComponent Text="@L["Button.Print"]"
                                      Variant="ButtonVariant.Blue"
                                      OnClick="HandlePrint"
                                      IsDisabled="@(IsLoading || IsPrinting || _isGeneratingPdf || string.IsNullOrEmpty(_printerName))" />

                <GenericButtonComponent Text="@L["Button.Cancel"]"
                                      Variant="ButtonVariant.Red"
                                      OnClick="HandleCancel"
                                      IsDisabled="@(IsLoading || IsPrinting || _isGeneratingPdf)" />
            </div>
        </div>
    </HeaderButtons>
    
    <BodyContent>
        @if (IsPrinting)
        {
            <div class="d-flex justify-content-center align-items-center py-5">
                <div class="spinner-border text-primary me-3" role="status">
                    <span class="visually-hidden">@L["Report.Printing"]</span>
                </div>
                <span class="fs-5">@L["Report.SendingToPrinter"]</span>
            </div>
        }
        else
        {
            @* 左右分欄佈局：左側設定區域、右側預覽區域 *@
            <div class="report-modal-layout">
                @* 左側：列印設定區域 *@
                <div class="print-settings-panel">
                    <h6 class="settings-section-title">
                        <i class="fas fa-cog me-2"></i>@L["Report.PrintSettings"]
                    </h6>
                    
                    @* 印表機選擇 *@
                    <div class="setting-item-row">
                        <label class="setting-label-inline">
                            <i class="fas fa-print me-1"></i>@L["Report.PrinterLabel"]
                        </label>
                        <select class="form-select form-select-sm setting-input" 
                                @bind="_selectedPrinterConfigurationId" 
                                @bind:after="OnPrinterChanged"
                                disabled="@IsLoading">
                            <option value="">-- 請選擇 --</option>
                            @foreach (var printer in _printerConfigurations)
                            {
                                <option value="@printer.Id">@printer.Name</option>
                            }
                        </select>
                    </div>
                    @if (string.IsNullOrEmpty(_printerName))
                    {
                        <small class="text-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i>@L["Report.SelectPrinterWarning"]
                        </small>
                    }
                    
                    @* 紙張選擇 *@
                    <div class="setting-item-row">
                        <label class="setting-label-inline">
                            <i class="fas fa-file me-1"></i>@L["Report.PaperLabel"]
                        </label>
                        <select class="form-select form-select-sm setting-input" 
                                @bind="_selectedPaperSettingId"
                                @bind:after="OnPaperChanged"
                                disabled="@IsLoading">
                            <option value="">-- 請選擇 --</option>
                            @foreach (var paper in _paperSettings)
                            {
                                <option value="@paper.Id">@paper.Name (@paper.Width×@paper.Height cm)</option>
                            }
                        </select>
                    </div>

                    @* 預覽縮放 *@
                    <div class="setting-item-row">
                        <label class="setting-label-inline">
                            <i class="fas fa-search-plus me-1"></i>@L["Report.ZoomLabel"]
                        </label>
                        <div class="d-flex align-items-center gap-1 setting-input">
                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                    @onclick="ZoomOut" disabled="@(_previewZoom <= 50)">
                                <i class="fas fa-minus"></i>
                            </button>
                            <div class="zoom-display">@_previewZoom%</div>
                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                    @onclick="ZoomIn" disabled="@(_previewZoom >= 200)">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    @* 邊距設定 *@
                    <div class="margin-settings-group mt-2">
                        <label class="setting-label-inline mb-1">
                            <i class="fas fa-border-style me-1"></i>@L["Report.MarginLabel"]
                        </label>
                        <div class="margin-inputs-grid">
                            <div class="margin-input-item">
                                <label class="margin-label">@L["Label.MarginTop"]</label>
                                <input type="number"
                                       class="form-control form-control-sm margin-input"
                                       @bind="_marginTop"
                                       @bind:after="OnMarginChanged"
                                       step="0.1"
                                       min="0"
                                       max="10"
                                       disabled="@(IsLoading || _selectedPaper == null)" />
                            </div>
                            <div class="margin-input-item">
                                <label class="margin-label">@L["Label.MarginBottom"]</label>
                                <input type="number"
                                       class="form-control form-control-sm margin-input"
                                       @bind="_marginBottom"
                                       @bind:after="OnMarginChanged"
                                       step="0.1"
                                       min="0"
                                       max="10"
                                       disabled="@(IsLoading || _selectedPaper == null)" />
                            </div>
                            <div class="margin-input-item">
                                <label class="margin-label">@L["Label.MarginLeft"]</label>
                                <input type="number"
                                       class="form-control form-control-sm margin-input"
                                       @bind="_marginLeft"
                                       @bind:after="OnMarginChanged"
                                       step="0.1"
                                       min="0"
                                       max="10"
                                       disabled="@(IsLoading || _selectedPaper == null)" />
                            </div>
                            <div class="margin-input-item">
                                <label class="margin-label">@L["Label.MarginRight"]</label>
                                <input type="number"
                                       class="form-control form-control-sm margin-input"
                                       @bind="_marginRight"
                                       @bind:after="OnMarginChanged"
                                       step="0.1"
                                       min="0"
                                       max="10"
                                       disabled="@(IsLoading || _selectedPaper == null)" />
                            </div>
                        </div>
                    </div>
                    

                    
                    <hr class="my-3" />
                    
                    @* 列印份數 *@
                    <div class="setting-item-row">
                        <label class="setting-label-inline">
                            <i class="fas fa-copy me-1"></i>@L["Report.CopiesLabel"]
                        </label>
                        <input type="number" 
                               class="form-control form-control-sm setting-input-small" 
                               @bind="_copies" 
                               min="1" 
                               max="99"
                               disabled="@IsLoading" />
                    </div>
                    
                    @* 頁數顯示 *@
                    <div class="setting-item-row">
                        <label class="setting-label-inline">
                            <i class="fas fa-file-alt me-1"></i>@L["Report.PagesLabel"]
                        </label>
                        <div class="form-control form-control-sm bg-light text-center setting-input-small">
                            @string.Format(L["Report.PageNum"], _estimatedPages)
                        </div>
                    </div>
                </div>
                
                @* 右側：報表預覽區域 *@
                <div class="report-preview-outer-container">
                    @if (PreviewImages != null && PreviewImages.Any())
                    {
                        @* 顯示圖片預覽 *@
                        <div class="formatted-preview-wrapper" style="@GetPreviewZoomStyle()">
                            @foreach (var (imageData, index) in PreviewImages.Select((img, i) => (img, i)))
                            {
                                <div class="page-preview-container mb-3">
                                    <div class="page-number-badge">@string.Format(L["Report.PageNum"], index + 1)</div>
                                    <img src="data:image/png;base64,@Convert.ToBase64String(imageData)"
                                         class="formatted-page-preview"
                                         alt="@string.Format(L["Report.PageNum"], index + 1)" />
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="d-flex justify-content-center align-items-center py-5 text-muted h-100">
                            <div class="text-center">
                                <i class="fas fa-file-alt fa-3x mb-3"></i>
                                <div class="fs-5">@L["Report.NoContent"]</div>
                            </div>
                        </div>
                    }
                </div>

                @* 匯出進度條 Overlay *@
                @if (_showExportProgress)
                {
                    <div class="export-progress-overlay">
                        <div class="export-progress-card">
                            <div class="export-progress-message">@_exportProgressMessage</div>
                            <div class="progress export-progress-bar" role="progressbar"
                                 aria-valuenow="@_exportProgressValue" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-bar progress-bar-striped progress-bar-animated @_exportProgressColorClass"
                                     style="width: @(_exportProgressValue)%">
                                    @_exportProgressValue%
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </BodyContent>
</BaseModalComponent>

@code {
    // ===== 參數 =====
    
    /// <summary>
    /// Modal 是否顯示
    /// </summary>
    [Parameter] public bool IsVisible { get; set; } = false;
    
    /// <summary>
    /// Modal 顯示狀態變更事件
    /// </summary>
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    
    /// <summary>
    /// Modal 標題
    /// </summary>
    [Parameter] public string Title { get; set; } = "報表預覽";
    
    /// <summary>
    /// 報表預覽圖片
    /// 由 RenderToImages 生成的 PNG 圖片 byte[] 列表
    /// </summary>
    [Parameter] public List<byte[]>? PreviewImages { get; set; }
    
    /// <summary>
    /// 格式化文件（列印時需要）
    /// </summary>
    [Parameter] public FormattedDocument? FormattedDocument { get; set; }
    
    /// <summary>
    /// 報表 ID（用於查詢印表機配置）
    /// 例如：PO001（採購單）、PR001（進貨單）、SO001（銷貨單）
    /// </summary>
    [Parameter] public string ReportId { get; set; } = string.Empty;
    
    /// <summary>
    /// 列印文件名稱（顯示在列印佇列中）
    /// </summary>
    [Parameter] public string DocumentName { get; set; } = "報表列印";
    
    /// <summary>
    /// 列印成功事件
    /// </summary>
    [Parameter] public EventCallback OnPrintSuccess { get; set; }
    
    /// <summary>
    /// 列印失敗事件
    /// </summary>
    [Parameter] public EventCallback<string> OnPrintFailure { get; set; }
    
    /// <summary>
    /// 取消事件
    /// </summary>
    [Parameter] public EventCallback OnCancel { get; set; }
    
    /// <summary>
    /// 紙張設定變更事件
    /// 當用戶變更紙張選擇時觸發，父組件應根據新紙張重新渲染預覽圖片
    /// </summary>
    [Parameter] public EventCallback<PaperSetting> OnPaperSettingChanged { get; set; }
    
    // ===== 內部狀態 =====
    
    private bool IsLoading { get; set; } = false;
    private bool IsPrinting { get; set; } = false;
    private bool IsExporting { get; set; } = false;
    private bool _isGeneratingPdf = false;
    private string LoadingMessage { get; set; } = "載入中...";

    // 匯出進度條
    private bool _showExportProgress = false;
    private int _exportProgressValue = 0;
    private string _exportProgressMessage = "";
    private string _exportProgressColorClass = "bg-warning";
    
    // 印表機相關
    private string? _printerName = null;
    private int? _printerConfigurationId = null;
    private int _selectedPrinterConfigurationId;
    private List<PrinterConfiguration> _printerConfigurations = new();
    
    // 紙張相關
    private int? _paperSettingId = null;
    private int _selectedPaperSettingId;
    private List<PaperSetting> _paperSettings = new();
    private PaperSetting? _selectedPaper = null;
    
    // 邊距設定（單位：公分）
    private decimal _marginTop = 0.3m;
    private decimal _marginBottom = 0.3m;
    private decimal _marginLeft = 0.8m;
    private decimal _marginRight = 0.8m;
    
    // 列印設定
    private int _copies = 1;
    private int _estimatedPages = 1;
    
    // 預覽縮放控制
    private int _previewZoom = 100;  // 縮放百分比（50-200）
    
    // 初始化標記（避免參數變更時重複載入配置）
    private bool _isConfigurationLoaded = false;
    
    // ===== 生命週期 =====
    
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible)
        {
            // 只在第一次開啟 Modal 時載入預設配置
            if (!_isConfigurationLoaded)
            {
                await LoadPrintConfigurations();
            }
            CalculateEstimatedPages();
        }
        else
        {
            // Modal 關閉時重設標記，下次開啟時重新載入
            _isConfigurationLoaded = false;
        }
    }
    
    // ===== 資料載入 =====
    
    /// <summary>
    /// 載入所有列印相關配置
    /// </summary>
    private async Task LoadPrintConfigurations()
    {
        try
        {
            IsLoading = true;
            LoadingMessage = "載入列印配置...";
            StateHasChanged();

            // 重設所有選擇狀態，避免殘留上次開啟時的值
            _selectedPrinterConfigurationId = 0;
            _printerConfigurationId = null;
            _printerName = null;
            _selectedPaperSettingId = 0;
            _paperSettingId = null;
            _selectedPaper = null;
            _marginTop = 0.3m;
            _marginBottom = 0.3m;
            _marginLeft = 0.8m;
            _marginRight = 0.8m;

            // 載入所有印表機和紙張選項
            var printerTask = PrinterConfigurationService.GetAllAsync();
            var paperTask = PaperSettingService.GetAllAsync();
            
            await Task.WhenAll(printerTask, paperTask);
            
            _printerConfigurations = (await printerTask)?.ToList() ?? new List<PrinterConfiguration>();
            _paperSettings = (await paperTask)?.ToList() ?? new List<PaperSetting>();
            
            // 根據 ReportId 查詢預設配置
            if (!string.IsNullOrEmpty(ReportId))
            {
                var reportConfig = await ReportPrintConfigurationService.GetByReportIdAsync(ReportId);
                
                if (reportConfig != null)
                {
                    // 設定預設印表機
                    if (reportConfig.PrinterConfigurationId.HasValue)
                    {
                        _selectedPrinterConfigurationId = reportConfig.PrinterConfigurationId.Value;
                        _printerConfigurationId = reportConfig.PrinterConfigurationId.Value;
                        var printerConfig = _printerConfigurations.FirstOrDefault(p => p.Id == _printerConfigurationId);
                        _printerName = printerConfig?.Name;
                    }
                    
                    // 設定預設紙張
                    if (reportConfig.PaperSettingId.HasValue)
                    {
                        _selectedPaperSettingId = reportConfig.PaperSettingId.Value;
                        _paperSettingId = reportConfig.PaperSettingId.Value;
                        _selectedPaper = _paperSettings.FirstOrDefault(p => p.Id == _paperSettingId);
                        
                        // 初始化邊距值
                        if (_selectedPaper != null)
                        {
                            _marginTop = _selectedPaper.TopMargin ?? 0.3m;
                            _marginBottom = _selectedPaper.BottomMargin ?? 0.3m;
                            _marginLeft = _selectedPaper.LeftMargin ?? 0.8m;
                            _marginRight = _selectedPaper.RightMargin ?? 0.8m;
                        }
                    }
                }
            }
            
            // 重設列印份數
            _copies = 1;
            
            // 標記配置已載入
            _isConfigurationLoaded = true;
            
            // 如果有預設紙張設定，通知父組件用正確的紙張尺寸重新渲染預覽
            // 這確保預覽圖片與設定的紙張格式一致（例如中一刀而非預設 A4）
            await NotifyPaperSettingChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入列印配置失敗：{ex.Message}");
            _printerName = null;
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// 計算預估頁數
    /// </summary>
    private void CalculateEstimatedPages()
    {
        // 根據圖片數量計算頁數
        if (PreviewImages != null)
        {
            _estimatedPages = PreviewImages.Count;
            return;
        }
        
        _estimatedPages = 0;
    }
    
    /// <summary>
    /// 取得預覽縮放樣式
    /// </summary>
    private string GetPreviewZoomStyle()
    {
        var scale = _previewZoom / 100.0;
        return $"transform: scale({scale:F2});";
    }
    
    /// <summary>
    /// 放大預覽
    /// </summary>
    private void ZoomIn()
    {
        if (_previewZoom < 200)
        {
            _previewZoom += 10;
        }
    }
    
    /// <summary>
    /// 縮小預覽
    /// </summary>
    private void ZoomOut()
    {
        if (_previewZoom > 50)
        {
            _previewZoom -= 10;
        }
    }
    
    /// <summary>
    /// 印表機變更事件
    /// </summary>
    private void OnPrinterChanged()
    {
        if (_selectedPrinterConfigurationId > 0)
        {
            var printer = _printerConfigurations.FirstOrDefault(p => p.Id == _selectedPrinterConfigurationId);
            _printerName = printer?.Name;
            _printerConfigurationId = _selectedPrinterConfigurationId;
        }
        else
        {
            _printerName = null;
            _printerConfigurationId = null;
        }
    }
    
    /// <summary>
    /// 紙張變更事件
    /// </summary>
    private async Task OnPaperChanged()
    {
        if (_selectedPaperSettingId > 0)
        {
            _selectedPaper = _paperSettings.FirstOrDefault(p => p.Id == _selectedPaperSettingId);
            _paperSettingId = _selectedPaperSettingId;
            
            // 載入該紙張的預設邊距值
            if (_selectedPaper != null)
            {
                _marginTop = _selectedPaper.TopMargin ?? 0.3m;
                _marginBottom = _selectedPaper.BottomMargin ?? 0.3m;
                _marginLeft = _selectedPaper.LeftMargin ?? 0.8m;
                _marginRight = _selectedPaper.RightMargin ?? 0.8m;
            }
        }
        else
        {
            _selectedPaper = null;
            _paperSettingId = null;
            // 重設為預設邊距
            _marginTop = 0.3m;
            _marginBottom = 0.3m;
            _marginLeft = 0.8m;
            _marginRight = 0.8m;
        }
        
        // 重新計算頁數
        CalculateEstimatedPages();
        
        // 通知父組件紙張已變更，需要重新渲染預覽圖片
        await NotifyPaperSettingChanged();
    }
    
    /// <summary>
    /// 邊距變更事件
    /// </summary>
    private async Task OnMarginChanged()
    {
        // 確保邊距值在合理範圍內
        _marginTop = Math.Max(0, Math.Min(10, _marginTop));
        _marginBottom = Math.Max(0, Math.Min(10, _marginBottom));
        _marginLeft = Math.Max(0, Math.Min(10, _marginLeft));
        _marginRight = Math.Max(0, Math.Min(10, _marginRight));
        
        // 更新 _selectedPaper 的邊距值
        if (_selectedPaper != null)
        {
            _selectedPaper.TopMargin = _marginTop;
            _selectedPaper.BottomMargin = _marginBottom;
            _selectedPaper.LeftMargin = _marginLeft;
            _selectedPaper.RightMargin = _marginRight;
        }
        
        // 通知父組件重新渲染預覽圖片
        await NotifyPaperSettingChanged();
    }
    
    /// <summary>
    /// 通知父組件紙張設定已變更
    /// </summary>
    private async Task NotifyPaperSettingChanged()
    {
        if (_selectedPaper != null && OnPaperSettingChanged.HasDelegate)
        {
            // 確保邊距值已更新到 _selectedPaper
            _selectedPaper.TopMargin = _marginTop;
            _selectedPaper.BottomMargin = _marginBottom;
            _selectedPaper.LeftMargin = _marginLeft;
            _selectedPaper.RightMargin = _marginRight;
            
            await OnPaperSettingChanged.InvokeAsync(_selectedPaper);
        }
    }
    
    // ===== 匯出進度條 =====

    /// <summary>
    /// 更新匯出進度條，並讓 UI 刷新後再繼續
    /// </summary>
    private async Task SetExportProgress(int value, string message)
    {
        _exportProgressValue = value;
        _exportProgressMessage = message;
        StateHasChanged();
        await Task.Delay(10);
    }

    // ===== 事件處理 =====

    /// <summary>
    /// 處理列印按鈕點擊
    /// 使用格式化列印服務
    /// </summary>
    private async Task HandlePrint()
    {
        // 檢查是否有內容可列印
        if (IsPrinting || FormattedDocument == null)
            return;
        
        if (string.IsNullOrEmpty(_printerName))
        {
            await NotificationService.ShowWarningAsync(L["Report.SelectPrinterWarning"]);
            return;
        }
        
        // 確保份數至少為 1
        if (_copies < 1) _copies = 1;
        
        try
        {
            IsPrinting = true;
            StateHasChanged();
            
            // 使用格式化列印服務（支援表格線、圖片）
            var result = FormattedPrintService.Print(FormattedDocument, _printerName, _copies);
            
            if (result.IsSuccess)
            {
                var message = _copies > 1 
                    ? $"已送出 {_copies} 份列印到印表機：{_printerName}" 
                    : $"已送出列印到印表機：{_printerName}";
                await NotificationService.ShowSuccessAsync(message);
                
                if (OnPrintSuccess.HasDelegate)
                {
                    await OnPrintSuccess.InvokeAsync();
                }
                
                // 列印成功後關閉 Modal
                await CloseModal();
            }
            else
            {
                var errorMessage = result.ErrorMessage ?? "列印失敗";
                await NotificationService.ShowErrorAsync($"列印失敗：{errorMessage}");
                
                if (OnPrintFailure.HasDelegate)
                {
                    await OnPrintFailure.InvokeAsync(errorMessage);
                }
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"列印時發生錯誤：{ex.Message}");
            
            if (OnPrintFailure.HasDelegate)
            {
                await OnPrintFailure.InvokeAsync(ex.Message);
            }
        }
        finally
        {
            IsPrinting = false;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// 處理轉Excel按鈕點擊
    /// 將 FormattedDocument 轉換為 Excel 檔案並下載
    /// </summary>
    private async Task HandleExportExcel()
    {
        if (IsExporting || FormattedDocument == null)
            return;

        try
        {
            IsExporting = true;
            _showExportProgress = true;
            _exportProgressColorClass = "bg-success";
            await SetExportProgress(10, "正在產生 Excel...");

            var excelBytes = await ExcelExportService.ExportToExcelAsync(FormattedDocument);

            await SetExportProgress(75, "正在下載...");

            var fileName = $"{FormattedDocument.DocumentName}.xlsx";
            var base64 = Convert.ToBase64String(excelBytes);
            var contentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
            var success = await JSRuntime.InvokeAsync<bool>("downloadFileFromBase64", fileName, base64, contentType);

            await SetExportProgress(100, success ? "下載完成！" : "下載失敗");
            await Task.Delay(500);

            if (success)
                await NotificationService.ShowSuccessAsync($"已下載 Excel 檔案：{fileName}");
            else
                await NotificationService.ShowErrorAsync("下載 Excel 檔案失敗");
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"轉換 Excel 時發生錯誤：{ex.Message}");
        }
        finally
        {
            IsExporting = false;
            _showExportProgress = false;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// 處理下載PDF按鈕點擊
    /// 重新以高解析度（150 DPI）渲染報表，再透過 PuppeteerSharp 產生 PDF 並下載
    /// </summary>
    private async Task HandleExportPdf()
    {
        if (_isGeneratingPdf || FormattedDocument == null)
            return;

        try
        {
            _isGeneratingPdf = true;
            _showExportProgress = true;
            _exportProgressColorClass = "bg-warning";
            await SetExportProgress(5, "準備中...");

            // 以 150 DPI 重新渲染以獲得更佳列印品質
            await SetExportProgress(15, "正在渲染頁面...");
            List<byte[]> pdfImages;
            if (_selectedPaper != null)
            {
                pdfImages = FormattedPrintService.RenderToImages(FormattedDocument, _selectedPaper, dpi: 150);
            }
            else
            {
                // A4 @ 150 DPI：21cm × 150/2.54 ≈ 1240px，29.7cm × 150/2.54 ≈ 1754px
                pdfImages = FormattedPrintService.RenderToImages(FormattedDocument, 1240, 1754, 150);
            }

            await SetExportProgress(60, "正在產生 PDF...");

            var widthCm = _selectedPaper != null ? (double)_selectedPaper.Width : 21.0;
            var heightCm = _selectedPaper != null ? (double)_selectedPaper.Height : 29.7;

            var pdfBytes = await PdfExportService.ExportToPdfAsync(pdfImages, widthCm, heightCm);

            await SetExportProgress(85, "正在下載...");

            var fileName = $"{FormattedDocument.DocumentName}.pdf";
            var base64 = Convert.ToBase64String(pdfBytes);
            var success = await JSRuntime.InvokeAsync<bool>("downloadFileFromBase64", fileName, base64, "application/pdf");

            await SetExportProgress(100, success ? "下載完成！" : "下載失敗");
            await Task.Delay(800);

            if (success)
                await NotificationService.ShowSuccessAsync($"已下載 PDF 檔案：{fileName}");
            else
                await NotificationService.ShowErrorAsync("下載 PDF 檔案失敗");
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"產生 PDF 時發生錯誤：{ex.Message}");
        }
        finally
        {
            _isGeneratingPdf = false;
            _showExportProgress = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// 處理本機列印按鈕點擊
    /// 將預覽圖片傳送到瀏覽器，透過 window.print() 開啟本機列印對話框
    /// 適合外地工作者使用本機或 VPN 連線的印表機
    /// </summary>
    private async Task HandleBrowserPrint()
    {
        if (PreviewImages == null || !PreviewImages.Any())
            return;

        var base64Images = PreviewImages.Select(img => Convert.ToBase64String(img)).ToArray();
        var widthCm = _selectedPaper != null ? (double)_selectedPaper.Width : 21.0;
        var heightCm = _selectedPaper != null ? (double)_selectedPaper.Height : 29.7;

        var success = await JSRuntime.InvokeAsync<bool>(
            "browserPrintImages",
            base64Images,
            DocumentName,
            widthCm,
            heightCm);

        if (!success)
            await NotificationService.ShowWarningAsync("無法開啟列印視窗，請確認瀏覽器未封鎖彈出視窗");
    }

    /// <summary>
    /// 處理取消按鈕點擊
    /// </summary>
    private async Task HandleCancel()
    {
        if (OnCancel.HasDelegate)
        {
            await OnCancel.InvokeAsync();
        }
        
        await CloseModal();
    }
    
    /// <summary>
    /// 關閉 Modal
    /// </summary>
    private async Task CloseModal()
    {
        // 重設狀態
        _copies = 1;
        
        if (IsVisibleChanged.HasDelegate)
        {
            await IsVisibleChanged.InvokeAsync(false);
        }
    }
    
    // ===== 輔助方法 =====
    
    /// <summary>
    /// 取得 Modal 標題
    /// </summary>
    private string GetModalTitle()
    {
        return string.IsNullOrEmpty(Title) ? "報表預覽" : Title;
    }
    
    /// <summary>
    /// 取得紙張資訊文字
    /// </summary>
    private string GetPaperInfoText()
    {
        if (_selectedPaper == null)
        {
            return "A4 (21×29.7 cm)";
        }
        
        return $"{_selectedPaper.Name} ({_selectedPaper.Width}×{_selectedPaper.Height} cm)";
    }

    /// <summary>
    /// 取得當前的紙張版面配置
    /// 可供父組件在需要時取得當前設定
    /// </summary>
    public PaperLayout GetCurrentPaperLayout()
    {
        return PaperLayoutCalculator.Calculate(_selectedPaper);
    }

    /// <summary>
    /// 取得當前選擇的紙張設定
    /// </summary>
    public PaperSetting? GetSelectedPaperSetting()
    {
        return _selectedPaper;
    }
}
