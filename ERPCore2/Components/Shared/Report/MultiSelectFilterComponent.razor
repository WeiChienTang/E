@* 
    多選篩選組件 - 使用 InteractiveTableComponent 實作
    提供左右雙欄的項目選擇介面，支援搜尋、全選、清空等功能
*@

@typeparam TItem
@using System.Reflection
@using ERPCore2.Components.Shared.Base
@using ERPCore2.Helpers.InteractiveTableComponentHelper

<div class="row g-2">
    @* 左欄：可選項目 *@
    <div class="col-md-6">
        <input type="text"
               class="form-control mb-1"
               placeholder="@Placeholder"
               @bind="searchTerm"
               @bind:event="oninput" />
        <div style="max-height: @ListHeight; overflow: auto;">
            <InteractiveTableComponent TItem="TItem"
                                       Items="@AvailableItems"
                                       ColumnDefinitions="@GetAvailableColumnDefinitions()"
                                       ShowHeader="false"
                                       ShowRowNumbers="false"
                                       ShowActions="false"
                                       IsStriped="true"
                                       IsHoverable="true"
                                       IsBordered="true"
                                       EnableRowClick="true"
                                       OnRowClick="AddItem"
                                       RowClickCursor="pointer"
                                       EmptyMessage="@GetAvailableEmptyMessage()"
                                       CssClass="table-sm mb-0" />
        </div>
    </div>
    
    @* 右欄：已選項目 *@
    <div class="col-md-6">
        <input type="text"
               class="form-control mb-1"
               placeholder="搜尋已選項目..."
               @bind="selectedSearchTerm"
               @bind:event="oninput" />
        <div style="max-height: @ListHeight; overflow: auto;">
            <InteractiveTableComponent TItem="TItem"
                                       Items="@FilteredSelectedItems"
                                       ColumnDefinitions="@GetSelectedColumnDefinitions()"
                                       ShowHeader="false"
                                       ShowRowNumbers="false"
                                       ShowActions="false"
                                       IsStriped="true"
                                       IsHoverable="true"
                                       IsBordered="true"
                                       EnableRowClick="true"
                                       OnRowClick="RemoveItem"
                                       RowClickCursor="pointer"
                                       EmptyMessage="@EmptyMessage"
                                       CssClass="table-sm mb-0" />
        </div>
    </div>
</div>

@code {
    // ===== 參數定義 =====
    
    /// <summary>可選擇的項目清單</summary>
    [Parameter, EditorRequired] 
    public List<TItem> Items { get; set; } = new();
    
    /// <summary>已選擇的項目清單（雙向綁定）</summary>
    [Parameter] 
    public List<TItem> SelectedItems { get; set; } = new();
    
    /// <summary>已選擇項目變更事件</summary>
    [Parameter] 
    public EventCallback<List<TItem>> SelectedItemsChanged { get; set; }
    
    /// <summary>顯示文字的屬性名稱</summary>
    [Parameter, EditorRequired] 
    public string DisplayProperty { get; set; } = string.Empty;
    
    /// <summary>值的屬性名稱（用於比較和去重）</summary>
    [Parameter] 
    public string ValueProperty { get; set; } = "Id";
    
    /// <summary>標籤文字</summary>
    [Parameter] 
    public string Label { get; set; } = "項目";
    
    /// <summary>搜尋框提示文字</summary>
    [Parameter] 
    public string Placeholder { get; set; } = "請輸入關鍵字搜尋...";
    
    /// <summary>未選擇時的提示訊息</summary>
    [Parameter] 
    public string EmptyMessage { get; set; } = "尚未選擇項目";
    
    /// <summary>列表高度</summary>
    [Parameter] 
    public string ListHeight { get; set; } = "200px";
    
    /// <summary>標籤和項目前的圖示 CSS 類別</summary>
    [Parameter] 
    public string IconClass { get; set; } = string.Empty;
    
    /// <summary>是否顯示 Card 外層（保留向後相容，目前不使用）</summary>
    [Parameter]
    public bool ShowCard { get; set; } = true;

    // ===== 內部狀態 =====
    private string searchTerm = string.Empty;
    private string selectedSearchTerm = string.Empty;

    // ===== 計算屬性 =====
    
    /// <summary>可選項目（排除已選擇的）</summary>
    private List<TItem> AvailableItems
    {
        get
        {
            if (Items == null) return new List<TItem>();
            
            var available = Items.Where(item => 
                !SelectedItems.Any(selected => AreItemsEqual(item, selected))
            );
            
            if (string.IsNullOrWhiteSpace(searchTerm))
                return available.ToList();
            
            return available.Where(item =>
                GetDisplayValue(item).Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
            ).ToList();
        }
    }
    
    /// <summary>已選項目（經過搜尋篩選）</summary>
    private List<TItem> FilteredSelectedItems
    {
        get
        {
            if (SelectedItems == null) return new List<TItem>();
            
            if (string.IsNullOrWhiteSpace(selectedSearchTerm))
                return SelectedItems;
            
            return SelectedItems.Where(item =>
                GetDisplayValue(item).Contains(selectedSearchTerm, StringComparison.OrdinalIgnoreCase)
            ).ToList();
        }
    }

    // ===== 欄位定義 =====
    
    /// <summary>取得可選項目表格的欄位定義</summary>
    private List<InteractiveColumnDefinition> GetAvailableColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = "名稱",
                PropertyName = DisplayProperty,
                ColumnType = InteractiveColumnType.Custom,
                Width = "100%",
                CustomTemplate = item =>
                {
                    var typedItem = (TItem)item;
                    var displayText = GetDisplayValue(typedItem);
                    return @<text>
                        @if (!string.IsNullOrEmpty(IconClass))
                        {
                            <i class="@IconClass me-2 text-muted"></i>
                        }
                        <span>@displayText</span>
                    </text>;
                }
            }
        };
    }
    
    /// <summary>取得已選項目表格的欄位定義</summary>
    private List<InteractiveColumnDefinition> GetSelectedColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = "名稱",
                PropertyName = DisplayProperty,
                ColumnType = InteractiveColumnType.Custom,
                Width = "100%",
                CustomTemplate = item =>
                {
                    var typedItem = (TItem)item;
                    var displayText = GetDisplayValue(typedItem);
                    return @<text>
                        @if (!string.IsNullOrEmpty(IconClass))
                        {
                            <i class="@IconClass me-2 text-muted"></i>
                        }
                        <span>@displayText</span>
                    </text>;
                }
            }
        };
    }

    // ===== 輔助方法 =====
    
    private string GetAvailableEmptyMessage()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
            return "所有項目已選擇";
        return $"找不到符合「{searchTerm}」的項目";
    }

    /// <summary>取得項目的顯示值</summary>
    private string GetDisplayValue(TItem item)
    {
        if (item == null) return string.Empty;
        
        try
        {
            var property = typeof(TItem).GetProperty(DisplayProperty);
            return property?.GetValue(item)?.ToString() ?? item.ToString() ?? string.Empty;
        }
        catch
        {
            return item.ToString() ?? string.Empty;
        }
    }

    /// <summary>取得項目的值（用於比較）</summary>
    private object? GetItemValue(TItem item)
    {
        if (item == null) return null;
        
        try
        {
            var property = typeof(TItem).GetProperty(ValueProperty);
            return property?.GetValue(item) ?? item;
        }
        catch
        {
            return item;
        }
    }

    /// <summary>檢查兩個項目是否相同</summary>
    private bool AreItemsEqual(TItem item1, TItem item2)
    {
        if (item1 == null && item2 == null) return true;
        if (item1 == null || item2 == null) return false;
        
        return Equals(GetItemValue(item1), GetItemValue(item2));
    }

    /// <summary>新增項目到已選清單</summary>
    private async Task AddItem(TItem item)
    {
        if (item == null || SelectedItems.Any(s => AreItemsEqual(s, item))) 
            return;
        
        SelectedItems.Add(item);
        await SelectedItemsChanged.InvokeAsync(SelectedItems);
        StateHasChanged();
    }

    /// <summary>從已選清單移除項目</summary>
    private async Task RemoveItem(TItem item)
    {
        if (item == null) return;
        
        var itemToRemove = SelectedItems.FirstOrDefault(s => AreItemsEqual(s, item));
        if (itemToRemove != null)
        {
            SelectedItems.Remove(itemToRemove);
            await SelectedItemsChanged.InvokeAsync(SelectedItems);
            StateHasChanged();
        }
    }

    }
