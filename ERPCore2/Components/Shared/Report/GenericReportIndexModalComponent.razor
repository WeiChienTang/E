@using ERPCore2.Models
@using ERPCore2.Models.Reports
@inject IStringLocalizer<SharedResource> L

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@Title"
                   Icon="@Icon"
                   Size="BaseModalComponent.ModalSize.Desktop"
                   HeaderColor="BaseModalComponent.HeaderVariant.ProjectPrimary"
                   UseWhiteCloseButton="true"
                   BodyCssClass="p-0"
                   OnClose="@HandleClose">

    <BodyContent>
        <div class="p-3">
            @if (Reports == null || !Reports.Any())
            {
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    @L["Report.NoReports"]
                </div>
            }
            else
            {
                @* 搜尋區域 *@
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text"
                               class="form-control"
                               placeholder="@L["Report.SearchPlaceholder"]"
                               @bind="searchKeyword"
                               @bind:event="oninput" />
                        @if (!string.IsNullOrEmpty(searchKeyword))
                        {
                            <button class="btn btn-outline-secondary" type="button" @onclick="ClearSearch">
                                <i class="bi bi-x"></i>
                            </button>
                        }
                    </div>
                </div>

                <InteractiveTableComponent TItem="ReportDefinition"
                                          Items="@FilteredReports"
                                          ColumnDefinitions="@columnDefinitions"
                                          ShowRowNumbers="true"
                                          IsReadOnly="true"
                                          ShowBuiltInActions="true"
                                          ShowBuiltInDeleteButton="false"
                                          IsStriped="true"
                                          IsHoverable="true"
                                          IsBordered="true"
                                          EnableRowClick="true"
                                          OnRowClick="@HandleRowClick"
                                          EmptyMessage="@GetEmptyMessage()">
                    <CustomActionsTemplate>
                        @{
                            var report = context;
                            var isEnabled = report.IsEnabled;
                        }
                        <GenericButtonComponent Variant="@(isEnabled ? ButtonVariant.DarkBlue : ButtonVariant.Gray)"
                                              Size="ButtonSize.Small"
                                              Text="@L["Report.GoTo"]"
                                              IsDisabled="@(!isEnabled)"
                                              Title="@(isEnabled ? $"{L["Report.GoTo"]} {GetLocalizedName(report)}" : L["Report.NotAvailable"].ToString())"
                                              OnClick="@(() => HandlePrintClick(report))" />
                    </CustomActionsTemplate>
                </InteractiveTableComponent>

                @* 說明區塊 *@
                <div class="mt-3 text-muted small">
                    <i class="bi bi-info-circle me-1"></i>
                    @L["Report.InstructionText"]
                </div>
            }
        </div>
    </BodyContent>

</BaseModalComponent>

@code {
    // ===== 參數定義 =====

    /// <summary>
    /// Modal 是否顯示
    /// </summary>
    [Parameter]
    public bool IsVisible { get; set; }

    /// <summary>
    /// Modal 顯示狀態變更事件
    /// </summary>
    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    /// <summary>
    /// Modal 標題
    /// </summary>
    [Parameter]
    public string Title { get; set; } = "報表中心";

    /// <summary>
    /// Modal 圖示
    /// </summary>
    [Parameter]
    public string Icon { get; set; } = "bi-printer";

    /// <summary>
    /// 報表清單
    /// </summary>
    [Parameter]
    public IEnumerable<ReportDefinition>? Reports { get; set; }

    /// <summary>
    /// 報表選擇事件（傳遞 ActionId）
    /// </summary>
    [Parameter]
    public EventCallback<string> OnReportSelected { get; set; }

    /// <summary>
    /// 關閉事件
    /// </summary>
    [Parameter]
    public EventCallback OnClose { get; set; }

    // ===== 私有欄位 =====

    private List<InteractiveColumnDefinition> columnDefinitions = new();
    private string searchKeyword = string.Empty;

    // ===== 計算屬性 =====

    /// <summary>
    /// 篩選後的報表清單
    /// </summary>
    private List<ReportDefinition> FilteredReports
    {
        get
        {
            if (Reports == null)
                return new List<ReportDefinition>();

            var result = Reports.AsEnumerable();

            // 關鍵字搜尋（原始中文名稱 + 本地化名稱）
            if (!string.IsNullOrWhiteSpace(searchKeyword))
            {
                var keyword = searchKeyword.Trim().ToLower();
                result = result.Where(r =>
                    r.Name.ToLower().Contains(keyword) ||
                    (r.NameKey != null && L[r.NameKey].ToString()!.ToLower().Contains(keyword)));
            }

            return result.OrderBy(r => r.SortOrder).ToList();
        }
    }

    // ===== 生命週期方法 =====

    protected override void OnInitialized()
    {
        InitializeColumnDefinitions();
    }

    private void InitializeColumnDefinitions()
    {
        columnDefinitions = new List<InteractiveColumnDefinition>
        {
            new InteractiveColumnDefinition
            {
                PropertyName = "Name",
                Title = L["Report.NameColumn"],
                ColumnType = InteractiveColumnType.Display,
                Width = "200px",
                DisplayFormatter = (item) =>
                {
                    var report = item as ReportDefinition;
                    return GetLocalizedName(report);
                }
            },
            new InteractiveColumnDefinition
            {
                PropertyName = "Description",
                Title = L["Report.DescriptionColumn"],
                ColumnType = InteractiveColumnType.Display
            }
        };
    }

    // ===== 輔助方法 =====

    private string GetLocalizedName(ReportDefinition? report)
    {
        if (report == null) return "";
        if (report.NameKey != null)
            return L[report.NameKey].ToString() ?? report.Name;
        return report.Name;
    }

    // ===== 事件處理方法 =====

    private async Task HandleRowClick(ReportDefinition report)
    {
        await HandlePrintClick(report);
    }

    private async Task HandlePrintClick(ReportDefinition report)
    {
        if (!report.IsEnabled)
        {
            return;
        }

        await IsVisibleChanged.InvokeAsync(false);

        if (OnReportSelected.HasDelegate && !string.IsNullOrEmpty(report.ActionId))
        {
            await OnReportSelected.InvokeAsync(report.ActionId);
        }
    }

    private async Task HandleClose()
    {
        searchKeyword = string.Empty;

        if (OnClose.HasDelegate)
        {
            await OnClose.InvokeAsync();
        }
    }

    private void ClearSearch()
    {
        searchKeyword = string.Empty;
    }

    private string GetEmptyMessage()
    {
        if (!string.IsNullOrWhiteSpace(searchKeyword))
        {
            return string.Format(L["Report.SearchEmpty"], searchKeyword);
        }
        return L["Report.NoReports"];
    }
}
