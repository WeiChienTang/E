@page "/auth/login"
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using Microsoft.AspNetCore.Authentication.Cookies
@inject NavigationManager Navigation
@inject ERPCore2.Services.IAuthenticationService AuthenticationService

<PageTitle>ç™»å…¥ - ERPCore2</PageTitle>

<div class="container-fluid vh-100 d-flex align-items-center justify-content-center bg-light">
    <div class="card shadow-lg" style="width: 400px;">
        <div class="card-header bg-primary text-white text-center">
            <h4 class="mb-0">
                <i class="fas fa-sign-in-alt me-2"></i>
                ERPCore2 ç™»å…¥
            </h4>
        </div>
        <div class="card-body p-4">
            <form @onsubmit="@HandleLoginSubmit" @onsubmit:preventDefault="true">
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        @errorMessage
                    </div>
                }

                <div class="mb-3">
                    <label for="username" class="form-label">
                        <i class="fas fa-user me-2"></i>ä½¿ç”¨è€…åç¨±
                    </label>
                    <input @bind="loginModel.Username" 
                           class="form-control" 
                           id="username" 
                           type="text"
                           placeholder="è«‹è¼¸å…¥ä½¿ç”¨è€…åç¨±" 
                           required />
                </div>
                
                <div class="mb-3">
                    <label for="password" class="form-label">
                        <i class="fas fa-lock me-2"></i>å¯†ç¢¼
                    </label>
                    <input @bind="loginModel.Password" 
                           type="password" 
                           class="form-control" 
                           id="password" 
                           placeholder="è«‹è¼¸å…¥å¯†ç¢¼" 
                           required />
                </div>
                
                <div class="mb-3 form-check">
                    <input @bind="loginModel.RememberMe" 
                           class="form-check-input" 
                           type="checkbox"
                           id="rememberMe" />
                    <label class="form-check-label" for="rememberMe">
                        è¨˜ä½æˆ‘
                    </label>
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-primary" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>ç™»å…¥ä¸­...</span>
                        }
                        else
                        {
                            <i class="fas fa-sign-in-alt me-2"></i>
                            <span>ç™»å…¥</span>
                        }
                    </button>
                </div>
            </form>
        </div>
        <div class="card-footer text-center text-muted">
            <small>ERPCore2 ä¼æ¥­è³‡æºè¦åŠƒç³»çµ±</small>
        </div>
    </div>
</div>

@code {
    private LoginModel loginModel = new();
    private string errorMessage = string.Empty;
    private bool isLoading = false;

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    protected override void OnInitialized()
    {
        Console.WriteLine("ğŸš€ Login çµ„ä»¶åˆå§‹åŒ–é–‹å§‹");
        loginModel ??= new LoginModel();
        Console.WriteLine($"ReturnUrl: '{ReturnUrl}'");
        Console.WriteLine("âœ… Login çµ„ä»¶åˆå§‹åŒ–å®Œæˆ");
    }    private async Task HandleLoginSubmit()
    {
        Console.WriteLine("=== HandleLoginSubmit é–‹å§‹ (ç›´æ¥ Blazor æ¨¡å¼) ===");
        
        // é˜²æ­¢é‡è¤‡æäº¤
        if (isLoading) 
        {
            Console.WriteLine("âŒ ç”±æ–¼ isLoading=trueï¼Œåœæ­¢åŸ·è¡Œ");
            return;
        }

        try
        {
            isLoading = true;
            errorMessage = string.Empty;
            StateHasChanged();
            
            Console.WriteLine($"loginModel.Username: '{loginModel?.Username}'");
            Console.WriteLine($"loginModel.Password: é•·åº¦={loginModel?.Password?.Length ?? 0}");
            Console.WriteLine($"loginModel.RememberMe: {loginModel?.RememberMe}");
            
            // è¼¸å…¥å€¼æª¢æŸ¥
            if (string.IsNullOrWhiteSpace(loginModel?.Username) || string.IsNullOrWhiteSpace(loginModel?.Password))
            {
                Console.WriteLine("âŒ è¼¸å…¥é©—è­‰å¤±æ•— - ä½¿ç”¨è€…åç¨±æˆ–å¯†ç¢¼ç‚ºç©º");
                errorMessage = "è«‹è¼¸å…¥ä½¿ç”¨è€…åç¨±å’Œå¯†ç¢¼";
                return;
            }            Console.WriteLine("âœ… è¼¸å…¥é©—è­‰é€šéï¼Œæº–å‚™ç›´æ¥é©—è­‰å“¡å·¥");

            // ç›´æ¥èª¿ç”¨èªè­‰æœå‹™é€²è¡Œé©—è­‰
            var employeeResult = await AuthenticationService.LoginAsync(
                loginModel!.Username.Trim(), 
                loginModel.Password.Trim());

            if (!employeeResult.IsSuccess || employeeResult.Data == null)
            {
                Console.WriteLine($"âŒ å“¡å·¥é©—è­‰å¤±æ•—: {employeeResult.ErrorMessage}");
                errorMessage = employeeResult.ErrorMessage ?? "ä½¿ç”¨è€…åç¨±æˆ–å¯†ç¢¼éŒ¯èª¤";
                return;
            }

            var employee = employeeResult.Data;
            Console.WriteLine($"âœ… å“¡å·¥é©—è­‰æˆåŠŸ: Id={employee.Id}, Username={employee.Username}");

            // å»ºç«‹èªè­‰ Claims
            var claims = new List<Claim>
            {
                new Claim(ClaimTypes.NameIdentifier, employee.Id.ToString()),
                new Claim(ClaimTypes.Name, employee.Username),
                new Claim(ClaimTypes.GivenName, employee.FirstName ?? ""),
                new Claim(ClaimTypes.Surname, employee.LastName ?? ""),
                new Claim(ClaimTypes.Email, employee.Email ?? ""),
                new Claim("EmployeeCode", employee.EmployeeCode ?? ""),
                new Claim("Department", employee.Department ?? ""),
                new Claim("Position", employee.Position ?? "")
            };

            Console.WriteLine("ğŸ” å»ºç«‹çš„åŸºæœ¬ Claims:");
            foreach (var claim in claims)
            {
                Console.WriteLine($"  - {claim.Type}: {claim.Value}");
            }

            // åŠ å…¥è§’è‰²è²æ˜
            if (employee.Role != null)
            {
                claims.Add(new Claim(ClaimTypes.Role, employee.Role.RoleName));
                Console.WriteLine($"âœ… æ·»åŠ è§’è‰²è²æ˜: {employee.Role.RoleName}");
            }
            else
            {
                Console.WriteLine("âš ï¸ å“¡å·¥æ²’æœ‰è§’è‰²è³‡æ–™");
            }            // å»ºç«‹èº«ä»½ä¸¦åŸ·è¡Œç™»å…¥ - ä½¿ç”¨å°èˆªåˆ°èªè­‰ç«¯é»çš„æ–¹å¼
            var claimsList = new List<string>();
            foreach (var claim in claims)
            {
                claimsList.Add($"{claim.Type}|{claim.Value}");
            }
            
            // å°‡Claimsè³‡æ–™åºåˆ—åŒ–ä¸¦é€šéå°èˆªå‚³éåˆ°èªè­‰ç«¯é»
            var claimsData = string.Join(";", claimsList);
            var rememberMe = loginModel.RememberMe ? "true" : "false";
            var returnUrl = !string.IsNullOrEmpty(ReturnUrl) ? ReturnUrl : "/";
            
            Console.WriteLine($"ğŸª æº–å‚™å°èˆªåˆ°èªè­‰ç«¯é»é€²è¡ŒCookieè¨­å®š");
            Console.WriteLine($"ğŸ”„ ReturnUrl: {returnUrl}");
            
            // å°èˆªåˆ°èªè­‰ç«¯é»ä¾†è¨­ç½®Cookie
            var encodedClaimsData = Uri.EscapeDataString(claimsData);
            var encodedReturnUrl = Uri.EscapeDataString(returnUrl);
            var authUrl = $"/api/auth/signin?claims={encodedClaimsData}&remember={rememberMe}&returnUrl={encodedReturnUrl}";
            
            Console.WriteLine($"ğŸ”„ å°èˆªåˆ°: {authUrl}");
            Navigation.NavigateTo(authUrl, forceLoad: true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ğŸ’¥ HandleLoginSubmit ç™¼ç”Ÿä¾‹å¤–: {ex.GetType().Name}");
            Console.WriteLine($"ğŸ’¥ ä¾‹å¤–è¨Šæ¯: {ex.Message}");
            errorMessage = $"ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}";
        }
        finally
        {
            Console.WriteLine($"ğŸ”š HandleLoginSubmit çµæŸï¼Œè¨­å®š isLoading=false");
            isLoading = false;
            StateHasChanged();
            Console.WriteLine("=== HandleLoginSubmit å®Œæˆ ===");
        }
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "è«‹è¼¸å…¥ä½¿ç”¨è€…åç¨±")]
        public string Username { get; set; } = string.Empty;

        [Required(ErrorMessage = "è«‹è¼¸å…¥å¯†ç¢¼")]
        public string Password { get; set; } = string.Empty;

        public bool RememberMe { get; set; } = false;
    }
}
