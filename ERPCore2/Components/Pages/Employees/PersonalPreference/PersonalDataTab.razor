@* 個人資料 Tab *@
@* 帳號唯讀、姓名/手機/Email 可編輯；密碼獨立區塊 *@
@inject IStringLocalizer<SharedResource> L

<GenericFormComponent TModel="Employee"
                      Model="@(Model ?? _fallback)"
                      FieldDefinitions="@allFields"
                      FieldSections="@fieldSections" />

@* ===== 變更密碼 ===== *@
<div class="mt-4 pt-3 border-top">
    <h6 class="mb-3">
        <i class="bi bi-shield-lock me-2"></i>@L["Preference.ChangePassword"]
    </h6>
    <p class="text-muted small mb-3">@L["Password.LeaveBlank"]。</p>

    <div class="row g-3">
        <div class="col-12 col-sm-6">
            <label class="form-label fw-medium">@L["Employee.NewPassword"]</label>
            <input type="password" class="form-control" maxlength="20"
                   placeholder="@L["Placeholder.NewPassword"]"
                   value="@NewPassword"
                   @oninput="@(e => NewPasswordChanged.InvokeAsync(e.Value?.ToString() ?? string.Empty))"
                   autocomplete="new-password" />
        </div>
        <div class="col-12 col-sm-6">
            <label class="form-label fw-medium">@L["Employee.ConfirmPassword"]</label>
            <input type="password" class="form-control" maxlength="20"
                   placeholder="@L["Placeholder.ConfirmPassword"]"
                   value="@ConfirmPassword"
                   @oninput="@(e => ConfirmPasswordChanged.InvokeAsync(e.Value?.ToString() ?? string.Empty))"
                   autocomplete="new-password" />
            @if (!string.IsNullOrEmpty(NewPassword) && NewPassword != ConfirmPassword)
            {
                <div class="form-text text-danger mt-1">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    @L["Password.Mismatch"]
                </div>
            }
            else if (!string.IsNullOrEmpty(NewPassword) && NewPassword == ConfirmPassword)
            {
                <div class="form-text text-success mt-1">
                    <i class="bi bi-check-circle me-1"></i>
                    @L["Password.Match"]
                </div>
            }
            else
            {
                <div class="form-text text-muted mt-1">
                    <i class="bi bi-info-circle me-1"></i>
                    @L["Password.LeaveBlank"]
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public Employee? Model { get; set; }

    [Parameter]
    public string NewPassword { get; set; } = string.Empty;

    [Parameter]
    public EventCallback<string> NewPasswordChanged { get; set; }

    [Parameter]
    public string ConfirmPassword { get; set; } = string.Empty;

    [Parameter]
    public EventCallback<string> ConfirmPasswordChanged { get; set; }

    private readonly Employee _fallback = new();

    private List<FormFieldDefinition> allFields = new();
    private Dictionary<string, string> fieldSections = new();

    protected override void OnInitialized()
    {
        allFields = new List<FormFieldDefinition>
        {
            new FormFieldDefinition
            {
                PropertyName = nameof(Employee.Account),
                Label = L["Employee.Account"],
                FieldType = FormFieldType.Text,
                IsReadOnly = true,
                HelpText = L["Employee.AccountHelpText"]
            },
            new FormFieldDefinition
            {
                PropertyName = nameof(Employee.Name),
                Label = L["Employee.Name"],
                FieldType = FormFieldType.Text,
                IsRequired = true,
                MaxLength = 10,
                Placeholder = L["Placeholder.Name"]
            },
            new FormFieldDefinition
            {
                PropertyName = nameof(Employee.Mobile),
                Label = L["Employee.Mobile"],
                FieldType = FormFieldType.MobilePhone,
                Placeholder = L["Placeholder.MobilePhone"]
            },
            new FormFieldDefinition
            {
                PropertyName = nameof(Employee.Email),
                Label = L["Employee.Email"],
                FieldType = FormFieldType.Text,
                MaxLength = 50,
                Placeholder = L["Placeholder.Email"]
            }
        };

        fieldSections = new Dictionary<string, string>
        {
            { nameof(Employee.Account), L["Preference.AccountInfo"] },
            { nameof(Employee.Name),    L["Preference.BasicInfo"] },
            { nameof(Employee.Mobile),  L["Preference.BasicInfo"] },
            { nameof(Employee.Email),   L["Preference.BasicInfo"] }
        };
    }
}
