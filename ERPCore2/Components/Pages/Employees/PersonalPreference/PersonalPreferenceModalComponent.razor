@* 個人化設定 Modal *@
@using Microsoft.AspNetCore.Components.Authorization
@inject IEmployeePreferenceService EmployeePreferenceService
@inject IEmployeeService EmployeeService
@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@inject IStringLocalizer<SharedResource> L

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@L["Preference.Title"]"
                   Icon="bi bi-person-gear"
                   HeaderColor="BaseModalComponent.HeaderVariant.ProjectPrimary"
                   IsLoading="@isLoading"
                   LoadingMessage="@L["Preference.LoadingMessage"]"
                   OnClose="@HandleClose">

    <HeaderButtons>
        <div class="d-flex gap-2 align-items-center">
            <GenericButtonComponent Variant="ButtonVariant.Green"
                                  Size="ButtonSize.Small"
                                  Text="@L["Button.Save"]"
                                  Icon="bi bi-check-lg"
                                  OnClick="HandleSave"
                                  IsDisabled="@isLoading"
                                  Title="@L["Preference.SaveTooltip"]" />
        </div>
    </HeaderButtons>

    <BodyContent>
        <GenericFormComponent TModel="EmployeePreference"
                              Model="@employeePreference"
                              FieldDefinitions="@allFields"
                              FieldSections="@fieldSections"
                              TabDefinitions="@tabDefinitions" />
    </BodyContent>

</BaseModalComponent>

@code {
    // ===== 參數 =====

    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    [Parameter]
    public EventCallback OnSaved { get; set; }

    // ===== 私有欄位 =====

    private bool isLoading = false;
    private int? currentEmployeeId = null;

    // 語言偏好 + 字型縮放
    private EmployeePreference employeePreference = new();
    private UILanguage _originalLanguage = UILanguage.ZhTW;   // 記錄載入時的語言，用於判斷是否需要 reload
    private ContentZoom _originalZoom = ContentZoom.Medium;    // 記錄載入時的縮放，用於判斷是否需要套用

    // 個人資料
    private Employee? currentEmployee = null;
    private string newPassword = string.Empty;
    private string confirmPassword = string.Empty;

    // Tab 定義
    private readonly List<FormFieldDefinition> allFields = new();
    private readonly Dictionary<string, string> fieldSections = new();
    private List<FormTabDefinition> tabDefinitions = new();

    // ===== Tab RenderFragment =====

    private RenderFragment CreatePersonalDataTabContent() => __builder =>
    {
        <PersonalDataTab Model="@currentEmployee"
                         NewPassword="@newPassword"
                         NewPasswordChanged="@((pwd) => { newPassword = pwd; StateHasChanged(); })"
                         ConfirmPassword="@confirmPassword"
                         ConfirmPasswordChanged="@((pwd) => { confirmPassword = pwd; StateHasChanged(); })" />
    };

    private RenderFragment CreateLanguageRegionTabContent() => __builder =>
    {
        <LanguageRegionTab Model="@employeePreference" />
    };

    private RenderFragment CreateDisplayTabContent() => __builder =>
    {
        <DisplayTab Model="@employeePreference" />
    };

    // ===== 生命週期 =====

    protected override void OnInitialized()
    {
        tabDefinitions = new List<FormTabDefinition>
        {
            new() { Label = L["Preference.PersonalData"], Icon = "bi bi-person", SectionNames = new(), CustomContent = CreatePersonalDataTabContent() },
            new() { Label = L["Preference.LanguageRegion"], Icon = "bi bi-translate", SectionNames = new(), CustomContent = CreateLanguageRegionTabContent() },
            new() { Label = L["Preference.Display"], Icon = "bi bi-type", SectionNames = new(), CustomContent = CreateDisplayTabContent() }
        };
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isLoading && currentEmployeeId == null)
        {
            await LoadDataAsync();
        }
    }

    // ===== 資料載入 =====

    private async Task LoadDataAsync()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            currentEmployeeId = await CurrentUserHelper.GetCurrentEmployeeIdAsync(AuthenticationStateProvider);

            if (currentEmployeeId.HasValue)
            {
                // 載入語言偏好，並記錄原始值供儲存後比對
                employeePreference = await EmployeePreferenceService.GetByEmployeeIdAsync(currentEmployeeId.Value);
                _originalLanguage = employeePreference.Language;
                _originalZoom = employeePreference.Zoom;

                // 載入員工個人資料
                currentEmployee = await EmployeeService.GetByIdAsync(currentEmployeeId.Value);
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync(L["Error.LoadFailed", ex.Message]);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // ===== 事件處理 =====

    private async Task HandleSave()
    {
        if (!currentEmployeeId.HasValue)
        {
            await NotificationService.ShowErrorAsync(L["Error.UnknownUser"]);
            return;
        }

        // 密碼確認驗證
        if (!string.IsNullOrEmpty(newPassword) && newPassword != confirmPassword)
        {
            await NotificationService.ShowErrorAsync(L["Error.PasswordMismatch"]);
            return;
        }

        try
        {
            isLoading = true;
            StateHasChanged();

            // 1. 儲存語言偏好
            var preferenceResult = await EmployeePreferenceService.SavePreferenceAsync(currentEmployeeId.Value, employeePreference);

            if (!preferenceResult.IsSuccess)
            {
                await NotificationService.ShowErrorAsync(L["Error.SavePreferenceFailed", preferenceResult.ErrorMessage ?? ""]);
                return;
            }

            // 2. 儲存個人資料
            if (currentEmployee != null)
            {
                var profileResult = await EmployeeService.UpdateSelfProfileAsync(
                    currentEmployeeId.Value,
                    currentEmployee.Name ?? string.Empty,
                    currentEmployee.Mobile,
                    currentEmployee.Email,
                    string.IsNullOrWhiteSpace(newPassword) ? null : newPassword
                );

                if (!profileResult.IsSuccess)
                {
                    await NotificationService.ShowErrorAsync(L["Error.SaveProfileFailed", profileResult.ErrorMessage ?? ""]);
                    return;
                }
            }

            await NotificationService.ShowSuccessAsync(L["Preference.SaveSuccess"]);

            if (OnSaved.HasDelegate)
                await OnSaved.InvokeAsync();

            // 字型縮放若有變更，即時套用（寫 cookie + 更新 CSS variable，不需 reload）
            if (employeePreference.Zoom != _originalZoom)
            {
                await JSRuntime.InvokeVoidAsync("setContentZoom", (int)employeePreference.Zoom);
                _originalZoom = employeePreference.Zoom;
            }

            // 語言若與目前 UI 文化不同，寫入 cookie 並重新載入頁面以套用新語言
            var newCultureCode = ERPCore2.Helpers.CultureHelper.ToCultureCode(employeePreference.Language);
            if (newCultureCode != System.Globalization.CultureInfo.CurrentUICulture.Name)
            {
                await JSRuntime.InvokeVoidAsync("setCultureAndReload", newCultureCode);
                return; // reload 後頁面會重整，不需要繼續執行
            }

            await CloseModalAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync(L["Error.SaveFailed", ex.Message]);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleClose()
    {
        await CloseModalAsync();
    }

    private async Task CloseModalAsync()
    {
        // 關閉時重置狀態，下次開啟時重新載入
        currentEmployeeId = null;
        currentEmployee = null;
        employeePreference = new();
        _originalLanguage = UILanguage.ZhTW;
        _originalZoom = ContentZoom.Medium;
        newPassword = string.Empty;
        confirmPassword = string.Empty;

        if (IsVisibleChanged.HasDelegate)
            await IsVisibleChanged.InvokeAsync(false);
    }
}
