@* 身分權限管理 Modal 組件 - 不使用路由，純 Modal 彈窗 *@
@using ERPCore2.Data.Entities
@inject IRoleService RoleService
@inject IPermissionManagementService PermissionManagementService
@inject INotificationService NotificationService
@inject IJSRuntime JSRuntime

@* 身分權限管理 Modal *@
<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@HandleModalVisibilityChanged"
                   Title="身分權限設定"
                   Icon="bi bi-shield-lock"
                   Size="BaseModalComponent.ModalSize.Desktop"
                   HeaderColor="BaseModalComponent.HeaderVariant.ProjectPrimary"
                   ShowFooter="false"
                   ShowCloseButton="true"
                   CloseOnBackdropClick="true">
    <BodyContent>
        @* 區塊 1: 身分選擇區域 *@
        <div class="mb-4">
            @if (isLoadingRoles)
            {
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">載入中...</span>
                    </div>
                    <p class="mt-2 text-muted">載入身分資料中...</p>
                </div>
            }
            else if (roles.Any())
            {
                <div class="row align-items-end">
                    <div class="col-md-8">
                        <select id="roleSelect" 
                                class="form-select" 
                                @onchange="HandleRoleSelectionChanged"
                                disabled="@isSaving">
                            <option value="">請選擇要設定的身分 ... </option>
                            @foreach (var role in roles)
                            {
                                <option value="@role.Id" selected="@(role.Id == selectedRole?.Id)">
                                    @role.Name
                                </option>
                            }
                        </select>
                    </div>
                    
                    @* 操作按鈕組 *@
                    @if (selectedRole != null && !IsAdminRole(selectedRole))
                    {
                        <div class="col-md-4">
                            <div class="d-flex gap-2 justify-content-end flex-wrap mt-3 mt-md-0">
                                <div class="dropdown">
                                    <GenericButtonComponent Text="複製"
                                                        Variant="ButtonVariant.Gray"
                                                        Size="ButtonSize.Small"
                                                        IsDisabled="@isSaving"
                                                        AdditionalAttributes="@(new Dictionary<string, object> 
                                                        { 
                                                            { "data-bs-toggle", "dropdown" },
                                                            { "aria-expanded", "false" }
                                                        })" />
                                    <ul class="dropdown-menu">
                                        <li><h6 class="dropdown-header">選擇複製對象</h6></li>
                                        @foreach (var role in roles.Where(r => r.Id != selectedRole.Id && !IsAdminRole(r)))
                                        {
                                            <li>
                                                <a class="dropdown-item" href="#" @onclick="() => CopyPermissionsFromRole(role.Id)" @onclick:preventDefault="true">
                                                    @role.Name
                                                </a>
                                            </li>
                                        }
                                        @if (!roles.Any(r => r.Id != selectedRole.Id && !IsAdminRole(r)))
                                        {
                                            <li><span class="dropdown-item-text text-muted">沒有可複製的對象</span></li>
                                        }
                                    </ul>
                                </div>
                                <GenericButtonComponent Text="全選"
                                                    Variant="ButtonVariant.Green"
                                                    Size="ButtonSize.Small"
                                                    OnClick="SelectAllPermissions"
                                                    IsDisabled="@isSaving"
                                                    Tooltip="僅選擇一般權限，系統權限需手動選擇" />
                                <GenericButtonComponent Text="全清"
                                                    Variant="ButtonVariant.Yellow"
                                                    Size="ButtonSize.Small"
                                                    OnClick="ClearAllPermissions"
                                                    IsDisabled="@isSaving"
                                                    Tooltip="僅清除一般權限，系統權限需手動取消" />
                                <GenericButtonComponent Text="儲存"
                                                    Variant="ButtonVariant.DarkBlue"
                                                    Size="ButtonSize.Small"
                                                    OnClick="SaveRolePermissions"
                                                    IsDisabled="@isSaving"
                                                    IsLoading="@isSaving" />
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    尚未建立任何身分
                </div>
            }
        </div>

        @* 區塊 2: 權限設定區域 *@
        @if (selectedRole != null)
        {
            <div class="border-top pt-4">
                @if (isLoadingPermissions)
                {
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">載入中...</span>
                        </div>
                        <p class="mt-2 text-muted">載入權限資料中...</p>
                    </div>
                }
                else
                {
                    @* 操作說明（僅非管理員身分顯示） *@
                    @if (!IsAdminRole(selectedRole))
                    {
                        <div class="alert alert-info mb-1">
                            <i class="bi bi-lightbulb me-1"></i>
                            <strong>提示：</strong>「全選」/「全清」按鈕僅影響一般權限，系統權限需要手動點擊個別選擇以確保安全性。
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info mb-1">
                            <i class="bi bi-lightbulb me-1"></i>
                            <strong>提示：</strong> 管理員身分擁有所有權限。
                        </div>
                    }
                    
                    @* 一般權限表格 *@
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="bi bi-list-ul me-2"></i>一般權限
                        </h6>
                        <InteractiveTableComponent TItem="Permission"
                                                  Items="@GetNormalPermissions()"
                                                  ColumnDefinitions="@normalPermissionColumns"
                                                  ShowHeader="true"
                                                  ShowRowNumbers="false"
                                                  ShowActions="false"
                                                  IsStriped="true"
                                                  IsHoverable="true"
                                                  IsBordered="true"
                                                  IsReadOnly="@IsAdminRole(selectedRole)"
                                                  EmptyMessage="沒有找到權限資料"
                                                  GetRowCssClass="@GetPermissionRowClass"
                                                  EnableRowClick="@(!IsAdminRole(selectedRole))"
                                                  OnRowClick="@HandlePermissionRowClick" />
                    </div>
                    
                    @* 系統權限表格（如果有） *@
                    @if (permissions.Any(p => IsSystemPermission(p)))
                    {
                        <div class="mt-4">
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>注意：</strong>以下為系統核心權限，@(IsAdminRole(selectedRole) ? "管理員身分擁有所有權限。" : "請謹慎授權！這些權限可能影響系統安全性和穩定性。")
                            </div>
                            <h6 class="mb-3 text-danger">
                                <i class="bi bi-shield-exclamation me-2"></i>系統權限
                            </h6>
                            <InteractiveTableComponent TItem="Permission"
                                                      Items="@GetSystemPermissions()"
                                                      ColumnDefinitions="@systemPermissionColumns"
                                                      ShowHeader="true"
                                                      ShowRowNumbers="false"
                                                      ShowActions="false"
                                                      IsStriped="true"
                                                      IsHoverable="true"
                                                      IsBordered="true"
                                                      IsReadOnly="@IsAdminRole(selectedRole)"
                                                      CssClass="table-danger"
                                                      EmptyMessage="沒有找到系統權限資料"
                                                      GetRowCssClass="@GetPermissionRowClass"
                                                      EnableRowClick="@(!IsAdminRole(selectedRole))"
                                                      OnRowClick="@HandlePermissionRowClick" />
                        </div>
                    }
                }
            </div>
        }
    </BodyContent>
</BaseModalComponent>

@code {
    // ===== 參數 =====
    
    /// <summary>
    /// Modal 是否顯示（由外部控制）
    /// </summary>
    [Parameter]
    public bool IsVisible { get; set; }
    
    /// <summary>
    /// Modal 顯示狀態變更事件
    /// </summary>
    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }
    
    // ===== 內部狀態 =====
    
    // 資料模型
    private List<Role> roles = new();
    private List<Permission> permissions = new();
    private Role? selectedRole;
    private Dictionary<int, bool> permissionSelections = new();
    
    // 載入狀態
    private bool isLoadingRoles = true;
    private bool isLoadingPermissions = false;
    private bool isSaving = false;
    
    // 表格欄位定義
    private List<InteractiveColumnDefinition> normalPermissionColumns = new();
    private List<InteractiveColumnDefinition> systemPermissionColumns = new();
    
    // ===== 生命週期 =====
    
    protected override async Task OnParametersSetAsync()
    {
        // 當 Modal 被開啟時，初始化資料
        if (IsVisible && !roles.Any())
        {
            await LoadDataAsync();
        }
    }
    
    private async Task LoadDataAsync()
    {
        try
        {
            InitializeColumnDefinitions();
            await LoadRolesAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDataAsync), GetType(), 
                additionalData: "初始化身分權限管理資料失敗");
            await NotificationService.ShowErrorAsync("初始化資料失敗");
        }
        finally
        {
            isLoadingRoles = false;
        }
    }
    
    private void InitializeColumnDefinitions()
    {
        // 一般權限表格欄位定義（顯示選擇欄）
        normalPermissionColumns = new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = "選擇",
                PropertyName = nameof(Permission.Id),
                ColumnType = InteractiveColumnType.Custom,
                Width = "80px",
                CellCssClass = "text-center",
                HeaderCssClass = "text-center",
                CustomTemplate = permission => builder =>
                {
                    var p = (Permission)permission;
                    var isChecked = permissionSelections.GetValueOrDefault(p.Id, false);
                    var isDisabled = IsAdminRole(selectedRole);
                    
                    builder.OpenElement(0, "div");
                    builder.AddAttribute(1, "class", "form-check form-switch d-flex justify-content-center");
                    
                    builder.OpenElement(2, "input");
                    builder.AddAttribute(3, "class", "form-check-input");
                    builder.AddAttribute(4, "type", "checkbox");
                    builder.AddAttribute(5, "checked", isChecked);
                    builder.AddAttribute(6, "disabled", isDisabled);
                    builder.AddAttribute(7, "onchange", EventCallback.Factory.Create<ChangeEventArgs>(
                        this, async e => await HandlePermissionCheckboxChanged(p, e.Value is bool b && b)));
                    builder.CloseElement();
                    
                    builder.CloseElement();
                }
            },
            new()
            {
                Title = "權限名稱",
                PropertyName = nameof(Permission.Name),
                ColumnType = InteractiveColumnType.Display,
                Width = "25%"
            },
            new()
            {
                Title = "權限代碼",
                PropertyName = nameof(Permission.Code),
                ColumnType = InteractiveColumnType.Display,
                Width = "30%",
                CellCssClass = "font-monospace",
                HideOnMobile = true
            },
            new()
            {
                Title = "備註",
                PropertyName = nameof(Permission.Remarks),
                ColumnType = InteractiveColumnType.Display,
                DisplayFormatter = value => string.IsNullOrEmpty(value?.ToString()) ? "-" : value.ToString()!
            }
        };
        
        // 系統權限表格欄位定義（與一般權限相同，但樣式不同）
        systemPermissionColumns = new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = "選擇",
                PropertyName = nameof(Permission.Id),
                ColumnType = InteractiveColumnType.Custom,
                Width = "80px",
                CellCssClass = "text-center",
                HeaderCssClass = "text-center",
                CustomTemplate = permission => builder =>
                {
                    var p = (Permission)permission;
                    var isChecked = permissionSelections.GetValueOrDefault(p.Id, false);
                    var isDisabled = IsAdminRole(selectedRole);
                    
                    builder.OpenElement(0, "div");
                    builder.AddAttribute(1, "class", "form-check form-switch d-flex justify-content-center");
                    
                    builder.OpenElement(2, "input");
                    builder.AddAttribute(3, "class", "form-check-input");
                    builder.AddAttribute(4, "type", "checkbox");
                    builder.AddAttribute(5, "checked", isChecked);
                    builder.AddAttribute(6, "disabled", isDisabled);
                    builder.AddAttribute(7, "onchange", EventCallback.Factory.Create<ChangeEventArgs>(
                        this, async e => await HandlePermissionCheckboxChanged(p, e.Value is bool b && b)));
                    builder.CloseElement();
                    
                    builder.CloseElement();
                }
            },
            new()
            {
                Title = "權限名稱",
                PropertyName = nameof(Permission.Name),
                ColumnType = InteractiveColumnType.Display,
                Width = "25%",
                CellCssClass = "text-danger fw-bold"
            },
            new()
            {
                Title = "權限代碼",
                PropertyName = nameof(Permission.Code),
                ColumnType = InteractiveColumnType.Display,
                Width = "30%",
                CellCssClass = "font-monospace text-danger",
                HideOnMobile = true
            },
            new()
            {
                Title = "備註",
                PropertyName = nameof(Permission.Remarks),
                ColumnType = InteractiveColumnType.Display,
                CellCssClass = "text-danger",
                DisplayFormatter = value => string.IsNullOrEmpty(value?.ToString()) ? "-" : value.ToString()!
            }
        };
    }
    
    private async Task LoadRolesAsync()
    {
        try
        {
            roles = (await DataLoaderHelper.LoadAsync(
                RoleService.GetAllAsync, 
                "身分", 
                NotificationService, 
                GetType()))
                .OrderBy(r => r.Name)
                .ToList();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadRolesAsync), GetType());
            await NotificationService.ShowErrorAsync("載入身分資料失敗");
            roles = new List<Role>();
        }
    }
    
    private async Task LoadPermissionsAsync()
    {
        if (selectedRole == null) return;
        
        try
        {
            isLoadingPermissions = true;
            StateHasChanged();
            
            // 載入所有權限
            var allPermissions = await PermissionManagementService.GetAllAsync();
            if (allPermissions != null)
            {
                permissions = allPermissions.OrderBy(p => p.Code).ToList();
            }
            
            // 載入身分已有的權限
            var roleData = await RoleService.GetByIdAsync(selectedRole.Id);
            if (roleData != null)
            {
                var rolePermissions = roleData.RolePermissions
                    .Where(rp => rp.Status == EntityStatus.Active)
                    .Select(rp => rp.Permission)
                    .ToList();
                
                // 初始化權限選擇狀態
                permissionSelections.Clear();
                foreach (var permission in permissions)
                {
                    permissionSelections[permission.Id] = rolePermissions.Any(rp => rp.Id == permission.Id);
                }
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadPermissionsAsync), GetType());
            await NotificationService.ShowErrorAsync("載入權限資料時發生錯誤");
        }
        finally
        {
            isLoadingPermissions = false;
            StateHasChanged();
        }
    }
    
    // ===== 事件處理 =====
    
    /// <summary>
    /// 處理 Modal 顯示狀態變更（當使用者關閉 Modal 時）
    /// </summary>
    private async Task HandleModalVisibilityChanged(bool visible)
    {
        // 通知父組件狀態變更
        await IsVisibleChanged.InvokeAsync(visible);
    }
    
    /// <summary>
    /// 處理身分選擇變更
    /// </summary>
    private async Task HandleRoleSelectionChanged(ChangeEventArgs e)
    {
        try
        {
            if (int.TryParse(e.Value?.ToString(), out int roleId) && roleId > 0)
            {
                selectedRole = roles.FirstOrDefault(r => r.Id == roleId);
                if (selectedRole != null)
                {
                    await LoadPermissionsAsync();
                }
            }
            else
            {
                selectedRole = null;
                permissionSelections.Clear();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleRoleSelectionChanged), GetType());
        }
    }
    
    /// <summary>
    /// 處理權限勾選框變更
    /// </summary>
    private async Task HandlePermissionCheckboxChanged(Permission permission, bool isChecked)
    {
        if (selectedRole == null || IsAdminRole(selectedRole))
        {
            return;
        }
        
        permissionSelections[permission.Id] = isChecked;
        StateHasChanged();
        
        await Task.CompletedTask;
    }
    
    /// <summary>
    /// 處理權限行點擊（切換選取狀態）
    /// </summary>
    private async Task HandlePermissionRowClick(Permission permission)
    {
        if (selectedRole == null || IsAdminRole(selectedRole))
        {
            return;
        }
        
        var currentValue = permissionSelections.GetValueOrDefault(permission.Id, false);
        permissionSelections[permission.Id] = !currentValue;
        StateHasChanged();
        
        await Task.CompletedTask;
    }
    
    /// <summary>
    /// 全選權限 - 僅選擇一般權限
    /// </summary>
    private void SelectAllPermissions()
    {
        if (selectedRole == null || IsAdminRole(selectedRole))
        {
            return;
        }
        
        foreach (var permission in permissions)
        {
            // 只自動選擇一般權限，系統權限需要使用者手動點擊
            if (!IsSystemPermission(permission))
            {
                permissionSelections[permission.Id] = true;
            }
        }
        StateHasChanged();
    }
    
    /// <summary>
    /// 清除所有權限 - 僅清除一般權限
    /// </summary>
    private void ClearAllPermissions()
    {
        if (selectedRole == null || IsAdminRole(selectedRole))
        {
            return;
        }
        
        foreach (var permission in permissions)
        {
            // 只自動清除一般權限，系統權限需要使用者手動點擊
            if (!IsSystemPermission(permission))
            {
                permissionSelections[permission.Id] = false;
            }
        }
        StateHasChanged();
    }
    
    /// <summary>
    /// 複製其他身分的權限
    /// </summary>
    private async Task CopyPermissionsFromRole(int sourceRoleId)
    {
        if (selectedRole == null || isSaving)
        {
            return;
        }
        
        try
        {
            isSaving = true;
            StateHasChanged();
            
            var sourceRole = roles.FirstOrDefault(r => r.Id == sourceRoleId);
            if (sourceRole == null)
            {
                await NotificationService.ShowErrorAsync("來源身分不存在");
                return;
            }
            
            // 檢查來源身分是否為管理員身分
            if (IsAdminRole(sourceRole))
            {
                await NotificationService.ShowWarningAsync("無法複製管理員身分的權限");
                return;
            }
            
            // 取得來源身分的權限
            var sourceRoleData = await RoleService.GetByIdAsync(sourceRoleId);
            if (sourceRoleData == null)
            {
                await NotificationService.ShowErrorAsync("載入來源身分權限時發生錯誤");
                return;
            }
            
            // 更新權限選擇狀態
            permissionSelections.Clear();
            var sourcePermissionIds = sourceRoleData.RolePermissions
                .Where(rp => rp.Status == EntityStatus.Active)
                .Select(rp => rp.PermissionId)
                .ToHashSet();
            
            foreach (var permission in permissions)
            {
                permissionSelections[permission.Id] = sourcePermissionIds.Contains(permission.Id);
            }
            
            StateHasChanged();
            await NotificationService.ShowSuccessAsync($"已成功複製身分「{sourceRole.Name}」的權限設定");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(CopyPermissionsFromRole), GetType());
            await NotificationService.ShowErrorAsync("複製權限時發生錯誤");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// 儲存身分權限
    /// </summary>
    private async Task SaveRolePermissions()
    {
        if (selectedRole == null)
        {
            await NotificationService.ShowWarningAsync("請先選擇一個身分");
            return;
        }
        
        // 檢查是否為管理員身分
        if (IsAdminRole(selectedRole))
        {
            await NotificationService.ShowWarningAsync("管理員身分的權限無法修改");
            return;
        }
        
        try
        {
            isSaving = true;
            StateHasChanged();
            
            var selectedPermissionIds = permissionSelections
                .Where(kvp => kvp.Value)
                .Select(kvp => kvp.Key)
                .ToList();
            
            // 檢查是否授予了系統權限，需要確認
            var selectedPermissions = permissions
                .Where(p => selectedPermissionIds.Contains(p.Id))
                .ToList();
            
            var systemPermissions = selectedPermissions
                .Where(p => IsSystemPermission(p))
                .ToList();
            
            // 如果包含系統權限，顯示確認對話框
            if (systemPermissions.Any())
            {
                var systemPermissionNames = systemPermissions.Select(p => $"• {p.Name} ({p.Code})").ToList();
                var permissionList = string.Join("\n", systemPermissionNames);
                
                var confirmMessage = $"您即將為身分「{selectedRole.Name}」授予以下系統核心權限：\n\n{permissionList}\n\n" +
                                   "⚠️ 警告：\n" +
                                   "• 系統權限可能影響系統安全性和穩定性\n" +
                                   "• 擁有這些權限的用戶可以執行敏感的系統操作\n" +
                                   "• 包括但不限於：系統設定修改、權限管理、身分管理等\n\n" +
                                   "請確認您了解這些權限的影響，是否繼續執行授權？";
                
                var confirmed = await NotificationService.ShowConfirmAsync(confirmMessage, "系統權限授權確認");
                
                if (!confirmed)
                {
                    isSaving = false;
                    StateHasChanged();
                    return;
                }
            }
            
            var result = await RoleService.AssignPermissionsToRoleAsync(selectedRole.Id, selectedPermissionIds);
            
            if (result.IsSuccess)
            {
                // 根據是否包含系統權限顯示不同的成功訊息
                var successMessage = systemPermissions.Any() 
                    ? $"已成功更新身分「{selectedRole.Name}」的權限（包含 {systemPermissions.Count} 個系統權限）"
                    : $"已成功更新身分「{selectedRole.Name}」的權限";
                
                await NotificationService.ShowSuccessAsync(successMessage);
                
                // 重新載入身分權限
                await LoadPermissionsAsync();
            }
            else
            {
                await NotificationService.ShowErrorAsync($"儲存失敗：{result.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveRolePermissions), GetType());
            await NotificationService.ShowErrorAsync("儲存權限時發生錯誤");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }
    
    // ===== 輔助方法 =====
    
    /// <summary>
    /// 判斷是否為管理員身分
    /// </summary>
    private bool IsAdminRole(Role? role)
    {
        if (role == null) return false;
        var roleName = role.Name?.Trim().ToLower();
        return roleName == "管理員" || roleName == "admin";
    }
    
    /// <summary>
    /// 判斷是否為系統權限
    /// </summary>
    private bool IsSystemPermission(Permission permission)
    {
        var code = permission.Code;
        return code != null && (
            code.StartsWith("System.") || 
            code.StartsWith("EmployeeEdit_Account_Password.") ||
            code.StartsWith("SystemControl.") || 
            code.StartsWith("Permission.") || 
            code.StartsWith("Role.") || 
            code.StartsWith("Company.") ||
            code.StartsWith("PurchaseOrder_Approve."));
    }
    
    /// <summary>
    /// 取得一般權限列表
    /// </summary>
    private List<Permission> GetNormalPermissions()
    {
        return permissions.Where(p => !IsSystemPermission(p)).ToList();
    }
    
    /// <summary>
    /// 取得系統權限列表
    /// </summary>
    private List<Permission> GetSystemPermissions()
    {
        return permissions.Where(p => IsSystemPermission(p)).ToList();
    }
    
    /// <summary>
    /// 取得權限行的 CSS 類別
    /// </summary>
    private string GetPermissionRowClass(Permission permission, int index)
    {
        var classes = new List<string>();
        
        // 選中的權限加上背景色
        if (permissionSelections.GetValueOrDefault(permission.Id, false))
        {
            classes.Add("table-success");
        }
        
        // 可點擊的行加上游標樣式
        if (!IsAdminRole(selectedRole))
        {
            classes.Add("cursor-pointer");
            classes.Add("user-select-none");
        }
        
        return string.Join(" ", classes);
    }
}
