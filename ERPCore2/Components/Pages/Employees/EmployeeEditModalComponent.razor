@* å¯é‡ç”¨çš„å“¡å·¥ç·¨è¼¯çµ„ä»¶ - å¯åœ¨ä»»ä½•é é¢ä¸­åµŒå…¥ *@
@using System.Security.Claims
@inject IEmployeeService EmployeeService
@inject IDepartmentService DepartmentService
@inject IEmployeePositionService EmployeePositionService
@inject IRoleService RoleService
@inject IContactService ContactService
@inject IAddressService AddressService
@inject IContactTypeService ContactTypeService
@inject IAddressTypeService AddressTypeService
@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject INavigationPermissionService NavigationPermissionService
@inject ActionButtonHelper ActionButtonHelper
@using ERPCore2.Helpers

<GenericEditModalComponent TEntity="Employee" 
                          TService="IEmployeeService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          Id="@EmployeeId"
                          Service="@EmployeeService"
                          EntityName="å“¡å·¥"
                          EntityNamePlural="å“¡å·¥"
                          ModalTitle="@(EmployeeId.HasValue ? "ç·¨è¼¯å“¡å·¥" : "æ–°å¢å“¡å·¥")"
                          Size="GenericEditModalComponent<Employee, IEmployeeService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@GetAutoCompletePrefillers()"
                          AutoCompleteCollections="@GetAutoCompleteCollections()"
                          AutoCompleteDisplayProperties="@GetAutoCompleteDisplayProperties()"
                          AutoCompleteValueProperties="@GetAutoCompleteValueProperties()"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadEmployeeData"
                          SaveHandler="@SaveEmployee"
                          AdditionalDataLoader="@LoadAdditionalDataAsync"
                          OnSaveSuccess="@OnSaveSuccess"
                          RequiredPermission="Employee.Read"
                          OnCancel="@OnCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          AdditionalSections="@GetAdditionalSections()" />

@* éƒ¨é–€ç·¨è¼¯ Modal *@
<DepartmentEditModalComponent @ref="departmentEditModal"
                             IsVisible="@departmentModalManager.IsModalVisible"
                             IsVisibleChanged="@departmentModalManager.HandleModalVisibilityChangedAsync"
                             DepartmentId="@departmentModalManager.SelectedEntityId"
                             PrefilledValues="@departmentModalManager.PrefilledValues"
                             OnDepartmentSaved="@OnDepartmentSavedWrapper"
                             OnCancel="@departmentModalManager.HandleModalCancelAsync" />

@* è·ä½ç·¨è¼¯ Modal *@
<EmployeePositionEditModalComponent @ref="positionEditModal"
                                   IsVisible="@positionModalManager.IsModalVisible"
                                   IsVisibleChanged="@positionModalManager.HandleModalVisibilityChangedAsync"
                                   EmployeePositionId="@positionModalManager.SelectedEntityId"
                                   PrefilledValues="@positionModalManager.PrefilledValues"
                                   OnEmployeePositionSaved="@OnEmployeePositionSavedWrapper"
                                   OnCancel="@positionModalManager.HandleModalCancelAsync" />

@* è§’è‰²ç·¨è¼¯ Modal *@
<RoleEditModalComponent @ref="roleEditModal"
                       IsVisible="@roleModalManager.IsModalVisible"
                       IsVisibleChanged="@roleModalManager.HandleModalVisibilityChangedAsync"
                       RoleId="@roleModalManager.SelectedEntityId"
                       PrefilledValues="@roleModalManager.PrefilledValues"
                       OnRoleSaved="@OnRoleSavedWrapper"
                       OnCancel="@roleModalManager.HandleModalCancelAsync" />


@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? EmployeeId { get; set; }
    [Parameter] public EventCallback<Employee> OnEmployeeSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private GenericEditModalComponent<Employee, IEmployeeService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // éƒ¨é–€ç·¨è¼¯ Modal ç›¸é—œè®Šæ•¸ - ä½¿ç”¨æ³›å‹ç®¡ç†å™¨
    private DepartmentEditModalComponent? departmentEditModal;
    private RelatedEntityModalManager<Department> departmentModalManager = default!;
    
    // è·ä½ç·¨è¼¯ Modal ç›¸é—œè®Šæ•¸ - ä½¿ç”¨æ³›å‹ç®¡ç†å™¨
    private EmployeePositionEditModalComponent? positionEditModal;
    private RelatedEntityModalManager<EmployeePosition> positionModalManager = default!;
    
    // è§’è‰²ç·¨è¼¯ Modal ç›¸é—œè®Šæ•¸ - ä½¿ç”¨æ³›å‹ç®¡ç†å™¨
    private RoleEditModalComponent? roleEditModal;
    private RelatedEntityModalManager<Role> roleModalManager = default!;
    
    // é¸é …è³‡æ–™
    private List<Department> availableDepartments = new();
    private List<EmployeePosition> availablePositions = new();
    private List<Role> availableRoles = new();
    
    // è¯çµ¡è³‡è¨Šå’Œåœ°å€è³‡è¨Šç›¸é—œè®Šæ•¸
    private List<Contact> employeeContacts = new();
    private List<Address> employeeAddresses = new();
    private List<ContactType> contactTypes = new();
    private List<AddressType> addressTypes = new();
    
    // å­é›†åˆçµ„ä»¶ç”¨çš„è½‰æ›æ¸…å–®
    private List<ERPCore2.Data.BaseEntity> contactTypeOptions = new();
    private List<ERPCore2.Data.BaseEntity> addressTypeOptions = new();
    
    // æ³¨æ„ï¼šæœå°‹é—œéµå­—è¿½è¹¤å·²æ•´åˆåˆ° GenericEditModalComponent ä¸­ï¼Œä¸å†éœ€è¦æ‰‹å‹•è¿½è¹¤
    // private string lastDepartmentSearchTerm = string.Empty;  // å·²ç§»é™¤
    // private string lastPositionSearchTerm = string.Empty;    // å·²ç§»é™¤

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // åˆå§‹åŒ–éƒ¨é–€ Modal ç®¡ç†å™¨
            InitializeDepartmentModalManager();
            
            // åˆå§‹åŒ–è·ä½ Modal ç®¡ç†å™¨
            InitializePositionModalManager();
            
            // åˆå§‹åŒ–è§’è‰² Modal ç®¡ç†å™¨
            InitializeRoleModalManager();
            
            await LoadAdditionalDataAsync();
            
            await InitializeFormFieldsAsync();
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("åˆå§‹åŒ–å“¡å·¥ç·¨è¼¯çµ„ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        // ç•¶ EmployeeId åƒæ•¸è®Šæ›´æ™‚ï¼Œé‡æ–°åˆå§‹åŒ–è¡¨å–®æ¬„ä½
        if (formFields != null) // åªæœ‰åœ¨å·²ç¶“åˆå§‹åŒ–éçš„æƒ…æ³ä¸‹æ‰é‡æ–°è¨­å®š
        {
            await InitializeFormFieldsAsync();
        }
        
        await base.OnParametersSetAsync();
    }
    
    /// <summary>
    /// åˆå§‹åŒ–éƒ¨é–€ Modal ç®¡ç†å™¨
    /// </summary>
    private void InitializeDepartmentModalManager()
    {
        departmentModalManager = new RelatedEntityManagerBuilder<Department>(NotificationService, "éƒ¨é–€")
            .WithPropertyName(nameof(Employee.DepartmentId))
            .WithReloadCallback(LoadAdditionalDataAsync)
            .WithStateChangedCallback(StateHasChanged)
            .WithAutoSelectCallback(departmentId => 
            {
                if (editModalComponent?.Entity != null)
                {
                    editModalComponent.Entity.DepartmentId = departmentId;
                }
            })
            .WithCustomPostProcess(async department => 
            {
                // å“¡å·¥ç‰¹å®šçš„å¾Œè™•ç†é‚è¼¯
                await InitializeFormFieldsAsync();
            })
            .Build();
    }

    /// <summary>
    /// åˆå§‹åŒ–è·ä½ Modal ç®¡ç†å™¨
    /// </summary>
    private void InitializePositionModalManager()
    {
        positionModalManager = new RelatedEntityManagerBuilder<EmployeePosition>(NotificationService, "è·ä½")
            .WithPropertyName(nameof(Employee.EmployeePositionId))
            .WithReloadCallback(LoadAdditionalDataAsync)
            .WithStateChangedCallback(StateHasChanged)
            .WithAutoSelectCallback(positionId => 
            {
                if (editModalComponent?.Entity != null)
                {
                    editModalComponent.Entity.EmployeePositionId = positionId;
                }
            })
            .WithCustomPostProcess(async position => 
            {
                // å“¡å·¥ç‰¹å®šçš„å¾Œè™•ç†é‚è¼¯
                await InitializeFormFieldsAsync();
            })
            .Build();
    }

    /// <summary>
    /// åˆå§‹åŒ–è§’è‰² Modal ç®¡ç†å™¨
    /// </summary>
    private void InitializeRoleModalManager()
    {
        roleModalManager = new RelatedEntityManagerBuilder<Role>(NotificationService, "è§’è‰²")
            .WithPropertyName(nameof(Employee.RoleId))
            .WithReloadCallback(LoadAdditionalDataAsync)
            .WithStateChangedCallback(StateHasChanged)
            .WithAutoSelectCallback(roleId => 
            {
                if (editModalComponent?.Entity != null)
                {
                    editModalComponent.Entity.RoleId = roleId;
                }
            })
            .WithCustomPostProcess(async role => 
            {
                // å“¡å·¥ç‰¹å®šçš„å¾Œè™•ç†é‚è¼¯
                await InitializeFormFieldsAsync();
            })
            .Build();
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // è¼‰å…¥å¯é¸æ“‡çš„éƒ¨é–€åˆ—è¡¨
            availableDepartments = await DepartmentService.GetAllAsync();
            
            // è¼‰å…¥å¯é¸æ“‡çš„è·ä½åˆ—è¡¨
            availablePositions = await EmployeePositionService.GetAllAsync();
            
            // è¼‰å…¥å¯æŒ‡æ´¾çš„è§’è‰²åˆ—è¡¨ - æ ¹æ“šç•¶å‰ä½¿ç”¨è€…è§’è‰²éæ¿¾
            var currentUserRole = await CurrentUserHelper.GetCurrentRoleAsync(AuthenticationStateProvider);
            var rolesResult = await RoleService.GetAssignableRolesForCurrentUserAsync(currentUserRole);
            availableRoles = rolesResult.IsSuccess ? rolesResult.Data ?? new List<Role>() : new List<Role>();
            
            // è¼‰å…¥è¯çµ¡é¡å‹å’Œåœ°å€é¡å‹
            contactTypes = await ContactTypeService.GetActiveAsync();
            addressTypes = await AddressTypeService.GetActiveAsync();
            
            // è½‰æ›ç‚ºå­é›†åˆçµ„ä»¶ç”¨çš„åŸºç¤å¯¦é«”æ¸…å–®
            contactTypeOptions = contactTypes.Cast<ERPCore2.Data.BaseEntity>().ToList();
            addressTypeOptions = addressTypes.Cast<ERPCore2.Data.BaseEntity>().ToList();
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("è¼‰å…¥å“¡å·¥ç·¨è¼¯ç›¸é—œè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
            availableDepartments = new List<Department>();
            availablePositions = new List<EmployeePosition>();
            availableRoles = new List<Role>();
            contactTypes = new List<ContactType>();
            addressTypes = new List<AddressType>();
            contactTypeOptions = new List<ERPCore2.Data.BaseEntity>();
            addressTypeOptions = new List<ERPCore2.Data.BaseEntity>();
        }
    }

    /// <summary>
    /// æª¢æŸ¥ç•¶å‰ä½¿ç”¨è€…æ˜¯å¦æ“æœ‰æŒ‡å®šæ¬Šé™
    /// </summary>
    private async Task<bool> CheckCurrentUserPermissionAsync(string permission)
    {
        try
        {
            return await NavigationPermissionService.CanAccessAsync(permission);
        }
        catch
        {
            return false;
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                // åŸºæœ¬è³‡è¨Šå€æ®µ
                new()
                {
                    PropertyName = nameof(Employee.Code),
                    Label = "å“¡å·¥ä»£ç¢¼",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥å“¡å·¥ä»£ç¢¼",
                    IsRequired = true,
                    MaxLength = 20,
                    HelpText = "å“¡å·¥çš„å”¯ä¸€è­˜åˆ¥ä»£ç¢¼ï¼Œæ–°å¢æ™‚ç³»çµ±æœƒè‡ªå‹•ç”¢ç”Ÿï¼Œä¹Ÿå¯æ‰‹å‹•ä¿®æ”¹"
                },
                new()
                {
                    PropertyName = nameof(Employee.Name),
                    Label = "å§“å",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥å§“å",
                    IsRequired = true,
                    MaxLength = 25,
                    HelpText = "å“¡å·¥çš„åå­—"
                }
            };

            // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æ“æœ‰ç‰¹å®šæ¬Šé™æ‰å¯ä»¥çœ‹åˆ°ç³»çµ±ä½¿ç”¨è€…ç›¸é—œè¨­å®š
            var hasAccountPasswordPermission = await CheckCurrentUserPermissionAsync("EmployeeEdit_Account_Password.Read");
            
            if (hasAccountPasswordPermission)
            {
                formFields.AddRange(new List<FormFieldDefinition>
                {
                    new()
                    {
                        PropertyName = nameof(Employee.Account),
                        Label = "ç™»å…¥å¸³è™Ÿ",
                        FieldType = FormFieldType.Text,
                        Placeholder = "è«‹è¼¸å…¥ç™»å…¥å¸³è™Ÿ",
                        MaxLength = 50,
                        HelpText = "è¼¸å…¥å¸³è™Ÿå³å¯ç™»å…¥ç³»çµ±ï¼Œç•™ç©ºè¡¨ç¤ºæ­¤å“¡å·¥ç„¡æ³•ç™»å…¥"
                    },
                    new()
                    {
                        PropertyName = nameof(Employee.Password),
                        Label = "ç™»å…¥å¯†ç¢¼",
                        FieldType = FormFieldType.Password,
                        Placeholder = "è«‹è¼¸å…¥ç™»å…¥å¯†ç¢¼",
                        MaxLength = 100,
                        HelpText = "ç³»çµ±ç™»å…¥å¯†ç¢¼ï¼ˆç·¨è¼¯æ™‚ç•™ç©ºè¡¨ç¤ºä¸è®Šæ›´ï¼‰",
                    },
                    new()
                    {
                        PropertyName = nameof(Employee.RoleId),
                        Label = "èº«åˆ†",
                        FieldType = FormFieldType.AutoComplete,
                        Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡èº«åˆ†",
                        MinSearchLength = 0, // å…è¨±ç©ºç™½æœå°‹ä»¥é¡¯ç¤ºæ‰€æœ‰é¸é …
                        HelpText = "è¨­å®šæ­¤å“¡å·¥åœ¨ç³»çµ±ä¸­çš„æ¬Šé™è§’è‰²ï¼ˆæœ‰å¸³è™Ÿæ‰éœ€è¦è¨­å®šï¼‰",
                        ActionButtons = await GetRoleActionButtonsAsync()
                    }
                });
            }
            
            // çµ„ç¹”æ¶æ§‹å€æ®µ - æ‰€æœ‰äººéƒ½å¯è¦‹
            formFields.AddRange(new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(Employee.DepartmentId),
                    Label = "éƒ¨é–€",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡éƒ¨é–€",
                    MinSearchLength = 0, // å…è¨±ç©ºç™½æœå°‹ä»¥é¡¯ç¤ºæ‰€æœ‰é¸é …
                    HelpText = "è¼¸å…¥éƒ¨é–€åç¨±é€²è¡Œæœå°‹ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                    ActionButtons = await GetDepartmentActionButtonsAsync()
                },
                new()
                {
                    PropertyName = nameof(Employee.EmployeePositionId),
                    Label = "è·ä½",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡è·ä½",
                    MinSearchLength = 0, // å…è¨±ç©ºç™½æœå°‹ä»¥é¡¯ç¤ºæ‰€æœ‰é¸é …
                    HelpText = "è¼¸å…¥è·ä½åç¨±é€²è¡Œæœå°‹ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                    ActionButtons = await GetPositionActionButtonsAsync()
                }
            });

            formFields.Add(FormFieldConfigurationHelper.CreateRemarksField<Employee>());

            // æ›´æ–°è¡¨å–®å€æ®µå®šç¾©
            formSections = new Dictionary<string, string>
            {
                { nameof(Employee.Code), "åŸºæœ¬è³‡è¨Š" },
                { nameof(Employee.Name), "åŸºæœ¬è³‡è¨Š" },                
                { nameof(Employee.DepartmentId), "åŸºæœ¬è³‡è¨Š" },
                { nameof(Employee.EmployeePositionId), "åŸºæœ¬è³‡è¨Š" },
                { nameof(Employee.Remarks), "é¡å¤–è³‡æ–™" }
            };

            // åªæœ‰æœ‰æ¬Šé™çš„ä½¿ç”¨è€…æ‰åŠ å…¥å¸³è™Ÿç›¸é—œå€æ®µ
            if (hasAccountPasswordPermission)
            {
                formSections.Add(nameof(Employee.Account), "å¸³è™Ÿè³‡è¨Š");
                formSections.Add(nameof(Employee.Password), "å¸³è™Ÿè³‡è¨Š");
                formSections.Add(nameof(Employee.RoleId), "å¸³è™Ÿè³‡è¨Š");                
            }
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("åˆå§‹åŒ–è¡¨å–®æ¬„ä½æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }
    
    /// <summary>
    /// é…ç½® AutoComplete é å¡«å™¨ - ä½¿ç”¨æ•´åˆæ–¹å¼
    /// </summary>
    private Dictionary<string, Func<string, Dictionary<string, object?>>> GetAutoCompletePrefillers()
    {
        return new Dictionary<string, Func<string, Dictionary<string, object?>>>
        {
            {
                nameof(Employee.DepartmentId),
                searchTerm => new Dictionary<string, object?>
                {
                    ["Name"] = searchTerm,
                    // æ ¹æ“šæœå°‹è©æ¨æ¸¬éƒ¨é–€ä»£ç¢¼
                    ["DepartmentCode"] = searchTerm.Contains("è²¡å‹™") ? "FIN" : 
                                       searchTerm.Contains("æ¥­å‹™") ? "SALES" :
                                       searchTerm.Contains("äººè³‡") ? "HR" : 
                                       searchTerm.ToUpper().Replace(" ", "")
                }
            },
            {
                nameof(Employee.EmployeePositionId),
                searchTerm => new Dictionary<string, object?>
                {
                    ["Name"] = searchTerm,
                    ["PositionCode"] = searchTerm.ToUpper().Replace(" ", "")
                }
            },
            {
                nameof(Employee.RoleId),
                searchTerm => new Dictionary<string, object?>
                {
                    ["Name"] = searchTerm
                }
            }
        };
    }

    /// <summary>
    /// é…ç½® AutoComplete è³‡æ–™é›†åˆ
    /// </summary>
    private Dictionary<string, IEnumerable<object>> GetAutoCompleteCollections()
    {
        return new Dictionary<string, IEnumerable<object>>
        {
            { nameof(Employee.DepartmentId), availableDepartments.Cast<object>() },
            { nameof(Employee.EmployeePositionId), availablePositions.Cast<object>() },
            { nameof(Employee.RoleId), availableRoles.Cast<object>() }
        };
    }

    /// <summary>
    /// é…ç½® AutoComplete é¡¯ç¤ºå±¬æ€§
    /// </summary>
    private Dictionary<string, string> GetAutoCompleteDisplayProperties()
    {
        return new Dictionary<string, string>
        {
            { nameof(Employee.DepartmentId), "Name" },
            { nameof(Employee.EmployeePositionId), "Name" },
            { nameof(Employee.RoleId), "Name" }
        };
    }

    /// <summary>
    /// é…ç½® AutoComplete å€¼å±¬æ€§
    /// </summary>
    private Dictionary<string, string> GetAutoCompleteValueProperties()
    {
        return new Dictionary<string, string>
        {
            { nameof(Employee.DepartmentId), "Id" },
            { nameof(Employee.EmployeePositionId), "Id" },
            { nameof(Employee.RoleId), "Id" }
        };
    }
    
    /// <summary>
    /// é…ç½® Modal ç®¡ç†å™¨ - ä½¿ç”¨æ•´åˆæ–¹å¼
    /// </summary>
    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(Employee.DepartmentId), departmentModalManager },
            { nameof(Employee.EmployeePositionId), positionModalManager },
            { nameof(Employee.RoleId), roleModalManager }
        };
    }

    private async Task<Employee?> LoadEmployeeData()
    {
        try
        {
            if (!EmployeeId.HasValue) 
            {
                // æ–°å¢æ¨¡å¼ï¼šå»ºç«‹æ–°çš„å“¡å·¥å¯¦é«”ä¸¦ç”Ÿæˆä»£ç¢¼
                employeeContacts = new List<Contact>();
                employeeAddresses = new List<Address>();
                
                // æ‰¾å‡ºé è¨­çš„èº«åˆ† (Employee-éç³»çµ±ä½¿ç”¨è€…)
                var defaultRole = availableRoles.FirstOrDefault(r => 
                    r.Name.Contains("Employee") && r.Name.Contains("éç³»çµ±ä½¿ç”¨è€…"));
                
                var newEmployee = new Employee
                {
                    Code = await GenerateEmployeeCodeAsync(),
                    Name = string.Empty,
                    IsSystemUser = false,
                    RoleId = defaultRole?.Id,
                    Status = EntityStatus.Active
                };
                
                return newEmployee;
            }

            var employee = await EmployeeService.GetByIdAsync(EmployeeId.Value);            
            
            if (employee == null)
            {
                // å¦‚æœæ‰¾ä¸åˆ°å“¡å·¥ï¼Œå»ºç«‹æ–°çš„é è¨­å“¡å·¥
                employee = new Employee
                {
                    Code = "ERROR",
                    Name = "ERROR",
                    Status = EntityStatus.Active
                };
                employeeContacts = new List<Contact>();
                employeeAddresses = new List<Address>();
                return employee;
            }
            
            // è¼‰å…¥è¯çµ¡è³‡è¨Šå’Œåœ°å€è³‡è¨Š
            employeeContacts = await ContactService.GetByOwnerAsync(ContactOwnerTypes.Employee, EmployeeId.Value);
            
            employeeAddresses = await AddressService.GetEmployeeAddressesAsync(EmployeeId.Value);
            
            return employee;
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("è¼‰å…¥å“¡å·¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
            
            // è¨­å®šå®‰å…¨çš„é è¨­å€¼ï¼Œç¢ºä¿ç¨‹å¼ä¸æœƒå´©æ½°
            return new Employee
            {
                Code = "ERROR",
                Name = "ERROR",
                Status = EntityStatus.Active
            };
        }
    }

    private async Task<string> GenerateEmployeeCodeAsync()
    {
        return await CodeGenerationHelper.GenerateEntityCodeWithServiceResultAsync(
            EmployeeService,
            "EMP",
            (service, code, excludeId) => service.IsEmployeeCodeExistsAsync(code, excludeId)
        );
    }

    private async Task<bool> SaveEmployee(Employee entity)
    {
        try
        {
            // ğŸ¯ ç°¡åŒ–é‚è¼¯ï¼šæ ¹æ“šæ˜¯å¦æœ‰å¸³è™Ÿè‡ªå‹•è¨­å®š IsSystemUser
            bool hasAccount = !string.IsNullOrWhiteSpace(entity.Account);
            entity.IsSystemUser = hasAccount;
            
            // å¦‚æœæ²’æœ‰å¸³è™Ÿï¼Œæ¸…ç©ºç›¸é—œæ¬„ä½
            if (!hasAccount)
            {
                entity.Account = null;
                entity.Password = null;
                entity.RoleId = null; // éç³»çµ±ä½¿ç”¨è€…ä¸éœ€è¦èº«åˆ†
            }

            // åŸºæœ¬é©—è­‰ - ä½¿ç”¨é€šçŸ¥æœå‹™
            if (string.IsNullOrWhiteSpace(entity.Code))
            {
                await NotificationService.ShowErrorAsync("å“¡å·¥ä»£ç¢¼ç‚ºå¿…å¡«");
                return false;
            }

            if (string.IsNullOrWhiteSpace(entity.Name))
            {
                await NotificationService.ShowErrorAsync("å“¡å·¥å§“åç‚ºå¿…å¡«");
                return false;
            }

            // æª¢æŸ¥å“¡å·¥ä»£ç¢¼æ˜¯å¦é‡è¤‡
            var employeeCodeExistsResult = await EmployeeService.IsEmployeeCodeExistsAsync(entity.Code, EmployeeId);
            if (employeeCodeExistsResult.IsSuccess && employeeCodeExistsResult.Data)
            {
                await NotificationService.ShowErrorAsync($"å“¡å·¥ä»£ç¢¼ '{entity.Code}' å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–ä»£ç¢¼");
                return false;
            }

            // å¦‚æœæœ‰è¨­å®šå¸³è™Ÿï¼Œé€²è¡Œå¸³è™Ÿç›¸é—œé©—è­‰
            if (hasAccount)
            {
                // æª¢æŸ¥å¸³è™Ÿæ˜¯å¦é‡è¤‡
                var accountExistsResult = await EmployeeService.IsAccountExistsAsync(entity.Account!, EmployeeId);
                if (accountExistsResult.IsSuccess && accountExistsResult.Data)
                {
                    await NotificationService.ShowErrorAsync($"å¸³è™Ÿ '{entity.Account}' å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–å¸³è™Ÿ");
                    return false;
                }

                // æ–°å¢æ™‚å¯†ç¢¼å¿…å¡«
                if (string.IsNullOrWhiteSpace(entity.Password) && !EmployeeId.HasValue)
                {
                    await NotificationService.ShowErrorAsync("æ–°å¢å“¡å·¥æ™‚ï¼Œè‹¥è¨­å®šå¸³è™Ÿå‰‡å¯†ç¢¼ç‚ºå¿…å¡«");
                    return false;
                }

                // èº«åˆ†å¿…å¡«
                if (!entity.RoleId.HasValue)
                {
                    await NotificationService.ShowErrorAsync("è¨­å®šå¸³è™Ÿæ™‚å¿…é ˆæŒ‡æ´¾èº«åˆ†");
                    return false;
                }
            }

            // è™•ç†å¯†ç¢¼é›œæ¹Š - åªæœ‰åœ¨æ–°å¢æˆ–å¯†ç¢¼æœ‰è®Šæ›´æ™‚æ‰é›œæ¹Š
            if (hasAccount && !string.IsNullOrWhiteSpace(entity.Password))
            {
                // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°å¯†ç¢¼ï¼ˆæ–°å¢æ¨¡å¼æˆ–å¯†ç¢¼æ¬„ä½è¢«ä¿®æ”¹ï¼‰
                bool isNewPassword = false;
                
                if (!EmployeeId.HasValue)
                {
                    // æ–°å¢æ¨¡å¼
                    isNewPassword = true;
                }
                else
                {
                    // ç·¨è¼¯æ¨¡å¼ï¼šæª¢æŸ¥å¯†ç¢¼æ˜¯å¦æœ‰è®Šæ›´
                    var originalEmployee = await EmployeeService.GetByIdAsync(EmployeeId.Value);
                    if (originalEmployee != null && originalEmployee.Password != entity.Password)
                    {
                        isNewPassword = true;
                    }
                }
                
                if (isNewPassword)
                {
                    // ä½¿ç”¨ SeedDataHelper çš„å¯†ç¢¼é›œæ¹Šæ–¹æ³•
                    entity.Password = SeedDataHelper.HashPassword(entity.Password);
                }
            }

            ServiceResult result;
            
            if (EmployeeId.HasValue)
            {
                // æ›´æ–°ç¾æœ‰å“¡å·¥
                result = await EmployeeService.UpdateAsync(entity);
                if (result.IsSuccess)
                {
                    await UpdateEmployeeSubCollectionsAsync(EmployeeId.Value);
                }
            }
            else
            {
                // æ–°å¢å“¡å·¥
                result = await EmployeeService.CreateAsync(entity);
                if (result.IsSuccess && entity.Id > 0)
                {
                    await UpdateEmployeeSubCollectionsAsync(entity.Id);
                }
            }

            // è®“ GenericEditModalComponent è™•ç†é€šç”¨çš„æˆåŠŸ/å¤±æ•—è¨Šæ¯
            return result.IsSuccess;
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("å„²å­˜å“¡å·¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
            return false;
        }
    }

    private async Task UpdateEmployeeSubCollectionsAsync(int employeeId)
    {
        try
        {
            // æ›´æ–°è¯çµ¡è³‡è¨Š - åªæ›´æ–°æˆ–æ–°å¢ï¼Œä¸åˆªé™¤
            foreach (var contact in employeeContacts)
            {
                contact.OwnerType = ContactOwnerTypes.Employee;
                contact.OwnerId = employeeId;
                
                if (contact.Id == 0)
                {
                    // æ–°è¨˜éŒ„
                    await ContactService.CreateAsync(contact);
                }
                else
                {
                    // æ›´æ–°ç¾æœ‰è¨˜éŒ„
                    await ContactService.UpdateAsync(contact);
                }
            }

            // é‡æ–°åŠ è¼‰è¯çµ¡è³‡æ–™ä»¥æ›´æ–°UIé¡¯ç¤º
            employeeContacts = await ContactService.GetByOwnerAsync(ContactOwnerTypes.Employee, employeeId);

            // æ›´æ–°åœ°å€è³‡è¨Š - åªæ›´æ–°æˆ–æ–°å¢ï¼Œä¸åˆªé™¤
            foreach (var address in employeeAddresses)
            {
                address.OwnerType = AddressOwnerTypes.Employee;
                address.OwnerId = employeeId;
                
                if (address.Id == 0)
                {
                    // æ–°è¨˜éŒ„
                    await AddressService.CreateAddressAsync(AddressOwnerTypes.Employee, employeeId, address);
                }
                else
                {
                    // æ›´æ–°ç¾æœ‰è¨˜éŒ„
                    await AddressService.UpdateAddressAsync(address);
                }
            }

            // é‡æ–°åŠ è¼‰åœ°å€è³‡æ–™ä»¥æ›´æ–°UIé¡¯ç¤º
            employeeAddresses = await AddressService.GetEmployeeAddressesAsync(employeeId);

            StateHasChanged(); // é€šçŸ¥UIæ›´æ–°
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("æ›´æ–°å“¡å·¥ç›¸é—œè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    private async Task OnSaveSuccess()
    {
        try
        {
            if (editModalComponent?.Entity != null)
            {
                await OnEmployeeSaved.InvokeAsync(editModalComponent.Entity);
            }
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("å„²å­˜æˆåŠŸå›èª¿æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // ä½¿ç”¨çµ±ä¸€ Helper è™•ç†éƒ¨é–€æ¬„ä½è®Šæ›´
            if (fieldChange.PropertyName == nameof(Employee.DepartmentId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    departmentModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
            }
            
            // ä½¿ç”¨çµ±ä¸€ Helper è™•ç†è·ä½æ¬„ä½è®Šæ›´
            if (fieldChange.PropertyName == nameof(Employee.EmployeePositionId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    positionModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
            }
            
            // ä½¿ç”¨çµ±ä¸€ Helper è™•ç†è§’è‰²æ¬„ä½è®Šæ›´
            if (fieldChange.PropertyName == nameof(Employee.RoleId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    roleModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
            }
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("æ¬„ä½è®Šæ›´è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    /// <summary>
    /// åŒ…è£éƒ¨é–€å„²å­˜äº‹ä»¶ä»¥ç¬¦åˆåŸæœ‰ä»‹é¢
    /// </summary>
    private async Task OnDepartmentSavedWrapper(Department savedDepartment)
    {
        await departmentModalManager.HandleEntitySavedAsync(savedDepartment, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// åŒ…è£è·ä½å„²å­˜äº‹ä»¶ä»¥ç¬¦åˆåŸæœ‰ä»‹é¢
    /// </summary>
    private async Task OnEmployeePositionSavedWrapper(EmployeePosition savedPosition)
    {
        await positionModalManager.HandleEntitySavedAsync(savedPosition, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// åŒ…è£è§’è‰²å„²å­˜äº‹ä»¶ä»¥ç¬¦åˆåŸæœ‰ä»‹é¢
    /// </summary>
    private async Task OnRoleSavedWrapper(Role savedRole)
    {
        await roleModalManager.HandleEntitySavedAsync(savedRole, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// ä½¿ç”¨çµ±ä¸€ Helper ç”¢ç”Ÿéƒ¨é–€æ“ä½œæŒ‰éˆ•
    /// </summary>
    private async Task<List<FieldActionButton>> GetDepartmentActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            departmentModalManager, 
            nameof(Employee.DepartmentId)
        );
    }

    /// <summary>
    /// ä½¿ç”¨çµ±ä¸€ Helper ç”¢ç”Ÿè·ä½æ“ä½œæŒ‰éˆ•
    /// </summary>
    private async Task<List<FieldActionButton>> GetPositionActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            positionModalManager, 
            nameof(Employee.EmployeePositionId)
        );
    }

    /// <summary>
    /// ä½¿ç”¨çµ±ä¸€ Helper ç”¢ç”Ÿè§’è‰²æ“ä½œæŒ‰éˆ•
    /// </summary>
    private async Task<List<FieldActionButton>> GetRoleActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            roleModalManager, 
            nameof(Employee.RoleId)
        );
    }

    // ===== éƒ¨é–€ç®¡ç†ç›¸é—œæ–¹æ³• - å·²é‡æ§‹ç‚ºä½¿ç”¨æ³›å‹ç®¡ç†å™¨ =====

    /// <summary>
    /// é–‹å•Ÿéƒ¨é–€ç·¨è¼¯ Modal - ä½¿ç”¨æ³›å‹ç®¡ç†å™¨
    /// </summary>
    private async Task OpenDepartmentModal(int? departmentId)
    {
        await departmentModalManager.OpenModalAsync(departmentId);
    }

    /// <summary>
    /// å–å¾—ç›®å‰é¸æ“‡çš„éƒ¨é–€ ID
    /// </summary>
    private int? GetSelectedDepartmentId()
    {
        try
        {
            return editModalComponent?.Entity?.DepartmentId;
        }
        catch
        {
            return null;
        }
    }

    /// <summary>
    /// è™•ç†å“¡å·¥è¯çµ¡æ–¹å¼è®Šæ›´äº‹ä»¶
    /// </summary>
    private Task OnEmployeeContactsChanged(List<Contact> updatedContacts)
    {
        try
        {
            employeeContacts = updatedContacts;
            StateHasChanged();
            return Task.CompletedTask;
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("æ›´æ–°è¯çµ¡æ–¹å¼æ™‚ç™¼ç”ŸéŒ¯èª¤");
            return Task.CompletedTask;
        }
    }

    /// <summary>
    /// è™•ç†å·²åˆªé™¤çš„å“¡å·¥è¯çµ¡æ–¹å¼ID - å¯¦éš›å¾è³‡æ–™åº«åˆªé™¤
    /// </summary>
    private async Task HandleDeletedEmployeeContactsChanged(List<int> deletedContactIds)
    {
        try
        {
            if (deletedContactIds?.Any() == true)
            {
                foreach (var contactId in deletedContactIds)
                {
                    await ContactService.DeleteAsync(contactId);
                }
                
                // é¡¯ç¤ºæˆåŠŸé€šçŸ¥
                await NotificationService.ShowSuccessAsync($"å·²åˆªé™¤ {deletedContactIds.Count} å€‹è¯çµ¡æ–¹å¼");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"åˆªé™¤è¯çµ¡æ–¹å¼æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è™•ç†å“¡å·¥åœ°å€è®Šæ›´äº‹ä»¶
    /// </summary>
    private Task OnEmployeeAddressesChanged(List<Address> updatedAddresses)
    {
        try
        {
            employeeAddresses = updatedAddresses;
            StateHasChanged();
            return Task.CompletedTask;
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("æ›´æ–°åœ°å€è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
            return Task.CompletedTask;
        }
    }

    /// <summary>
    /// è™•ç†å·²åˆªé™¤çš„å“¡å·¥åœ°å€ID - å¯¦éš›å¾è³‡æ–™åº«åˆªé™¤
    /// </summary>
    private async Task HandleDeletedEmployeeAddressesChanged(List<int> deletedAddressIds)
    {
        try
        {
            if (deletedAddressIds?.Any() == true)
            {
                foreach (var addressId in deletedAddressIds)
                {
                    await AddressService.DeleteAddressAsync(addressId);
                }
                
                // é¡¯ç¤ºæˆåŠŸé€šçŸ¥
                await NotificationService.ShowSuccessAsync($"å·²åˆªé™¤ {deletedAddressIds.Count} å€‹å“¡å·¥åœ°å€");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"åˆªé™¤å“¡å·¥åœ°å€æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// å–å¾—é¡å¤–å€æ®µå…§å®¹ï¼ˆè¯çµ¡æ–¹å¼å’Œåœ°å€ç®¡ç†ï¼‰
    /// </summary>
    private RenderFragment? GetAdditionalSections()
    {
        return @<div class="row mt-4">
            <div class="row">
                <div class="col-md-6">
                        <ContactManagerComponent TContactEntity="Contact"
                                               TParentEntity="Employee"
                                               Items="@employeeContacts"
                                               Options="@contactTypeOptions"
                                               ParentEntityId="@(EmployeeId ?? editModalComponent?.Entity?.Id ?? 0)"
                                               GetTypeId="@(c => c.ContactTypeId)"
                                               GetContactValue="@(c => c.ContactValue)"
                                               SetTypeId="@((c, typeId) => c.ContactTypeId = typeId)"
                                               SetContactValue="@((c, value) => c.ContactValue = value)"
                                               SetParentId="@((c, parentId) => { c.OwnerType = ContactOwnerTypes.Employee; c.OwnerId = parentId; })"
                                               ItemsChanged="@OnEmployeeContactsChanged"
                                               OnDeletedDetailsChanged="@HandleDeletedEmployeeContactsChanged" />
                </div>
                <div class="col-md-6">
                        <AddressManagerComponent TAddressEntity="Address"
                                               TParentEntity="Employee"
                                               Items="@employeeAddresses"
                                               Options="@addressTypeOptions"
                                               ParentEntityId="@(EmployeeId ?? editModalComponent?.Entity?.Id ?? 0)"
                                               GetTypeId="@(a => a.AddressTypeId)"
                                               GetAddress="@(a => a.AddressLine)"
                                               SetTypeId="@((a, typeId) => a.AddressTypeId = typeId)"
                                               SetAddress="@((a, address) => a.AddressLine = address)"
                                               SetParentId="@((a, parentId) => SetEmployeeIdForAddress(a, parentId))"
                                               ItemsChanged="@OnEmployeeAddressesChanged"
                                               OnDeletedDetailsChanged="@HandleDeletedEmployeeAddressesChanged" />
                </div>
            </div>
        </div>;
    }

    private void SetEmployeeIdForAddress(Address address, int parentId)
    {
        address.OwnerId = parentId;
        address.OwnerType = AddressOwnerTypes.Employee;
    }
}
