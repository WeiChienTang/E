@* å¯é‡ç”¨çš„å“¡å·¥ç·¨è¼¯çµ„ä»¶ - å¯åœ¨ä»»ä½•é é¢ä¸­åµŒå…¥ *@
@using System.Security.Claims
@using ERPCore2.Helpers
@using ERPCore2.Helpers.EditModal
@inject IEmployeeService EmployeeService
@inject IDepartmentService DepartmentService
@inject IEmployeePositionService EmployeePositionService
@inject IRoleService RoleService
@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject INavigationPermissionService NavigationPermissionService
@inject ActionButtonHelper ActionButtonHelper
@inject IVehicleService VehicleService

<GenericEditModalComponent TEntity="Employee"
                          TService="IEmployeeService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@EmployeeId"
                          Service="@EmployeeService"
                          EntityName="å“¡å·¥"
                          EntityNamePlural="å“¡å·¥"
                          ModalTitle="@(EmployeeId.HasValue ? "ç·¨è¼¯å“¡å·¥" : "æ–°å¢å“¡å·¥")"
                          Size="GenericEditModalComponent<Employee, IEmployeeService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          TabDefinitions="@tabDefinitions"
                          AutoCompletePrefillers="@autoCompleteConfig?.Prefillers"
                          AutoCompleteCollections="@autoCompleteConfig?.Collections"
                          AutoCompleteDisplayProperties="@autoCompleteConfig?.DisplayProperties"
                          AutoCompleteValueProperties="@autoCompleteConfig?.ValueProperties"
                          ModalManagers="@modalManagers?.AsDictionary()"
                          DataLoader="@LoadEmployeeData"
                          SaveHandler="@SaveEmployee"
                          AdditionalDataLoader="@LoadAdditionalDataAsync"
                          OnSaveSuccess="@OnSaveSuccess"
                          RequiredPermission="Employee.Read"
                          OnCancel="@OnCancel"
                          OnEntityLoaded="@HandleEntityLoaded" />

@* éƒ¨é–€ç·¨è¼¯ Modal *@
<DepartmentEditModalComponent @ref="departmentEditModal"
                             IsVisible="@departmentModalManager.IsModalVisible"
                             IsVisibleChanged="@departmentModalManager.HandleModalVisibilityChangedAsync"
                             DepartmentId="@departmentModalManager.SelectedEntityId"
                             PrefilledValues="@departmentModalManager.PrefilledValues"
                             OnDepartmentSaved="@departmentModalManager.OnSavedAsync"
                             OnCancel="@departmentModalManager.HandleModalCancelAsync" />

@* è·ä½ç·¨è¼¯ Modal *@
<EmployeePositionEditModalComponent @ref="positionEditModal"
                                   IsVisible="@positionModalManager.IsModalVisible"
                                   IsVisibleChanged="@positionModalManager.HandleModalVisibilityChangedAsync"
                                   EmployeePositionId="@positionModalManager.SelectedEntityId"
                                   PrefilledValues="@positionModalManager.PrefilledValues"
                                   OnEmployeePositionSaved="@positionModalManager.OnSavedAsync"
                                   OnCancel="@positionModalManager.HandleModalCancelAsync" />

@* æ¬Šé™çµ„ç·¨è¼¯ Modal *@
<RoleEditModalComponent @ref="roleEditModal"
                       IsVisible="@roleModalManager.IsModalVisible"
                       IsVisibleChanged="@roleModalManager.HandleModalVisibilityChangedAsync"
                       RoleId="@roleModalManager.SelectedEntityId"
                       PrefilledValues="@roleModalManager.PrefilledValues"
                       OnRoleSaved="@roleModalManager.OnSavedAsync"
                       OnCancel="@roleModalManager.HandleModalCancelAsync" />

@* è»Šè¼›ç·¨è¼¯ Modal - æ¢ä»¶å¼æ¸²æŸ“é¿å…å¾ªç’°å…ƒä»¶å¯¦ä¾‹åŒ– *@
@if (isVehicleModalVisible)
{
    <VehicleEditModalComponent @ref="vehicleEditModal"
                              IsVisible="@isVehicleModalVisible"
                              IsVisibleChanged="@HandleVehicleModalVisibilityChanged"
                              VehicleId="@editingVehicleId"
                              PrefilledValues="@GetVehiclePrefilledValues()"
                              OnVehicleSaved="@OnVehicleSavedWrapper"
                              OnCancel="@HandleVehicleModalCancel" />
}


@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? EmployeeId { get; set; }
    [Parameter] public EventCallback<Employee> OnEmployeeSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private GenericEditModalComponent<Employee, IEmployeeService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    private List<FormTabDefinition>? tabDefinitions;
    
    // éƒ¨é–€ç·¨è¼¯ Modal ç›¸é—œè®Šæ•¸ - ä½¿ç”¨æ³›å‹ç®¡ç†å™¨
    private DepartmentEditModalComponent? departmentEditModal;
    private RelatedEntityModalManager<Department> departmentModalManager = default!;
    
    // è·ä½ç·¨è¼¯ Modal ç›¸é—œè®Šæ•¸ - ä½¿ç”¨æ³›å‹ç®¡ç†å™¨
    private EmployeePositionEditModalComponent? positionEditModal;
    private RelatedEntityModalManager<EmployeePosition> positionModalManager = default!;
    
    // è§’è‰²ç·¨è¼¯ Modal ç›¸é—œè®Šæ•¸ - ä½¿ç”¨æ³›å‹ç®¡ç†å™¨
    private RoleEditModalComponent? roleEditModal;
    private RelatedEntityModalManager<Role> roleModalManager = default!;
    
    private ModalManagerCollection modalManagers = default!;
    
    // AutoComplete é…ç½®
    private AutoCompleteConfig? autoCompleteConfig;
    
    // é¸é …è³‡æ–™
    private List<Department> availableDepartments = new();
    private List<EmployeePosition> availablePositions = new();
    private List<Role> availableRoles = new();
    
    // è³‡æ–™è¼‰å…¥ç‹€æ…‹æ¨™è¨˜
    private bool isDataLoaded = false;
    
    // è»Šè¼› Tab ç›¸é—œ
    private List<Vehicle> employeeVehicles = new();
    private VehicleEditModalComponent? vehicleEditModal;
    private bool isVehicleModalVisible = false;
    private int? editingVehicleId = null;
    
    // æ³¨æ„ï¼šæœå°‹é—œéµå­—è¿½è¹¤å·²æ•´åˆåˆ° GenericEditModalComponent ä¸­ï¼Œä¸å†éœ€è¦æ‰‹å‹•è¿½è¹¤
    // private string lastDepartmentSearchTerm = string.Empty;  // å·²ç§»é™¤
    // private string lastPositionSearchTerm = string.Empty;    // å·²ç§»é™¤

    /// <summary>
    /// è™•ç†å¯¦é«”è¼‰å…¥å®Œæˆäº‹ä»¶ï¼ˆç”± GenericEditModalComponent çš„å°èˆªè§¸ç™¼ï¼‰
    /// ç•¶ä¸Šä¸‹ç­†åˆ‡æ›æ™‚è§¸ç™¼ UI æ›´æ–°ï¼Œç¢ºä¿è¡¨å–®æ¬„ä½æ­£ç¢ºæ¸²æŸ“
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            // è¼‰å…¥è©²å“¡å·¥çš„è»Šè¼›è³‡è¨Š
            if (loadedEntityId > 0)
            {
                employeeVehicles = await VehicleService.GetByEmployeeAsync(loadedEntityId);
            }
            else
            {
                employeeVehicles = new();
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    protected override void OnInitialized()
    {
        try
        {
            // ä½¿ç”¨ ModalManagerInitHelper åˆå§‹åŒ– Modal ç®¡ç†å™¨
            modalManagers = ModalManagerInitHelper.CreateBuilder<Employee, IEmployeeService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Department>(nameof(Employee.DepartmentId), "éƒ¨é–€")
                .AddManager<EmployeePosition>(nameof(Employee.EmployeePositionId), "è·ä½")
                .AddManager<Role>(nameof(Employee.RoleId), "è§’è‰²")
                .Build();
            departmentModalManager = modalManagers.Get<Department>(nameof(Employee.DepartmentId));
            positionModalManager = modalManagers.Get<EmployeePosition>(nameof(Employee.EmployeePositionId));
            roleModalManager = modalManagers.Get<Role>(nameof(Employee.RoleId));
            
            // ç§»é™¤è‡ªå‹•è¼‰å…¥è³‡æ–™ï¼Œæ”¹ç‚ºåœ¨ OnParametersSetAsync ä¸­æ ¹æ“š IsVisible è¼‰å…¥
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("åˆå§‹åŒ–å“¡å·¥ç·¨è¼¯çµ„ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // è¼‰å…¥å¯é¸æ“‡çš„éƒ¨é–€åˆ—è¡¨
            availableDepartments = await DepartmentService.GetAllAsync();
            
            // è¼‰å…¥å¯é¸æ“‡çš„è·ä½åˆ—è¡¨
            availablePositions = await EmployeePositionService.GetAllAsync();
            
            // è¼‰å…¥å¯æŒ‡æ´¾çš„è§’è‰²åˆ—è¡¨ - æ ¹æ“šç•¶å‰ä½¿ç”¨è€…è§’è‰²éæ¿¾
            var currentUserRole = await CurrentUserHelper.GetCurrentRoleAsync(AuthenticationStateProvider);
            var rolesResult = await RoleService.GetAssignableRolesForCurrentUserAsync(currentUserRole);
            availableRoles = rolesResult.IsSuccess ? rolesResult.Data ?? new List<Role>() : new List<Role>();
            
            // ä½¿ç”¨ AutoCompleteConfigHelper å»ºç«‹é…ç½®
            autoCompleteConfig = new AutoCompleteConfigBuilder<Employee>()
                .AddFieldWithMultipleSearchProperties<Department>(
                    nameof(Employee.DepartmentId),
                    "Name",
                    availableDepartments,
                    new[] { "Name", "DepartmentCode" })
                .AddFieldWithMultipleSearchProperties<EmployeePosition>(
                    nameof(Employee.EmployeePositionId),
                    "Name",
                    availablePositions,
                    new[] { "Name", "PositionCode" })
                .AddField(nameof(Employee.RoleId), "Name", availableRoles)
                .Build();
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("è¼‰å…¥å“¡å·¥ç·¨è¼¯ç›¸é—œè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
            availableDepartments = new List<Department>();
            availablePositions = new List<EmployeePosition>();
            availableRoles = new List<Role>();
        }
    }

    /// <summary>
    /// æª¢æŸ¥ç•¶å‰ä½¿ç”¨è€…æ˜¯å¦æ“æœ‰æŒ‡å®šæ¬Šé™
    /// </summary>
    private async Task<bool> CheckCurrentUserPermissionAsync(string permission)
    {
        try
        {
            return await NavigationPermissionService.CanAccessAsync(permission);
        }
        catch
        {
            return false;
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                // åŸºæœ¬è³‡è¨Šå€æ®µ
                new()
                {
                    PropertyName = nameof(Employee.Code),
                    Label = "å“¡å·¥ç·¨è™Ÿ",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿ",
                    IsRequired = true,
                    MaxLength = 20,
                    HelpText = "å“¡å·¥çš„å”¯ä¸€è­˜åˆ¥ç·¨è™Ÿï¼Œæ–°å¢æ™‚ç³»çµ±æœƒè‡ªå‹•ç”¢ç”Ÿï¼Œä¹Ÿå¯æ‰‹å‹•ä¿®æ”¹"
                },
                new()
                {
                    PropertyName = nameof(Employee.Name),
                    Label = "å§“å",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥å§“å",
                    IsRequired = true,
                    MaxLength = 10,
                    HelpText = "å“¡å·¥çš„åå­—"
                },
                new()
                {
                    PropertyName = nameof(Employee.Gender),
                    Label = "æ€§åˆ¥",
                    FieldType = FormFieldType.Select,
                    Options = Enum.GetValues<Gender>()
                        .Select(g => new SelectOption
                        {
                            Text = GetGenderDisplayName(g),
                            Value = ((int)g).ToString()
                        }).ToList(),
                    HelpText = "å“¡å·¥æ€§åˆ¥"
                },
                new()
                {
                    PropertyName = nameof(Employee.BirthDate),
                    Label = "ç”Ÿæ—¥",
                    FieldType = FormFieldType.Date,
                    Placeholder = "è«‹é¸æ“‡ç”Ÿæ—¥",
                    HelpText = "å“¡å·¥å‡ºç”Ÿæ—¥æœŸ"
                },
                new()
                {
                    PropertyName = nameof(Employee.IdNumber),
                    Label = "èº«åˆ†è­‰å­—è™Ÿ",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥èº«åˆ†è­‰å­—è™Ÿ",
                    MaxLength = 10,
                    HelpText = "å“¡å·¥èº«åˆ†è­‰å­—è™Ÿ"
                }
            };

            // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æ“æœ‰ç‰¹å®šæ¬Šé™æ‰å¯ä»¥çœ‹åˆ°ç³»çµ±ä½¿ç”¨è€…ç›¸é—œè¨­å®š
            var hasAccountPasswordPermission = await CheckCurrentUserPermissionAsync("EmployeeEdit_Account_Password.Read");
            
            if (hasAccountPasswordPermission)
            {
                formFields.AddRange(new List<FormFieldDefinition>
                {
                    new()
                    {
                        PropertyName = nameof(Employee.Account),
                        Label = "ç™»å…¥å¸³è™Ÿ",
                        FieldType = FormFieldType.Text,
                        Placeholder = "è«‹è¼¸å…¥ç™»å…¥å¸³è™Ÿ",
                        MaxLength = 20,
                        HelpText = "è¼¸å…¥å¸³è™Ÿå³å¯ç™»å…¥ç³»çµ±ï¼Œç•™ç©ºè¡¨ç¤ºæ­¤å“¡å·¥ç„¡æ³•ç™»å…¥"
                    },
                    new()
                    {
                        PropertyName = nameof(Employee.Password),
                        Label = "ç™»å…¥å¯†ç¢¼",
                        FieldType = FormFieldType.Password,
                        Placeholder = "è«‹è¼¸å…¥ç™»å…¥å¯†ç¢¼",
                        MaxLength = 20,
                        HelpText = "ç³»çµ±ç™»å…¥å¯†ç¢¼ï¼ˆç·¨è¼¯æ™‚ç•™ç©ºè¡¨ç¤ºä¸è®Šæ›´ï¼‰",
                    },
                    new()
                    {
                        PropertyName = nameof(Employee.RoleId),
                        Label = "æ¬Šé™çµ„",
                        FieldType = FormFieldType.AutoComplete,
                        Placeholder = "è«‹é¸æ“‡æ¬Šé™çµ„",
                        MinSearchLength = 0, // å…è¨±ç©ºç™½æœå°‹ä»¥é¡¯ç¤ºæ‰€æœ‰é¸é …
                        HelpText = "è¨­å®šæ­¤å“¡å·¥åœ¨ç³»çµ±ä¸­çš„æ¬Šé™çµ„ï¼ˆæœ‰å¸³è™Ÿæ‰éœ€è¦è¨­å®šï¼‰"
                    }
                });
            }
            
            // è¯çµ¡è³‡è¨Šå€æ®µ
            formFields.AddRange(new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(Employee.Mobile),
                    Label = "æ‰‹æ©Ÿè™Ÿç¢¼",
                    FieldType = FormFieldType.MobilePhone,
                    Placeholder = "0912-345-678",
                    HelpText = "å“¡å·¥å€‹äººæ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆ10ç¢¼ï¼Œä»¥09é–‹é ­ï¼‰"
                },
                new()
                {
                    PropertyName = nameof(Employee.Email),
                    Label = "é›»å­éƒµä»¶",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥Email",
                    MaxLength = 50,
                    HelpText = "å“¡å·¥é›»å­éƒµä»¶åœ°å€"
                },
                new()
                {
                    PropertyName = nameof(Employee.EmergencyContact),
                    Label = "ç·Šæ€¥è¯çµ¡äºº",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥ç·Šæ€¥è¯çµ¡äººå§“å",
                    MaxLength = 10,
                    HelpText = "ç·Šæ€¥ç‹€æ³æ™‚çš„è¯çµ¡äºº"
                },
                new()
                {
                    PropertyName = nameof(Employee.EmergencyPhone),
                    Label = "ç·Šæ€¥è¯çµ¡é›»è©±",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥ç·Šæ€¥è¯çµ¡é›»è©±",
                    MaxLength = 20,
                    HelpText = "ç·Šæ€¥è¯çµ¡äººé›»è©±è™Ÿç¢¼"
                }
            });
            
            // çµ„ç¹”æ¶æ§‹å€æ®µ - æ‰€æœ‰äººéƒ½å¯è¦‹
            formFields.AddRange(new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(Employee.DepartmentId),
                    Label = "éƒ¨é–€",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡éƒ¨é–€",
                    MinSearchLength = 0, // å…è¨±ç©ºç™½æœå°‹ä»¥é¡¯ç¤ºæ‰€æœ‰é¸é …
                    HelpText = "è¼¸å…¥éƒ¨é–€åç¨±é€²è¡Œæœå°‹ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                    ActionButtons = await GetDepartmentActionButtonsAsync()
                },
                new()
                {
                    PropertyName = nameof(Employee.EmployeePositionId),
                    Label = "è·ä½",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡è·ä½",
                    MinSearchLength = 0, // å…è¨±ç©ºç™½æœå°‹ä»¥é¡¯ç¤ºæ‰€æœ‰é¸é …
                    HelpText = "è¼¸å…¥è·ä½åç¨±é€²è¡Œæœå°‹ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                    ActionButtons = await GetPositionActionButtonsAsync()
                }
            });
            
            // ä»»è·è³‡è¨Šå€æ®µ
            formFields.AddRange(new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(Employee.HireDate),
                    Label = "åˆ°è·æ—¥æœŸ",
                    FieldType = FormFieldType.Date,
                    Placeholder = "è«‹é¸æ“‡åˆ°è·æ—¥æœŸ",
                    HelpText = "å“¡å·¥æ­£å¼åˆ°è·çš„æ—¥æœŸ"
                },
                new()
                {
                    PropertyName = nameof(Employee.ResignationDate),
                    Label = "é›¢è·æ—¥æœŸ",
                    FieldType = FormFieldType.Date,
                    Placeholder = "è«‹é¸æ“‡é›¢è·æ—¥æœŸ",
                    HelpText = "å“¡å·¥é›¢è·æ—¥æœŸï¼ˆåœ¨è·è€…å…å¡«ï¼‰"
                },
                new()
                {
                    PropertyName = nameof(Employee.EmploymentStatus),
                    Label = "åœ¨è·ç‹€æ…‹",
                    FieldType = FormFieldType.Select,
                    Options = Enum.GetValues<EmployeeStatus>()
                        .Select(es => new SelectOption
                        {
                            Text = GetEmployeeStatusDisplayName(es),
                            Value = ((int)es).ToString()
                        }).ToList(),
                    HelpText = "å“¡å·¥ç›®å‰çš„åœ¨è·ç‹€æ…‹"
                }
            });

            formFields.Add(FormFieldConfigurationHelper.CreateRemarksField<Employee>());

            // æ›´æ–°è¡¨å–®å€æ®µå®šç¾©èˆ‡ Tab åˆ†çµ„
            var layout = FormSectionHelper<Employee>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    e => e.Code,
                    e => e.Name,
                    e => e.Gender,
                    e => e.BirthDate,
                    e => e.IdNumber,
                    e => e.Mobile,
                    e => e.Email,
                    e => e.EmergencyContact,
                    e => e.EmergencyPhone)
                .AddToSection(FormSectionNames.EmploymentInfo,
                    e => e.DepartmentId,
                    e => e.EmployeePositionId,
                    e => e.HireDate,
                    e => e.ResignationDate,
                    e => e.EmploymentStatus)
                .AddIf(hasAccountPasswordPermission, FormSectionNames.EmploymentInfo,
                    e => e.Account,
                    e => e.Password,
                    e => e.RoleId)
                .AddToSection(FormSectionNames.AdditionalData,
                    e => e.Remarks)
                .GroupIntoTab("å“¡å·¥è³‡æ–™", "bi-person-fill", FormSectionNames.BasicInfo, FormSectionNames.EmploymentInfo, FormSectionNames.AdditionalData)
                .GroupIntoCustomTab("è»Šè¼›è³‡è¨Š", "bi-truck", CreateVehicleTabContent())
                .BuildAll();

            formSections = layout.FieldSections;
            tabDefinitions = layout.TabDefinitions;
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("åˆå§‹åŒ–è¡¨å–®æ¬„ä½æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    private async Task<Employee?> LoadEmployeeData()
    {
        try
        {
            if (!EmployeeId.HasValue) 
            {
                // æ–°å¢æ¨¡å¼ - æ¸…é™¤å‰ä¸€ç­†çš„è»Šè¼›è³‡æ–™
                employeeVehicles = new List<Vehicle>();

                // æ‰¾å‡ºé è¨­çš„æ¬Šé™çµ„ (Employee-éç³»çµ±ä½¿ç”¨è€…)
                var defaultRole = availableRoles.FirstOrDefault(r => 
                    r.Name.Contains("Employee") && r.Name.Contains("éç³»çµ±ä½¿ç”¨è€…"));
                
                var newEmployee = new Employee
                {
                    Code = await EntityCodeGenerationHelper.GenerateForEntity<Employee, IEmployeeService>(EmployeeService, "EMP"),
                    Name = string.Empty,
                    IsSystemUser = false,
                    RoleId = defaultRole?.Id,
                    Status = EntityStatus.Active,
                    EmploymentStatus = EmployeeStatus.Active,
                    HireDate = DateTime.Today // é è¨­åˆ°è·æ—¥æœŸç‚ºç•¶æ—¥
                };
                
                return newEmployee;
            }

            var employee = await EmployeeService.GetByIdAsync(EmployeeId.Value);            
            
            if (employee == null)
            {
                // å¦‚æœæ‰¾ä¸åˆ°å“¡å·¥ï¼Œå»ºç«‹æ–°çš„é è¨­å“¡å·¥
                employee = new Employee
                {
                    Code = "ERROR",
                    Name = "ERROR",
                    Status = EntityStatus.Active
                };
                return employee;
            }

            // è¼‰å…¥è©²å“¡å·¥çš„è»Šè¼›è³‡è¨Š
            employeeVehicles = await VehicleService.GetByEmployeeAsync(EmployeeId.Value);
            
            return employee;
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("è¼‰å…¥å“¡å·¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
            
            // è¨­å®šå®‰å…¨çš„é è¨­å€¼ï¼Œç¢ºä¿ç¨‹å¼ä¸æœƒå´©æ½°
            return new Employee
            {
                Code = "ERROR",
                Name = "ERROR",
                Status = EntityStatus.Active
            };
        }
    }

    private async Task<bool> SaveEmployee(Employee entity)
    {
        try
        {
            // ğŸ¯ ç°¡åŒ–é‚è¼¯ï¼šæ ¹æ“šæ˜¯å¦æœ‰å¸³è™Ÿè‡ªå‹•è¨­å®š IsSystemUser
            bool hasAccount = !string.IsNullOrWhiteSpace(entity.Account);
            entity.IsSystemUser = hasAccount;
            
            // å¦‚æœæ²’æœ‰å¸³è™Ÿï¼Œæ¸…ç©ºç›¸é—œæ¬„ä½
            if (!hasAccount)
            {
                entity.Account = null;
                entity.Password = null;
                entity.RoleId = null; // éç³»çµ±ä½¿ç”¨è€…ä¸éœ€è¦æ¬Šé™çµ„
            }

            // åŸºæœ¬é©—è­‰ - ä½¿ç”¨é€šçŸ¥æœå‹™
            if (string.IsNullOrWhiteSpace(entity.Code))
            {
                await NotificationService.ShowErrorAsync("å“¡å·¥ç·¨è™Ÿç‚ºå¿…å¡«");
                return false;
            }

            if (string.IsNullOrWhiteSpace(entity.Name))
            {
                await NotificationService.ShowErrorAsync("å“¡å·¥å§“åç‚ºå¿…å¡«");
                return false;
            }

            // æª¢æŸ¥å“¡å·¥ç·¨è™Ÿæ˜¯å¦é‡è¤‡
            var employeeCodeExists = await EmployeeService.IsEmployeeCodeExistsAsync(entity.Code, EmployeeId);
            if (employeeCodeExists)
            {
                await NotificationService.ShowErrorAsync($"å“¡å·¥ç·¨è™Ÿ '{entity.Code}' å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–ç·¨è™Ÿ");
                return false;
            }

            // å¦‚æœæœ‰è¨­å®šå¸³è™Ÿï¼Œé€²è¡Œå¸³è™Ÿç›¸é—œé©—è­‰
            if (hasAccount)
            {
                // æª¢æŸ¥å¸³è™Ÿæ˜¯å¦é‡è¤‡
                var accountExists = await EmployeeService.IsAccountExistsAsync(entity.Account!, EmployeeId);
                if (accountExists)
                {
                    await NotificationService.ShowErrorAsync($"å¸³è™Ÿ '{entity.Account}' å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–å¸³è™Ÿ");
                    return false;
                }

                // æ–°å¢æ™‚å¯†ç¢¼å¿…å¡«
                if (string.IsNullOrWhiteSpace(entity.Password) && !EmployeeId.HasValue)
                {
                    await NotificationService.ShowErrorAsync("æ–°å¢å“¡å·¥æ™‚ï¼Œè‹¥è¨­å®šå¸³è™Ÿå‰‡å¯†ç¢¼ç‚ºå¿…å¡«");
                    return false;
                }

                // æ¬Šé™çµ„å¿…å¡«
                if (!entity.RoleId.HasValue)
                {
                    await NotificationService.ShowErrorAsync("è¨­å®šå¸³è™Ÿæ™‚å¿…é ˆæŒ‡æ´¾æ¬Šé™çµ„");
                    return false;
                }
            }

            // è™•ç†å¯†ç¢¼é›œæ¹Š - åªæœ‰åœ¨æ–°å¢æˆ–å¯†ç¢¼æœ‰è®Šæ›´æ™‚æ‰é›œæ¹Š
            if (hasAccount && !string.IsNullOrWhiteSpace(entity.Password))
            {
                // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°å¯†ç¢¼ï¼ˆæ–°å¢æ¨¡å¼æˆ–å¯†ç¢¼æ¬„ä½è¢«ä¿®æ”¹ï¼‰
                bool isNewPassword = false;
                
                if (!EmployeeId.HasValue)
                {
                    // æ–°å¢æ¨¡å¼
                    isNewPassword = true;
                }
                else
                {
                    // ç·¨è¼¯æ¨¡å¼ï¼šæª¢æŸ¥å¯†ç¢¼æ˜¯å¦æœ‰è®Šæ›´
                    var originalEmployee = await EmployeeService.GetByIdAsync(EmployeeId.Value);
                    if (originalEmployee != null && originalEmployee.Password != entity.Password)
                    {
                        isNewPassword = true;
                    }
                }
                
                if (isNewPassword)
                {
                    // ä½¿ç”¨ SeedDataHelper çš„å¯†ç¢¼é›œæ¹Šæ–¹æ³•
                    entity.Password = SeedDataHelper.HashPassword(entity.Password);
                }
            }

            ServiceResult result;
            
            if (EmployeeId.HasValue)
            {
                // æ›´æ–°ç¾æœ‰å“¡å·¥
                result = await EmployeeService.UpdateAsync(entity);
            }
            else
            {
                // æ–°å¢å“¡å·¥
                result = await EmployeeService.CreateAsync(entity);
            }

            // è®“ GenericEditModalComponent è™•ç†é€šç”¨çš„æˆåŠŸ/å¤±æ•—è¨Šæ¯
            return result.IsSuccess;
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("å„²å­˜å“¡å·¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
            return false;
        }
    }

    private async Task OnSaveSuccess()
    {
        try
        {
            if (editModalComponent?.Entity != null)
            {
                await OnEmployeeSaved.InvokeAsync(editModalComponent.Entity);
            }
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("å„²å­˜æˆåŠŸå›èª¿æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    
    /// <summary>
    /// ä½¿ç”¨çµ±ä¸€ Helper ç”¢ç”Ÿéƒ¨é–€æ“ä½œæŒ‰éˆ•
    /// </summary>
    private async Task<List<FieldActionButton>> GetDepartmentActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            departmentModalManager, 
            nameof(Employee.DepartmentId)
        );
    }

    /// <summary>
    /// ä½¿ç”¨çµ±ä¸€ Helper ç”¢ç”Ÿè·ä½æ“ä½œæŒ‰éˆ•
    /// </summary>
    private async Task<List<FieldActionButton>> GetPositionActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            positionModalManager, 
            nameof(Employee.EmployeePositionId)
        );
    }

    /// <summary>
    /// ä½¿ç”¨çµ±ä¸€ Helper ç”¢ç”Ÿæ¬Šé™çµ„æ“ä½œæŒ‰éˆ•
    /// </summary>
    private async Task<List<FieldActionButton>> GetRoleActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            roleModalManager, 
            nameof(Employee.RoleId)
        );
    }

    // ===== éƒ¨é–€ç®¡ç†ç›¸é—œæ–¹æ³• - å·²é‡æ§‹ç‚ºä½¿ç”¨æ³›å‹ç®¡ç†å™¨ =====

    /// <summary>
    /// é–‹å•Ÿéƒ¨é–€ç·¨è¼¯ Modal - ä½¿ç”¨æ³›å‹ç®¡ç†å™¨
    /// </summary>
    private async Task OpenDepartmentModal(int? departmentId)
    {
        await departmentModalManager.OpenModalAsync(departmentId);
    }

    /// <summary>
    /// å–å¾—ç›®å‰é¸æ“‡çš„éƒ¨é–€ ID
    /// </summary>
    private int? GetSelectedDepartmentId()
    {
        try
        {
            return editModalComponent?.Entity?.DepartmentId;
        }
        catch
        {
            return null;
        }
    }

    /// <summary>
    /// å–å¾—æ€§åˆ¥çš„é¡¯ç¤ºåç¨±
    /// </summary>
    private static string GetGenderDisplayName(Gender gender)
    {
        var displayAttribute = gender.GetType()
            .GetField(gender.ToString())?
            .GetCustomAttribute<DisplayAttribute>();
        
        return displayAttribute?.Name ?? gender.ToString();
    }

    /// <summary>
    /// å–å¾—åœ¨è·ç‹€æ…‹çš„é¡¯ç¤ºåç¨±
    /// </summary>
    private static string GetEmployeeStatusDisplayName(EmployeeStatus status)
    {
        var displayAttribute = status.GetType()
            .GetField(status.ToString())?
            .GetCustomAttribute<DisplayAttribute>();
        
        return displayAttribute?.Name ?? status.ToString();
    }

    // ===== è»Šè¼› Tab ç›¸é—œæ–¹æ³• =====

    /// <summary>
    /// å–å¾—è»Šè¼›é å¡«å€¼ï¼ˆæ–°å¢æ™‚è‡ªå‹•å¸¶å…¥ EmployeeIdï¼‰
    /// </summary>
    private Dictionary<string, object?>? GetVehiclePrefilledValues()
    {
        if (!editingVehicleId.HasValue && EmployeeId.HasValue)
        {
            return new Dictionary<string, object?>
            {
                { nameof(Vehicle.EmployeeId), EmployeeId.Value }
            };
        }
        return null;
    }

    /// <summary>
    /// å»ºç«‹è»Šè¼› Tab çš„è‡ªè¨‚å…§å®¹ RenderFragment
    /// </summary>
    private RenderFragment CreateVehicleTabContent() => __builder =>
    {
        <VehicleTable Vehicles="@employeeVehicles"
                     OnAddVehicle="@HandleAddVehicle"
                     OnEditVehicle="@HandleEditVehicle"
                     OnUnlinkVehicle="@HandleUnlinkVehicle" />
    };

    /// <summary>
    /// æ–°å¢è»Šè¼›è³‡è¨Š - é–‹å•Ÿ VehicleEditModalï¼ˆæ–°å¢æ¨¡å¼ï¼Œè‡ªå‹•å¸¶å…¥ EmployeeIdï¼‰
    /// </summary>
    private void HandleAddVehicle()
    {
        editingVehicleId = null;
        isVehicleModalVisible = true;
        StateHasChanged();
    }

    /// <summary>
    /// ç·¨è¼¯è»Šè¼› - é–‹å•Ÿ VehicleEditModalï¼ˆç·¨è¼¯æ¨¡å¼ï¼‰
    /// </summary>
    private void HandleEditVehicle(Vehicle vehicle)
    {
        editingVehicleId = vehicle.Id;
        isVehicleModalVisible = true;
        StateHasChanged();
    }

    /// <summary>
    /// è§£é™¤è»Šè¼›é…çµ¦ - å°‡è»Šè¼›çš„ EmployeeId è¨­ç‚º nullï¼ˆä¸åˆªé™¤è»Šè¼›ï¼‰
    /// </summary>
    private async Task HandleUnlinkVehicle(Vehicle vehicle)
    {
        try
        {
            vehicle.EmployeeId = null;
            await VehicleService.UpdateAsync(vehicle);
            
            // é‡æ–°è¼‰å…¥è»Šè¼›åˆ—è¡¨
            if (EmployeeId.HasValue)
            {
                employeeVehicles = await VehicleService.GetByEmployeeAsync(EmployeeId.Value);
            }
            StateHasChanged();
            await NotificationService.ShowSuccessAsync($"å·²è§£é™¤è»Šè¼›ã€Œ{vehicle.LicensePlate}ã€çš„é…çµ¦");
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è§£é™¤é…çµ¦æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è»Šè¼›å„²å­˜å¾Œçš„å›èª¿ - é‡æ–°è¼‰å…¥è»Šè¼›åˆ—è¡¨
    /// </summary>
    private async Task OnVehicleSavedWrapper(Vehicle savedVehicle)
    {
        try
        {
            // ç¢ºä¿æ–°è»Šè¼›çš„ EmployeeId å·²è¨­å®š
            if (EmployeeId.HasValue && savedVehicle.EmployeeId != EmployeeId.Value)
            {
                savedVehicle.EmployeeId = EmployeeId.Value;
                await VehicleService.UpdateAsync(savedVehicle);
            }
            
            // é‡æ–°è¼‰å…¥è»Šè¼›åˆ—è¡¨
            if (EmployeeId.HasValue)
            {
                employeeVehicles = await VehicleService.GetByEmployeeAsync(EmployeeId.Value);
            }
            
            isVehicleModalVisible = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è»Šè¼›å„²å­˜å¾Œæ›´æ–°åˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è»Šè¼› Modal å¯è¦‹ç‹€æ…‹è®Šæ›´
    /// </summary>
    private async Task HandleVehicleModalVisibilityChanged(bool isVisible)
    {
        isVehicleModalVisible = isVisible;
        if (!isVisible && EmployeeId.HasValue)
        {
            // Modal é—œé–‰æ™‚é‡æ–°è¼‰å…¥è»Šè¼›åˆ—è¡¨
            employeeVehicles = await VehicleService.GetByEmployeeAsync(EmployeeId.Value);
        }
        StateHasChanged();
    }

    /// <summary>
    /// è»Šè¼› Modal å–æ¶ˆ
    /// </summary>
    private async Task HandleVehicleModalCancel()
    {
        isVehicleModalVisible = false;
        StateHasChanged();
        await Task.CompletedTask;
    }
}
