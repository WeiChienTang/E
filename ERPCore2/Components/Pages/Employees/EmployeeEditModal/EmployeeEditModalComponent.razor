@* 可重用的員工編輯組件 - 可在任何頁面中嵌入 *@
@using System.Security.Claims
@using ERPCore2.Helpers
@using ERPCore2.Helpers.EditModal
@using ERPCore2.Models.Reports
@using ERPCore2.Services.Reports
@using ERPCore2.Services.Reports.Interfaces
@inject IEmployeeService EmployeeService
@inject IDepartmentService DepartmentService
@inject IEmployeePositionService EmployeePositionService
@inject INotificationService NotificationService
@inject INavigationPermissionService NavigationPermissionService
@inject ICompanyModuleService CompanyModuleService
@inject ActionButtonHelper ActionButtonHelper
@inject IEmployeeDetailReportService EmployeeDetailReportService
@inject IStringLocalizer<SharedResource> L

<GenericEditModalComponent TEntity="Employee"
                          TService="IEmployeeService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@EmployeeId"
                          Service="@EmployeeService"
                          EntityName="@L["Entity.Employee"]"
                          EntityNamePlural="@L["Entity.Employee"]"
                          ModalTitle="@(EmployeeId.HasValue ? L["Message.EditTitle", L["Entity.Employee"]].ToString() : L["Message.CreateTitle", L["Entity.Employee"]].ToString())"
                          Size="GenericEditModalComponent<Employee, IEmployeeService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          TabDefinitions="@tabDefinitions"
                          AutoCompletePrefillers="@autoCompleteConfig?.Prefillers"
                          AutoCompleteCollections="@autoCompleteConfig?.Collections"
                          AutoCompleteDisplayProperties="@autoCompleteConfig?.DisplayProperties"
                          AutoCompleteValueProperties="@autoCompleteConfig?.ValueProperties"
                          ModalManagers="@modalManagers?.AsDictionary()"
                          DataLoader="@LoadEmployeeData"
                          SaveHandler="@SaveEmployee"
                          OnSaveSuccess="@OnSaveSuccess"
                          RequiredPermission="@PermissionRegistry.Employee.Read"
                          OnCancel="@OnCancel"
                          OnEntityLoaded="@HandleEntityLoaded"
                          ShowPrintButton="true"
                          PrintButtonText="@L["Button.Print"]"
                          ReportService="@EmployeeDetailReportService"
                          ReportId="@ReportIds.EmployeeDetail"
                          ReportPreviewTitle="@L["Label.DocumentPreview", L["Entity.Employee"]]"
                          GetReportDocumentName="@(e => $"員工-{e.Code}-{e.Name}")">
    <CustomActionButtons>
        @if (_hasAccountPermission && EmployeeId.HasValue)
        {
            <GenericButtonComponent Variant="ButtonVariant.DarkBlue"
                                   Text="@L["Button.AccountManagement"]"
                                   OnClick="@(() => _showAccountModal = true)"
                                   Title="管理此員工的系統帳號與權限" />
        }
    </CustomActionButtons>
</GenericEditModalComponent>

@* 部門編輯 Modal *@
<DepartmentEditModalComponent @ref="departmentEditModal"
                             IsVisible="@departmentModalManager.IsModalVisible"
                             IsVisibleChanged="@departmentModalManager.HandleModalVisibilityChangedAsync"
                             DepartmentId="@departmentModalManager.SelectedEntityId"
                             PrefilledValues="@departmentModalManager.PrefilledValues"
                             OnDepartmentSaved="@departmentModalManager.OnSavedAsync"
                             OnCancel="@departmentModalManager.HandleModalCancelAsync" />

@* 職位編輯 Modal *@
<EmployeePositionEditModalComponent @ref="positionEditModal"
                                   IsVisible="@positionModalManager.IsModalVisible"
                                   IsVisibleChanged="@positionModalManager.HandleModalVisibilityChangedAsync"
                                   EmployeePositionId="@positionModalManager.SelectedEntityId"
                                   PrefilledValues="@positionModalManager.PrefilledValues"
                                   OnEmployeePositionSaved="@positionModalManager.OnSavedAsync"
                                   OnCancel="@positionModalManager.HandleModalCancelAsync" />

@* 帳號管理 Modal *@
@if (_hasAccountPermission && EmployeeId.HasValue)
{
    <EmployeeAccountModalComponent IsVisible="@_showAccountModal"
                                  IsVisibleChanged="@((bool v) => _showAccountModal = v)"
                                  EmployeeId="@EmployeeId"
                                  OnSaved="@HandleAccountSavedAsync"
                                  OnCancel="@(() => _showAccountModal = false)" />
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? EmployeeId { get; set; }
    [Parameter] public EventCallback<Employee> OnEmployeeSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private GenericEditModalComponent<Employee, IEmployeeService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    private List<FormTabDefinition>? tabDefinitions;

    // 部門 Modal 管理器
    private DepartmentEditModalComponent? departmentEditModal;
    private RelatedEntityModalManager<Department> departmentModalManager = default!;

    // 職位 Modal 管理器
    private EmployeePositionEditModalComponent? positionEditModal;
    private RelatedEntityModalManager<EmployeePosition> positionModalManager = default!;

    private ModalManagerCollection modalManagers = default!;
    private AutoCompleteConfig? autoCompleteConfig;
    private List<Department> availableDepartments = new();
    private List<EmployeePosition> availablePositions = new();
    private bool isDataLoaded = false;

    // 帳號管理 Modal
    private bool _showAccountModal = false;
    private bool _hasAccountPermission = false;

    // Tab 元件參考（透過 @ref 呼叫公開方法）
    private EmployeeVehicleTab? vehicleTab;
    private EmployeeToolTab? toolTab;
    private EmployeeTrainingTab? trainingTab;

    // ===== Tab 內容 RenderFragment =====

    private RenderFragment CreateVehicleTabContent() => __builder =>
    {
        <EmployeeVehicleTab @ref="vehicleTab" EmployeeId="@EmployeeId" />
    };

    private RenderFragment CreateToolTabContent() => __builder =>
    {
        <EmployeeToolTab @ref="toolTab" EmployeeId="@EmployeeId" />
    };

    private RenderFragment CreateTrainingTabContent() => __builder =>
    {
        <EmployeeTrainingTab @ref="trainingTab" EmployeeId="@EmployeeId" />
    };

    // ===== 生命週期 =====

    protected override void OnInitialized()
    {
        try
        {
            modalManagers = ModalManagerInitHelper.CreateBuilder<Employee, IEmployeeService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Department>(nameof(Employee.DepartmentId), L["Entity.Department"].ToString())
                .AddManager<EmployeePosition>(nameof(Employee.EmployeePositionId), L["Entity.EmployeePosition"].ToString())
                .Build();
            departmentModalManager = modalManagers.Get<Department>(nameof(Employee.DepartmentId));
            positionModalManager = modalManagers.Get<EmployeePosition>(nameof(Employee.EmployeePositionId));
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("初始化員工編輯組件時發生錯誤");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
        }
    }

    // ===== 資料載入 =====

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            _hasAccountPermission = await NavigationPermissionService.CanAccessAsync("EmployeeEdit_Account_Password.Read");
            availableDepartments = await DepartmentService.GetAllAsync();
            availablePositions = await EmployeePositionService.GetAllAsync();

            autoCompleteConfig = new AutoCompleteConfigBuilder<Employee>()
                .AddFieldWithMultipleSearchProperties<Department>(
                    nameof(Employee.DepartmentId),
                    "Name",
                    availableDepartments,
                    new[] { "Name", "DepartmentCode" })
                .AddFieldWithMultipleSearchProperties<EmployeePosition>(
                    nameof(Employee.EmployeePositionId),
                    "Name",
                    availablePositions,
                    new[] { "Name", "PositionCode" })
                .Build();
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("載入員工編輯相關資料時發生錯誤");
            availableDepartments = new List<Department>();
            availablePositions = new List<EmployeePosition>();
        }
    }

    private async Task<Employee?> LoadEmployeeData()
    {
        try
        {
            if (!EmployeeId.HasValue)
            {
                vehicleTab?.Clear();
                toolTab?.Clear();
                trainingTab?.Clear();

                return new Employee
                {
                    Code = await EntityCodeGenerationHelper.GenerateForEntity<Employee, IEmployeeService>(EmployeeService, "EMP"),
                    Name = string.Empty,
                    IsSystemUser = false,
                    Status = EntityStatus.Active,
                    EmploymentStatus = EmployeeStatus.Active,
                    HireDate = DateTime.Today
                };
            }

            var employee = await EmployeeService.GetByIdAsync(EmployeeId.Value);

            if (employee == null)
            {
                return new Employee { Code = "ERROR", Name = "ERROR", Status = EntityStatus.Active };
            }

            return employee;
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("載入員工資料時發生錯誤");
            return new Employee { Code = "ERROR", Name = "ERROR", Status = EntityStatus.Active };
        }
    }

    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            if (loadedEntityId > 0)
            {
                if (vehicleTab != null) await vehicleTab.LoadAsync(loadedEntityId);
                if (toolTab != null) await toolTab.LoadAsync(loadedEntityId);
                if (trainingTab != null) await trainingTab.LoadAsync(loadedEntityId);
            }
            else
            {
                vehicleTab?.Clear();
                toolTab?.Clear();
                trainingTab?.Clear();
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入資料時發生錯誤：{ex.Message}");
        }
    }

    // ===== 儲存 =====

    private async Task<bool> SaveEmployee(Employee entity)
    {
        try
        {
            if (string.IsNullOrWhiteSpace(entity.Code))
            {
                await NotificationService.ShowErrorAsync("員工編號為必填");
                return false;
            }

            if (string.IsNullOrWhiteSpace(entity.Name))
            {
                await NotificationService.ShowErrorAsync("員工姓名為必填");
                return false;
            }

            var employeeCodeExists = await EmployeeService.IsEmployeeCodeExistsAsync(entity.Code, EmployeeId);
            if (employeeCodeExists)
            {
                await NotificationService.ShowErrorAsync($"員工編號 '{entity.Code}' 已存在，請使用其他編號");
                return false;
            }

            ServiceResult result = EmployeeId.HasValue
                ? await EmployeeService.UpdateAsync(entity)
                : await EmployeeService.CreateAsync(entity);

            if (result.IsSuccess && vehicleTab != null)
            {
                await vehicleTab.SavePendingChangesAsync(entity.Id);
            }

            return result.IsSuccess;
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("儲存員工資料時發生錯誤");
            return false;
        }
    }

    private async Task OnSaveSuccess()
    {
        try
        {
            if (editModalComponent?.Entity != null && editModalComponent.Entity.Id > 0)
            {
                if (vehicleTab != null) await vehicleTab.ReloadAsync(editModalComponent.Entity.Id);
                if (toolTab != null) await toolTab.LoadAsync(editModalComponent.Entity.Id);
                if (trainingTab != null) await trainingTab.LoadAsync(editModalComponent.Entity.Id);
                await OnEmployeeSaved.InvokeAsync(editModalComponent.Entity);
            }
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("儲存成功回調時發生錯誤");
        }
    }

    private async Task HandleAccountSavedAsync()
    {
        _showAccountModal = false;
        if (editModalComponent != null)
            await editModalComponent.RefreshEntityAsync();
    }

    // ===== 表單欄位初始化 =====

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                // 基本資訊區段
                new() { PropertyName = nameof(Employee.Code), Label = L["Field.EmployeeCode"], FieldType = FormFieldType.Text, Placeholder = L["Placeholder.PleaseInput", L["Field.EmployeeCode"]], IsRequired = true, MaxLength = 20, HelpText = "員工的唯一識別編號，新增時系統會自動產生，也可手動修改" },
                new() { PropertyName = nameof(Employee.Name), Label = L["Field.FullName"], FieldType = FormFieldType.Text, Placeholder = L["Placeholder.PleaseInput", L["Field.FullName"]], IsRequired = true, MaxLength = 10, HelpText = "員工的名字" },
                new()
                {
                    PropertyName = nameof(Employee.Gender), Label = L["Field.Gender"], FieldType = FormFieldType.Select, HelpText = "員工性別",
                    Options = Enum.GetValues<Gender>().Select(g => new SelectOption { Text = GetGenderDisplayName(g), Value = ((int)g).ToString() }).ToList()
                },
                new() { PropertyName = nameof(Employee.BirthDate), Label = L["Field.Birthday"], FieldType = FormFieldType.Date, Placeholder = L["Placeholder.PleaseSelect", L["Field.Birthday"]], HelpText = "員工出生日期" },
                new() { PropertyName = nameof(Employee.IdNumber), Label = L["Field.IdNumber"], FieldType = FormFieldType.Text, Placeholder = L["Placeholder.PleaseInput", L["Field.IdNumber"]], MaxLength = 10, HelpText = "員工身分證字號" },
                // 聯絡資訊區段
                new() { PropertyName = nameof(Employee.Mobile), Label = L["Field.PhoneNumber"], FieldType = FormFieldType.MobilePhone, Placeholder = "0912-345-678", HelpText = "員工個人手機號碼（10碼，以09開頭）" },
                new() { PropertyName = nameof(Employee.Email), Label = L["Field.Email"], FieldType = FormFieldType.Text, Placeholder = L["Placeholder.PleaseInput", L["Field.Email"]], MaxLength = 50, HelpText = "員工電子郵件地址" },
                new() { PropertyName = nameof(Employee.EmergencyContact), Label = L["Field.EmergencyContact"], FieldType = FormFieldType.Text, Placeholder = L["Placeholder.PleaseInput", L["Field.EmergencyContact"]], MaxLength = 10, HelpText = "緊急狀況時的聯絡人" },
                new() { PropertyName = nameof(Employee.EmergencyPhone), Label = L["Field.EmergencyPhone"], FieldType = FormFieldType.Text, Placeholder = L["Placeholder.PleaseInput", L["Field.EmergencyPhone"]], MaxLength = 20, HelpText = "緊急聯絡人電話號碼" },
                // 組織架構區段
                new() { PropertyName = nameof(Employee.DepartmentId), Label = L["Entity.Department"], FieldType = FormFieldType.AutoComplete, Placeholder = L["Placeholder.PleaseInputOrSelect", L["Entity.Department"]], MinSearchLength = 0, HelpText = "輸入部門名稱進行搜尋，或直接選擇", ActionButtons = await GetDepartmentActionButtonsAsync() },
                new() { PropertyName = nameof(Employee.EmployeePositionId), Label = L["Entity.EmployeePosition"], FieldType = FormFieldType.AutoComplete, Placeholder = L["Placeholder.PleaseInputOrSelect", L["Entity.EmployeePosition"]], MinSearchLength = 0, HelpText = "輸入職位名稱進行搜尋，或直接選擇", ActionButtons = await GetPositionActionButtonsAsync() },
                // 任職資訊區段
                new() { PropertyName = nameof(Employee.HireDate), Label = L["Field.HireDate"], FieldType = FormFieldType.Date, Placeholder = L["Placeholder.PleaseSelect", L["Field.HireDate"]], HelpText = "員工正式到職的日期" },
                new() { PropertyName = nameof(Employee.ResignationDate), Label = L["Field.ResignDate"], FieldType = FormFieldType.Date, Placeholder = L["Placeholder.PleaseSelect", L["Field.ResignDate"]], HelpText = "員工離職日期（在職者免填）" },
                new()
                {
                    PropertyName = nameof(Employee.EmploymentStatus), Label = L["Field.EmploymentStatus"], FieldType = FormFieldType.Select, HelpText = "員工目前的在職狀態",
                    Options = Enum.GetValues<EmployeeStatus>().Select(es => new SelectOption { Text = GetEmployeeStatusDisplayName(es), Value = ((int)es).ToString() }).ToList()
                },
                FormFieldConfigurationHelper.CreateRemarksField<Employee>()
            };

            // 車輛模組狀態（停用時隱藏車輛 Tab）
            var isVehiclesEnabled = await CompanyModuleService.IsModuleEnabledAsync("Vehicles");
            if (!isVehiclesEnabled)
                isVehiclesEnabled = await NavigationPermissionService.IsCurrentEmployeeSuperAdminAsync();

            var builder = FormSectionHelper<Employee>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    e => e.Code, e => e.Name, e => e.Gender, e => e.BirthDate, e => e.IdNumber,
                    e => e.Mobile, e => e.Email, e => e.EmergencyContact, e => e.EmergencyPhone)
                .AddToSection(FormSectionNames.EmploymentInfo,
                    e => e.DepartmentId, e => e.EmployeePositionId, e => e.HireDate, e => e.ResignationDate, e => e.EmploymentStatus)
                .AddToSection(FormSectionNames.AdditionalData,
                    e => e.Remarks)
                .GroupIntoTab(L["Tab.EmployeeData"].ToString(), "bi-person-fill", FormSectionNames.BasicInfo, FormSectionNames.EmploymentInfo, FormSectionNames.AdditionalData);

            if (isVehiclesEnabled)
                builder = builder.GroupIntoCustomTab(L["Tab.VehicleInfo"].ToString(), "bi-truck", CreateVehicleTabContent());

            var layout = builder
                .GroupIntoCustomTab(L["Tab.PersonalTools"].ToString(), "bi-tools", CreateToolTabContent())
                .GroupIntoCustomTab(L["Tab.Training"].ToString(), "bi-mortarboard", CreateTrainingTabContent())
                .BuildAll();

            formSections = layout.FieldSections;
            tabDefinitions = layout.TabDefinitions;
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("初始化表單欄位時發生錯誤");
        }
    }

    // ===== 輔助方法 =====

    private async Task<List<FieldActionButton>> GetDepartmentActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(editModalComponent, departmentModalManager, nameof(Employee.DepartmentId));
    }

    private async Task<List<FieldActionButton>> GetPositionActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(editModalComponent, positionModalManager, nameof(Employee.EmployeePositionId));
    }

    private static string GetGenderDisplayName(Gender gender)
    {
        var displayAttribute = gender.GetType().GetField(gender.ToString())?.GetCustomAttribute<DisplayAttribute>();
        return displayAttribute?.Name ?? gender.ToString();
    }

    private static string GetEmployeeStatusDisplayName(EmployeeStatus status)
    {
        var displayAttribute = status.GetType().GetField(status.ToString())?.GetCustomAttribute<DisplayAttribute>();
        return displayAttribute?.Name ?? status.ToString();
    }
}
