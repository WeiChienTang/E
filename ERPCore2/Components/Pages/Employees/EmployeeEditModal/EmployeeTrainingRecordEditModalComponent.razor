@* 員工受訓紀錄編輯組件 - 用於教育訓練 Tab 中 *@
@inject IEmployeeTrainingRecordService EmployeeTrainingRecordService
@inject INotificationService NotificationService

<GenericEditModalComponent TEntity="EmployeeTrainingRecord"
                          TService="IEmployeeTrainingRecordService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@EmployeeTrainingRecordId"
                          Service="@EmployeeTrainingRecordService"
                          EntityName="受訓紀錄"
                          EntityNamePlural="受訓紀錄"
                          ModalTitle="@(EmployeeTrainingRecordId.HasValue ? "編輯受訓紀錄" : "新增受訓紀錄")"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          DataLoader="@LoadTrainingRecordData"
                          UseGenericSave="true"
                          SaveSuccessMessage="@(EmployeeTrainingRecordId.HasValue ? "受訓紀錄更新成功" : "受訓紀錄新增成功")"
                          SaveFailureMessage="受訓紀錄儲存失敗"
                          RequiredPermission="Employee.Read"
                          OnEntitySaved="@OnEmployeeTrainingRecordSaved"
                          OnCancel="@OnCancel" />

@code {
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? EmployeeTrainingRecordId { get; set; }
    [Parameter] public int? PrefilledEmployeeId { get; set; }
    [Parameter] public EventCallback<EmployeeTrainingRecord> OnEmployeeTrainingRecordSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private GenericEditModalComponent<EmployeeTrainingRecord, IEmployeeTrainingRecordService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    private bool isDataLoaded = false;

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            await InitializeFormFieldsAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
        }
    }

    private async Task<EmployeeTrainingRecord?> LoadTrainingRecordData()
    {
        try
        {
            if (!EmployeeTrainingRecordId.HasValue)
            {
                var newRecord = new EmployeeTrainingRecord
                {
                    TrainingDate = DateTime.Today,
                    Status = EntityStatus.Active
                };

                if (PrefilledEmployeeId.HasValue)
                    newRecord.EmployeeId = PrefilledEmployeeId.Value;

                return newRecord;
            }

            return await EmployeeTrainingRecordService.GetByIdAsync(EmployeeTrainingRecordId.Value);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入受訓紀錄時發生錯誤：{ex.Message}");
            return null;
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(EmployeeTrainingRecord.CourseName),
                    Label = "課程名稱",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入課程名稱",
                    IsRequired = true,
                    MaxLength = 100,
                    HelpText = "訓練課程的完整名稱"
                },
                new()
                {
                    PropertyName = nameof(EmployeeTrainingRecord.TrainingDate),
                    Label = "受訓日期",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "開始受訓的日期"
                },
                new()
                {
                    PropertyName = nameof(EmployeeTrainingRecord.CompletedDate),
                    Label = "完成日期",
                    FieldType = FormFieldType.Date,
                    IsRequired = false,
                    HelpText = "完成或結業的日期（選填）"
                },
                new()
                {
                    PropertyName = nameof(EmployeeTrainingRecord.TrainingHours),
                    Label = "訓練時數",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "訓練總時數（小時，選填）"
                },
                new()
                {
                    PropertyName = nameof(EmployeeTrainingRecord.TrainingOrganization),
                    Label = "訓練機構",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入訓練機構名稱",
                    IsRequired = false,
                    MaxLength = 100,
                    HelpText = "提供訓練的機構或單位（選填）"
                },
                new()
                {
                    PropertyName = nameof(EmployeeTrainingRecord.Result),
                    Label = "結果/成績",
                    FieldType = FormFieldType.Text,
                    Placeholder = "例：通過、合格、85分",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "訓練結果或成績（選填）"
                },
                FormFieldConfigurationHelper.CreateRemarksField<EmployeeTrainingRecord>()
            };

            formSections = FormSectionHelper<EmployeeTrainingRecord>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    r => r.CourseName,
                    r => r.TrainingDate,
                    r => r.CompletedDate,
                    r => r.TrainingHours,
                    r => r.TrainingOrganization,
                    r => r.Result)
                .AddToSection(FormSectionNames.OtherInfo,
                    r => r.Remarks)
                .Build();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化受訓紀錄表單欄位時發生錯誤");
        }
    }
}
