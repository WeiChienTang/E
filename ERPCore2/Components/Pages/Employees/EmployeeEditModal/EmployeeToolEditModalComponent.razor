@* 可重用的員工工具配給紀錄編輯組件 - 用於員工 EditModal 的 Tab 頁籤中 *@
@inject IEmployeeToolService EmployeeToolService
@inject INotificationService NotificationService
@inject IStringLocalizer<SharedResource> L

<GenericEditModalComponent TEntity="EmployeeTool"
                          TService="IEmployeeToolService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@EmployeeToolId"
                          Service="@EmployeeToolService"
                          EntityName="@L["Entity.EmployeeTool"]"
                          EntityNamePlural="@L["Entity.EmployeeTool"]"
                          ModalTitle="@(EmployeeToolId.HasValue ? L["Message.EditTitle", L["Entity.EmployeeTool"]].ToString() : L["Message.CreateTitle", L["Entity.EmployeeTool"]].ToString())"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          DataLoader="@LoadToolData"
                          UseGenericSave="true"
                          SaveSuccessMessage="@(EmployeeToolId.HasValue ? L["Message.UpdateSuccess", L["Entity.EmployeeTool"]].ToString() : L["Message.CreateSuccess", L["Entity.EmployeeTool"]].ToString())"
                          SaveFailureMessage="@L["Message.SaveFailure", L["Entity.EmployeeTool"]]"
                          RequiredPermission="Employee.Read"
                          OnEntitySaved="@OnEmployeeToolSaved"
                          OnCancel="@OnCancel" />

@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? EmployeeToolId { get; set; }
    [Parameter] public int? PrefilledEmployeeId { get; set; }
    [Parameter] public EventCallback<EmployeeTool> OnEmployeeToolSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<EmployeeTool, IEmployeeToolService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();

    // 資料載入狀態標記
    private bool isDataLoaded = false;

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            await InitializeFormFieldsAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
        }
    }

    private async Task<EmployeeTool?> LoadToolData()
    {
        try
        {
            if (!EmployeeToolId.HasValue)
            {
                var newTool = new EmployeeTool
                {
                    AssignedDate = DateTime.Today,
                    Status = EntityStatus.Active
                };

                if (PrefilledEmployeeId.HasValue)
                    newTool.EmployeeId = PrefilledEmployeeId.Value;

                return newTool;
            }

            return await EmployeeToolService.GetByIdAsync(EmployeeToolId.Value);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入工具配給紀錄時發生錯誤：{ex.Message}");
            return null;
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(EmployeeTool.ToolName),
                    Label = L["Field.ToolName"],
                    FieldType = FormFieldType.Text,
                    Placeholder = L["Placeholder.PleaseInput", L["Field.ToolName"]],
                    IsRequired = true,
                    MaxLength = 50,
                    HelpText = "配給工具的名稱"
                },
                new()
                {
                    PropertyName = nameof(EmployeeTool.ToolCode),
                    Label = L["Field.SerialModel"],
                    FieldType = FormFieldType.Text,
                    Placeholder = L["Placeholder.PleaseInput", L["Field.SerialModel"]],
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "工具的序號、型號或識別碼（選填）"
                },
                new()
                {
                    PropertyName = nameof(EmployeeTool.AssignedDate),
                    Label = L["Field.AssignDate"],
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "公司將工具配給員工的日期"
                },
                new()
                {
                    PropertyName = nameof(EmployeeTool.ReturnedDate),
                    Label = L["Field.ReturnDate"],
                    FieldType = FormFieldType.Date,
                    IsRequired = false,
                    HelpText = "員工歸還工具的日期（未歸還則留空）"
                },
                FormFieldConfigurationHelper.CreateRemarksField<EmployeeTool>()
            };

            formSections = FormSectionHelper<EmployeeTool>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    t => t.ToolName,
                    t => t.ToolCode,
                    t => t.AssignedDate,
                    t => t.ReturnedDate)
                .AddToSection(FormSectionNames.OtherInfo,
                    t => t.Remarks)
                .Build();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化工具配給紀錄表單欄位時發生錯誤");
        }
    }
}
