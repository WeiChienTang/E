@page "/customers"
@using ERPCore2.Data.Entities
@using ERPCore2.Data.Enums
@using ERPCore2.Services
@using ERPCore2.Services.Interfaces
@using Microsoft.AspNetCore.Components.Web
@using ERPCore2.Components.Shared.Buttons
@using ERPCore2.Components.Shared.Alerts
@using ERPCore2.Components.Shared.Headers
@using ERPCore2.Components.Shared.Loading
@using ERPCore2.Components.Shared.Forms
@using ERPCore2.Components.Shared.Modals
@using static ERPCore2.Components.Shared.Buttons.ButtonComponent
@using static ERPCore2.Components.Shared.Alerts.AlertComponent
@inject ICustomerService CustomerService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>å®¢æˆ¶ç®¡ç†</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <PageHeaderComponent Title="å®¢æˆ¶ç®¡ç†" IconClass="fas fa-users">
                    <Actions>
                        <ButtonComponent Text="æ–°å¢å®¢æˆ¶" 
                                       Variant="ButtonVariant.Primary" 
                                       IconClass="fas fa-plus" 
                                       OnClick="NavigateToCreate" />
                    </Actions>
                </PageHeaderComponent>                
                <div class="card-body">
                    <!-- æœç´¢å€åŸŸ -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <SearchComponent Placeholder="æœç´¢å®¢æˆ¶ä»£ç¢¼æˆ–å…¬å¸åç¨±..." 
                                           SearchTerm="@searchTerm"
                                           SearchTermChanged="@OnSearchTermChanged"
                                           OnSearch="@OnSearchSubmit" />
                        </div>                        
                        <div class="col-md-4">
                            <SelectComponent TValue="string"
                                           Id="statusFilter" 
                                           Label=""
                                           @bind-Value="selectedStatus"
                                           Items="@(Enum.GetValues<EntityStatus>().Cast<object>())"
                                           GetItemText="@(item => GetStatusFilterText((EntityStatus)item))"
                                           GetItemValue="@(item => item.ToString())"
                                           EmptyOptionText="å…¨éƒ¨ç‹€æ…‹" />
                        </div>
                        <div class="col-md-4">
                            <ButtonComponent Text="æ¸…é™¤ç¯©é¸" 
                                           IconClass="fas fa-times" 
                                           OnClick="ClearFilters" />
                        </div>
                    </div><!-- è¨Šæ¯é¡¯ç¤ºå€åŸŸ -->
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <AlertComponent Type="AlertType.Danger" 
                                      Message="@errorMessage" 
                                      IconClass="fas fa-exclamation-triangle"
                                      OnDismiss="ClearError" />
                    }

                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <AlertComponent Type="AlertType.Success" 
                                      Message="@successMessage" 
                                      IconClass="fas fa-check-circle"
                                      OnDismiss="ClearSuccess" />
                    }                    <!-- è¼‰å…¥ä¸­æŒ‡ç¤ºå™¨ -->
                    <LoadingComponent IsLoading="@isLoading" 
                                    LoadingText="è¼‰å…¥å®¢æˆ¶è³‡æ–™ä¸­..." 
                                    ShowText="true" />
                      @if (!isLoading)
                    {
                        <!-- å®¢æˆ¶åˆ—è¡¨ -->                        
                        <TableComponent TItem="Customer" 
                                      Items="customers"
                                      Headers="tableHeaders"
                                      ShowActions="false"
                                      EnableRowClick="true"
                                      OnRowClick="ShowCustomerDetail"
                                      EmptyMessage="æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„å®¢æˆ¶è³‡æ–™">
                            <RowTemplate Context="customer">
                                <td>
                                    <strong>@customer.CustomerCode</strong>
                                </td>
                                <td>@customer.CompanyName</td>
                                <td>@(customer.ContactPerson ?? "-")</td>
                                <td>@(customer.TaxNumber ?? "-")</td>
                                <td>@(customer.CustomerType?.TypeName ?? "-")</td>
                                <td>@(customer.IndustryType?.IndustryTypeName ?? "-")</td>
                                <td>
                                    <StatusBadgeComponent Status="customer.Status" />
                                </td>
                                <td>@customer.CreatedAt.ToString("yyyy/MM/dd")</td>
                            </RowTemplate>
                        </TableComponent>
                    }
                </div>
            </div>        </div>    
        </div>
</div>

<!-- å®¢æˆ¶è©³ç´°è³‡æ–™æ¨¡æ…‹å°è©±æ¡† -->
<ERPCore2.Components.Shared.Modals.CustomerDetailModal @ref="customerDetailModal" 
                    Customer="selectedCustomer" 
                    OnClose="OnModalClose" />

@code {
    private List<Customer> customers = new();
    private List<Customer> allCustomers = new();
    
    private string searchTerm = string.Empty;
    private string selectedStatus = string.Empty;
    
    private bool isLoading = true;    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    
    // æ¨¡æ…‹ç›¸é—œè®Šæ•¸
    private CustomerDetailModal customerDetailModal = default!;
    private Customer? selectedCustomer;
    
    private List<string> tableHeaders = new()
    {
        "å®¢æˆ¶ä»£ç¢¼", "å…¬å¸åç¨±", "è¯çµ¡äºº", "çµ±ä¸€ç·¨è™Ÿ", 
        "å®¢æˆ¶é¡å‹", "è¡Œæ¥­åˆ¥", "ç‹€æ…‹", "å»ºç«‹æ—¥æœŸ"
    };
    
    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }
    
    private async Task LoadDataAsync()
    {
        try
        {
            isLoading = true;
            ClearMessages();
            
            allCustomers = await CustomerService.GetAllAsync();
            ApplyFilters();
        }        catch (Exception)
        {
            errorMessage = "è¼‰å…¥å®¢æˆ¶è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
            // å¯ä»¥è€ƒæ…®æ·»åŠ  logger æ³¨å…¥ä¾†è¨˜éŒ„éŒ¯èª¤
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private void ApplyFilters()
    {
        customers = allCustomers;
        
        // æœç´¢éæ¿¾
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var term = searchTerm.ToLower().Trim();
            customers = customers.Where(c => 
                c.CustomerCode.ToLower().Contains(term) || 
                c.CompanyName.ToLower().Contains(term) ||
                (c.ContactPerson?.ToLower().Contains(term) ?? false)
            ).ToList();
        }
        
        // ç‹€æ…‹éæ¿¾
        if (!string.IsNullOrWhiteSpace(selectedStatus) && Enum.TryParse<EntityStatus>(selectedStatus, out var status))
        {
            customers = customers.Where(c => c.Status == status).ToList();
        }
    }
      private async Task OnSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            ApplyFilters();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task OnSearchTermChanged(string newSearchTerm)
    {
        searchTerm = newSearchTerm;
        ApplyFilters();
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnSearchSubmit(string searchValue)
    {
        searchTerm = searchValue;
        ApplyFilters();
        await InvokeAsync(StateHasChanged);
    }
      private void ClearFilters()
    {
        searchTerm = string.Empty;
        selectedStatus = string.Empty;
        ApplyFilters();
        StateHasChanged();
    }
      private void NavigateToCreate()
    {
        Navigation.NavigateTo("/customers/create");
    }
    
    private void NavigateToEdit(int customerId)
    {
        Navigation.NavigateTo($"/customers/{customerId}/edit");
    }
    
    private async Task ConfirmDelete(int customerId, string companyName)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"ç¢ºå®šè¦åˆªé™¤å®¢æˆ¶ã€Œ{companyName}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚");
        
        if (confirmed)
        {
            try
            {
                var result = await CustomerService.DeleteAsync(customerId);
                
                if (result.IsSuccess)
                {
                    successMessage = "å®¢æˆ¶åˆªé™¤æˆåŠŸï¼";
                    await LoadDataAsync();
                }
                else
                {
                    errorMessage = $"å®¢æˆ¶åˆªé™¤å¤±æ•—: {result.ErrorMessage}";
                }
            }            catch (Exception)
            {
                errorMessage = "åˆªé™¤å®¢æˆ¶æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
            }
        }
    }
    
    private void ClearMessages()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;
    }
    
    private void ClearError() => errorMessage = string.Empty;
    private void ClearSuccess() => successMessage = string.Empty;
    
    // Watch for search term changes
    private string previousSearchTerm = string.Empty;
    private string previousStatus = string.Empty;
      protected override void OnAfterRender(bool firstRender)
    {
        if (!firstRender)
        {
            if (searchTerm != previousSearchTerm || selectedStatus != previousStatus)
            {
                previousSearchTerm = searchTerm;
                previousStatus = selectedStatus;
                
                ApplyFilters();
                StateHasChanged();
            }
        }
    }
      private string GetStatusFilterText(EntityStatus status)
    {
        return status switch
        {
            EntityStatus.Active => "å•Ÿç”¨",
            EntityStatus.Inactive => "åœç”¨",
            _ => status.ToString()
        };
    }    // æ¨¡æ…‹ç›¸é—œæ–¹æ³•
    private async Task ShowCustomerDetail(Customer customer)
    {
        Console.WriteLine($"ğŸ”µ æ­¥é©Ÿ1: æ¥æ”¶åˆ°é»æ“Šçš„å®¢æˆ¶: {customer.CompanyName}");
        
        selectedCustomer = customer;
        Console.WriteLine($"ğŸ”µ æ­¥é©Ÿ2: å·²è¨­å®š selectedCustomer = {selectedCustomer?.CompanyName}");
        Console.WriteLine($"ğŸ”µ æ­¥é©Ÿ3: Blazor ç¾åœ¨æœƒè‡ªå‹•å°‡ selectedCustomer å‚³éçµ¦ CustomerDetailModal.Customer åƒæ•¸");
        
        await customerDetailModal.ShowAsync();
        Console.WriteLine($"ğŸ”µ æ­¥é©Ÿ4: æ¨¡æ…‹è¦–çª—å·²é¡¯ç¤º");
    }
    
    private void OnModalClose()
    {
        selectedCustomer = null;
        StateHasChanged();
    }
}
