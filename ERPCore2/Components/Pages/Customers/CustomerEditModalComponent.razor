@* 可重用的客戶編輯組件 - 可在任何頁面中嵌入 *@
@using ERPCore2.Services.Reports.Interfaces
@using ERPCore2.Models.Reports
@inject ICustomerService CustomerService
@inject IEmployeeService EmployeeService
@inject IPaymentMethodService PaymentMethodService
@inject INotificationService NotificationService
@inject ICustomerRosterReportService CustomerRosterReportService
@inject IVehicleService VehicleService
@inject ActionButtonHelper ActionButtonHelper

<GenericEditModalComponent TEntity="Customer" 
                          TService="ICustomerService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@CustomerId"
                          Service="@CustomerService"
                          EntityName="客戶"
                          EntityNamePlural="客戶"
                          ModalTitle="@(CustomerId.HasValue ? "編輯客戶" : "新增客戶")"
                          Size="GenericEditModalComponent<Customer, ICustomerService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          TabDefinitions="@tabDefinitions"
                          AutoCompletePrefillers="@autoCompleteConfig?.Prefillers"
                          AutoCompleteCollections="@autoCompleteConfig?.Collections"
                          AutoCompleteDisplayProperties="@autoCompleteConfig?.DisplayProperties"
                          AutoCompleteValueProperties="@autoCompleteConfig?.ValueProperties"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadCustomerData"
                          UseGenericSave="true"
                          SaveSuccessMessage="@(CustomerId.HasValue ? "客戶更新成功" : "客戶新增成功")"
                          SaveFailureMessage="客戶儲存失敗"
                          RequiredPermission="Customer.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@OnCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          OnEntityLoaded="@HandleEntityLoaded"
                          ShowPrintButton="true"
                          PrintButtonText="列印"
                          ReportService="@CustomerRosterReportService"
                          ReportId="@ReportIds.CustomerRoster"
                          ReportPreviewTitle="客戶資料預覽"
                          GetReportDocumentName="@(e => $"客戶-{e.Code}")" />

@* 員工編輯 Modal *@
<EmployeeEditModalComponent @ref="employeeEditModal"
                           IsVisible="@employeeModalManager.IsModalVisible"
                           IsVisibleChanged="@employeeModalManager.HandleModalVisibilityChangedAsync"
                           EmployeeId="@employeeModalManager.SelectedEntityId"
                           OnEmployeeSaved="@OnEmployeeSavedWrapper"
                           OnCancel="@employeeModalManager.HandleModalCancelAsync" />

@* 付款方式編輯 Modal *@
<PaymentMethodEditModalComponent @ref="paymentMethodEditModal"
                                IsVisible="@paymentMethodModalManager.IsModalVisible"
                                IsVisibleChanged="@paymentMethodModalManager.HandleModalVisibilityChangedAsync"
                                PaymentMethodId="@paymentMethodModalManager.SelectedEntityId"
                                OnPaymentMethodSaved="@OnPaymentMethodSavedWrapper"
                                OnCancel="@paymentMethodModalManager.HandleModalCancelAsync" />

@* 車輛編輯 Modal - 條件式渲染避免循環元件實例化 *@
@if (isVehicleModalVisible)
{
    <VehicleEditModalComponent @ref="vehicleEditModal"
                              IsVisible="@isVehicleModalVisible"
                              IsVisibleChanged="@HandleVehicleModalVisibilityChanged"
                              VehicleId="@editingVehicleId"
                              PrefilledValues="@GetVehiclePrefilledValues()"
                              OnVehicleSaved="@OnVehicleSavedWrapper"
                              OnCancel="@HandleVehicleModalCancel" />
}

@* 車輛選擇 Modal *@
<VehicleSelectModal IsVisible="@isVehicleSelectModalVisible"
                    IsVisibleChanged="@HandleVehicleSelectModalVisibilityChanged"
                    ExcludeVehicleIds="@GetCurrentVehicleIds()"
                    OnVehicleSelected="@HandleVehicleSelected" />

@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? CustomerId { get; set; }
    [Parameter] public EventCallback<Customer> OnCustomerSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<Customer, ICustomerService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    private List<FormTabDefinition>? tabDefinitions;
    
    // AutoComplete 配置
    private AutoCompleteConfig? autoCompleteConfig;
    
    // 選項資料
    private List<Employee> availableEmployees = new();
    private List<PaymentMethod> availablePaymentMethods = new();
    
    // Modal Manager 集合
    private ModalManagerCollection? modalManagers;
    
    // 員工編輯 Modal 相關變數 - 使用泛型管理器
    private EmployeeEditModalComponent? employeeEditModal;
    private RelatedEntityModalManager<Employee> employeeModalManager = default!;
    
    // 付款方式編輯 Modal 相關變數 - 使用泛型管理器
    private PaymentMethodEditModalComponent? paymentMethodEditModal;
    private RelatedEntityModalManager<PaymentMethod> paymentMethodModalManager = default!;
    
    // 資料載入狀態標記
    private bool isDataLoaded = false;

    // 車輛 Tab 相關
    private List<Vehicle> customerVehicles = new();
    private VehicleEditModalComponent? vehicleEditModal;
    private bool isVehicleModalVisible = false;
    private int? editingVehicleId = null;
    private bool isVehicleSelectModalVisible = false;

    // 車輛配給緩衝（參考 PurchaseOrderTable 模式，等主檔儲存時才寫入 DB）
    private List<Vehicle> _pendingVehicleLinks = new();
    private List<Vehicle> _pendingVehicleUnlinks = new();

    // ===== 必要方法 =====
    
    /// <summary>
    /// 處理實體載入完成事件（由 GenericEditModalComponent 的導航觸發）
    /// 當上下筆切換時觸發 UI 更新，確保表單欄位正確渲染
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            // 清除待處理的車輛變更（切換記錄或新增時）
            _pendingVehicleLinks.Clear();
            _pendingVehicleUnlinks.Clear();

            // 載入該客戶的車輛資訊
            if (loadedEntityId > 0)
            {
                customerVehicles = await VehicleService.GetByCustomerAsync(loadedEntityId);
            }
            else
            {
                customerVehicles = new();
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入資料時發生錯誤：{ex.Message}");
        }
    }
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 使用 ModalManagerInitHelper 初始化所有 Manager
            modalManagers = ModalManagerInitHelper.CreateBuilder<Customer, ICustomerService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Employee>(nameof(Customer.EmployeeId), "員工")
                .AddManager<PaymentMethod>(nameof(Customer.PaymentMethodId), "付款方式")
                .Build();
            
            // 取得個別 Manager 供組件使用
            employeeModalManager = modalManagers.Get<Employee>(nameof(Customer.EmployeeId));
            paymentMethodModalManager = modalManagers.Get<PaymentMethod>(nameof(Customer.PaymentMethodId));
            
            // 移除自動載入資料，改為在 OnParametersSetAsync 中根據 IsVisible 載入
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化客戶編輯組件時發生錯誤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            await LoadAdditionalDataAsync();
            
            // 使用 AutoCompleteConfigHelper 建立配置
            autoCompleteConfig = new AutoCompleteConfigBuilder<Customer>()
                .AddField(nameof(Customer.EmployeeId), "Name", availableEmployees)
                .AddField(nameof(Customer.PaymentMethodId), "Name", availablePaymentMethods)
                .Build();
            
            await InitializeFormFieldsAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
        }
    }
    
    private async Task HandleSaveSuccess()
    {
        if (editModalComponent?.Entity != null)
        {
            // 儲存待處理的車輛配給變更（參考 PurchaseOrderTable 模式）
            await SavePendingVehicleChangesAsync(editModalComponent.Entity.Id);

            // 儲存後重新載入車輛列表（確保與 DB 同步）
            if (editModalComponent.Entity.Id > 0)
            {
                customerVehicles = await VehicleService.GetByCustomerAsync(editModalComponent.Entity.Id);
            }

            await OnCustomerSaved.InvokeAsync(editModalComponent.Entity);
        }
        // CloseModal 已由 GenericEditModalComponent 統一控制
    }
    private async Task<Customer?> LoadCustomerData()
    {
        try
        {
            if (!CustomerId.HasValue)
            {
                // 新增模式 - 清除前一筆的車輛資料與暫存
                customerVehicles = new List<Vehicle>();
                _pendingVehicleLinks.Clear();
                _pendingVehicleUnlinks.Clear();

                var newCustomer = new Customer
                {
                    Code = await EntityCodeGenerationHelper.GenerateForEntity<Customer, ICustomerService>(CustomerService, "CUST"),
                    Status = EntityStatus.Active
                };

                return newCustomer;
            }

            // 編輯模式
            var customer = await CustomerService.GetByIdAsync(CustomerId.Value);

            // 載入該客戶的車輛資訊
            customerVehicles = await VehicleService.GetByCustomerAsync(CustomerId.Value);

            return customer;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入客戶資料時發生錯誤：{ex.Message}");
            return null;
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
            new()
            {
                PropertyName = nameof(Customer.Code),
                Label = "客戶編號",
                FieldType = FormFieldType.Text,
                Placeholder = "請輸入客戶編號",
                IsRequired = true,
                MaxLength = 20,
                HelpText = "客戶的唯一識別編號，新增時系統會自動產生，也可手動修改"
            },
            new()
            {
                PropertyName = nameof(Customer.CompanyName),
                Label = "公司名稱",
                FieldType = FormFieldType.Text,
                Placeholder = "請輸入公司名稱",
                IsRequired = false,
                MaxLength = 20,
                HelpText = "客戶的完整公司名稱（公司名稱、負責人或聯絡人至少需填寫一項）"
            },
            new()
            {
                PropertyName = nameof(Customer.ContactPerson),
                Label = "聯絡人",
                FieldType = FormFieldType.Text,
                Placeholder = "請輸入聯絡人姓名",
                IsRequired = false,
                MaxLength = 10,
                HelpText = "主要聯絡人姓名（公司名稱、負責人或聯絡人至少需填寫一項）"
            },
            new()
            {
                PropertyName = nameof(Customer.TaxNumber),
                Label = "統一編號",
                FieldType = FormFieldType.Text,
                Placeholder = "請輸入統一編號",
                IsRequired = false,
                MaxLength = 8,
                HelpText = "公司統一編號（8位數字）"
            },
            new()
            {
                PropertyName = nameof(Customer.ResponsiblePerson),
                Label = "負責人",
                FieldType = FormFieldType.Text,
                Placeholder = "請輸入負責人姓名",
                IsRequired = false,
                MaxLength = 10,
                HelpText = "公司負責人姓名（公司名稱、負責人或聯絡人至少需填寫一項）"
            },
            new()
            {
                PropertyName = nameof(Customer.JobTitle),
                Label = "職稱",
                FieldType = FormFieldType.Text,
                Placeholder = "請輸入職稱",
                IsRequired = false,
                MaxLength = 10,
                HelpText = "聯絡人職稱"
            },
            new()
            {
                PropertyName = nameof(Customer.ContactPhone),
                Label = "聯絡電話",
                FieldType = FormFieldType.Text,
                Placeholder = "請輸入聯絡電話",
                IsRequired = false,
                MaxLength = 20,
                HelpText = "聯絡人或是公司聯絡電話"
            },
            new()
            {
                PropertyName = nameof(Customer.MobilePhone),
                Label = "行動電話",
                FieldType = FormFieldType.MobilePhone,
                Placeholder = "0912-345-678",
                HelpText = "聯絡人行動電話（10碼，以09開頭）"
            },
            new()
            {
                PropertyName = nameof(Customer.Fax),
                Label = "傳真",
                FieldType = FormFieldType.Text,
                Placeholder = "請輸入傳真號碼",
                IsRequired = false,
                MaxLength = 20,
                HelpText = "公司傳真號碼"
            },
            new()
            {
                PropertyName = nameof(Customer.Email),
                Label = "信箱",
                FieldType = FormFieldType.Text,
                Placeholder = "請輸入電子郵件",
                IsRequired = false,
                MaxLength = 50,
                HelpText = "聯絡人電子郵件地址"
            },
            new()
            {
                PropertyName = nameof(Customer.Website),
                Label = "公司網址",
                FieldType = FormFieldType.Text,
                Placeholder = "請輸入公司網址",
                IsRequired = false,
                MaxLength = 50,
                ContainerCssClass = "col-4",
                HelpText = "公司官方網站網址"
            },
            new()
            {
                PropertyName = nameof(Customer.ContactAddress),
                Label = "聯絡地址",
                FieldType = FormFieldType.Text,
                Placeholder = "請輸入聯絡地址",
                IsRequired = false,
                MaxLength = 50,
                HelpText = "公司聯絡地址",
                ContainerCssClass = "col-4"
            },
            new()
            {
                PropertyName = nameof(Customer.ShippingAddress),
                Label = "貨運地址",
                FieldType = FormFieldType.Text,
                Placeholder = "請輸入貨運地址",
                IsRequired = false,
                MaxLength = 50,
                HelpText = "貨物運送地址",
                ContainerCssClass = "col-4",
                ActionButtons = await GetShippingAddressActionButtonsAsync()
            },
            new()
            {
                PropertyName = nameof(Customer.PaymentMethodId),
                Label = "付款方式",
                FieldType = FormFieldType.AutoComplete,
                Placeholder = "請輸入或選擇付款方式",
                IsRequired = false,
                MinSearchLength = 0,
                HelpText = "客戶的付款方式（例如：現金、支票、匯款等）",
                ActionButtons = await GetPaymentMethodActionButtonsAsync()
            },
            new()
            {
                PropertyName = nameof(Customer.PaymentTerms),
                Label = "付款條件",
                FieldType = FormFieldType.Text,
                Placeholder = "請輸入付款條件",
                IsRequired = false,
                MaxLength = 50,
                HelpText = "付款條件說明（例如：月結30天、貨到付款等）"
            },
            new FormFieldDefinition()
            {
                PropertyName = nameof(Customer.PaymentDate),
                Label = "收款日",
                FieldType = FormFieldType.Number,
                Placeholder = "收款日1-30，30 表示每月最後一天",
                IsRequired = false,
                Min = 0,
                Max = 30,
                HelpText = "每月固定收款日期 (1-30)，輸入 0 表示月底收款。例如：12 表示每月12日、30 表示每月最後一天",
            },
            new FormFieldDefinition()
            {
                PropertyName = nameof(Customer.InvoiceTitle),
                Label = "發票抬頭",
                FieldType = FormFieldType.Text,
                Placeholder = "請輸入發票抬頭",
                IsRequired = false,
                MaxLength = 100,
                HelpText = "開立發票時使用的抬頭名稱",
                ActionButtons = await GetInvoiceTitleActionButtonsAsync()
            },
            new()
            {
                PropertyName = nameof(Customer.CreditLimit),
                Label = "信用額度",
                FieldType = FormFieldType.Number,
                Placeholder = "請輸入信用額度",
                IsRequired = false,
                HelpText = "客戶的信用額度上限"
            },
            new()
            {
                PropertyName = nameof(Customer.CurrentBalance),
                Label = "應收餘額",
                FieldType = FormFieldType.Number,
                Placeholder = "應收餘額",
                IsRequired = false,
                IsReadOnly = true,
                HelpText = "客戶目前的應收帳款餘額（系統自動計算）"
            },
            new()
            {
                PropertyName = nameof(Customer.EmployeeId),
                Label = "業務負責人",
                FieldType = FormFieldType.AutoComplete,
                Placeholder = "請輸入或選擇業務負責人",
                IsRequired = false,
                MinSearchLength = 0,
                HelpText = "負責此客戶的業務人員",
                ActionButtons = await GetEmployeeActionButtonsAsync()
            },
            new FormFieldDefinition()
            {
                PropertyName = nameof(Customer.CompanyContactPhone),
                Label = "聯絡電話",
                FieldType = FormFieldType.Text,
                Placeholder = "請輸入聯絡電話",
                IsRequired = false,
                MaxLength = 20,
                HelpText = "負責人或是公司聯絡電話"
            },

            FormFieldConfigurationHelper.CreateRemarksField<Customer>()
        };

        var layout = FormSectionHelper<Customer>.Create()
            .AddToSection(FormSectionNames.BasicInfo,
                c => c.Code,
                c => c.CompanyName,
                c => c.ResponsiblePerson,
                c => c.CompanyContactPhone,
                c => c.TaxNumber,
                c => c.Fax,
                c => c.Website,
                c => c.ContactAddress,
                c => c.ShippingAddress)
            .AddToSection(FormSectionNames.ContactPersonInfo,
                c => c.ContactPerson,
                c => c.JobTitle,
                c => c.ContactPhone,
                c => c.MobilePhone,
                c => c.Email)
            .AddToSection(FormSectionNames.PaymentInfo,
                c => c.PaymentMethodId,
                c => c.PaymentTerms,
                c => c.PaymentDate,
                c => c.InvoiceTitle,
                c => c.CreditLimit,
                c => c.CurrentBalance)
            .AddToSection(FormSectionNames.OtherInfo,
                c => c.EmployeeId,
                c => c.Remarks)
            .GroupIntoTab("客戶資料", "bi-building", FormSectionNames.BasicInfo, FormSectionNames.ContactPersonInfo, FormSectionNames.PaymentInfo, FormSectionNames.OtherInfo)
            .GroupIntoCustomTab("車輛資訊", "bi-truck", CreateVehicleTabContent())
            .BuildAll();
        
        formSections = layout.FieldSections;
        tabDefinitions = layout.TabDefinitions;
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化表單欄位時發生錯誤");
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }
    
    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // 載入可選擇的員工列表（排除超級管理員）
            var allEmployees = await EmployeeService.GetAllAsync();
            availableEmployees = allEmployees.Where(e => !e.IsSuperAdmin).ToList();
            // 載入可選擇的付款方式列表
            availablePaymentMethods = await PaymentMethodService.GetAllAsync();
            
            // 重新建立 AutoComplete 配置（資料更新後）
            autoCompleteConfig = new AutoCompleteConfigBuilder<Customer>()
                .AddField(nameof(Customer.EmployeeId), "Name", availableEmployees)
                .AddField(nameof(Customer.PaymentMethodId), "Name", availablePaymentMethods)
                .Build();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("載入客戶編輯相關資料時發生錯誤");
            availableEmployees = new List<Employee>();
            availablePaymentMethods = new List<PaymentMethod>();
        }
    }
    
    /// <summary>
    /// 配置 Modal 管理器
    /// </summary>
    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(Customer.EmployeeId), employeeModalManager },
            { nameof(Customer.PaymentMethodId), paymentMethodModalManager }
        };
    }
    
    /// <summary>
    /// 使用統一 Helper 產生員工操作按鈕
    /// </summary>
    private async Task<List<FieldActionButton>> GetEmployeeActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            employeeModalManager, 
            nameof(Customer.EmployeeId)
        );
    }
    
    /// <summary>
    /// 使用統一 Helper 產生付款方式操作按鈕
    /// </summary>
    private async Task<List<FieldActionButton>> GetPaymentMethodActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            paymentMethodModalManager, 
            nameof(Customer.PaymentMethodId)
        );
    }
    
    /// <summary>
    /// 產生發票抬頭操作按鈕 - 同公司名稱
    /// </summary>
    private Task<List<FieldActionButton>> GetInvoiceTitleActionButtonsAsync()
    {
        var buttons = new List<FieldActionButton>
        {
            new FieldActionButton
            {
                Text = "複製",
                Variant = "OutlinePrimary",
                Size = "Small",
                Title = "將公司名稱複製到發票抬頭",
                OnClick = async () => await CopyCompanyNameToInvoiceTitle(),
                IsDisabled = false
            }
        };
        
        return Task.FromResult(buttons);
    }
    
    /// <summary>
    /// 產生貨運地址操作按鈕 - 同聯絡地址
    /// </summary>
    private Task<List<FieldActionButton>> GetShippingAddressActionButtonsAsync()
    {
        var buttons = new List<FieldActionButton>
        {
            new FieldActionButton
            {
                Text = "複製",
                Variant = "OutlinePrimary",
                Size = "Small",
                Title = "將聯絡地址複製到貨運地址",
                OnClick = async () => await CopyContactAddressToShippingAddress(),
                IsDisabled = false
            }
        };
        
        return Task.FromResult(buttons);
    }

    /// <summary>
    /// 將公司名稱複製到發票抬頭欄位
    /// </summary>
    private async Task CopyCompanyNameToInvoiceTitle()
    {
        try
        {
            if (editModalComponent?.Entity != null)
            {
                // 複製公司名稱到發票抬頭
                editModalComponent.Entity.InvoiceTitle = editModalComponent.Entity.CompanyName;
                
                // 通知 UI 更新
                StateHasChanged();
                
                // 顯示成功訊息
                await NotificationService.ShowSuccessAsync("已將公司名稱複製到發票抬頭");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"複製公司名稱時發生錯誤：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 將聯絡地址複製到貨運地址欄位
    /// </summary>
    private async Task CopyContactAddressToShippingAddress()
    {
        try
        {
            if (editModalComponent?.Entity != null)
            {
                // 複製聯絡地址到貨運地址
                editModalComponent.Entity.ShippingAddress = editModalComponent.Entity.ContactAddress;
                
                // 通知 UI 更新
                StateHasChanged();
                
                // 顯示成功訊息
                await NotificationService.ShowSuccessAsync("已將聯絡地址複製到貨運地址");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"複製聯絡地址時發生錯誤：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 包裝員工儲存事件以符合原有介面
    /// </summary>
    private async Task OnEmployeeSavedWrapper(Employee savedEmployee)
    {
        await employeeModalManager.HandleEntitySavedAsync(savedEmployee, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// 包裝付款方式儲存事件以符合原有介面
    /// </summary>
    private async Task OnPaymentMethodSavedWrapper(PaymentMethod savedPaymentMethod)
    {
        await paymentMethodModalManager.HandleEntitySavedAsync(savedPaymentMethod, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// 處理欄位值變更事件
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // 使用統一 Helper 處理員工欄位變更
            if (fieldChange.PropertyName == nameof(Customer.EmployeeId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    employeeModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
            }
            // 使用統一 Helper 處理付款方式欄位變更
            else if (fieldChange.PropertyName == nameof(Customer.PaymentMethodId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    paymentMethodModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
            }
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("欄位變更處理時發生錯誤");
        }
    }

    // ===== 車輛 Tab 相關方法 =====

    /// <summary>
    /// 取得車輛預填值（新增時自動帶入 CustomerId）
    /// </summary>
    private Dictionary<string, object?>? GetVehiclePrefilledValues()
    {
        if (!editingVehicleId.HasValue && CustomerId.HasValue)
        {
            return new Dictionary<string, object?>
            {
                { nameof(Vehicle.CustomerId), CustomerId.Value }
            };
        }
        return null;
    }

    /// <summary>
    /// 建立車輛 Tab 的自訂內容 RenderFragment
    /// </summary>
    private RenderFragment CreateVehicleTabContent() => __builder =>
    {
        <VehicleTable Vehicles="@customerVehicles"
                     OnAddVehicle="@HandleAddVehicle"
                     OnSelectVehicle="@HandleOpenVehicleSelectModal"
                     OnEditVehicle="@HandleEditVehicle"
                     OnUnlinkVehicle="@HandleUnlinkVehicle" />
    };

    /// <summary>
    /// 新增車輛資訊
    /// </summary>
    private void HandleAddVehicle()
    {
        editingVehicleId = null;
        isVehicleModalVisible = true;
        StateHasChanged();
    }

    /// <summary>
    /// 編輯車輛
    /// </summary>
    private void HandleEditVehicle(Vehicle vehicle)
    {
        editingVehicleId = vehicle.Id;
        isVehicleModalVisible = true;
        StateHasChanged();
    }

    /// <summary>
    /// 解除車輛配給 - 緩衝處理，等主檔儲存時才寫入 DB
    /// </summary>
    private void HandleUnlinkVehicle(Vehicle vehicle)
    {
        // 從本地列表移除
        customerVehicles.RemoveAll(v => v.Id == vehicle.Id);

        // 如果之前選擇過配給，從待配給清單中移除
        _pendingVehicleLinks.RemoveAll(v => v.Id == vehicle.Id);

        // 加入待解除配給清單
        if (!_pendingVehicleUnlinks.Any(v => v.Id == vehicle.Id))
        {
            _pendingVehicleUnlinks.Add(vehicle);
        }

        StateHasChanged();
    }

    /// <summary>
    /// 車輛儲存後的回調 - 更新本地列表（不重新查詢 DB）
    /// </summary>
    private void OnVehicleSavedWrapper(Vehicle savedVehicle)
    {
        // VehicleEditModal 已儲存車輛實體到 DB（含 PrefilledValues 中的 FK）
        // 更新本地列表以反映變更
        var existingIndex = customerVehicles.FindIndex(v => v.Id == savedVehicle.Id);
        if (existingIndex >= 0)
        {
            // 編輯模式：更新本地列表中的車輛
            customerVehicles[existingIndex] = savedVehicle;
        }
        else
        {
            // 新增模式：加入本地列表
            customerVehicles.Add(savedVehicle);
        }

        isVehicleModalVisible = false;
        StateHasChanged();
    }

    private void HandleVehicleModalVisibilityChanged(bool isVisible)
    {
        isVehicleModalVisible = isVisible;
        StateHasChanged();
    }

    private async Task HandleVehicleModalCancel()
    {
        isVehicleModalVisible = false;
        StateHasChanged();
        await Task.CompletedTask;
    }

    // ===== 車輛選擇 Modal 相關 =====

    /// <summary>
    /// 開啟車輛選擇 Modal
    /// </summary>
    private void HandleOpenVehicleSelectModal()
    {
        isVehicleSelectModalVisible = true;
        StateHasChanged();
    }

    /// <summary>
    /// 車輛選擇 Modal 顯示狀態變更
    /// </summary>
    private void HandleVehicleSelectModalVisibilityChanged(bool isVisible)
    {
        isVehicleSelectModalVisible = isVisible;
        StateHasChanged();
    }

    /// <summary>
    /// 取得目前已車輛資訊的 ID 清單（用於排除已在列表中的車輛）
    /// </summary>
    private List<int> GetCurrentVehicleIds()
    {
        return customerVehicles.Select(v => v.Id).ToList();
    }

    /// <summary>
    /// 處理從選擇 Modal 選取的車輛 - 緩衝處理，等主檔儲存時才寫入 DB
    /// </summary>
    private void HandleVehicleSelected(Vehicle vehicle)
    {
        // 加入本地列表（供 UI 顯示）
        if (!customerVehicles.Any(v => v.Id == vehicle.Id))
        {
            customerVehicles.Add(vehicle);
        }

        // 如果之前解除過配給，從待解除清單中移除
        _pendingVehicleUnlinks.RemoveAll(v => v.Id == vehicle.Id);

        // 加入待配給清單
        if (!_pendingVehicleLinks.Any(v => v.Id == vehicle.Id))
        {
            _pendingVehicleLinks.Add(vehicle);
        }

        StateHasChanged();
    }

    // ===== 車輛配給儲存方法（參考 PurchaseOrderTable 模式） =====

    /// <summary>
    /// 儲存待處理的車輛配給變更
    /// </summary>
    private async Task SavePendingVehicleChangesAsync(int customerId)
    {
        foreach (var vehicle in _pendingVehicleLinks)
        {
            vehicle.CustomerId = customerId;
            await VehicleService.UpdateAsync(vehicle);
        }

        foreach (var vehicle in _pendingVehicleUnlinks)
        {
            vehicle.CustomerId = null;
            await VehicleService.UpdateAsync(vehicle);
        }

        _pendingVehicleLinks.Clear();
        _pendingVehicleUnlinks.Clear();
    }
}
