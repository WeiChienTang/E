@* 可重用的客戶拜訪紀錄列表面板 - 用於客戶 EditModal 的 Tab 頁籤中 *@
@using ERPCore2.Data.Entities
@using ERPCore2.Models.Enums
@inject IStringLocalizer<SharedResource> L

<div class="customer-visit-table-panel">
    @* 工具列 *@
    <div class="d-flex justify-content-between align-items-center mb-2 px-1">
        @if (!IsReadOnly)
        {
            <GenericButtonComponent Text="@L["Button.AddVisitRecord"]"
                                  Variant="ButtonVariant.DarkBlue"
                                  Size="ButtonSize.Small"
                                  OnClick="@HandleAddVisit"
                                  Title="@L["Button.AddVisitRecord"]" />
        }
        else
        {
            <span></span>
        }
    </div>

    @* 拜訪紀錄表格 *@
    <InteractiveTableComponent TItem="CustomerVisit"
                              Items="@(Visits ?? new List<CustomerVisit>())"
                              ColumnDefinitions="@GetColumnDefinitions()"
                              ShowHeader="true"
                              ShowRowNumbers="true"
                              IsStriped="true"
                              IsHoverable="true"
                              IsBordered="true"
                              IsReadOnly="true"
                              ShowBuiltInActions="@(!IsReadOnly)"
                              ShowBuiltInDeleteButton="false"
                              EnableAutoEmptyRow="false"
                              EmptyMessage="@L["Customer.NoVisits"]"
                              CustomActionsTemplate="@GetActionsTemplate()"
                              ActionsColumnWidth="80px" />
</div>

@code {
    /// <summary>拜訪紀錄清單</summary>
    [Parameter] public List<CustomerVisit>? Visits { get; set; }

    /// <summary>是否唯讀模式</summary>
    [Parameter] public bool IsReadOnly { get; set; } = false;

    /// <summary>點擊「新增拜訪紀錄」的回調</summary>
    [Parameter] public EventCallback OnAddVisit { get; set; }

    /// <summary>點擊編輯的回調</summary>
    [Parameter] public EventCallback<CustomerVisit> OnEditVisit { get; set; }

    /// <summary>點擊刪除的回調</summary>
    [Parameter] public EventCallback<CustomerVisit> OnDeleteVisit { get; set; }

    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            new InteractiveColumnDefinition
            {
                Title = L["Column.VisitDate"],
                PropertyName = nameof(CustomerVisit.VisitDate),
                ColumnType = InteractiveColumnType.Display,
                Width = "110px",
                DisplayFormatter = item =>
                {
                    if (item is CustomerVisit v)
                        return v.VisitDate.ToString("yyyy-MM-dd");
                    return "-";
                }
            },
            new InteractiveColumnDefinition
            {
                Title = L["Column.VisitMethod"],
                PropertyName = nameof(CustomerVisit.VisitType),
                ColumnType = InteractiveColumnType.Display,
                Width = "80px",
                DisplayFormatter = item =>
                {
                    if (item is CustomerVisit v)
                        return v.VisitType switch
                        {
                            VisitType.Phone => L["VisitType.Phone"],
                            VisitType.OnSite => L["VisitType.OnSite"],
                            VisitType.VideoConference => L["VisitType.VideoConference"],
                            VisitType.Email => L["VisitType.Email"],
                            VisitType.Other => L["VisitType.Other"],
                            _ => "-"
                        };
                    return "-";
                }
            },
            new InteractiveColumnDefinition
            {
                Title = L["Column.SalesEmployee"],
                PropertyName = nameof(CustomerVisit.EmployeeId),
                ColumnType = InteractiveColumnType.Display,
                Width = "90px",
                DisplayFormatter = item =>
                {
                    if (item is CustomerVisit v && v.Employee != null)
                        return v.Employee.Name ?? "-";
                    return "-";
                }
            },
            new InteractiveColumnDefinition
            {
                Title = L["Column.VisitPurpose"],
                PropertyName = nameof(CustomerVisit.Purpose),
                ColumnType = InteractiveColumnType.Display,
                Width = "150px",
                NullDisplayText = "-"
            },
            new InteractiveColumnDefinition
            {
                Title = L["Column.VisitResult"],
                PropertyName = nameof(CustomerVisit.Result),
                ColumnType = InteractiveColumnType.Display,
                NullDisplayText = "-"
            },
            new InteractiveColumnDefinition
            {
                Title = L["Column.NextFollowUp"],
                PropertyName = nameof(CustomerVisit.NextFollowUpDate),
                ColumnType = InteractiveColumnType.Display,
                Width = "110px",
                DisplayFormatter = item =>
                {
                    if (item is CustomerVisit v && v.NextFollowUpDate.HasValue)
                        return v.NextFollowUpDate.Value.ToString("yyyy-MM-dd");
                    return "-";
                }
            }
        };
    }

    private RenderFragment<CustomerVisit>? GetActionsTemplate()
    {
        if (IsReadOnly) return null;

        return visit => __builder =>
        {
            <div class="d-flex gap-1">
                <GenericButtonComponent IconClass="bi bi-pencil-square text-white"
                                      Variant="ButtonVariant.DarkBlue"
                                      Size="ButtonSize.Large"
                                      OnClick="@(() => OnEditVisit.InvokeAsync(visit))"
                                      Title="編輯此筆紀錄"
                                      CssClass="btn-square" />
                <GenericButtonComponent IconClass="bi bi-trash text-white"
                                      Variant="ButtonVariant.Red"
                                      Size="ButtonSize.Large"
                                      OnClick="@(() => OnDeleteVisit.InvokeAsync(visit))"
                                      Title="刪除此筆紀錄"
                                      CssClass="btn-square" />
            </div>
        };
    }

    private async Task HandleAddVisit()
    {
        await OnAddVisit.InvokeAsync();
    }
}
