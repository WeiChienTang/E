@* 盤點單編輯組件 *@
@using ERPCore2.Components.Shared.UI.Form
@using ERPCore2.Helpers
@using ERPCore2.Models
@using ERPCore2.Models.Enums
@using ERPCore2.Models.Reports
@using ERPCore2.Services.Reports.Interfaces
@inject IStockTakingService StockTakingService
@inject IWarehouseService WarehouseService
@inject IWarehouseLocationService WarehouseLocationService
@inject IEmployeeService EmployeeService
@inject IProductService ProductService
@inject INotificationService NotificationService
@inject IStockTakingDifferenceReportService StockTakingDifferenceReportService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<GenericEditModalComponent TEntity="StockTaking"
                          TService="IStockTakingService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@StockTakingId"
                          Service="@StockTakingService"
                          EntityName="盤點單"
                          EntityNamePlural="盤點單"
                          ModalTitle="@GetModalTitle()"
                          Size="GenericEditModalComponent<StockTaking, IStockTakingService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          AutoCompleteCollections="@(autoCompleteConfig?.Collections)"
                          AutoCompleteDisplayProperties="@(autoCompleteConfig?.DisplayProperties)"
                          AutoCompleteValueProperties="@(autoCompleteConfig?.ValueProperties)"
                          DataLoader="@LoadStockTakingData"
                          SaveHandler="@SaveStockTakingWrapper"
                          SaveSuccessMessage="@(StockTakingId.HasValue ? "盤點單更新成功" : "盤點單新增成功")"
                          SaveFailureMessage="盤點單儲存失敗"
                          RequiredPermission="StockTaking.Read"
                          OnEntitySaved="@OnStockTakingSaved"
                          OnCancel="@OnCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          CustomValidator="@ValidateStockTakingDetailsAsync"
                          CustomModules="@GetCustomModules()"
                          OnEntityLoaded="@HandleEntityLoaded"
                          FormHeaderContent="@WarningMessage"
                          CustomActionButtons="@CustomActionButtons"
                          ShowPrintButton="true"
                          PrintButtonText="列印"
                          ReportService="@StockTakingDifferenceReportService"
                          ReportId="@ReportIds.InventoryCount"
                          ReportPreviewTitle="盤點差異表預覽"
                          GetReportDocumentName="@(e => $"盤點差異表-{e.TakingNumber}")">
</GenericEditModalComponent>

<!-- 庫存調整確認 Modal -->
<GenericConfirmModalComponent IsVisible="@_showAdjustConfirmModal"
                             IsVisibleChanged="@((bool visible) => _showAdjustConfirmModal = visible)"
                             Title="庫存調整確認"
                             Icon="bi-arrow-left-right"
                             HeaderColor="BaseModalComponent.HeaderVariant.Warning"
                             Message="即將執行以下庫存調整："
                             Conditions="@_adjustConditions"
                             SummaryMessage="@_adjustSummaryMessage"
                             ConfirmButtonText="確定"
                             CancelButtonText="取消"
                             ConfirmButtonVariant="ButtonVariant.DarkBlue"
                             OnConfirm="@ExecuteAdjustment"
                             OnCancel="@(() => _showAdjustConfirmModal = false)" />

@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? StockTakingId { get; set; }
    [Parameter] public EventCallback<StockTaking> OnStockTakingSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<StockTaking, IStockTakingService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();

    // 相關資料
    private List<Warehouse> warehouses = new();
    private List<WarehouseLocation> warehouseLocations = new();
    private List<Employee> employees = new();
    private List<Product> products = new();

    // 下拉選單選項
    private List<SelectOption> warehouseOptions = new();
    private List<SelectOption> warehouseLocationOptions = new();
    private List<SelectOption> takingTypeOptions = new();
    private List<SelectOption> takingStatusOptions = new();

    // 盤點明細
    private List<StockTakingDetail> stockTakingDetails = new();
    private StockTakingTable? detailTableComponent;

    // 當前選擇的倉庫和庫位
    private int? selectedWarehouseId = null;
    private int? selectedWarehouseLocationId = null;

    // AutoComplete 配置
    private AutoCompleteConfig? autoCompleteConfig;

    // 資料載入狀態
    private bool isDataLoaded = false;

    // 庫存調整確認 Modal
    private bool _showAdjustConfirmModal = false;
    private List<string> _adjustConditions = new();
    private string _adjustSummaryMessage = string.Empty;
    
    // 鎖定狀態：是否有任何已調整的明細（用於鎖定主檔欄位）
    private bool hasAdjustedDetails = false;
    
    // 計算已調整和未調整的明細數量
    private int adjustedDetailsCount = 0;
    private int unadjustedDetailsCount = 0;

    // ===== 生命週期方法 =====

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            stockTakingDetails = new List<StockTakingDetail>();
            selectedWarehouseId = null;
            selectedWarehouseLocationId = null;
            hasAdjustedDetails = false; // 重置鎖定狀態
            adjustedDetailsCount = 0;
            unadjustedDetailsCount = 0;

            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
            hasAdjustedDetails = false; // 關閉時重置
            adjustedDetailsCount = 0;
            unadjustedDetailsCount = 0;
        }

        await base.OnParametersSetAsync();
    }

    // ===== Modal 標題 =====

    private string GetModalTitle()
    {
        if (!StockTakingId.HasValue) return "新增盤點單";

        // 全部明細都已調整 = 已完成
        if (hasAdjustedDetails && unadjustedDetailsCount == 0) return "檢視盤點單（已完成）";
        
        // 部分已調整 = 進行中
        if (hasAdjustedDetails) return "編輯盤點單（部分已調整）";

        var status = editModalComponent?.Entity?.TakingStatus;
        return status switch
        {
            StockTakingStatusEnum.Draft => "編輯盤點單（草稿）",
            StockTakingStatusEnum.InProgress => "執行盤點",
            StockTakingStatusEnum.Cancelled => "檢視盤點單（已取消）",
            _ => "編輯盤點單"
        };
    }

    // ===== 實體載入事件 =====

    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            var stockTaking = await StockTakingService.GetWithDetailsAsync(loadedEntityId);

            if (stockTaking?.StockTakingDetails != null)
            {
                stockTakingDetails = stockTaking.StockTakingDetails.ToList();
                selectedWarehouseId = stockTaking.WarehouseId;
                selectedWarehouseLocationId = stockTaking.WarehouseLocationId;
                
                // 關鍵：從明細計算鎖定狀態
                UpdateAdjustmentStatus();
            }
            else
            {
                stockTakingDetails = new List<StockTakingDetail>();
                hasAdjustedDetails = false;
                adjustedDetailsCount = 0;
                unadjustedDetailsCount = 0;
            }

            StateHasChanged();

            if (detailTableComponent != null)
            {
                await detailTableComponent.RefreshDetailsAsync();
            }

            // 重新初始化表單欄位以更新動態樣式（盤盈盤虧和完成率的顏色）
            await InitializeFormFieldsAsync();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleEntityLoaded), GetType(),
                additionalData: $"處理實體載入事件失敗 - EntityId: {loadedEntityId}");
            await NotificationService.ShowErrorAsync("載入明細資料時發生錯誤");
        }
    }
    // ===== 資料載入方法 =====

    private async Task<StockTaking?> LoadStockTakingData()
    {
        try
        {
            stockTakingDetails = new List<StockTakingDetail>();

            if (!StockTakingId.HasValue)
            {
                // 新增模式
                var newStockTaking = new StockTaking
                {
                    TakingNumber = await GenerateTakingNumberAsync(),
                    TakingDate = DateTime.Today,
                    TakingType = StockTakingTypeEnum.Full,
                    TakingStatus = StockTakingStatusEnum.Draft,
                    Status = EntityStatus.Active,
                    StockTakingDetails = new List<StockTakingDetail>()
                };

                return newStockTaking;
            }

            var stockTaking = await StockTakingService.GetWithDetailsAsync(StockTakingId.Value);

            if (stockTaking != null)
            {
                stockTakingDetails = stockTaking.StockTakingDetails?.ToList() ?? new List<StockTakingDetail>();
                selectedWarehouseId = stockTaking.WarehouseId;
                selectedWarehouseLocationId = stockTaking.WarehouseLocationId;
                
                // 關鍵：從明細計算鎖定狀態（在 Entity 被設置到 editModalComponent 之前）
                UpdateAdjustmentStatus();
                
                // 明細載入後重新初始化表單欄位，以更新動態樣式（盤盈盤虧和完成率的顏色）
                await InitializeFormFieldsAsync();
                
                // 強制 UI 更新，確保 FormFields 參數正確傳遞給 GenericEditModalComponent
                StateHasChanged();
            }

            return stockTaking;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadStockTakingData), GetType(),
                additionalData: $"載入盤點單資料失敗 - ID: {StockTakingId}");
            await NotificationService.ShowErrorAsync("載入盤點單資料失敗");
            return null;
        }
    }

    private async Task<string> GenerateTakingNumberAsync()
    {
        try
        {
            var today = DateTime.Today;
            var prefix = $"ST-{today:yyyyMMdd}-";

            // 取得今天的盤點單數量
            var todayStockTakings = await StockTakingService.GetByDateRangeAsync(today, today);
            var sequence = todayStockTakings.Count + 1;

            return $"{prefix}{sequence:D3}";
        }
        catch
        {
            return $"ST-{DateTime.Now:yyyyMMddHHmmss}";
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            var warehousesTask = WarehouseService.GetAllAsync();
            var warehouseLocationsTask = WarehouseLocationService.GetAllAsync();
            var employeesTask = EmployeeService.GetAllAsync();
            var productsTask = ProductService.GetAllAsync();

            await Task.WhenAll(warehousesTask, warehouseLocationsTask, employeesTask, productsTask);

            warehouses = await warehousesTask;
            warehouseLocations = await warehouseLocationsTask;
            var allEmployees = await employeesTask;
            employees = allEmployees.Where(e => !e.IsSuperAdmin).ToList();
            products = await productsTask;

            // 建立下拉選單選項
            warehouseOptions = warehouses.Select(w => new SelectOption
            {
                Text = w.Name ?? "",
                Value = w.Id.ToString()
            }).ToList();

            takingTypeOptions = new List<SelectOption>
            {
                new() { Text = "全盤", Value = ((int)StockTakingTypeEnum.Full).ToString() },
                new() { Text = "循環盤點", Value = ((int)StockTakingTypeEnum.Cycle).ToString() },
                new() { Text = "抽樣盤點", Value = ((int)StockTakingTypeEnum.Sample).ToString() },
                new() { Text = "特定商品盤點", Value = ((int)StockTakingTypeEnum.Specific).ToString() },
                new() { Text = "特定位置盤點", Value = ((int)StockTakingTypeEnum.Location).ToString() }
            };

            takingStatusOptions = new List<SelectOption>
            {
                new() { Text = "草稿", Value = ((int)StockTakingStatusEnum.Draft).ToString() },
                new() { Text = "進行中", Value = ((int)StockTakingStatusEnum.InProgress).ToString() },
                new() { Text = "已完成", Value = ((int)StockTakingStatusEnum.Completed).ToString() },
                new() { Text = "待審核", Value = ((int)StockTakingStatusEnum.PendingApproval).ToString() },
                new() { Text = "已審核", Value = ((int)StockTakingStatusEnum.Approved).ToString() },
                new() { Text = "已取消", Value = ((int)StockTakingStatusEnum.Cancelled).ToString() }
            };

            // AutoComplete 配置 - 倉庫、盤點員和監盤員
            autoCompleteConfig = new AutoCompleteConfigBuilder<StockTaking>()
                .AddField(nameof(StockTaking.WarehouseId), "Name", warehouses)
                .AddField(nameof(StockTaking.TakingPersonnel), "Name", employees)
                .AddField(nameof(StockTaking.SupervisingPersonnel), "Name", employees)
                .Build();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadAdditionalDataAsync), GetType(),
                additionalData: "載入盤點單相關資料失敗");
            await NotificationService.ShowErrorAsync("載入相關資料失敗");

            warehouses = new List<Warehouse>();
            warehouseLocations = new List<WarehouseLocation>();
            employees = new List<Employee>();
            products = new List<Product>();
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            // 使用 hasAdjustedDetails 判斷是否鎖定主表欄位
            // 當有任何明細已調整庫存時，主表欄位（倉庫、日期等）應鎖定
            // （因為此方法可能在 editModalComponent.Entity 尚未設置時被調用）
            
            formFields = new List<FormFieldDefinition>
            {
                new FormFieldDefinition
                {
                    PropertyName = nameof(StockTaking.TakingNumber),
                    Label = "盤點單號",
                    FieldType = FormFieldType.Text,
                    IsReadOnly = true,
                    Placeholder = "系統自動產生",
                    HelpText = "系統自動產生的唯一盤點單號"
                },
                new FormFieldDefinition
                {
                    PropertyName = nameof(StockTaking.TakingDate),
                    Label = "盤點日期",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    IsReadOnly = hasAdjustedDetails,
                    DefaultValue = DateTime.Today,
                    HelpText = "請選擇盤點的日期"
                },
                new FormFieldDefinition
                {
                    PropertyName = nameof(StockTaking.WarehouseId),
                    Label = "倉庫",
                    FieldType = FormFieldType.AutoComplete,
                    IsRequired = true,
                    IsReadOnly = hasAdjustedDetails,
                    Placeholder = "請選擇盤點倉庫",
                    MinSearchLength = 0,
                    HelpText = "選擇要進行盤點的倉庫"
                },
                new FormFieldDefinition
                {
                    PropertyName = nameof(StockTaking.WarehouseLocationId),
                    Label = "庫位",
                    FieldType = FormFieldType.Select,
                    IsRequired = false,
                    IsReadOnly = hasAdjustedDetails,
                    Options = warehouseLocationOptions,
                    Placeholder = "請選擇庫位（選填）",
                    HelpText = "可選擇特定庫位進行盤點，留空則盤點整個倉庫"
                },
                new FormFieldDefinition
                {
                    PropertyName = nameof(StockTaking.TakingType),
                    Label = "盤點類型",
                    FieldType = FormFieldType.Select,
                    IsRequired = true,
                    IsReadOnly = hasAdjustedDetails,
                    Options = takingTypeOptions,
                    DefaultValue = (int)StockTakingTypeEnum.Full,
                    HelpText = "選擇盤點的方式",
                    LabelHelpItems = new List<LabelHelpItem>
                    {
                        new LabelHelpItem
                        {
                            Title = "全盤",
                            Description = "盤點倉庫或庫位內所有商品，適合年度盤點或定期全面清查"
                        },
                        new LabelHelpItem
                        {
                            Title = "循環盤點",
                            Description = "按照計畫輪流盤點不同商品類別，維持日常庫存準確性"
                        },
                        new LabelHelpItem
                        {
                            Title = "抽樣盤點",
                            Description = "隨機抽取部分商品進行盤點，快速評估整體庫存準確度"
                        },
                        new LabelHelpItem
                        {
                            Title = "特定商品盤點",
                            Description = "針對高價值或異常商品進行重點盤點"
                        },
                        new LabelHelpItem
                        {
                            Title = "特定位置盤點",
                            Description = "針對特定儲位或區域進行盤點，適合區域輪動盤點"
                        }
                    }
                },
                new FormFieldDefinition
                {
                    PropertyName = nameof(StockTaking.TakingPersonnel),
                    Label = "盤點員",
                    FieldType = FormFieldType.AutoComplete,
                    IsRequired = true,
                    IsReadOnly = hasAdjustedDetails,
                    Placeholder = "請輸入或選擇盤點員",
                    MinSearchLength = 0,
                    HelpText = "負責執行盤點的人員"
                },
                new FormFieldDefinition
                {
                    PropertyName = nameof(StockTaking.SupervisingPersonnel),
                    Label = "監盤員",
                    FieldType = FormFieldType.AutoComplete,
                    IsRequired = false,
                    IsReadOnly = hasAdjustedDetails,
                    Placeholder = "請輸入或選擇監盤員",
                    MinSearchLength = 0,
                    HelpText = "負責監督盤點的人員"
                },

                // 盤點結果欄位
                new FormFieldDefinition
                {
                    PropertyName = nameof(StockTaking.TotalItems),
                    Label = "盤點項目",
                    FieldType = FormFieldType.Number,
                    IsReadOnly = true,
                    HelpText = "盤點清單中的商品總項目數"
                },
                new FormFieldDefinition
                {
                    PropertyName = nameof(StockTaking.CompletedItems),
                    Label = "已盤點數",
                    FieldType = FormFieldType.Number,
                    IsReadOnly = true,
                    HelpText = "已完成盤點的商品項目數"
                },
                new FormFieldDefinition
                {
                    PropertyName = nameof(StockTaking.DifferenceItems),
                    Label = "差異數",
                    FieldType = FormFieldType.Number,
                    IsReadOnly = true,
                    HelpText = "存在數量差異的商品項目數"
                },
                new FormFieldDefinition
                {
                    PropertyName = nameof(StockTaking.DifferenceAmount),
                    Label = "盤盈盤虧",
                    FieldType = FormFieldType.Number,
                    IsReadOnly = true,
                    DecimalPlaces = 2,
                    HelpText = "所有差異項目的金額總計",
                    CssClass = GetDifferenceAmountCssClass() // 動態設定顏色
                },
                new FormFieldDefinition
                {
                    PropertyName = nameof(StockTaking.CompletionRate),
                    Label = "完成率(%)",
                    FieldType = FormFieldType.Number,
                    IsReadOnly = true,
                    DecimalPlaces = 2,
                    HelpText = "已盤點項目數占總項目數的百分比",
                    CssClass = GetCompletionRateCssClass() // 動態設定顏色
                },

                FormFieldConfigurationHelper.CreateRemarksField<StockTaking>(readOnly: hasAdjustedDetails)
            };

            formSections = FormSectionHelper<StockTaking>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    st => st.TakingNumber,
                    st => st.TakingDate,
                    st => st.TakingType)
                .AddToSection("盤點資訊",
                    st => st.TakingPersonnel,
                    st => st.SupervisingPersonnel,
                    st => st.WarehouseId,
                    st => st.WarehouseLocationId)
                .AddToSection("盤點結果",
                    st => st.TotalItems,
                    st => st.CompletedItems,
                    st => st.DifferenceItems,
                    st => st.DifferenceAmount,
                    st => st.CompletionRate)
                .AddToSection(FormSectionNames.AdditionalData,
                    st => st.Remarks)
                .Build();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(InitializeFormFieldsAsync), GetType(),
                additionalData: "初始化表單欄位失敗");
            formFields = new List<FormFieldDefinition>();
            formSections = new Dictionary<string, string>();
        }
    }

    // ===== 自訂模組 =====

    private List<GenericEditModalComponent<StockTaking, IStockTakingService>.CustomModule> GetCustomModules()
    {
        if (editModalComponent == null)
        {
            return new List<GenericEditModalComponent<StockTaking, IStockTakingService>.CustomModule>();
        }

        return new List<GenericEditModalComponent<StockTaking, IStockTakingService>.CustomModule>
        {
            new GenericEditModalComponent<StockTaking, IStockTakingService>.CustomModule
            {
                Order = 1,
                IsVisible = true,
                Content = CreateDetailTableContent()
            }
        };
    }

    private RenderFragment CreateDetailTableContent() => __builder =>
    {
        if (editModalComponent?.Entity != null)
        {
            // 明細元件會自己處理單筆的鎖定，這裡只檢查整體狀態
            // 已審核或已取消時，整個 Table 在唯讀模式
            var isTableReadOnly = editModalComponent.Entity.TakingStatus == StockTakingStatusEnum.Approved ||
                                  editModalComponent.Entity.TakingStatus == StockTakingStatusEnum.Cancelled;

            <div class="mt-3">
                <StockTakingTable @ref="detailTableComponent"
                                 Details="@stockTakingDetails"
                                 DetailsChanged="@HandleDetailsChanged"
                                 IsReadOnly="@isTableReadOnly"
                                 SelectedWarehouseId="@selectedWarehouseId"
                                 SelectedWarehouseLocationId="@selectedWarehouseLocationId"
                                 Products="@products"
                                 WarehouseLocations="@warehouseLocations" />
            </div>
        }
    };

    private async void HandleDetailsChanged(List<StockTakingDetail> details)
    {
        stockTakingDetails = details;
        
        // 更新調整狀態計算
        UpdateAdjustmentStatus();
        
        // 重新初始化表單欄位以更新動態樣式（盤盈盤虧和完成率的顏色）
        await InitializeFormFieldsAsync();
        
        StateHasChanged();
    }
    
    /// <summary>
    /// 更新調整狀態計算（從明細檢查）
    /// </summary>
    private void UpdateAdjustmentStatus()
    {
        adjustedDetailsCount = stockTakingDetails.Count(d => d.IsAdjusted);
        unadjustedDetailsCount = stockTakingDetails.Count(d => !d.IsAdjusted && d.HasDifference);
        hasAdjustedDetails = adjustedDetailsCount > 0;
    }

    /// <summary>
    /// 取得盤盈盤虧欄位的 CSS 樣式
    /// - 正數=綠色，負數=紅色，零=默認
    /// </summary>
    private string GetDifferenceAmountCssClass()
    {
        var amount = stockTakingDetails?
            .Where(d => d.DifferenceAmount.HasValue)
            .Sum(d => d.DifferenceAmount!.Value) ?? 0;

        return amount switch
        {
            > 0 => "text-success fw-bold", // 正數：綠色粗體
            < 0 => "text-danger fw-bold",  // 負數：紅色粗體
            _ => "fw-bold"                 // 零：默認粗體
        };
    }

    /// <summary>
    /// 取得盤點完成率欄位的 CSS 樣式
    /// - 100%=綠色，其他=黃色
    /// </summary>
    private string GetCompletionRateCssClass()
    {
        var totalItems = stockTakingDetails?.Count ?? 0;
        var completedItems = stockTakingDetails?.Count(d => d.ActualStock.HasValue) ?? 0;
        var rate = totalItems > 0 ? (decimal)completedItems / totalItems * 100 : 0;

        return rate >= 100m 
            ? "text-success fw-bold"  // 100%：綠色粗體
            : "text-warning fw-bold"; // 其他：黃色粗體
    }

    // ===== 儲存處理 =====

    private async Task<bool> SaveStockTakingWrapper(StockTaking stockTaking)
    {
        try
        {
            if (stockTaking == null)
            {
                await NotificationService.ShowErrorAsync("沒有要儲存的盤點單資料");
                return false;
            }

            // 使用 SaveWithDetailsAsync 同時儲存主檔和明細
            // 這樣可以確保編輯模式下新增的明細也能正確存入資料庫
            var result = await StockTakingService.SaveWithDetailsAsync(stockTaking, stockTakingDetails);

            if (!result.IsSuccess)
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "儲存盤點單失敗");
                return false;
            }

            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveStockTakingWrapper), GetType(),
                additionalData: $"儲存盤點單失敗 - ID: {stockTaking?.Id}");
            await NotificationService.ShowErrorAsync($"儲存時發生錯誤：{ex.Message}");
            return false;
        }
    }

    // ===== 驗證方法 =====

    private async Task<bool> ValidateStockTakingDetailsAsync(StockTaking stockTaking)
    {
        try
        {
            // 驗證倉庫已選擇
            if (stockTaking.WarehouseId <= 0)
            {
                await NotificationService.ShowErrorAsync("請選擇盤點倉庫");
                return false;
            }

            // 驗證至少有一筆明細
            if (!stockTakingDetails.Any())
            {
                await NotificationService.ShowErrorAsync("請至少新增一筆盤點商品");
                return false;
            }

            // 驗證明細資料完整性
            var invalidDetails = stockTakingDetails.Where(d => d.ProductId <= 0).ToList();

            if (invalidDetails.Any())
            {
                await NotificationService.ShowErrorAsync("存在無效的明細資料，請檢查商品是否已選擇");
                return false;
            }

            // 如果有 Table 組件，使用其驗證方法
            if (detailTableComponent != null)
            {
                return await detailTableComponent.ValidateAsync();
            }

            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ValidateStockTakingDetailsAsync), GetType(),
                additionalData: "驗證盤點明細失敗");
            await NotificationService.ShowErrorAsync("驗證明細資料時發生錯誤");
            return false;
        }
    }

    // ===== 欄位變更處理 =====

    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // 倉庫變更時更新庫位選項
            if (fieldChange.PropertyName == nameof(StockTaking.WarehouseId))
            {
                var warehouseIdStr = fieldChange.Value?.ToString();
                if (int.TryParse(warehouseIdStr, out var warehouseId))
                {
                    selectedWarehouseId = warehouseId;
                    selectedWarehouseLocationId = null; // 倉庫變更時清空庫位
                    UpdateWarehouseLocationOptions(warehouseId);
                }
                else
                {
                    selectedWarehouseId = null;
                    selectedWarehouseLocationId = null;
                    warehouseLocationOptions.Clear();
                }
            }
            // 庫位變更時更新明細表
            else if (fieldChange.PropertyName == nameof(StockTaking.WarehouseLocationId))
            {
                var locationIdStr = fieldChange.Value?.ToString();
                var newLocationId = string.IsNullOrEmpty(locationIdStr) ? (int?)null : int.Parse(locationIdStr);
                
                // 如果已有明細且庫位變更，提示使用者
                if (stockTakingDetails.Any() && selectedWarehouseLocationId != newLocationId)
                {
                    // 清空明細，因為庫位已變更
                    stockTakingDetails.Clear();
                    if (detailTableComponent != null)
                    {
                        await detailTableComponent.RefreshDetailsAsync();
                    }
                }
                
                selectedWarehouseLocationId = newLocationId;
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(OnFieldValueChanged), GetType(),
                additionalData: $"處理欄位變更失敗 - Property: {fieldChange.PropertyName}");
        }
    }

    private void UpdateWarehouseLocationOptions(int warehouseId)
    {
        var locations = warehouseLocations.Where(l => l.WarehouseId == warehouseId).ToList();
        
        // 建立選項列表，加入空值選項作為預設
        warehouseLocationOptions = new List<SelectOption>
        {
            new SelectOption { Text = "不指定庫位（盤點整個倉庫）", Value = "" }
        };
        
        warehouseLocationOptions.AddRange(locations.Select(l => new SelectOption
        {
            Text = l.Name ?? "",
            Value = l.Id.ToString()
        }));

        // 更新表單欄位的選項
        var locationField = formFields.FirstOrDefault(f => f.PropertyName == nameof(StockTaking.WarehouseLocationId));
        if (locationField != null)
        {
            locationField.Options = warehouseLocationOptions;
        }
    }

    // ===== 庫存調整功能 =====

    /// <summary>
    /// 判斷是否可以執行庫存調整
    /// 條件：已儲存（有 Id）+ 尚有未調整的差異項目
    /// </summary>
    private bool CanApplyAdjustment =>
        editModalComponent?.Entity != null &&
        editModalComponent.Entity.Id > 0 &&
        unadjustedDetailsCount > 0;

    /// <summary>
    /// 取得差異項目數量（用於確認訊息）
    /// </summary>
    private int GetDifferenceItemsCount()
    {
        return stockTakingDetails.Count(d => d.HasDifference && !d.IsAdjusted);
    }

    /// <summary>
    /// 取得差異總金額（用於確認訊息）
    /// </summary>
    private decimal GetTotalDifferenceAmount()
    {
        return stockTakingDetails
            .Where(d => d.HasDifference && !d.IsAdjusted)
            .Sum(d => d.DifferenceAmount ?? 0);
    }

    /// <summary>
    /// 處理執行庫存調整按鈕點擊：驗證後顯示確認 Modal
    /// </summary>
    private async Task HandleApplyAdjustment()
    {
        try
        {
            // 安全檢查
            if (editModalComponent?.Entity == null)
            {
                await NotificationService.ShowErrorAsync("請先載入盤點單資料");
                return;
            }

            var entity = editModalComponent.Entity;

            // 檢查是否已儲存
            if (entity.Id <= 0)
            {
                await NotificationService.ShowErrorAsync("請先儲存盤點單後再執行庫存調整");
                return;
            }

            // 檢查是否有差異項目（僅計算尚未調整的）
            var differenceCount = GetDifferenceItemsCount();
            if (differenceCount == 0)
            {
                await NotificationService.ShowInfoAsync("沒有需要調整的差異項目");
                return;
            }

            // 建立確認條件清單
            var totalAmount = GetTotalDifferenceAmount();
            var amountDisplay = totalAmount >= 0 
                ? $"+{totalAmount:N2}" 
                : totalAmount.ToString("N2");

            _adjustConditions = new List<string>
            {
                $"差異項目數：{differenceCount} 筆",
                $"盤盈盤虧金額：{amountDisplay}",
                "系統將自動儲存盤點單後執行調整"
            };
            _adjustSummaryMessage = "執行後將更新對應庫位的庫存數量，此操作無法復原。是否確定執行？";

            _showAdjustConfirmModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleApplyAdjustment), GetType(),
                additionalData: $"準備庫存調整失敗 - StockTakingId: {editModalComponent?.Entity?.Id}");
            await NotificationService.ShowErrorAsync("準備庫存調整時發生錯誤");
        }
    }

    /// <summary>
    /// 執行庫存調整（確認 Modal 按下確認後調用）
    /// 流程：自動儲存 → 執行庫存調整
    /// </summary>
    private async Task ExecuteAdjustment()
    {
        try
        {
            var entity = editModalComponent!.Entity!;

            // 先自動儲存盤點單（確保所有明細都已寫入資料庫）
            var saveSuccess = await SaveStockTakingWrapper(entity);
            if (!saveSuccess)
            {
                await NotificationService.ShowErrorAsync("儲存盤點單失敗，無法執行庫存調整");
                return;
            }

            // 儲存成功後重新載入以取得正確的 Id
            await HandleEntityLoaded(entity.Id);

            var differenceCount = GetDifferenceItemsCount();

            // 執行庫存調整
            var result = await StockTakingService.GenerateAdjustmentTransactionsAsync(entity.Id);

            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync($"庫存調整完成，已處理 {differenceCount} 筆差異項目");
                
                // 重新載入資料以更新狀態
                await HandleEntityLoaded(entity.Id);
                StateHasChanged();
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "執行庫存調整失敗");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ExecuteAdjustment), GetType(),
                additionalData: $"執行庫存調整失敗 - StockTakingId: {editModalComponent?.Entity?.Id}");
            await NotificationService.ShowErrorAsync("執行庫存調整時發生錯誤");
        }
    }

    /// <summary>
    /// 取得警告訊息（顯示在表單欄位上方）
    /// 當有已調整的明細時，顯示鎖定警告訊息
    /// </summary>
    private RenderFragment? WarningMessage => __builder =>
    {
        @if (hasAdjustedDetails && unadjustedDetailsCount == 0)
        {
            // 全部已完成
            <GenericLockedFieldMessage IsVisible="true"
                                      Message="此盤點單已完成庫存調整，主檔及明細欄位已設為唯讀。"
                                      Type="GenericLockedFieldMessage.MessageType.Success" />
        }
        else if (hasAdjustedDetails)
        {
            // 部分已調整
            <GenericLockedFieldMessage IsVisible="true"
                                      Message="@($"已有 {adjustedDetailsCount} 筆明細完成庫存調整（該部分已鎖定），尚有 {unadjustedDetailsCount} 筆差異項目可繼續處理。")"
                                      Type="GenericLockedFieldMessage.MessageType.Info" />
        }
    };

    /// <summary>
    /// 取得自訂操作按鈕（顯示在 Modal 頂部左側）
    /// </summary>
    private RenderFragment? CustomActionButtons => __builder =>
    {
        @* 執行庫存調整按鈕 - 已儲存後顯示 *@
        @if (editModalComponent?.Entity?.Id > 0)
        {
            // 全部已調整則禁用
            var allAdjusted = hasAdjustedDetails && unadjustedDetailsCount == 0;
            var buttonText = allAdjusted ? "調整完成" : "調整庫存";
            var buttonVariant = allAdjusted ? ButtonVariant.Gray : ButtonVariant.DarkBlue;
            
            <GenericButtonComponent Text="@buttonText"
                                  Variant="@buttonVariant"
                                  OnClick="@HandleApplyAdjustment"
                                  IsDisabled="@allAdjusted"
                                  Title="@(allAdjusted ? "此盤點單已執行過庫存調整" : "將盤點結果更新到對應庫位的庫存")" />
        }
    };
}
