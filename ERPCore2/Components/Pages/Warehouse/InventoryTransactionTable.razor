@* 庫存異動明細表格組件 - 使用 InteractiveTableComponent 統一UI（唯讀顯示） *@
@using ERPCore2.Data.Entities
@using ERPCore2.Data.Enums
@using ERPCore2.Helpers
@using ERPCore2.Models

<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <InteractiveTableComponent @ref="tableComponent"
                                  TItem="TransactionDetailItem" 
                                  Items="@DetailItems"
                                  ColumnDefinitions="@GetColumnDefinitions()"
                                  ShowHeader="true"
                                  ShowBuiltInActions="true"
                                  ShowBuiltInDeleteButton="false"
                                  ActionsColumnWidth="60px"
                                  CustomActionsTemplate="@GetCustomActionsTemplate"
                                  ShowRowNumbers="true"
                                  IsReadOnly="true"
                                  EmptyMessage="無明細資料"
                                  CssClass="mb-0"
                                  EnableAutoEmptyRow="false"
                                  DataLoadCompleted="true" />
    </div>
</div>

@* 關聯異動查看 Modal *@
<InventoryTransactionRelatedModal IsVisible="@showRelatedModal"
                                  IsVisibleChanged="@((bool visible) => showRelatedModal = visible)"
                                  TransactionNumber="@TransactionNumber"
                                  ProductId="@selectedProductId"
                                  ProductName="@selectedProductName" />

@code {
    // ===== 參數 =====
    [Parameter] public List<InventoryTransactionDetail>? Details { get; set; }
    
    /// <summary>
    /// 異動編號（用於查詢關聯交易）
    /// </summary>
    [Parameter] public string? TransactionNumber { get; set; }
    
    /// <summary>
    /// 是否顯示異動前/後庫存欄位（預設 false，用於庫存異動查詢頁面時可設為 true）
    /// </summary>
    [Parameter] public bool ShowStockBeforeAfter { get; set; } = false;
    
    /// <summary>
    /// 是否顯示操作類型欄位（OperationType）
    /// </summary>
    [Parameter] public bool ShowOperationType { get; set; } = true;
    
    // ===== 內部狀態 =====
    private InteractiveTableComponent<TransactionDetailItem>? tableComponent;
    private List<TransactionDetailItem> DetailItems { get; set; } = new();
    private List<InventoryTransactionDetail>? _previousDetails;
    
    // ===== 關聯查看狀態 =====
    private bool showRelatedModal = false;
    private int? selectedProductId = null;
    private string? selectedProductName = null;
    
    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        
        // 檢查明細是否變更（使用參考比較或數量比較）
        if (!ReferenceEquals(_previousDetails, Details) || 
            (_previousDetails?.Count ?? 0) != (Details?.Count ?? 0))
        {
            _previousDetails = Details;
            LoadDetails();
        }
    }
    
    /// <summary>
    /// 載入明細資料到顯示項目
    /// </summary>
    private void LoadDetails()
    {
        DetailItems.Clear();
        
        if (Details == null || !Details.Any())
        {
            return;
        }
        
        foreach (var detail in Details.OrderBy(d => d.OperationTime).ThenBy(d => d.Id))
        {
            DetailItems.Add(new TransactionDetailItem
            {
                DetailEntity = detail,
                ProductCode = detail.Product?.Code ?? "-",
                ProductName = detail.Product?.Name ?? "-",
                WarehouseLocationName = detail.WarehouseLocation?.Name ?? "-",
                Quantity = detail.Quantity,
                UnitCost = detail.UnitCost,
                Amount = detail.Amount,
                StockBefore = detail.StockBefore,
                StockAfter = detail.StockAfter,
                BatchNumber = detail.BatchNumber ?? "-",
                OperationType = detail.OperationType,
                OperationNote = detail.OperationNote ?? "-",
                OperationTime = detail.OperationTime
            });
        }
        
        StateHasChanged();
    }
    
    /// <summary>
    /// 取得欄位定義
    /// </summary>
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>
        {
            // 商品編號
            new()
            {
                Title = "商品編號",
                PropertyName = nameof(TransactionDetailItem.ProductCode),
                ColumnType = InteractiveColumnType.Display,
                Width = "120px",
                IsReadOnly = true
            },
            // 商品名稱
            new()
            {
                Title = "商品名稱",
                PropertyName = nameof(TransactionDetailItem.ProductName),
                ColumnType = InteractiveColumnType.Display,
                Width = "180px",
                IsReadOnly = true
            },
            // 倉位
            new()
            {
                Title = "倉位",
                PropertyName = nameof(TransactionDetailItem.WarehouseLocationName),
                ColumnType = InteractiveColumnType.Display,
                Width = "100px",
                IsReadOnly = true
            },
            // 數量
            new()
            {
                Title = "數量",
                PropertyName = nameof(TransactionDetailItem.Quantity),
                ColumnType = InteractiveColumnType.Custom,
                Width = "100px",
                TextAlign = "right",
                IsReadOnly = true,
                CustomTemplate = item =>
                {
                    var detailItem = (TransactionDetailItem)item;
                    return @<span class="@GetQuantityColorClass(detailItem.Quantity)">@NumberFormatHelper.FormatSmart(detailItem.Quantity)</span>;
                }
            }
        };
        
        // 操作類型欄位（根據參數決定是否顯示）
        if (ShowOperationType)
        {
            columns.Add(new()
            {
                Title = "操作類型",
                PropertyName = nameof(TransactionDetailItem.OperationType),
                ColumnType = InteractiveColumnType.Custom,
                Width = "90px",
                TextAlign = "center",
                IsReadOnly = true,
                CustomTemplate = item =>
                {
                    var detailItem = (TransactionDetailItem)item;
                    return @<span class="@GetOperationTypeBadgeClass(detailItem.OperationType)">@GetOperationTypeDisplayName(detailItem.OperationType)</span>;
                }
            });
        }
        
        // 異動前/後庫存欄位（根據參數決定是否顯示）
        if (ShowStockBeforeAfter)
        {
            columns.Add(new()
            {
                Title = "異動前",
                PropertyName = nameof(TransactionDetailItem.StockBefore),
                ColumnType = InteractiveColumnType.Custom,
                Width = "100px",
                TextAlign = "right",
                IsReadOnly = true,
                CustomTemplate = item =>
                {
                    var detailItem = (TransactionDetailItem)item;
                    return @<span class="text-muted">@NumberFormatHelper.FormatSmart(detailItem.StockBefore)</span>;
                }
            });
            
            columns.Add(new()
            {
                Title = "異動後",
                PropertyName = nameof(TransactionDetailItem.StockAfter),
                ColumnType = InteractiveColumnType.Custom,
                Width = "100px",
                TextAlign = "right",
                IsReadOnly = true,
                CustomTemplate = item =>
                {
                    var detailItem = (TransactionDetailItem)item;
                    return @<span class="fw-bold">@NumberFormatHelper.FormatSmart(detailItem.StockAfter)</span>;
                }
            });
        }
        
        return columns;
    }
    
    /// <summary>
    /// 取得操作類型的顯示名稱
    /// </summary>
    private string GetOperationTypeDisplayName(InventoryOperationTypeEnum operationType)
    {
        return operationType switch
        {
            InventoryOperationTypeEnum.Initial => "首次",
            InventoryOperationTypeEnum.Adjust => "調整",
            InventoryOperationTypeEnum.Delete => "刪除",
            _ => operationType.ToString()
        };
    }
    
    /// <summary>
    /// 取得操作類型的 Badge 樣式
    /// </summary>
    private string GetOperationTypeBadgeClass(InventoryOperationTypeEnum operationType)
    {
        return operationType switch
        {
            InventoryOperationTypeEnum.Initial => "badge bg-primary",
            InventoryOperationTypeEnum.Adjust => "badge bg-warning text-dark",
            InventoryOperationTypeEnum.Delete => "badge bg-danger",
            _ => "badge bg-secondary"
        };
    }
    
    /// <summary>
    /// 自訂操作欄位模板 - 顯示查看關聯按鈕
    /// </summary>
    private RenderFragment<TransactionDetailItem> GetCustomActionsTemplate => item => __builder =>
    {
        // 顯示查看此商品異動歷史的按鈕
        <GenericButtonComponent Variant="ButtonVariant.Blue"
                               IconClass="bi bi-clock-history text-white"
                               Size="ButtonSize.Large"
                               Title="查看此商品的異動歷史"
                               OnClick="() => ShowProductTransactionHistory(item)"
                               StopPropagation="true"
                               CssClass="btn-square" />
    };
    
    /// <summary>
    /// 顯示特定商品的異動歷史
    /// </summary>
    private void ShowProductTransactionHistory(TransactionDetailItem item)
    {
        if (item?.DetailEntity?.ProductId != null)
        {
            selectedProductId = item.DetailEntity.ProductId;
            selectedProductName = item.ProductName;
            showRelatedModal = true;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// 取得數量顏色樣式（正數綠色、負數紅色）
    /// </summary>
    private string GetQuantityColorClass(decimal quantity)
    {
        if (quantity > 0) return "text-success fw-bold";
        if (quantity < 0) return "text-danger fw-bold";
        return "";
    }
    
    /// <summary>
    /// 計算總數量
    /// </summary>
    private decimal GetTotalQuantity()
    {
        return DetailItems?.Sum(d => d.Quantity) ?? 0;
    }
    
    /// <summary>
    /// 計算總金額
    /// </summary>
    private decimal GetTotalAmount()
    {
        return DetailItems?.Sum(d => d.Amount) ?? 0;
    }
    
    /// <summary>
    /// 明細顯示項目類別
    /// </summary>
    public class TransactionDetailItem
    {
        public InventoryTransactionDetail? DetailEntity { get; set; }
        public string ProductCode { get; set; } = string.Empty;
        public string ProductName { get; set; } = string.Empty;
        public string WarehouseLocationName { get; set; } = string.Empty;
        public decimal Quantity { get; set; }
        public decimal? UnitCost { get; set; }
        public decimal Amount { get; set; }
        public decimal StockBefore { get; set; }
        public decimal StockAfter { get; set; }
        public string BatchNumber { get; set; } = string.Empty;
        
        // 操作類型相關欄位
        public InventoryOperationTypeEnum OperationType { get; set; } = InventoryOperationTypeEnum.Initial;
        public string OperationNote { get; set; } = string.Empty;
        public DateTime OperationTime { get; set; }
    }
}
