@*
    庫存警戒線設定 Modal 組件
    用於批次設定未設定警戒線的庫存明細
*@
@using ERPCore2.Data.Entities
@using ERPCore2.Services
@using ERPCore2.Models
@inject IInventoryStockService InventoryStockService
@inject INotificationService NotificationService
@inject IStringLocalizer<SharedResource> L

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@Title"
                   Icon="bi bi-exclamation-triangle"
                   Size="BaseModalComponent.ModalSize.Desktop"
                   HeaderColor="BaseModalComponent.HeaderVariant.Warning"
                   IsLoading="@isLoading"
                   LoadingMessage="@L["Warehouse.LoadingAlerts"]"
                   BodyCssClass="p-4"
                   OnClose="@HandleCancel">
    
    <HeaderButtons>
        @* Modal Actions - 按鈕區塊移到 Header *@
        <div class="d-flex gap-2 align-items-center flex-wrap">
            @if (!isLoading && stockDetails.Any())
            {
                <div class="text-muted small me-2" style="font-size: 0.875rem;">
                    <i class="bi bi-info-circle me-1"></i>
                    @string.Format(L["Report.TotalCount"].ToString(), stockDetails.Count)
                </div>

                @* 批次填入輸入區 *@
                <div class="input-group input-group-sm" style="width: 130px;">
                    <span class="input-group-text">@L["Warehouse.BatchMin"]</span>
                    <input type="number" 
                           class="form-control" 
                           @bind="batchMinLevel" 
                           min="0" 
                           placeholder="0" />
                </div>
                <div class="input-group input-group-sm" style="width: 130px;">
                    <span class="input-group-text">@L["Warehouse.BatchMax"]</span>
                    <input type="number" 
                           class="form-control" 
                           @bind="batchMaxLevel" 
                           min="0" 
                           placeholder="0" />
                </div>
                <GenericButtonComponent Variant="ButtonVariant.DarkBlue"
                                      Size="ButtonSize.Small"
                                      Text="@L["Report.BatchFill"]"
                                      OnClick="ApplyBatchFill"
                                      Title="@L["Report.BatchFillTitle"]" />
                <GenericButtonComponent Variant="ButtonVariant.Gray"
                                      Size="ButtonSize.Small"
                                      Text="@L["Button.Clear"]"
                                      OnClick="HandleClearAll"
                                      Title="@L["Button.Clear"]" />
                <GenericButtonComponent Variant="ButtonVariant.Green"
                                      Size="ButtonSize.Small"
                                      Text="@L["Button.Save"]"
                                      OnClick="HandleSave"
                                      IsDisabled="@(!stockDetails.Any())"
                                      Title="@L["Button.Save"]" />
            }
        </div>
    </HeaderButtons>
    
    <BodyContent>
        @if (!stockDetails.Any() && !isLoading)
        {
            <div class="alert alert-success mb-0">
                <i class="bi bi-check-circle me-2"></i>
                @L["Warehouse.AllAlertsSet"]
            </div>
        }
        else
        {
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                        <InteractiveTableComponent TItem="StockLevelAlertItem"
                                                 Items="@stockDetails"
                                                 ColumnDefinitions="@GetColumnDefinitions()"
                                                 ShowHeader="true"
                                                 ShowActions="false"
                                                 ShowRowNumbers="true"
                                                 IsStriped="true"
                                                 IsHoverable="true"
                                                 IsBordered="true"
                                                 CssClass="mb-0" />
                </div>
            </div>
        }
    </BodyContent>
    
</BaseModalComponent>

@code {
    // ===== 參數定義 =====

    /// <summary>
    /// Modal 是否顯示
    /// </summary>
    [Parameter]
    public bool IsVisible { get; set; }

    /// <summary>
    /// Modal 顯示狀態變更事件
    /// </summary>
    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    /// <summary>
    /// Modal 標題
    /// </summary>
    [Parameter]
    public string Title { get; set; } = "設定庫存警戒線";

    /// <summary>
    /// 儲存成功後的回調
    /// </summary>
    [Parameter]
    public EventCallback OnSaved { get; set; }

    // ===== 私有欄位 =====
    private bool isLoading = false;
    private List<StockLevelAlertItem> stockDetails = new();
    
    // 批次填入相關
    private int? batchMinLevel = null;
    private int? batchMaxLevel = null;

    // ===== 生命週期方法 =====

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isLoading && !stockDetails.Any())
        {
            await LoadStockDetailsAsync();
        }
    }

    // ===== 資料載入方法 =====

    /// <summary>
    /// 載入未設警戒線的庫存明細
    /// </summary>
    private async Task LoadStockDetailsAsync()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            var details = await InventoryStockService.GetStockDetailsWithoutAlertAsync();
            
            stockDetails = details.Select(d => new StockLevelAlertItem
            {
                DetailId = d.Id,
                Code = d.InventoryStock?.Product?.Code ?? "未知編號",
                ProductName = d.InventoryStock?.Product?.Name ?? "未知商品",
                WarehouseName = d.Warehouse?.Name ?? "未知倉庫",
                WarehouseLocationName = d.WarehouseLocation?.Name ?? "未指定",
                CurrentStock = d.CurrentStock,
                MinStockLevel = d.MinStockLevel,
                MaxStockLevel = d.MaxStockLevel
            }).ToList();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync(string.Format(L["Inventory.LoadFailed"].ToString(), ex.Message));
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // ===== 表格欄位定義 =====

    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = L["Column.StockCode"].ToString(),
                PropertyName = nameof(StockLevelAlertItem.Code),
                ColumnType = InteractiveColumnType.Display,
                Width = "140px"
            },
            new()
            {
                Title = L["Column.ProductName"].ToString(),
                PropertyName = nameof(StockLevelAlertItem.ProductName),
                ColumnType = InteractiveColumnType.Display,
                Width = "140px"
            },
            new()
            {
                Title = L["Column.Warehouse"].ToString(),
                PropertyName = nameof(StockLevelAlertItem.WarehouseName),
                ColumnType = InteractiveColumnType.Display,
                Width = "120px"
            },
            new()
            {
                Title = L["Column.WarehousePosition"].ToString(),
                PropertyName = nameof(StockLevelAlertItem.WarehouseLocationName),
                ColumnType = InteractiveColumnType.Display,
                Width = "120px"
            },
            new()
            {
                Title = L["Column.CurrentStockLevel"].ToString(),
                PropertyName = nameof(StockLevelAlertItem.CurrentStock),
                ColumnType = InteractiveColumnType.Display,
                Width = "80px",
                CellCssClass = "text-end",
                SmartDecimalDisplay = true
            },
            new()
            {
                Title = L["Column.MinStock"].ToString(),
                PropertyName = nameof(StockLevelAlertItem.MinStockLevel),
                ColumnType = InteractiveColumnType.Number,
                Width = "80px",
                MinValue = 0,
                CellCssClass = "text-end"
            },
            new()
            {
                Title = L["Column.MaxStock"].ToString(),
                PropertyName = nameof(StockLevelAlertItem.MaxStockLevel),
                ColumnType = InteractiveColumnType.Number,
                Width = "80px",
                MinValue = 0,
                CellCssClass = "text-end"
            }
        };
    }

    // ===== 事件處理方法 =====

    /// <summary>
    /// 處理儲存按鈕點擊
    /// </summary>
    private async Task HandleSave()
    {
        try
        {
            if (!stockDetails.Any())
            {
                await NotificationService.ShowWarningAsync(L["Warehouse.NoDataSave"].ToString());
                return;
            }

            // 驗證資料
            var errors = new List<string>();
            foreach (var item in stockDetails)
            {
                if (item.MinStockLevel.HasValue && item.MinStockLevel.Value < 0)
                {
                    errors.Add(string.Format(L["Warehouse.MinNegativeItem"].ToString(), item.ProductName));
                }

                if (item.MaxStockLevel.HasValue && item.MaxStockLevel.Value < 0)
                {
                    errors.Add(string.Format(L["Warehouse.MaxNegativeItem"].ToString(), item.ProductName));
                }

                if (item.MinStockLevel.HasValue && item.MaxStockLevel.HasValue &&
                    item.MinStockLevel.Value > item.MaxStockLevel.Value)
                {
                    errors.Add(string.Format(L["Warehouse.MinExceedsMaxItem"].ToString(), item.ProductName));
                }
            }

            if (errors.Any())
            {
                await NotificationService.ShowErrorAsync(string.Format(L["Warehouse.ValidationFailed"].ToString(), string.Join("；", errors)));
                return;
            }

            isLoading = true;
            StateHasChanged();

            // 準備更新資料
            var updates = stockDetails
                .Select(item => (item.DetailId, item.MinStockLevel, item.MaxStockLevel))
                .ToList();

            // 批次更新
            var result = await InventoryStockService.BatchUpdateStockLevelAlertsAsync(updates);

            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync(string.Format(L["Warehouse.UpdateSuccessCount"].ToString(), stockDetails.Count));
                
                // 清空資料並關閉 Modal
                stockDetails.Clear();
                
                if (OnSaved.HasDelegate)
                {
                    await OnSaved.InvokeAsync();
                }
                
                await CloseModal();
            }
            else
            {
                await NotificationService.ShowErrorAsync($"{L["Message.SaveFailed"]}：{result.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync(string.Format(L["Warehouse.SaveError"].ToString(), ex.Message));
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// 處理取消按鈕點擊
    /// </summary>
    private async Task HandleCancel()
    {
        await CloseModal();
    }

    /// <summary>
    /// 處理背景點擊
    /// </summary>
    private async Task HandleBackdropClick()
    {
        await CloseModal();
    }

    /// <summary>
    /// 套用批次填入
    /// </summary>
    private async Task ApplyBatchFill()
    {
        try
        {
            // 驗證輸入
            if (!batchMinLevel.HasValue && !batchMaxLevel.HasValue)
            {
                await NotificationService.ShowWarningAsync(L["Warehouse.NeedMinOrMax"].ToString());
                return;
            }

            if (batchMinLevel.HasValue && batchMinLevel.Value < 0)
            {
                await NotificationService.ShowWarningAsync(L["Warehouse.MinNegative"].ToString());
                return;
            }

            if (batchMaxLevel.HasValue && batchMaxLevel.Value < 0)
            {
                await NotificationService.ShowWarningAsync(L["Warehouse.MaxNegative"].ToString());
                return;
            }

            if (batchMinLevel.HasValue && batchMaxLevel.HasValue &&
                batchMinLevel.Value > batchMaxLevel.Value)
            {
                await NotificationService.ShowWarningAsync(L["Warehouse.MinExceedsMax"].ToString());
                return;
            }

            // 套用到所有項目
            foreach (var item in stockDetails)
            {
                if (batchMinLevel.HasValue)
                {
                    item.MinStockLevel = batchMinLevel.Value;
                }
                
                if (batchMaxLevel.HasValue)
                {
                    item.MaxStockLevel = batchMaxLevel.Value;
                }
            }

            // 清空輸入值
            batchMinLevel = null;
            batchMaxLevel = null;
            
            await NotificationService.ShowSuccessAsync(string.Format(L["Warehouse.BatchFillCount"].ToString(), stockDetails.Count));
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync(string.Format(L["Warehouse.BatchFillError"].ToString(), ex.Message));
        }
    }

    /// <summary>
    /// 處理清空按鈕
    /// </summary>
    private async Task HandleClearAll()
    {
        try
        {
            // 清空所有警戒線設定
            foreach (var item in stockDetails)
            {
                item.MinStockLevel = null;
                item.MaxStockLevel = null;
            }

            await NotificationService.ShowSuccessAsync(L["Warehouse.ClearSuccess"].ToString());
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync(string.Format(L["Warehouse.ClearError"].ToString(), ex.Message));
        }
    }

    /// <summary>
    /// 關閉 Modal
    /// </summary>
    private async Task CloseModal()
    {
        stockDetails.Clear();
        
        if (IsVisibleChanged.HasDelegate)
        {
            await IsVisibleChanged.InvokeAsync(false);
        }
    }

    // ===== 內部類別 =====

    /// <summary>
    /// 警戒線設定項目
    /// </summary>
    public class StockLevelAlertItem
    {
        public int DetailId { get; set; }
        public string Code { get; set; } = string.Empty;
        public string ProductName { get; set; } = string.Empty;
        public string WarehouseName { get; set; } = string.Empty;
        public string WarehouseLocationName { get; set; } = string.Empty;
        public decimal CurrentStock { get; set; }
        public decimal? MinStockLevel { get; set; }
        public decimal? MaxStockLevel { get; set; }
    }
}
