@* 可重用的庫存異動記錄編輯組件 - 可在任何頁面中嵌入 *@
@* 重構後支援主/明細結構顯示 *@
@inject IInventoryTransactionService InventoryTransactionService
@inject IWarehouseService WarehouseService
@inject IEmployeeService EmployeeService
@inject INotificationService NotificationService
@using ERPCore2.Components.Shared.UI.Form
@using ERPCore2.Components.Shared.PageTemplate
@using ERPCore2.Data.Enums
@using ERPCore2.Data.Entities
@using ERPCore2.Helpers

<GenericEditModalComponent TEntity="InventoryTransaction" 
                          TService="IInventoryTransactionService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@InventoryTransactionId"
                          Service="@InventoryTransactionService"
                          EntityName="庫存異動記錄"
                          EntityNamePlural="庫存異動記錄"
                          ModalTitle="檢視庫存異動記錄 (唯讀)"
                          Size="GenericEditModalComponent<InventoryTransaction, IInventoryTransactionService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          DataLoader="@LoadInventoryTransactionData"
                          AdditionalDataLoader="@LoadAdditionalDataAsync"
                          RequiredPermission="InventoryTransaction.Read"
                          OnCancel="@HandleCancel"
                          ShowSaveButton="false"
                          ShowPrintButton="false"
                          CancelButtonText="關閉"
                          OnEntityLoaded="@HandleEntityLoaded"
                          CustomModules="@GetCustomModules()">
</GenericEditModalComponent>

@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? InventoryTransactionId { get; set; }
    [Parameter] public EventCallback<InventoryTransaction> OnInventoryTransactionSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<InventoryTransaction, IInventoryTransactionService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // 選項清單
    private List<Warehouse> warehouses = new();
    private List<Employee> employees = new();
    
    // 當前異動記錄
    private InventoryTransaction? currentTransaction;
    
    // 明細資料（傳遞給 InventoryTransactionTable）
    private List<InventoryTransactionDetail> transactionDetails = new();
    
    /// <summary>
    /// 配置自訂模組（顯示明細表格）
    /// </summary>
    private List<GenericEditModalComponent<InventoryTransaction, IInventoryTransactionService>.CustomModule> GetCustomModules()
    {
        if (editModalComponent == null)
        {
            return new List<GenericEditModalComponent<InventoryTransaction, IInventoryTransactionService>.CustomModule>();
        }

        return new List<GenericEditModalComponent<InventoryTransaction, IInventoryTransactionService>.CustomModule>
        {
            new GenericEditModalComponent<InventoryTransaction, IInventoryTransactionService>.CustomModule
            {
                Order = 1,
                IsVisible = true,
                Content = CreateDetailTableContent()
            }
        };
    }
    
    /// <summary>
    /// 創建明細表格內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateDetailTableContent() => __builder =>
    {
        try
        {
            @if (currentTransaction != null)
            {
                <div class="mt-4">
                    <InventoryTransactionTable Details="@transactionDetails" 
                                              TransactionNumber="@currentTransaction.TransactionNumber" />
                </div>
            }
            else
            {
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">載入中...</span>
                    </div>
                </div>
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                載入明細表格時發生錯誤，請重新整理頁面。
            </div>
        }
    };
    
    /// <summary>
    /// 處理實體載入完成事件(由 GenericEditModalComponent 的導航觸發)
    /// 當上下筆切換時觸發 UI 更新,確保表單欄位正確渲染
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            // 重新載入完整的異動記錄（包含明細）
            currentTransaction = await InventoryTransactionService.GetByIdWithDetailsAsync(loadedEntityId);
            
            // 更新明細清單（供 InventoryTransactionTable 使用）
            transactionDetails = currentTransaction?.Details?.ToList() ?? new List<InventoryTransactionDetail>();
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入資料時發生錯誤：{ex.Message}");
        }
    }

    private async Task HandleCancel()
    {
        try
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }

            await CloseModal();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCancel), GetType(), additionalData: "處理取消事件時發生錯誤");
            await NotificationService.ShowErrorAsync($"處理取消事件時發生錯誤：{ex.Message}");
        }
    }

    private async Task CloseModal()
    {
        if (IsVisibleChanged.HasDelegate)
        {
            await IsVisibleChanged.InvokeAsync(false);
        }
    }

    // ===== 資料載入 =====
    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // 載入倉庫選項
            await LoadWarehousesAsync();
            
            // 載入員工選項
            await LoadEmployeesAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadAdditionalDataAsync), GetType(), additionalData: "載入額外資料失敗");
            await NotificationService.ShowErrorAsync("載入額外資料失敗");
        }
    }

    private async Task LoadWarehousesAsync()
    {
        try
        {
            warehouses = await WarehouseService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadWarehousesAsync), GetType(), additionalData: "載入倉庫資料失敗");
            await NotificationService.ShowErrorAsync("載入倉庫資料失敗");
            warehouses = new List<Warehouse>();
        }
    }

    private async Task LoadEmployeesAsync()
    {
        try
        {
            employees = await EmployeeService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadEmployeesAsync), GetType(), additionalData: "載入員工資料失敗");
            await NotificationService.ShowErrorAsync("載入員工資料失敗");
            employees = new List<Employee>();
        }
    }

    private async Task<InventoryTransaction?> LoadInventoryTransactionData()
    {
        try
        {
            if (!InventoryTransactionId.HasValue)
            {
                // 新增模式 - 返回空白實體（庫存異動通常不支援手動新增）
                currentTransaction = new InventoryTransaction
                {
                    TransactionDate = DateTime.Now,
                    TransactionType = InventoryTransactionTypeEnum.Purchase,
                    TotalQuantity = 0,
                    TotalAmount = 0,
                    Status = EntityStatus.Active,
                    Details = new List<InventoryTransactionDetail>()
                };
                transactionDetails = new List<InventoryTransactionDetail>();
                return currentTransaction;
            }

            // 編輯模式 - 從服務載入現有資料（包含明細）
            currentTransaction = await InventoryTransactionService.GetByIdWithDetailsAsync(InventoryTransactionId.Value);
            
            // 更新明細清單（供 InventoryTransactionTable 使用）
            transactionDetails = currentTransaction?.Details?.ToList() ?? new List<InventoryTransactionDetail>();
            
            return currentTransaction;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadInventoryTransactionData), GetType(), additionalData: $"載入庫存異動記錄資料失敗，ID: {InventoryTransactionId}");
            await NotificationService.ShowErrorAsync("載入庫存異動記錄資料失敗");
            return null;
        }
    }

    protected override void OnParametersSet()
    {
        if (IsVisible)
        {
            InitializeFormFields();
        }
    }

    // ===== 表單設定 =====
    private void InitializeFormFields()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                // ===== 基本資訊區段 =====
                new()
                {
                    PropertyName = nameof(InventoryTransaction.TransactionNumber),
                    Label = "異動單號",
                    FieldType = FormFieldType.Text,
                    IsRequired = true,
                    IsReadOnly = true
                },
                new()
                {
                    PropertyName = nameof(InventoryTransaction.TransactionType),
                    Label = "異動類型",
                    FieldType = FormFieldType.Select,
                    IsRequired = true,
                    Options = GetTransactionTypeOptions(),
                    IsReadOnly = true
                },
                new()
                {
                    PropertyName = nameof(InventoryTransaction.TransactionDate),
                    Label = "異動日期",
                    FieldType = FormFieldType.DateTime,
                    IsRequired = true,
                    IsReadOnly = true
                },
                new()
                {
                    PropertyName = nameof(InventoryTransaction.WarehouseId),
                    Label = "倉庫",
                    FieldType = FormFieldType.Select,
                    IsRequired = true,
                    Options = warehouses.Select(w => new SelectOption 
                    { 
                        Text = w.Name, 
                        Value = w.Id.ToString() 
                    }).ToList(),
                    IsReadOnly = true
                },

                // ===== 來源單據資訊 =====
                new()
                {
                    PropertyName = nameof(InventoryTransaction.SourceDocumentType),
                    Label = "來源單據類型",
                    FieldType = FormFieldType.Text,
                    IsRequired = false,
                    IsReadOnly = true
                },
                new()
                {
                    PropertyName = nameof(InventoryTransaction.SourceDocumentId),
                    Label = "來源單據ID",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true
                },

                // ===== 彙總資訊 =====
                new()
                {
                    PropertyName = nameof(InventoryTransaction.TotalQuantity),
                    Label = "總數量",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true
                },
                new()
                {
                    PropertyName = nameof(InventoryTransaction.TotalAmount),
                    Label = "總金額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true
                },
                
                // ===== 操作人員 =====
                new()
                {
                    PropertyName = nameof(InventoryTransaction.EmployeeId),
                    Label = "操作人員",
                    FieldType = FormFieldType.Select,
                    IsRequired = false,
                    Options = employees.Select(e => new SelectOption 
                    { 
                        Text = e.Name ?? string.Empty, 
                        Value = e.Id.ToString() 
                    }).ToList(),
                    IsReadOnly = true
                },

                FormFieldConfigurationHelper.CreateRemarksField<InventoryTransaction>(readOnly:true)
            };

            formSections = FormSectionHelper<InventoryTransaction>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    it => it.TransactionNumber,
                    it => it.TransactionType,
                    it => it.TransactionDate,
                    it => it.WarehouseId)
                .AddCustomFields("來源單據",
                    nameof(InventoryTransaction.SourceDocumentType),
                    nameof(InventoryTransaction.SourceDocumentId))
                .AddCustomFields("彙總資訊",
                    nameof(InventoryTransaction.TotalQuantity),
                    nameof(InventoryTransaction.TotalAmount),
                    nameof(InventoryTransaction.EmployeeId))
                .AddCustomFields("其他資料",
                    nameof(InventoryTransaction.Remarks))
                .Build();
        }
        catch (Exception ex)
        {
            _ = Task.Run(async () =>
            {
                await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(InitializeFormFields), GetType(), additionalData: "初始化表單欄位失敗");
                await NotificationService.ShowErrorAsync("初始化表單欄位失敗");
            });
            formFields = new List<FormFieldDefinition>();
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }

    private List<SelectOption> GetTransactionTypeOptions()
    {
        try
        {
            return Enum.GetValues<InventoryTransactionTypeEnum>()
                .Select(type => new SelectOption
                {
                    Text = GetEnumDescription(type),
                    Value = ((int)type).ToString()
                })
                .ToList();
        }
        catch (Exception ex)
        {
            _ = Task.Run(async () =>
            {
                await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetTransactionTypeOptions), GetType(), additionalData: "取得異動類型選項失敗");
            });
            return new List<SelectOption>();
        }
    }

    private string GetEnumDescription(InventoryTransactionTypeEnum value)
    {
        try
        {
            var field = value.GetType().GetField(value.ToString());
            var attribute = field?.GetCustomAttributes(typeof(System.ComponentModel.DescriptionAttribute), false)
                           .FirstOrDefault() as System.ComponentModel.DescriptionAttribute;
            return attribute?.Description ?? value.ToString();
        }
        catch
        {
            return value.ToString();
        }
    }

    /// <summary>
    /// 開啟新增庫存異動記錄 Modal（通常不支援手動新增）
    /// </summary>
    public async Task ShowAddModal()
    {
        InventoryTransactionId = null;
        currentTransaction = null;
        if (IsVisibleChanged.HasDelegate)
        {
            await IsVisibleChanged.InvokeAsync(true);
        }
    }

    /// <summary>
    /// 開啟檢視庫存異動記錄 Modal
    /// </summary>
    public async Task ShowEditModal(int inventoryTransactionId)
    {
        InventoryTransactionId = inventoryTransactionId;
        if (IsVisibleChanged.HasDelegate)
        {
            await IsVisibleChanged.InvokeAsync(true);
        }
    }
}
