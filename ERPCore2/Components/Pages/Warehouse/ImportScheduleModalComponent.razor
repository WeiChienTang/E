@*
    åŒ¯å…¥æ’ç¨‹ Modal çµ„ä»¶
    ç”¨æ–¼å°‡ç”Ÿç”¢æ’ç¨‹é …ç›®åŒ¯å…¥åˆ°åº«å­˜
*@
@using ERPCore2.Components.Shared.Base
@using ERPCore2.Components.Shared.PageTemplate
@using ERPCore2.Helpers.InteractiveTableComponentHelper
@using ERPCore2.Models
@using ERPCore2.Data.Entities
@using ERPCore2.Data.Enums
@inject INotificationService NotificationService
@inject IProductionScheduleItemService ProductionScheduleItemService
@inject IProductionScheduleCompletionService ProductionScheduleCompletionService
@inject IWarehouseService WarehouseService
@inject IWarehouseLocationService WarehouseLocationService
@inject IInventoryStockService InventoryStockService

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="åŒ¯å…¥æ’ç¨‹"
                   Icon="bi-box-arrow-in-down"
                   Size="BaseModalComponent.ModalSize.Desktop"
                   HeaderColor="BaseModalComponent.HeaderVariant.ProjectPrimary"
                   UseWhiteCloseButton="true"
                   BodyCssClass="p-4"
                   OnClose="@HandleClose">
    
    <HeaderButtons>
        @* æŒ‰éˆ•çµ„ *@
        <div class="d-flex gap-2">
            <GenericButtonComponent Variant="ButtonVariant.Green" 
                                  Size="ButtonSize.Small"
                                  Text="åŒ¯å…¥" 
                                  OnClick="HandleImportConfirm"
                                  IsDisabled="@(selectedCount == 0)"
                                  Title="ç¢ºèªä¸¦åŸ·è¡ŒåŒ¯å…¥" />
            <GenericButtonComponent Variant="ButtonVariant.DarkBlue"
                                  Size="ButtonSize.Small"
                                  Text="å…¨é¸"
                                  OnClick="SelectAll" />
            <GenericButtonComponent Variant="ButtonVariant.Red"
                                  Size="ButtonSize.Small"
                                  Text="å–æ¶ˆå…¨é¸"
                                  OnClick="DeselectAll" />
        </div>
    </HeaderButtons>
    
    <BodyContent>
        @if (isLoading)
        {
            <div class="d-flex justify-content-center align-items-center py-5">
                <div class="spinner-border text-primary me-2" role="status">
                    <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                </div>
                <span>è¼‰å…¥æ’ç¨‹è³‡æ–™ä¸­...</span>
            </div>
        }
        else if (importItems == null || !importItems.Any())
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                ç›®å‰æ²’æœ‰å¯åŒ¯å…¥çš„æ’ç¨‹é …ç›®ï¼ˆæ‰€æœ‰æ’ç¨‹é …ç›®éƒ½å·²å®Œæˆï¼‰
            </div>
        }
        else
        {
            @* çµ±è¨ˆè³‡è¨Š *@
            <div class="alert alert-secondary mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span>
                        <i class="bi bi-list-check me-2"></i>
                        å…± <strong>@importItems.Count</strong> ç­†å¾…åŒ¯å…¥é …ç›®
                    </span>
                    <span>
                        å·²é¸å– <strong class="text-primary">@selectedCount</strong> ç­†
                    </span>
                </div>
            </div>
            
            @* æ’ç¨‹é …ç›®è¡¨æ ¼ *@
            <div style="max-height: 500px; overflow: auto;">
                <InteractiveTableComponent TItem="ImportScheduleItemDto"
                                           Items="@importItems"
                                           ColumnDefinitions="@GetColumnDefinitions()"
                                           ShowHeader="true"
                                           EnableRowClick="true"
                                           EnableRowSelection="true"
                                           AllowMultipleSelection="true"
                                           SelectedItems="@selectedItems"
                                           OnSelectionChanged="@HandleSelectionChanged"
                                           GetRowCssClass="@GetRowCssClass"
                                           IsHoverable="true"
                                           IsBordered="true"
                                           EmptyMessage="æ²’æœ‰å¯åŒ¯å…¥çš„æ’ç¨‹é …ç›®"
                                           CssClass="mb-0" />
            </div>
            
            @* åŒ¯å…¥æç¤ºè¨Šæ¯ *@
            <div class="alert alert-info mt-3 mb-0 d-flex align-items-center" role="alert">
                <i class="bi bi-info-circle-fill me-2"></i>
                <span>æç¤ºï¼šåŒ¯å…¥å¾Œå°‡å¢åŠ å°æ‡‰å€‰åº«/åº«ä½çš„åº«å­˜æ•¸é‡ï¼Œä¸¦å°‡æ’ç¨‹é …ç›®ç‹€æ…‹æ¨™è¨˜ç‚ºã€Œå·²å®Œæˆã€</span>
            </div>
        }
    </BodyContent>
    
</BaseModalComponent>

@code {
    // ===== åƒæ•¸å®šç¾© =====
    
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public EventCallback OnImportCompleted { get; set; }
    
    // ===== å…§éƒ¨ç‹€æ…‹ =====
    
    private List<ImportScheduleItemDto> importItems = new();
    private HashSet<ImportScheduleItemDto> selectedItems = new();
    private int selectedCount = 0;
    private bool isLoading = false;
    
    // ä¸‹æ‹‰é¸å–®è³‡æ–™
    private List<Warehouse> warehouses = new();
    private List<WarehouseLocation> warehouseLocations = new();
    
    // å„å•†å“çš„åº«å­˜ä½ç½®è³‡æ–™ï¼ˆKey: ProductId, Value: è©²å•†å“çš„åº«å­˜æ˜ç´°åˆ—è¡¨ï¼‰
    private Dictionary<int, List<InventoryStockDetail>> productStockDetails = new();
    
    // è¿½è¹¤ä¸Šæ¬¡çš„ IsVisible ç‹€æ…‹
    private bool _previousIsVisible = false;
    
    // ===== ç”Ÿå‘½é€±æœŸæ–¹æ³• =====
    
    protected override async Task OnParametersSetAsync()
    {
        // æª¢æ¸¬ Modal æ˜¯å¦å¾é—œé–‰è®Šç‚ºé–‹å•Ÿ
        if (IsVisible && !_previousIsVisible)
        {
            // Modal é–‹å•Ÿæ™‚ï¼Œé‡æ–°è¼‰å…¥è³‡æ–™ä¸¦æ¸…ç©ºé¸å–
            await LoadDataAsync();
            ClearSelection();
        }
        
        _previousIsVisible = IsVisible;
    }
    
    // ===== è³‡æ–™è¼‰å…¥æ–¹æ³• =====
    
    private async Task LoadDataAsync()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            // è¼‰å…¥å€‰åº«å’Œåº«ä½è³‡æ–™
            warehouses = await WarehouseService.GetAllAsync();
            warehouseLocations = await WarehouseLocationService.GetAllAsync();
            
            // è¼‰å…¥å¾…ç”Ÿç”¢å’Œç”Ÿç”¢ä¸­çš„æ’ç¨‹é …ç›®
            var pendingItems = await ProductionScheduleItemService.GetPendingItemsAsync();
            var inProgressItems = await ProductionScheduleItemService.GetInProgressItemsAsync();
            
            // åˆä½µä¸¦æ’é™¤å·²çµæ¡ˆçš„é …ç›®
            var allItems = pendingItems.Concat(inProgressItems)
                .Where(x => !x.IsClosed)
                .ToList();
            
            // å–å¾—æ‰€æœ‰éœ€è¦çš„å•†å“ ID
            var productIds = allItems.Select(x => x.ProductId).Distinct().ToList();
            
            // æŸ¥è©¢å„å•†å“çš„åº«å­˜ä½ç½®è³‡æ–™
            productStockDetails.Clear();
            foreach (var productId in productIds)
            {
                var stockDetails = await InventoryStockService.GetAvailableWarehouseLocationsByProductAsync(productId);
                productStockDetails[productId] = stockDetails;
            }
            
            importItems = allItems
                .Select((item, index) => 
                {
                    var dto = new ImportScheduleItemDto
                    {
                        Id = item.Id,
                        RowNumber = index + 1,
                        SalesOrderCode = item.SalesOrderDetail?.SalesOrder?.Code ?? "-",
                        CustomerName = item.SalesOrderDetail?.SalesOrder?.Customer?.CompanyName ?? "-",
                        ProductId = item.ProductId,
                        ProductCode = item.Product?.Code ?? "-",
                        ProductName = item.Product?.Name ?? "-",
                        WarehouseId = item.WarehouseId,
                        WarehouseLocationId = item.WarehouseLocationId,
                        ScheduledQuantity = item.ScheduledQuantity,
                        CompletedQuantity = item.CompletedQuantity,
                        IsSelected = false,
                        IsClosed = item.IsClosed  // è®€å–åŸæœ¬çš„çµæ¡ˆç‹€æ…‹
                    };
                    
                    // è¨­å®šé è¨­æœ¬æ¬¡å®Œæˆæ•¸é‡ç‚ºå¾…å®Œæˆæ•¸é‡
                    dto.ImportQuantity = dto.PendingQuantity;
                    
                    // è¨­å®šé è¨­å€¼ï¼šé¸æ“‡è©²å•†å“åº«å­˜æœ€å¤šçš„ä½ç½®
                    SetDefaultLocationKey(dto);
                    
                    return dto;
                })
                .ToList();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥æ’ç¨‹è³‡æ–™å¤±æ•—ï¼š{ex.Message}");
            importItems = new();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// è¨­å®šé …ç›®çš„é è¨­å€‰åº«ä½ç½® - é¸æ“‡è©²å•†å“åº«å­˜æœ€å¤šçš„ä½ç½®
    /// </summary>
    private void SetDefaultLocationKey(ImportScheduleItemDto dto)
    {
        if (!productStockDetails.TryGetValue(dto.ProductId, out var stockDetails) || !stockDetails.Any())
        {
            // æ²’æœ‰åº«å­˜è³‡æ–™ï¼Œé è¨­ä½¿ç”¨ç¬¬ä¸€å€‹å€‰åº«ï¼ˆç„¡åº«ä½ï¼‰
            if (warehouses.Any())
            {
                var firstWarehouse = warehouses.First();
                dto.WarehouseId = firstWarehouse.Id;
                dto.WarehouseLocationId = null;
                dto.SelectedLocationKey = $"{firstWarehouse.Id}|";
            }
            return;
        }
        
        // æ‰¾å‡ºè©²å•†å“åº«å­˜æœ€å¤šçš„ä½ç½®
        var maxStockDetail = stockDetails.OrderByDescending(d => d.CurrentStock).First();
        dto.WarehouseId = maxStockDetail.WarehouseId;
        dto.WarehouseLocationId = maxStockDetail.WarehouseLocationId;
        dto.SelectedLocationKey = $"{maxStockDetail.WarehouseId}|{maxStockDetail.WarehouseLocationId?.ToString() ?? ""}";
    }
    
    // ===== è¡¨æ ¼æ¬„ä½å®šç¾© =====
    
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = "è¨‚å–®ç·¨è™Ÿ",
                PropertyName = nameof(ImportScheduleItemDto.SalesOrderCode),
                ColumnType = InteractiveColumnType.Display,
                Width = "120px",
                CellCssClass = "text-primary fw-bold"
            },
            new()
            {
                Title = "å®¢æˆ¶",
                PropertyName = nameof(ImportScheduleItemDto.CustomerName),
                ColumnType = InteractiveColumnType.Display,
                Width = "100px"
            },
            new()
            {
                Title = "å•†å“ç·¨è™Ÿ",
                PropertyName = nameof(ImportScheduleItemDto.ProductCode),
                ColumnType = InteractiveColumnType.Display,
                Width = "90px"
            },
            new()
            {
                Title = "å•†å“åç¨±",
                PropertyName = nameof(ImportScheduleItemDto.ProductName),
                ColumnType = InteractiveColumnType.Display,
                Width = "120px"
            },
            new()
            {
                Title = "æ’ç¨‹æ•¸é‡",
                PropertyName = nameof(ImportScheduleItemDto.ScheduledQuantity),
                ColumnType = InteractiveColumnType.Display,
                Width = "80px",
                TextAlign = "right",
                SmartDecimalDisplay = true
            },
            new()
            {
                Title = "å·²å®Œæˆ",
                PropertyName = nameof(ImportScheduleItemDto.CompletedQuantity),
                ColumnType = InteractiveColumnType.Display,
                Width = "70px",
                TextAlign = "right",
                SmartDecimalDisplay = true,
                CellCssClass = "text-success"
            },
            new()
            {
                Title = "æœ¬æ¬¡å®Œæˆ",
                PropertyName = nameof(ImportScheduleItemDto.ImportQuantity),
                ColumnType = InteractiveColumnType.Custom,
                Width = "100px",
                TextAlign = "right",
                CustomTemplate = item => GetImportQuantityInputTemplate((ImportScheduleItemDto)item)
            },
            new()
            {
                Title = "å€‰åº«/åº«ä½",
                PropertyName = nameof(ImportScheduleItemDto.SelectedLocationKey),
                ColumnType = InteractiveColumnType.Custom,
                Width = "200px",
                CustomTemplate = item => GetWarehouseLocationGroupedSelectTemplate((ImportScheduleItemDto)item)
            },
            new()
            {
                Title = "çµæ¡ˆ",
                PropertyName = nameof(ImportScheduleItemDto.IsClosed),
                ColumnType = InteractiveColumnType.Custom,
                Width = "50px",
                TextAlign = "center",
                Tooltip = "å‹¾é¸å¾Œæ­¤é …ç›®å°‡ä¸å†é¡¯ç¤ºæ–¼åŒ¹å…¥æ’ç¨‹æ¸…å–®",
                CustomTemplate = item => GetIsClosedTemplate((ImportScheduleItemDto)item)
            },
        };
    }
    
    /// <summary>
    /// å–å¾—æœ¬æ¬¡å®Œæˆæ•¸é‡è¼¸å…¥æ¡† CustomTemplate
    /// </summary>
    private RenderFragment GetImportQuantityInputTemplate(ImportScheduleItemDto item) => __builder =>
    {
        if (item.IsClosed)
        {
            // çµæ¡ˆæ™‚é¡¯ç¤ºç‚ºå”¯è®€ï¼Œæ•¸é‡å›ºå®šç‚º 0
            <span class="text-muted">0</span>
        }
        else
        {
            var maxQuantity = item.PendingQuantity;
            <input type="number" 
                   class="form-control form-control-sm text-end" 
                   style="width: 100%;"
                   value="@NumberFormatHelper.FormatForInput(item.ImportQuantity)"
                   min="0"
                   max="@maxQuantity"
                   step="0.001"
                   @onchange="@(e => HandleImportQuantityChanged(item, e))" />
        }
    };
    
    /// <summary>
    /// è™•ç†æœ¬æ¬¡å®Œæˆæ•¸é‡è®Šæ›´
    /// </summary>
    private void HandleImportQuantityChanged(ImportScheduleItemDto item, ChangeEventArgs e)
    {
        if (decimal.TryParse(e.Value?.ToString(), out var newQuantity))
        {
            // é™åˆ¶åœ¨ 0 ~ PendingQuantity ä¹‹é–“
            item.ImportQuantity = Math.Max(0, Math.Min(newQuantity, item.PendingQuantity));
        }
        StateHasChanged();
    }
    
    /// <summary>
    /// å–å¾—çµæ¡ˆæ¬„ä½çš„ CustomTemplate
    /// </summary>
    private RenderFragment GetIsClosedTemplate(ImportScheduleItemDto item) => __builder =>
    {
        // çµæ¡ˆæ™‚é¡¯ç¤ºè­¦å‘Šè‰²èƒŒæ™¯æç¤º
        var wrapperClass = item.IsClosed ? "bg-warning-subtle rounded px-1" : "";
        <div class="@wrapperClass d-flex align-items-center justify-content-center">
            <input type="checkbox" 
                   class="form-check-input m-0"
                   checked="@item.IsClosed"
                   @onchange="e => HandleIsClosedChanged(item, e)"
                   title="@(item.IsClosed ? "å·²çµæ¡ˆï¼šä¸å…¥åº«ï¼Œæ­¤é …ç›®å°‡ä¸å†é¡¯ç¤º" : "é»æ“Šçµæ¡ˆ")" />
        </div>
    };
    
    /// <summary>
    /// è™•ç†çµæ¡ˆç‹€æ…‹è®Šæ›´
    /// </summary>
    private void HandleIsClosedChanged(ImportScheduleItemDto item, ChangeEventArgs e)
    {
        var newValue = (bool)(e.Value ?? false);
        item.IsClosed = newValue;
        
        // å‹¾é¸çµæ¡ˆæ™‚ï¼Œå°‡æœ¬æ¬¡å®Œæˆè¨­ç‚º 0
        if (newValue)
        {
            item.ImportQuantity = 0;
        }
        else
        {
            // å–æ¶ˆçµæ¡ˆæ™‚ï¼Œæ¢å¾©ç‚ºé è¨­çš„å¾…å®Œæˆæ•¸é‡
            item.ImportQuantity = item.PendingQuantity;
        }
        
        StateHasChanged();
    }
    
    /// <summary>
    /// å–å¾—åˆä½µçš„å€‰åº«/åº«ä½åˆ†çµ„ä¸‹æ‹‰é¸å–® CustomTemplate
    /// </summary>
    private RenderFragment GetWarehouseLocationGroupedSelectTemplate(ImportScheduleItemDto item) => __builder =>
    {
        <select class="form-select form-select-sm" 
                value="@item.SelectedLocationKey"
                @onchange="@(e => HandleLocationKeyChanged(item, e))">
            @{
                var (stockOptions, otherOptions) = GetGroupedLocationOptions(item);
                
                // æ­¤å•†å“ç¾æœ‰åº«å­˜ä½ç½®ï¼ˆæœ‰æ•¸é‡çš„ï¼‰
                if (stockOptions.Any())
                {
                    <optgroup label="ğŸ“¦ å•†å“ç¾æœ‰åº«å­˜ä½ç½®">
                        @foreach (var option in stockOptions)
                        {
                            <option value="@option.Key">@option.Text</option>
                        }
                    </optgroup>
                }
                
                // å…¶ä»–å¯ç”¨ä½ç½®ï¼ˆç„¡åº«å­˜æˆ–ä¸åŒä½ç½®ï¼‰
                if (otherOptions.Any())
                {
                    <optgroup label=" - ç„¡å­˜æ”¾åº«å­˜ä½ç½® -">
                        @foreach (var option in otherOptions)
                        {
                            <option value="@option.Key">@option.Text</option>
                        }
                    </optgroup>
                }
            }
        </select>
    };
    
    /// <summary>
    /// ä½ç½®é¸é …è³‡æ–™çµæ§‹
    /// </summary>
    private record LocationOption(string Key, string Text, decimal? Stock);
    
    /// <summary>
    /// å–å¾—åˆ†çµ„çš„å€‰åº«/åº«ä½é¸é …
    /// å›å‚³: (ç¾æœ‰åº«å­˜ä½ç½®é¸é …, å…¶ä»–å¯ç”¨ä½ç½®é¸é …)
    /// </summary>
    private (List<LocationOption> stockOptions, List<LocationOption> otherOptions) GetGroupedLocationOptions(ImportScheduleItemDto item)
    {
        var stockOptions = new List<LocationOption>();
        var otherOptions = new List<LocationOption>();
        
        // å–å¾—è©²å•†å“çš„åº«å­˜æ˜ç´°
        var hasStockDetails = productStockDetails.TryGetValue(item.ProductId, out var stockDetails);
        var stockLookup = stockDetails?.ToDictionary(
            d => $"{d.WarehouseId}|{d.WarehouseLocationId?.ToString() ?? ""}",
            d => d.CurrentStock
        ) ?? new Dictionary<string, decimal>();
        
        foreach (var warehouse in warehouses)
        {
            // å–å¾—è©²å€‰åº«ä¸‹çš„æ‰€æœ‰åº«ä½
            var locations = warehouseLocations.Where(l => l.WarehouseId == warehouse.Id).ToList();
            
            // ç„¡è«–æœ‰ç„¡åº«ä½å®šç¾©ï¼Œéƒ½å…ˆåŠ å…¥ã€Œå€‰åº«ï¼ˆç„¡åº«ä½ï¼‰ã€é¸é …
            var warehouseOnlyKey = $"{warehouse.Id}|";
            var warehouseOnlyStock = stockLookup.TryGetValue(warehouseOnlyKey, out var ws) ? ws : 0;
            
            if (locations.Any())
            {
                // æœ‰åº«ä½çš„å€‰åº«ï¼šå…ˆåŠ å…¥ç„¡åº«ä½é¸é …ï¼Œå†åŠ å…¥å„åº«ä½é¸é …
                
                // åŠ å…¥ã€Œå€‰åº«ï¼ˆç„¡æŒ‡å®šåº«ä½ï¼‰ã€é¸é …
                var warehouseOnlyText = warehouseOnlyStock > 0 
                    ? $"{warehouse.Name} - (ç„¡æŒ‡å®šåº«ä½) ({warehouseOnlyStock:N0})"
                    : $"{warehouse.Name} - (ç„¡æŒ‡å®šåº«ä½)";
                var warehouseOnlyOption = new LocationOption(warehouseOnlyKey, warehouseOnlyText, warehouseOnlyStock);
                
                if (warehouseOnlyStock > 0)
                    stockOptions.Add(warehouseOnlyOption);
                else
                    otherOptions.Add(warehouseOnlyOption);
                
                // ç‚ºæ¯å€‹åº«ä½ç”Ÿæˆé¸é …
                foreach (var location in locations)
                {
                    var key = $"{warehouse.Id}|{location.Id}";
                    var stock = stockLookup.TryGetValue(key, out var s) ? s : 0;
                    var displayText = stock > 0 
                        ? $"{warehouse.Name} - {location.Name} ({stock:N0})"
                        : $"{warehouse.Name} - {location.Name}";
                    
                    var option = new LocationOption(key, displayText, stock);
                    
                    if (stock > 0)
                        stockOptions.Add(option);
                    else
                        otherOptions.Add(option);
                }
            }
            else
            {
                // æ²’æœ‰åº«ä½çš„å€‰åº«ï¼šåªä½¿ç”¨å€‰åº«æœ¬èº«
                var displayText = warehouseOnlyStock > 0 
                    ? $"{warehouse.Name} ({warehouseOnlyStock:N0})"
                    : $"{warehouse.Name}";
                
                var option = new LocationOption(warehouseOnlyKey, displayText, warehouseOnlyStock);
                
                if (warehouseOnlyStock > 0)
                    stockOptions.Add(option);
                else
                    otherOptions.Add(option);
            }
        }
        
        // æ’åºï¼šåº«å­˜å¤šçš„æ’å‰é¢
        stockOptions = stockOptions.OrderByDescending(o => o.Stock ?? 0).ToList();
        otherOptions = otherOptions.OrderBy(o => o.Text).ToList();
        
        return (stockOptions, otherOptions);
    }
    
    /// <summary>
    /// è™•ç†å€‰åº«/åº«ä½é¸æ“‡è®Šæ›´äº‹ä»¶
    /// </summary>
    private void HandleLocationKeyChanged(ImportScheduleItemDto item, ChangeEventArgs e)
    {
        item.SelectedLocationKey = e.Value?.ToString();
        item.ParseLocationKey();
        StateHasChanged();
    }
    
    // ===== äº‹ä»¶è™•ç†æ–¹æ³• =====
    
    /// <summary>
    /// è™•ç†é¸å–ç‹€æ…‹è®Šæ›´äº‹ä»¶
    /// </summary>
    private void HandleSelectionChanged(HashSet<ImportScheduleItemDto> items)
    {
        selectedItems = items;
        UpdateStatistics();
        StateHasChanged();
    }
    
    /// <summary>
    /// å–å¾—è¡Œçš„ CSS é¡åˆ¥ - ç‚ºé¸å–çš„è¡Œæ·»åŠ é«˜äº®æ¨£å¼
    /// </summary>
    private string GetRowCssClass(ImportScheduleItemDto item, int index)
    {
        return selectedItems.Contains(item) ? "table-row-selected" : "";
    }
    
    private void SelectAll()
    {
        selectedItems = importItems.ToHashSet();
        UpdateStatistics();
        StateHasChanged();
    }
    
    private void DeselectAll()
    {
        selectedItems.Clear();
        UpdateStatistics();
        StateHasChanged();
    }
    
    private void ClearSelection()
    {
        selectedItems.Clear();
        selectedCount = 0;
    }
    
    private void UpdateStatistics()
    {
        selectedCount = selectedItems.Count;
    }
    
    private async Task HandleImportConfirm()
    {
        try
        {
            if (selectedCount == 0)
            {
                await NotificationService.ShowWarningAsync("è«‹è‡³å°‘é¸æ“‡ä¸€é …æ’ç¨‹é …ç›®");
                return;
            }
            
            // é©—è­‰æ‰€æœ‰é¸å–é …ç›®æ˜¯å¦éƒ½æœ‰é¸æ“‡å€‰åº«ï¼ˆåº«ä½å¯ç‚ºç©ºï¼‰
            // åªæœ‰éœ€è¦å…¥åº«çš„é …ç›®æ‰éœ€è¦é©—è­‰å€‰åº«
            var itemsNeedWarehouse = selectedItems.Where(x => x.ImportQuantity > 0 && !x.WarehouseId.HasValue).ToList();
            if (itemsNeedWarehouse.Any())
            {
                var invalidCodes = string.Join(", ", itemsNeedWarehouse.Take(3).Select(x => x.ProductCode));
                var moreCount = itemsNeedWarehouse.Count > 3 ? $"...ç­‰ {itemsNeedWarehouse.Count} ç­†" : "";
                await NotificationService.ShowWarningAsync($"ä»¥ä¸‹é …ç›®å°šæœªé¸æ“‡å€‰åº«/åº«ä½ï¼š{invalidCodes}{moreCount}");
                return;
            }
            
            // é©—è­‰æœ¬æ¬¡å®Œæˆæ•¸é‡ï¼šå¿…é ˆå¤§æ–¼ 0ï¼Œæˆ–æ˜¯å‹¾é¸çµæ¡ˆï¼ˆåªçµæ¡ˆä¸å…¥åº«ï¼‰
            var invalidQuantityItems = selectedItems.Where(x => x.ImportQuantity <= 0 && !x.IsClosed).ToList();
            if (invalidQuantityItems.Any())
            {
                var invalidCodes = string.Join(", ", invalidQuantityItems.Take(3).Select(x => x.ProductCode));
                var moreCount = invalidQuantityItems.Count > 3 ? $"...ç­‰ {invalidQuantityItems.Count} ç­†" : "";
                await NotificationService.ShowWarningAsync($"ä»¥ä¸‹é …ç›®æœ¬æ¬¡å®Œæˆæ•¸é‡å¿…é ˆå¤§æ–¼0ï¼Œæˆ–å‹¾é¸çµæ¡ˆï¼š{invalidCodes}{moreCount}");
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰çµæ¡ˆé …ç›®ï¼Œéœ€è¦ç¢ºèª
            var closedItems = selectedItems.Where(x => x.IsClosed).ToList();
            if (closedItems.Any())
            {
                var closedCodes = string.Join("ã€", closedItems.Take(5).Select(x => x.ProductCode));
                var moreText = closedItems.Count > 5 ? $"...ç­‰ {closedItems.Count} ç­†" : "";
                var confirmMessage = $"ä»¥ä¸‹ {closedItems.Count} ç­†é …ç›®å·²å‹¾é¸ã€Œçµæ¡ˆã€ï¼š\n{closedCodes}{moreText}\n\nçµæ¡ˆå¾Œå°‡ä¸æœƒå…¥åº«ï¼Œä¸”æ­¤é …ç›®å°‡ä¸å†é¡¯ç¤ºæ–¼åŒ¯å…¥æ’ç¨‹æ¸…å–®ã€‚\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ";
                
                var confirmed = await NotificationService.ShowConfirmAsync(confirmMessage, "ç¢ºèªçµæ¡ˆ");
                if (!confirmed)
                {
                    return;
                }
            }
            
            isLoading = true;
            StateHasChanged();
            
            var successCount = 0;
            var closedOnlyCount = 0;  // åªçµæ¡ˆä¸å…¥åº«çš„æ•¸é‡
            var failedItems = new List<string>();
            
            foreach (var item in selectedItems)
            {
                try
                {
                    // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œåªçµæ¡ˆä¸å…¥åº«ã€
                    var isCloseOnly = item.IsClosed && item.ImportQuantity <= 0;
                    
                    if (!isCloseOnly)
                    {
                        // æœ‰å…¥åº«æ•¸é‡æ™‚ï¼šå»ºç«‹å®Œå·¥è¨˜éŒ„å’Œå¢åŠ åº«å­˜
                        
                        // 1. å»ºç«‹å®Œå·¥ç™»éŒ„è¨˜éŒ„
                        var completion = new ProductionScheduleCompletion
                        {
                            ProductionScheduleItemId = item.Id,
                            CompletedQuantity = item.ImportQuantity,
                            CompletionDate = DateTime.Now,
                            WarehouseId = item.WarehouseId,
                            WarehouseLocationId = item.WarehouseLocationId,
                            Status = EntityStatus.Active,
                            CreatedAt = DateTime.Now
                        };
                        
                        var completionResult = await ProductionScheduleCompletionService.CreateAsync(completion);
                        if (!completionResult.IsSuccess)
                        {
                            failedItems.Add($"{item.ProductCode}: å»ºç«‹å®Œå·¥è¨˜éŒ„å¤±æ•—");
                            continue;
                        }
                        
                        // 2. å¢åŠ åº«å­˜
                        var transactionNumber = $"PC{DateTime.Now:yyyyMMddHHmmss}{item.Id}";
                        var stockResult = await InventoryStockService.AddStockAsync(
                            item.ProductId,
                            item.WarehouseId!.Value,
                            item.ImportQuantity,
                            InventoryTransactionTypeEnum.ProductionCompletion,
                            transactionNumber,
                            unitCost: null,
                            locationId: item.WarehouseLocationId,
                            remarks: $"ç”Ÿç”¢å®Œå·¥å…¥åº« - æ’ç¨‹é …ç›® #{item.Id}"
                        );
                        
                        if (!stockResult.IsSuccess)
                        {
                            failedItems.Add($"{item.ProductCode}: åº«å­˜å…¥åº«å¤±æ•— - {stockResult.ErrorMessage}");
                            continue;
                        }
                    }
                    
                    // 3. æ›´æ–°æ’ç¨‹é …ç›®çš„å·²å®Œæˆæ•¸é‡å’Œçµæ¡ˆç‹€æ…‹
                    var scheduleItem = await ProductionScheduleItemService.GetByIdAsync(item.Id);
                    if (scheduleItem != null)
                    {
                        // åªæœ‰æœ‰å…¥åº«æ•¸é‡æ™‚æ‰ç´¯åŠ å·²å®Œæˆæ•¸é‡
                        if (!isCloseOnly)
                        {
                            scheduleItem.CompletedQuantity += item.ImportQuantity;
                        }
                        
                        // æ›´æ–°çµæ¡ˆç‹€æ…‹ï¼ˆä½¿ç”¨è€…åœ¨å…¥åº«æ™‚å¯æ±ºå®šæ˜¯å¦çµæ¡ˆï¼‰
                        scheduleItem.IsClosed = item.IsClosed;
                        
                        // æª¢æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
                        if (scheduleItem.CompletedQuantity >= scheduleItem.ScheduledQuantity)
                        {
                            scheduleItem.ProductionItemStatus = ProductionItemStatus.Completed;
                            scheduleItem.ActualEndDate = DateTime.Now;
                        }
                        
                        await ProductionScheduleItemService.UpdateAsync(scheduleItem);
                    }
                    
                    if (isCloseOnly)
                    {
                        closedOnlyCount++;
                    }
                    else
                    {
                        successCount++;
                    }
                }
                catch (Exception ex)
                {
                    failedItems.Add($"{item.ProductCode}: {ex.Message}");
                }
            }
            
            // é¡¯ç¤ºçµæœ
            if (failedItems.Any())
            {
                var failedMessage = string.Join("\n", failedItems.Take(5));
                if (failedItems.Count > 5)
                {
                    failedMessage += $"\n...é‚„æœ‰ {failedItems.Count - 5} ç­†å¤±æ•—";
                }
                await NotificationService.ShowWarningAsync($"æˆåŠŸåŒ¯å…¥ {successCount} ç­†ï¼Œå¤±æ•— {failedItems.Count} ç­†\n{failedMessage}");
            }
            else
            {
                var message = successCount > 0 
                    ? $"å·²æˆåŠŸåŒ¯å…¥ {successCount} ç­†æ’ç¨‹é …ç›®åˆ°åº«å­˜"
                    : "";
                if (closedOnlyCount > 0)
                {
                    message += (message.Length > 0 ? "ï¼Œ" : "") + $"å¦æœ‰ {closedOnlyCount} ç­†åƒ…çµæ¡ˆï¼ˆä¸å…¥åº«ï¼‰";
                }
                await NotificationService.ShowSuccessAsync(message);
            }
            
            // é—œé–‰ Modal ä¸¦é€šçŸ¥çˆ¶å…ƒä»¶
            await IsVisibleChanged.InvokeAsync(false);
            if (OnImportCompleted.HasDelegate)
            {
                await OnImportCompleted.InvokeAsync();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"åŒ¯å…¥å¤±æ•—ï¼š{ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task HandleClose()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }
}
