@* å¯é‡ç”¨çš„å» å•†ç·¨è¼¯çµ„ä»¶ - å¯åœ¨ä»»ä½•é é¢ä¸­åµŒå…¥ *@
@inject ISupplierService SupplierService
@inject IProductSupplierService ProductSupplierService
@inject IProductService ProductService
@inject INotificationService NotificationService
@inject ActionButtonHelper ActionButtonHelper

<GenericEditModalComponent TEntity="Supplier" 
                          TService="ISupplierService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@SupplierId"
                          Service="@SupplierService"
                          EntityName="å» å•†"
                          EntityNamePlural="å» å•†"
                          ModalTitle="@(SupplierId.HasValue ? "ç·¨è¼¯å» å•†" : "æ–°å¢å» å•†")"
                          Size="GenericEditModalComponent<Supplier, ISupplierService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@(autoCompleteConfig?.Prefillers)"
                          AutoCompleteCollections="@(autoCompleteConfig?.Collections)"
                          AutoCompleteDisplayProperties="@(autoCompleteConfig?.DisplayProperties)"
                          AutoCompleteValueProperties="@(autoCompleteConfig?.ValueProperties)"
                          DataLoader="@LoadSupplierData"
                          SaveHandler="@SaveSupplier"
                          OnSaveSuccess="@OnSaveSuccess"
                          RequiredPermission="Supplier.Read"
                          OnCancel="@OnCancel"
                          OnEntityLoaded="@HandleEntityLoaded"
                          CustomModules="@GetCustomModules()" />

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SupplierId { get; set; }
    [Parameter] public EventCallback<Supplier> OnSupplierSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public Dictionary<string, object?>? PrefilledValues { get; set; }

    private GenericEditModalComponent<Supplier, ISupplierService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // AutoComplete é…ç½®
    private AutoCompleteConfig? autoCompleteConfig;
    
    // ===== ä¾›æ‡‰å•†å“ç®¡ç†ç›¸é—œ =====
    private List<ProductSupplier> productSuppliers = new();
    private List<ProductSupplier> deletedProductSuppliers = new();
    private List<Product> availableProducts = new();
    private bool isProductSupplierDataReady = false;

    /// <summary>
    /// è™•ç†å¯¦é«”è¼‰å…¥å®Œæˆäº‹ä»¶ï¼ˆç”± GenericEditModalComponent çš„å°èˆªè§¸ç™¼ï¼‰
    /// ç•¶ä¸Šä¸‹ç­†åˆ‡æ›æ™‚è§¸ç™¼ UI æ›´æ–°ï¼Œç¢ºä¿è¡¨å–®æ¬„ä½æ­£ç¢ºæ¸²æŸ“
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            // é‡æ–°è¼‰å…¥ä¾›æ‡‰å•†å“è³‡æ–™
            isProductSupplierDataReady = false;
            await LoadProductSupplierDataAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }
    
    // è³‡æ–™è¼‰å…¥ç‹€æ…‹æ¨™è¨˜
    private bool isDataLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // ç§»é™¤è‡ªå‹•è¼‰å…¥è³‡æ–™ï¼Œæ”¹ç‚ºåœ¨ OnParametersSetAsync ä¸­æ ¹æ“š IsVisible è¼‰å…¥
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–å» å•†ç·¨è¼¯çµ„ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
            await LoadProductSupplierDataAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
            isProductSupplierDataReady = false;
            productSuppliers.Clear();
            deletedProductSuppliers.Clear();
        }
    }

    private Task LoadAdditionalDataAsync()
    {
        try
        {
            // é…ç½® AutoComplete (ç›®å‰å» å•†æ²’æœ‰ AutoComplete æ¬„ä½,ä¿ç•™ç©ºé…ç½®ä»¥ä¾¿æœªä¾†æ“´å……)
            autoCompleteConfig = new AutoCompleteConfigBuilder<Supplier>()
                .Build();
            
            return Task.CompletedTask;
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("è¼‰å…¥å» å•†ç·¨è¼¯ç›¸é—œè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
            return Task.CompletedTask;
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(Supplier.Code),
                    Label = "å» å•†ä»£ç¢¼",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥å» å•†ä»£ç¢¼",
                    IsRequired = true,
                    MaxLength = 20,
                    HelpText = "å» å•†çš„å”¯ä¸€è­˜åˆ¥ä»£ç¢¼"
                },
                new()
                {
                    PropertyName = nameof(Supplier.CompanyName),
                    Label = "å…¬å¸åç¨±",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥å…¬å¸åç¨±",
                    IsRequired = false,
                    MaxLength = 100,
                    HelpText = "å» å•†çš„æ­£å¼å…¬å¸åç¨±ï¼ˆå…¬å¸åç¨±ã€è² è²¬äººæˆ–è¯çµ¡äººè‡³å°‘éœ€å¡«å¯«ä¸€é …ï¼‰"
                },
                new()
                {
                    PropertyName = nameof(Supplier.ContactPerson),
                    Label = "è¯çµ¡äºº",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥è¯çµ¡äººå§“å",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "ä¸»è¦è¯çµ¡äººå§“åï¼ˆå…¬å¸åç¨±ã€è² è²¬äººæˆ–è¯çµ¡äººè‡³å°‘éœ€å¡«å¯«ä¸€é …ï¼‰"
                },
                new()
                {
                    PropertyName = nameof(Supplier.TaxNumber),
                    Label = "çµ±ä¸€ç·¨è™Ÿ",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥çµ±ä¸€ç·¨è™Ÿ",
                    MaxLength = 8,
                    HelpText = "å…¬å¸çµ±ä¸€ç·¨è™Ÿï¼ˆ8ä½æ•¸å­—ï¼‰"
                },
                new()
                {
                    PropertyName = nameof(Supplier.ResponsiblePerson),
                    Label = "è² è²¬äºº",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥è² è²¬äººå§“å",
                    IsRequired = false,
                    MaxLength = 10,
                    HelpText = "å…¬å¸è² è²¬äººå§“åï¼ˆå…¬å¸åç¨±ã€è² è²¬äººæˆ–è¯çµ¡äººè‡³å°‘éœ€å¡«å¯«ä¸€é …ï¼‰"
                },
                new()
                {
                    PropertyName = nameof(Supplier.JobTitle),
                    Label = "è·ç¨±",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥è·ç¨±",
                    IsRequired = false,
                    MaxLength = 10,
                    HelpText = "è¯çµ¡äººè·ç¨±"
                },
                new()
                {
                    PropertyName = nameof(Supplier.ContactPhone),
                    Label = "è¯çµ¡é›»è©±",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥è¯çµ¡é›»è©±",
                    IsRequired = false,
                    MaxLength = 20,
                    HelpText = "è¯çµ¡äººæˆ–æ˜¯å…¬å¸è¯çµ¡é›»è©±"
                },
                new()
                {
                    PropertyName = nameof(Supplier.MobilePhone),
                    Label = "è¡Œå‹•é›»è©±",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥è¡Œå‹•é›»è©±",
                    IsRequired = false,
                    MaxLength = 20,
                    HelpText = "è¯çµ¡äººè¡Œå‹•é›»è©±"
                },
                new()
                {
                    PropertyName = nameof(Supplier.Fax),
                    Label = "å‚³çœŸ",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥å‚³çœŸè™Ÿç¢¼",
                    IsRequired = false,
                    MaxLength = 20,
                    HelpText = "å…¬å¸å‚³çœŸè™Ÿç¢¼"
                },
                new()
                {
                    PropertyName = nameof(Supplier.Email),
                    Label = "ä¿¡ç®±",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥é›»å­éƒµä»¶",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "è¯çµ¡äººé›»å­éƒµä»¶åœ°å€"
                },
                new()
                {
                    PropertyName = nameof(Supplier.Website),
                    Label = "å…¬å¸ç¶²å€",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥å…¬å¸ç¶²å€",
                    MaxLength = 50,
                    ContainerCssClass = "col-4",
                    HelpText = "å…¬å¸å®˜æ–¹ç¶²ç«™ç¶²å€"
                },
                new()
                {
                    PropertyName = nameof(Supplier.ContactAddress),
                    Label = "è¯çµ¡åœ°å€",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥è¯çµ¡åœ°å€",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "å…¬å¸è¯çµ¡åœ°å€",
                    ContainerCssClass = "col-4"
                },
                new()
                {
                    PropertyName = nameof(Supplier.SupplierAddress),
                    Label = "å…¬å¸åœ°å€",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥å…¬å¸åœ°å€",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "å…¬å¸åœ°å€",
                    ContainerCssClass = "col-4"
                },
                new()
                {
                    PropertyName = nameof(Supplier.PaymentMethod),
                    Label = "ä»˜æ¬¾æ–¹å¼",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥ä»˜æ¬¾æ–¹å¼",
                    IsRequired = false,
                    MaxLength = 10,
                    HelpText = "å®¢æˆ¶çš„ä»˜æ¬¾æ–¹å¼ï¼ˆä¾‹å¦‚ï¼šç¾é‡‘ã€æ”¯ç¥¨ã€åŒ¯æ¬¾ç­‰ï¼‰"
                },
                new()
                {
                    PropertyName = nameof(Supplier.PaymentTerms),
                    Label = "ä»˜æ¬¾æ¢ä»¶",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥ä»˜æ¬¾æ¢ä»¶",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "ä»˜æ¬¾æ¢ä»¶èªªæ˜ï¼ˆä¾‹å¦‚ï¼šæœˆçµ30å¤©ã€è²¨åˆ°ä»˜æ¬¾ç­‰ï¼‰"
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(Supplier.SupplierContactPhone),
                    Label = "è¯çµ¡é›»è©±",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥è¯çµ¡é›»è©±",
                    IsRequired = false,
                    MaxLength = 20,
                    HelpText = "è² è²¬äººæˆ–æ˜¯å…¬å¸è¯çµ¡é›»è©±"
                },

                FormFieldConfigurationHelper.CreateRemarksField<Supplier>()
            };

            // æ›´æ–°è¡¨å–®å€æ®µå®šç¾©
            formSections = FormSectionHelper<Supplier>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    s => s.Code,
                    s => s.CompanyName,
                    s => s.ResponsiblePerson,
                    s => s.SupplierContactPhone,
                    s => s.TaxNumber,
                    s => s.Fax,
                    s => s.Website,
                    s => s.ContactAddress,
                    s => s.SupplierAddress)
                .AddToSection(FormSectionNames.ContactPersonInfo,
                    s => s.ContactPerson,
                    s => s.JobTitle,
                    s => s.ContactPhone,
                    s => s.MobilePhone,
                    s => s.Email)
                .AddToSection(FormSectionNames.PaymentInfo,
                    s => s.PaymentMethod,
                    s => s.PaymentTerms)
                .AddToSection(FormSectionNames.OtherInfo,
                    s => s.Remarks)
                .Build();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–è¡¨å–®æ¬„ä½æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }
    
    private async Task<Supplier?> LoadSupplierData()
    {
        try
        {
            if (!SupplierId.HasValue) 
            {
                // æ–°å¢æ¨¡å¼
                var newSupplier = new Supplier
                {
                    Code = await EntityCodeGenerationHelper.GenerateForEntity<Supplier, ISupplierService>(SupplierService, "S"),
                    CompanyName = "",
                    ContactPerson = "",
                    TaxNumber = "",
                    Status = EntityStatus.Active
                };
                
                // æ‡‰ç”¨é å¡«å€¼
                PrefilledValueHelper.ApplyPrefilledValues(newSupplier, PrefilledValues);
                
                return newSupplier;
            }

            var supplier = await SupplierService.GetByIdAsync(SupplierId.Value);            
            
            if (supplier == null)
            {
                _ = NotificationService.ShowErrorAsync("æ‰¾ä¸åˆ°æŒ‡å®šçš„å» å•†è³‡æ–™");
                return null;
            }
            
            return supplier;
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("è¼‰å…¥å» å•†è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
            
            // è¨­å®šå®‰å…¨çš„é è¨­å€¼ï¼Œç¢ºä¿ç¨‹å¼ä¸æœƒå´©æ½°
            return new Supplier
            {
                Code = "",
                CompanyName = "",
                ContactPerson = "",
                TaxNumber = "",
                Status = EntityStatus.Active
            };
        }
    }

    private async Task<bool> SaveSupplier(Supplier entity)
    {
        try
        {
            // ä½¿ç”¨æœå‹™çš„å®Œæ•´é©—è­‰é‚è¼¯ï¼ˆåŒ…å«é‡è¤‡æª¢æŸ¥ï¼‰
            var validationResult = await SupplierService.ValidateAsync(entity);
            if (!validationResult.IsSuccess)
            {
                _ = NotificationService.ShowErrorAsync(validationResult.ErrorMessage);
                return false;
            }

            ServiceResult result;
            
            if (SupplierId.HasValue)
            {
                // æ›´æ–°ç¾æœ‰å» å•†
                result = await SupplierService.UpdateAsync(entity);
            }
            else
            {
                // æ–°å¢å» å•†
                result = await SupplierService.CreateAsync(entity);
            }

            if (!result.IsSuccess)
            {
                return false;
            }

            // å„²å­˜æˆåŠŸå¾Œï¼Œè™•ç†ä¾›æ‡‰å•†å“ç¶å®š
            await SaveProductSuppliersAsync(entity.Id);

            return true;
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("å„²å­˜å» å•†è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
            return false;
        }
    }

    /// <summary>
    /// å„²å­˜ä¾›æ‡‰å•†å“ç¶å®šè³‡æ–™
    /// </summary>
    private async Task SaveProductSuppliersAsync(int supplierId)
    {
        try
        {
            // éæ¿¾å‡ºæœ‰æ•ˆçš„ç¶å®šï¼ˆå·²é¸æ“‡å•†å“ï¼‰
            var validProductSuppliers = productSuppliers
                .Where(ps => ps.ProductId > 0)
                .ToList();

            // è¨­å®šä¾›æ‡‰å•†ID
            foreach (var ps in validProductSuppliers)
            {
                ps.SupplierId = supplierId;
            }

            // åˆªé™¤å·²æ¨™è¨˜åˆªé™¤çš„é …ç›®
            foreach (var deletedItem in deletedProductSuppliers)
            {
                if (deletedItem.Id > 0)
                {
                    await ProductSupplierService.DeleteAsync(deletedItem.Id);
                }
            }

            // æ–°å¢æˆ–æ›´æ–°ç¶å®š
            foreach (var ps in validProductSuppliers)
            {
                //  æ¸…é™¤å°èˆªå±¬æ€§ï¼Œé¿å… EF Core è©¦åœ–æ’å…¥é—œè¯å¯¦é«”
                ps.Product = null;
                ps.Supplier = null;
                
                if (ps.Id > 0)
                {
                    // æ›´æ–°ç¾æœ‰ç¶å®š
                    await ProductSupplierService.UpdateAsync(ps);
                }
                else
                {
                    // æ–°å¢ç¶å®š
                    await ProductSupplierService.CreateAsync(ps);
                }
            }

            deletedProductSuppliers.Clear();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å„²å­˜ä¾›æ‡‰å•†å“ç¶å®šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }



    private async Task OnSaveSuccess()
    {
        try
        {
            if (editModalComponent?.Entity != null)
            {
                await OnSupplierSaved.InvokeAsync(editModalComponent.Entity);
            }
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("å„²å­˜æˆåŠŸå›èª¿æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    // ===== ä¾›æ‡‰å•†å“ç®¡ç†æ–¹æ³• =====

    /// <summary>
    /// è¼‰å…¥ä¾›æ‡‰å•†å“è³‡æ–™
    /// </summary>
    private async Task LoadProductSupplierDataAsync()
    {
        try
        {
            isProductSupplierDataReady = false;
            
            // è¼‰å…¥æ‰€æœ‰å¯ç”¨å•†å“
            availableProducts = (await ProductService.GetAllAsync()).ToList();
            
            // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ï¼Œè¼‰å…¥ç¾æœ‰çš„ä¾›æ‡‰å•†å“ç¶å®š
            if (SupplierId.HasValue && SupplierId.Value > 0)
            {
                productSuppliers = (await ProductSupplierService.GetBySupplierIdAsync(SupplierId.Value)).ToList();
                
                // ğŸ”‘ è¨­å®š SearchText ç”¨æ–¼é¡¯ç¤ºå·²é¸æ“‡çš„å•†å“
                foreach (var ps in productSuppliers)
                {
                    if (ps.Product != null)
                    {
                        ps.SearchText = !string.IsNullOrEmpty(ps.Product.Code) && !string.IsNullOrEmpty(ps.Product.Name)
                            ? $"[{ps.Product.Code}] {ps.Product.Name}"
                            : ps.Product.Code ?? ps.Product.Name ?? "";
                    }
                }
            }
            else
            {
                productSuppliers = new List<ProductSupplier>();
            }
            
            deletedProductSuppliers.Clear();
            isProductSupplierDataReady = true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ä¾›æ‡‰å•†å“è³‡æ–™å¤±æ•—ï¼š{ex.Message}");
            isProductSupplierDataReady = true; // è¨­ç‚º true ä»¥å…ä¸€ç›´é¡¯ç¤ºè¼‰å…¥ä¸­
        }
    }

    /// <summary>
    /// é…ç½®è‡ªè¨‚æ¨¡çµ„ - ä¾›æ‡‰å•†å“ç®¡ç†
    /// </summary>
    private List<GenericEditModalComponent<Supplier, ISupplierService>.CustomModule> GetCustomModules()
    {
        if (editModalComponent == null)
        {
            return new List<GenericEditModalComponent<Supplier, ISupplierService>.CustomModule>();
        }

        return new List<GenericEditModalComponent<Supplier, ISupplierService>.CustomModule>
        {
            new GenericEditModalComponent<Supplier, ISupplierService>.CustomModule
            {
                Title = "ä¾›æ‡‰å•†å“ç®¡ç†",
                Order = 1,
                Content = CreateProductSupplierContent()
            }
        };
    }

    /// <summary>
    /// å‰µå»ºä¾›æ‡‰å•†å“ç®¡ç†å…§å®¹çš„ RenderFragment
    /// </summary>
    private RenderFragment CreateProductSupplierContent() => __builder =>
    {
        <div class="card border-0 shadow-sm mt-3">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    @if (SupplierId.HasValue && SupplierId.Value > 0)
                    {
                        <GenericButtonComponent Text="åŒ¯å…¥"
                                              Variant="ButtonVariant.Blue"
                                              Size="ButtonSize.Small"
                                              IconClass="bi bi-upload"
                                              OnClick="@HandleBatchImportFromHistory" />
                    }
                </div>
            </div>
            
            <div class="card-body p-0">
                @if (editModalComponent?.Entity != null)
                {
                    @if (!isProductSupplierDataReady)
                    {
                        <div class="d-flex justify-content-center align-items-center py-4">
                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                            <span class="text-muted">è¼‰å…¥ä¾›æ‡‰å•†å“è³‡æ–™ä¸­...</span>
                        </div>
                    }
                    else if (availableProducts != null && availableProducts.Any())
                    {
                        <SupplierProductTable Items="@productSuppliers"
                                            ItemsChanged="@(async (items) => { productSuppliers = items; await InvokeAsync(StateHasChanged); })"
                                            AvailableProducts="@availableProducts"
                                            SupplierId="@(SupplierId ?? 0)"
                                            DataLoadCompleted="@isProductSupplierDataReady"
                                            EmptyMessage="å°šæœªè¨­å®šä¾›æ‡‰å•†å“"
                                            OnItemDeleted="@HandleDeleteProductSupplier" />
                    }
                    else
                    {
                        <div class="alert alert-warning text-center m-3" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            ç„¡å¯ç”¨çš„å•†å“è³‡æ–™ï¼Œè«‹å…ˆå»ºç«‹å•†å“
                        </div>
                    }
                }
            </div>
        </div>
    };

    /// <summary>
    /// åˆªé™¤ä¾›æ‡‰å•†å“ç¶å®š
    /// </summary>
    private async Task HandleDeleteProductSupplier(ProductSupplier item)
    {
        if (item.Id > 0)
        {
            deletedProductSuppliers.Add(item);
        }
        productSuppliers.Remove(item);
        await InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// å¾æ¡è³¼æ­·å²æ‰¹æ¬¡åŒ¯å…¥
    /// </summary>
    private async Task HandleBatchImportFromHistory()
    {
        try
        {
            if (!SupplierId.HasValue || SupplierId.Value <= 0)
            {
                await NotificationService.ShowWarningAsync("è«‹å…ˆå„²å­˜ä¾›æ‡‰å•†è³‡æ–™");
                return;
            }

            var importedCount = await ProductSupplierService.ImportFromPurchaseHistoryAsync(SupplierId.Value);
            
            if (importedCount > 0)
            {
                await NotificationService.ShowSuccessAsync($"æˆåŠŸåŒ¯å…¥ {importedCount} ç­†å•†å“ç¶å®š");
                await LoadProductSupplierDataAsync();
            }
            else
            {
                await NotificationService.ShowInfoAsync("æ²’æœ‰å¯åŒ¯å…¥çš„æ¡è³¼æ­·å²è¨˜éŒ„");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"åŒ¯å…¥ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

}
