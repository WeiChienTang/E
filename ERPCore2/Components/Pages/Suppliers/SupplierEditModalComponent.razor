@* 可重用的廠商編輯組件 - 可在任何頁面中嵌入 *@
@inject ISupplierService SupplierService
@inject IProductSupplierService ProductSupplierService
@inject INotificationService NotificationService
@inject ActionButtonHelper ActionButtonHelper

<GenericEditModalComponent TEntity="Supplier" 
                          TService="ISupplierService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@SupplierId"
                          Service="@SupplierService"
                          EntityName="廠商"
                          EntityNamePlural="廠商"
                          ModalTitle="@(SupplierId.HasValue ? "編輯廠商" : "新增廠商")"
                          Size="GenericEditModalComponent<Supplier, ISupplierService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@(autoCompleteConfig?.Prefillers)"
                          AutoCompleteCollections="@(autoCompleteConfig?.Collections)"
                          AutoCompleteDisplayProperties="@(autoCompleteConfig?.DisplayProperties)"
                          AutoCompleteValueProperties="@(autoCompleteConfig?.ValueProperties)"
                          DataLoader="@LoadSupplierData"
                          AdditionalDataLoader="@LoadAdditionalDataAsync"
                          SaveHandler="@SaveSupplier"
                          OnSaveSuccess="@OnSaveSuccess"
                          RequiredPermission="Supplier.Read"
                          OnCancel="@OnCancel" />

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SupplierId { get; set; }
    [Parameter] public EventCallback<Supplier> OnSupplierSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public Dictionary<string, object?>? PrefilledValues { get; set; }

    private GenericEditModalComponent<Supplier, ISupplierService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // 產品供應商關聯相關變數
    private List<ProductSupplier> supplierProducts = new();
    private List<Product> availableProducts = new();
    private List<Unit> availableUnits = new();
    
    // AutoComplete 配置
    private AutoCompleteConfig? autoCompleteConfig;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化廠商編輯組件時發生錯誤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        // 當 SupplierId 參數變更時，重新初始化表單欄位
        if (formFields != null) // 只有在已經初始化過的情況下才重新設定
        {
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
        }
        
        await base.OnParametersSetAsync();
    }

    private Task LoadAdditionalDataAsync()
    {
        try
        {
            // 配置 AutoComplete (目前廠商沒有 AutoComplete 欄位,保留空配置以便未來擴充)
            autoCompleteConfig = new AutoCompleteConfigBuilder<Supplier>()
                .Build();
            
            return Task.CompletedTask;
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("載入廠商編輯相關資料時發生錯誤");
            return Task.CompletedTask;
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(Supplier.Code),
                    Label = "廠商代碼",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入廠商代碼",
                    IsRequired = true,
                    MaxLength = 20,
                    HelpText = "廠商的唯一識別代碼"
                },
                new()
                {
                    PropertyName = nameof(Supplier.CompanyName),
                    Label = "公司名稱",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入公司名稱",
                    IsRequired = false,
                    MaxLength = 100,
                    HelpText = "廠商的正式公司名稱（公司名稱、負責人或聯絡人至少需填寫一項）"
                },
                new()
                {
                    PropertyName = nameof(Supplier.ContactPerson),
                    Label = "聯絡人",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入聯絡人姓名",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "主要聯絡人姓名（公司名稱、負責人或聯絡人至少需填寫一項）"
                },
                new()
                {
                    PropertyName = nameof(Supplier.TaxNumber),
                    Label = "統一編號",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入統一編號",
                    MaxLength = 8,
                    HelpText = "公司統一編號（8位數字）"
                },
                new()
                {
                    PropertyName = nameof(Supplier.ResponsiblePerson),
                    Label = "負責人",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入負責人姓名",
                    IsRequired = false,
                    MaxLength = 10,
                    HelpText = "公司負責人姓名（公司名稱、負責人或聯絡人至少需填寫一項）"
                },
                new()
                {
                    PropertyName = nameof(Supplier.JobTitle),
                    Label = "職稱",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入職稱",
                    IsRequired = false,
                    MaxLength = 10,
                    HelpText = "聯絡人職稱"
                },
                new()
                {
                    PropertyName = nameof(Supplier.ContactPhone),
                    Label = "聯絡電話",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入聯絡電話",
                    IsRequired = false,
                    MaxLength = 20,
                    HelpText = "聯絡人或是公司聯絡電話"
                },
                new()
                {
                    PropertyName = nameof(Supplier.MobilePhone),
                    Label = "行動電話",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入行動電話",
                    IsRequired = false,
                    MaxLength = 20,
                    HelpText = "聯絡人行動電話"
                },
                new()
                {
                    PropertyName = nameof(Supplier.Fax),
                    Label = "傳真",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入傳真號碼",
                    IsRequired = false,
                    MaxLength = 20,
                    HelpText = "公司傳真號碼"
                },
                new()
                {
                    PropertyName = nameof(Supplier.Email),
                    Label = "信箱",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入電子郵件",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "聯絡人電子郵件地址"
                },
                new()
                {
                    PropertyName = nameof(Supplier.Website),
                    Label = "公司網址",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入公司網址",
                    MaxLength = 50,
                    ContainerCssClass = "col-4",
                    HelpText = "公司官方網站網址"
                },
                new()
                {
                    PropertyName = nameof(Supplier.ContactAddress),
                    Label = "聯絡地址",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入聯絡地址",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "公司聯絡地址",
                    ContainerCssClass = "col-4"
                },
                new()
                {
                    PropertyName = nameof(Supplier.SupplierAddress),
                    Label = "公司地址",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入公司地址",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "公司地址",
                    ContainerCssClass = "col-4"
                },
                new()
                {
                    PropertyName = nameof(Supplier.PaymentMethod),
                    Label = "付款方式",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入付款方式",
                    IsRequired = false,
                    MaxLength = 10,
                    HelpText = "客戶的付款方式（例如：現金、支票、匯款等）"
                },
                new()
                {
                    PropertyName = nameof(Supplier.PaymentTerms),
                    Label = "付款條件",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入付款條件",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "付款條件說明（例如：月結30天、貨到付款等）"
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(Supplier.SupplierContactPhone),
                    Label = "聯絡電話",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入聯絡電話",
                    IsRequired = false,
                    MaxLength = 20,
                    HelpText = "負責人或是公司聯絡電話"
                },

                FormFieldConfigurationHelper.CreateRemarksField<Supplier>()
            };

            // 更新表單區段定義
            formSections = FormSectionHelper<Supplier>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    s => s.Code,
                    s => s.CompanyName,
                    s => s.ResponsiblePerson,
                    s => s.SupplierContactPhone,
                    s => s.TaxNumber,
                    s => s.Fax,
                    s => s.Website,
                    s => s.ContactAddress,
                    s => s.SupplierAddress)
                .AddToSection(FormSectionNames.ContactPersonInfo,
                    s => s.ContactPerson,
                    s => s.JobTitle,
                    s => s.ContactPhone,
                    s => s.MobilePhone,
                    s => s.Email)
                .AddToSection(FormSectionNames.PaymentInfo,
                    s => s.PaymentMethod,
                    s => s.PaymentTerms)
                .AddToSection(FormSectionNames.OtherInfo,
                    s => s.Remarks)
                .Build();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化表單欄位時發生錯誤");
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }
    
    private async Task<Supplier?> LoadSupplierData()
    {
        try
        {
            if (!SupplierId.HasValue) 
            {
                // 新增模式
                var newSupplier = new Supplier
                {
                    Code = await EntityCodeGenerationHelper.GenerateForEntity<Supplier, ISupplierService>(SupplierService, "S"),
                    CompanyName = "",
                    ContactPerson = "",
                    TaxNumber = "",
                    Status = EntityStatus.Active
                };
                
                // 應用預填值
                PrefilledValueHelper.ApplyPrefilledValues(newSupplier, PrefilledValues);
                
                return newSupplier;
            }

            var supplier = await SupplierService.GetByIdAsync(SupplierId.Value);            
            
            if (supplier == null)
            {
                _ = NotificationService.ShowErrorAsync("找不到指定的廠商資料");
                return null;
            }
            
            return supplier;
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("載入廠商資料時發生錯誤");
            
            // 設定安全的預設值，確保程式不會崩潰
            return new Supplier
            {
                Code = "",
                CompanyName = "",
                ContactPerson = "",
                TaxNumber = "",
                Status = EntityStatus.Active
            };
        }
    }

    private async Task<bool> SaveSupplier(Supplier entity)
    {
        try
        {
            // 使用服務的完整驗證邏輯（包含重複檢查）
            var validationResult = await SupplierService.ValidateAsync(entity);
            if (!validationResult.IsSuccess)
            {
                _ = NotificationService.ShowErrorAsync(validationResult.ErrorMessage);
                return false;
            }

            ServiceResult result;
            
            if (SupplierId.HasValue)
            {
                // 更新現有廠商
                result = await SupplierService.UpdateAsync(entity);
            }
            else
            {
                // 新增廠商
                result = await SupplierService.CreateAsync(entity);
            }

            // 讓 GenericEditModalComponent 處理通用的成功/失敗訊息
            return result.IsSuccess;
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("儲存廠商資料時發生錯誤");
            return false;
        }
    }



    private async Task OnSaveSuccess()
    {
        try
        {
            if (editModalComponent?.Entity != null)
            {
                await OnSupplierSaved.InvokeAsync(editModalComponent.Entity);
            }
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("儲存成功回調時發生錯誤");
        }
    }










}
