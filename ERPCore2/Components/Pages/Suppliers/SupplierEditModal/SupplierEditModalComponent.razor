@* 可重用的廠商編輯組件 - 可在任何頁面中嵌入 *@
@using ERPCore2.Services.Reports.Interfaces
@using ERPCore2.Models.Reports
@inject ISupplierService SupplierService
@inject IPaymentMethodService PaymentMethodService
@inject INotificationService NotificationService
@inject ISupplierRosterReportService SupplierRosterReportService
@inject ISupplierDetailReportService SupplierDetailReportService
@inject ActionButtonHelper ActionButtonHelper

<GenericEditModalComponent TEntity="Supplier"
                          TService="ISupplierService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@SupplierId"
                          Service="@SupplierService"
                          EntityName="廠商"
                          EntityNamePlural="廠商"
                          ModalTitle="@(SupplierId.HasValue ? "編輯廠商" : "新增廠商")"
                          Size="GenericEditModalComponent<Supplier, ISupplierService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          TabDefinitions="@tabDefinitions"
                          AutoCompletePrefillers="@(autoCompleteConfig?.Prefillers)"
                          AutoCompleteCollections="@(autoCompleteConfig?.Collections)"
                          AutoCompleteDisplayProperties="@(autoCompleteConfig?.DisplayProperties)"
                          AutoCompleteValueProperties="@(autoCompleteConfig?.ValueProperties)"
                          ModalManagers="@modalManagers?.AsDictionary()"
                          DataLoader="@LoadSupplierData"
                          SaveHandler="@SaveSupplier"
                          OnSaveSuccess="@OnSaveSuccess"
                          RequiredPermission="Supplier.Read"
                          OnCancel="@OnCancel"
                          OnEntityLoaded="@HandleEntityLoaded"
                          ShowPrintButton="true"
                          PrintButtonText="列印"
                          ReportService="@SupplierDetailReportService"
                          ReportId="@ReportIds.SupplierDetail"
                          ReportPreviewTitle="廠商詳細資料預覽"
                          GetReportDocumentName="@(e => $"廠商-{e.Code}")"
                          CustomModules="@GetCustomModules()"
                          CustomActionButtons="@GetCustomActionButtons()" />

@* 付款方式編輯 Modal *@
<PaymentMethodEditModalComponent @ref="paymentMethodEditModal"
                                IsVisible="@paymentMethodModalManager.IsModalVisible"
                                IsVisibleChanged="@paymentMethodModalManager.HandleModalVisibilityChangedAsync"
                                PaymentMethodId="@paymentMethodModalManager.SelectedEntityId"
                                OnPaymentMethodSaved="@paymentMethodModalManager.OnSavedAsync"
                                OnCancel="@paymentMethodModalManager.HandleModalCancelAsync" />

@* 複製至客戶確認 Modal *@
<GenericConfirmModalComponent IsVisible="@showCopyToCustomerModal"
                              IsVisibleChanged="@((bool v) => showCopyToCustomerModal = v)"
                              Title="複製至客戶"
                              Icon="bi-person-lines-fill"
                              Message="確定要將此廠商的資料複製為新客戶嗎？"
                              Conditions="@copyToCustomerConditions"
                              SummaryMessage="複製後將在客戶清單中建立一筆新資料"
                              ConfirmButtonText="確認複製"
                              CancelButtonText="取消"
                              ConfirmButtonVariant="ButtonVariant.Green"
                              HeaderColor="BaseModalComponent.HeaderVariant.Primary"
                              OnConfirm="@HandleConfirmCopyToCustomer"
                              OnCancel="@(() => showCopyToCustomerModal = false)" />

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SupplierId { get; set; }
    [Parameter] public EventCallback<Supplier> OnSupplierSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public Dictionary<string, object?>? PrefilledValues { get; set; }

    private GenericEditModalComponent<Supplier, ISupplierService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    private List<FormTabDefinition>? tabDefinitions;

    // AutoComplete 配置
    private AutoCompleteConfig? autoCompleteConfig;

    // 付款方式選項
    private List<PaymentMethod> availablePaymentMethods = new();

    // Modal Manager 集合
    private ModalManagerCollection? modalManagers;

    // 付款方式編輯 Modal 相關變數 - 使用泛型管理器
    private PaymentMethodEditModalComponent? paymentMethodEditModal;
    private RelatedEntityModalManager<PaymentMethod> paymentMethodModalManager = default!;

    // 資料載入狀態標記
    private bool isDataLoaded = false;

    // 複製至客戶
    private bool showCopyToCustomerModal = false;
    private List<string> copyToCustomerConditions = new();

    // Tab 元件參考（透過 @ref 呼叫公開方法）
    private SupplierVehicleTab? vehicleTab;
    private SupplierProductTab? supplierProductTab;

    // ===== Tab 內容 RenderFragment =====

    private RenderFragment CreateVehicleTabContent() => __builder =>
    {
        <SupplierVehicleTab @ref="vehicleTab" SupplierId="@SupplierId" />
    };

    private RenderFragment CreateSupplierProductTabContent() => __builder =>
    {
        <SupplierProductTab @ref="supplierProductTab" SupplierId="@SupplierId" />
    };

    // ===== 生命週期 =====

    protected override async Task OnInitializedAsync()
    {
        try
        {
            modalManagers = ModalManagerInitHelper.CreateBuilder<Supplier, ISupplierService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<PaymentMethod>(nameof(Supplier.PaymentMethodId), "付款方式")
                .Build();

            paymentMethodModalManager = modalManagers.Get<PaymentMethod>(nameof(Supplier.PaymentMethodId));
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化廠商編輯組件時發生錯誤");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
        }
    }

    // ===== 事件處理 =====

    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            if (loadedEntityId > 0)
            {
                if (vehicleTab != null)         await vehicleTab.LoadAsync(loadedEntityId);
                if (supplierProductTab != null) await supplierProductTab.LoadAsync(loadedEntityId);
            }
            else
            {
                vehicleTab?.Clear();
                supplierProductTab?.Clear();
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入資料時發生錯誤：{ex.Message}");
        }
    }

    private async Task OnSaveSuccess()
    {
        try
        {
            if (editModalComponent?.Entity != null)
            {
                await OnSupplierSaved.InvokeAsync(editModalComponent.Entity);
            }
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("儲存成功回調時發生錯誤");
        }
    }

    // ===== 資料載入 =====

    private async Task<Supplier?> LoadSupplierData()
    {
        try
        {
            if (!SupplierId.HasValue)
            {
                vehicleTab?.Clear();
                supplierProductTab?.Clear();

                var newSupplier = new Supplier
                {
                    Code = await EntityCodeGenerationHelper.GenerateForEntity<Supplier, ISupplierService>(SupplierService, "S"),
                    CompanyName = "",
                    ContactPerson = "",
                    TaxNumber = "",
                    Status = EntityStatus.Active
                };

                PrefilledValueHelper.ApplyPrefilledValues(newSupplier, PrefilledValues);
                return newSupplier;
            }

            var supplier = await SupplierService.GetByIdAsync(SupplierId.Value);

            if (supplier == null)
            {
                _ = NotificationService.ShowErrorAsync("找不到指定的廠商資料");
                return null;
            }

            return supplier;
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("載入廠商資料時發生錯誤");
            return new Supplier
            {
                Code = "",
                CompanyName = "",
                ContactPerson = "",
                TaxNumber = "",
                Status = EntityStatus.Active
            };
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            availablePaymentMethods = await PaymentMethodService.GetAllAsync();

            autoCompleteConfig = new AutoCompleteConfigBuilder<Supplier>()
                .AddField(nameof(Supplier.PaymentMethodId), "Name", availablePaymentMethods)
                .Build();
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("載入廠商編輯相關資料時發生錯誤");
            availablePaymentMethods = new List<PaymentMethod>();
        }
    }

    // ===== 自訂儲存（含車輛緩衝提交） =====

    private async Task<bool> SaveSupplier(Supplier entity)
    {
        try
        {
            var validationResult = await SupplierService.ValidateAsync(entity);
            if (!validationResult.IsSuccess)
            {
                _ = NotificationService.ShowErrorAsync(validationResult.ErrorMessage);
                return false;
            }

            ServiceResult result;

            if (SupplierId.HasValue)
                result = await SupplierService.UpdateAsync(entity);
            else
                result = await SupplierService.CreateAsync(entity);

            if (!result.IsSuccess)
                return false;

            // 車輛 Tab 有緩衝機制，需在主檔儲存後提交
            if (vehicleTab != null)
                await vehicleTab.SavePendingChangesAsync(entity.Id);

            return true;
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("儲存廠商資料時發生錯誤");
            return false;
        }
    }

    // ===== 表單欄位定義 =====

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(Supplier.Code),
                    Label = "廠商編號",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入廠商編號",
                    IsRequired = true,
                    MaxLength = 20,
                    HelpText = "廠商的唯一識別編號"
                },
                new()
                {
                    PropertyName = nameof(Supplier.CompanyName),
                    Label = "廠商名稱",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入廠商名稱",
                    IsRequired = false,
                    MaxLength = 100,
                    HelpText = "廠商的正式廠商名稱（廠商名稱、負責人或聯絡人至少需填寫一項）"
                },
                new()
                {
                    PropertyName = nameof(Supplier.ContactPerson),
                    Label = "聯絡人",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入聯絡人姓名",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "主要聯絡人姓名（廠商名稱、負責人或聯絡人至少需填寫一項）",
                    ActionButtons = await GetContactPersonActionButtonsAsync()
                },
                new()
                {
                    PropertyName = nameof(Supplier.TaxNumber),
                    Label = "統一編號",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入統一編號",
                    MaxLength = 8,
                    HelpText = "公司統一編號（8位數字）"
                },
                new()
                {
                    PropertyName = nameof(Supplier.ResponsiblePerson),
                    Label = "負責人",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入負責人姓名",
                    IsRequired = false,
                    MaxLength = 10,
                    HelpText = "公司負責人姓名（廠商名稱、負責人或聯絡人至少需填寫一項）"
                },
                new()
                {
                    PropertyName = nameof(Supplier.JobTitle),
                    Label = "職稱",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入職稱",
                    IsRequired = false,
                    MaxLength = 10,
                    HelpText = "聯絡人職稱"
                },
                new()
                {
                    PropertyName = nameof(Supplier.ContactPhone),
                    Label = "聯絡電話",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入聯絡電話",
                    IsRequired = false,
                    MaxLength = 20,
                    HelpText = "聯絡人或是公司聯絡電話"
                },
                new()
                {
                    PropertyName = nameof(Supplier.MobilePhone),
                    Label = "行動電話",
                    FieldType = FormFieldType.MobilePhone,
                    Placeholder = "0912-345-678",
                    HelpText = "聯絡人行動電話（10碼，以09開頭）"
                },
                new()
                {
                    PropertyName = nameof(Supplier.Fax),
                    Label = "傳真",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入傳真號碼",
                    IsRequired = false,
                    MaxLength = 20,
                    HelpText = "公司傳真號碼"
                },
                new()
                {
                    PropertyName = nameof(Supplier.Email),
                    Label = "信箱",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入電子郵件",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "聯絡人電子郵件地址"
                },
                new()
                {
                    PropertyName = nameof(Supplier.Website),
                    Label = "公司網址",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入公司網址",
                    MaxLength = 50,
                    ContainerCssClass = "col-4",
                    HelpText = "公司官方網站網址"
                },
                new()
                {
                    PropertyName = nameof(Supplier.ContactAddress),
                    Label = "聯絡地址",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入聯絡地址",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "公司聯絡地址",
                    ContainerCssClass = "col-4"
                },
                new()
                {
                    PropertyName = nameof(Supplier.SupplierAddress),
                    Label = "公司地址",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入公司地址",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "公司地址",
                    ContainerCssClass = "col-4",
                    ActionButtons = await GetSupplierAddressActionButtonsAsync()
                },
                new()
                {
                    PropertyName = nameof(Supplier.PaymentMethodId),
                    Label = "付款方式",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇付款方式",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "廠商的付款方式（例如：現金、支票、匯款等）",
                    ActionButtons = await GetPaymentMethodActionButtonsAsync()
                },
                new()
                {
                    PropertyName = nameof(Supplier.PaymentTerms),
                    Label = "付款條件",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入付款條件",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "付款條件說明（例如：月結30天、貨到付款等）"
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(Supplier.SupplierContactPhone),
                    Label = "廠商電話",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入廠商電話",
                    IsRequired = false,
                    MaxLength = 20,
                    HelpText = "負責人或是公司聯絡電話"
                },
                FormFieldConfigurationHelper.CreateRemarksField<Supplier>()
            };

            var layout = FormSectionHelper<Supplier>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    s => s.Code,
                    s => s.CompanyName,
                    s => s.ResponsiblePerson,
                    s => s.SupplierContactPhone,
                    s => s.TaxNumber,
                    s => s.Fax,
                    s => s.Website,
                    s => s.ContactAddress,
                    s => s.SupplierAddress)
                .AddToSection(FormSectionNames.ContactPersonInfo,
                    s => s.ContactPerson,
                    s => s.JobTitle,
                    s => s.ContactPhone,
                    s => s.MobilePhone,
                    s => s.Email)
                .AddToSection(FormSectionNames.PaymentInfo,
                    s => s.PaymentMethodId,
                    s => s.PaymentTerms)
                .AddToSection(FormSectionNames.OtherInfo,
                    s => s.Remarks)
                .GroupIntoTab("廠商資料", "bi-shop", FormSectionNames.BasicInfo, FormSectionNames.ContactPersonInfo, FormSectionNames.PaymentInfo, FormSectionNames.OtherInfo)
                .GroupIntoCustomTab("車輛資訊", "bi-truck", CreateVehicleTabContent())
                .GroupIntoCustomTab("供應商品", "bi-box-seam", CreateSupplierProductTabContent())
                .BuildAll();

            formSections = layout.FieldSections;
            tabDefinitions = layout.TabDefinitions;
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化表單欄位時發生錯誤");
        }
    }

    // ===== 欄位操作按鈕 =====

    private async Task<List<FieldActionButton>> GetPaymentMethodActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent,
            paymentMethodModalManager,
            nameof(Supplier.PaymentMethodId)
        );
    }

    private Task<List<FieldActionButton>> GetContactPersonActionButtonsAsync()
    {
        return Task.FromResult(new List<FieldActionButton>
        {
            new()
            {
                Text = "複製",
                Variant = "OutlinePrimary",
                Size = "Small",
                Title = "將負責人姓名與聯絡電話複製到聯絡人資訊",
                OnClick = async () => await CopyResponsiblePersonToContactPerson(),
                IsDisabled = false
            }
        });
    }

    private Task<List<FieldActionButton>> GetSupplierAddressActionButtonsAsync()
    {
        return Task.FromResult(new List<FieldActionButton>
        {
            new()
            {
                Text = "複製",
                Variant = "OutlinePrimary",
                Size = "Small",
                Title = "將聯絡地址複製到公司地址",
                OnClick = async () => await CopyContactAddressToSupplierAddress(),
                IsDisabled = false
            }
        });
    }

    private async Task CopyResponsiblePersonToContactPerson()
    {
        if (editModalComponent?.Entity != null)
        {
            var entity = editModalComponent.Entity;

            if (string.IsNullOrWhiteSpace(entity.ResponsiblePerson) &&
                string.IsNullOrWhiteSpace(entity.SupplierContactPhone))
            {
                await NotificationService.ShowWarningAsync("負責人姓名與聯絡電話皆為空，無資料可複製");
                return;
            }

            entity.ContactPerson = entity.ResponsiblePerson;
            entity.ContactPhone = entity.SupplierContactPhone;
            StateHasChanged();
            await NotificationService.ShowSuccessAsync("已將負責人資料複製到聯絡人資訊");
        }
    }

    private async Task CopyContactAddressToSupplierAddress()
    {
        if (editModalComponent?.Entity != null)
        {
            var entity = editModalComponent.Entity;

            if (string.IsNullOrWhiteSpace(entity.ContactAddress))
            {
                await NotificationService.ShowWarningAsync("聯絡地址為空，無資料可複製");
                return;
            }

            entity.SupplierAddress = entity.ContactAddress;
            StateHasChanged();
            await NotificationService.ShowSuccessAsync("已將聯絡地址複製到公司地址");
        }
    }

    // ===== 自訂模組 =====

    private List<GenericEditModalComponent<Supplier, ISupplierService>.CustomModule> GetCustomModules()
    {
        return new List<GenericEditModalComponent<Supplier, ISupplierService>.CustomModule>();
    }

    // ===== 複製至客戶 =====

    private RenderFragment? GetCustomActionButtons() => __builder =>
    {
        if (editModalComponent?.Entity != null && SupplierId.HasValue)
        {
            <GenericButtonComponent Text="複製至客戶"
                                    Variant="ButtonVariant.Green"
                                    OnClick="HandleCopyToCustomerClick"
                                    Title="將此廠商資料複製為新客戶" />
        }
    };

    private async Task HandleCopyToCustomerClick()
    {
        try
        {
            var entity = editModalComponent?.Entity;
            if (entity == null)
            {
                await NotificationService.ShowErrorAsync("無法取得廠商資料");
                return;
            }

            if (string.IsNullOrWhiteSpace(entity.CompanyName))
            {
                await NotificationService.ShowErrorAsync("廠商公司名稱不可為空白，無法複製至客戶");
                return;
            }

            copyToCustomerConditions = new List<string>();
            copyToCustomerConditions.Add($"公司名稱：{entity.CompanyName}");
            if (!string.IsNullOrWhiteSpace(entity.ContactPerson))        copyToCustomerConditions.Add($"聯絡人：{entity.ContactPerson}");
            if (!string.IsNullOrWhiteSpace(entity.TaxNumber))             copyToCustomerConditions.Add($"統一編號：{entity.TaxNumber}");
            if (!string.IsNullOrWhiteSpace(entity.ResponsiblePerson))     copyToCustomerConditions.Add($"負責人：{entity.ResponsiblePerson}");
            if (!string.IsNullOrWhiteSpace(entity.SupplierContactPhone))  copyToCustomerConditions.Add($"公司聯絡電話：{entity.SupplierContactPhone}");
            if (!string.IsNullOrWhiteSpace(entity.ContactPhone))          copyToCustomerConditions.Add($"聯絡電話：{entity.ContactPhone}");
            if (!string.IsNullOrWhiteSpace(entity.MobilePhone))           copyToCustomerConditions.Add($"行動電話：{entity.MobilePhone}");
            if (!string.IsNullOrWhiteSpace(entity.Email))                 copyToCustomerConditions.Add($"信箱：{entity.Email}");
            if (!string.IsNullOrWhiteSpace(entity.Fax))                   copyToCustomerConditions.Add($"傳真：{entity.Fax}");
            if (!string.IsNullOrWhiteSpace(entity.ContactAddress))        copyToCustomerConditions.Add($"聯絡地址：{entity.ContactAddress}");
            if (!string.IsNullOrWhiteSpace(entity.SupplierAddress))       copyToCustomerConditions.Add($"公司地址：{entity.SupplierAddress}");
            if (!string.IsNullOrWhiteSpace(entity.Website))               copyToCustomerConditions.Add($"公司網址：{entity.Website}");
            if (!string.IsNullOrWhiteSpace(entity.JobTitle))              copyToCustomerConditions.Add($"職稱：{entity.JobTitle}");
            if (!string.IsNullOrWhiteSpace(entity.PaymentTerms))          copyToCustomerConditions.Add($"付款條件：{entity.PaymentTerms}");
            if (entity.PaymentMethodId.HasValue)                          copyToCustomerConditions.Add("付款方式（依對應帳款方式）");

            showCopyToCustomerModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"操作時發生錯誤：{ex.Message}");
        }
    }

    private async Task HandleConfirmCopyToCustomer()
    {
        try
        {
            if (!SupplierId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法取得廠商 ID");
                return;
            }

            var result = await SupplierService.CopyToCustomerAsync(SupplierId.Value);

            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync($"已成功將「{editModalComponent?.Entity?.CompanyName}」複製為客戶（編號：{result.Data?.Code}）");
            }
            else
            {
                await NotificationService.ShowErrorAsync($"複製至客戶失敗：{result.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"複製至客戶時發生錯誤：{ex.Message}");
        }
    }
}
