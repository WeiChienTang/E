@* 廠商供應商品 Tab - 自包含元件，主組件透過 @ref 協調 *@
@inject IProductSupplierService ProductSupplierService
@inject INotificationService NotificationService
@inject IStringLocalizer<SharedResource> L

@if (_isLoading)
{
    <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">@L["Label.Loading"]</span>
        </div>
    </div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-2 px-1">
        <small class="text-muted">@string.Format(L["Label.RecordCount"], _productSuppliers.Count)</small>
        <small class="text-muted fst-italic">
            <i class="bi bi-info-circle me-1"></i>@L["Supplier.AutoSyncNote"]
        </small>
    </div>

    <InteractiveTableComponent TItem="ProductSupplier"
                               Items="@_productSuppliers"
                               ColumnDefinitions="@GetColumnDefinitions()"
                               ShowHeader="true"
                               ShowRowNumbers="true"
                               IsStriped="true"
                               IsHoverable="true"
                               IsBordered="true"
                               ShowBuiltInActions="true"
                               ShowBuiltInDeleteButton="true"
                               DeleteButtonVariant="ButtonVariant.Red"
                               DeleteButtonTitle="@L["Supplier.DeleteButtonTitle"]"
                               OnItemDelete="@HandleDeleteItem"
                               EmptyMessage="@L["Supplier.NoProducts"]" />
}

@* 刪除確認 Modal *@
<GenericConfirmModalComponent IsVisible="@_showDeleteModal"
                              IsVisibleChanged="@((bool v) => _showDeleteModal = v)"
                              Title="@L["Supplier.RemoveProduct"]"
                              Icon="bi-trash"
                              Message="@string.Format(L["Supplier.ConfirmRemoveProduct"], _deletingItem?.Product?.Name ?? L["Column.Product"])"
                              ConfirmButtonText="@L["Button.ConfirmRemove"]"
                              CancelButtonText="@L["Button.Cancel"]"
                              ConfirmButtonVariant="ButtonVariant.Red"
                              HeaderColor="BaseModalComponent.HeaderVariant.Danger"
                              OnConfirm="@HandleConfirmDelete"
                              OnCancel="@(() => _showDeleteModal = false)" />

@code {
    [Parameter] public int? SupplierId { get; set; }

    private List<ProductSupplier> _productSuppliers = new();
    private bool _isLoading = false;
    private bool _showDeleteModal = false;
    private ProductSupplier? _deletingItem = null;

    // ===== 公開方法（供主組件透過 @ref 呼叫） =====

    public async Task LoadAsync(int supplierId)
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            _productSuppliers = await ProductSupplierService.GetBySupplierIdAsync(supplierId);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入供應商品時發生錯誤：{ex.Message}");
            _productSuppliers = new();
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    public void Clear()
    {
        _productSuppliers = new();
        StateHasChanged();
    }

    // ===== 欄位定義 =====

    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = L["Column.ProductCode"],
                PropertyName = "",
                ColumnType = InteractiveColumnType.Display,
                Width = "110px",
                DisplayFormatter = item => item is ProductSupplier ps0 ? ps0.Product?.Code ?? "-" : "-"
            },
            new()
            {
                Title = L["Column.ProductName"],
                PropertyName = "",
                ColumnType = InteractiveColumnType.Display,
                DisplayFormatter = item => item is ProductSupplier ps1 ? ps1.Product?.Name ?? "-" : "-"
            },
            new()
            {
                Title = L["Column.SupplierProductCode"],
                PropertyName = nameof(ProductSupplier.SupplierProductCode),
                ColumnType = InteractiveColumnType.Display,
                Width = "120px",
                NullDisplayText = "-"
            },
            new()
            {
                Title = L["Column.LastPurchasePrice"],
                PropertyName = "",
                ColumnType = InteractiveColumnType.Display,
                Width = "110px",
                TextAlign = "right",
                DisplayFormatter = item =>
                {
                    if (item is not ProductSupplier ps) return "-";
                    return ps.LastPurchasePrice.HasValue
                        ? ps.LastPurchasePrice.Value.ToString("N0")
                        : "-";
                }
            },
            new()
            {
                Title = L["Column.LastPurchaseDate"],
                PropertyName = "",
                ColumnType = InteractiveColumnType.Display,
                Width = "110px",
                DisplayFormatter = item =>
                {
                    if (item is not ProductSupplier ps) return "-";
                    return ps.LastPurchaseDate.HasValue
                        ? ps.LastPurchaseDate.Value.ToString("yyyy/MM/dd")
                        : "-";
                }
            },
            new()
            {
                Title = L["Column.IsPreferred"],
                PropertyName = "",
                ColumnType = InteractiveColumnType.Display,
                Width = "55px",
                TextAlign = "center",
                DisplayFormatter = item =>
                {
                    if (item is not ProductSupplier ps) return "";
                    return ps.IsPreferred ? "<span class=\"text-warning fw-bold\" title=\"常用廠商\">★</span>" : "";
                }
            }
        };
    }

    // ===== 刪除處理 =====

    private async Task HandleDeleteItem(ProductSupplier item)
    {
        _deletingItem = item;
        _showDeleteModal = true;
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task HandleConfirmDelete()
    {
        if (_deletingItem == null) return;

        try
        {
            var result = await ProductSupplierService.DeleteAsync(_deletingItem.Id);
            if (result.IsSuccess)
            {
                _productSuppliers.RemoveAll(ps => ps.Id == _deletingItem.Id);
                await NotificationService.ShowSuccessAsync(L["Supplier.RemovedFromCatalog"]);
            }
            else
            {
                await NotificationService.ShowErrorAsync($"移除失敗：{result.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"移除時發生錯誤：{ex.Message}");
        }
        finally
        {
            _deletingItem = null;
            _showDeleteModal = false;
            StateHasChanged();
        }
    }
}
