@* 廠商會計資訊 Tab — 顯示應付帳款等四種子科目，並可立即建立 *@
@using ERPCore2.Models.Enums
@using Microsoft.Extensions.Localization
@inject ISubAccountService SubAccountService
@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthStateProvider
@inject IStringLocalizer<SharedResource> L

@if (_supplierId <= 0)
{
    <div class="text-muted py-3 px-2">
        <i class="bi bi-info-circle me-2"></i>@L["Accounting.SaveFirst"]
    </div>
}
else if (_isLoading)
{
    <div class="text-muted py-3 px-2">
        <i class="bi bi-hourglass-split me-2"></i>@L["Label.Loading"]
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-sm table-hover mb-3">
            <thead class="table-light">
                <tr>
                    <th style="width:160px">@L["Accounting.SubAccountType"]</th>
                    <th style="width:140px">@L["Accounting.AccountCode"]</th>
                    <th>@L["Accounting.AccountName"]</th>
                    <th style="width:90px">@L["Field.Status"]</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var row in _rows)
                {
                    <tr>
                        <td>@row.Label</td>
                        <td class="font-monospace small">@(row.Item?.Code ?? "—")</td>
                        <td class="small">@(row.Item?.Name ?? "—")</td>
                        <td>
                            @if (row.Item != null)
                            {
                                <span class="text-success small"><i class="bi bi-check-circle me-1"></i>@L["Accounting.Created"]</span>
                            }
                            else
                            {
                                <span class="text-warning small"><i class="bi bi-exclamation-circle me-1"></i>@L["Accounting.NotCreated"]</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (_rows.Any(r => r.Item == null))
    {
        <GenericButtonComponent Variant="ButtonVariant.DarkBlue"
                               Text="@L["Accounting.CreateSubAccount"].ToString()"
                               OnClick="HandleCreateAsync"
                               IsLoading="@_isCreating"
                               IsDisabled="@_isCreating"
                               Title="@L["Accounting.CreateSubAccountTitle"].ToString()" />
    }
}

@code {
    private int _supplierId;
    private bool _isLoading;
    private bool _isCreating;
    private List<(string Label, AccountItem? Item)> _rows = new();

    public async Task LoadAsync(int supplierId)
    {
        _supplierId = supplierId;
        await RefreshAsync();
        StateHasChanged();
    }

    public void Clear()
    {
        _supplierId = 0;
        _rows = new();
        StateHasChanged();
    }

    private async Task RefreshAsync()
    {
        if (_supplierId <= 0) return;

        _isLoading = true;
        StateHasChanged();

        var all = await SubAccountService.GetAllSubAccountsForSupplierAsync(_supplierId);

        AccountItem? Find(SubAccountLinkType type) =>
            all.FirstOrDefault(a =>
                a.SubAccountLinkType == type ||
                (type == SubAccountLinkType.ReceivablePayable && a.SubAccountLinkType == null));

        _rows = new()
        {
            (L["Accounting.AccountsPayable"].ToString(), Find(SubAccountLinkType.ReceivablePayable)),
            (L["Accounting.NotePayable"].ToString(), Find(SubAccountLinkType.NoteReceivablePayable)),
            (L["Accounting.PurchaseReturn"].ToString(), Find(SubAccountLinkType.SalesPurchaseReturn)),
            (L["Accounting.AdvancePayment"].ToString(), Find(SubAccountLinkType.AdvanceReceiptPayment)),
        };

        _isLoading = false;
    }

    private async Task HandleCreateAsync()
    {
        try
        {
            _isCreating = true;
            StateHasChanged();

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var createdBy = authState.User.Identity?.Name ?? "system";

            await SubAccountService.GetOrCreateSupplierSubAccountAsync(_supplierId, createdBy);
            await RefreshAsync();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync(L["Accounting.CreateError"].ToString());
        }
        finally
        {
            _isCreating = false;
            StateHasChanged();
        }
    }
}
