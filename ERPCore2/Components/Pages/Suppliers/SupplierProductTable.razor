@* 供應商商品綁定管理組件 - 使用 InteractiveTableComponent *@
@inject INotificationService NotificationService
@inject IJSRuntime JSRuntime
@inject IStringLocalizer<SharedResource> L
@using ERPCore2.Helpers
@using ERPCore2.Data.Entities

<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <InteractiveTableComponent @ref="tableComponent"
                                  TItem="ProductSupplier" 
                                  Items="@Items"
                                  ColumnDefinitions="@GetColumnDefinitions()"
                                  ShowHeader="true"
                                  ShowRowNumbers="true"
                                  IsStriped="true"
                                  IsHoverable="true"
                                  IsBordered="true"
                                  ShowBuiltInActions="true"
                                  ShowBuiltInDeleteButton="true"
                                  DeleteButtonVariant="ButtonVariant.Red"
                                  OnItemDelete="@HandleDeleteItem"
                                  EnableAutoEmptyRow="true"
                                  AllowAddNewRow="true"
                                  ActionsColumnWidth = "60px"
                                  DataLoadCompleted="@DataLoadCompleted"
                                  CreateEmptyItem="@CreateEmptyItem"
                                  EmptyMessage="@EmptyMessage" />
    </div>
    
    <div class="card-footer">
        <div class="d-flex justify-content-end">
            <GenericButtonComponent Text="@L["Button.ClearDetails"]"
                                  Variant="ButtonVariant.Red"
                                  OnClick="ClearAllDetails"
                                  IsDisabled="@(!HasProductItems)"
                                  Title="@(!HasProductItems ? L["Supplier.NoClearTooltip"].ToString() : L["Supplier.ClearDetailsTooltip"].ToString())" />
        </div>
    </div>
</div>

@code {
    // ===== 參數 =====
    [Parameter] public List<ProductSupplier> Items { get; set; } = new();
    [Parameter] public EventCallback<List<ProductSupplier>> ItemsChanged { get; set; }
    [Parameter] public List<Product> AvailableProducts { get; set; } = new();
    [Parameter] public int SupplierId { get; set; }
    [Parameter] public bool DataLoadCompleted { get; set; } = true;
    [Parameter] public string EmptyMessage { get; set; } = "尚未設定供應商品";
    [Parameter] public EventCallback<ProductSupplier> OnItemDeleted { get; set; }
    
    // ===== InteractiveTableComponent 參考 =====
    private InteractiveTableComponent<ProductSupplier>? tableComponent;
    
    /// <summary>
    /// 計算屬性：是否有供應商品項目
    /// </summary>
    private bool HasProductItems => Items.Any(item => item.Product != null);

    /// <summary>
    /// 建立供應商品管理的欄位定義
    /// </summary>
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            // 商品選擇（必填，SearchableSelect）
            new InteractiveColumnDefinition
            {
                Title = L["Column.Product"],
                PropertyName = nameof(ProductSupplier.SearchText),  //  修正：綁定實際存在的屬性
                EmptyCheckPropertyName = nameof(ProductSupplier.Product),  //  修正：檢查物件屬性（null = 空行）
                ColumnType = InteractiveColumnType.SearchableSelect,
                Width = "300px",
                Placeholder = "請輸入商品編號或名稱",
                TriggerEmptyRowOnFilled = true,
                SearchValuePropertyName = nameof(ProductSupplier.SearchText),
                FilteredItemsPropertyName = "FilteredProducts",
                ShowDropdownPropertyName = "ShowProductDropdown",
                SelectedIndexPropertyName = "ProductSelectedIndex",
                ItemDisplayFormatter = (item) =>
                {
                    var product = (Product)item;
                    return $"[{product.Code}] {product.Name}";
                },
                EnableKeyboardNavigation = true,
                GetDropdownItems = (item) => ((ProductSupplier)item).FilteredProducts.Cast<object>().ToList(),
                GetSelectedIndex = (item) => ((ProductSupplier)item).ProductSelectedIndex,
                SetSelectedIndex = (item, index) => ((ProductSupplier)item).ProductSelectedIndex = index,
                GetShowDropdown = (item) => ((ProductSupplier)item).ShowProductDropdown,
                SetShowDropdown = (item, show) => ((ProductSupplier)item).ShowProductDropdown = show,
                MaxDisplayItems = 20,
                OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, (tuple) =>
                {
                    var (item, searchValue) = tuple;
                    OnProductSearchChanged((ProductSupplier)item, searchValue);
                }),
                OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
                {
                    var (item, selectedItem) = tuple;
                    await OnProductSelected((ProductSupplier)item, (Product?)selectedItem);
                }),
                OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
                {
                    OnProductFocus((ProductSupplier)item);
                }),
                OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
                {
                    OnProductBlur((ProductSupplier)item);
                })
            },
            
            // 供應商料號
            new InteractiveColumnDefinition
            {
                Title = L["Column.SupplierProductCode"],
                PropertyName = nameof(ProductSupplier.SupplierProductCode),
                ColumnType = InteractiveColumnType.Input,
                Width = "150px",
                Placeholder = "供應商料號",
                Tooltip = "供應商自己的商品編號"
            },
            
            // 備註
            new InteractiveColumnDefinition
            {
                Title = L["Label.Remarks"],
                PropertyName = nameof(ProductSupplier.Remarks),
                ColumnType = InteractiveColumnType.Input,
                Width = "200px",
                Placeholder = "採購注意事項"
            }
        };
    }

    /// <summary>
    /// 創建空的 ProductSupplier
    /// </summary>
    private ProductSupplier CreateEmptyItem()
    {
        return new ProductSupplier
        {
            SupplierId = SupplierId,
            ProductId = 0,
            Product = null,  //  重要：空行判斷依據（Product = null 表示空行）
            IsPreferred = false,
            Priority = 999,
            Status = EntityStatus.Active,
            SearchText = "",
            FilteredProducts = new List<Product>(),
            ShowProductDropdown = false,
            ProductSelectedIndex = -1
        };
    }

    /// <summary>
    /// 商品搜尋輸入變更事件
    /// </summary>
    private void OnProductSearchChanged(ProductSupplier productSupplier, string? searchValue)
    {
        productSupplier.SearchText = searchValue ?? "";
        
        if (string.IsNullOrWhiteSpace(searchValue))
        {
            productSupplier.FilteredProducts = new List<Product>();
            productSupplier.ShowProductDropdown = false;
        }
        else
        {
            var searchLower = searchValue.Trim().ToLower();
            productSupplier.FilteredProducts = AvailableProducts
                .Where(p => (p.Code?.ToLower().Contains(searchLower) ?? false) || 
                           (p.Name?.ToLower().Contains(searchLower) ?? false))
                .Take(20)
                .ToList();
            productSupplier.ShowProductDropdown = productSupplier.FilteredProducts.Any();
        }
        
        productSupplier.ProductSelectedIndex = -1;
        StateHasChanged();
    }

    /// <summary>
    /// 商品選擇事件
    /// </summary>
    private async Task OnProductSelected(ProductSupplier productSupplier, Product? selectedProduct)
    {
        if (selectedProduct == null) return;

        // 檢查是否已存在相同商品
        var existingBinding = Items.FirstOrDefault(ps => 
            ps != productSupplier && 
            ps.ProductId == selectedProduct.Id);

        if (existingBinding != null)
        {
            await NotificationService.ShowWarningAsync(string.Format(L["Supplier.AlreadyBound"], selectedProduct.Name));
            productSupplier.ProductId = 0;
            productSupplier.SearchText = "";
            productSupplier.FilteredProducts = new List<Product>();
            productSupplier.ShowProductDropdown = false;
            return;
        }

        productSupplier.ProductId = selectedProduct.Id;
        productSupplier.Product = selectedProduct;
        productSupplier.SearchText = $"[{selectedProduct.Code}] {selectedProduct.Name}";
        productSupplier.FilteredProducts = new List<Product>();
        productSupplier.ShowProductDropdown = false;
        
        StateHasChanged();
    }

    /// <summary>
    /// 商品輸入框獲得焦點
    /// </summary>
    private void OnProductFocus(ProductSupplier productSupplier)
    {
        if (productSupplier.ProductId > 0)
        {
            // 已選擇商品時，顯示所有商品供重新選擇
            productSupplier.FilteredProducts = AvailableProducts.Take(20).ToList();
            productSupplier.ShowProductDropdown = true;
        }
        StateHasChanged();
    }

    /// <summary>
    /// 商品輸入框失去焦點
    /// </summary>
    private void OnProductBlur(ProductSupplier productSupplier)
    {
        // 延遲關閉下拉選單，讓點擊事件能正常觸發
        Task.Delay(200).ContinueWith(_ =>
        {
            productSupplier.ShowProductDropdown = false;
            InvokeAsync(StateHasChanged);
        });
    }

    /// <summary>
    /// 刪除供應商品綁定
    /// </summary>
    private async Task HandleDeleteItem(ProductSupplier item)
    {
        Items.Remove(item);
        await ItemsChanged.InvokeAsync(Items);
        await OnItemDeleted.InvokeAsync(item);
        await InvokeAsync(StateHasChanged);
    }
    
    /// <summary>
    /// 清空所有供應商品明細
    /// </summary>
    private async Task ClearAllDetails()
    {
        //  關鍵：在清除前，先收集需要刪除的項目（有 Id 的項目需通知父組件以便從資料庫刪除）
        var itemsToDelete = Items.Where(item => item.Id > 0 && item.Product != null).ToList();
        
        var cleared = await ItemManagementHelper.ClearAllDetailsAsync(
            Items,
            JSRuntime,
            async () =>
            {
                //  通知父組件哪些項目需要從資料庫刪除
                foreach (var item in itemsToDelete)
                {
                    await OnItemDeleted.InvokeAsync(item);
                }
                
                await ItemsChanged.InvokeAsync(Items);
                tableComponent?.RefreshEmptyRow();
            },
            L["Supplier.ConfirmClearAll"]
        );
        
        if (cleared)
        {
            await NotificationService.ShowSuccessAsync(L["Supplier.ClearedAll"]);
        }
    }
}
