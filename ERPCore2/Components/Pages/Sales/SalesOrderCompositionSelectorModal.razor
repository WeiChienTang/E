@* 商品配方選擇對話框 - 用於選擇要使用的 BOM 配方或自定義模式（銷貨訂單版本） *@
@using ERPCore2.Components.Shared.UI.Button
@using ERPCore2.Data.Entities

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@GetModalTitle()"
                   Icon="bi bi-diagram-3"
                   HeaderColor="BaseModalComponent.HeaderVariant.Primary"
                   ShowFooter="false"
                   CloseOnBackdropClick="true"
                   CloseOnEscape="true"
                   Size="BaseModalComponent.ModalSize.Large"
                   BodyContent="@BodyContent" />

@code {
    // ===== 參數定義 =====
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public string ProductName { get; set; } = string.Empty;
    [Parameter] public List<ProductComposition> Compositions { get; set; } = new();
    [Parameter] public int? CurrentCustomerId { get; set; }
    [Parameter] public EventCallback<(int? compositionId, bool isCustomMode)> OnSelected { get; set; }

    // ===== 私有欄位 =====
    private string searchTerm = string.Empty;

    // ===== 計算屬性 =====
    private List<ProductComposition> FilteredCompositions
    {
        get
        {
            var filtered = Compositions.AsEnumerable();

            // 搜尋過濾
            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                filtered = filtered.Where(c =>
                    (c.Code?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (c.Specification?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (c.Customer?.CompanyName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (c.CompositionCategory?.Name?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
                );
            }

            // 排序：當前客戶 > 通用配方 > 其他 > 最新日期
            return filtered
                .OrderByDescending(c => c.CustomerId == CurrentCustomerId)
                .ThenByDescending(c => c.CustomerId == null)
                .ThenByDescending(c => c.CreatedAt)
                .ToList();
        }
    }

    // ===== 方法 =====
    private string GetModalTitle()
    {
        return string.IsNullOrEmpty(ProductName)
            ? "選擇 BOM 配方"
            : $"選擇 BOM 配方 - {ProductName}";
    }

    private async Task SelectComposition(int compositionId)
    {
        if (OnSelected.HasDelegate)
        {
            await OnSelected.InvokeAsync((compositionId, false));
        }
        await CloseModal();
    }

    private async Task SelectCustomMode()
    {
        if (OnSelected.HasDelegate)
        {
            await OnSelected.InvokeAsync((null, true));
        }
        await CloseModal();
    }

    private async Task CloseModal()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }

    private string GetCompositionDisplayInfo(ProductComposition composition)
    {
        var info = new List<string>();

        if (composition.Customer != null)
        {
            info.Add($"客戶: {composition.Customer.CompanyName}");
        }
        if (!string.IsNullOrEmpty(composition.Specification))
        {
            info.Add($"規格: {composition.Specification}");
        }
        if (composition.CompositionCategory != null)
        {
            info.Add($"類型: {composition.CompositionCategory.Name}");
        }

        return info.Any() ? string.Join(" | ", info) : "通用配方";
    }

    // ===== Body Content =====
    private RenderFragment BodyContent => __builder =>
    {
        <div class="container-fluid">
            @if (Compositions.Any())
            {
                <!-- 搜尋框 -->
                <div class="mb-3">
                    <input type="text"
                           class="form-control"
                           placeholder="搜尋配方編號、規格、客戶或類型..."
                           @bind="searchTerm"
                           @bind:event="oninput" />
                </div>

                @if (!FilteredCompositions.Any())
                {
                    <div class="alert alert-warning text-center">
                        <i class="bi bi-search me-2"></i>
                        找不到符合條件的配方
                    </div>
                }
                else
                {
                    <!-- 配方清單 -->
                    <div class="list-group mb-3" style="max-height: 400px; overflow-y: auto;">
                        @foreach (var composition in FilteredCompositions)
                        {
                            <button type="button"
                                    class="list-group-item list-group-item-action @(composition.CustomerId == CurrentCustomerId ? "list-group-item-info" : "")"
                                    @onclick="() => SelectComposition(composition.Id)">
                                <div class="d-flex w-100 justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">
                                            <i class="bi bi-diagram-3 me-2 text-primary"></i>
                                            [@composition.Code]
                                            @if (composition.CustomerId == CurrentCustomerId)
                                            {
                                                <span class="badge bg-info ms-2">當前客戶</span>
                                            }
                                        </h6>
                                        <p class="mb-1 text-muted small">
                                            @GetCompositionDisplayInfo(composition)
                                        </p>
                                        <small class="text-muted">
                                            組件數: @(composition.CompositionDetails?.Count ?? 0)
                                            <span class="ms-2">建立日期: @composition.CreatedAt.ToString("yyyy/MM/dd")</span>
                                        </small>
                                    </div>
                                    <div class="ms-3">
                                        <i class="bi bi-chevron-right text-muted"></i>
                                    </div>
                                </div>
                            </button>
                        }
                    </div>
                }
            }

            <!-- 自定義選項 -->
            <button type="button"
                    class="list-group-item list-group-item-action list-group-item-warning w-100"
                    style="border: 2px dashed #ffc107;"
                    @onclick="SelectCustomMode">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <i class="bi bi-stars me-2"></i>
                            自定義（手動選擇組件）
                        </h6>
                        <small class="text-muted">不使用既有配方，自行挑選組件並設定數量</small>
                    </div>
                    <div class="ms-3">
                        <i class="bi bi-chevron-right"></i>
                    </div>
                </div>
            </button>

            @if (!Compositions.Any())
            {
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle me-2"></i>
                    此商品尚未建立 BOM 配方，請選擇「自定義」模式手動建立組成。
                </div>
            }

            <!-- 取消按鈕 -->
            <div class="mt-3 text-end">
                <GenericButtonComponent Text="取消"
                                      Variant="ButtonVariant.Gray"
                                      Size="ButtonSize.Normal"
                                      OnClick="CloseModal" />
            </div>
        </div>
    };
}
