@inject IQuotationService QuotationService
@inject IQuotationDetailService QuotationDetailService
@inject ICustomerService CustomerService
@inject ICompanyService CompanyService
@inject IEmployeeService EmployeeService
@inject IProductService ProductService
@inject IUnitService UnitService
@inject INotificationService NotificationService
@inject IReportPrintConfigurationService ReportPrintConfigurationService
@inject ISalesOrderService SalesOrderService
@inject ISalesOrderDetailService SalesOrderDetailService
@inject ISystemParameterService SystemParameterService
@inject NavigationManager NavigationManager
@inject ActionButtonHelper ActionButtonHelper
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@using System.ComponentModel.DataAnnotations
@using System.Reflection

@using ERPCore2.Components.Shared.SubCollections

<GenericEditModalComponent TEntity="Quotation" 
                          TService="IQuotationService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          Id="@QuotationId"
                          Service="@QuotationService"
                          EntityName="報價單"
                          EntityNamePlural="報價單"
                          ModalTitle="@(QuotationId.HasValue ? "編輯報價單" : "新增報價單")"
                          Size="GenericEditModalComponent<Quotation, IQuotationService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@GetAutoCompletePrefillers()"
                          AutoCompleteCollections="@GetAutoCompleteCollections()"
                          AutoCompleteDisplayProperties="@GetAutoCompleteDisplayProperties()"
                          AutoCompleteValueProperties="@GetAutoCompleteValueProperties()"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadQuotationData"
                          AdditionalDataLoader="@LoadAdditionalDataAsync"
                          SaveHandler="@SaveQuotationWithDetails"
                          SaveSuccessMessage="@(QuotationId.HasValue ? "報價單更新成功" : "報價單新增成功")"
                          SaveFailureMessage="報價單儲存失敗"
                          RequiredPermission="Quotation.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          CustomModules="@GetCustomModules()"
                          CustomActionButtons="@CustomActionButtons"
                          FormHeaderContent="@WarningMessage"
                          ShowPrintButton="true"
                          OnPrint="@HandlePrint"
                          ShowApprovalSection="@ShouldShowApprovalSection()"
                          ApprovalPermission="Quotation.Approve"
                          OnApprove="@HandleQuotationApprove"
                          OnRejectWithReason="@HandleQuotationRejectWithReason">
</GenericEditModalComponent>

@* 客戶編輯 Modal *@
<CustomerEditModalComponent @ref="customerEditModal"
                           IsVisible="@customerModalManager.IsModalVisible"
                           IsVisibleChanged="@customerModalManager.HandleModalVisibilityChangedAsync"
                           CustomerId="@customerModalManager.SelectedEntityId"
                           OnCustomerSaved="@OnCustomerSavedWrapper"
                           OnCancel="@customerModalManager.HandleModalCancelAsync" />

@* 業務員編輯 Modal *@
<EmployeeEditModalComponent @ref="employeeEditModal"
                           IsVisible="@employeeModalManager.IsModalVisible"
                           IsVisibleChanged="@employeeModalManager.HandleModalVisibilityChangedAsync"
                           EmployeeId="@employeeModalManager.SelectedEntityId"
                           OnEmployeeSaved="@OnEmployeeSavedWrapper"
                           OnCancel="@employeeModalManager.HandleModalCancelAsync" />

@* 公司編輯 Modal *@
<CompanyEditModalComponent @ref="companyEditModal"
                          IsVisible="@companyModalManager.IsModalVisible"
                          IsVisibleChanged="@companyModalManager.HandleModalVisibilityChangedAsync"
                          CompanyId="@companyModalManager.SelectedEntityId"
                          OnCompanySaved="@OnCompanySavedWrapper"
                          OnCancel="@companyModalManager.HandleModalCancelAsync" />

@* 銷貨訂單編輯 Modal *@
<SalesOrderEditModalComponent @ref="salesOrderEditModal"
                             IsVisible="@showSalesOrderModal"
                             IsVisibleChanged="@((bool visible) => showSalesOrderModal = visible)"
                             SalesOrderId="@selectedSalesOrderId"
                             PrefilledCustomerId="@editModalComponent?.Entity?.CustomerId"
                             PrefilledQuotationId="@QuotationId"
                             OnSalesOrderSaved="@HandleSalesOrderSaved"
                             OnCancel="@(() => showSalesOrderModal = false)" />

@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? QuotationId { get; set; }
    [Parameter] public EventCallback<Quotation> OnQuotationSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<Quotation, IQuotationService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // 原始資料集合（用於 AutoComplete）
    private List<Customer> availableCustomers = new();
    private List<Company> availableCompanies = new();
    private List<Employee> availableEmployees = new();
    private List<Product> availableProducts = new();
    private List<Unit> availableUnits = new();
    
    // 報價單明細
    private List<QuotationDetail> quotationDetails = new();
    private QuotationTable<Quotation, QuotationDetail>? quotationDetailManager;
    
    // Modal 管理器
    private CustomerEditModalComponent? customerEditModal;
    private RelatedEntityModalManager<Customer> customerModalManager = default!;
    private CompanyEditModalComponent? companyEditModal;
    private RelatedEntityModalManager<Company> companyModalManager = default!;
    private EmployeeEditModalComponent? employeeEditModal;
    private RelatedEntityModalManager<Employee> employeeModalManager = default!;
    
    // ===== 相關單據 Modal =====
    private SalesOrderEditModalComponent? salesOrderEditModal;
    private bool showSalesOrderModal = false;
    private int? selectedSalesOrderId = null;
    
    // 下拉選單選項（向下相容）
    private List<Customer> customers = new();
    private List<Employee> employees = new();
    private List<SelectOption> customerOptions = new();
    private List<SelectOption> employeeOptions = new();
    
    // ===== 審核開關狀態 =====
    private bool isApprovalEnabled = true; // 是否啟用報價單審核功能（從系統參數載入）
    
    // ===== 鎖定狀態 =====
    private bool isConvertedToSalesOrder = false; // 是否已轉為銷貨訂單（已轉單則鎖定主檔欄位）

    // ===== 必要方法 =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 初始化 Modal 管理器
            InitializeCustomerModalManager();
            InitializeCompanyModalManager();
            InitializeEmployeeModalManager();
            
            // 載入系統參數（審核開關）
            await LoadSystemParametersAsync();
            
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化報價單編輯組件時發生錯誤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible)
        {
            // 打開時,如果是新增模式,重置鎖定狀態
            if (!QuotationId.HasValue)
            {
                isConvertedToSalesOrder = false;
            }
            
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
        }
    }

    /// <summary>
    /// 初始化客戶 Modal 管理器
    /// </summary>
    private void InitializeCustomerModalManager()
    {
        customerModalManager = RelatedEntityModalManagerHelper.CreateStandardManager(
            new StandardModalManagerConfig<Quotation, Customer, IQuotationService>
            {
                NotificationService = NotificationService,
                EntityDisplayName = "客戶",
                PropertyName = nameof(Quotation.CustomerId),
                GetEditModalComponent = () => editModalComponent,
                ReloadDataCallback = LoadAdditionalDataAsync,
                StateChangedCallback = StateHasChanged,
                AutoSelectAction = (entity, customerId) =>
                {
                    if (entity != null)
                    {
                        entity.CustomerId = customerId;
                    }
                },
                InitializeFormFieldsCallback = InitializeFormFieldsAsync,
                RefreshAutoCompleteFields = true  // 刷新 Quotation EditModal 的 Customer AutoComplete
            });
    }

    /// <summary>
    /// 初始化公司 Modal 管理器
    /// </summary>
    private void InitializeCompanyModalManager()
    {
        companyModalManager = RelatedEntityModalManagerHelper.CreateStandardManager(
            new StandardModalManagerConfig<Quotation, Company, IQuotationService>
            {
                NotificationService = NotificationService,
                EntityDisplayName = "公司",
                PropertyName = nameof(Quotation.CompanyId),
                GetEditModalComponent = () => editModalComponent,
                ReloadDataCallback = LoadAdditionalDataAsync,
                StateChangedCallback = StateHasChanged,
                AutoSelectAction = (entity, companyId) =>
                {
                    if (entity != null)
                    {
                        entity.CompanyId = companyId;
                    }
                },
                InitializeFormFieldsCallback = InitializeFormFieldsAsync,
                RefreshAutoCompleteFields = true  // 刷新 Quotation EditModal 的 Company AutoComplete
            });
    }

    /// <summary>
    /// 初始化業務員 Modal 管理器
    /// </summary>
    private void InitializeEmployeeModalManager()
    {
        employeeModalManager = RelatedEntityModalManagerHelper.CreateStandardManager(
            new StandardModalManagerConfig<Quotation, Employee, IQuotationService>
            {
                NotificationService = NotificationService,
                EntityDisplayName = "業務人員",
                PropertyName = nameof(Quotation.EmployeeId),
                GetEditModalComponent = () => editModalComponent,
                ReloadDataCallback = LoadAdditionalDataAsync,
                StateChangedCallback = StateHasChanged,
                AutoSelectAction = (entity, employeeId) =>
                {
                    if (entity != null)
                    {
                        entity.EmployeeId = employeeId;
                    }
                },
                InitializeFormFieldsCallback = InitializeFormFieldsAsync,
                RefreshAutoCompleteFields = true  // 刷新 Quotation EditModal 的 Employee AutoComplete
            });
    }

    private async Task HandleSaveSuccess()
    {
        if (editModalComponent?.Entity != null)
        {
            await OnQuotationSaved.InvokeAsync(editModalComponent.Entity);
        }
        await CloseModal();
    }

    private async Task HandleCancel()
    {
        await OnCancel.InvokeAsync();
        await CloseModal();
    }

    private async Task CloseModal()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }

    private async Task<Quotation?> LoadQuotationData()
    {
        try
        {
            if (!QuotationId.HasValue)
            {
                // 新增模式
                var newQuotation = new Quotation
                {
                    QuotationNumber = await GenerateQuotationNumberAsync(),
                    QuotationDate = DateTime.Today,
                    Status = EntityStatus.Active
                };

                // 初始化空的子集合
                quotationDetails = new List<QuotationDetail>();
                
                // 新增模式時,重置鎖定狀態為 false
                isConvertedToSalesOrder = false;

                return newQuotation;
            }

            // 編輯模式
            var quotation = await QuotationService.GetWithDetailsAsync(QuotationId.Value);
            
            if (quotation != null)
            {
                // 載入報價單明細
                quotationDetails = quotation.QuotationDetails?.ToList() ?? new List<QuotationDetail>();
                
                // 檢查是否已轉為銷貨訂單
                isConvertedToSalesOrder = quotation.ConvertedToSalesOrderId.HasValue;
                
                // 在實體載入後重新初始化表單欄位以反映正確的唯讀狀態
                await Task.Delay(10); // 短暫延遲確保實體已設定
                _ = Task.Run(async () =>
                {
                    await InvokeAsync(async () =>
                    {
                        await InitializeFormFieldsAsync();
                        StateHasChanged();
                    });
                });
            }
            else
            {
                quotationDetails = new List<QuotationDetail>();
            }

            return quotation;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入報價單資料時發生錯誤：{ex.Message}");
            return null;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // 載入客戶列表
            availableCustomers = await CustomerService.GetAllAsync();
            customers = availableCustomers;
            customerOptions = customers.Select(c => new SelectOption 
            { 
                Text = c.CompanyName ?? "", 
                Value = c.Id.ToString() 
            }).ToList();
            
            // 載入公司列表
            availableCompanies = await CompanyService.GetAllAsync();
            
            // 載入業務人員列表
            availableEmployees = await EmployeeService.GetAllAsync();
            employees = availableEmployees;
            employeeOptions = employees.Select(e => new SelectOption 
            { 
                Text = e.Name ?? "", 
                Value = e.Id.ToString() 
            }).ToList();
            
            // 載入產品列表（用於明細）
            availableProducts = await ProductService.GetAllAsync();
            
            // 載入單位列表（用於明細）
            availableUnits = await UnitService.GetAllAsync();
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("載入報價單編輯相關資料時發生錯誤");
            availableCustomers = new List<Customer>();
            availableCompanies = new List<Company>();
            availableEmployees = new List<Employee>();
            availableProducts = new List<Product>();
            availableUnits = new List<Unit>();
            customers = new List<Customer>();
            employees = new List<Employee>();
            customerOptions = new List<SelectOption>();
            employeeOptions = new List<SelectOption>();
        }
    }

    /// <summary>
    /// 載入系統參數（審核開關）
    /// </summary>
    private async Task LoadSystemParametersAsync()
    {
        try
        {
            var systemParams = await SystemParameterService.GetSystemParameterAsync();
            if (systemParams != null)
            {
                isApprovalEnabled = systemParams.EnableQuotationApproval;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSystemParametersAsync), GetType());
            // 預設啟用審核
            isApprovalEnabled = false;
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            // 使用 ApprovalConfigHelper 統一判斷是否鎖定欄位
            // 報價單的鎖定條件：(審核通過) 或 (已轉為銷貨訂單)
            var shouldLock = ApprovalConfigHelper.ShouldLockFieldByApproval(
                isApprovalEnabled,
                editModalComponent?.Entity?.IsApproved ?? false,
                isConvertedToSalesOrder  // 使用已轉單狀態作為額外的鎖定條件
            );
            
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(Quotation.QuotationNumber),
                    Label = "報價單號",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入報價單號",
                    IsRequired = true,
                    MaxLength = 30,
                    HelpText = "報價單的唯一識別編號，新增時系統會自動產生，也可手動修改",
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(Quotation.CustomerId),
                    Label = "客戶",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇客戶",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "輸入客戶名稱進行搜尋，或直接選擇",
                    ActionButtons = shouldLock ? new List<FieldActionButton>() : await GetCustomerActionButtonsAsync(),
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(Quotation.CompanyId),
                    Label = "公司",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇公司",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "輸入公司名稱進行搜尋，或直接選擇",
                    ActionButtons = shouldLock ? new List<FieldActionButton>() : await GetCompanyActionButtonsAsync(),
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(Quotation.EmployeeId),
                    Label = "業務人員",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇業務人員",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "輸入業務人員姓名進行搜尋，或直接選擇",
                    ActionButtons = shouldLock ? new List<FieldActionButton>() : await GetEmployeeActionButtonsAsync(),
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(Quotation.QuotationDate),
                    Label = "報價日期",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "報價單的建立日期",
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(Quotation.PaymentTerms),
                    Label = "付款條件",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入付款條件",
                    IsRequired = false,
                    MaxLength = 100,
                    HelpText = "例如：貨到付款、月結30天等",
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(Quotation.DeliveryTerms),
                    Label = "交貨條件",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入交貨條件",
                    IsRequired = false,
                    MaxLength = 100,
                    HelpText = "例如：工廠交貨、送貨到府等",
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(Quotation.TotalAmount),
                    Label = "報價總金額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true, // 總金額欄位始終為唯讀
                    HelpText = "系統根據明細自動計算"
                },
                new()
                {
                    PropertyName = nameof(Quotation.DiscountAmount),
                    Label = "折扣金額",
                    FieldType = FormFieldType.Number,
                    Placeholder = "請輸入折扣金額",
                    IsRequired = false,
                    HelpText = "整張報價單的額外折扣金額",
                    IsReadOnly = shouldLock
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(Quotation.ProjectName),
                    Label = "工程名稱",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入工程名稱",
                    IsRequired = false,
                    MaxLength = 20,
                    HelpText = "報價所屬的工程名稱",
                    IsReadOnly = shouldLock
                },

                FormFieldConfigurationHelper.CreateRemarksField<Quotation>(label: "報價說明") // 備註永遠可編輯（不受轉單影響）
            };

            formSections = new Dictionary<string, string>
            {
                { nameof(Quotation.QuotationNumber), "基本資訊" },
                { nameof(Quotation.CustomerId), "基本資訊" },
                { nameof(Quotation.CompanyId), "基本資訊" },
                { nameof(Quotation.EmployeeId), "基本資訊" },
                { nameof(Quotation.ProjectName), "基本資訊" },
                { nameof(Quotation.QuotationDate), "基本資訊" },
                { nameof(Quotation.PaymentTerms), "交易條件" },
                { nameof(Quotation.DeliveryTerms), "交易條件" },
                { nameof(Quotation.TotalAmount), "金額資訊" },
                { nameof(Quotation.DiscountAmount), "金額資訊" },
                { "Remarks", "其他資訊" }
            };
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化表單欄位時發生錯誤");
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }

    /// <summary>
    /// 驗證報價單明細 - 在儲存主檔之前執行
    /// </summary>
    private async Task<bool> ValidateQuotationDetailsAsync(Quotation quotation)
    {
        try
        {
            if (quotationDetailManager != null)
            {
                return await quotationDetailManager.ValidateAsync();
            }
            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ValidateQuotationDetailsAsync), GetType());
            return false;
        }
    }

    /// <summary>
    /// 自訂儲存邏輯 - 同時儲存主檔和明細
    /// </summary>
    private async Task<bool> SaveQuotationWithDetails(Quotation quotation)
    {
        try
        {
            if (quotation == null)
            {
                await NotificationService.ShowErrorAsync("沒有要儲存的報價單資料");
                return false;
            }

            // 檢查公司欄位是否有資料
            if (quotation.CompanyId <= 0)
            {
                await NotificationService.ShowWarningAsync("請選擇公司後再進行儲存");
                return false;
            }

            // 先執行明細驗證
            if (!await ValidateQuotationDetailsAsync(quotation))
            {
                return false;
            }

            // 檢查是否已轉為銷貨訂單（已轉單則不能儲存主檔欄位，只能修改備註）
            if (isConvertedToSalesOrder)
            {
                await NotificationService.ShowWarningAsync("此報價單已轉為銷貨訂單，無法修改主檔資料");
                return false;
            }

            // 更新總金額
            quotation.TotalAmount = quotationDetails.Sum(d => d.SubtotalAmount);

            // 儲存主檔
            ServiceResult<Quotation> result;
            if (QuotationId.HasValue)
            {
                result = await QuotationService.UpdateAsync(quotation);
            }
            else
            {
                result = await QuotationService.CreateAsync(quotation);
            }

            if (!result.IsSuccess || result.Data == null)
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "儲存報價單失敗");
                return false;
            }

            // 儲存明細
            await SaveQuotationDetails(result.Data.Id);

            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveQuotationWithDetails), GetType(), 
                additionalData: "儲存報價單和明細失敗");
            await NotificationService.ShowErrorAsync($"儲存時發生錯誤：{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// 儲存報價單明細
    /// </summary>
    private async Task SaveQuotationDetails(int quotationId)
    {
        try
        {
            // 設定主檔ID
            foreach (var detail in quotationDetails)
            {
                detail.QuotationId = quotationId;
                if (detail.Id == 0)
                {
                    detail.Status = EntityStatus.Active;
                    detail.CreatedAt = DateTime.Now;
                }
                else
                {
                    detail.UpdatedAt = DateTime.Now;
                }
            }

            // 先獲取現有的明細
            var existingQuotation = await QuotationService.GetWithDetailsAsync(quotationId);
            var existingDetails = existingQuotation?.QuotationDetails?.ToList() ?? new List<QuotationDetail>();
            
            // 處理新增和更新的明細
            foreach (var detail in quotationDetails.Where(d => d.ProductId > 0))
            {
                if (detail.Id == 0)
                {
                    // 新增明細
                    await QuotationDetailService.CreateAsync(detail);
                }
                else
                {
                    // 更新明細
                    await QuotationDetailService.UpdateAsync(detail);
                }
            }

            // 處理刪除的明細（現有的但不在當前列表中的）
            var currentDetailIds = quotationDetails.Where(d => d.Id > 0).Select(d => d.Id).ToList();
            var detailsToDelete = existingDetails.Where(e => !currentDetailIds.Contains(e.Id)).ToList();
            
            foreach (var detailToDelete in detailsToDelete)
            {
                await QuotationDetailService.DeleteAsync(detailToDelete.Id);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveQuotationDetails), GetType(), 
                additionalData: $"儲存報價單明細失敗 - QuotationId: {quotationId}");
            throw; // 重新拋出例外，讓上層處理
        }
    }

    /// <summary>
    /// 配置自訂模組
    /// </summary>
    private List<GenericEditModalComponent<Quotation, IQuotationService>.CustomModule> GetCustomModules()
    {
        try
        {
            return new List<GenericEditModalComponent<Quotation, IQuotationService>.CustomModule>
            {
                new()
                {
                    Title = "",
                    Content = CreateQuotationDetailManagerContent()
                }
            };
        }
        catch
        {
            return new List<GenericEditModalComponent<Quotation, IQuotationService>.CustomModule>();
        }
    }

    /// <summary>
    /// 創建報價單明細管理器內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateQuotationDetailManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null)
            {
                // 檢查是否有可用的商品資料
                @if (availableProducts != null && availableProducts.Any())
                {
                    // 檢查是否已選擇客戶
                    @if (editModalComponent.Entity.CustomerId > 0)
                    {
                        <QuotationTable @ref="quotationDetailManager"
                                                TMainEntity="Quotation"
                                                TDetailEntity="QuotationDetail"
                                                MainEntity="@editModalComponent?.Entity"
                                                ExistingDetails="@quotationDetails"
                                                OnDetailsChanged="@HandleQuotationDetailsChanged"
                                                OnDeletedDetailsChanged="@HandleDeletedDetailsChanged"
                                                Products="@availableProducts"
                                                Units="@availableUnits"
                                                SelectedCustomerId="@editModalComponent?.Entity?.CustomerId"
                                                MainEntityIdPropertyName="@nameof(QuotationDetail.QuotationId)"
                                                QuantityPropertyName="@nameof(QuotationDetail.Quantity)"
                                                UnitPricePropertyName="@nameof(QuotationDetail.UnitPrice)"
                                                DiscountPercentagePropertyName="@nameof(QuotationDetail.DiscountPercentage)"
                                                RemarksPropertyName="@nameof(BaseEntity.Remarks)"
                                                UnitIdPropertyName="@nameof(QuotationDetail.UnitId)"
                                                IsReadOnly="false"
                                                OnOpenRelatedDocument="@HandleOpenRelatedDocument"
                                                Title="報價明細"
                                                EmptyMessage="尚未新增報價商品" />
                    }
                    else
                    {
                        <div class="alert alert-info text-center" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            請先選擇客戶後再進行報價明細管理
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-warning text-center" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        無可用的商品資料，請聯繫系統管理員
                    </div>
                }
            }
        }
        catch
        {
            <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                載入報價明細管理器時發生錯誤
            </div>
        }
    };

    /// <summary>
    /// 處理報價單明細變更 - 自動計算總金額
    /// </summary>
    private async Task HandleQuotationDetailsChanged(List<QuotationDetail> details)
    {
        try
        {
            quotationDetails = details;
            
            if (editModalComponent?.Entity != null)
            {
                // 計算總金額
                editModalComponent.Entity.TotalAmount = details.Sum(d => d.SubtotalAmount);
                
                // 更新主檔的 QuotationDetails 集合
                editModalComponent.Entity.QuotationDetails = details;
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleQuotationDetailsChanged), GetType());
        }
    }

    /// <summary>
    /// 處理已刪除的報價單明細ID
    /// </summary>
    private async Task HandleDeletedDetailsChanged(List<int> deletedDetailIds)
    {
        try
        {
            if (deletedDetailIds?.Any() == true)
            {
                foreach (var detailId in deletedDetailIds)
                {
                    await QuotationDetailService.DeleteAsync(detailId);
                }
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDeletedDetailsChanged), GetType());
        }
    }

    /// <summary>
    /// 取得枚舉的顯示名稱
    /// </summary>
    private static string GetEnumDisplayName(Enum enumValue)
    {
        var displayAttribute = enumValue.GetType()
            .GetField(enumValue.ToString())?
            .GetCustomAttribute<DisplayAttribute>();
        
        return displayAttribute?.Name ?? enumValue.ToString();
    }

    /// <summary>
    /// 配置 AutoComplete 預填器
    /// </summary>
    private Dictionary<string, Func<string, Dictionary<string, object?>>> GetAutoCompletePrefillers()
    {
        return new Dictionary<string, Func<string, Dictionary<string, object?>>>
        {
            {
                nameof(Quotation.CustomerId),
                searchTerm => new Dictionary<string, object?>
                {
                    ["CompanyName"] = searchTerm,
                    ["Status"] = 1 // EntityStatus.Active
                }
            },
            {
                nameof(Quotation.CompanyId),
                searchTerm => new Dictionary<string, object?>
                {
                    ["CompanyName"] = searchTerm,
                    ["Status"] = 1 // EntityStatus.Active
                }
            },
            {
                nameof(Quotation.EmployeeId),
                searchTerm => new Dictionary<string, object?>
                {
                    ["Name"] = searchTerm,
                    ["Status"] = 1 // EntityStatus.Active
                }
            }
        };
    }

    /// <summary>
    /// 配置 AutoComplete 資料集合
    /// </summary>
    private Dictionary<string, IEnumerable<object>> GetAutoCompleteCollections()
    {
        return new Dictionary<string, IEnumerable<object>>
        {
            { nameof(Quotation.CustomerId), availableCustomers.Cast<object>() },
            { nameof(Quotation.CompanyId), availableCompanies.Cast<object>() },
            { nameof(Quotation.EmployeeId), availableEmployees.Cast<object>() }
        };
    }

    /// <summary>
    /// 配置 AutoComplete 顯示屬性
    /// </summary>
    private Dictionary<string, string> GetAutoCompleteDisplayProperties()
    {
        return new Dictionary<string, string>
        {
            { nameof(Quotation.CustomerId), "CompanyName" },
            { nameof(Quotation.CompanyId), "CompanyName" },
            { nameof(Quotation.EmployeeId), "Name" }
        };
    }

    /// <summary>
    /// 配置 AutoComplete 值屬性
    /// </summary>
    private Dictionary<string, string> GetAutoCompleteValueProperties()
    {
        return new Dictionary<string, string>
        {
            { nameof(Quotation.CustomerId), "Id" },
            { nameof(Quotation.CompanyId), "Id" },
            { nameof(Quotation.EmployeeId), "Id" }
        };
    }

    /// <summary>
    /// 配置 Modal 管理器
    /// </summary>
    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(Quotation.CustomerId), customerModalManager },
            { nameof(Quotation.CompanyId), companyModalManager },
            { nameof(Quotation.EmployeeId), employeeModalManager }
        };
    }

    /// <summary>
    /// 包裝客戶儲存事件以符合原有介面
    /// </summary>
    private async Task OnCustomerSavedWrapper(Customer savedCustomer)
    {
        await customerModalManager.HandleEntitySavedAsync(savedCustomer, shouldAutoSelect: true);
    }

    /// <summary>
    /// 包裝公司儲存事件以符合原有介面
    /// </summary>
    private async Task OnCompanySavedWrapper(Company savedCompany)
    {
        await companyModalManager.HandleEntitySavedAsync(savedCompany, shouldAutoSelect: true);
    }

    /// <summary>
    /// 包裝業務員儲存事件以符合原有介面
    /// </summary>
    private async Task OnEmployeeSavedWrapper(Employee savedEmployee)
    {
        await employeeModalManager.HandleEntitySavedAsync(savedEmployee, shouldAutoSelect: true);
    }

    /// <summary>
    /// 使用統一 Helper 產生客戶操作按鈕
    /// </summary>
    private async Task<List<FieldActionButton>> GetCustomerActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            customerModalManager, 
            nameof(Quotation.CustomerId)
        );
    }

    /// <summary>
    /// 使用統一 Helper 產生公司操作按鈕
    /// </summary>
    private async Task<List<FieldActionButton>> GetCompanyActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            companyModalManager, 
            nameof(Quotation.CompanyId)
        );
    }

    /// <summary>
    /// 使用統一 Helper 產生業務員操作按鈕
    /// </summary>
    private async Task<List<FieldActionButton>> GetEmployeeActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            employeeModalManager, 
            nameof(Quotation.EmployeeId)
        );
    }

    /// <summary>
    /// 處理欄位值變更事件 - 使用統一 Helper
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // 使用統一 Helper 處理客戶欄位變更
            if (fieldChange.PropertyName == nameof(Quotation.CustomerId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    customerModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
            }
            // 使用統一 Helper 處理公司欄位變更
            else if (fieldChange.PropertyName == nameof(Quotation.CompanyId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    companyModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
            }
            // 使用統一 Helper 處理業務員欄位變更
            else if (fieldChange.PropertyName == nameof(Quotation.EmployeeId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    employeeModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
            }
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("欄位變更處理時發生錯誤");
        }
    }

    /// <summary>
    /// 生成報價單號
    /// </summary>
    private async Task<string> GenerateQuotationNumberAsync()
    {
        return await CodeGenerationHelper.GenerateEntityCodeAsync(
            QuotationService,
            "QT",
            (service, code, excludeId) => service.IsQuotationNumberExistsAsync(code, excludeId)
        );
    }

    /// <summary>
    /// 取得警告訊息（顯示在表單欄位上方）- 作為屬性以確保正確的渲染時機
    /// 當報價單已審核通過時，顯示鎖定警告訊息
    /// </summary>
    private RenderFragment? WarningMessage
    {
        get
        {
            // 先計算警告訊息（避免在 RenderFragment 中出錯）
            string? approvalWarning = null;
            
            try
            {
                if (editModalComponent?.Entity != null)
                {
                    approvalWarning = ApprovalConfigHelper.GetApprovalWarningMessage(
                        isApprovalEnabled,
                        editModalComponent.Entity.IsApproved,
                        "報價單"
                    );
                }
            }
            catch
            {
                // 如果出錯，就不顯示警告
                approvalWarning = null;
            }
            
            return __builder =>
            {
                @if (!string.IsNullOrEmpty(approvalWarning))
                {
                    <div class="alert alert-warning mb-2 py-2" role="alert">
                        <i class="fas fa-lock me-2"></i>@approvalWarning
                    </div>
                }
            };
        }
    }
    
    /// <summary>
    /// 取得自訂操作按鈕（顯示在 Modal 頂部左側）- 作為屬性以確保正確的渲染時機
    /// </summary>
    private RenderFragment? CustomActionButtons
    {
        get
        {
            // 修改邏輯：轉銷貨按鈕永遠顯示（只要報價單已儲存）
            // 明細是否可轉由 SalesOrderTable 組件處理（根據審核狀態和已轉數量）
            bool shouldShowButton = false;
            
            try
            {
                if (editModalComponent?.Entity != null && 
                    QuotationId.HasValue && 
                    QuotationId.Value > 0)
                {
                    shouldShowButton = true;
                }
            }
            catch
            {
                shouldShowButton = false;
            }
            
            return __builder =>
            {
                @* 轉銷貨訂單按鈕 - 報價單已儲存即可顯示 *@
                @if (shouldShowButton)
                {
                    <GenericButtonComponent Text="轉銷貨訂單" 
                                          Variant="ButtonVariant.Success" 
                                          Size="ButtonSize.Small"
                                          CssClass="me-2"
                                          OnClick="HandleCreateSalesOrderFromQuotation" />
                }
            };
        }
    }

    /// <summary>
    /// 從報價單轉銷貨訂單
    /// </summary>
    private async Task HandleCreateSalesOrderFromQuotation()
    {
        try
        {
            if (!QuotationId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("無法轉銷貨訂單：報價單資料不存在");
                return;
            }
            
            // 移除審核檢查：改為在載入明細時根據審核開關過濾
            // 如果啟用審核，只會載入已審核的報價單明細
            // 如果未啟用審核，載入所有報價單明細
            
            // 檢查是否有客戶資料
            if (editModalComponent.Entity.CustomerId <= 0)
            {
                await NotificationService.ShowWarningAsync("報價單缺少客戶資訊，無法轉銷貨訂單");
                return;
            }

            // 檢查是否還有未完成的明細（還需要轉單的商品）
            if (!quotationDetails.Any())
            {
                await NotificationService.ShowWarningAsync("報價單沒有明細資料，無法轉銷貨訂單");
                return;
            }
            
            // 檢查是否所有明細都已完成轉單（已轉數量 >= 報價數量）
            var hasIncompleteDetails = quotationDetails.Any(detail => 
                detail.ConvertedQuantity < detail.Quantity
            );
            
            if (!hasIncompleteDetails)
            {
                await NotificationService.ShowWarningAsync("報價單所有明細皆已轉為銷貨訂單，無需再轉單");
                return;
            }

            // 使用公開方法打開銷貨訂單 Modal 並自動載入報價單明細
            if (salesOrderEditModal != null)
            {
                await salesOrderEditModal.ShowAddModalWithPrefilledQuotation(
                    editModalComponent.Entity.CustomerId,
                    QuotationId.Value
                );
            }
            else
            {
                await NotificationService.ShowWarningAsync("銷貨訂單組件未初始化，請重新整理頁面");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCreateSalesOrderFromQuotation), GetType(),
                additionalData: new { QuotationId = QuotationId });
            await NotificationService.ShowErrorAsync("轉銷貨訂單時發生錯誤");
        }
    }

    /// <summary>
    /// 處理銷貨訂單儲存後的事件
    /// </summary>
    private async Task HandleSalesOrderSaved(SalesOrder savedSalesOrder)
    {
        try
        {
            showSalesOrderModal = false;
            selectedSalesOrderId = null;

            // 更新報價單的轉單狀態
            if (QuotationId.HasValue && editModalComponent?.Entity != null)
            {
                editModalComponent.Entity.ConvertedToSalesOrderId = savedSalesOrder.Id;
                
                var updateResult = await QuotationService.UpdateAsync(editModalComponent.Entity);
                if (!updateResult.IsSuccess)
                {
                    await NotificationService.ShowWarningAsync($"報價單轉單狀態更新失敗：{updateResult.ErrorMessage}");
                }
                
                // 重新載入以取得完整的關聯資料
                var updatedQuotation = await QuotationService.GetWithDetailsAsync(QuotationId.Value);
                if (updatedQuotation != null)
                {
                    editModalComponent.Entity.SalesOrder = updatedQuotation.SalesOrder;
                }
                
                // 更新鎖定狀態並重新初始化表單欄位
                isConvertedToSalesOrder = true;
                await InitializeFormFieldsAsync();
            }

            await NotificationService.ShowSuccessAsync($"已成功從報價單轉為銷貨訂單（訂單編號：{savedSalesOrder.SalesOrderNumber}）");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSalesOrderSaved), GetType());
        }
    }

    /// <summary>
    /// 處理開啟相關單據的事件（從明細表格的查看按鈕觸發）
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            switch (args.type)
            {
                case RelatedDocumentType.SalesOrder:
                    // 開啟銷貨訂單 Modal（以唯讀模式）
                    selectedSalesOrderId = args.id;
                    showSalesOrderModal = true;
                    StateHasChanged();
                    break;
                    
                default:
                    await NotificationService.ShowWarningAsync($"不支援的單據類型：{args.type}");
                    break;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleOpenRelatedDocument), GetType(), 
                additionalData: $"開啟相關單據失敗 - Type: {args.type}, Id: {args.id}");
            await NotificationService.ShowErrorAsync("開啟單據時發生錯誤");
        }
    }

    /// <summary>
    /// 生成銷貨訂單號
    /// </summary>
    private async Task<string> GenerateSalesOrderNumberAsync()
    {
        return await CodeGenerationHelper.GenerateEntityCodeAsync(
            SalesOrderService,
            "SO",
            (service, code, excludeId) => service.IsSalesOrderNumberExistsAsync(code, excludeId)
        );
    }
    
    // ===== 審核相關方法 =====
    
    /// <summary>
    /// 判斷是否應該顯示審核區域
    /// </summary>
    private bool ShouldShowApprovalSection()
    {
        return isApprovalEnabled && QuotationId.HasValue;
    }
    
    /// <summary>
    /// 處理報價單審核通過
    /// </summary>
    private async Task<bool> HandleQuotationApprove()
    {
        try
        {
            if (!QuotationId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowErrorAsync("找不到報價單資料");
                return false;
            }

            var quotation = editModalComponent.Entity;

            // 檢查是否已經審核
            if (quotation.IsApproved)
            {
                await NotificationService.ShowWarningAsync("此報價單已經審核通過");
                return false;
            }

            // 驗證明細
            if (!quotationDetails.Any())
            {
                await NotificationService.ShowWarningAsync("報價單沒有明細資料，無法審核");
                return false;
            }

            // 取得當前使用者ID
            var currentUserId = await GetCurrentUserIdAsync();
            if (!currentUserId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法取得當前使用者資訊");
                return false;
            }

            // 更新審核狀態
            quotation.IsApproved = true;
            quotation.ApprovedBy = currentUserId.Value;
            quotation.ApprovedAt = DateTime.Now;
            quotation.RejectReason = null; // 清除駁回原因

            // 儲存
            var result = await QuotationService.UpdateAsync(quotation);
            if (!result.IsSuccess)
            {
                await NotificationService.ShowErrorAsync($"審核失敗：{result.ErrorMessage}");
                return false;
            }

            await NotificationService.ShowSuccessAsync("報價單審核通過");
            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleQuotationApprove), GetType());
            await NotificationService.ShowErrorAsync("審核處理時發生錯誤");
            return false;
        }
    }
    
    /// <summary>
    /// 處理報價單審核駁回（帶駁回原因）
    /// </summary>
    private async Task<bool> HandleQuotationRejectWithReason(string rejectReason)
    {
        try
        {
            if (!QuotationId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowErrorAsync("找不到報價單資料");
                return false;
            }

            if (string.IsNullOrWhiteSpace(rejectReason))
            {
                await NotificationService.ShowWarningAsync("請輸入駁回原因");
                return false;
            }

            var quotation = editModalComponent.Entity;

            // 檢查是否已經駁回
            if (!quotation.IsApproved && !string.IsNullOrEmpty(quotation.RejectReason))
            {
                await NotificationService.ShowWarningAsync("此報價單已經被駁回");
                return false;
            }

            // 取得當前使用者ID
            var currentUserId = await GetCurrentUserIdAsync();
            if (!currentUserId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法取得當前使用者資訊");
                return false;
            }

            // 更新駁回狀態
            quotation.IsApproved = false;
            quotation.ApprovedBy = currentUserId.Value;
            quotation.ApprovedAt = DateTime.Now;
            quotation.RejectReason = rejectReason;

            // 儲存
            var result = await QuotationService.UpdateAsync(quotation);
            if (!result.IsSuccess)
            {
                await NotificationService.ShowErrorAsync($"駁回失敗：{result.ErrorMessage}");
                return false;
            }

            await NotificationService.ShowSuccessAsync($"報價單已駁回：{rejectReason}");
            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleQuotationRejectWithReason), GetType());
            await NotificationService.ShowErrorAsync("駁回處理時發生錯誤");
            return false;
        }
    }
    
    /// <summary>
    /// 取得當前使用者ID
    /// </summary>
    private async Task<int?> GetCurrentUserIdAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            if (user?.Identity?.IsAuthenticated == true)
            {
                var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
                if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
                {
                    return userId;
                }
            }
            
            return null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetCurrentUserIdAsync), GetType());
            return null;
        }
    }

    /// <summary>
    /// 處理列印事件
    /// </summary>
    private async Task HandlePrint()
    {
        try
        {
            // 使用通用 Helper 進行完整驗證（實體、ID）
            // 報價單不需要核准即可列印
            var (isValid, errorMessage) = ReportPrintHelper.ValidateForPrint(
                entity: editModalComponent?.Entity,
                entityId: QuotationId,
                isApproved: true, // 報價單不需審核
                entityName: "報價單",
                requireApproval: false
            );
            
            if (!isValid)
            {
                await NotificationService.ShowWarningAsync(errorMessage);
                return;
            }
            
            // 直接執行列印，使用預設設定
            await HandleDirectPrint(null);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePrint), GetType(), 
                additionalData: $"報價單列印處理失敗 - ID: {QuotationId}");
            await NotificationService.ShowErrorAsync("列印處理時發生錯誤");
        }
    }

    /// <summary>
    /// 直接執行列印 - 可以使用指定的列印配置或預設配置
    /// </summary>
    private async Task HandleDirectPrint(ReportPrintConfiguration? printConfig)
    {
        try
        {
            if (!QuotationId.HasValue)
            {
                await NotificationService.ShowWarningAsync("請先儲存報價單後再進行列印");
                return;
            }

            // 驗證列印配置
            var (isValid, errorMessage) = ReportPrintHelper.ValidateConfiguration(printConfig);
            if (!isValid)
            {
                await NotificationService.ShowWarningAsync(errorMessage);
                return;
            }

            // 使用通用 Helper 建立列印 URL（新版路由）
            var printUrl = ReportPrintHelper.BuildPrintUrl(
                baseUrl: NavigationManager.BaseUri,
                reportType: "sales-report/quotation",
                documentId: QuotationId.Value,
                configuration: printConfig,
                autoprint: true
            );

            // 使用通用 Helper 執行列印（隱藏 iframe 方式）
            var success = await ReportPrintHelper.ExecutePrintWithHiddenIframeAsync(
                printUrl: printUrl,
                jsRuntime: JSRuntime,
                iframeId: "printFrame"
            );
            
            if (success)
            {
                // 可選：顯示成功訊息
                // await NotificationService.ShowSuccessAsync("報價單列印已送出");
            }
            else
            {
                await NotificationService.ShowErrorAsync("列印執行失敗");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDirectPrint), GetType(), 
                additionalData: $"報價單直接列印失敗 - ID: {QuotationId}, Config: {printConfig?.ReportName}");
            await NotificationService.ShowErrorAsync("列印執行時發生錯誤");
        }
    }
}
