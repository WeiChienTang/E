@using ERPCore2.Services.Reports.Interfaces
@using ERPCore2.Models.Reports
@inject IQuotationService QuotationService
@inject IQuotationDetailService QuotationDetailService
@inject IQuotationCompositionDetailService QuotationCompositionDetailService
@inject ICustomerService CustomerService
@inject ICompanyService CompanyService
@inject IEmployeeService EmployeeService
@inject IProductService ProductService
@inject IUnitService UnitService
@inject INotificationService NotificationService
@inject IReportPrintConfigurationService ReportPrintConfigurationService
@inject ISalesOrderService SalesOrderService
@inject ISalesOrderDetailService SalesOrderDetailService
@inject ISystemParameterService SystemParameterService
@inject IQuotationReportService QuotationReportService
@inject NavigationManager NavigationManager
@inject ActionButtonHelper ActionButtonHelper
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ERPCore2.Data.Context.AppDbContext DbContext
@inject IStringLocalizer<SharedResource> L

<GenericEditModalComponent TEntity="Quotation" 
                          TService="IQuotationService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@QuotationId"
                          Service="@QuotationService"
                          EntityName="@L["Entity.Quotation"]"
                          EntityNamePlural="@L["Entity.Quotation"]"
                          ModalTitle="@(QuotationId.HasValue ? L["Message.EditTitle", L["Entity.Quotation"]].ToString() : L["Message.CreateTitle", L["Entity.Quotation"]].ToString())"
                          Size="GenericEditModalComponent<Quotation, IQuotationService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@autoCompleteConfig?.Prefillers"
                          AutoCompleteCollections="@autoCompleteConfig?.Collections"
                          AutoCompleteDisplayProperties="@autoCompleteConfig?.DisplayProperties"
                          AutoCompleteValueProperties="@autoCompleteConfig?.ValueProperties"
                          ModalManagers="@modalManagers?.AsDictionary()"
                          DataLoader="@LoadQuotationData"
                          SaveHandler="@SaveQuotationWithDetails"
                          SaveSuccessMessage="@(QuotationId.HasValue ? L["Message.UpdateSuccess", L["Entity.Quotation"]].ToString() : L["Message.CreateSuccess", L["Entity.Quotation"]].ToString())"
                          SaveFailureMessage="@L["Message.SaveFailure", L["Entity.Quotation"]]"
                          RequiredPermission="@PermissionRegistry.Quotation.Read"
                          OnEntitySaved="@OnQuotationSaved"
                          OnCancel="@OnCancel"
                          OnTaxMethodChanged="@(() => HandleQuotationDetailsChanged(quotationDetails))"
                          CustomModules="@GetCustomModules()"
                          CustomActionButtons="@GetCustomActionButtons()"
                          FormHeaderContent="@GetWarningMessage()"
                          ShowPrintButton="true"
                          ReportService="@QuotationReportService"
                          ReportId="@ReportIds.Quotation"
                          ReportPreviewTitle="@L["Label.DocumentPreview", L["Entity.Quotation"]]"
                          GetReportDocumentName="@(e => $"報價單-{e.Code}")"
                          ShowApprovalSection="@ShouldShowApprovalSection()"
                          ApprovalPermission="Quotation.Approve"
                          OnApprove="@HandleQuotationApprove"
                          OnRejectWithReason="@HandleQuotationRejectWithReason"
                          OnEntityLoaded="@HandleEntityLoaded">
</GenericEditModalComponent>

@* 客戶編輯 Modal *@
<CustomerEditModalComponent @ref="customerEditModal"
                           IsVisible="@customerModalManager.IsModalVisible"
                           IsVisibleChanged="@customerModalManager.HandleModalVisibilityChangedAsync"
                           CustomerId="@customerModalManager.SelectedEntityId"
                           OnCustomerSaved="@customerModalManager.OnSavedAsync"
                           OnCancel="@customerModalManager.HandleModalCancelAsync" />

@* 業務員編輯 Modal *@
<EmployeeEditModalComponent @ref="employeeEditModal"
                           IsVisible="@employeeModalManager.IsModalVisible"
                           IsVisibleChanged="@employeeModalManager.HandleModalVisibilityChangedAsync"
                           EmployeeId="@employeeModalManager.SelectedEntityId"
                           OnEmployeeSaved="@employeeModalManager.OnSavedAsync"
                           OnCancel="@employeeModalManager.HandleModalCancelAsync" />

@* 公司編輯 Modal *@
<CompanyEditModalComponent @ref="companyEditModal"
                          IsVisible="@companyModalManager.IsModalVisible"
                          IsVisibleChanged="@companyModalManager.HandleModalVisibilityChangedAsync"
                          CompanyId="@companyModalManager.SelectedEntityId"
                          OnCompanySaved="@companyModalManager.OnSavedAsync"
                          OnCancel="@companyModalManager.HandleModalCancelAsync" />

@* 銷貨訂單編輯 Modal *@
<SalesOrderEditModalComponent @ref="salesOrderEditModal"
                             IsVisible="@showSalesOrderModal"
                             IsVisibleChanged="@((bool visible) => showSalesOrderModal = visible)"
                             SalesOrderId="@selectedSalesOrderId"
                             PrefilledCustomerId="@editModalComponent?.Entity?.CustomerId"
                             PrefilledQuotationId="@QuotationId"
                             OnSalesOrderSaved="@HandleSalesOrderSaved"
                             OnCancel="@(() => showSalesOrderModal = false)" />

@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? QuotationId { get; set; }
    [Parameter] public EventCallback<Quotation> OnQuotationSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<Quotation, IQuotationService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();

    // AutoComplete 配置
    private AutoCompleteConfig? autoCompleteConfig;
    
    // 原始資料集合（用於 AutoComplete）
    private List<Customer> availableCustomers = new();
    private List<Company> availableCompanies = new();
    private List<Employee> availableEmployees = new();
    private List<Product> availableProducts = new();
    private List<Unit> availableUnits = new();
    
    // 報價單明細
    private List<QuotationDetail> quotationDetails = new();
    private QuotationTable? quotationDetailManager;
    
    // 方案 D 改良版：資料版本計數器
    private int _detailsDataVersion = 0;
    
    // Modal Manager 集合
    private ModalManagerCollection? modalManagers;
    
    // Modal 管理器
    private CustomerEditModalComponent? customerEditModal;
    private RelatedEntityModalManager<Customer> customerModalManager = default!;
    private CompanyEditModalComponent? companyEditModal;
    private RelatedEntityModalManager<Company> companyModalManager = default!;
    private EmployeeEditModalComponent? employeeEditModal;
    private RelatedEntityModalManager<Employee> employeeModalManager = default!;
    
    // ===== 相關單據 Modal =====
    private SalesOrderEditModalComponent? salesOrderEditModal;
    private bool showSalesOrderModal = false;
    private int? selectedSalesOrderId = null;
    
    // 下拉選單選項（向下相容）
    private List<Customer> customers = new();
    private List<Employee> employees = new();
    private List<SelectOption> customerOptions = new();
    private List<SelectOption> employeeOptions = new();
    private List<SelectOption> taxCalculationMethodOptions = new();
    
    // ===== 審核開關狀態 =====
    private bool isApprovalEnabled = true; // 是否啟用報價單審核功能（從系統參數載入）
    
    // ===== 鎖定狀態 =====
    private bool hasUndeletableDetails = false; // 是否有不可刪除的明細（已有轉單記錄）
    
    // ===== 已刪除的明細 ID 暫存（儲存時才真正刪除） =====
    private List<int> _deletedDetailIds = new();
    
    // ===== 明細載入狀態 =====
    private bool isDetailDataReady = false;  // 標記明細相關資料是否已完整載入
    private bool isDataLoaded = false;  // 標記資料是否已載入（用於 Lazy Loading）

    // ===== 必要方法 =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 使用 ModalManagerInitHelper 初始化所有 Manager
            modalManagers = ModalManagerInitHelper.CreateBuilder<Quotation, IQuotationService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Customer>(nameof(Quotation.CustomerId), "客戶")
                .AddManager<Company>(nameof(Quotation.CompanyId), "公司")
                .AddManager<Employee>(nameof(Quotation.EmployeeId), "業務員")
                .Build();
            
            // 取得個別 Manager 供組件使用
            customerModalManager = modalManagers.Get<Customer>(nameof(Quotation.CustomerId));
            companyModalManager = modalManagers.Get<Company>(nameof(Quotation.CompanyId));
            employeeModalManager = modalManagers.Get<Employee>(nameof(Quotation.EmployeeId));
            
            // 載入系統參數（審核開關）
            await LoadSystemParametersAsync();
            
            // 移除自動載入資料，改為在 OnParametersSetAsync 中根據 IsVisible 載入
            // await LoadAdditionalDataAsync();
            // await InitializeFormFieldsAsync();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化報價單編輯組件時發生錯誤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            // 打開時，首次載入資料
            if (!QuotationId.HasValue)
            {
                hasUndeletableDetails = false;
            }
            
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            // Modal 關閉時重置狀態
            isDetailDataReady = false;
            isDataLoaded = false;
            _deletedDetailIds.Clear();  // 清除暫存的已刪除明細 ID
        }
    }
    private async Task<Quotation?> LoadQuotationData()
    {
        try
        {
            // 🔑 關鍵修正：每次載入資料時重置狀態變數，避免上次編輯的狀態殘留到新增模式
            isDetailDataReady = false;
            hasUndeletableDetails = false;
            
            if (!QuotationId.HasValue)
            {
                // 新增模式
                // 取得預設公司
                var primaryCompany = await CompanyService.GetPrimaryCompanyAsync();
                
                var newQuotation = new Quotation
                {
                    Code = await EntityCodeGenerationHelper.GenerateForEntity<Quotation, IQuotationService>(QuotationService, DbContext),
                    QuotationDate = DateTime.Today,
                    Status = EntityStatus.Active,
                    CompanyId = primaryCompany?.Id ?? 0 // 設定預設公司
                };

                // 初始化空的子集合
                quotationDetails = new List<QuotationDetail>();
                
                // 新增模式下直接標記為準備就緒（沒有明細需要載入）
                isDetailDataReady = true;

                return newQuotation;
            }

            // 編輯模式
            var quotation = await QuotationService.GetWithDetailsAsync(QuotationId.Value);
            
            if (quotation != null)
            {
                // 載入報價單明細
                quotationDetails = quotation.QuotationDetails?.ToList() ?? new List<QuotationDetail>();
                
                // 方案 D 改良版：遞增版本號
                _detailsDataVersion++;
                
                // 檢查明細是否有已轉單的記錄（與 PurchaseOrderEditModalComponent 邏輯一致）
                var hasConvertedDetails = quotationDetails.Any(d => d.ConvertedQuantity > 0);
                hasUndeletableDetails = hasConvertedDetails;
                
                //  標記明細資料已準備就緒
                isDetailDataReady = true;
                
                // 如果已轉單或已審核，需要鎖定欄位
                if (hasUndeletableDetails || quotation.IsApproved)
                {
                    // 在實體載入後重新初始化表單欄位以反映正確的唯讀狀態
                    await Task.Delay(10); // 短暫延遲確保實體已設定
                    _ = Task.Run(async () =>
                    {
                        await InvokeAsync(async () =>
                        {
                            await InitializeFormFieldsAsync();
                            UpdateFieldsReadOnlyState(); // 重新計算並鎖定欄位
                            StateHasChanged();
                        });
                    });
                }
            }
            else
            {
                quotationDetails = new List<QuotationDetail>();
            }

            return quotation;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入報價單資料時發生錯誤：{ex.Message}");
            return null;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // 載入客戶列表
            availableCustomers = await CustomerService.GetAllAsync();
            customers = availableCustomers;
            customerOptions = customers.Select(c => new SelectOption 
            { 
                Text = c.CompanyName ?? "", 
                Value = c.Id.ToString() 
            }).ToList();
            
            // 載入公司列表
            availableCompanies = await CompanyService.GetAllAsync();
            
            // 載入業務員列表（排除超級管理員）
            var allEmployees = await EmployeeService.GetAllAsync();
            availableEmployees = allEmployees.Where(e => !e.IsSuperAdmin).ToList();
            employees = availableEmployees;
            employeeOptions = employees.Select(e => new SelectOption 
            { 
                Text = e.Name ?? "", 
                Value = e.Id.ToString() 
            }).ToList();
            
            // 載入商品列表（用於明細）
            availableProducts = await ProductService.GetAllAsync();
            
            // 載入單位列表（用於明細）
            availableUnits = await UnitService.GetAllAsync();
            
            taxCalculationMethodOptions = TaxCalculationHelper.GetTaxMethodOptions();
            
            // 使用 AutoCompleteConfigHelper 建立配置
            autoCompleteConfig = new AutoCompleteConfigBuilder<Quotation>()
                .AddField(nameof(Quotation.CustomerId), "CompanyName", availableCustomers)
                .AddField(nameof(Quotation.CompanyId), "CompanyName", availableCompanies)
                .AddField(nameof(Quotation.EmployeeId), "Name", availableEmployees)
                .Build();
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("載入報價單編輯相關資料時發生錯誤");
            availableCustomers = new List<Customer>();
            availableCompanies = new List<Company>();
            availableEmployees = new List<Employee>();
            availableProducts = new List<Product>();
            availableUnits = new List<Unit>();
            customers = new List<Customer>();
            employees = new List<Employee>();
            customerOptions = new List<SelectOption>();
            employeeOptions = new List<SelectOption>();
        }
    }

    /// <summary>
    /// 載入系統參數（審核開關）
    /// </summary>
    private async Task LoadSystemParametersAsync()
    {
        try
        {
            var systemParams = await SystemParameterService.GetSystemParameterAsync();
            if (systemParams != null)
            {
                isApprovalEnabled = systemParams.EnableQuotationApproval;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSystemParametersAsync), GetType());
            // 預設啟用審核
            isApprovalEnabled = false;
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            // 使用 ApprovalConfigHelper 統一判斷是否鎖定欄位
            // 報價單的鎖定條件：(審核通過) 或 (明細有轉單記錄)
            var shouldLock = ApprovalConfigHelper.ShouldLockFieldByApproval(
                isApprovalEnabled,
                editModalComponent?.Entity?.IsApproved ?? false,
                hasUndeletableDetails  // 使用明細轉單狀態作為額外的鎖定條件
            );
            
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(Quotation.Code),
                    Label = L["Field.QuotationCode"],
                    FieldType = FormFieldType.Text,
                    Placeholder = L["Placeholder.PleaseInput", L["Field.QuotationCode"]],
                    IsRequired = true,
                    MaxLength = 30,
                    HelpText = "報價單的唯一識別編號，新增時系統會自動產生，也可手動修改",
                    IsReadOnly = shouldLock // 根據審核狀態和明細轉單狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(Quotation.CustomerId),
                    Label = L["Entity.Customer"],
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = L["Placeholder.PleaseInputOrSelect", L["Entity.Customer"]],
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "輸入客戶名稱進行搜尋，或直接選擇",
                    ActionButtons = await GetCustomerActionButtonsAsync(),
                    IsReadOnly = shouldLock // 根據審核狀態和明細轉單狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(Quotation.CompanyId),
                    Label = L["Entity.Company"],
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = L["Placeholder.PleaseSelect", L["Entity.Company"]],
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "選擇進行此次報價的公司",
                    IsReadOnly = shouldLock // 根據審核狀態和轉單狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(Quotation.EmployeeId),
                    Label = L["Field.QuotationCreator"],
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = L["Placeholder.PleaseInputOrSelect", L["Field.QuotationCreator"]],
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "輸入製表者姓名進行搜尋，或直接選擇",
                    ActionButtons = await GetEmployeeActionButtonsAsync(),
                    IsReadOnly = shouldLock // 根據審核狀態和轉單狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(Quotation.QuotationDate),
                    Label = L["Field.QuotationDate"],
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "報價單的建立日期",
                    IsReadOnly = shouldLock // 根據審核狀態和轉單狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(Quotation.TaxCalculationMethod),
                    Label = L["Field.TaxType"],
                    FieldType = FormFieldType.Select,
                    Options = taxCalculationMethodOptions,
                    IsRequired = true,
                    HelpText = "外加稅：稅額另外加上 | 內含稅：總價已包含稅 | 不含稅：完全免稅",
                    IsReadOnly = shouldLock // 根據審核狀態和轉單狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(Quotation.PaymentTerms),
                    Label = L["Field.PaymentTerms"],
                    FieldType = FormFieldType.Text,
                    Placeholder = L["Placeholder.PleaseInput", L["Field.PaymentTerms"]],
                    IsRequired = false,
                    MaxLength = 100,
                    HelpText = "例如：貨到付款、月結30天等",
                    IsReadOnly = shouldLock // 根據審核狀態和轉單狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(Quotation.DeliveryTerms),
                    Label = L["Field.DeliveryTerms"],
                    FieldType = FormFieldType.Text,
                    Placeholder = L["Placeholder.PleaseInput", L["Field.DeliveryTerms"]],
                    IsRequired = false,
                    MaxLength = 100,
                    HelpText = "例如：工廠交貨、送貨到府等",
                    IsReadOnly = shouldLock // 根據審核狀態和轉單狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(Quotation.SubtotalBeforeDiscount),
                    Label = L["Field.Amount"],
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true, // 折扣前金額始終為唯讀
                    HelpText = "系統根據明細自動計算（明細的數量 × 單價總和）",
                    CssClass = "text-warning fw-bold" // 使用黃色粗體顯示
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(Quotation.DiscountAmount),
                    Label = L["Field.Discount"],
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true, // 折扣金額始終為唯讀
                    HelpText = "系統根據明細自動計算 = (數量 × 單價 × 折扣%)",
                    CssClass = "text-danger fw-bold" // 使用紅色粗體顯示
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(Quotation.QuotationTaxAmount),
                    Label = L["Field.TaxAmount"],
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "系統根據明細自動計算 = (折扣後金額 × 稅率%)",
                    CssClass = "text-info fw-bold"
                },
                new()
                {
                    PropertyName = nameof(Quotation.TotalAmount),
                    Label = L["Field.TotalAmount"],
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "系統根據明細自動計算（金額 - 折扣 + 稅額）",
                    CssClass = "text-success fw-bold"
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(Quotation.ProjectName),
                    Label = L["Field.ProjectName"],
                    FieldType = FormFieldType.Text,
                    Placeholder = L["Placeholder.PleaseInput", L["Field.ProjectName"]],
                    IsRequired = false,
                    MaxLength = 20,
                    HelpText = "報價所屬的工程名稱",
                    IsReadOnly = shouldLock // 根據審核狀態和轉單狀態決定是否鎖定
                },

                FormFieldConfigurationHelper.CreateRemarksField<Quotation>(
                    label: "報價說明",
                    readOnly: shouldLock // 根據審核狀態和轉單狀態決定是否鎖定
                )
            };

            formSections = FormSectionHelper<Quotation>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    q => q.Code,
                    q => q.CustomerId,
                    q => q.CompanyId,
                    q => q.EmployeeId,
                    q => q.ProjectName,
                    q => q.QuotationDate)
                .AddToSection(FormSectionNames.AmountInfo,
                    q => q.TaxCalculationMethod,
                    q => q.SubtotalBeforeDiscount,
                    q => q.DiscountAmount,
                    q => q.QuotationTaxAmount,
                    q => q.TotalAmount)
                .AddToSection(FormSectionNames.TradingTerms,
                    q => q.PaymentTerms,
                    q => q.DeliveryTerms)
                .AddCustomFields(FormSectionNames.OtherInfo, "Remarks")
                .Build();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化表單欄位時發生錯誤");
        }
    }



    /// <summary>
    /// 驗證報價單明細 - 在儲存主檔之前執行
    /// </summary>
    private async Task<bool> ValidateQuotationDetailsAsync(Quotation quotation)
    {
        try
        {
            if (quotationDetailManager != null)
            {
                return await quotationDetailManager.ValidateAsync();
            }
            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ValidateQuotationDetailsAsync), GetType());
            return false;
        }
    }

    /// <summary>
    /// 自訂儲存邏輯 - 同時儲存主檔和明細
    /// 特殊處理：審核通過或已轉單後仍允許儲存，用於更新明細的執行狀態
    /// </summary>
    private async Task<bool> SaveQuotationWithDetails(Quotation quotation)
    {
        try
        {
            if (quotation == null)
            {
                await NotificationService.ShowErrorAsync("沒有要儲存的報價單資料");
                return false;
            }

            // 檢查公司欄位是否有資料
            if (quotation.CompanyId <= 0)
            {
                await NotificationService.ShowWarningAsync("請選擇公司後再進行儲存");
                return false;
            }

            // 先執行明細驗證
            if (!await ValidateQuotationDetailsAsync(quotation))
            {
                return false;
            }

            //  修改：審核通過或已轉單後仍允許儲存（用於更新明細的執行狀態）
            // 移除原有的 hasUndeletableDetails 檢查，與 PurchaseOrderEditModalComponent 保持一致
            // 欄位鎖定由 InitializeFormFieldsAsync 中的 IsReadOnly 控制
            // 但使用者仍可修改明細並儲存整個單據
            
            // 根據稅別計算金額欄位（與 HandleQuotationDetailsChanged 邏輯一致）
            var taxMethod = quotation.TaxCalculationMethod;
            
            switch (taxMethod)
            {
                case TaxCalculationMethod.TaxExclusive:
                    // 外加稅：總額 = 金額 - 折扣 + 稅額
                    {
                        quotation.SubtotalBeforeDiscount = Math.Round(
                            quotationDetails.Sum(d => d.Quantity * d.UnitPrice), 0, MidpointRounding.AwayFromZero);
                        
                        quotation.DiscountAmount = Math.Round(
                            quotationDetails.Sum(d => d.Quantity * d.UnitPrice * (d.DiscountPercentage / 100)), 0, MidpointRounding.AwayFromZero);
                        
                        quotation.QuotationTaxAmount = Math.Round(
                            quotationDetails.Sum(d => {
                                var amountAfterDiscount = d.Quantity * d.UnitPrice * (1 - d.DiscountPercentage / 100);
                                var taxRate = d.TaxRate ?? 0;
                                return amountAfterDiscount * (taxRate / 100);
                            }), 0, MidpointRounding.AwayFromZero);
                        
                        quotation.TotalAmount = quotation.SubtotalBeforeDiscount - quotation.DiscountAmount + quotation.QuotationTaxAmount;
                    }
                    break;
                
                case TaxCalculationMethod.TaxInclusive:
                    // 內含稅：總額已含稅，反推金額、折扣、稅額
                    {
                        quotation.TotalAmount = Math.Round(
                            quotationDetails.Sum(d => d.Quantity * d.UnitPrice * (1 - d.DiscountPercentage / 100)), 0, MidpointRounding.AwayFromZero);
                        
                        quotation.QuotationTaxAmount = Math.Round(
                            quotationDetails.Sum(d => {
                                var amountWithTax = d.Quantity * d.UnitPrice * (1 - d.DiscountPercentage / 100);
                                var taxRate = d.TaxRate ?? 0;
                                return amountWithTax / (1 + taxRate / 100) * (taxRate / 100);
                            }), 0, MidpointRounding.AwayFromZero);
                        
                        quotation.SubtotalBeforeDiscount = Math.Round(
                            quotationDetails.Sum(d => d.Quantity * d.UnitPrice), 0, MidpointRounding.AwayFromZero);
                        
                        quotation.DiscountAmount = Math.Round(
                            quotationDetails.Sum(d => d.Quantity * d.UnitPrice * (d.DiscountPercentage / 100)), 0, MidpointRounding.AwayFromZero);
                    }
                    break;
                
                case TaxCalculationMethod.NoTax:
                    // 免稅：總額 = 金額 - 折扣（稅額為 0）
                    {
                        quotation.SubtotalBeforeDiscount = Math.Round(
                            quotationDetails.Sum(d => d.Quantity * d.UnitPrice), 0, MidpointRounding.AwayFromZero);
                        
                        quotation.DiscountAmount = Math.Round(
                            quotationDetails.Sum(d => d.Quantity * d.UnitPrice * (d.DiscountPercentage / 100)), 0, MidpointRounding.AwayFromZero);
                        
                        quotation.QuotationTaxAmount = 0;
                        
                        quotation.TotalAmount = quotation.SubtotalBeforeDiscount - quotation.DiscountAmount;
                    }
                    break;
            }

            // 儲存主檔
            ServiceResult<Quotation> result;
            if (QuotationId.HasValue)
            {
                result = await QuotationService.UpdateAsync(quotation);
            }
            else
            {
                result = await QuotationService.CreateAsync(quotation);
            }

            if (!result.IsSuccess || result.Data == null)
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "儲存報價單失敗");
                return false;
            }

            // 儲存明細
            await SaveQuotationDetails(result.Data.Id);

            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveQuotationWithDetails), GetType(), 
                additionalData: "儲存報價單和明細失敗");
            await NotificationService.ShowErrorAsync($"儲存時發生錯誤：{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// 儲存報價單明細
    /// </summary>
    private async Task SaveQuotationDetails(int quotationId)
    {
        try
        {
            // 設定主檔ID
            foreach (var detail in quotationDetails)
            {
                detail.QuotationId = quotationId;
                if (detail.Id == 0)
                {
                    detail.Status = EntityStatus.Active;
                    detail.CreatedAt = DateTime.Now;
                }
                else
                {
                    detail.UpdatedAt = DateTime.Now;
                }
            }

            // 處理新增和更新的明細
            foreach (var detail in quotationDetails.Where(d => d.ProductId > 0))
            {
                if (detail.Id == 0)
                {
                    // 新增明細
                    await QuotationDetailService.CreateAsync(detail);
                }
                else
                {
                    // 更新明細
                    await QuotationDetailService.UpdateAsync(detail);
                }
            }

            // 處理刪除的明細（使用暫存的已刪除 ID 列表）
            // 這與 PurchaseOrderTable 的行為保持一致：在 Table 上刪除只是暫存，儲存時才真正刪除
            if (_deletedDetailIds.Any())
            {
                foreach (var detailId in _deletedDetailIds)
                {
                    await QuotationDetailService.DeleteAsync(detailId);
                }
                _deletedDetailIds.Clear();  // 刪除完成後清空列表
            }
            
            // 儲存報價單組合明細（BOM）
            await SaveQuotationCompositionDetails(quotationId);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveQuotationDetails), GetType(), 
                additionalData: $"儲存報價單明細失敗 - QuotationId: {quotationId}");
            throw; // 重新拋出例外，讓上層處理
        }
    }

    /// <summary>
    /// 儲存報價單組合明細（BOM）
    /// 處理臨時索引（負數）映射到實際儲存後的明細ID
    /// </summary>
    private async Task SaveQuotationCompositionDetails(int quotationId)
    {
        try
        {
            // 從 QuotationTable 組件取得組合明細資料
            if (quotationDetailManager == null)
                return;
            
            var compositionDetailsMap = quotationDetailManager.GetCompositionDetails();
            
            if (!compositionDetailsMap.Any())
                return;
            
            // 取得所有報價單明細（按順序排列，與 QuotationItems 對應）
            var savedQuotationDetails = await QuotationDetailService.GetByQuotationIdAsync(quotationId);
            var orderedDetails = savedQuotationDetails.OrderBy(d => d.Id).ToList();
            
            foreach (var kvp in compositionDetailsMap)
            {
                var quotationDetailId = kvp.Key;
                var compositionDetails = kvp.Value;
                
                QuotationDetail? quotationDetail = null;
                
                if (quotationDetailId > 0)
                {
                    // 正常 ID，直接查找
                    quotationDetail = orderedDetails.FirstOrDefault(d => d.Id == quotationDetailId);
                    if (quotationDetail == null)
                        continue;
                }
                else
                {
                    // 臨時索引（負數），映射到實際明細
                    // -1 對應第 0 個明細，-2 對應第 1 個明細...
                    int arrayIndex = Math.Abs(quotationDetailId) - 1;
                    
                    if (arrayIndex < orderedDetails.Count)
                    {
                        quotationDetail = orderedDetails[arrayIndex];
                    }
                    else
                    {
                        continue;
                    }
                }
                
                // 批次儲存組合明細（使用實際的明細ID）
                await QuotationCompositionDetailService.SaveBatchAsync(quotationDetail.Id, compositionDetails);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveQuotationCompositionDetails), GetType(), 
                additionalData: $"儲存報價單組合明細失敗 - QuotationId: {quotationId}");
            // 不拋出例外，讓主要儲存流程繼續
        }
    }

    /// <summary>
    /// 配置自訂模組（報價明細表格）
    /// </summary>
    private List<GenericEditModalComponent<Quotation, IQuotationService>.CustomModule> GetCustomModules()
    {
        try
        {
            if (editModalComponent == null)
            {
                return new List<GenericEditModalComponent<Quotation, IQuotationService>.CustomModule>();
            }

            return new List<GenericEditModalComponent<Quotation, IQuotationService>.CustomModule>
            {
                new GenericEditModalComponent<Quotation, IQuotationService>.CustomModule
                {
                    Title = "",
                    Content = CreateQuotationDetailManagerContent(),
                    Order = 1
                }
            };
        }
        catch
        {
            return new List<GenericEditModalComponent<Quotation, IQuotationService>.CustomModule>();
        }
    }

    /// <summary>
    /// 創建報價單明細管理器內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateQuotationDetailManagerContent() => __builder =>
    {
        <DetailSectionWrapper IsEntityReady="@(editModalComponent?.Entity != null)"
                              EntityLoadingVariant="DetailSectionWrapper.LoadingVariant.Silent"
                              IsDataAvailable="@(availableProducts != null && availableProducts.Any())"
                              DataUnavailableMessage="無可用的商品資料，請聯繫系統管理員"
                              IsPreconditionMet="@(editModalComponent?.Entity?.CustomerId > 0)"
                              PreconditionMessage="請先選擇客戶後再進行報價明細管理">
            <QuotationTable @ref="quotationDetailManager"
                                    MainEntity="@editModalComponent!.Entity"
                                    ExistingDetails="@quotationDetails"
                                    DataVersion="@_detailsDataVersion"
                                    IsParentLoading="@(editModalComponent?.IsLoading ?? false)"
                                    OnDetailsChanged="@HandleQuotationDetailsChanged"
                                    OnDeletedDetailsChanged="@HandleDeletedDetailsChanged"
                                    Products="@availableProducts"
                                    Units="@availableUnits"
                                    SelectedCustomerId="@(editModalComponent?.Entity?.CustomerId > 0 ? editModalComponent.Entity.CustomerId : (int?)null)"
                                    SelectedSupplierId="@(editModalComponent?.Entity?.CustomerId > 0 ? editModalComponent.Entity.CustomerId : (int?)null)"
                                    TaxCalculationMethod="@(editModalComponent?.Entity?.TaxCalculationMethod ?? TaxCalculationMethod.TaxExclusive)"
                                    IsReadOnly="false"
                                    OnOpenRelatedDocument="@HandleOpenRelatedDocument"
                                    Title="報價明細"
                                    EmptyMessage="尚未新增報價商品" />
        </DetailSectionWrapper>
    };

    /// <summary>
    /// 處理報價單明細變更 - 根據稅別自動計算金額欄位
    /// </summary>
    private async Task HandleQuotationDetailsChanged(List<QuotationDetail> details)
    {
        try
        {
            editModalComponent?.MarkDirty();
            quotationDetails = details;

            if (editModalComponent?.Entity != null)
            {
                var (net, tax, gross, discount) = TaxCalculationHelper.CalculateFromDetailsWithDiscount(
                    details,
                    editModalComponent.Entity.TaxCalculationMethod,
                    0m,
                    d => d.SubtotalAmount,
                    d => d.TaxRate,
                    d => d.Quantity * d.UnitPrice);

                editModalComponent.Entity.SubtotalBeforeDiscount = gross;
                editModalComponent.Entity.DiscountAmount = discount;
                editModalComponent.Entity.QuotationTaxAmount = tax;
                editModalComponent.Entity.TotalAmount = net + tax;

                editModalComponent.Entity.QuotationDetails = details;

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleQuotationDetailsChanged), GetType());
        }
    }

    /// <summary>
    /// 處理已刪除的報價單明細ID
    /// 注意：這裡只暫存刪除的 ID，在 SaveQuotationDetails 儲存時才真正刪除資料庫記錄
    /// 這與 PurchaseOrderTable 的行為保持一致
    /// </summary>
    private Task HandleDeletedDetailsChanged(List<int> deletedDetailIds)
    {
        try
        {
            if (deletedDetailIds?.Any() == true)
            {
                // 將刪除的 ID 加入暫存列表（避免重複）
                foreach (var detailId in deletedDetailIds)
                {
                    if (!_deletedDetailIds.Contains(detailId))
                    {
                        _deletedDetailIds.Add(detailId);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            // 記錄錯誤但不拋出，因為這只是暫存操作
            Console.WriteLine($"HandleDeletedDetailsChanged 發生錯誤: {ex.Message}");
        }
        
        return Task.CompletedTask;
    }

    /// <summary>
    /// 取得枚舉的顯示名稱
    /// </summary>
    private static string GetEnumDisplayName(Enum enumValue)
    {
        var displayAttribute = enumValue.GetType()
            .GetField(enumValue.ToString())?
            .GetCustomAttribute<DisplayAttribute>();
        
        return displayAttribute?.Name ?? enumValue.ToString();
    }



    /// <summary>
    /// 使用統一 Helper 產生客戶操作按鈕
    /// </summary>
    private async Task<List<FieldActionButton>> GetCustomerActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            customerModalManager, 
            nameof(Quotation.CustomerId)
        );
    }

    /// <summary>
    /// 使用統一 Helper 產生公司操作按鈕
    /// </summary>
    private async Task<List<FieldActionButton>> GetCompanyActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            companyModalManager, 
            nameof(Quotation.CompanyId)
        );
    }

    /// <summary>
    /// 更新欄位的唯讀狀態 - 根據審核狀態和明細轉單狀態
    /// 使用 FormFieldLockHelper 統一處理欄位鎖定邏輯
    /// </summary>
    private async void UpdateFieldsReadOnlyState()
    {
        // 計算是否應該鎖定欄位
        var shouldLock = ApprovalConfigHelper.ShouldLockFieldByApproval(
            isApprovalEnabled,
            editModalComponent?.Entity?.IsApproved ?? false,
            hasUndeletableDetails
        );

        // 使用 FormFieldLockHelper 一次處理所有欄位（含 ActionButtons）
        FormFieldLockHelper.LockMultipleFields(
            formFields,
            new[]
            {
                nameof(Quotation.Code),
                nameof(Quotation.QuotationDate),
                nameof(Quotation.PaymentTerms),
                nameof(Quotation.DeliveryTerms),
                nameof(Quotation.ProjectName),
                nameof(BaseEntity.Remarks),
                nameof(Quotation.CustomerId),
                nameof(Quotation.CompanyId),
                nameof(Quotation.EmployeeId)
            },
            isLocked: shouldLock,
            actionButtonsMap: new Dictionary<string, Func<Task<List<FieldActionButton>>>>
            {
                { nameof(Quotation.CustomerId), GetCustomerActionButtonsAsync },
                { nameof(Quotation.CompanyId), GetCompanyActionButtonsAsync },
                { nameof(Quotation.EmployeeId), GetEmployeeActionButtonsAsync }
            }
        );
        
        // 強制更新 UI
        await InvokeAsync(() => StateHasChanged());
    }

    /// <summary>
    /// 使用統一 Helper 產生業務員操作按鈕
    /// </summary>
    private async Task<List<FieldActionButton>> GetEmployeeActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            employeeModalManager, 
            nameof(Quotation.EmployeeId)
        );
    }


    /// <summary>
    /// 取得警告訊息（顯示在表單欄位上方）- 作為屬性以確保正確的渲染時機
    /// 當報價單已審核通過或有明細已轉單時，顯示鎖定警告訊息
    /// </summary>
    private RenderFragment? GetWarningMessage() => __builder =>
    {
        // 只在資料準備就緒後才顯示訊息
        if (!isDetailDataReady)
            return;

        // 審核通過的警告訊息
        <GenericLockedFieldMessage IsVisible="@(isApprovalEnabled && editModalComponent?.Entity?.IsApproved == true)"
                                  Message="報價單已審核通過，主檔欄位已鎖定。" />

        // 明細已轉單的警告訊息
        <GenericLockedFieldMessage IsVisible="@(hasUndeletableDetails && !(isApprovalEnabled && editModalComponent?.Entity?.IsApproved == true))"
                                  Message="@EditModalMessages.UndeletableDetailsWarning"/>
    };
    

    /// <summary>
    /// 取得自訂操作按鈕（顯示在 Modal 頂部左側）- 作為屬性以確保正確的渲染時機
    /// </summary>
    private RenderFragment? GetCustomActionButtons()
    {
        // 修改邏輯：轉銷貨按鈕永遠顯示（只要報價單已儲存）
        // 明細是否可轉由 SalesOrderTable 組件處理（根據審核狀態和已轉數量）
        bool shouldShowButton = false;

        try
        {
            if (editModalComponent?.Entity != null &&
                QuotationId.HasValue &&
                QuotationId.Value > 0)
            {
                shouldShowButton = true;
            }
        }
        catch
        {
            shouldShowButton = false;
        }

        return __builder =>
        {
            @* 轉銷貨訂單按鈕 - 報價單已儲存即可顯示 *@
            @if (shouldShowButton)
            {
                <GenericButtonComponent Text="@L["Button.ConvertToOrder"]"
                                      Variant="ButtonVariant.Green"
                                      Size="ButtonSize.Small"
                                      CssClass="me-2"
                                      OnClick="HandleCreateSalesOrderFromQuotation" />
            }
        };
    }

    /// <summary>
    /// 從報價單轉銷貨訂單
    /// </summary>
    private async Task HandleCreateSalesOrderFromQuotation()
    {
        try
        {
            if (!QuotationId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("無法轉銷貨訂單：報價單資料不存在");
                return;
            }
            
            // 移除審核檢查：改為在載入明細時根據審核開關過濾
            // 如果啟用審核，只會載入已審核的報價單明細
            // 如果未啟用審核，載入所有報價單明細
            
            // 檢查是否有客戶資料
            if (editModalComponent.Entity.CustomerId <= 0)
            {
                await NotificationService.ShowWarningAsync("報價單缺少客戶資訊，無法轉銷貨訂單");
                return;
            }

            // 檢查是否還有未完成的明細（還需要轉單的商品）
            if (!quotationDetails.Any())
            {
                await NotificationService.ShowWarningAsync("報價單沒有明細資料，無法轉銷貨訂單");
                return;
            }
            
            // 檢查是否所有明細都已完成轉單（已轉數量 >= 報價數量）
            var hasIncompleteDetails = quotationDetails.Any(detail => 
                detail.ConvertedQuantity < detail.Quantity
            );
            
            if (!hasIncompleteDetails)
            {
                await NotificationService.ShowWarningAsync("報價單所有明細皆已轉為銷貨訂單，無需再轉單");
                return;
            }

            // 使用公開方法打開銷貨訂單 Modal 並自動載入報價單明細
            if (salesOrderEditModal != null)
            {
                await salesOrderEditModal.ShowAddModalWithPrefilledQuotation(
                    editModalComponent.Entity.CustomerId,
                    editModalComponent.Entity.CompanyId,
                    editModalComponent.Entity.EmployeeId,
                    QuotationId.Value
                );
            }
            else
            {
                await NotificationService.ShowWarningAsync("銷貨訂單組件未初始化，請重新整理頁面");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCreateSalesOrderFromQuotation), GetType(),
                additionalData: new { QuotationId = QuotationId });
            await NotificationService.ShowErrorAsync("轉銷貨訂單時發生錯誤");
        }
    }

    /// <summary>
    /// 處理銷貨訂單儲存後的事件
    /// </summary>
    /// <summary>
    /// 處理銷貨訂單儲存後的事件（報價單轉單）
    /// 使用 ChildDocumentRefreshHelper 統一處理刷新邏輯
    /// </summary>
    private async Task HandleSalesOrderSaved(SalesOrder savedSalesOrder)
    {
        try
        {
            await ChildDocumentRefreshHelper.HandleQuotationConversionAsync(
                closeModal: () =>
                {
                    showSalesOrderModal = false;
                    selectedSalesOrderId = null;
                },
                quotationId: QuotationId,
                savedSalesOrderId: savedSalesOrder.Id,
                updateEntity: async () =>
                {
                    // 不需要更新報價單的轉單狀態（已移除 ConvertedToSalesOrderId 欄位）
                    // 銷貨訂單透過 QuotationId 關聯到報價單即可
                    await Task.CompletedTask;
                },
                reloadQuotation: async () =>
                {
                    //  關鍵修復：使用專門的 LoadQuotationDetails 方法從資料庫重新載入明細
                    // 這確保 ConvertedQuantity 等欄位都是最新的資料
                    if (QuotationId.HasValue)
                    {
                        await LoadQuotationDetails(QuotationId.Value);
                    }
                },
                checkUndeletable: () => quotationDetails.Any(d => d.ConvertedQuantity > 0),
                updateHasUndeletableDetails: (hasUndeletable) => hasUndeletableDetails = hasUndeletable,
                reinitializeFields: InitializeFormFieldsAsync,
                stateHasChanged: StateHasChanged,
                additionalActions: async () =>
                {
                    //  關鍵修復：呼叫 Table 組件的公開刷新方法
                    // 因為父 Modal 沒有關閉，Table 組件不會自動重新載入
                    // 需要主動呼叫刷新方法來更新 UI 顯示
                    if (quotationDetailManager != null)
                    {
                        await quotationDetailManager.RefreshDetailsAsync();
                    }
                }
            );

            await NotificationService.ShowSuccessAsync($"已成功從報價單轉為銷貨訂單（訂單編號：{savedSalesOrder.Code}）");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSalesOrderSaved), GetType());
        }
    }

    /// <summary>
    /// 處理開啟相關單據的事件（從明細表格的查看按鈕觸發）
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            switch (args.type)
            {
                case RelatedDocumentType.SalesOrder:
                    // 開啟銷貨訂單 Modal（以唯讀模式）
                    selectedSalesOrderId = args.id;
                    showSalesOrderModal = true;
                    StateHasChanged();
                    break;
                    
                default:
                    await NotificationService.ShowWarningAsync($"不支援的單據類型：{args.type}");
                    break;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleOpenRelatedDocument), GetType(), 
                additionalData: $"開啟相關單據失敗 - Type: {args.type}, Id: {args.id}");
            await NotificationService.ShowErrorAsync("開啟單據時發生錯誤");
        }
    }


    
    // ===== 審核相關方法 =====
    
    /// <summary>
    /// 判斷是否應該顯示審核區域
    /// </summary>
    private bool ShouldShowApprovalSection()
    {
        return isApprovalEnabled && QuotationId.HasValue;
    }
    
    /// <summary>
    /// 處理報價單審核通過
    /// </summary>
    private async Task<bool> HandleQuotationApprove()
    {
        try
        {
            if (!QuotationId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowErrorAsync("找不到報價單資料");
                return false;
            }

            var quotation = editModalComponent.Entity;

            // 檢查是否已經審核
            if (quotation.IsApproved)
            {
                await NotificationService.ShowWarningAsync("此報價單已經審核通過");
                return false;
            }

            // 驗證明細
            if (!quotationDetails.Any())
            {
                await NotificationService.ShowWarningAsync("報價單沒有明細資料，無法審核");
                return false;
            }

            // 取得當前使用者ID
            var currentUserId = await CurrentUserHelper.GetCurrentEmployeeIdAsync(AuthenticationStateProvider);
            if (!currentUserId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法取得當前使用者資訊");
                return false;
            }

            // 更新審核狀態
            quotation.IsApproved = true;
            quotation.ApprovedBy = currentUserId.Value;
            quotation.ApprovedAt = DateTime.Now;
            quotation.RejectReason = null; // 清除駁回原因

            // 儲存
            var result = await QuotationService.UpdateAsync(quotation);
            if (!result.IsSuccess)
            {
                await NotificationService.ShowErrorAsync($"審核失敗：{result.ErrorMessage}");
                return false;
            }

            await NotificationService.ShowSuccessAsync("報價單審核通過");
            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleQuotationApprove), GetType());
            await NotificationService.ShowErrorAsync("審核處理時發生錯誤");
            return false;
        }
    }
    
    /// <summary>
    /// 處理報價單審核駁回（帶駁回原因）
    /// </summary>
    private async Task<bool> HandleQuotationRejectWithReason(string rejectReason)
    {
        try
        {
            if (!QuotationId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowErrorAsync("找不到報價單資料");
                return false;
            }

            if (string.IsNullOrWhiteSpace(rejectReason))
            {
                await NotificationService.ShowWarningAsync("請輸入駁回原因");
                return false;
            }

            var quotation = editModalComponent.Entity;

            // 檢查是否已經駁回
            if (!quotation.IsApproved && !string.IsNullOrEmpty(quotation.RejectReason))
            {
                await NotificationService.ShowWarningAsync("此報價單已經被駁回");
                return false;
            }

            // 取得當前使用者ID
            var currentUserId = await CurrentUserHelper.GetCurrentEmployeeIdAsync(AuthenticationStateProvider);
            if (!currentUserId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法取得當前使用者資訊");
                return false;
            }

            // 更新駁回狀態
            quotation.IsApproved = false;
            quotation.ApprovedBy = currentUserId.Value;
            quotation.ApprovedAt = DateTime.Now;
            quotation.RejectReason = rejectReason;

            // 儲存
            var result = await QuotationService.UpdateAsync(quotation);
            if (!result.IsSuccess)
            {
                await NotificationService.ShowErrorAsync($"駁回失敗：{result.ErrorMessage}");
                return false;
            }

            await NotificationService.ShowSuccessAsync($"報價單已駁回：{rejectReason}");
            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleQuotationRejectWithReason), GetType());
            await NotificationService.ShowErrorAsync("駁回處理時發生錯誤");
            return false;
        }
    }
    
    /// <summary>
    /// 處理實體載入完成事件（由 GenericEditModalComponent 的導航觸發）
    /// 方案 A + D 重構：明細已由 DataLoader 載入，Table 自動偵測參數變化
    /// 只需處理 UI 刷新
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            // 明細已由 DataLoader (LoadQuotationData) 載入完成
            // Table 組件會自動偵測 ExistingDetails 參數變化並重新載入
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleEntityLoaded), GetType(),
                additionalData: $"處理實體載入事件失敗 - EntityId: {loadedEntityId}");
            await NotificationService.ShowErrorAsync("載入明細資料時發生錯誤");
        }
    }
    
    /// <summary>
    /// 載入報價單明細
    /// </summary>
    private async Task LoadQuotationDetails(int quotationId)
    {
        try
        {
            // 從服務載入報價單明細（包含最新的 ConvertedQuantity）
            var quotation = await QuotationService.GetWithDetailsAsync(quotationId);
            quotationDetails = quotation?.QuotationDetails?.ToList() ?? new List<QuotationDetail>();
            
            // 載入明細後，檢查是否有不可刪除的明細（有轉單記錄）
            var hasConverted = quotationDetails.Any(d => d.ConvertedQuantity > 0);
            if (hasUndeletableDetails != hasConverted)
            {
                hasUndeletableDetails = hasConverted;
                // 如果鎖定狀態改變，需要重新初始化表單欄位
                await InitializeFormFieldsAsync();
                UpdateFieldsReadOnlyState();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadQuotationDetails), GetType(), 
                additionalData: $"載入報價單明細失敗 - QuotationId: {quotationId}");
            quotationDetails = new List<QuotationDetail>();
        }
    }
}
