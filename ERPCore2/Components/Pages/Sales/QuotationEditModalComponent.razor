@inject IQuotationService QuotationService
@inject IQuotationDetailService QuotationDetailService
@inject IQuotationCompositionDetailService QuotationCompositionDetailService
@inject ICustomerService CustomerService
@inject ICompanyService CompanyService
@inject IEmployeeService EmployeeService
@inject IProductService ProductService
@inject IUnitService UnitService
@inject INotificationService NotificationService
@inject IReportPrintConfigurationService ReportPrintConfigurationService
@inject ISalesOrderService SalesOrderService
@inject ISalesOrderDetailService SalesOrderDetailService
@inject ISystemParameterService SystemParameterService
@inject NavigationManager NavigationManager
@inject ActionButtonHelper ActionButtonHelper
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ERPCore2.Data.Context.AppDbContext DbContext

<GenericEditModalComponent TEntity="Quotation" 
                          TService="IQuotationService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@QuotationId"
                          Service="@QuotationService"
                          EntityName="å ±åƒ¹å–®"
                          EntityNamePlural="å ±åƒ¹å–®"
                          ModalTitle="@(QuotationId.HasValue ? "ç·¨è¼¯å ±åƒ¹å–®" : "æ–°å¢å ±åƒ¹å–®")"
                          Size="GenericEditModalComponent<Quotation, IQuotationService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@autoCompleteConfig?.Prefillers"
                          AutoCompleteCollections="@autoCompleteConfig?.Collections"
                          AutoCompleteDisplayProperties="@autoCompleteConfig?.DisplayProperties"
                          AutoCompleteValueProperties="@autoCompleteConfig?.ValueProperties"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadQuotationData"
                          SaveHandler="@SaveQuotationWithDetails"
                          SaveSuccessMessage="@(QuotationId.HasValue ? "å ±åƒ¹å–®æ›´æ–°æˆåŠŸ" : "å ±åƒ¹å–®æ–°å¢æˆåŠŸ")"
                          SaveFailureMessage="å ±åƒ¹å–®å„²å­˜å¤±æ•—"
                          RequiredPermission="Quotation.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          CustomModules="@GetCustomModules()"
                          CustomActionButtons="@CustomActionButtons"
                          FormHeaderContent="@WarningMessage"
                          ShowPrintButton="true"
                          OnPrint="@HandlePrint"
                          ShowApprovalSection="@ShouldShowApprovalSection()"
                          ApprovalPermission="Quotation.Approve"
                          OnApprove="@HandleQuotationApprove"
                          OnRejectWithReason="@HandleQuotationRejectWithReason"
                          OnEntityLoaded="@HandleEntityLoaded">
</GenericEditModalComponent>

@* å®¢æˆ¶ç·¨è¼¯ Modal *@
<CustomerEditModalComponent @ref="customerEditModal"
                           IsVisible="@customerModalManager.IsModalVisible"
                           IsVisibleChanged="@customerModalManager.HandleModalVisibilityChangedAsync"
                           CustomerId="@customerModalManager.SelectedEntityId"
                           OnCustomerSaved="@OnCustomerSavedWrapper"
                           OnCancel="@customerModalManager.HandleModalCancelAsync" />

@* æ¥­å‹™å“¡ç·¨è¼¯ Modal *@
<EmployeeEditModalComponent @ref="employeeEditModal"
                           IsVisible="@employeeModalManager.IsModalVisible"
                           IsVisibleChanged="@employeeModalManager.HandleModalVisibilityChangedAsync"
                           EmployeeId="@employeeModalManager.SelectedEntityId"
                           OnEmployeeSaved="@OnEmployeeSavedWrapper"
                           OnCancel="@employeeModalManager.HandleModalCancelAsync" />

@* å…¬å¸ç·¨è¼¯ Modal *@
<CompanyEditModalComponent @ref="companyEditModal"
                          IsVisible="@companyModalManager.IsModalVisible"
                          IsVisibleChanged="@companyModalManager.HandleModalVisibilityChangedAsync"
                          CompanyId="@companyModalManager.SelectedEntityId"
                          OnCompanySaved="@OnCompanySavedWrapper"
                          OnCancel="@companyModalManager.HandleModalCancelAsync" />

@* éŠ·è²¨è¨‚å–®ç·¨è¼¯ Modal *@
<SalesOrderEditModalComponent @ref="salesOrderEditModal"
                             IsVisible="@showSalesOrderModal"
                             IsVisibleChanged="@((bool visible) => showSalesOrderModal = visible)"
                             SalesOrderId="@selectedSalesOrderId"
                             PrefilledCustomerId="@editModalComponent?.Entity?.CustomerId"
                             PrefilledQuotationId="@QuotationId"
                             OnSalesOrderSaved="@HandleSalesOrderSaved"
                             OnCancel="@(() => showSalesOrderModal = false)" />

@code {
    // ===== å¿…è¦åƒæ•¸ =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? QuotationId { get; set; }
    [Parameter] public EventCallback<Quotation> OnQuotationSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== å…§éƒ¨ç‹€æ…‹ =====
    private GenericEditModalComponent<Quotation, IQuotationService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // AutoComplete é…ç½®
    private AutoCompleteConfig? autoCompleteConfig;
    
    // åŸå§‹è³‡æ–™é›†åˆï¼ˆç”¨æ–¼ AutoCompleteï¼‰
    private List<Customer> availableCustomers = new();
    private List<Company> availableCompanies = new();
    private List<Employee> availableEmployees = new();
    private List<Product> availableProducts = new();
    private List<Unit> availableUnits = new();
    
    // å ±åƒ¹å–®æ˜ç´°
    private List<QuotationDetail> quotationDetails = new();
    private QuotationTable<Quotation, QuotationDetail>? quotationDetailManager;
    
    // Modal Manager é›†åˆ
    private ModalManagerCollection? modalManagers;
    
    // Modal ç®¡ç†å™¨
    private CustomerEditModalComponent? customerEditModal;
    private RelatedEntityModalManager<Customer> customerModalManager = default!;
    private CompanyEditModalComponent? companyEditModal;
    private RelatedEntityModalManager<Company> companyModalManager = default!;
    private EmployeeEditModalComponent? employeeEditModal;
    private RelatedEntityModalManager<Employee> employeeModalManager = default!;
    
    // ===== ç›¸é—œå–®æ“š Modal =====
    private SalesOrderEditModalComponent? salesOrderEditModal;
    private bool showSalesOrderModal = false;
    private int? selectedSalesOrderId = null;
    
    // ä¸‹æ‹‰é¸å–®é¸é …ï¼ˆå‘ä¸‹ç›¸å®¹ï¼‰
    private List<Customer> customers = new();
    private List<Employee> employees = new();
    private List<SelectOption> customerOptions = new();
    private List<SelectOption> employeeOptions = new();
    private List<SelectOption> taxCalculationMethodOptions = new();
    
    // ===== å¯©æ ¸é–‹é—œç‹€æ…‹ =====
    private bool isApprovalEnabled = true; // æ˜¯å¦å•Ÿç”¨å ±åƒ¹å–®å¯©æ ¸åŠŸèƒ½ï¼ˆå¾ç³»çµ±åƒæ•¸è¼‰å…¥ï¼‰
    
    // ===== é–å®šç‹€æ…‹ =====
    private bool hasUndeletableDetails = false; // æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²æœ‰è½‰å–®è¨˜éŒ„ï¼‰
    
    // ===== å·²åˆªé™¤çš„æ˜ç´° ID æš«å­˜ï¼ˆå„²å­˜æ™‚æ‰çœŸæ­£åˆªé™¤ï¼‰ =====
    private List<int> _deletedDetailIds = new();
    
    // ===== æ˜ç´°è¼‰å…¥ç‹€æ…‹ =====
    private bool isDetailDataReady = false;  // æ¨™è¨˜æ˜ç´°ç›¸é—œè³‡æ–™æ˜¯å¦å·²å®Œæ•´è¼‰å…¥
    private bool isDataLoaded = false;  // æ¨™è¨˜è³‡æ–™æ˜¯å¦å·²è¼‰å…¥ï¼ˆç”¨æ–¼ Lazy Loadingï¼‰

    // ===== å¿…è¦æ–¹æ³• =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // ä½¿ç”¨ ModalManagerInitHelper åˆå§‹åŒ–æ‰€æœ‰ Manager
            modalManagers = ModalManagerInitHelper.CreateBuilder<Quotation, IQuotationService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Customer>(nameof(Quotation.CustomerId), "å®¢æˆ¶")
                .AddManager<Company>(nameof(Quotation.CompanyId), "å…¬å¸")
                .AddManager<Employee>(nameof(Quotation.EmployeeId), "æ¥­å‹™å“¡")
                .Build();
            
            // å–å¾—å€‹åˆ¥ Manager ä¾›çµ„ä»¶ä½¿ç”¨
            customerModalManager = modalManagers.Get<Customer>(nameof(Quotation.CustomerId));
            companyModalManager = modalManagers.Get<Company>(nameof(Quotation.CompanyId));
            employeeModalManager = modalManagers.Get<Employee>(nameof(Quotation.EmployeeId));
            
            // è¼‰å…¥ç³»çµ±åƒæ•¸ï¼ˆå¯©æ ¸é–‹é—œï¼‰
            await LoadSystemParametersAsync();
            
            // ç§»é™¤è‡ªå‹•è¼‰å…¥è³‡æ–™ï¼Œæ”¹ç‚ºåœ¨ OnParametersSetAsync ä¸­æ ¹æ“š IsVisible è¼‰å…¥
            // await LoadAdditionalDataAsync();
            // await InitializeFormFieldsAsync();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–å ±åƒ¹å–®ç·¨è¼¯çµ„ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            // æ‰“é–‹æ™‚ï¼Œé¦–æ¬¡è¼‰å…¥è³‡æ–™
            if (!QuotationId.HasValue)
            {
                hasUndeletableDetails = false;
            }
            
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            // Modal é—œé–‰æ™‚é‡ç½®ç‹€æ…‹
            isDetailDataReady = false;
            isDataLoaded = false;
            _deletedDetailIds.Clear();  // æ¸…é™¤æš«å­˜çš„å·²åˆªé™¤æ˜ç´° ID
        }
    }

    private async Task HandleSaveSuccess()
    {
        if (editModalComponent?.Entity != null)
        {
            await OnQuotationSaved.InvokeAsync(editModalComponent.Entity);
        }
        // CloseModal å·²ç”± GenericEditModalComponent çµ±ä¸€æ§åˆ¶
    }

    private async Task HandleCancel()
    {
        await OnCancel.InvokeAsync();
        await CloseModal();
    }

    private async Task CloseModal()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }

    private async Task<Quotation?> LoadQuotationData()
    {
        try
        {
            // ğŸ”‘ é—œéµä¿®æ­£ï¼šæ¯æ¬¡è¼‰å…¥è³‡æ–™æ™‚é‡ç½®ç‹€æ…‹è®Šæ•¸ï¼Œé¿å…ä¸Šæ¬¡ç·¨è¼¯çš„ç‹€æ…‹æ®˜ç•™åˆ°æ–°å¢æ¨¡å¼
            isDetailDataReady = false;
            hasUndeletableDetails = false;
            
            if (!QuotationId.HasValue)
            {
                // æ–°å¢æ¨¡å¼
                // å–å¾—é è¨­å…¬å¸
                var primaryCompany = await CompanyService.GetPrimaryCompanyAsync();
                
                var newQuotation = new Quotation
                {
                    Code = await EntityCodeGenerationHelper.GenerateForEntity<Quotation, IQuotationService>(QuotationService, DbContext),
                    QuotationDate = DateTime.Today,
                    Status = EntityStatus.Active,
                    CompanyId = primaryCompany?.Id ?? 0 // è¨­å®šé è¨­å…¬å¸
                };

                // åˆå§‹åŒ–ç©ºçš„å­é›†åˆ
                quotationDetails = new List<QuotationDetail>();
                
                // æ–°å¢æ¨¡å¼ä¸‹ç›´æ¥æ¨™è¨˜ç‚ºæº–å‚™å°±ç·’ï¼ˆæ²’æœ‰æ˜ç´°éœ€è¦è¼‰å…¥ï¼‰
                isDetailDataReady = true;

                return newQuotation;
            }

            // ç·¨è¼¯æ¨¡å¼
            var quotation = await QuotationService.GetWithDetailsAsync(QuotationId.Value);
            
            if (quotation != null)
            {
                // è¼‰å…¥å ±åƒ¹å–®æ˜ç´°
                quotationDetails = quotation.QuotationDetails?.ToList() ?? new List<QuotationDetail>();
                
                // æª¢æŸ¥æ˜ç´°æ˜¯å¦æœ‰å·²è½‰å–®çš„è¨˜éŒ„ï¼ˆèˆ‡ PurchaseOrderEditModalComponent é‚è¼¯ä¸€è‡´ï¼‰
                var hasConvertedDetails = quotationDetails.Any(d => d.ConvertedQuantity > 0);
                hasUndeletableDetails = hasConvertedDetails;
                
                //  æ¨™è¨˜æ˜ç´°è³‡æ–™å·²æº–å‚™å°±ç·’
                isDetailDataReady = true;
                
                // å¦‚æœå·²è½‰å–®æˆ–å·²å¯©æ ¸ï¼Œéœ€è¦é–å®šæ¬„ä½
                if (hasUndeletableDetails || quotation.IsApproved)
                {
                    // åœ¨å¯¦é«”è¼‰å…¥å¾Œé‡æ–°åˆå§‹åŒ–è¡¨å–®æ¬„ä½ä»¥åæ˜ æ­£ç¢ºçš„å”¯è®€ç‹€æ…‹
                    await Task.Delay(10); // çŸ­æš«å»¶é²ç¢ºä¿å¯¦é«”å·²è¨­å®š
                    _ = Task.Run(async () =>
                    {
                        await InvokeAsync(async () =>
                        {
                            await InitializeFormFieldsAsync();
                            UpdateFieldsReadOnlyState(); // é‡æ–°è¨ˆç®—ä¸¦é–å®šæ¬„ä½
                            StateHasChanged();
                        });
                    });
                }
            }
            else
            {
                quotationDetails = new List<QuotationDetail>();
            }

            return quotation;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å ±åƒ¹å–®è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return null;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // è¼‰å…¥å®¢æˆ¶åˆ—è¡¨
            availableCustomers = await CustomerService.GetAllAsync();
            customers = availableCustomers;
            customerOptions = customers.Select(c => new SelectOption 
            { 
                Text = c.CompanyName ?? "", 
                Value = c.Id.ToString() 
            }).ToList();
            
            // è¼‰å…¥å…¬å¸åˆ—è¡¨
            availableCompanies = await CompanyService.GetAllAsync();
            
            // è¼‰å…¥æ¥­å‹™å“¡åˆ—è¡¨ï¼ˆæ’é™¤è¶…ç´šç®¡ç†å“¡ï¼‰
            var allEmployees = await EmployeeService.GetAllAsync();
            availableEmployees = allEmployees.Where(e => !e.IsSuperAdmin).ToList();
            employees = availableEmployees;
            employeeOptions = employees.Select(e => new SelectOption 
            { 
                Text = e.Name ?? "", 
                Value = e.Id.ToString() 
            }).ToList();
            
            // è¼‰å…¥å•†å“åˆ—è¡¨ï¼ˆç”¨æ–¼æ˜ç´°ï¼‰
            availableProducts = await ProductService.GetAllAsync();
            
            // è¼‰å…¥å–®ä½åˆ—è¡¨ï¼ˆç”¨æ–¼æ˜ç´°ï¼‰
            availableUnits = await UnitService.GetAllAsync();
            
            // åˆå§‹åŒ–ç¨…åˆ¥ä¸‹æ‹‰é¸é …
            taxCalculationMethodOptions = new List<SelectOption>
            {
                new SelectOption { Value = ((int)TaxCalculationMethod.TaxExclusive).ToString(), Text = "å¤–åŠ ç¨…" },
                new SelectOption { Value = ((int)TaxCalculationMethod.TaxInclusive).ToString(), Text = "å…§å«ç¨…" },
                new SelectOption { Value = ((int)TaxCalculationMethod.NoTax).ToString(), Text = "ä¸å«ç¨…" }
            };
            
            // ä½¿ç”¨ AutoCompleteConfigHelper å»ºç«‹é…ç½®
            autoCompleteConfig = new AutoCompleteConfigBuilder<Quotation>()
                .AddField(nameof(Quotation.CustomerId), "CompanyName", availableCustomers)
                .AddField(nameof(Quotation.CompanyId), "CompanyName", availableCompanies)
                .AddField(nameof(Quotation.EmployeeId), "Name", availableEmployees)
                .Build();
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("è¼‰å…¥å ±åƒ¹å–®ç·¨è¼¯ç›¸é—œè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
            availableCustomers = new List<Customer>();
            availableCompanies = new List<Company>();
            availableEmployees = new List<Employee>();
            availableProducts = new List<Product>();
            availableUnits = new List<Unit>();
            customers = new List<Customer>();
            employees = new List<Employee>();
            customerOptions = new List<SelectOption>();
            employeeOptions = new List<SelectOption>();
        }
    }

    /// <summary>
    /// è¼‰å…¥ç³»çµ±åƒæ•¸ï¼ˆå¯©æ ¸é–‹é—œï¼‰
    /// </summary>
    private async Task LoadSystemParametersAsync()
    {
        try
        {
            var systemParams = await SystemParameterService.GetSystemParameterAsync();
            if (systemParams != null)
            {
                isApprovalEnabled = systemParams.EnableQuotationApproval;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSystemParametersAsync), GetType());
            // é è¨­å•Ÿç”¨å¯©æ ¸
            isApprovalEnabled = false;
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            // ä½¿ç”¨ ApprovalConfigHelper çµ±ä¸€åˆ¤æ–·æ˜¯å¦é–å®šæ¬„ä½
            // å ±åƒ¹å–®çš„é–å®šæ¢ä»¶ï¼š(å¯©æ ¸é€šé) æˆ– (æ˜ç´°æœ‰è½‰å–®è¨˜éŒ„)
            var shouldLock = ApprovalConfigHelper.ShouldLockFieldByApproval(
                isApprovalEnabled,
                editModalComponent?.Entity?.IsApproved ?? false,
                hasUndeletableDetails  // ä½¿ç”¨æ˜ç´°è½‰å–®ç‹€æ…‹ä½œç‚ºé¡å¤–çš„é–å®šæ¢ä»¶
            );
            
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(Quotation.Code),
                    Label = "å ±åƒ¹å–®è™Ÿ",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥å ±åƒ¹å–®è™Ÿ",
                    IsRequired = true,
                    MaxLength = 30,
                    HelpText = "å ±åƒ¹å–®çš„å”¯ä¸€è­˜åˆ¥ç·¨è™Ÿï¼Œæ–°å¢æ™‚ç³»çµ±æœƒè‡ªå‹•ç”¢ç”Ÿï¼Œä¹Ÿå¯æ‰‹å‹•ä¿®æ”¹",
                    IsReadOnly = shouldLock // æ ¹æ“šå¯©æ ¸ç‹€æ…‹å’Œæ˜ç´°è½‰å–®ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(Quotation.CustomerId),
                    Label = "å®¢æˆ¶",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡å®¢æˆ¶",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "è¼¸å…¥å®¢æˆ¶åç¨±é€²è¡Œæœå°‹ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                    ActionButtons = await GetCustomerActionButtonsAsync(),
                    IsReadOnly = shouldLock // æ ¹æ“šå¯©æ ¸ç‹€æ…‹å’Œæ˜ç´°è½‰å–®ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(Quotation.CompanyId),
                    Label = "å…¬å¸",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹é¸æ“‡å…¬å¸",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "é¸æ“‡é€²è¡Œæ­¤æ¬¡å ±åƒ¹çš„å…¬å¸",
                    IsReadOnly = shouldLock // æ ¹æ“šå¯©æ ¸ç‹€æ…‹å’Œè½‰å–®ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(Quotation.EmployeeId),
                    Label = "è£½è¡¨è€…",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡è£½è¡¨è€…",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "è¼¸å…¥è£½è¡¨è€…å§“åé€²è¡Œæœå°‹ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                    ActionButtons = await GetEmployeeActionButtonsAsync(),
                    IsReadOnly = shouldLock // æ ¹æ“šå¯©æ ¸ç‹€æ…‹å’Œè½‰å–®ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(Quotation.QuotationDate),
                    Label = "å ±åƒ¹æ—¥æœŸ",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "å ±åƒ¹å–®çš„å»ºç«‹æ—¥æœŸ",
                    IsReadOnly = shouldLock // æ ¹æ“šå¯©æ ¸ç‹€æ…‹å’Œè½‰å–®ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(Quotation.TaxCalculationMethod),
                    Label = "ç¨…åˆ¥",
                    FieldType = FormFieldType.Select,
                    Options = taxCalculationMethodOptions,
                    IsRequired = true,
                    HelpText = "å¤–åŠ ç¨…ï¼šç¨…é¡å¦å¤–åŠ ä¸Š | å…§å«ç¨…ï¼šç¸½åƒ¹å·²åŒ…å«ç¨… | ä¸å«ç¨…ï¼šå®Œå…¨å…ç¨…",
                    IsReadOnly = shouldLock // æ ¹æ“šå¯©æ ¸ç‹€æ…‹å’Œè½‰å–®ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(Quotation.PaymentTerms),
                    Label = "ä»˜æ¬¾æ¢ä»¶",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥ä»˜æ¬¾æ¢ä»¶",
                    IsRequired = false,
                    MaxLength = 100,
                    HelpText = "ä¾‹å¦‚ï¼šè²¨åˆ°ä»˜æ¬¾ã€æœˆçµ30å¤©ç­‰",
                    IsReadOnly = shouldLock // æ ¹æ“šå¯©æ ¸ç‹€æ…‹å’Œè½‰å–®ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(Quotation.DeliveryTerms),
                    Label = "äº¤è²¨æ¢ä»¶",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥äº¤è²¨æ¢ä»¶",
                    IsRequired = false,
                    MaxLength = 100,
                    HelpText = "ä¾‹å¦‚ï¼šå·¥å» äº¤è²¨ã€é€è²¨åˆ°åºœç­‰",
                    IsReadOnly = shouldLock // æ ¹æ“šå¯©æ ¸ç‹€æ…‹å’Œè½‰å–®ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(Quotation.SubtotalBeforeDiscount),
                    Label = "é‡‘é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true, // æŠ˜æ‰£å‰é‡‘é¡å§‹çµ‚ç‚ºå”¯è®€
                    HelpText = "ç³»çµ±æ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—ï¼ˆæ˜ç´°çš„æ•¸é‡ Ã— å–®åƒ¹ç¸½å’Œï¼‰",
                    CssClass = "text-warning fw-bold" // ä½¿ç”¨é»ƒè‰²ç²—é«”é¡¯ç¤º
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(Quotation.DiscountAmount),
                    Label = "æŠ˜æ‰£",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true, // æŠ˜æ‰£é‡‘é¡å§‹çµ‚ç‚ºå”¯è®€
                    HelpText = "ç³»çµ±æ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®— = (æ•¸é‡ Ã— å–®åƒ¹ Ã— æŠ˜æ‰£%)",
                    CssClass = "text-danger fw-bold" // ä½¿ç”¨ç´…è‰²ç²—é«”é¡¯ç¤º
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(Quotation.QuotationTaxAmount),
                    Label = "ç¨…é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "ç³»çµ±æ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®— = (æŠ˜æ‰£å¾Œé‡‘é¡ Ã— ç¨…ç‡%)",
                    CssClass = "text-info fw-bold"
                },
                new()
                {
                    PropertyName = nameof(Quotation.TotalAmount),
                    Label = "ç¸½é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "ç³»çµ±æ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—ï¼ˆé‡‘é¡ - æŠ˜æ‰£ + ç¨…é¡ï¼‰",
                    CssClass = "text-success fw-bold"
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(Quotation.ProjectName),
                    Label = "å·¥ç¨‹åç¨±",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥å·¥ç¨‹åç¨±",
                    IsRequired = false,
                    MaxLength = 20,
                    HelpText = "å ±åƒ¹æ‰€å±¬çš„å·¥ç¨‹åç¨±",
                    IsReadOnly = shouldLock // æ ¹æ“šå¯©æ ¸ç‹€æ…‹å’Œè½‰å–®ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },

                FormFieldConfigurationHelper.CreateRemarksField<Quotation>(
                    label: "å ±åƒ¹èªªæ˜",
                    readOnly: shouldLock // æ ¹æ“šå¯©æ ¸ç‹€æ…‹å’Œè½‰å–®ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                )
            };

            formSections = FormSectionHelper<Quotation>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    q => q.Code,
                    q => q.CustomerId,
                    q => q.CompanyId,
                    q => q.EmployeeId,
                    q => q.ProjectName,
                    q => q.QuotationDate,
                    q => q.TaxCalculationMethod)
                .AddToSection(FormSectionNames.TradingTerms,
                    q => q.PaymentTerms,
                    q => q.DeliveryTerms)
                .AddToSection(FormSectionNames.AmountInfo,
                    q => q.SubtotalBeforeDiscount,
                    q => q.DiscountAmount,
                    q => q.QuotationTaxAmount,
                    q => q.TotalAmount)
                .AddCustomFields(FormSectionNames.OtherInfo, "Remarks")
                .Build();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–è¡¨å–®æ¬„ä½æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }

    /// <summary>
    /// é©—è­‰å ±åƒ¹å–®æ˜ç´° - åœ¨å„²å­˜ä¸»æª”ä¹‹å‰åŸ·è¡Œ
    /// </summary>
    private async Task<bool> ValidateQuotationDetailsAsync(Quotation quotation)
    {
        try
        {
            if (quotationDetailManager != null)
            {
                return await quotationDetailManager.ValidateAsync();
            }
            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ValidateQuotationDetailsAsync), GetType());
            return false;
        }
    }

    /// <summary>
    /// è‡ªè¨‚å„²å­˜é‚è¼¯ - åŒæ™‚å„²å­˜ä¸»æª”å’Œæ˜ç´°
    /// ç‰¹æ®Šè™•ç†ï¼šå¯©æ ¸é€šéæˆ–å·²è½‰å–®å¾Œä»å…è¨±å„²å­˜ï¼Œç”¨æ–¼æ›´æ–°æ˜ç´°çš„åŸ·è¡Œç‹€æ…‹
    /// </summary>
    private async Task<bool> SaveQuotationWithDetails(Quotation quotation)
    {
        try
        {
            if (quotation == null)
            {
                await NotificationService.ShowErrorAsync("æ²’æœ‰è¦å„²å­˜çš„å ±åƒ¹å–®è³‡æ–™");
                return false;
            }

            // æª¢æŸ¥å…¬å¸æ¬„ä½æ˜¯å¦æœ‰è³‡æ–™
            if (quotation.CompanyId <= 0)
            {
                await NotificationService.ShowWarningAsync("è«‹é¸æ“‡å…¬å¸å¾Œå†é€²è¡Œå„²å­˜");
                return false;
            }

            // å…ˆåŸ·è¡Œæ˜ç´°é©—è­‰
            if (!await ValidateQuotationDetailsAsync(quotation))
            {
                return false;
            }

            //  ä¿®æ”¹ï¼šå¯©æ ¸é€šéæˆ–å·²è½‰å–®å¾Œä»å…è¨±å„²å­˜ï¼ˆç”¨æ–¼æ›´æ–°æ˜ç´°çš„åŸ·è¡Œç‹€æ…‹ï¼‰
            // ç§»é™¤åŸæœ‰çš„ hasUndeletableDetails æª¢æŸ¥ï¼Œèˆ‡ PurchaseOrderEditModalComponent ä¿æŒä¸€è‡´
            // æ¬„ä½é–å®šç”± InitializeFormFieldsAsync ä¸­çš„ IsReadOnly æ§åˆ¶
            // ä½†ä½¿ç”¨è€…ä»å¯ä¿®æ”¹æ˜ç´°ä¸¦å„²å­˜æ•´å€‹å–®æ“š
            
            // æ ¹æ“šç¨…åˆ¥è¨ˆç®—é‡‘é¡æ¬„ä½ï¼ˆèˆ‡ HandleQuotationDetailsChanged é‚è¼¯ä¸€è‡´ï¼‰
            var taxMethod = quotation.TaxCalculationMethod;
            
            switch (taxMethod)
            {
                case TaxCalculationMethod.TaxExclusive:
                    // å¤–åŠ ç¨…ï¼šç¸½é¡ = é‡‘é¡ - æŠ˜æ‰£ + ç¨…é¡
                    {
                        quotation.SubtotalBeforeDiscount = Math.Round(
                            quotationDetails.Sum(d => d.Quantity * d.UnitPrice), 0, MidpointRounding.AwayFromZero);
                        
                        quotation.DiscountAmount = Math.Round(
                            quotationDetails.Sum(d => d.Quantity * d.UnitPrice * (d.DiscountPercentage / 100)), 0, MidpointRounding.AwayFromZero);
                        
                        quotation.QuotationTaxAmount = Math.Round(
                            quotationDetails.Sum(d => {
                                var amountAfterDiscount = d.Quantity * d.UnitPrice * (1 - d.DiscountPercentage / 100);
                                var taxRate = d.TaxRate ?? 0;
                                return amountAfterDiscount * (taxRate / 100);
                            }), 0, MidpointRounding.AwayFromZero);
                        
                        quotation.TotalAmount = quotation.SubtotalBeforeDiscount - quotation.DiscountAmount + quotation.QuotationTaxAmount;
                    }
                    break;
                
                case TaxCalculationMethod.TaxInclusive:
                    // å…§å«ç¨…ï¼šç¸½é¡å·²å«ç¨…ï¼Œåæ¨é‡‘é¡ã€æŠ˜æ‰£ã€ç¨…é¡
                    {
                        quotation.TotalAmount = Math.Round(
                            quotationDetails.Sum(d => d.Quantity * d.UnitPrice * (1 - d.DiscountPercentage / 100)), 0, MidpointRounding.AwayFromZero);
                        
                        quotation.QuotationTaxAmount = Math.Round(
                            quotationDetails.Sum(d => {
                                var amountWithTax = d.Quantity * d.UnitPrice * (1 - d.DiscountPercentage / 100);
                                var taxRate = d.TaxRate ?? 0;
                                return amountWithTax / (1 + taxRate / 100) * (taxRate / 100);
                            }), 0, MidpointRounding.AwayFromZero);
                        
                        quotation.SubtotalBeforeDiscount = Math.Round(
                            quotationDetails.Sum(d => d.Quantity * d.UnitPrice), 0, MidpointRounding.AwayFromZero);
                        
                        quotation.DiscountAmount = Math.Round(
                            quotationDetails.Sum(d => d.Quantity * d.UnitPrice * (d.DiscountPercentage / 100)), 0, MidpointRounding.AwayFromZero);
                    }
                    break;
                
                case TaxCalculationMethod.NoTax:
                    // å…ç¨…ï¼šç¸½é¡ = é‡‘é¡ - æŠ˜æ‰£ï¼ˆç¨…é¡ç‚º 0ï¼‰
                    {
                        quotation.SubtotalBeforeDiscount = Math.Round(
                            quotationDetails.Sum(d => d.Quantity * d.UnitPrice), 0, MidpointRounding.AwayFromZero);
                        
                        quotation.DiscountAmount = Math.Round(
                            quotationDetails.Sum(d => d.Quantity * d.UnitPrice * (d.DiscountPercentage / 100)), 0, MidpointRounding.AwayFromZero);
                        
                        quotation.QuotationTaxAmount = 0;
                        
                        quotation.TotalAmount = quotation.SubtotalBeforeDiscount - quotation.DiscountAmount;
                    }
                    break;
            }

            // å„²å­˜ä¸»æª”
            ServiceResult<Quotation> result;
            if (QuotationId.HasValue)
            {
                result = await QuotationService.UpdateAsync(quotation);
            }
            else
            {
                result = await QuotationService.CreateAsync(quotation);
            }

            if (!result.IsSuccess || result.Data == null)
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "å„²å­˜å ±åƒ¹å–®å¤±æ•—");
                return false;
            }

            // å„²å­˜æ˜ç´°
            await SaveQuotationDetails(result.Data.Id);

            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveQuotationWithDetails), GetType(), 
                additionalData: "å„²å­˜å ±åƒ¹å–®å’Œæ˜ç´°å¤±æ•—");
            await NotificationService.ShowErrorAsync($"å„²å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// å„²å­˜å ±åƒ¹å–®æ˜ç´°
    /// </summary>
    private async Task SaveQuotationDetails(int quotationId)
    {
        try
        {
            // è¨­å®šä¸»æª”ID
            foreach (var detail in quotationDetails)
            {
                detail.QuotationId = quotationId;
                if (detail.Id == 0)
                {
                    detail.Status = EntityStatus.Active;
                    detail.CreatedAt = DateTime.Now;
                }
                else
                {
                    detail.UpdatedAt = DateTime.Now;
                }
            }

            // è™•ç†æ–°å¢å’Œæ›´æ–°çš„æ˜ç´°
            foreach (var detail in quotationDetails.Where(d => d.ProductId > 0))
            {
                if (detail.Id == 0)
                {
                    // æ–°å¢æ˜ç´°
                    await QuotationDetailService.CreateAsync(detail);
                }
                else
                {
                    // æ›´æ–°æ˜ç´°
                    await QuotationDetailService.UpdateAsync(detail);
                }
            }

            // è™•ç†åˆªé™¤çš„æ˜ç´°ï¼ˆä½¿ç”¨æš«å­˜çš„å·²åˆªé™¤ ID åˆ—è¡¨ï¼‰
            // é€™èˆ‡ PurchaseOrderTable çš„è¡Œç‚ºä¿æŒä¸€è‡´ï¼šåœ¨ Table ä¸Šåˆªé™¤åªæ˜¯æš«å­˜ï¼Œå„²å­˜æ™‚æ‰çœŸæ­£åˆªé™¤
            if (_deletedDetailIds.Any())
            {
                foreach (var detailId in _deletedDetailIds)
                {
                    await QuotationDetailService.DeleteAsync(detailId);
                }
                _deletedDetailIds.Clear();  // åˆªé™¤å®Œæˆå¾Œæ¸…ç©ºåˆ—è¡¨
            }
            
            // å„²å­˜å ±åƒ¹å–®çµ„åˆæ˜ç´°ï¼ˆBOMï¼‰
            await SaveQuotationCompositionDetails(quotationId);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveQuotationDetails), GetType(), 
                additionalData: $"å„²å­˜å ±åƒ¹å–®æ˜ç´°å¤±æ•— - QuotationId: {quotationId}");
            throw; // é‡æ–°æ‹‹å‡ºä¾‹å¤–ï¼Œè®“ä¸Šå±¤è™•ç†
        }
    }

    /// <summary>
    /// å„²å­˜å ±åƒ¹å–®çµ„åˆæ˜ç´°ï¼ˆBOMï¼‰
    /// è™•ç†è‡¨æ™‚ç´¢å¼•ï¼ˆè² æ•¸ï¼‰æ˜ å°„åˆ°å¯¦éš›å„²å­˜å¾Œçš„æ˜ç´°ID
    /// </summary>
    private async Task SaveQuotationCompositionDetails(int quotationId)
    {
        try
        {
            // å¾ QuotationTable çµ„ä»¶å–å¾—çµ„åˆæ˜ç´°è³‡æ–™
            if (quotationDetailManager == null)
                return;
            
            var compositionDetailsMap = quotationDetailManager.GetCompositionDetails();
            
            if (!compositionDetailsMap.Any())
                return;
            
            // å–å¾—æ‰€æœ‰å ±åƒ¹å–®æ˜ç´°ï¼ˆæŒ‰é †åºæ’åˆ—ï¼Œèˆ‡ QuotationItems å°æ‡‰ï¼‰
            var savedQuotationDetails = await QuotationDetailService.GetByQuotationIdAsync(quotationId);
            var orderedDetails = savedQuotationDetails.OrderBy(d => d.Id).ToList();
            
            foreach (var kvp in compositionDetailsMap)
            {
                var quotationDetailId = kvp.Key;
                var compositionDetails = kvp.Value;
                
                QuotationDetail? quotationDetail = null;
                
                if (quotationDetailId > 0)
                {
                    // æ­£å¸¸ IDï¼Œç›´æ¥æŸ¥æ‰¾
                    quotationDetail = orderedDetails.FirstOrDefault(d => d.Id == quotationDetailId);
                    if (quotationDetail == null)
                        continue;
                }
                else
                {
                    // è‡¨æ™‚ç´¢å¼•ï¼ˆè² æ•¸ï¼‰ï¼Œæ˜ å°„åˆ°å¯¦éš›æ˜ç´°
                    // -1 å°æ‡‰ç¬¬ 0 å€‹æ˜ç´°ï¼Œ-2 å°æ‡‰ç¬¬ 1 å€‹æ˜ç´°...
                    int arrayIndex = Math.Abs(quotationDetailId) - 1;
                    
                    if (arrayIndex < orderedDetails.Count)
                    {
                        quotationDetail = orderedDetails[arrayIndex];
                    }
                    else
                    {
                        continue;
                    }
                }
                
                // æ‰¹æ¬¡å„²å­˜çµ„åˆæ˜ç´°ï¼ˆä½¿ç”¨å¯¦éš›çš„æ˜ç´°IDï¼‰
                await QuotationCompositionDetailService.SaveBatchAsync(quotationDetail.Id, compositionDetails);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveQuotationCompositionDetails), GetType(), 
                additionalData: $"å„²å­˜å ±åƒ¹å–®çµ„åˆæ˜ç´°å¤±æ•— - QuotationId: {quotationId}");
            // ä¸æ‹‹å‡ºä¾‹å¤–ï¼Œè®“ä¸»è¦å„²å­˜æµç¨‹ç¹¼çºŒ
        }
    }

    /// <summary>
    /// é…ç½®è‡ªè¨‚æ¨¡çµ„
    /// </summary>
    private List<GenericEditModalComponent<Quotation, IQuotationService>.CustomModule> GetCustomModules()
    {
        try
        {
            return new List<GenericEditModalComponent<Quotation, IQuotationService>.CustomModule>
            {
                new()
                {
                    Title = "",
                    Content = CreateQuotationDetailManagerContent()
                }
            };
        }
        catch
        {
            return new List<GenericEditModalComponent<Quotation, IQuotationService>.CustomModule>();
        }
    }

    /// <summary>
    /// å‰µå»ºå ±åƒ¹å–®æ˜ç´°ç®¡ç†å™¨å…§å®¹çš„ RenderFragment
    /// </summary>
    private RenderFragment CreateQuotationDetailManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null)
            {
                // æª¢æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„å•†å“è³‡æ–™
                @if (availableProducts != null && availableProducts.Any())
                {
                    // æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡å®¢æˆ¶
                    @if (editModalComponent.Entity.CustomerId > 0)
                    {
                        <QuotationTable @ref="quotationDetailManager"
                                                TMainEntity="Quotation"
                                                TDetailEntity="QuotationDetail"
                                                MainEntity="@editModalComponent?.Entity"
                                                ExistingDetails="@quotationDetails"
                                                OnDetailsChanged="@HandleQuotationDetailsChanged"
                                                OnDeletedDetailsChanged="@HandleDeletedDetailsChanged"
                                                Products="@availableProducts"
                                                Units="@availableUnits"
                                                SelectedCustomerId="@editModalComponent?.Entity?.CustomerId"
                                                TaxCalculationMethod="@(editModalComponent?.Entity?.TaxCalculationMethod ?? TaxCalculationMethod.TaxExclusive)"
                                                MainEntityIdPropertyName="@nameof(QuotationDetail.QuotationId)"
                                                QuantityPropertyName="@nameof(QuotationDetail.Quantity)"
                                                UnitPricePropertyName="@nameof(QuotationDetail.UnitPrice)"
                                                DiscountPercentagePropertyName="@nameof(QuotationDetail.DiscountPercentage)"
                                                RemarksPropertyName="@nameof(BaseEntity.Remarks)"
                                                UnitIdPropertyName="@nameof(QuotationDetail.UnitId)"
                                                IsReadOnly="false"
                                                OnOpenRelatedDocument="@HandleOpenRelatedDocument"
                                                Title="å ±åƒ¹æ˜ç´°"
                                                EmptyMessage="å°šæœªæ–°å¢å ±åƒ¹å•†å“" />
                    }
                    else
                    {
                        <div class="alert alert-info text-center" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            è«‹å…ˆé¸æ“‡å®¢æˆ¶å¾Œå†é€²è¡Œå ±åƒ¹æ˜ç´°ç®¡ç†
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-warning text-center" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ç„¡å¯ç”¨çš„å•†å“è³‡æ–™ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡
                    </div>
                }
            }
        }
        catch
        {
            <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                è¼‰å…¥å ±åƒ¹æ˜ç´°ç®¡ç†å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤
            </div>
        }
    };

    /// <summary>
    /// è™•ç†å ±åƒ¹å–®æ˜ç´°è®Šæ›´ - æ ¹æ“šç¨…åˆ¥è‡ªå‹•è¨ˆç®—é‡‘é¡æ¬„ä½
    /// </summary>
    private async Task HandleQuotationDetailsChanged(List<QuotationDetail> details)
    {
        try
        {
            quotationDetails = details;
            
            if (editModalComponent?.Entity != null)
            {
                var taxMethod = editModalComponent.Entity.TaxCalculationMethod;
                
                switch (taxMethod)
                {
                    case TaxCalculationMethod.TaxExclusive:
                        // å¤–åŠ ç¨…ï¼šç¸½é¡ = é‡‘é¡ - æŠ˜æ‰£ + ç¨…é¡
                        {
                            // é‡‘é¡
                            editModalComponent.Entity.SubtotalBeforeDiscount = Math.Round(
                                details.Sum(d => d.Quantity * d.UnitPrice), 0, MidpointRounding.AwayFromZero);
                            
                            // æŠ˜æ‰£
                            editModalComponent.Entity.DiscountAmount = Math.Round(
                                details.Sum(d => d.Quantity * d.UnitPrice * (d.DiscountPercentage / 100)), 0, MidpointRounding.AwayFromZero);
                            
                            // ç¨…é¡ = Î£(æŠ˜æ‰£å¾Œé‡‘é¡ Ã— ç¨…ç‡%)
                            editModalComponent.Entity.QuotationTaxAmount = Math.Round(
                                details.Sum(d => {
                                    var amountAfterDiscount = d.Quantity * d.UnitPrice * (1 - d.DiscountPercentage / 100);
                                    var taxRate = d.TaxRate ?? 0;
                                    return amountAfterDiscount * (taxRate / 100);
                                }), 0, MidpointRounding.AwayFromZero);
                            
                            // ç¸½é¡ = é‡‘é¡ - æŠ˜æ‰£ + ç¨…é¡
                            editModalComponent.Entity.TotalAmount = 
                                editModalComponent.Entity.SubtotalBeforeDiscount - editModalComponent.Entity.DiscountAmount + editModalComponent.Entity.QuotationTaxAmount;
                        }
                        break;
                    
                    case TaxCalculationMethod.TaxInclusive:
                        // å…§å«ç¨…ï¼šç¸½é¡å·²å«ç¨…ï¼Œåæ¨é‡‘é¡ã€æŠ˜æ‰£ã€ç¨…é¡
                        {
                            // ç¸½é¡ï¼ˆå«ç¨…ï¼‰= Î£(æ•¸é‡ Ã— å–®åƒ¹ Ã— (1 - æŠ˜æ‰£%))
                            editModalComponent.Entity.TotalAmount = Math.Round(
                                details.Sum(d => d.Quantity * d.UnitPrice * (1 - d.DiscountPercentage / 100)), 0, MidpointRounding.AwayFromZero);
                            
                            // ç¨…é¡ = Î£(å°è¨ˆ / (1 + ç¨…ç‡%) Ã— ç¨…ç‡%)
                            editModalComponent.Entity.QuotationTaxAmount = Math.Round(
                                details.Sum(d => {
                                    var amountWithTax = d.Quantity * d.UnitPrice * (1 - d.DiscountPercentage / 100);
                                    var taxRate = d.TaxRate ?? 0;
                                    return amountWithTax / (1 + taxRate / 100) * (taxRate / 100);
                                }), 0, MidpointRounding.AwayFromZero);
                            
                            // é‡‘é¡ï¼ˆæœªç¨…ï¼‰
                            editModalComponent.Entity.SubtotalBeforeDiscount = Math.Round(
                                details.Sum(d => d.Quantity * d.UnitPrice), 0, MidpointRounding.AwayFromZero);
                            
                            // æŠ˜æ‰£
                            editModalComponent.Entity.DiscountAmount = Math.Round(
                                details.Sum(d => d.Quantity * d.UnitPrice * (d.DiscountPercentage / 100)), 0, MidpointRounding.AwayFromZero);
                        }
                        break;
                    
                    case TaxCalculationMethod.NoTax:
                        // å…ç¨…ï¼šç¸½é¡ = é‡‘é¡ - æŠ˜æ‰£ï¼ˆç¨…é¡ç‚º 0ï¼‰
                        {
                            // é‡‘é¡
                            editModalComponent.Entity.SubtotalBeforeDiscount = Math.Round(
                                details.Sum(d => d.Quantity * d.UnitPrice), 0, MidpointRounding.AwayFromZero);
                            
                            // æŠ˜æ‰£
                            editModalComponent.Entity.DiscountAmount = Math.Round(
                                details.Sum(d => d.Quantity * d.UnitPrice * (d.DiscountPercentage / 100)), 0, MidpointRounding.AwayFromZero);
                            
                            // ç¨…é¡ = 0ï¼ˆå…ç¨…ï¼‰
                            editModalComponent.Entity.QuotationTaxAmount = 0;
                            
                            // ç¸½é¡ = é‡‘é¡ - æŠ˜æ‰£
                            editModalComponent.Entity.TotalAmount = 
                                editModalComponent.Entity.SubtotalBeforeDiscount - editModalComponent.Entity.DiscountAmount;
                        }
                        break;
                }
                
                // æ›´æ–°ä¸»æª”çš„ QuotationDetails é›†åˆ
                editModalComponent.Entity.QuotationDetails = details;
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleQuotationDetailsChanged), GetType());
        }
    }

    /// <summary>
    /// è™•ç†å·²åˆªé™¤çš„å ±åƒ¹å–®æ˜ç´°ID
    /// æ³¨æ„ï¼šé€™è£¡åªæš«å­˜åˆªé™¤çš„ IDï¼Œåœ¨ SaveQuotationDetails å„²å­˜æ™‚æ‰çœŸæ­£åˆªé™¤è³‡æ–™åº«è¨˜éŒ„
    /// é€™èˆ‡ PurchaseOrderTable çš„è¡Œç‚ºä¿æŒä¸€è‡´
    /// </summary>
    private Task HandleDeletedDetailsChanged(List<int> deletedDetailIds)
    {
        try
        {
            if (deletedDetailIds?.Any() == true)
            {
                // å°‡åˆªé™¤çš„ ID åŠ å…¥æš«å­˜åˆ—è¡¨ï¼ˆé¿å…é‡è¤‡ï¼‰
                foreach (var detailId in deletedDetailIds)
                {
                    if (!_deletedDetailIds.Contains(detailId))
                    {
                        _deletedDetailIds.Add(detailId);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            // è¨˜éŒ„éŒ¯èª¤ä½†ä¸æ‹‹å‡ºï¼Œå› ç‚ºé€™åªæ˜¯æš«å­˜æ“ä½œ
            Console.WriteLine($"HandleDeletedDetailsChanged ç™¼ç”ŸéŒ¯èª¤: {ex.Message}");
        }
        
        return Task.CompletedTask;
    }

    /// <summary>
    /// å–å¾—æšèˆ‰çš„é¡¯ç¤ºåç¨±
    /// </summary>
    private static string GetEnumDisplayName(Enum enumValue)
    {
        var displayAttribute = enumValue.GetType()
            .GetField(enumValue.ToString())?
            .GetCustomAttribute<DisplayAttribute>();
        
        return displayAttribute?.Name ?? enumValue.ToString();
    }

    /// <summary>
    /// é…ç½® Modal ç®¡ç†å™¨
    /// </summary>
    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(Quotation.CustomerId), customerModalManager },
            { nameof(Quotation.CompanyId), companyModalManager },
            { nameof(Quotation.EmployeeId), employeeModalManager }
        };
    }

    /// <summary>
    /// åŒ…è£å®¢æˆ¶å„²å­˜äº‹ä»¶ä»¥ç¬¦åˆåŸæœ‰ä»‹é¢
    /// </summary>
    private async Task OnCustomerSavedWrapper(Customer savedCustomer)
    {
        await customerModalManager.HandleEntitySavedAsync(savedCustomer, shouldAutoSelect: true);
    }

    /// <summary>
    /// åŒ…è£å…¬å¸å„²å­˜äº‹ä»¶ä»¥ç¬¦åˆåŸæœ‰ä»‹é¢
    /// </summary>
    private async Task OnCompanySavedWrapper(Company savedCompany)
    {
        await companyModalManager.HandleEntitySavedAsync(savedCompany, shouldAutoSelect: true);
    }

    /// <summary>
    /// åŒ…è£æ¥­å‹™å“¡å„²å­˜äº‹ä»¶ä»¥ç¬¦åˆåŸæœ‰ä»‹é¢
    /// </summary>
    private async Task OnEmployeeSavedWrapper(Employee savedEmployee)
    {
        await employeeModalManager.HandleEntitySavedAsync(savedEmployee, shouldAutoSelect: true);
    }

    /// <summary>
    /// ä½¿ç”¨çµ±ä¸€ Helper ç”¢ç”Ÿå®¢æˆ¶æ“ä½œæŒ‰éˆ•
    /// </summary>
    private async Task<List<FieldActionButton>> GetCustomerActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            customerModalManager, 
            nameof(Quotation.CustomerId)
        );
    }

    /// <summary>
    /// ä½¿ç”¨çµ±ä¸€ Helper ç”¢ç”Ÿå…¬å¸æ“ä½œæŒ‰éˆ•
    /// </summary>
    private async Task<List<FieldActionButton>> GetCompanyActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            companyModalManager, 
            nameof(Quotation.CompanyId)
        );
    }

    /// <summary>
    /// æ›´æ–°æ¬„ä½çš„å”¯è®€ç‹€æ…‹ - æ ¹æ“šå¯©æ ¸ç‹€æ…‹å’Œæ˜ç´°è½‰å–®ç‹€æ…‹
    /// ä½¿ç”¨ FormFieldLockHelper çµ±ä¸€è™•ç†æ¬„ä½é–å®šé‚è¼¯
    /// </summary>
    private async void UpdateFieldsReadOnlyState()
    {
        // è¨ˆç®—æ˜¯å¦æ‡‰è©²é–å®šæ¬„ä½
        var shouldLock = ApprovalConfigHelper.ShouldLockFieldByApproval(
            isApprovalEnabled,
            editModalComponent?.Entity?.IsApproved ?? false,
            hasUndeletableDetails
        );

        // ä½¿ç”¨ FormFieldLockHelper æ‰¹æ¬¡é–å®š/è§£é–æ¬„ä½
        var fieldsToLock = new[]
        {
            nameof(Quotation.Code),
            nameof(Quotation.QuotationDate),
            nameof(Quotation.PaymentTerms),
            nameof(Quotation.DeliveryTerms),
            nameof(Quotation.ProjectName),
            nameof(BaseEntity.Remarks)
        };
        
        // é–å®šæˆ–è§£é–ä¸€èˆ¬æ¬„ä½ï¼ˆä¸éœ€è¦ ActionButtonsï¼‰
        FormFieldLockHelper.LockMultipleFieldsSimple(
            formFields, 
            fieldsToLock, 
            isLocked: shouldLock
        );
        
        // ç‰¹æ®Šè™•ç†æœ‰ ActionButtons çš„æ¬„ä½
        var fieldsWithActionButtons = new Dictionary<string, Func<Task<List<FieldActionButton>>>>
        {
            { nameof(Quotation.CustomerId), GetCustomerActionButtonsAsync },
            { nameof(Quotation.CompanyId), GetCompanyActionButtonsAsync },
            { nameof(Quotation.EmployeeId), GetEmployeeActionButtonsAsync }
        };

        foreach (var kvp in fieldsWithActionButtons)
        {
            if (shouldLock)
            {
                // é–å®šï¼šç§»é™¤ ActionButtons
                FormFieldLockHelper.LockField(
                    formFields,
                    kvp.Key,
                    isLocked: true
                );
            }
            else
            {
                // è§£é–ï¼šæ¢å¾© ActionButtons
                FormFieldLockHelper.LockField(
                    formFields,
                    kvp.Key,
                    isLocked: false,
                    actionButtonsGetter: kvp.Value
                );
            }
        }
        
        // å¼·åˆ¶æ›´æ–° UI
        await InvokeAsync(() => StateHasChanged());
    }

    /// <summary>
    /// ä½¿ç”¨çµ±ä¸€ Helper ç”¢ç”Ÿæ¥­å‹™å“¡æ“ä½œæŒ‰éˆ•
    /// </summary>
    private async Task<List<FieldActionButton>> GetEmployeeActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            employeeModalManager, 
            nameof(Quotation.EmployeeId)
        );
    }

    /// <summary>
    /// è™•ç†æ¬„ä½å€¼è®Šæ›´äº‹ä»¶ - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // æª¢æŸ¥æ˜¯å¦æ‡‰è©²é–å®šæ¬„ä½ï¼ˆé¿å…åœ¨é–å®šç‹€æ…‹ä¸‹é‡æ–°åŠ å…¥ ActionButtonsï¼‰
            var shouldLock = ApprovalConfigHelper.ShouldLockFieldByApproval(
                isApprovalEnabled,
                editModalComponent?.Entity?.IsApproved ?? false,
                hasUndeletableDetails
            );
            
            // ä½¿ç”¨çµ±ä¸€ Helper è™•ç†å®¢æˆ¶æ¬„ä½è®Šæ›´
            if (fieldChange.PropertyName == nameof(Quotation.CustomerId))
            {
                // åªæœ‰åœ¨éé–å®šç‹€æ…‹ä¸‹æ‰æ›´æ–° ActionButtons
                if (!shouldLock)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        customerModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                }
            }
            // ä½¿ç”¨çµ±ä¸€ Helper è™•ç†å…¬å¸æ¬„ä½è®Šæ›´
            else if (fieldChange.PropertyName == nameof(Quotation.CompanyId))
            {
                // åªæœ‰åœ¨éé–å®šç‹€æ…‹ä¸‹æ‰æ›´æ–° ActionButtons
                if (!shouldLock)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        companyModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                }
            }
            // ä½¿ç”¨çµ±ä¸€ Helper è™•ç†æ¥­å‹™å“¡æ¬„ä½è®Šæ›´
            else if (fieldChange.PropertyName == nameof(Quotation.EmployeeId))
            {
                // åªæœ‰åœ¨éé–å®šç‹€æ…‹ä¸‹æ‰æ›´æ–° ActionButtons
                if (!shouldLock)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        employeeModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                }
            }
            // è™•ç†ç¨…åˆ¥è®Šæ›´ - è§¸ç™¼æ˜ç´°é‡æ–°è¨ˆç®—
            else if (fieldChange.PropertyName == nameof(Quotation.TaxCalculationMethod))
            {
                // ç•¶ç¨…åˆ¥æ”¹è®Šæ™‚ï¼Œé‡æ–°è¨ˆç®—ä¸»æª”é‡‘é¡æ¬„ä½
                if (quotationDetails?.Any() == true)
                {
                    await HandleQuotationDetailsChanged(quotationDetails);
                }
                StateHasChanged();
            }
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("æ¬„ä½è®Šæ›´è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    /// <summary>
    /// å–å¾—è­¦å‘Šè¨Šæ¯ï¼ˆé¡¯ç¤ºåœ¨è¡¨å–®æ¬„ä½ä¸Šæ–¹ï¼‰- ä½œç‚ºå±¬æ€§ä»¥ç¢ºä¿æ­£ç¢ºçš„æ¸²æŸ“æ™‚æ©Ÿ
    /// ç•¶å ±åƒ¹å–®å·²å¯©æ ¸é€šéæˆ–æœ‰æ˜ç´°å·²è½‰å–®æ™‚ï¼Œé¡¯ç¤ºé–å®šè­¦å‘Šè¨Šæ¯
    /// </summary>
    private RenderFragment? WarningMessage => __builder =>
    {
        // åªåœ¨è³‡æ–™æº–å‚™å°±ç·’å¾Œæ‰é¡¯ç¤ºè¨Šæ¯
        if (!isDetailDataReady)
            return;
        
        // å¯©æ ¸é€šéçš„è­¦å‘Šè¨Šæ¯
        <GenericLockedFieldMessage IsVisible="@(isApprovalEnabled && editModalComponent?.Entity?.IsApproved == true)"
                                  Message="å ±åƒ¹å–®å·²å¯©æ ¸é€šéï¼Œä¸»æª”æ¬„ä½å·²é–å®šã€‚" />
        
        // æ˜ç´°å·²è½‰å–®çš„è­¦å‘Šè¨Šæ¯
        <GenericLockedFieldMessage IsVisible="@(hasUndeletableDetails && !(isApprovalEnabled && editModalComponent?.Entity?.IsApproved == true))"
                                  Message="å› éƒ¨åˆ†æ˜ç´°æœ‰å…¶ä»–å‹•ä½œï¼Œç‚ºä¿è­·è³‡æ–™å®Œæ•´æ€§ä¸»æª”æ¬„ä½å·²è¨­å”¯è®€ã€‚"/>
    };
    
    /// <summary>
    /// å–å¾—è‡ªè¨‚æ“ä½œæŒ‰éˆ•ï¼ˆé¡¯ç¤ºåœ¨ Modal é ‚éƒ¨å·¦å´ï¼‰- ä½œç‚ºå±¬æ€§ä»¥ç¢ºä¿æ­£ç¢ºçš„æ¸²æŸ“æ™‚æ©Ÿ
    /// </summary>
    private RenderFragment? CustomActionButtons
    {
        get
        {
            // ä¿®æ”¹é‚è¼¯ï¼šè½‰éŠ·è²¨æŒ‰éˆ•æ°¸é é¡¯ç¤ºï¼ˆåªè¦å ±åƒ¹å–®å·²å„²å­˜ï¼‰
            // æ˜ç´°æ˜¯å¦å¯è½‰ç”± SalesOrderTable çµ„ä»¶è™•ç†ï¼ˆæ ¹æ“šå¯©æ ¸ç‹€æ…‹å’Œå·²è½‰æ•¸é‡ï¼‰
            bool shouldShowButton = false;
            
            try
            {
                if (editModalComponent?.Entity != null && 
                    QuotationId.HasValue && 
                    QuotationId.Value > 0)
                {
                    shouldShowButton = true;
                }
            }
            catch
            {
                shouldShowButton = false;
            }
            
            return __builder =>
            {
                @* è½‰éŠ·è²¨è¨‚å–®æŒ‰éˆ• - å ±åƒ¹å–®å·²å„²å­˜å³å¯é¡¯ç¤º *@
                @if (shouldShowButton)
                {
                    <GenericButtonComponent Text="è½‰è¨‚å–®" 
                                          Variant="ButtonVariant.Green" 
                                          Size="ButtonSize.Small"
                                          CssClass="me-2"
                                          OnClick="HandleCreateSalesOrderFromQuotation" />
                }
            };
        }
    }

    /// <summary>
    /// å¾å ±åƒ¹å–®è½‰éŠ·è²¨è¨‚å–®
    /// </summary>
    private async Task HandleCreateSalesOrderFromQuotation()
    {
        try
        {
            if (!QuotationId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("ç„¡æ³•è½‰éŠ·è²¨è¨‚å–®ï¼šå ±åƒ¹å–®è³‡æ–™ä¸å­˜åœ¨");
                return;
            }
            
            // ç§»é™¤å¯©æ ¸æª¢æŸ¥ï¼šæ”¹ç‚ºåœ¨è¼‰å…¥æ˜ç´°æ™‚æ ¹æ“šå¯©æ ¸é–‹é—œéæ¿¾
            // å¦‚æœå•Ÿç”¨å¯©æ ¸ï¼Œåªæœƒè¼‰å…¥å·²å¯©æ ¸çš„å ±åƒ¹å–®æ˜ç´°
            // å¦‚æœæœªå•Ÿç”¨å¯©æ ¸ï¼Œè¼‰å…¥æ‰€æœ‰å ±åƒ¹å–®æ˜ç´°
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å®¢æˆ¶è³‡æ–™
            if (editModalComponent.Entity.CustomerId <= 0)
            {
                await NotificationService.ShowWarningAsync("å ±åƒ¹å–®ç¼ºå°‘å®¢æˆ¶è³‡è¨Šï¼Œç„¡æ³•è½‰éŠ·è²¨è¨‚å–®");
                return;
            }

            // æª¢æŸ¥æ˜¯å¦é‚„æœ‰æœªå®Œæˆçš„æ˜ç´°ï¼ˆé‚„éœ€è¦è½‰å–®çš„å•†å“ï¼‰
            if (!quotationDetails.Any())
            {
                await NotificationService.ShowWarningAsync("å ±åƒ¹å–®æ²’æœ‰æ˜ç´°è³‡æ–™ï¼Œç„¡æ³•è½‰éŠ·è²¨è¨‚å–®");
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰æ˜ç´°éƒ½å·²å®Œæˆè½‰å–®ï¼ˆå·²è½‰æ•¸é‡ >= å ±åƒ¹æ•¸é‡ï¼‰
            var hasIncompleteDetails = quotationDetails.Any(detail => 
                detail.ConvertedQuantity < detail.Quantity
            );
            
            if (!hasIncompleteDetails)
            {
                await NotificationService.ShowWarningAsync("å ±åƒ¹å–®æ‰€æœ‰æ˜ç´°çš†å·²è½‰ç‚ºéŠ·è²¨è¨‚å–®ï¼Œç„¡éœ€å†è½‰å–®");
                return;
            }

            // ä½¿ç”¨å…¬é–‹æ–¹æ³•æ‰“é–‹éŠ·è²¨è¨‚å–® Modal ä¸¦è‡ªå‹•è¼‰å…¥å ±åƒ¹å–®æ˜ç´°
            if (salesOrderEditModal != null)
            {
                await salesOrderEditModal.ShowAddModalWithPrefilledQuotation(
                    editModalComponent.Entity.CustomerId,
                    editModalComponent.Entity.CompanyId,
                    editModalComponent.Entity.EmployeeId,
                    QuotationId.Value
                );
            }
            else
            {
                await NotificationService.ShowWarningAsync("éŠ·è²¨è¨‚å–®çµ„ä»¶æœªåˆå§‹åŒ–ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCreateSalesOrderFromQuotation), GetType(),
                additionalData: new { QuotationId = QuotationId });
            await NotificationService.ShowErrorAsync("è½‰éŠ·è²¨è¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    /// <summary>
    /// è™•ç†éŠ·è²¨è¨‚å–®å„²å­˜å¾Œçš„äº‹ä»¶
    /// </summary>
    /// <summary>
    /// è™•ç†éŠ·è²¨è¨‚å–®å„²å­˜å¾Œçš„äº‹ä»¶ï¼ˆå ±åƒ¹å–®è½‰å–®ï¼‰
    /// ä½¿ç”¨ ChildDocumentRefreshHelper çµ±ä¸€è™•ç†åˆ·æ–°é‚è¼¯
    /// </summary>
    private async Task HandleSalesOrderSaved(SalesOrder savedSalesOrder)
    {
        try
        {
            await ChildDocumentRefreshHelper.HandleQuotationConversionAsync(
                closeModal: () =>
                {
                    showSalesOrderModal = false;
                    selectedSalesOrderId = null;
                },
                quotationId: QuotationId,
                savedSalesOrderId: savedSalesOrder.Id,
                updateEntity: async () =>
                {
                    // ä¸éœ€è¦æ›´æ–°å ±åƒ¹å–®çš„è½‰å–®ç‹€æ…‹ï¼ˆå·²ç§»é™¤ ConvertedToSalesOrderId æ¬„ä½ï¼‰
                    // éŠ·è²¨è¨‚å–®é€é QuotationId é—œè¯åˆ°å ±åƒ¹å–®å³å¯
                    await Task.CompletedTask;
                },
                reloadQuotation: async () =>
                {
                    //  é—œéµä¿®å¾©ï¼šä½¿ç”¨å°ˆé–€çš„ LoadQuotationDetails æ–¹æ³•å¾è³‡æ–™åº«é‡æ–°è¼‰å…¥æ˜ç´°
                    // é€™ç¢ºä¿ ConvertedQuantity ç­‰æ¬„ä½éƒ½æ˜¯æœ€æ–°çš„è³‡æ–™
                    if (QuotationId.HasValue)
                    {
                        await LoadQuotationDetails(QuotationId.Value);
                    }
                },
                checkUndeletable: () => quotationDetails.Any(d => d.ConvertedQuantity > 0),
                updateHasUndeletableDetails: (hasUndeletable) => hasUndeletableDetails = hasUndeletable,
                reinitializeFields: InitializeFormFieldsAsync,
                stateHasChanged: StateHasChanged,
                additionalActions: async () =>
                {
                    //  é—œéµä¿®å¾©ï¼šå‘¼å« Table çµ„ä»¶çš„å…¬é–‹åˆ·æ–°æ–¹æ³•
                    // å› ç‚ºçˆ¶ Modal æ²’æœ‰é—œé–‰ï¼ŒTable çµ„ä»¶ä¸æœƒè‡ªå‹•é‡æ–°è¼‰å…¥
                    // éœ€è¦ä¸»å‹•å‘¼å«åˆ·æ–°æ–¹æ³•ä¾†æ›´æ–° UI é¡¯ç¤º
                    if (quotationDetailManager != null)
                    {
                        await quotationDetailManager.RefreshDetailsAsync();
                    }
                }
            );

            await NotificationService.ShowSuccessAsync($"å·²æˆåŠŸå¾å ±åƒ¹å–®è½‰ç‚ºéŠ·è²¨è¨‚å–®ï¼ˆè¨‚å–®ç·¨è™Ÿï¼š{savedSalesOrder.Code}ï¼‰");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSalesOrderSaved), GetType());
        }
    }

    /// <summary>
    /// è™•ç†é–‹å•Ÿç›¸é—œå–®æ“šçš„äº‹ä»¶ï¼ˆå¾æ˜ç´°è¡¨æ ¼çš„æŸ¥çœ‹æŒ‰éˆ•è§¸ç™¼ï¼‰
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            switch (args.type)
            {
                case RelatedDocumentType.SalesOrder:
                    // é–‹å•ŸéŠ·è²¨è¨‚å–® Modalï¼ˆä»¥å”¯è®€æ¨¡å¼ï¼‰
                    selectedSalesOrderId = args.id;
                    showSalesOrderModal = true;
                    StateHasChanged();
                    break;
                    
                default:
                    await NotificationService.ShowWarningAsync($"ä¸æ”¯æ´çš„å–®æ“šé¡å‹ï¼š{args.type}");
                    break;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleOpenRelatedDocument), GetType(), 
                additionalData: $"é–‹å•Ÿç›¸é—œå–®æ“šå¤±æ•— - Type: {args.type}, Id: {args.id}");
            await NotificationService.ShowErrorAsync("é–‹å•Ÿå–®æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }


    
    // ===== å¯©æ ¸ç›¸é—œæ–¹æ³• =====
    
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦æ‡‰è©²é¡¯ç¤ºå¯©æ ¸å€åŸŸ
    /// </summary>
    private bool ShouldShowApprovalSection()
    {
        return isApprovalEnabled && QuotationId.HasValue;
    }
    
    /// <summary>
    /// è™•ç†å ±åƒ¹å–®å¯©æ ¸é€šé
    /// </summary>
    private async Task<bool> HandleQuotationApprove()
    {
        try
        {
            if (!QuotationId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowErrorAsync("æ‰¾ä¸åˆ°å ±åƒ¹å–®è³‡æ–™");
                return false;
            }

            var quotation = editModalComponent.Entity;

            // æª¢æŸ¥æ˜¯å¦å·²ç¶“å¯©æ ¸
            if (quotation.IsApproved)
            {
                await NotificationService.ShowWarningAsync("æ­¤å ±åƒ¹å–®å·²ç¶“å¯©æ ¸é€šé");
                return false;
            }

            // é©—è­‰æ˜ç´°
            if (!quotationDetails.Any())
            {
                await NotificationService.ShowWarningAsync("å ±åƒ¹å–®æ²’æœ‰æ˜ç´°è³‡æ–™ï¼Œç„¡æ³•å¯©æ ¸");
                return false;
            }

            // å–å¾—ç•¶å‰ä½¿ç”¨è€…ID
            var currentUserId = await GetCurrentUserIdAsync();
            if (!currentUserId.HasValue)
            {
                await NotificationService.ShowErrorAsync("ç„¡æ³•å–å¾—ç•¶å‰ä½¿ç”¨è€…è³‡è¨Š");
                return false;
            }

            // æ›´æ–°å¯©æ ¸ç‹€æ…‹
            quotation.IsApproved = true;
            quotation.ApprovedBy = currentUserId.Value;
            quotation.ApprovedAt = DateTime.Now;
            quotation.RejectReason = null; // æ¸…é™¤é§å›åŸå› 

            // å„²å­˜
            var result = await QuotationService.UpdateAsync(quotation);
            if (!result.IsSuccess)
            {
                await NotificationService.ShowErrorAsync($"å¯©æ ¸å¤±æ•—ï¼š{result.ErrorMessage}");
                return false;
            }

            await NotificationService.ShowSuccessAsync("å ±åƒ¹å–®å¯©æ ¸é€šé");
            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleQuotationApprove), GetType());
            await NotificationService.ShowErrorAsync("å¯©æ ¸è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤");
            return false;
        }
    }
    
    /// <summary>
    /// è™•ç†å ±åƒ¹å–®å¯©æ ¸é§å›ï¼ˆå¸¶é§å›åŸå› ï¼‰
    /// </summary>
    private async Task<bool> HandleQuotationRejectWithReason(string rejectReason)
    {
        try
        {
            if (!QuotationId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowErrorAsync("æ‰¾ä¸åˆ°å ±åƒ¹å–®è³‡æ–™");
                return false;
            }

            if (string.IsNullOrWhiteSpace(rejectReason))
            {
                await NotificationService.ShowWarningAsync("è«‹è¼¸å…¥é§å›åŸå› ");
                return false;
            }

            var quotation = editModalComponent.Entity;

            // æª¢æŸ¥æ˜¯å¦å·²ç¶“é§å›
            if (!quotation.IsApproved && !string.IsNullOrEmpty(quotation.RejectReason))
            {
                await NotificationService.ShowWarningAsync("æ­¤å ±åƒ¹å–®å·²ç¶“è¢«é§å›");
                return false;
            }

            // å–å¾—ç•¶å‰ä½¿ç”¨è€…ID
            var currentUserId = await GetCurrentUserIdAsync();
            if (!currentUserId.HasValue)
            {
                await NotificationService.ShowErrorAsync("ç„¡æ³•å–å¾—ç•¶å‰ä½¿ç”¨è€…è³‡è¨Š");
                return false;
            }

            // æ›´æ–°é§å›ç‹€æ…‹
            quotation.IsApproved = false;
            quotation.ApprovedBy = currentUserId.Value;
            quotation.ApprovedAt = DateTime.Now;
            quotation.RejectReason = rejectReason;

            // å„²å­˜
            var result = await QuotationService.UpdateAsync(quotation);
            if (!result.IsSuccess)
            {
                await NotificationService.ShowErrorAsync($"é§å›å¤±æ•—ï¼š{result.ErrorMessage}");
                return false;
            }

            await NotificationService.ShowSuccessAsync($"å ±åƒ¹å–®å·²é§å›ï¼š{rejectReason}");
            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleQuotationRejectWithReason), GetType());
            await NotificationService.ShowErrorAsync("é§å›è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤");
            return false;
        }
    }
    
    /// <summary>
    /// è™•ç†å¯¦é«”è¼‰å…¥å®Œæˆäº‹ä»¶ï¼ˆç”± GenericEditModalComponent çš„å°èˆªè§¸ç™¼ï¼‰
    /// ç•¶ä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼Œé‡æ–°è¼‰å…¥å°æ‡‰çš„æ˜ç´°è³‡æ–™
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            // 1. é‡æ–°è¼‰å…¥æ˜ç´°è³‡æ–™
            await LoadQuotationDetails(loadedEntityId);
            
            //  é—œéµä¿®æ­£ï¼šç«‹å³è§¸ç™¼ UI æ›´æ–°ï¼Œç¢ºä¿ Table å…ƒä»¶æ”¶åˆ°æ–°çš„ ExistingDetails åƒæ•¸
            // é€™æ¨£ RefreshDetailsAsync() æ‰èƒ½è®€å–åˆ°æ­£ç¢ºçš„æ˜ç´°è³‡æ–™
            StateHasChanged();
            
            // 2. è§¸ç™¼ Table å…ƒä»¶åˆ·æ–°ï¼ˆæ­¤æ™‚ ExistingDetails å·²ç¶“æ˜¯æ–°çš„è³‡æ–™ï¼‰
            if (quotationDetailManager != null)
            {
                await quotationDetailManager.RefreshDetailsAsync();
            }
            
            // 3. æœ€å¾Œå†æ¬¡æ›´æ–° UIï¼ˆç¢ºä¿æ‰€æœ‰è®Šæ›´éƒ½åæ˜ åœ¨ç•«é¢ä¸Šï¼‰
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleEntityLoaded), GetType(), 
                additionalData: $"è™•ç†å¯¦é«”è¼‰å…¥äº‹ä»¶å¤±æ•— - EntityId: {loadedEntityId}");
            await NotificationService.ShowErrorAsync("è¼‰å…¥æ˜ç´°è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    /// <summary>
    /// è¼‰å…¥å ±åƒ¹å–®æ˜ç´°
    /// </summary>
    private async Task LoadQuotationDetails(int quotationId)
    {
        try
        {
            // å¾æœå‹™è¼‰å…¥å ±åƒ¹å–®æ˜ç´°ï¼ˆåŒ…å«æœ€æ–°çš„ ConvertedQuantityï¼‰
            var quotation = await QuotationService.GetWithDetailsAsync(quotationId);
            quotationDetails = quotation?.QuotationDetails?.ToList() ?? new List<QuotationDetail>();
            
            // è¼‰å…¥æ˜ç´°å¾Œï¼Œæª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆæœ‰è½‰å–®è¨˜éŒ„ï¼‰
            var hasConverted = quotationDetails.Any(d => d.ConvertedQuantity > 0);
            if (hasUndeletableDetails != hasConverted)
            {
                hasUndeletableDetails = hasConverted;
                // å¦‚æœé–å®šç‹€æ…‹æ”¹è®Šï¼Œéœ€è¦é‡æ–°åˆå§‹åŒ–è¡¨å–®æ¬„ä½
                await InitializeFormFieldsAsync();
                UpdateFieldsReadOnlyState();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadQuotationDetails), GetType(), 
                additionalData: $"è¼‰å…¥å ±åƒ¹å–®æ˜ç´°å¤±æ•— - QuotationId: {quotationId}");
            quotationDetails = new List<QuotationDetail>();
        }
    }
    
    /// <summary>
    /// å–å¾—ç•¶å‰ä½¿ç”¨è€…ID
    /// </summary>
    private async Task<int?> GetCurrentUserIdAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            if (user?.Identity?.IsAuthenticated == true)
            {
                var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
                if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
                {
                    return userId;
                }
            }
            
            return null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetCurrentUserIdAsync), GetType());
            return null;
        }
    }

    /// <summary>
    /// è™•ç†åˆ—å°äº‹ä»¶
    /// </summary>
    private async Task HandlePrint()
    {
        try
        {
            // ä½¿ç”¨é€šç”¨ Helper é€²è¡Œå®Œæ•´é©—è­‰ï¼ˆå¯¦é«”ã€IDï¼‰
            // å ±åƒ¹å–®ä¸éœ€è¦æ ¸å‡†å³å¯åˆ—å°
            var (isValid, errorMessage) = ReportPrintHelper.ValidateForPrint(
                entity: editModalComponent?.Entity,
                entityId: QuotationId,
                isApproved: true, // å ±åƒ¹å–®ä¸éœ€å¯©æ ¸
                entityName: "å ±åƒ¹å–®",
                requireApproval: false
            );
            
            if (!isValid)
            {
                await NotificationService.ShowWarningAsync(errorMessage);
                return;
            }
            
            // ç›´æ¥åŸ·è¡Œåˆ—å°ï¼Œä½¿ç”¨é è¨­è¨­å®š
            await HandleDirectPrint(null);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePrint), GetType(), 
                additionalData: $"å ±åƒ¹å–®åˆ—å°è™•ç†å¤±æ•— - ID: {QuotationId}");
            await NotificationService.ShowErrorAsync("åˆ—å°è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    /// <summary>
    /// ç›´æ¥åŸ·è¡Œåˆ—å° - å¯ä»¥ä½¿ç”¨æŒ‡å®šçš„åˆ—å°é…ç½®æˆ–é è¨­é…ç½®
    /// </summary>
    private async Task HandleDirectPrint(ReportPrintConfiguration? printConfig)
    {
        try
        {
            if (!QuotationId.HasValue)
            {
                await NotificationService.ShowWarningAsync("è«‹å…ˆå„²å­˜å ±åƒ¹å–®å¾Œå†é€²è¡Œåˆ—å°");
                return;
            }

            // é©—è­‰åˆ—å°é…ç½®
            var (isValid, errorMessage) = ReportPrintHelper.ValidateConfiguration(printConfig);
            if (!isValid)
            {
                await NotificationService.ShowWarningAsync(errorMessage);
                return;
            }

            // ä½¿ç”¨é€šç”¨ Helper å»ºç«‹åˆ—å° URLï¼ˆæ–°ç‰ˆè·¯ç”±ï¼‰
            var printUrl = ReportPrintHelper.BuildPrintUrl(
                baseUrl: NavigationManager.BaseUri,
                reportType: "sales-report/quotation",
                documentId: QuotationId.Value,
                configuration: printConfig,
                autoprint: true
            );

            // ä½¿ç”¨é€šç”¨ Helper åŸ·è¡Œåˆ—å°ï¼ˆéš±è— iframe æ–¹å¼ï¼‰
            var success = await ReportPrintHelper.ExecutePrintWithHiddenIframeAsync(
                printUrl: printUrl,
                jsRuntime: JSRuntime,
                iframeId: "printFrame"
            );
            
            if (success)
            {
                // å¯é¸ï¼šé¡¯ç¤ºæˆåŠŸè¨Šæ¯
                // await NotificationService.ShowSuccessAsync("å ±åƒ¹å–®åˆ—å°å·²é€å‡º");
            }
            else
            {
                await NotificationService.ShowErrorAsync("åˆ—å°åŸ·è¡Œå¤±æ•—");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDirectPrint), GetType(), 
                additionalData: $"å ±åƒ¹å–®ç›´æ¥åˆ—å°å¤±æ•— - ID: {QuotationId}, Config: {printConfig?.ReportName}");
            await NotificationService.ShowErrorAsync("åˆ—å°åŸ·è¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
}
