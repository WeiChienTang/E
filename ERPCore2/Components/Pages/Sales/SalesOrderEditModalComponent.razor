@inject ISalesOrderService SalesOrderService
@inject ISalesOrderDetailService SalesOrderDetailService
@inject ISalesReturnDetailService SalesReturnDetailService
@inject IInventoryStockService InventoryStockService
@inject ICustomerService CustomerService
@inject ICompanyService CompanyService
@inject IProductService ProductService
@inject IEmployeeService EmployeeService
@inject IUnitService UnitService
@inject IWarehouseService WarehouseService
@inject ISystemParameterService SystemParameterService
@inject INotificationService NotificationService
@inject NavigationManager NavigationManager
@inject ActionButtonHelper ActionButtonHelper
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ISalesReturnService SalesReturnService
@inject ISetoffDocumentService SetoffDocumentService
@inject IReportPrintConfigurationService ReportPrintConfigurationService
@inject IQuotationService QuotationService
@inject IQuotationDetailService QuotationDetailService
@inject ERPCore2.Data.Context.AppDbContext DbContext
@inject IDbContextFactory<AppDbContext> DbContextFactory

<GenericEditModalComponent TEntity="SalesOrder" 
                          TService="ISalesOrderService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          Id="@SalesOrderId"
                          Service="@SalesOrderService"
                          EntityName="éŠ·è²¨è¨‚å–®"
                          EntityNamePlural="éŠ·è²¨è¨‚å–®"
                          ModalTitle="@(SalesOrderId.HasValue ? "ç·¨è¼¯éŠ·è²¨è¨‚å–®" : "æ–°å¢éŠ·è²¨è¨‚å–®")"
                          Size="GenericEditModalComponent<SalesOrder, ISalesOrderService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@autoCompleteConfig?.Prefillers"
                          AutoCompleteCollections="@autoCompleteConfig?.Collections"
                          AutoCompleteDisplayProperties="@autoCompleteConfig?.DisplayProperties"
                          AutoCompleteValueProperties="@autoCompleteConfig?.ValueProperties"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadSalesOrderData"
                          AdditionalDataLoader="@LoadAdditionalDataAsync"
                          SaveHandler="@SaveSalesOrderWrapper"
                          SaveSuccessMessage="@(SalesOrderId.HasValue ? "éŠ·è²¨è¨‚å–®æ›´æ–°æˆåŠŸ" : "éŠ·è²¨è¨‚å–®æ–°å¢æˆåŠŸ")"
                          SaveFailureMessage="éŠ·è²¨è¨‚å–®å„²å­˜å¤±æ•—"
                          RequiredPermission="SalesOrder.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          GetStatusMessage="@GetStatusMessage"
                          FormHeaderContent="@GetWarningMessage()"
                          CustomModules="@GetCustomModules()"
                          CustomActionButtons="@GetCustomActionButtons()"
                          ShowPrintButton="true"
                          OnPrint="@HandlePrint"
                          >

</GenericEditModalComponent>

@* å®¢æˆ¶ç·¨è¼¯ Modal *@
<CustomerEditModalComponent @ref="customerEditModal"
                           IsVisible="@customerModalManager.IsModalVisible"
                           IsVisibleChanged="@customerModalManager.HandleModalVisibilityChangedAsync"
                           CustomerId="@customerModalManager.SelectedEntityId"
                           OnCustomerSaved="@OnCustomerSavedWrapper"
                           OnCancel="@customerModalManager.HandleModalCancelAsync" />

@* æ¥­å‹™å“¡ç·¨è¼¯ Modal *@
<EmployeeEditModalComponent @ref="employeeEditModal"
                           IsVisible="@employeeModalManager.IsModalVisible"
                           IsVisibleChanged="@employeeModalManager.HandleModalVisibilityChangedAsync"
                           EmployeeId="@employeeModalManager.SelectedEntityId"
                           OnEmployeeSaved="@OnEmployeeSavedWrapper"
                           OnCancel="@employeeModalManager.HandleModalCancelAsync" />

@* éŠ·è²¨é€€å›ç·¨è¼¯ Modal *@
<SalesReturnEditModalComponent @ref="salesReturnEditModal"
                              IsVisible="@showSalesReturnModal"
                              IsVisibleChanged="@((bool visible) => showSalesReturnModal = visible)"
                              SalesReturnId="@selectedSalesReturnId"
                              OnSalesReturnSaved="@HandleSalesReturnSaved"
                              OnCancel="@(() => showSalesReturnModal = false)" />

@* æ²–æ¬¾å–®ç·¨è¼¯ Modal *@
<SetoffDocumentEditModalComponent @ref="setoffDocumentEditModal"
                                 IsVisible="@showSetoffDocumentModal"
                                 IsVisibleChanged="@((bool visible) => showSetoffDocumentModal = visible)"
                                 SetoffDocumentId="@selectedSetoffDocumentId"
                                 OnSetoffDocumentSaved="@HandleSetoffDocumentSaved"
                                 OnCancel="@(() => showSetoffDocumentModal = false)" />

@code {
    // ===== å¿…è¦åƒæ•¸ =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SalesOrderId { get; set; }
    [Parameter] public EventCallback<SalesOrder> OnSalesOrderSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    
    // ===== é å¡«åƒæ•¸ï¼ˆç”¨æ–¼å¾å ±åƒ¹å–®è½‰å–®ï¼‰ =====
    [Parameter] public int? PrefilledCustomerId { get; set; }
    [Parameter] public int? PrefilledQuotationId { get; set; }
    
    // ===== å¯©æ ¸æ§åˆ¶ =====
    private bool isApprovalEnabled = false; // ç³»çµ±åƒæ•¸ï¼šæ˜¯å¦å•Ÿç”¨å ±åƒ¹å–®å¯©æ ¸
    private bool? isSourceQuotationApproved = null; // ä¾†æºå ±åƒ¹å–®æ˜¯å¦å·²å¯©æ ¸

    // ===== å…§éƒ¨ç‹€æ…‹ =====
    private GenericEditModalComponent<SalesOrder, ISalesOrderService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // AutoComplete é…ç½®
    private AutoCompleteConfig? autoCompleteConfig;
    
    // åŸå§‹è³‡æ–™é›†åˆï¼ˆç”¨æ–¼ AutoCompleteï¼‰
    private List<Customer> availableCustomers = new();
    private List<Company> availableCompanies = new();
    private List<Employee> availableEmployees = new();
    private List<Product> availableProducts = new();
    private List<Unit> availableUnits = new();
    private List<Warehouse> availableWarehouses = new();
    
    // éŠ·è²¨è¨‚å–®æ˜ç´°
    private List<SalesOrderDetail> salesOrderDetails = new();
    
    // æ˜ç´°ç®¡ç†çµ„ä»¶å¼•ç”¨
    private SalesOrderTable<SalesOrder, SalesOrderDetail>? salesOrderDetailManager;
    
    // Modal Manager é›†åˆ
    private ModalManagerCollection? modalManagers;
    
    // Modal ç®¡ç†å™¨
    private CustomerEditModalComponent? customerEditModal;
    private RelatedEntityModalManager<Customer> customerModalManager = default!;
    private EmployeeEditModalComponent? employeeEditModal;
    private RelatedEntityModalManager<Employee> employeeModalManager = default!;
    
    // ===== ç›¸é—œå–®æ“š Modal =====
    private SalesReturnEditModalComponent? salesReturnEditModal;
    private SetoffDocumentEditModalComponent? setoffDocumentEditModal;
    private bool showSalesReturnModal = false;
    private bool showSetoffDocumentModal = false;
    private int? selectedSalesReturnId = null;
    private int? selectedSetoffDocumentId = null;
    // ä¸‹æ‹‰é¸å–®é¸é …ï¼ˆå‘ä¸‹ç›¸å®¹ï¼‰
    private List<Customer> customers = new();
    private List<Company> companies = new();
    private List<Employee> employees = new();
    private List<SelectOption> customerOptions = new();
    private List<SelectOption> companyOptions = new();
    private List<SelectOption> employeeOptions = new();
    private List<SelectOption> statusOptions = new();
    
    // ç¨…ç‡å¿«å–è®Šæ•¸ï¼ˆä¸€æ¬¡æ€§è¼‰å…¥ï¼Œé¿å…æ¯æ¬¡è¨ˆç®—éƒ½æŸ¥è©¢è³‡æ–™åº«ï¼‰
    private decimal currentTaxRate = 5.0m; // é è¨­ 5%ï¼Œå¯¦éš›å€¼æœƒåœ¨åˆå§‹åŒ–æ™‚å¾è³‡æ–™åº«è¼‰å…¥
    
    // ===== é–å®šç‹€æ…‹ =====
    private bool hasUndeletableDetails = false;
    private bool isDetailDataReady = false;

    // ===== å¿…è¦æ–¹æ³• =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // ä½¿ç”¨ ModalManagerInitHelper åˆå§‹åŒ–æ‰€æœ‰ Manager
            modalManagers = ModalManagerInitHelper.CreateBuilder<SalesOrder, ISalesOrderService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Customer>(nameof(SalesOrder.CustomerId), "å®¢æˆ¶")
                .AddManager<Employee>(nameof(SalesOrder.EmployeeId), "æ¥­å‹™å“¡")
                .Build();
            
            // å–å¾—å€‹åˆ¥ Manager ä¾›çµ„ä»¶ä½¿ç”¨
            customerModalManager = modalManagers.Get<Customer>(nameof(SalesOrder.CustomerId));
            employeeModalManager = modalManagers.Get<Employee>(nameof(SalesOrder.EmployeeId));
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–éŠ·è²¨è¨‚å–®ç·¨è¼¯çµ„ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible)
        {
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
        }
    }

    private async Task HandleSaveSuccess()
    {
        try
        {
            if (OnSalesOrderSaved.HasDelegate && editModalComponent?.Entity != null)
            {
                await OnSalesOrderSaved.InvokeAsync(editModalComponent.Entity);
            }
            await CloseModal();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSaveSuccess), GetType(), 
                additionalData: "éŠ·è²¨è¨‚å–®ç·¨è¼¯Modalå„²å­˜æˆåŠŸè™•ç†å¤±æ•—");
        }
    }

    private async Task HandleCancel()
    {
        try
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }
            // ä¸è¦ç›´æ¥èª¿ç”¨ CloseModalï¼Œè®“ GenericEditModalComponent è™•ç†
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCancel), GetType(), 
                additionalData: "éŠ·è²¨è¨‚å–®ç·¨è¼¯Modalå–æ¶ˆè™•ç†å¤±æ•—");
        }
    }

    private async Task CloseModal()
    {
        try
        {
            if (IsVisibleChanged.HasDelegate)
            {
                await IsVisibleChanged.InvokeAsync(false);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(CloseModal), GetType(), 
                additionalData: "éŠ·è²¨è¨‚å–®ç·¨è¼¯Modalé—œé–‰å¤±æ•—");
        }
    }

    private async Task<SalesOrder?> LoadSalesOrderData()
    {
        try
        {
            isDetailDataReady = false;
            hasUndeletableDetails = false;
            
            if (!SalesOrderId.HasValue)
            {
                // æ–°å¢æ¨¡å¼ - è‡ªå‹•ç”¢ç”ŸéŠ·è²¨è¨‚å–®è™Ÿä¸¦è¨­å®šé è¨­å…¬å¸
                var generatedCode = await EntityCodeGenerationHelper.GenerateForEntity<SalesOrder, ISalesOrderService>(SalesOrderService, DbContext);
                
                var newOrder = new SalesOrder
                {
                    OrderDate = DateTime.Today,
                    ExpectedDeliveryDate = DateTime.Today.AddDays(7),
                    Status = EntityStatus.Active,
                    TotalAmount = 0,
                    Code = generatedCode
                };
                
                // å¦‚æœæ˜¯å¾å ±åƒ¹å–®è½‰å–®ï¼Œè¼‰å…¥å ±åƒ¹å–®è³‡æ–™
                if (PrefilledQuotationId.HasValue)
                {
                    await LoadDataFromQuotation(newOrder, PrefilledQuotationId.Value);
                }
                // å¦å‰‡ä½¿ç”¨é å¡«å®¢æˆ¶
                else if (PrefilledCustomerId.HasValue)
                {
                    newOrder.CustomerId = PrefilledCustomerId.Value;
                }
                
                // æ¸…ç©ºæ˜ç´°ï¼ˆå¦‚æœæ²’æœ‰å¾å ±åƒ¹å–®è¼‰å…¥ï¼‰
                if (!PrefilledQuotationId.HasValue)
                {
                    salesOrderDetails.Clear();
                }
                
                isDetailDataReady = true;
                
                return newOrder;
            }

            // ç·¨è¼¯æ¨¡å¼ - è¼‰å…¥éŠ·è²¨è¨‚å–®å’Œæ˜ç´°
            var salesOrder = await SalesOrderService.GetWithDetailsAsync(SalesOrderId.Value);
            
            if (salesOrder != null)
            {
                // è¼‰å…¥éŠ·è²¨è¨‚å–®æ˜ç´°
                await LoadSalesOrderDetails(SalesOrderId.Value);
                
                // ğŸ”‘ é—œéµï¼šè¼‰å…¥æ˜ç´°ç›¸é—œè³‡æ–™ï¼ˆé€€è²¨è¨˜éŒ„ã€æ”¶æ¬¾è¨˜éŒ„ï¼‰
                await LoadDetailRelatedDataAsync();
                isDetailDataReady = true;
                StateHasChanged();
                
                // åœ¨å¯¦é«”è¼‰å…¥å¾Œé‡æ–°åˆå§‹åŒ–è¡¨å–®æ¬„ä½
                await Task.Delay(10); // çŸ­æš«å»¶é²ç¢ºä¿å¯¦é«”å·²è¨­å®š
                _ = Task.Run(async () =>
                {
                    await InvokeAsync(async () =>
                    {
                        await InitializeFormFieldsAsync();
                        StateHasChanged();
                    });
                });
                
                // è§¸ç™¼é‡æ–°æ¸²æŸ“ä»¥æ›´æ–° ProductManagerComponent
                StateHasChanged();
            }
            else
            {
                isDetailDataReady = true;
            }
            
            return salesOrder;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSalesOrderData), GetType(), 
                additionalData: $"è¼‰å…¥éŠ·è²¨è¨‚å–®è³‡æ–™å¤±æ•— - ID: {SalesOrderId}");
            await NotificationService.ShowErrorAsync($"è¼‰å…¥éŠ·è²¨è¨‚å–®è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            isDetailDataReady = true; // éŒ¯èª¤ä¹Ÿè¦å…è¨±æ¸²æŸ“
            return null;
        }
    }

    /// <summary>
    /// è¼‰å…¥æ˜ç´°ç›¸é—œè³‡æ–™ï¼ˆé€€è²¨è¨˜éŒ„ã€æ”¶æ¬¾è¨˜éŒ„ï¼‰- ç”¨æ–¼åˆ¤æ–·æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
    /// å¿…é ˆåœ¨ DataLoader ä¸­åŒæ­¥åŸ·è¡Œï¼Œç¢ºä¿ç‹€æ…‹è¨Šæ¯æ­£ç¢ºé¡¯ç¤º
    /// </summary>
    private async Task LoadDetailRelatedDataAsync()
    {
        try
        {
            if (!salesOrderDetails.Any())
            {
                hasUndeletableDetails = false;
                return;
            }

            bool hasUndeletable = false;
            
            foreach (var detail in salesOrderDetails.Where(d => d.Id > 0))
            {
                // æª¢æŸ¥é€€è²¨è¨˜éŒ„
                var returnedQty = await SalesReturnDetailService.GetReturnedQuantityByOrderDetailAsync(detail.Id);
                if (returnedQty > 0)
                {
                    hasUndeletable = true;
                    break;
                }
                
                // æª¢æŸ¥æ”¶æ¬¾è¨˜éŒ„
                if (detail.TotalReceivedAmount > 0)
                {
                    hasUndeletable = true;
                    break;
                }
            }
            
            hasUndeletableDetails = hasUndeletable;
            
            if (hasUndeletableDetails)
            {
                UpdateFieldsReadOnlyState();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDetailRelatedDataAsync), GetType());
            hasUndeletableDetails = false;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // è¼‰å…¥å®¢æˆ¶é¸é …
            customers = await CustomerService.GetAllAsync();
            availableCustomers = customers; // ç”¨æ–¼ AutoComplete
            customerOptions = customers.Where(c => c.Status == EntityStatus.Active)
                .Select(c => new SelectOption
                {
                    Text = c.CompanyName ?? "",
                    Value = c.Id.ToString()
                }).ToList();

            // è¼‰å…¥å…¬å¸é¸é …
            companies = await CompanyService.GetAllAsync();
            availableCompanies = companies; // ç”¨æ–¼ AutoComplete
            companyOptions = companies.Where(c => c.Status == EntityStatus.Active)
                .Select(c => new SelectOption
                {
                    Text = c.CompanyName,
                    Value = c.Id.ToString()
                }).ToList();

            // è¼‰å…¥å“¡å·¥é¸é …
            employees = await EmployeeService.GetAllAsync();
            availableEmployees = employees; // ç”¨æ–¼ AutoComplete
            employeeOptions = employees.Where(e => e.Status == EntityStatus.Active)
                .Select(e => new SelectOption
                {
                    Text = e.Name ?? string.Empty,
                    Value = e.Id.ToString()
                }).ToList();

            // è¼‰å…¥å•†å“è³‡æ–™
            availableProducts = await ProductService.GetAllAsync();

            // è¼‰å…¥å–®ä½è³‡æ–™
            availableUnits = await UnitService.GetAllAsync();

            // è¼‰å…¥å€‰åº«è³‡æ–™
            availableWarehouses = await WarehouseService.GetAllAsync();

            // åˆå§‹åŒ–ç‹€æ…‹é¸é …
            statusOptions = new List<SelectOption>
            {
                new SelectOption { Text = "å•Ÿç”¨", Value = "Active" },
                new SelectOption { Text = "åœç”¨", Value = "Inactive" }
            };
            
            // ğŸ”‘ ä¸€æ¬¡æ€§è¼‰å…¥ç³»çµ±ç¨…ç‡ï¼ˆé¿å…æ¯æ¬¡è¨ˆç®—éƒ½æŸ¥è©¢è³‡æ–™åº«ï¼‰
            currentTaxRate = await TaxCalculationHelper.LoadTaxRateAsync(SystemParameterService);
            
            // ä½¿ç”¨ AutoCompleteConfigHelper å»ºç«‹é…ç½®
            autoCompleteConfig = new AutoCompleteConfigBuilder<SalesOrder>()
                .AddField(nameof(SalesOrder.CustomerId), "CompanyName", availableCustomers)
                .AddField(nameof(SalesOrder.EmployeeId), "Name", availableEmployees)
                .Build();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadAdditionalDataAsync), GetType(), 
                additionalData: "éŠ·è²¨è¨‚å–®ç·¨è¼¯Modalè¼‰å…¥é¡å¤–è³‡æ–™å¤±æ•—");
            
            // è¨­å®šå®‰å…¨çš„é è¨­å€¼
            customerOptions = new List<SelectOption>();
            companyOptions = new List<SelectOption>();
            employeeOptions = new List<SelectOption>();
            statusOptions = new List<SelectOption>();
            availableProducts = new List<Product>();
            availableUnits = new List<Unit>();
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SalesOrder.Code),
                    Label = "éŠ·è²¨å–®è™Ÿ",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥éŠ·è²¨å–®è™Ÿ",
                    IsRequired = true,
                    MaxLength = 30,
                    HelpText = "éŠ·è²¨è¨‚å–®çš„å”¯ä¸€ç·¨è™Ÿï¼Œæ–°å¢æ™‚ç³»çµ±æœƒè‡ªå‹•ç”¢ç”Ÿï¼Œä¹Ÿå¯æ‰‹å‹•ä¿®æ”¹",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.CustomerId),
                    Label = "å®¢æˆ¶",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡å®¢æˆ¶",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "è¼¸å…¥å®¢æˆ¶åç¨±é€²è¡Œæœå°‹ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                    ActionButtons = await GetCustomerActionButtonsAsync(),
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.EmployeeId),
                    Label = "æ¥­å‹™å“¡",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹é¸æ“‡æ¥­å‹™å“¡",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "é¸æ“‡è² è²¬æ­¤è¨‚å–®çš„æ¥­å‹™å“¡",
                    ActionButtons = await GetEmployeeActionButtonsAsync(),
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.OrderDate),
                    Label = "è¨‚å–®æ—¥æœŸ",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "éŠ·è²¨è¨‚å–®å»ºç«‹æ—¥æœŸ",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.ExpectedDeliveryDate),
                    Label = "é å®šå‡ºè²¨æ—¥æœŸ",
                    FieldType = FormFieldType.Date,
                    IsRequired = false,
                    HelpText = "é è¨ˆå‡ºè²¨çµ¦å®¢æˆ¶çš„æ—¥æœŸ",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },

                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesOrder.TotalAmount),
                    Label = "éŠ·è²¨ç¸½é‡‘é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "éŠ·è²¨å–®çš„ç¸½é‡‘é¡ï¼Œæ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—",
                    IsReadOnly = true // ç¸½é‡‘é¡æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesOrder.SalesTaxAmount),
                    Label = TaxCalculationHelper.GenerateTaxAmountLabel("éŠ·è²¨ç¨…é¡", currentTaxRate),
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = TaxCalculationHelper.GenerateTaxAmountHelpText("éŠ·è²¨å–®", currentTaxRate),
                    IsReadOnly = true // ç¨…é¡æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesOrder.TotalAmountWithTax),
                    Label = "å«ç¨…ç¸½é‡‘é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "éŠ·è²¨å–®çš„å«ç¨…ç¸½é‡‘é¡ï¼Œæ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—",
                    IsReadOnly = true // å«ç¨…ç¸½é‡‘é¡æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.PaymentTerms),
                    Label = "ä»˜æ¬¾æ¢ä»¶",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥ä»˜æ¬¾æ¢ä»¶",
                    IsRequired = false,
                    MaxLength = 200,
                    HelpText = "èˆ‡å®¢æˆ¶ç´„å®šçš„ä»˜æ¬¾æ–¹å¼å’ŒæœŸé™",
                    ContainerCssClass = "col-3",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.DeliveryTerms),
                    Label = "äº¤è²¨æ¢ä»¶",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥äº¤è²¨æ¢ä»¶",
                    IsRequired = false,
                    MaxLength = 200,
                    HelpText = "èˆ‡å®¢æˆ¶ç´„å®šçš„äº¤è²¨æ–¹å¼å’Œæ¢ä»¶",
                    ContainerCssClass = "col-3",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },

                FormFieldConfigurationHelper.CreateRemarksField<SalesOrder>(
                    containerCssClass: "col-6",
                    readOnly: hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                ),
            };

            formSections = new Dictionary<string, string>
            {
                { nameof(SalesOrder.Code), "åŸºæœ¬è³‡è¨Š" },
                { nameof(SalesOrder.CustomerId), "åŸºæœ¬è³‡è¨Š" },
                { nameof(SalesOrder.EmployeeId), "åŸºæœ¬è³‡è¨Š" },
                { nameof(SalesOrder.OrderDate), "åŸºæœ¬è³‡è¨Š" },
                { nameof(SalesOrder.ExpectedDeliveryDate), "åŸºæœ¬è³‡è¨Š" },
                { nameof(SalesOrder.TotalAmount), "é‡‘é¡è³‡è¨Š" },
                { nameof(SalesOrder.SalesTaxAmount), "é‡‘é¡è³‡è¨Š" },
                { nameof(SalesOrder.TotalAmountWithTax), "é‡‘é¡è³‡è¨Š" },
                { nameof(SalesOrder.PaymentTerms), "é¡å¤–è³‡è¨Š" },
                { nameof(SalesOrder.DeliveryTerms), "é¡å¤–è³‡è¨Š" },                
                { nameof(SalesOrder.Remarks), "é¡å¤–è³‡è¨Š" }
            };
        }
        catch (Exception ex)
        {
            _ = ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(InitializeFormFieldsAsync), GetType(), 
                additionalData: "éŠ·è²¨è¨‚å–®ç·¨è¼¯Modalè¡¨å–®æ¬„ä½åˆå§‹åŒ–å¤±æ•—");
            
            // è¨­å®šå®‰å…¨çš„é è¨­å€¼
            formFields = new List<FormFieldDefinition>();
            formSections = new Dictionary<string, string>();
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }

    /// <summary>
    /// ç”ŸæˆéŠ·è²¨è¨‚å–®è™Ÿ
    /// </summary>
    
    // ===== AutoComplete é…ç½®æ–¹æ³• =====
    
    /// <summary>
    /// é…ç½® Modal ç®¡ç†å™¨
    /// </summary>
    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(SalesOrder.CustomerId), customerModalManager },
            { nameof(SalesOrder.EmployeeId), employeeModalManager }
        };
    }
    
    /// <summary>
    /// é…ç½®è‡ªè¨‚æ¨¡çµ„
    /// </summary>
    private List<GenericEditModalComponent<SalesOrder, ISalesOrderService>.CustomModule> GetCustomModules()
    {
        // ç¢ºä¿åªåœ¨éœ€è¦æ™‚æ‰è¿”å›æ¨¡çµ„ï¼Œä¸¦ä¸”æª¢æŸ¥æ‰€æœ‰å¿…è¦çš„æ¢ä»¶
        if (editModalComponent == null)
        {
            return new List<GenericEditModalComponent<SalesOrder, ISalesOrderService>.CustomModule>();
        }

        return new List<GenericEditModalComponent<SalesOrder, ISalesOrderService>.CustomModule>
        {
            new GenericEditModalComponent<SalesOrder, ISalesOrderService>.CustomModule
            {
                Order = 1,
                IsVisible = true,
                Content = CreateProductManagerContent()
            }
        };
    }

    /// <summary>
    /// å‰µå»ºå•†å“ç®¡ç†å™¨å…§å®¹çš„ RenderFragment
    /// </summary>
    private RenderFragment CreateProductManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null)
            {
                @if (!isDetailDataReady)
                {
                    <div class="d-flex justify-content-center align-items-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span class="text-muted">è¼‰å…¥æ˜ç´°è³‡æ–™ä¸­...</span>
                    </div>
                }
                // æª¢æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„å•†å“å’Œå–®ä½è³‡æ–™
                else if (availableProducts != null && availableProducts.Any() && availableUnits != null && availableUnits.Any())
                {
                    // æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡å®¢æˆ¶
                    @if (editModalComponent.Entity.CustomerId > 0)
                    {
                        <SalesOrderTable @ref="salesOrderDetailManager"
                                                          TMainEntity="SalesOrder" 
                                                          TDetailEntity="SalesOrderDetail"
                                                          MainEntity="@editModalComponent.Entity"
                                                          ExistingDetails="@salesOrderDetails"
                                                          Products="@availableProducts"
                                                          Warehouses="@availableWarehouses"
                                                          SelectedCustomerId="@editModalComponent.Entity.CustomerId"
                                                          IsReadOnly="false"
                                                          MainEntityIdPropertyName="SalesOrderId"
                                                          QuantityPropertyName="OrderQuantity"
                                                          UnitPricePropertyName="UnitPrice"
                                                          DiscountPercentagePropertyName="DiscountPercentage"
                                                          UnitIdPropertyName="UnitId"
                                                          WarehouseIdPropertyName="WarehouseId"
                                                          RemarksPropertyName="DetailRemarks"
                                                          IsApprovalEnabled="@isApprovalEnabled"
                                                          SourceQuotationId="@PrefilledQuotationId"
                                                          IsSourceQuotationApproved="@isSourceQuotationApproved"
                                                          OnDetailsChanged="@HandleDetailsChanged"
                                                          OnHasUndeletableDetailsChanged="@HandleHasUndeletableDetailsChanged"
                                                          OnOpenRelatedDocument="@HandleOpenRelatedDocument"
                                                          ItemDisplayName="éŠ·å”®ç”¢å“"
                                                          EmptyMessage="å°šæœªæ–°å¢éŠ·å”®ç”¢å“" />
                    }
                    else
                    {
                        <div class="alert alert-info text-center" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            è«‹å…ˆé¸æ“‡å®¢æˆ¶å¾Œå†é€²è¡ŒéŠ·å”®æ˜ç´°ç®¡ç†
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-warning text-center" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ç„¡å¯ç”¨çš„å•†å“æˆ–å–®ä½è³‡æ–™ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡
                    </div>
                }
            }
            else
            {
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                è¼‰å…¥æ˜ç´°ç®¡ç†å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚
            </div>
        }
    };
    
    // ===== ActionButton ç”¢ç”Ÿæ–¹æ³• =====
    
    /// <summary>
    /// ç”¢ç”Ÿå®¢æˆ¶æ“ä½œæŒ‰éˆ• - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetCustomerActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            customerModalManager, 
            nameof(SalesOrder.CustomerId)
        );
    }
    
    /// <summary>
    /// ç”¢ç”Ÿæ¥­å‹™å“¡æ“ä½œæŒ‰éˆ• - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetEmployeeActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            employeeModalManager, 
            nameof(SalesOrder.EmployeeId)
        );
    }
    
    // ===== Modal äº‹ä»¶åŒ…è£å™¨æ–¹æ³• =====
    
    /// <summary>
    /// åŒ…è£å®¢æˆ¶å„²å­˜äº‹ä»¶
    /// </summary>
    private async Task OnCustomerSavedWrapper(Customer savedCustomer)
    {
        await customerModalManager.HandleEntitySavedAsync(savedCustomer, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// åŒ…è£æ¥­å‹™å“¡å„²å­˜äº‹ä»¶
    /// </summary>
    private async Task OnEmployeeSavedWrapper(Employee savedEmployee)
    {
        await employeeModalManager.HandleEntitySavedAsync(savedEmployee, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// è™•ç†é–‹å•Ÿç›¸é—œå–®æ“šçš„äº‹ä»¶
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            if (args.type == RelatedDocumentType.ReturnDocument)
            {
                // é–‹å•ŸéŠ·è²¨é€€å›å–®
                selectedSalesReturnId = args.id;
                showSalesReturnModal = true;
                StateHasChanged();
            }
            else if (args.type == RelatedDocumentType.SetoffDocument)
            {
                // é–‹å•Ÿæ²–æ¬¾å–®
                selectedSetoffDocumentId = args.id;
                showSetoffDocumentModal = true;
                StateHasChanged();
            }
            else
            {
                await NotificationService.ShowWarningAsync("ä¸æ”¯æ´çš„å–®æ“šé¡å‹", "æç¤º");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é–‹å•Ÿå–®æ“šå¤±æ•—ï¼š{ex.Message}");
        }
    }
    
    /// <summary>
    /// è™•ç†æ²–æ¬¾å–®å„²å­˜å¾Œçš„äº‹ä»¶
    /// </summary>
    private async Task HandleSetoffDocumentSaved(SetoffDocument savedDocument)
    {
        try
        {
            showSetoffDocumentModal = false;
            await NotificationService.ShowSuccessAsync("æ²–æ¬¾å–®å·²æ›´æ–°");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†æ²–æ¬¾å–®å„²å­˜äº‹ä»¶å¤±æ•—ï¼š{ex.Message}");
        }
    }
    
    /// <summary>
    /// è™•ç†æ¬„ä½å€¼è®Šæ›´äº‹ä»¶ - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // ä½¿ç”¨çµ±ä¸€ Helper è™•ç†å®¢æˆ¶æ¬„ä½è®Šæ›´
            if (fieldChange.PropertyName == nameof(SalesOrder.CustomerId))
            {
                // ğŸ”‘ é—œéµï¼šåªæœ‰åœ¨æ²’æœ‰ä¸å¯åˆªé™¤æ˜ç´°æ™‚æ‰æ›´æ–° ActionButtons
                if (!hasUndeletableDetails)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        customerModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                }
                
                // å®¢æˆ¶è®Šæ›´æ™‚ï¼Œè§¸ç™¼å•†å“ç®¡ç†å™¨é‡æ–°æ¸²æŸ“
                StateHasChanged();
            }
            // è™•ç†æ¥­å‹™å“¡æ¬„ä½è®Šæ›´
            else if (fieldChange.PropertyName == nameof(SalesOrder.EmployeeId))
            {
                // ğŸ”‘ é—œéµï¼šåªæœ‰åœ¨æ²’æœ‰ä¸å¯åˆªé™¤æ˜ç´°æ™‚æ‰æ›´æ–° ActionButtons
                if (!hasUndeletableDetails)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        employeeModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                }
            }
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("æ¬„ä½è®Šæ›´è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    // ===== éŠ·è²¨æ˜ç´°ç®¡ç†æ–¹æ³• =====
    
    /// <summary>
    /// è¼‰å…¥éŠ·è²¨è¨‚å–®æ˜ç´°
    /// </summary>
    private async Task LoadSalesOrderDetails(int salesOrderId)
    {
        try
        {
            // å¾ç¾æœ‰çš„éŠ·è²¨è¨‚å–®å–å¾—æ˜ç´°
            var salesOrder = await SalesOrderService.GetWithDetailsAsync(salesOrderId);
            if (salesOrder?.SalesOrderDetails != null)
            {
                salesOrderDetails = salesOrder.SalesOrderDetails.ToList();
            }
            else
            {
                salesOrderDetails = new List<SalesOrderDetail>();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSalesOrderDetails), GetType(), 
                additionalData: $"è¼‰å…¥éŠ·è²¨è¨‚å–®æ˜ç´°å¤±æ•— - OrderId: {salesOrderId}");
            salesOrderDetails = new List<SalesOrderDetail>();
        }
    }

    /// <summary>
    /// è™•ç†éŠ·è²¨æ˜ç´°è®Šæ›´
    /// </summary>
    private async Task HandleDetailsChanged(List<SalesOrderDetail> details)
    {
        try
        {
            salesOrderDetails = details ?? new List<SalesOrderDetail>();
            
            // æ˜ç´°çš„å°è¨ˆå·²ç¶“åœ¨ SalesOrderDetailManagerComponent ä¸­è¨ˆç®—å¥½äº†
            // é€™è£¡åªéœ€è¦æ›´æ–°ä¸»æª”çš„ç¸½é‡‘é¡å’Œç¨…é¡
            
            // æ›´æ–°ä¸»æª”çš„ç¸½é‡‘é¡å’Œç¨…é¡
            if (editModalComponent?.Entity != null)
            {
                // 1. è¨ˆç®—ç¸½é‡‘é¡ï¼ˆæœªç¨…ï¼‰- ä½¿ç”¨æ˜ç´°çš„ SubtotalAmountï¼ˆå·²æ‰£é™¤æŠ˜æ‰£ï¼‰
                editModalComponent.Entity.TotalAmount = salesOrderDetails.Sum(d => d.SubtotalAmount);
                
                // 2. è¨ˆç®—ç¨…é¡ï¼ˆä½¿ç”¨ TaxCalculationHelper çµ±ä¸€è™•ç†ï¼‰
                editModalComponent.Entity.SalesTaxAmount = TaxCalculationHelper.CalculateTax(
                    editModalComponent.Entity.TotalAmount, 
                    currentTaxRate
                );
                
                // 3. å«ç¨…ç¸½é‡‘é¡æœƒè‡ªå‹•è¨ˆç®—ï¼ˆTotalAmountWithTax æ˜¯è¨ˆç®—å±¬æ€§ï¼‰
                //    = TotalAmount + SalesTaxAmount
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDetailsChanged), GetType(), 
                additionalData: "è™•ç†éŠ·è²¨æ˜ç´°è®Šæ›´å¤±æ•—");
        }
    }

    /// <summary>
    /// è™•ç†æœ‰ä¸å¯åˆªé™¤æ˜ç´°çš„ç‹€æ…‹è®Šæ›´
    /// ç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚(å·²é€€è²¨æˆ–å·²æ”¶æ¬¾),é–å®šä¸»æª”çš„æ‰€æœ‰ä½¿ç”¨è€…å¯è¼¸å…¥æ¬„ä½
    /// </summary>
    private async Task HandleHasUndeletableDetailsChanged(bool hasUndeletable)
    {
        try
        {
            hasUndeletableDetails = hasUndeletable;
            
            // æ›´æ–°æ¬„ä½çš„å”¯è®€ç‹€æ…‹
            UpdateFieldsReadOnlyState();
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†æ˜ç´°é–å®šç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// æ›´æ–°æ¬„ä½çš„å”¯è®€ç‹€æ…‹
    /// ç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚,æ‰€æœ‰ä½¿ç”¨è€…å¯è¼¸å…¥çš„æ¬„ä½éƒ½æ‡‰è¨­ç‚ºå”¯è®€:
    /// - éŠ·è²¨å–®è™Ÿ (SalesOrderNumber)
    /// - å®¢æˆ¶ (CustomerId) - åŒæ™‚ç¦ç”¨æ–°å¢/ç·¨è¼¯æŒ‰éˆ•
    /// - æ¥­å‹™å“¡ (EmployeeId) - åŒæ™‚ç¦ç”¨æ–°å¢/ç·¨è¼¯æŒ‰éˆ•
    /// - è¨‚å–®æ—¥æœŸ (OrderDate)
    /// - é å®šå‡ºè²¨æ—¥æœŸ (ExpectedDeliveryDate)
    /// - ä»˜æ¬¾æ¢ä»¶ (PaymentTerms)
    /// - äº¤è²¨æ¢ä»¶ (DeliveryTerms)
    /// - å‚™è¨» (Remarks)
    /// </summary>
    /// <summary>
    /// æ›´æ–°æ¬„ä½çš„å”¯è®€ç‹€æ…‹ - æ ¹æ“šæ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
    /// ä½¿ç”¨ FormFieldLockHelper çµ±ä¸€è™•ç†æ¬„ä½é–å®šé‚è¼¯
    /// </summary>
    private void UpdateFieldsReadOnlyState()
    {
        // ä½¿ç”¨ FormFieldLockHelper æ‰¹æ¬¡é–å®š/è§£é–æ¬„ä½
        var fieldsToLock = new[]
        {
            nameof(SalesOrder.Code),
            nameof(SalesOrder.OrderDate),
            nameof(SalesOrder.ExpectedDeliveryDate),
            nameof(SalesOrder.PaymentTerms),
            nameof(SalesOrder.DeliveryTerms),
            nameof(BaseEntity.Remarks)
        };
        
        // é–å®šæˆ–è§£é–ä¸€èˆ¬æ¬„ä½ï¼ˆä¸éœ€è¦ ActionButtonsï¼‰
        FormFieldLockHelper.LockMultipleFieldsSimple(
            formFields, 
            fieldsToLock, 
            isLocked: hasUndeletableDetails
        );
        
        // ç‰¹æ®Šè™•ç†æœ‰ ActionButtons çš„æ¬„ä½
        var fieldsWithActionButtons = new Dictionary<string, Func<Task<List<FieldActionButton>>>>
        {
            { nameof(SalesOrder.CustomerId), GetCustomerActionButtonsAsync },
            { nameof(SalesOrder.EmployeeId), GetEmployeeActionButtonsAsync }
        };

        foreach (var kvp in fieldsWithActionButtons)
        {
            if (hasUndeletableDetails)
            {
                // é–å®šï¼šç§»é™¤ ActionButtons
                FormFieldLockHelper.LockField(
                    formFields,
                    kvp.Key,
                    isLocked: true
                );
            }
            else
            {
                // è§£é–ï¼šæ¢å¾© ActionButtons
                FormFieldLockHelper.LockField(
                    formFields,
                    kvp.Key,
                    isLocked: false,
                    actionButtonsGetter: kvp.Value
                );
            }
        }
    }

    /// <summary>
    /// å–å¾—ç‹€æ…‹è¨Šæ¯ï¼ˆé ‚éƒ¨å¾½ç« ï¼‰
    /// ç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚ï¼Œé¡¯ç¤ºé–å®šæç¤º
    /// </summary>
    private async Task<(string Message, GenericEditModalComponent<SalesOrder, ISalesOrderService>.BadgeVariant Variant, string IconClass)?> 
        GetStatusMessage()
    {
        try
        {
            if (!isDetailDataReady || editModalComponent?.Entity == null)
                return null;
            
            if (hasUndeletableDetails)
            {
                return (
                    "æ˜ç´°æœ‰å…¶ä»–å‹•ä½œï¼Œä¸»æª”æ¬„ä½å·²é–å®š",
                    GenericEditModalComponent<SalesOrder, ISalesOrderService>.BadgeVariant.Warning,
                    "fas fa-lock"
                );
            }
            
            return null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetStatusMessage), GetType());
            return null;
        }
    }

    /// <summary>
    /// å–å¾—è­¦å‘Šè¨Šæ¯ï¼ˆè¡¨å–®é ‚éƒ¨ï¼‰
    /// ç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚ï¼Œé¡¯ç¤ºè©³ç´°èªªæ˜
    /// </summary>
    private RenderFragment? GetWarningMessage() => __builder =>
    {
        <GenericLockedFieldMessage IsVisible="@(isDetailDataReady && hasUndeletableDetails)"
                                  Message="å› éƒ¨åˆ†æ˜ç´°æœ‰å…¶ä»–å‹•ä½œï¼Œç‚ºä¿è­·è³‡æ–™å®Œæ•´æ€§ä¸»æª”æ¬„ä½å·²è¨­å”¯è®€ã€‚"
                                  Type="GenericLockedFieldMessage.MessageType.Warning"
                                  IconClass="fas fa-lock" />
    };

    /// <summary>
    /// å–å¾—è‡ªè¨‚æ“ä½œæŒ‰éˆ•ï¼ˆé¡¯ç¤ºåœ¨ Modal é ‚éƒ¨å·¦å´ï¼‰
    /// </summary>
    private RenderFragment? GetCustomActionButtons() => __builder =>
    {
        @* è½‰éŠ·å”®é€€è²¨å–®æŒ‰éˆ• - åªåœ¨éŠ·è²¨è¨‚å–®å·²å„²å­˜æ™‚é¡¯ç¤º *@
        @if (editModalComponent?.Entity != null && 
            SalesOrderId.HasValue)
        {
            <GenericButtonComponent Text="è½‰éŠ·è²¨é€€å›" 
                                  Variant="ButtonVariant.Warning" 
                                  OnClick="HandleCreateReturnFromOrder" />
        }
    };

    /// <summary>
    /// å¾éŠ·è²¨è¨‚å–®è½‰éŠ·å”®é€€è²¨å–®
    /// </summary>
    private async Task HandleCreateReturnFromOrder()
    {
        try
        {
            // 1. é©—è­‰éŠ·è²¨è¨‚å–®è³‡æ–™
            if (!SalesOrderId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("ç„¡æ³•è½‰éŠ·å”®é€€è²¨å–®ï¼šéŠ·è²¨è¨‚å–®è³‡æ–™ä¸å­˜åœ¨");
                return;
            }
            
            // 2. é©—è­‰å®¢æˆ¶è³‡æ–™
            if (editModalComponent.Entity.CustomerId <= 0)
            {
                await NotificationService.ShowWarningAsync("éŠ·è²¨è¨‚å–®ç¼ºå°‘å®¢æˆ¶è³‡è¨Šï¼Œç„¡æ³•è½‰éŠ·å”®é€€è²¨å–®");
                return;
            }
            
            // 3. æª¢æŸ¥æ˜¯å¦æœ‰æ˜ç´°è³‡æ–™
            if (!salesOrderDetails.Any())
            {
                await NotificationService.ShowWarningAsync("éŠ·è²¨è¨‚å–®æ²’æœ‰æ˜ç´°è³‡æ–™ï¼Œç„¡æ³•è½‰éŠ·å”®é€€è²¨å–®");
                return;
            }
            
            // 4. æª¢æŸ¥æ˜¯å¦æœ‰å¯é€€è²¨çš„æ˜ç´°
            // æ³¨æ„ï¼šSalesOrderDetail ç›®å‰æ²’æœ‰ ReturnedQuantity æ¬„ä½
            // æš«æ™‚å…è¨±æ‰€æœ‰æœ‰æ˜ç´°çš„è¨‚å–®éƒ½å¯ä»¥è½‰é€€è²¨å–®
            // æœªä¾†å¦‚æœéœ€è¦æ›´ç²¾ç¢ºçš„é©—è­‰ï¼Œéœ€è¦åœ¨ SalesOrderDetail åŠ å…¥ ReturnedQuantity æ¬„ä½
            // var hasReturnableDetails = salesOrderDetails.Any(detail => 
            //     detail.ReturnedQuantity < detail.OrderQuantity
            // );
            // 
            // if (!hasReturnableDetails)
            // {
            //     await NotificationService.ShowWarningAsync("éŠ·è²¨è¨‚å–®æ‰€æœ‰æ˜ç´°çš†å·²å®Œæˆé€€è²¨ï¼Œç„¡éœ€å†è½‰éŠ·å”®é€€è²¨å–®");
            //     return;
            // }
            
            // 5. å‘¼å«éŠ·å”®é€€è²¨å–®çµ„ä»¶çš„å…¬é–‹æ–¹æ³•
            if (salesReturnEditModal != null)
            {
                await salesReturnEditModal.ShowAddModalWithPrefilledOrder(
                    editModalComponent.Entity.CustomerId,
                    SalesOrderId.Value
                );
            }
            else
            {
                await NotificationService.ShowWarningAsync("éŠ·å”®é€€è²¨å–®çµ„ä»¶æœªåˆå§‹åŒ–ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCreateReturnFromOrder), GetType(), 
                additionalData: $"è½‰éŠ·å”®é€€è²¨å–®å¤±æ•— - OrderId: {SalesOrderId}");
            await NotificationService.ShowErrorAsync("è½‰éŠ·å”®é€€è²¨å–®æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    /// <summary>
    /// è™•ç†éŠ·å”®é€€è²¨å–®å„²å­˜å¾Œçš„äº‹ä»¶
    /// </summary>
    /// <summary>
    /// è™•ç†éŠ·å”®é€€è²¨å–®å„²å­˜å¾Œçš„äº‹ä»¶
    /// ä½¿ç”¨ ChildDocumentRefreshHelper çµ±ä¸€è™•ç†åˆ·æ–°é‚è¼¯
    /// </summary>
    private async Task HandleSalesReturnSaved(SalesReturn savedReturn)
    {
        try
        {
            await ChildDocumentRefreshHelper.HandleChildDocumentSavedAsync(
                closeModal: () =>
                {
                    showSalesReturnModal = false;
                    selectedSalesReturnId = null;
                },
                reloadDetails: async () =>
                {
                    if (SalesOrderId.HasValue)
                    {
                        await LoadSalesOrderDetails(SalesOrderId.Value);
                        
                        // é‡æ–°è¨ˆç®—ç¸½é‡‘é¡å’Œç¨…é¡
                        if (editModalComponent?.Entity != null)
                        {
                            await HandleDetailsChanged(salesOrderDetails);
                        }
                    }
                },
                detailManager: salesOrderDetailManager,
                notificationMessage: null,
                stateHasChanged: StateHasChanged,
                invokeAsync: InvokeAsync,
                additionalActions: async () =>
                {
                    // ğŸ”‘ é—œéµä¿®å¾©ï¼šå‘¼å« Table çµ„ä»¶çš„å…¬é–‹åˆ·æ–°æ–¹æ³•
                    // é‡æ–°è¼‰å…¥é€€è²¨æ•¸é‡è³‡è¨Š
                    if (salesOrderDetailManager != null)
                    {
                        await salesOrderDetailManager.LoadReturnedQuantitiesAsync();
                    }
                }
            );
            
            await NotificationService.ShowSuccessAsync($"éŠ·å”®é€€è²¨å–® {savedReturn.Code} å·²æ›´æ–°ï¼ŒéŠ·è²¨è¨‚å–®æ˜ç´°å·²åˆ·æ–°");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSalesReturnSaved), GetType(), 
                additionalData: $"è™•ç†éŠ·å”®é€€è²¨å–®å„²å­˜äº‹ä»¶å¤±æ•— - ReturnId: {savedReturn?.Id}");
        }
    }

    /// <summary>
    /// è™•ç†åˆ—å°äº‹ä»¶
    /// </summary>
    private async Task HandlePrint()
    {
        try
        {
            // ä½¿ç”¨é€šç”¨ Helper é€²è¡Œå®Œæ•´é©—è­‰ï¼ˆå¯¦é«”ã€IDï¼‰
            // éŠ·è²¨å–®ä¸éœ€è¦æ ¸å‡†å³å¯åˆ—å°
            var (isValid, errorMessage) = ReportPrintHelper.ValidateForPrint(
                entity: editModalComponent?.Entity,
                entityId: SalesOrderId,
                isApproved: true, // ä¸éœ€è¦æ ¸å‡†ç‹€æ…‹æª¢æŸ¥
                entityName: "éŠ·è²¨å–®",
                requireApproval: false // éŠ·è²¨å–®ä¸éœ€è¦æ ¸å‡†å³å¯åˆ—å°
            );
            
            if (!isValid)
            {
                await NotificationService.ShowWarningAsync(errorMessage);
                return;
            }
            
            // ç›´æ¥åŸ·è¡Œåˆ—å°ï¼Œä½¿ç”¨é è¨­è¨­å®š
            await HandleDirectPrint(null);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePrint), GetType(), 
                additionalData: $"éŠ·è²¨å–®åˆ—å°è™•ç†å¤±æ•— - ID: {SalesOrderId}");
            await NotificationService.ShowErrorAsync("åˆ—å°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
    }

    /// <summary>
    /// ç›´æ¥åŸ·è¡Œåˆ—å° - å¯ä»¥ä½¿ç”¨æŒ‡å®šçš„åˆ—å°é…ç½®æˆ–é è¨­é…ç½®
    /// </summary>
    private async Task HandleDirectPrint(ReportPrintConfiguration? printConfig)
    {
        try
        {
            // å»ºç«‹åˆ—å° URL - ä½¿ç”¨æ–°çš„è·¯ç”±æ ¼å¼ /api/sales-report/order/{id}
            var printUrl = ReportPrintHelper.BuildPrintUrl(
                baseUrl: NavigationManager.BaseUri,
                reportType: "sales-report/order",
                documentId: SalesOrderId!.Value,
                configuration: printConfig,
                autoprint: true
            );

            // ä½¿ç”¨éš±è— iframe åˆ—å°ï¼ˆä¸é˜»æ“‹ä¸»è¦–çª—æ“ä½œï¼‰
            var printSuccess = await ReportPrintHelper.ExecutePrintWithHiddenIframeAsync(
                printUrl: printUrl,
                jsRuntime: JSRuntime,
                iframeId: "salesOrderPrintFrame"
            );

            if (printSuccess)
            {
                await NotificationService.ShowSuccessAsync("åˆ—å°æŒ‡ä»¤å·²é€å‡º");
            }
            else
            {
                await NotificationService.ShowWarningAsync("åˆ—å°æŒ‡ä»¤é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDirectPrint), GetType(), 
                additionalData: $"éŠ·è²¨å–®ç›´æ¥åˆ—å°å¤±æ•— - ID: {SalesOrderId}");
            await NotificationService.ShowErrorAsync($"åŸ·è¡Œåˆ—å°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// åŒ…è£æ–¹æ³• - æä¾›çµ¦ GenericEditModalComponent ä½¿ç”¨çš„å„²å­˜è™•ç†å™¨
    /// </summary>
    private async Task<bool> SaveSalesOrderWrapper(SalesOrder salesOrder)
    {
        return await SaveSalesOrderWithDetails(salesOrder);
    }

    /// <summary>
    /// è‡ªè¨‚å„²å­˜é‚è¼¯ - åŒæ™‚å„²å­˜ä¸»æª”å’Œæ˜ç´°
    /// </summary>
    private async Task<bool> SaveSalesOrderWithDetails(SalesOrder salesOrder)
    {
        try
        {
            if (salesOrder == null)
            {
                await NotificationService.ShowErrorAsync("æ²’æœ‰è¦å„²å­˜çš„éŠ·è²¨è¨‚å–®è³‡æ–™");
                return false;
            }

            // 1. å…ˆé€²è¡Œæ˜ç´°é©—è­‰ (æª¢æŸ¥å–®åƒ¹æ˜¯å¦ç‚º0)
            if (salesOrderDetailManager != null)
            {
                var isValid = await salesOrderDetailManager.ValidateAsync();
                if (!isValid)
                {
                    // ValidateAsync å…§éƒ¨å·²é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼Œç›´æ¥è¿”å›
                    return false;
                }
            }
            else
            {
                // å¦‚æœæ²’æœ‰ç®¡ç†å™¨å¼•ç”¨ï¼Œé€²è¡ŒåŸºæœ¬æª¢æŸ¥
                var invalidPriceDetails = salesOrderDetails
                    .Where(d => d.ProductId > 0 && d.UnitPrice < 0)
                    .ToList();
                
                if (invalidPriceDetails.Any())
                {
                    await NotificationService.ShowErrorAsync("æ‰€æœ‰ç”¢å“çš„å–®åƒ¹ä¸å¯ç‚ºè² æ•¸ï¼Œè«‹æª¢æŸ¥ä¸¦ä¿®æ­£");
                    return false;
                }
            }

            // æ›´æ–°ç¸½é‡‘é¡å’Œç¨…é¡ï¼ˆä½¿ç”¨ TaxCalculationHelper çµ±ä¸€è™•ç†ï¼‰
            salesOrder.TotalAmount = salesOrderDetails.Sum(d => d.SubtotalAmount);
            salesOrder.SalesTaxAmount = TaxCalculationHelper.CalculateTax(
                salesOrder.TotalAmount, 
                currentTaxRate
            );

            var isEditMode = SalesOrderId.HasValue;
            
            // 2. å„²å­˜å‰æª¢æŸ¥å€‰åº«é¸æ“‡å’Œåº«å­˜ï¼ˆåƒ…åœ¨æ–°å¢æ¨¡å¼ä¸‹é€²è¡Œï¼‰
            // ç·¨è¼¯æ¨¡å¼ä¸‹æœƒå…ˆé€²è¡Œåº«å­˜å›æ»¾ï¼Œæ‰€ä»¥ä¸éœ€è¦äº‹å‰é©—è­‰
            if (!isEditMode)
            {
                var stockValidationResult = await SalesOrderService.ValidateWarehouseInventoryStockAsync(salesOrderDetails);
                if (!stockValidationResult.IsSuccess)
                {
                    await NotificationService.ShowErrorAsync($"é©—è­‰å¤±æ•—ï¼Œç„¡æ³•å„²å­˜ï¼š\n{stockValidationResult.ErrorMessage}");
                    return false;
                }
            }
            List<SalesOrderDetail> originalDetails = new();
            
            // åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹ï¼Œå…ˆå–å¾—åŸå§‹æ˜ç´°è³‡æ–™
            if (isEditMode)
            {
                originalDetails = await SalesOrderDetailService.GetBySalesOrderIdAsync(SalesOrderId!.Value);
            }

            // å„²å­˜ä¸»æª”
            ServiceResult<SalesOrder> result;
            if (isEditMode)
            {
                result = await SalesOrderService.UpdateAsync(salesOrder);
            }
            else
            {
                result = await SalesOrderService.CreateAsync(salesOrder);
            }

            if (!result.IsSuccess || result.Data == null)
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "å„²å­˜éŠ·è²¨è¨‚å–®å¤±æ•—");
                return false;
            }

            // å„²å­˜æ˜ç´°
            await SaveSalesOrderDetails(result.Data.Id, isEditMode, isEditMode ? originalDetails : new List<SalesOrderDetail>());
            
            // åªæœ‰æ–°å¢æ¨¡å¼æ‰éœ€è¦é€²è¡Œåº«å­˜æ‰£æ¸›ï¼ˆç·¨è¼¯æ¨¡å¼çš„åº«å­˜ç”± SalesOrderDetailService.UpdateDetailsWithInventoryAsync è™•ç†ï¼‰
            if (!isEditMode)
            {
                await ReduceInventoryWithFIFOAsync(result.Data.Id);
            }

            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveSalesOrderWithDetails), GetType(), 
                additionalData: "å„²å­˜éŠ·è²¨è¨‚å–®å’Œæ˜ç´°å¤±æ•—");
            await NotificationService.ShowErrorAsync($"å„²å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// å„²å­˜éŠ·è²¨è¨‚å–®æ˜ç´°ï¼ˆæ”¯æ´æ–°å¢å’Œç·¨è¼¯æ¨¡å¼ï¼‰
    /// </summary>
    /// <param name="salesOrderId">éŠ·è²¨è¨‚å–®ID</param>
    /// <param name="isEditMode">æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼</param>
    /// <param name="originalDetails">åŸå§‹æ˜ç´°åˆ—è¡¨ï¼ˆç·¨è¼¯æ¨¡å¼ä½¿ç”¨ï¼‰</param>
    private async Task SaveSalesOrderDetails(int salesOrderId, bool isEditMode = false, List<SalesOrderDetail>? originalDetails = null)
    {
        try
        {
            // åªè™•ç†æœ‰æ•ˆçš„æ˜ç´°ï¼ˆå·²é¸æ“‡ç”¢å“çš„ï¼‰
            var validDetails = salesOrderDetails.Where(d => d.ProductId > 0).ToList();
            

            // è¨­å®šä¸»æª”IDå’Œæ™‚é–“æˆ³è¨˜
            foreach (var detail in validDetails)
            {
                detail.SalesOrderId = salesOrderId;
                if (detail.Id == 0)
                {
                    detail.Status = EntityStatus.Active;
                    detail.CreatedAt = DateTime.Now;
                }
                else
                {
                    detail.UpdatedAt = DateTime.Now;
                }

            }

            // å…ˆç²å–ç¾æœ‰çš„æ˜ç´°ï¼ˆå¦‚æœæœªæä¾›ï¼‰
            var existingDetails = originalDetails ?? (await SalesOrderService.GetWithDetailsAsync(salesOrderId))?.SalesOrderDetails?.ToList() ?? new List<SalesOrderDetail>();
            
            // è™•ç†æ–°å¢å’Œæ›´æ–°çš„æ˜ç´°
            foreach (var detail in validDetails)
            {
                if (detail.Id == 0)
                {
                    // æ–°å¢æ˜ç´°
                    var createResult = await SalesOrderDetailService.CreateAsync(detail);
                    if (createResult.IsSuccess && createResult.Data != null)
                    {
                        // æ›´æ–°æœ¬åœ°æ˜ç´°çš„ ID
                        detail.Id = createResult.Data.Id;
                        
                        // ğŸ”‘ æ›´æ–°å ±åƒ¹å–®æ˜ç´°çš„å·²è½‰éŠ·è²¨æ•¸é‡
                        if (detail.QuotationDetailId.HasValue)
                        {
                            await UpdateQuotationDetailConvertedQuantity(
                                detail.QuotationDetailId.Value, 
                                detail.OrderQuantity, 
                                isAdding: true
                            );
                        }
                    }
                }
                else
                {
                    // æ›´æ–°æ˜ç´° - éœ€è¦æª¢æŸ¥æ•¸é‡è®ŠåŒ–
                    var originalDetail = existingDetails.FirstOrDefault(e => e.Id == detail.Id);
                    var quantityDiff = detail.OrderQuantity - (originalDetail?.OrderQuantity ?? 0);
                    
                    await SalesOrderDetailService.UpdateAsync(detail);
                    
                    // ğŸ”‘ å¦‚æœæ•¸é‡æœ‰è®ŠåŒ–ä¸”æœ‰å ±åƒ¹å–®ä¾†æºï¼Œæ›´æ–°å ±åƒ¹å–®æ˜ç´°çš„å·²è½‰éŠ·è²¨æ•¸é‡
                    if (quantityDiff != 0 && detail.QuotationDetailId.HasValue)
                    {
                        await UpdateQuotationDetailConvertedQuantity(
                            detail.QuotationDetailId.Value,
                            Math.Abs(quantityDiff),
                            isAdding: quantityDiff > 0
                        );
                    }
                }
            }

            // è™•ç†åˆªé™¤çš„æ˜ç´°ï¼ˆç¾æœ‰çš„ä½†ä¸åœ¨ç•¶å‰æœ‰æ•ˆåˆ—è¡¨ä¸­çš„ï¼‰
            var currentDetailIds = validDetails.Where(d => d.Id > 0).Select(d => d.Id).ToList();
            var detailsToDelete = existingDetails.Where(e => !currentDetailIds.Contains(e.Id)).ToList();
            

            foreach (var detailToDelete in detailsToDelete)
            {
                // ğŸ”‘ å¦‚æœæœ‰å ±åƒ¹å–®ä¾†æºï¼Œæ¸›å°‘å ±åƒ¹å–®æ˜ç´°çš„å·²è½‰éŠ·è²¨æ•¸é‡
                if (detailToDelete.QuotationDetailId.HasValue)
                {
                    await UpdateQuotationDetailConvertedQuantity(
                        detailToDelete.QuotationDetailId.Value,
                        detailToDelete.OrderQuantity,
                        isAdding: false
                    );
                }
                
                await SalesOrderDetailService.PermanentDeleteAsync(detailToDelete.Id);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveSalesOrderDetails), GetType(), 
                additionalData: $"å„²å­˜éŠ·è²¨è¨‚å–®æ˜ç´°å¤±æ•— - OrderId: {salesOrderId}");
            throw; // é‡æ–°æ‹‹å‡ºä¾‹å¤–ï¼Œè®“ä¸Šå±¤è™•ç†
        }
    }

    /// <summary>
    /// æ›´æ–°å ±åƒ¹å–®æ˜ç´°çš„å·²è½‰éŠ·è²¨æ•¸é‡
    /// </summary>
    private async Task UpdateQuotationDetailConvertedQuantity(int quotationDetailId, decimal quantity, bool isAdding)
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var quotationDetail = await context.QuotationDetails.FindAsync(quotationDetailId);
            
            if (quotationDetail != null)
            {
                if (isAdding)
                {
                    quotationDetail.ConvertedQuantity += quantity;
                }
                else
                {
                    quotationDetail.ConvertedQuantity -= quantity;
                    // ç¢ºä¿ä¸æœƒè®Šæˆè² æ•¸
                    if (quotationDetail.ConvertedQuantity < 0)
                        quotationDetail.ConvertedQuantity = 0;
                }
                
                quotationDetail.UpdatedAt = DateTime.Now;
                await context.SaveChangesAsync();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(UpdateQuotationDetailConvertedQuantity), GetType(),
                additionalData: new { QuotationDetailId = quotationDetailId, Quantity = quantity, IsAdding = isAdding });
            // ä¸æ‹‹å‡ºç•°å¸¸ï¼Œé¿å…å½±éŸ¿ä¸»æµç¨‹
        }
    }

    /// <summary>
    /// ä½¿ç”¨FIFOæ–¹å¼æ‰£æ¸›åº«å­˜
    /// </summary>
    private async Task ReduceInventoryWithFIFOAsync(int salesOrderId)
    {
        try
        {
            // åªè™•ç†æœ‰æ•ˆçš„æ˜ç´°ï¼ˆå·²é¸æ“‡ç”¢å“å’Œå€‰åº«çš„ï¼‰
            var validDetails = salesOrderDetails
                .Where(d => d.ProductId > 0 && d.OrderQuantity > 0 && d.WarehouseId.HasValue)
                .ToList();

            foreach (var detail in validDetails)
            {
                if (!detail.WarehouseId.HasValue) continue;

                var result = await InventoryStockService.ReduceStockWithFIFOAsync(
                    detail.ProductId,
                    detail.WarehouseId.Value,
                    (int)Math.Ceiling(detail.OrderQuantity),
                    InventoryTransactionTypeEnum.Sale,
                    $"SO-{salesOrderId}",
                    null, // WarehouseLocationId - SalesOrderDetailæ²’æœ‰æ­¤æ¬„ä½ï¼Œå‚³å…¥null
                    $"éŠ·è²¨è¨‚å–®å‡ºè²¨ - SO-{salesOrderId}",
                    detail.Id > 0 ? detail.Id : null // å‚³éæ˜ç´°IDç”¨æ–¼è¿½è¹¤
                );

                if (!result.IsSuccess)
                {
                    await NotificationService.ShowWarningAsync($"å•†å“ {detail.Product?.Name} åº«å­˜æ‰£æ¸›å¤±æ•—ï¼š{result.ErrorMessage}");
                    // ä¸ä¸­æ–·æµç¨‹ï¼Œåªè¨˜éŒ„è­¦å‘Š
                }
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ReduceInventoryWithFIFOAsync), GetType(), 
                additionalData: $"FIFOåº«å­˜æ‰£æ¸›å¤±æ•— - OrderId: {salesOrderId}");
            await NotificationService.ShowWarningAsync("åº«å­˜æ‰£æ¸›æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥åº«å­˜è¨˜éŒ„");
        }
    }
    
    // ===== å¾å ±åƒ¹å–®è½‰å–®ç›¸é—œæ–¹æ³• =====
    
    /// <summary>
    /// æ‰“é–‹æ–°å¢éŠ·è²¨è¨‚å–® Modal ä¸¦é å¡«å ±åƒ¹å–®è³‡æ–™ï¼ˆå…¬é–‹æ–¹æ³•ï¼Œä¾›çˆ¶çµ„ä»¶å‘¼å«ï¼‰
    /// </summary>
    public async Task ShowAddModalWithPrefilledQuotation(int customerId, int quotationId)
    {
        try
        {
            // ä½¿ç”¨ DocumentConversionHelper è™•ç†è½‰å–®é‚è¼¯ï¼ˆè‡ªè¨‚è¼‰å…¥é‚è¼¯ç‰ˆæœ¬ï¼‰
            var success = await DocumentConversionHelper.ShowConversionModalWithCustomLoadAsync(
                resetEntityId: () => SalesOrderId = null,
                setPrefilledValues: () =>
                {
                    PrefilledCustomerId = customerId;
                    PrefilledQuotationId = quotationId;
                },
                isVisibleChanged: IsVisibleChanged,
                customLoadAction: async () =>
                {
                    await LoadQuotationDetailsToSalesOrder(quotationId);
                },
                detailManagerReady: () => salesOrderDetailManager != null,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("è½‰å–®æµç¨‹åŸ·è¡Œå¤±æ•—");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledQuotation), GetType(), 
                additionalData: $"é–‹å•Ÿé å¡«éŠ·è²¨è¨‚å–®Modalå¤±æ•— - CustomerId: {customerId}, QuotationId: {quotationId}");
            await NotificationService.ShowErrorAsync("é–‹å•ŸéŠ·è²¨è¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    /// <summary>
    /// å¾å ±åƒ¹å–®è¼‰å…¥æ˜ç´°åˆ°éŠ·è²¨è¨‚å–®æ˜ç´°è¡¨
    /// </summary>
    private async Task LoadQuotationDetailsToSalesOrder(int quotationId)
    {
        try
        {
            // è¼‰å…¥å ±åƒ¹å–®è³‡æ–™ï¼ˆå«æ˜ç´°å’Œå¯©æ ¸ç‹€æ…‹ï¼‰
            var quotation = await QuotationService.GetWithDetailsAsync(quotationId);
            if (quotation == null)
            {
                await NotificationService.ShowWarningAsync("æ‰¾ä¸åˆ°æŒ‡å®šçš„å ±åƒ¹å–®", "è¼‰å…¥å¤±æ•—");
                return;
            }
            
            // è¨˜éŒ„å¯©æ ¸ç‹€æ…‹
            isSourceQuotationApproved = quotation.IsApproved;
            
            // è¼‰å…¥ç³»çµ±åƒæ•¸ï¼šæ˜¯å¦å•Ÿç”¨å ±åƒ¹å–®å¯©æ ¸
            var systemParameter = await SystemParameterService.GetSystemParameterAsync();
            isApprovalEnabled = systemParameter?.EnableQuotationApproval ?? false;
            
            // é©—è­‰å ±åƒ¹å–®æ˜ç´°
            if (quotation.QuotationDetails == null || !quotation.QuotationDetails.Any())
            {
                await NotificationService.ShowWarningAsync("å ±åƒ¹å–®æ²’æœ‰æ˜ç´°è³‡æ–™", "è¼‰å…¥å¤±æ•—");
                return;
            }
            
            // ä½¿ç”¨ SalesOrderTable çš„å…¬é–‹æ–¹æ³•è¼‰å…¥æ˜ç´°
            if (salesOrderDetailManager != null)
            {
                await salesOrderDetailManager.LoadQuotationDetails(
                    quotation.QuotationDetails.ToList(), 
                    quotationId, 
                    quotation.IsApproved
                );
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadQuotationDetailsToSalesOrder), GetType(),
                additionalData: new { QuotationId = quotationId });
            await NotificationService.ShowErrorAsync("è¼‰å…¥å ±åƒ¹å–®æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    /// <summary>
    /// å¾å ±åƒ¹å–®è¼‰å…¥è³‡æ–™åˆ°éŠ·è²¨è¨‚å–®
    /// æ³¨æ„ï¼šå¯¦éš›çš„è½‰å–®é‚è¼¯ç”± QuotationEditModalComponent åœ¨å„²å­˜æ™‚è™•ç†
    /// é€™è£¡åªæ˜¯é ç•™åƒæ•¸ï¼Œå¯¦éš›ä½¿ç”¨ PrefilledCustomerId
    /// </summary>
    private async Task LoadDataFromQuotation(SalesOrder salesOrder, int quotationId)
    {
        try
        {
            // è¼‰å…¥å ±åƒ¹å–®è³‡æ–™ï¼ˆå«æ˜ç´°å’Œå¯©æ ¸ç‹€æ…‹ï¼‰
            var quotation = await QuotationService.GetWithDetailsAsync(quotationId);
            if (quotation == null)
            {
                await NotificationService.ShowWarningAsync("æ‰¾ä¸åˆ°æŒ‡å®šçš„å ±åƒ¹å–®", "è¼‰å…¥å¤±æ•—");
                return;
            }
            
            // è¨­å®šå®¢æˆ¶ID
            salesOrder.CustomerId = quotation.CustomerId;
            
            // è¨˜éŒ„å¯©æ ¸ç‹€æ…‹
            isSourceQuotationApproved = quotation.IsApproved;
            
            // è¼‰å…¥ç³»çµ±åƒæ•¸ï¼šæ˜¯å¦å•Ÿç”¨å ±åƒ¹å–®å¯©æ ¸
            var systemParameter = await SystemParameterService.GetSystemParameterAsync();
            isApprovalEnabled = systemParameter?.EnableQuotationApproval ?? false;
            
            // æ³¨æ„ï¼šæ˜ç´°çš„è¼‰å…¥å°‡ç”±çˆ¶çµ„ä»¶ï¼ˆQuotationEditModalComponentï¼‰çš„ HandleCreateSalesOrderFromQuotation è™•ç†
            // é€™è£¡ä¸ç›´æ¥è™•ç†æ˜ç´°è½‰æ›ï¼Œåªè¨­å®šå¯©æ ¸ç‹€æ…‹å’Œå®¢æˆ¶
            salesOrderDetails.Clear();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDataFromQuotation), GetType(),
                additionalData: new { QuotationId = quotationId });
        }
    }
}
