@using ERPCore2.Services.Reports.Interfaces
@using ERPCore2.Models.Reports
@inject ISalesOrderService SalesOrderService
@inject ISalesOrderDetailService SalesOrderDetailService
@inject ISalesOrderCompositionDetailService SalesOrderCompositionDetailService
@inject ISalesReturnDetailService SalesReturnDetailService
@inject IInventoryStockService InventoryStockService
@inject ICustomerService CustomerService
@inject ICompanyService CompanyService
@inject IProductService ProductService
@inject IEmployeeService EmployeeService
@inject IUnitService UnitService
@inject IWarehouseService WarehouseService
@inject ISystemParameterService SystemParameterService
@inject INotificationService NotificationService
@inject NavigationManager NavigationManager
@inject ActionButtonHelper ActionButtonHelper
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ISalesReturnService SalesReturnService
@inject ISetoffDocumentService SetoffDocumentService
@inject IReportPrintConfigurationService ReportPrintConfigurationService
@inject IQuotationService QuotationService
@inject IQuotationDetailService QuotationDetailService
@inject ISalesOrderReportService SalesOrderReportService
@inject ERPCore2.Data.Context.AppDbContext DbContext
@inject IDbContextFactory<AppDbContext> DbContextFactory

<GenericEditModalComponent TEntity="SalesOrder" 
                          TService="ISalesOrderService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@SalesOrderId"
                          Service="@SalesOrderService"
                          EntityName="è¨‚å–®"
                          EntityNamePlural="è¨‚å–®"
                          ModalTitle="@(SalesOrderId.HasValue ? "ç·¨è¼¯è¨‚å–®" : "æ–°å¢è¨‚å–®")"
                          Size="GenericEditModalComponent<SalesOrder, ISalesOrderService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@autoCompleteConfig?.Prefillers"
                          AutoCompleteCollections="@autoCompleteConfig?.Collections"
                          AutoCompleteDisplayProperties="@autoCompleteConfig?.DisplayProperties"
                          AutoCompleteValueProperties="@autoCompleteConfig?.ValueProperties"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadSalesOrderData"
                          SaveHandler="@SaveSalesOrderWrapper"
                          SaveSuccessMessage="@(SalesOrderId.HasValue ? "è¨‚å–®æ›´æ–°æˆåŠŸ" : "è¨‚å–®æ–°å¢æˆåŠŸ")"
                          SaveFailureMessage="è¨‚å–®å„²å­˜å¤±æ•—"
                          RequiredPermission="SalesOrder.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          GetStatusMessage="@GetStatusMessage"
                          FormHeaderContent="@WarningMessage"
                          CustomModules="@GetCustomModules()"
                          CustomActionButtons="@GetCustomActionButtons()"
                          ShowPrintButton="true"
                          OnPrint="@HandlePrint"
                          OnEntityLoaded="@HandleEntityLoaded"
                          >

</GenericEditModalComponent>

@* å®¢æˆ¶ç·¨è¼¯ Modal *@
<CustomerEditModalComponent @ref="customerEditModal"
                           IsVisible="@customerModalManager.IsModalVisible"
                           IsVisibleChanged="@customerModalManager.HandleModalVisibilityChangedAsync"
                           CustomerId="@customerModalManager.SelectedEntityId"
                           OnCustomerSaved="@OnCustomerSavedWrapper"
                           OnCancel="@customerModalManager.HandleModalCancelAsync" />

@* å…¬å¸ç·¨è¼¯ Modal *@
<CompanyEditModalComponent @ref="companyEditModal"
                          IsVisible="@companyModalManager.IsModalVisible"
                          IsVisibleChanged="@companyModalManager.HandleModalVisibilityChangedAsync"
                          CompanyId="@companyModalManager.SelectedEntityId"
                          OnCompanySaved="@OnCompanySavedWrapper"
                          OnCancel="@companyModalManager.HandleModalCancelAsync" />

@* æ¥­å‹™å“¡ç·¨è¼¯ Modal *@
<EmployeeEditModalComponent @ref="employeeEditModal"
                           IsVisible="@employeeModalManager.IsModalVisible"
                           IsVisibleChanged="@employeeModalManager.HandleModalVisibilityChangedAsync"
                           EmployeeId="@employeeModalManager.SelectedEntityId"
                           OnEmployeeSaved="@OnEmployeeSavedWrapper"
                           OnCancel="@employeeModalManager.HandleModalCancelAsync" />

@* éŠ·è²¨é€€å›ç·¨è¼¯ Modal *@
<SalesReturnEditModalComponent @ref="salesReturnEditModal"
                              IsVisible="@showSalesReturnModal"
                              IsVisibleChanged="@((bool visible) => showSalesReturnModal = visible)"
                              SalesReturnId="@selectedSalesReturnId"
                              OnSalesReturnSaved="@HandleSalesReturnSaved"
                              OnCancel="@(() => showSalesReturnModal = false)" />

@* éŠ·è²¨å‡ºè²¨å–®ç·¨è¼¯ Modal *@
<SalesDeliveryEditModalComponent @ref="salesDeliveryEditModal"
                                IsVisible="@showSalesDeliveryModal"
                                IsVisibleChanged="@(value => showSalesDeliveryModal = value)"
                                SalesDeliveryId="@selectedSalesDeliveryId"
                                OnSalesDeliverySaved="@HandleSalesDeliverySaved"
                                OnCancel="@(() => showSalesDeliveryModal = false)" />

@* æ²–æ¬¾å–®ç·¨è¼¯ Modal *@
<SetoffDocumentEditModalComponent @ref="setoffDocumentEditModal"
                                 IsVisible="@showSetoffDocumentModal"
                                 IsVisibleChanged="@((bool visible) => showSetoffDocumentModal = visible)"
                                 SetoffDocumentId="@selectedSetoffDocumentId"
                                 OnSetoffDocumentSaved="@HandleSetoffDocumentSaved"
                                 OnCancel="@(() => showSetoffDocumentModal = false)" />

@* ç”Ÿç”¢æ’ç¨‹ç·¨è¼¯ Modal *@
<ProductionScheduleEditModalComponent @ref="productionScheduleEditModal"
                                     IsVisible="@showProductionScheduleModal"
                                     IsVisibleChanged="@HandleProductionScheduleModalVisibleChanged"
                                     ProductionScheduleId="@selectedProductionScheduleId"
                                     OnProductionScheduleSaved="@HandleScheduleCreated"
                                     OnCancel="@HandleProductionScheduleModalClosed" />

@* è¨‚å–®åº«å­˜æª¢è¦– Modal *@
<OrderInventoryCheckModal IsVisible="@showInventoryCheckModal"
                         IsVisibleChanged="@((bool visible) => showInventoryCheckModal = visible)"
                         SalesOrderId="@SalesOrderId"
                         OrderNumber="@(editModalComponent?.Entity?.Code)"
                         OnClose="@(() => showInventoryCheckModal = false)" />

@* å ±è¡¨é è¦½ Modal *@
<ReportPreviewModalComponent IsVisible="@_showReportPreviewModal"
                             IsVisibleChanged="@((bool visible) => _showReportPreviewModal = visible)"
                             Title="éŠ·è²¨å–®é è¦½"
                             PreviewImages="@_reportPreviewImages"
                             FormattedDocument="@_formattedDocument"
                             ReportId="SO002"
                             DocumentName="@_reportDocumentName"
                             OnPrintSuccess="@HandleReportPrintSuccess"
                             OnPaperSettingChanged="@HandlePaperSettingChanged"
                             OnCancel="@(() => _showReportPreviewModal = false)" />

@code {
    // ===== å¿…è¦åƒæ•¸ =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SalesOrderId { get; set; }
    [Parameter] public EventCallback<SalesOrder> OnSalesOrderSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    
    // ===== é å¡«åƒæ•¸ï¼ˆç”¨æ–¼å¾å ±åƒ¹å–®è½‰å–®ï¼‰ =====
    [Parameter] public int? PrefilledCustomerId { get; set; }
    [Parameter] public int? PrefilledQuotationId { get; set; }

    // ===== å…§éƒ¨ç‹€æ…‹ =====
    private GenericEditModalComponent<SalesOrder, ISalesOrderService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // AutoComplete é…ç½®
    private AutoCompleteConfig? autoCompleteConfig;
    
    private List<Customer> customers = new();
    private List<Company> companies = new();
    private List<Employee> employees = new();
    private List<Product> products = new();
    private List<Unit> units = new();
    private List<Warehouse> warehouses = new();
    private List<Quotation> quotations = new();
    
    // è¨‚å–®æ˜ç´°
    private List<SalesOrderDetail> salesOrderDetails = new();
    
    // æ˜ç´°ç®¡ç†çµ„ä»¶å¼•ç”¨
    private SalesOrderTable<SalesOrder, SalesOrderDetail>? salesOrderDetailManager;
    
    // Modal Manager é›†åˆ
    private ModalManagerCollection? modalManagers;
    
    // Modal ç®¡ç†å™¨
    private CustomerEditModalComponent? customerEditModal;
    private RelatedEntityModalManager<Customer> customerModalManager = default!;
    private CompanyEditModalComponent? companyEditModal;
    private RelatedEntityModalManager<Company> companyModalManager = default!;
    private EmployeeEditModalComponent? employeeEditModal;
    private RelatedEntityModalManager<Employee> employeeModalManager = default!;
    private RelatedEntityModalManager<Product> productModalManager = default!;
    
    // å•†å“ç¯©é¸
    private int? filterProductId = null;
    
    // ===== ç›¸é—œå–®æ“š Modal =====
    private SalesReturnEditModalComponent? salesReturnEditModal;
    private SetoffDocumentEditModalComponent? setoffDocumentEditModal;
    private bool showSalesReturnModal = false;
    private bool showSetoffDocumentModal = false;
    private int? selectedSalesReturnId = null;
    private int? selectedSetoffDocumentId = null;
    
    // éŠ·è²¨å‡ºè²¨å–® Modal
    private SalesDeliveryEditModalComponent? salesDeliveryEditModal;
    private bool showSalesDeliveryModal = false;
    private int? selectedSalesDeliveryId = null;
    
    // ç”Ÿç”¢æ’ç¨‹ç·¨è¼¯ Modal
    private ProductionScheduleEditModalComponent? productionScheduleEditModal;
    private bool showProductionScheduleModal = false;
    private int? selectedProductionScheduleId = null;
    
    // è¨‚å–®åº«å­˜æª¢è¦– Modal
    private bool showInventoryCheckModal = false;
    
    // åº«å­˜ä¸è¶³ç‹€æ…‹
    private bool hasInventoryShortage = false;
    private bool isInventoryCheckLoading = false;
    
    // ä¸‹æ‹‰é¸å–®é¸é …
    private List<SelectOption> taxCalculationMethodOptions = new();
    
    // ç¨…ç‡å¿«å–è®Šæ•¸ï¼ˆä¸€æ¬¡æ€§è¼‰å…¥ï¼Œé¿å…æ¯æ¬¡è¨ˆç®—éƒ½æŸ¥è©¢è³‡æ–™åº«ï¼‰
    private decimal currentTaxRate = 5.0m; // é è¨­ 5%ï¼Œå¯¦éš›å€¼æœƒåœ¨åˆå§‹åŒ–æ™‚å¾è³‡æ–™åº«è¼‰å…¥
    
    // ===== é–å®šç‹€æ…‹ =====
    private bool hasUndeletableDetails = false;
    private bool isDetailDataReady = false;
    private bool isDataLoaded = false;  // è³‡æ–™è¼‰å…¥ç‹€æ…‹æ¨™è¨˜
    
    // ===== åˆ—å°ç›¸é—œç‹€æ…‹ =====
    private bool canPrint = false; // æ˜¯å¦å¯ä»¥åˆ—å°ï¼ˆæ–°å¢æ¨¡å¼éœ€å…ˆå„²å­˜ï¼Œç·¨è¼¯æ¨¡å¼ç›´æ¥ç‚º trueï¼‰
    private bool _showReportPreviewModal = false; // æ˜¯å¦é¡¯ç¤ºå ±è¡¨é è¦½ Modal
    private List<byte[]>? _reportPreviewImages = null; // å ±è¡¨é è¦½åœ–ç‰‡ï¼ˆæ ¼å¼åŒ–æ¨¡å¼ï¼‰
    private FormattedDocument? _formattedDocument = null; // æ ¼å¼åŒ–æ–‡ä»¶ï¼ˆç”¨æ–¼åˆ—å°ï¼‰
    private string _reportDocumentName = string.Empty; // åˆ—å°æ–‡ä»¶åç¨±

    // ===== å¿…è¦æ–¹æ³• =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // ä½¿ç”¨ ModalManagerInitHelper åˆå§‹åŒ–æ‰€æœ‰ Manager
            modalManagers = ModalManagerInitHelper.CreateBuilder<SalesOrder, ISalesOrderService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Customer>(nameof(SalesOrder.CustomerId), "å®¢æˆ¶")
                .AddManager<Company>(nameof(SalesOrder.CompanyId), "å…¬å¸")
                .AddManager<Employee>(nameof(SalesOrder.EmployeeId), "æ¥­å‹™å“¡")
                .AddManager<Product>("FilterProductId", "å•†å“")
                .Build();
            
            // å–å¾—å€‹åˆ¥ Manager ä¾›çµ„ä»¶ä½¿ç”¨
            customerModalManager = modalManagers.Get<Customer>(nameof(SalesOrder.CustomerId));
            companyModalManager = modalManagers.Get<Company>(nameof(SalesOrder.CompanyId));
            employeeModalManager = modalManagers.Get<Employee>(nameof(SalesOrder.EmployeeId));
            productModalManager = modalManagers.Get<Product>("FilterProductId");
            
            // ç§»é™¤è‡ªå‹•è¼‰å…¥è³‡æ–™ï¼Œæ”¹ç‚ºåœ¨ OnParametersSetAsync ä¸­æ ¹æ“š IsVisible è¼‰å…¥
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–è¨‚å–®ç·¨è¼¯çµ„ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            if (IsVisible && !isDataLoaded)
            {
                await LoadAdditionalDataAsync();
                await InitializeFormFieldsAsync();
                isDataLoaded = true;
            }
            else if (!IsVisible)
            {
                isDetailDataReady = false;
                isDataLoaded = false;
            }

            await base.OnParametersSetAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"åƒæ•¸è¨­ç½®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    private async Task HandleSaveSuccess()
    {
        try
        {
            if (OnSalesOrderSaved.HasDelegate && editModalComponent?.Entity != null)
            {
                await OnSalesOrderSaved.InvokeAsync(editModalComponent.Entity);
                canPrint = true; // å„²å­˜æˆåŠŸå¾Œå¯ä»¥åˆ—å°
            }
            // ä¸éœ€è¦æ‰‹å‹•é—œé–‰ Modalï¼ŒGenericEditModalComponent æœƒè™•ç†
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†æˆåŠŸäº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    private async Task HandleCancel()
    {
        try
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }
            // ä¸è¦ç›´æ¥èª¿ç”¨ CloseModalï¼Œè®“ GenericEditModalComponent è™•ç†
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é—œé–‰è¦–çª—æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    private async Task<SalesOrder?> LoadSalesOrderData()
    {
        try
        {
            // é‡ç½®æ˜ç´°è³‡æ–™æº–å‚™ç‹€æ…‹
            isDetailDataReady = false;
            hasUndeletableDetails = false;
            canPrint = false; // é è¨­ä¸å¯åˆ—å°
            
            if (!SalesOrderId.HasValue)
            {
                // æ–°å¢æ¨¡å¼
                var newOrder = new SalesOrder
                {
                    Code = await EntityCodeGenerationHelper.GenerateForEntity<SalesOrder, ISalesOrderService>(SalesOrderService, DbContext),
                    OrderDate = DateTime.Today,
                    ExpectedDeliveryDate = DateTime.Today.AddDays(7),
                    Status = EntityStatus.Active,
                    TotalAmount = 0
                };
                
                // å–å¾—é è¨­å…¬å¸
                var primaryCompany = await CompanyService.GetPrimaryCompanyAsync();
                newOrder.CompanyId = primaryCompany?.Id ?? 0;
                
                // å¦‚æœæ˜¯å¾å ±åƒ¹å–®è½‰å–®ï¼Œè¼‰å…¥å ±åƒ¹å–®è³‡æ–™
                if (PrefilledQuotationId.HasValue)
                {
                    await LoadDataFromQuotation(newOrder, PrefilledQuotationId.Value);
                }
                else if (PrefilledCustomerId.HasValue)
                {
                    newOrder.CustomerId = PrefilledCustomerId.Value;
                }
                
                // æ¸…ç©ºæ˜ç´°
                if (!PrefilledQuotationId.HasValue)
                {
                    salesOrderDetails.Clear();
                }
                
                isDetailDataReady = true;
                return newOrder;
            }

            // ç·¨è¼¯æ¨¡å¼
            var salesOrder = await SalesOrderService.GetWithDetailsAsync(SalesOrderId.Value);
            
            if (salesOrder != null)
            {
                // è¼‰å…¥è¨‚å–®æ˜ç´°
                await LoadSalesOrderDetails(SalesOrderId.Value);
                
                // è¼‰å…¥æ˜ç´°ç›¸é—œè³‡æ–™ï¼ˆé€€è²¨è¨˜éŒ„ã€æ”¶æ¬¾è¨˜éŒ„ï¼‰
                await LoadDetailRelatedDataAsync();
                
                // æª¢æŸ¥åº«å­˜ä¸è¶³ç‹€æ…‹
                await CheckInventoryShortageAsync();
                
                isDetailDataReady = true;
                
                // ç·¨è¼¯æ¨¡å¼å¯ä»¥åˆ—å°
                canPrint = true;
                StateHasChanged();
            }
            else
            {
                isDetailDataReady = true;
            }
            
            return salesOrder;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥è¨‚å–®è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            isDetailDataReady = true; // éŒ¯èª¤ä¹Ÿè¦å…è¨±æ¸²æŸ“
            return null;
        }
    }

    /// <summary>
    /// è¼‰å…¥æ˜ç´°ç›¸é—œè³‡æ–™ï¼ˆå‡ºè²¨ã€æ’ç¨‹ã€æ”¶æ¬¾è¨˜éŒ„ï¼‰- ç”¨æ–¼åˆ¤æ–·æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
    /// å¿…é ˆåœ¨ DataLoader ä¸­åŒæ­¥åŸ·è¡Œï¼Œç¢ºä¿ç‹€æ…‹è¨Šæ¯æ­£ç¢ºé¡¯ç¤º
    /// è¨‚å–®éœ€è¦æª¢æŸ¥ä¸‰ç¨®ä¸‹ä¸€æ­¥å‹•ä½œï¼š
    /// 1. DeliveredQuantity > 0ï¼šå·²æœ‰å‡ºè²¨è¨˜éŒ„
    /// 2. ScheduledQuantity > 0ï¼šå·²æœ‰ç”Ÿç”¢æ’ç¨‹
    /// 3. TotalReceivedAmount > 0ï¼šå·²æœ‰æ”¶æ¬¾è¨˜éŒ„
    /// </summary>
    private async Task LoadDetailRelatedDataAsync()
    {
        try
        {
            if (!salesOrderDetails.Any())
            {
                hasUndeletableDetails = false;
                return;
            }

            bool hasUndeletable = false;
            
            foreach (var detail in salesOrderDetails.Where(d => d.Id > 0))
            {
                //  ä½¿ç”¨ DetailLockHelper æª¢æŸ¥ä¸‰ç¨®ä¸‹ä¸€æ­¥å‹•ä½œ
                // æª¢æŸ¥ 1ï¼šå‡ºè²¨è¨˜éŒ„ (DeliveredQuantity)
                // æª¢æŸ¥ 2ï¼šæ’ç¨‹è¨˜éŒ„ (ScheduledQuantity)
                // æª¢æŸ¥ 3ï¼šæ”¶æ¬¾è¨˜éŒ„ (TotalReceivedAmount)
                bool canDelete = DetailLockHelper.CanDeleteItem(
                    detail, 
                    out string reason, 
                    checkDelivery: true,    // æª¢æŸ¥ DeliveredQuantity
                    checkSchedule: true,    // æª¢æŸ¥ ScheduledQuantity
                    checkPayment: true);    // æª¢æŸ¥ TotalReceivedAmount
                
                if (!canDelete)
                {
                    hasUndeletable = true;
                    break;
                }
            }
            
            hasUndeletableDetails = hasUndeletable;
            
            if (hasUndeletableDetails)
            {
                UpdateFieldsReadOnlyState();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥æ˜ç´°ç›¸é—œè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            hasUndeletableDetails = false;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰è³‡æ–™
            var tasks = new List<Task>
            {
                Task.Run(async () => customers = await CustomerService.GetAllAsync()),
                Task.Run(async () => companies = await CompanyService.GetAllAsync()),
                Task.Run(async () => employees = (await EmployeeService.GetAllAsync()).Where(e => !e.IsSuperAdmin).ToList()),
                Task.Run(async () => products = await ProductService.GetAllAsync()),
                Task.Run(async () => units = await UnitService.GetAllAsync()),
                Task.Run(async () => warehouses = await WarehouseService.GetAllAsync()),
                Task.Run(async () => quotations = await QuotationService.GetAllAsync())
            };
            
            await Task.WhenAll(tasks);
            
            // ä¸€æ¬¡æ€§è¼‰å…¥ç³»çµ±ç¨…ç‡ï¼ˆé¿å…æ¯æ¬¡è¨ˆç®—éƒ½æŸ¥è©¢è³‡æ–™åº«ï¼‰
            currentTaxRate = await TaxCalculationHelper.LoadTaxRateAsync(SystemParameterService);
            
            // åˆå§‹åŒ–ç¨…åˆ¥é¸é …
            taxCalculationMethodOptions = new List<SelectOption>
            {
                new SelectOption { Text = "å¤–åŠ ç¨…", Value = ((int)TaxCalculationMethod.TaxExclusive).ToString() },
                new SelectOption { Text = "å…§å«ç¨…", Value = ((int)TaxCalculationMethod.TaxInclusive).ToString() },
                new SelectOption { Text = "ä¸å«ç¨…", Value = ((int)TaxCalculationMethod.NoTax).ToString() }
            };
            
            // å»ºç«‹ AutoComplete é…ç½®
            autoCompleteConfig = new AutoCompleteConfigBuilder<SalesOrder>()
                .AddField(nameof(SalesOrder.CustomerId), "CompanyName", customers)
                .AddField(nameof(SalesOrder.CompanyId), "CompanyName", companies)
                .AddField(nameof(SalesOrder.EmployeeId), "Name", employees)
                .AddField(nameof(SalesOrder.QuotationId), "Code", quotations)
                .AddField("FilterProductId", "Name", products)
                .Build();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥é¡å¤–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            
            // è¨­å®šå®‰å…¨çš„é è¨­å€¼
            customers = new List<Customer>();
            companies = new List<Company>();
            employees = new List<Employee>();
            products = new List<Product>();
            units = new List<Unit>();
            warehouses = new List<Warehouse>();
            quotations = new List<Quotation>();
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SalesOrder.Code),
                    Label = "éŠ·è²¨å–®è™Ÿ",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥éŠ·è²¨å–®è™Ÿ",
                    IsRequired = true,
                    MaxLength = 30,
                    HelpText = "è¨‚å–®çš„å”¯ä¸€ç·¨è™Ÿï¼Œæ–°å¢æ™‚ç³»çµ±æœƒè‡ªå‹•ç”¢ç”Ÿï¼Œä¹Ÿå¯æ‰‹å‹•ä¿®æ”¹",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.CustomerId),
                    Label = "å®¢æˆ¶",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡å®¢æˆ¶",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "è¼¸å…¥å®¢æˆ¶åç¨±é€²è¡Œæœå°‹ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                    ActionButtons = await GetCustomerActionButtonsAsync(),
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = "FilterProductId", // ç¯©é¸ç”¨çš„è™›æ“¬æ¬„ä½
                    Label = "å•†å“",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡å•†å“",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "é¸æ“‡ç‰¹å®šå•†å“é€²è¡Œç¯©é¸ï¼Œæˆ–ç•™ç©ºé¡¯ç¤ºæ‰€æœ‰å•†å“"
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesOrder.QuotationId),
                    Label = "å ±åƒ¹å–®",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡å ±åƒ¹å–®",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "æ­¤è¨‚å–®æ‰€åƒè€ƒçš„å ±åƒ¹å–®å–®è™Ÿï¼ˆè‹¥æœ‰ï¼‰",
                    IsReadOnly = hasUndeletableDetails,
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.CompanyId),
                    Label = "å…¬å¸",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹é¸æ“‡å…¬å¸",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "é¸æ“‡é€²è¡Œæ­¤æ¬¡éŠ·è²¨çš„å…¬å¸",
                    ActionButtons = await GetCompanyActionButtonsAsync(),
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.EmployeeId),
                    Label = "æ¥­å‹™å“¡",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹é¸æ“‡æ¥­å‹™å“¡",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "é¸æ“‡è² è²¬æ­¤è¨‚å–®çš„æ¥­å‹™å“¡",
                    ActionButtons = await GetEmployeeActionButtonsAsync(),
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.OrderDate),
                    Label = "è¨‚å–®æ—¥æœŸ",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "è¨‚å–®å»ºç«‹æ—¥æœŸ",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.TaxCalculationMethod),
                    Label = "ç¨…åˆ¥",
                    FieldType = FormFieldType.Select,
                    IsRequired = true,
                    Options = taxCalculationMethodOptions,
                    HelpText = "ç¨…é¡è¨ˆç®—æ–¹å¼ï¼šå¤–åŠ ç¨…ï¼ˆç¨…é¡å¦åŠ ï¼‰ã€å…§å«ç¨…ï¼ˆåƒ¹æ ¼å·²å«ç¨…ï¼‰ã€ä¸å«ç¨…ï¼ˆå…ç¨…ï¼‰",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.ExpectedDeliveryDate),
                    Label = "é äº¤æ—¥",
                    FieldType = FormFieldType.Date,
                    IsRequired = false,
                    HelpText = "é è¨ˆå‡ºè²¨çµ¦å®¢æˆ¶çš„æ—¥æœŸ",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },

                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesOrder.TotalAmount),
                    Label = "é‡‘é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "éŠ·è²¨å–®çš„ç¸½é‡‘é¡ï¼Œæ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—ï¼ˆæ˜ç´°çš„æ•¸é‡ Ã— å–®åƒ¹ç¸½å’Œï¼‰",
                    IsReadOnly = true, // ç¸½é‡‘é¡æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                    CssClass = "text-warning fw-bold" // ä½¿ç”¨é»ƒè‰²ç²—é«”é¡¯ç¤º
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesOrder.DiscountAmount),
                    Label = "æŠ˜æ‰£",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "éŠ·è²¨å–®çš„æŠ˜æ‰£é‡‘é¡ï¼Œæ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®— = (æ•¸é‡ Ã— å–®åƒ¹ Ã— æŠ˜æ‰£%)",
                    IsReadOnly = true, // æŠ˜æ‰£æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                    CssClass = "text-danger fw-bold" // ä½¿ç”¨ç´…è‰²ç²—é«”é¡¯ç¤º
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesOrder.SalesTaxAmount),
                    Label = "ç¨…é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "éŠ·è²¨å–®çš„ç¨…é¡ï¼Œæ ¹æ“šé‡‘é¡å’Œç¨…ç‡è‡ªå‹•è¨ˆç®— = (æŠ˜æ‰£å¾Œé‡‘é¡ Ã— ç¨…ç‡%)",
                    IsReadOnly = true, // ç¨…é¡æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                    CssClass = "text-info fw-bold" // ä½¿ç”¨è—è‰²ç²—é«”é¡¯ç¤º
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesOrder.TotalAmountWithTax),
                    Label = "ç¸½é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "éŠ·è²¨å–®çš„å«ç¨…ç¸½é‡‘é¡ï¼Œæ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—ï¼ˆé‡‘é¡ - æŠ˜æ‰£ + ç¨…é¡ï¼‰",
                    IsReadOnly = true, // å«ç¨…ç¸½é‡‘é¡æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                    CssClass = "text-success fw-bold" // ä½¿ç”¨ç¶ è‰²ç²—é«”é¡¯ç¤º
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.PaymentTerms),
                    Label = "ä»˜æ¬¾æ¢ä»¶",
                    FieldType = FormFieldType.TextArea,
                    Placeholder = "è«‹è¼¸å…¥ä»˜æ¬¾æ¢ä»¶",
                    IsRequired = false,
                    MaxLength = 100,
                    HelpText = "èˆ‡å®¢æˆ¶ç´„å®šçš„ä»˜æ¬¾æ–¹å¼å’ŒæœŸé™",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.DeliveryTerms),
                    Label = "äº¤è²¨æ¢ä»¶",
                    FieldType = FormFieldType.TextArea,
                    Placeholder = "è«‹è¼¸å…¥äº¤è²¨æ¢ä»¶",
                    IsRequired = false,
                    MaxLength = 100,
                    HelpText = "èˆ‡å®¢æˆ¶ç´„å®šçš„äº¤è²¨æ–¹å¼å’Œæ¢ä»¶",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },

                FormFieldConfigurationHelper.CreateRemarksField<SalesOrder>(
                    containerCssClass: "col-6",
                    readOnly: hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                ),
            };

            formSections = FormSectionHelper<SalesOrder>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    so => so.Code,
                    so => so.CustomerId)
                .AddCustomFields(FormSectionNames.BasicInfo, "FilterProductId")  // ç”¨å­—ä¸²æŒ‡å®šè™›æ“¬æ¬„ä½
                .AddToSection(FormSectionNames.BasicInfo,
                    so => so.QuotationId,
                    so => so.CompanyId,
                    so => so.EmployeeId,
                    so => so.OrderDate,
                    so => so.ExpectedDeliveryDate)
                .AddToSection(FormSectionNames.AmountInfo,
                    so => so.TaxCalculationMethod,
                    so => so.TotalAmount,      // é‡‘é¡ï¼ˆæŠ˜æ‰£å‰ï¼‰
                    so => so.DiscountAmount,   // æŠ˜æ‰£
                    so => so.SalesTaxAmount,   // ç¨…é¡
                    so => so.TotalAmountWithTax) // ç¸½é¡
                .AddToSection(FormSectionNames.AdditionalInfo,
                    so => so.PaymentTerms,
                    so => so.DeliveryTerms,
                    so => so.Remarks)
                .Build();
        }
        catch (Exception ex)
        {
            _ = ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(InitializeFormFieldsAsync), GetType(), 
                additionalData: "è¨‚å–®ç·¨è¼¯Modalè¡¨å–®æ¬„ä½åˆå§‹åŒ–å¤±æ•—");
            
            // è¨­å®šå®‰å…¨çš„é è¨­å€¼
            formFields = new List<FormFieldDefinition>();
            formSections = new Dictionary<string, string>();
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }

    /// <summary>
    /// ç”Ÿæˆè¨‚å–®è™Ÿ
    /// </summary>
    
    // ===== AutoComplete é…ç½®æ–¹æ³• =====
    
    /// <summary>
    /// é…ç½® Modal ç®¡ç†å™¨
    /// </summary>
    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(SalesOrder.CustomerId), customerModalManager },
            { nameof(SalesOrder.CompanyId), companyModalManager },
            { nameof(SalesOrder.EmployeeId), employeeModalManager }
        };
    }
    
    /// <summary>
    /// é…ç½®è‡ªè¨‚æ¨¡çµ„
    /// </summary>
    private List<GenericEditModalComponent<SalesOrder, ISalesOrderService>.CustomModule> GetCustomModules()
    {
        // ç¢ºä¿åªåœ¨éœ€è¦æ™‚æ‰è¿”å›æ¨¡çµ„ï¼Œä¸¦ä¸”æª¢æŸ¥æ‰€æœ‰å¿…è¦çš„æ¢ä»¶
        if (editModalComponent == null)
        {
            return new List<GenericEditModalComponent<SalesOrder, ISalesOrderService>.CustomModule>();
        }

        return new List<GenericEditModalComponent<SalesOrder, ISalesOrderService>.CustomModule>
        {
            new GenericEditModalComponent<SalesOrder, ISalesOrderService>.CustomModule
            {
                Order = 1,
                IsVisible = true,
                Content = CreateProductManagerContent()
            }
        };
    }

    /// <summary>
    /// å‰µå»ºå•†å“ç®¡ç†å™¨å…§å®¹çš„ RenderFragment
    /// </summary>
    private RenderFragment CreateProductManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null)
            {
                @if (!isDetailDataReady)
                {
                    <div class="d-flex justify-content-center align-items-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span class="text-muted">è¼‰å…¥æ˜ç´°è³‡æ–™ä¸­...</span>
                    </div>
                }
                // æª¢æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„å•†å“å’Œå–®ä½è³‡æ–™
                else if (products != null && products.Any() && units != null && units.Any())
                {
                    // æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡å®¢æˆ¶
                    @if (editModalComponent.Entity.CustomerId > 0)
                    {
                        <SalesOrderTable @ref="salesOrderDetailManager"
                                                          @key="@editModalComponent.Entity.Id"
                                                          TMainEntity="SalesOrder" 
                                                          TDetailEntity="SalesOrderDetail"
                                                          MainEntity="@editModalComponent.Entity"
                                                          ExistingDetails="@salesOrderDetails"
                                                          Products="@products"
                                                          Warehouses="@warehouses"
                                                          SelectedCustomerId="@editModalComponent.Entity.CustomerId"
                                                          SelectedCustomerName="@GetSelectedCustomerName()"
                                                          SelectedQuotationId="@editModalComponent.Entity.QuotationId"
                                                          SelectedQuotationCode="@GetSelectedQuotationCode()"
                                                          FilterProductId="@filterProductId"
                                                          FilterProductName="@GetFilterProductName()"
                                                          TaxCalculationMethod="@editModalComponent.Entity.TaxCalculationMethod"
                                                          IsReadOnly="false"
                                                          MainEntityIdPropertyName="SalesOrderId"
                                                          QuantityPropertyName="OrderQuantity"
                                                          UnitPricePropertyName="UnitPrice"
                                                          DiscountPercentagePropertyName="DiscountPercentage"
                                                          UnitIdPropertyName="UnitId"
                                                          WarehouseIdPropertyName="WarehouseId"
                                                          RemarksPropertyName="Remarks"
                                                          SourceQuotationId="@PrefilledQuotationId"
                                                          OnDetailsChanged="@HandleDetailsChanged"
                                                          OnHasUndeletableDetailsChanged="@HandleHasUndeletableDetailsChanged"
                                                          OnOpenRelatedDocument="@HandleOpenRelatedDocument"
                                                          ItemDisplayName="éŠ·å”®å•†å“"
                                                          EmptyMessage="å°šæœªæ–°å¢éŠ·å”®å•†å“" />
                    }
                    else
                    {
                        <div class="alert alert-info text-center" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            è«‹å…ˆé¸æ“‡å®¢æˆ¶å¾Œå†é€²è¡ŒéŠ·å”®æ˜ç´°ç®¡ç†
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-warning text-center" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ç„¡å¯ç”¨çš„å•†å“æˆ–å–®ä½è³‡æ–™ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡
                    </div>
                }
            }
            else
            {
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                è¼‰å…¥æ˜ç´°ç®¡ç†å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚
            </div>
        }
    };
    
    // ===== ActionButton ç”¢ç”Ÿæ–¹æ³• =====
    
    /// <summary>
    /// ç”¢ç”Ÿå®¢æˆ¶æ“ä½œæŒ‰éˆ• - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetCustomerActionButtonsAsync()
    {
        // ğŸ”‘ é—œéµï¼šç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚ï¼Œä¸é¡¯ç¤º ActionButtonsï¼ˆèˆ‡ PurchaseOrder ä¸€è‡´ï¼‰
        if (hasUndeletableDetails)
        {
            return new List<FieldActionButton>();
        }
        
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            customerModalManager, 
            nameof(SalesOrder.CustomerId)
        );
    }
    
    /// <summary>
    /// ç”¢ç”Ÿå…¬å¸æ“ä½œæŒ‰éˆ• - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetCompanyActionButtonsAsync()
    {
        // ğŸ”‘ é—œéµï¼šç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚ï¼Œä¸é¡¯ç¤º ActionButtonsï¼ˆèˆ‡ PurchaseOrder ä¸€è‡´ï¼‰
        if (hasUndeletableDetails)
        {
            return new List<FieldActionButton>();
        }
        
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            companyModalManager, 
            nameof(SalesOrder.CompanyId)
        );
    }
    
    /// <summary>
    /// ç”¢ç”Ÿæ¥­å‹™å“¡æ“ä½œæŒ‰éˆ• - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetEmployeeActionButtonsAsync()
    {
        // ğŸ”‘ é—œéµï¼šç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚ï¼Œä¸é¡¯ç¤º ActionButtonsï¼ˆèˆ‡ PurchaseOrder ä¸€è‡´ï¼‰
        if (hasUndeletableDetails)
        {
            return new List<FieldActionButton>();
        }
        
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            employeeModalManager, 
            nameof(SalesOrder.EmployeeId)
        );
    }
    
    // ===== Modal äº‹ä»¶åŒ…è£å™¨æ–¹æ³• =====
    
    /// <summary>
    /// åŒ…è£å®¢æˆ¶å„²å­˜äº‹ä»¶
    /// </summary>
    private async Task OnCustomerSavedWrapper(Customer savedCustomer)
    {
        await customerModalManager.HandleEntitySavedAsync(savedCustomer, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// åŒ…è£å…¬å¸å„²å­˜äº‹ä»¶
    /// </summary>
    private async Task OnCompanySavedWrapper(Company savedCompany)
    {
        await companyModalManager.HandleEntitySavedAsync(savedCompany, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// åŒ…è£æ¥­å‹™å“¡å„²å­˜äº‹ä»¶
    /// </summary>
    private async Task OnEmployeeSavedWrapper(Employee savedEmployee)
    {
        await employeeModalManager.HandleEntitySavedAsync(savedEmployee, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// è™•ç†é–‹å•Ÿç›¸é—œå–®æ“šçš„äº‹ä»¶
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            if (args.type == RelatedDocumentType.ReturnDocument)
            {
                // é–‹å•ŸéŠ·è²¨é€€å›å–®
                selectedSalesReturnId = args.id;
                showSalesReturnModal = true;
                StateHasChanged();
            }
            else if (args.type == RelatedDocumentType.SetoffDocument)
            {
                // é–‹å•Ÿæ²–æ¬¾å–®
                selectedSetoffDocumentId = args.id;
                showSetoffDocumentModal = true;
                StateHasChanged();
            }
            else if (args.type == RelatedDocumentType.DeliveryDocument)
            {
                // é–‹å•ŸéŠ·è²¨å‡ºè²¨å–®
                selectedSalesDeliveryId = args.id;
                showSalesDeliveryModal = true;
                StateHasChanged();
            }
            else if (args.type == RelatedDocumentType.ProductionSchedule)
            {
                // é–‹å•Ÿç”Ÿç”¢æ’ç¨‹
                selectedProductionScheduleId = args.id;
                showProductionScheduleModal = true;
                StateHasChanged();
            }
            else
            {
                await NotificationService.ShowWarningAsync("ä¸æ”¯æ´çš„å–®æ“šé¡å‹", "æç¤º");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é–‹å•Ÿå–®æ“šå¤±æ•—ï¼š{ex.Message}");
        }
    }
    
    /// <summary>
    /// è™•ç†æ²–æ¬¾å–®å„²å­˜å¾Œçš„äº‹ä»¶
    /// </summary>
    private async Task HandleSetoffDocumentSaved(SetoffDocument savedDocument)
    {
        try
        {
            showSetoffDocumentModal = false;
            await NotificationService.ShowSuccessAsync("æ²–æ¬¾å–®å·²æ›´æ–°");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†æ²–æ¬¾å–®å„²å­˜äº‹ä»¶å¤±æ•—ï¼š{ex.Message}");
        }
    }
    
    /// <summary>
    /// è™•ç†æ¬„ä½å€¼è®Šæ›´äº‹ä»¶ - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // ä½¿ç”¨çµ±ä¸€ Helper è™•ç†å®¢æˆ¶æ¬„ä½è®Šæ›´
            if (fieldChange.PropertyName == nameof(SalesOrder.CustomerId))
            {
                //  é—œéµï¼šåªæœ‰åœ¨æ²’æœ‰ä¸å¯åˆªé™¤æ˜ç´°æ™‚æ‰æ›´æ–° ActionButtons
                if (!hasUndeletableDetails)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        customerModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                }
                
                // å®¢æˆ¶è®Šæ›´æ™‚ï¼Œè§¸ç™¼å•†å“ç®¡ç†å™¨é‡æ–°æ¸²æŸ“
                StateHasChanged();
            }
            // è™•ç†å…¬å¸æ¬„ä½è®Šæ›´
            else if (fieldChange.PropertyName == nameof(SalesOrder.CompanyId))
            {
                //  é—œéµï¼šåªæœ‰åœ¨æ²’æœ‰ä¸å¯åˆªé™¤æ˜ç´°æ™‚æ‰æ›´æ–° ActionButtons
                if (!hasUndeletableDetails)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        companyModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                }
            }
            // è™•ç†æ¥­å‹™å“¡æ¬„ä½è®Šæ›´
            else if (fieldChange.PropertyName == nameof(SalesOrder.EmployeeId))
            {
                //  é—œéµï¼šåªæœ‰åœ¨æ²’æœ‰ä¸å¯åˆªé™¤æ˜ç´°æ™‚æ‰æ›´æ–° ActionButtons
                if (!hasUndeletableDetails)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        employeeModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                }
            }
            // è™•ç†ç¨…åˆ¥è®Šæ›´
            else if (fieldChange.PropertyName == nameof(SalesOrder.TaxCalculationMethod))
            {
                // ç¨…åˆ¥è®Šæ›´æ™‚ï¼Œé‡æ–°è¨ˆç®—é‡‘é¡å’Œç¨…é¡
                await HandleDetailsChanged(salesOrderDetails);
                StateHasChanged();
            }
            // è™•ç†å•†å“ç¯©é¸è®Šæ›´
            else if (fieldChange.PropertyName == "FilterProductId")
            {
                // æ›´æ–°å•†å“ç¯©é¸ç‹€æ…‹ - è™•ç† int æˆ– string é¡å‹
                int? parsedProductId = null;
                
                if (fieldChange.Value is int intValue && intValue > 0)
                {
                    parsedProductId = intValue;
                }
                else if (fieldChange.Value is string strValue && int.TryParse(strValue, out int parsedInt) && parsedInt > 0)
                {
                    parsedProductId = parsedInt;
                }
                
                filterProductId = parsedProductId;
                StateHasChanged();
            }
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("æ¬„ä½è®Šæ›´è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    // ===== éŠ·è²¨æ˜ç´°ç®¡ç†æ–¹æ³• =====
    
    /// <summary>
    /// è™•ç†å¯¦é«”è¼‰å…¥å®Œæˆäº‹ä»¶ï¼ˆç”± GenericEditModalComponent çš„å°èˆªè§¸ç™¼ï¼‰
    /// ç•¶ä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼Œé‡æ–°è¼‰å…¥å°æ‡‰çš„æ˜ç´°è³‡æ–™
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            // 1. é‡æ–°è¼‰å…¥æ˜ç´°è³‡æ–™
            await LoadSalesOrderDetails(loadedEntityId);
            
            //  é—œéµä¿®æ­£ï¼šç«‹å³è§¸ç™¼ UI æ›´æ–°ï¼Œç¢ºä¿ Table å…ƒä»¶æ”¶åˆ°æ–°çš„ ExistingDetails åƒæ•¸
            // é€™æ¨£ RefreshDetailsAsync() æ‰èƒ½è®€å–åˆ°æ­£ç¢ºçš„æ˜ç´°è³‡æ–™
            StateHasChanged();
            
            // 2. è¼‰å…¥æ˜ç´°ç›¸é—œè³‡æ–™ï¼ˆé€€è²¨æ•¸é‡ã€æ”¶æ¬¾è¨˜éŒ„ç­‰ï¼‰
            await LoadDetailRelatedDataAsync();
            
            // 3. è§¸ç™¼ Table å…ƒä»¶åˆ·æ–°ï¼ˆæ­¤æ™‚ ExistingDetails å·²ç¶“æ˜¯æ–°çš„è³‡æ–™ï¼‰
            if (salesOrderDetailManager != null)
            {
                await salesOrderDetailManager.RefreshDetailsAsync();
            }
            
            // 4. æœ€å¾Œå†æ¬¡æ›´æ–° UIï¼ˆç¢ºä¿æ‰€æœ‰è®Šæ›´éƒ½åæ˜ åœ¨ç•«é¢ä¸Šï¼‰
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†å¯¦é«”è¼‰å…¥äº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }
    
    /// <summary>
    /// è¼‰å…¥è¨‚å–®æ˜ç´°
    /// </summary>
    private async Task LoadSalesOrderDetails(int salesOrderId)
    {
        try
        {
            // å¾ç¾æœ‰çš„è¨‚å–®å–å¾—æ˜ç´°
            var salesOrder = await SalesOrderService.GetWithDetailsAsync(salesOrderId);
            if (salesOrder?.SalesOrderDetails != null)
            {
                salesOrderDetails = salesOrder.SalesOrderDetails.ToList();
            }
            else
            {
                salesOrderDetails = new List<SalesOrderDetail>();
            }
            
            //  é—œéµä¿®æ­£ï¼šè¼‰å…¥æ˜ç´°å¾Œé‡æ–°æª¢æŸ¥é–å®šç‹€æ…‹
            // åƒè€ƒ PurchaseOrderEditModalComponent çš„å¯¦ä½œ
            await LoadDetailRelatedDataAsync();
            
            // æª¢æŸ¥åº«å­˜ä¸è¶³ç‹€æ…‹
            await CheckInventoryShortageAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSalesOrderDetails), GetType(), 
                additionalData: $"è¼‰å…¥è¨‚å–®æ˜ç´°å¤±æ•— - OrderId: {salesOrderId}");
            salesOrderDetails = new List<SalesOrderDetail>();
        }
    }

    /// <summary>
    /// è™•ç†éŠ·è²¨æ˜ç´°è®Šæ›´
    /// </summary>
    private async Task HandleDetailsChanged(List<SalesOrderDetail> details)
    {
        try
        {
            salesOrderDetails = details ?? new List<SalesOrderDetail>();
            
            // æ›´æ–°ä¸»æª”çš„é‡‘é¡ã€æŠ˜æ‰£ã€ç¨…é¡å’Œç¸½é¡
            if (editModalComponent?.Entity != null)
            {
                // æ ¹æ“šç¨…åˆ¥è¨ˆç®—é‡‘é¡å’Œç¨…é¡
                switch (editModalComponent.Entity.TaxCalculationMethod)
                {
                    case TaxCalculationMethod.TaxExclusive:
                        // å¤–åŠ ç¨…ï¼šç¸½é¡ = é‡‘é¡ - æŠ˜æ‰£ + ç¨…é¡
                        {
                            // 1. é‡‘é¡ï¼ˆæŠ˜æ‰£å‰ï¼‰= Î£(æ•¸é‡ Ã— å–®åƒ¹)
                            editModalComponent.Entity.TotalAmount = Math.Round(
                                salesOrderDetails.Sum(d => d.OrderQuantity * d.UnitPrice), 
                                0, MidpointRounding.AwayFromZero);
                            
                            // 2. æŠ˜æ‰£é‡‘é¡ = Î£(æ•¸é‡ Ã— å–®åƒ¹ Ã— æŠ˜æ‰£%)
                            editModalComponent.Entity.DiscountAmount = Math.Round(
                                salesOrderDetails.Sum(d => d.OrderQuantity * d.UnitPrice * (d.DiscountPercentage / 100)), 
                                0, MidpointRounding.AwayFromZero);
                            
                            // 3. ç¨…é¡ = Î£(æŠ˜æ‰£å¾Œé‡‘é¡ Ã— ç¨…ç‡%)
                            editModalComponent.Entity.SalesTaxAmount = Math.Round(
                                salesOrderDetails.Sum(d => {
                                    var amountAfterDiscount = d.OrderQuantity * d.UnitPrice * (1 - d.DiscountPercentage / 100);
                                    var taxRate = d.TaxRate ?? 0;
                                    return amountAfterDiscount * (taxRate / 100);
                                }), 0, MidpointRounding.AwayFromZero);
                            
                            // 4. ç¸½é¡ç”± TotalAmountWithTax è¨ˆç®—å±¬æ€§è‡ªå‹•è¨ˆç®— (TotalAmount + SalesTaxAmount)
                            // æ³¨æ„ï¼šé€™è£¡çš„ TotalAmount æ˜¯æŠ˜æ‰£å‰é‡‘é¡ï¼Œéœ€è¦æ¸›å»æŠ˜æ‰£å¾Œå†åŠ ç¨…
                            editModalComponent.Entity.TotalAmount = 
                                editModalComponent.Entity.TotalAmount - 
                                editModalComponent.Entity.DiscountAmount;
                        }
                        break;

                    case TaxCalculationMethod.TaxInclusive:
                        // å…§å«ç¨…ï¼šç¸½é¡å·²å«ç¨…ï¼Œåæ¨é‡‘é¡ã€æŠ˜æ‰£ã€ç¨…é¡
                        {
                            // 1. ç¸½é¡ï¼ˆå«ç¨…ï¼‰= Î£(æ•¸é‡ Ã— å–®åƒ¹ Ã— (1 - æŠ˜æ‰£%))
                            var totalWithTax = Math.Round(
                                salesOrderDetails.Sum(d => d.OrderQuantity * d.UnitPrice * (1 - d.DiscountPercentage / 100)), 
                                0, MidpointRounding.AwayFromZero);
                            
                            // 2. ç¨…é¡ = Î£(å°è¨ˆ / (1 + ç¨…ç‡%) Ã— ç¨…ç‡%)
                            editModalComponent.Entity.SalesTaxAmount = Math.Round(
                                salesOrderDetails.Sum(d => {
                                    var amountWithTax = d.OrderQuantity * d.UnitPrice * (1 - d.DiscountPercentage / 100);
                                    var taxRate = d.TaxRate ?? 0;
                                    return amountWithTax / (1 + taxRate / 100) * (taxRate / 100);
                                }), 0, MidpointRounding.AwayFromZero);
                            
                            // 3. é‡‘é¡ï¼ˆæœªç¨…ï¼‰= ç¸½é¡ - ç¨…é¡
                            editModalComponent.Entity.TotalAmount = Math.Round(
                                totalWithTax - editModalComponent.Entity.SalesTaxAmount, 
                                0, MidpointRounding.AwayFromZero);
                            
                            // 4. æŠ˜æ‰£é‡‘é¡ = Î£(æ•¸é‡ Ã— å–®åƒ¹ Ã— æŠ˜æ‰£%)
                            editModalComponent.Entity.DiscountAmount = Math.Round(
                                salesOrderDetails.Sum(d => d.OrderQuantity * d.UnitPrice * (d.DiscountPercentage / 100)), 
                                0, MidpointRounding.AwayFromZero);
                            
                            // æ³¨æ„ï¼šTotalAmountWithTax æ˜¯è¨ˆç®—å±¬æ€§ï¼Œæœƒè‡ªå‹• = TotalAmount + SalesTaxAmount
                        }
                        break;

                    case TaxCalculationMethod.NoTax:
                        // å…ç¨…ï¼šç¸½é¡ = é‡‘é¡ - æŠ˜æ‰£ï¼ˆç¨…é¡ç‚º 0ï¼‰
                        {
                            // 1. é‡‘é¡ï¼ˆæŠ˜æ‰£å‰ï¼‰= Î£(æ•¸é‡ Ã— å–®åƒ¹)
                            editModalComponent.Entity.TotalAmount = Math.Round(
                                salesOrderDetails.Sum(d => d.OrderQuantity * d.UnitPrice), 
                                0, MidpointRounding.AwayFromZero);
                            
                            // 2. æŠ˜æ‰£é‡‘é¡ = Î£(æ•¸é‡ Ã— å–®åƒ¹ Ã— æŠ˜æ‰£%)
                            editModalComponent.Entity.DiscountAmount = Math.Round(
                                salesOrderDetails.Sum(d => d.OrderQuantity * d.UnitPrice * (d.DiscountPercentage / 100)), 
                                0, MidpointRounding.AwayFromZero);
                            
                            // 3. ç¨…é¡ = 0ï¼ˆå…ç¨…ï¼‰
                            editModalComponent.Entity.SalesTaxAmount = 0;
                            
                            // 4. TotalAmount éœ€è¦æ¸›å»æŠ˜æ‰£
                            editModalComponent.Entity.TotalAmount = 
                                editModalComponent.Entity.TotalAmount - 
                                editModalComponent.Entity.DiscountAmount;
                            
                            // æ³¨æ„ï¼šTotalAmountWithTax æœƒè‡ªå‹• = TotalAmount + SalesTaxAmount (= TotalAmount + 0)
                        }
                        break;
                }
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDetailsChanged), GetType(), 
                additionalData: "è™•ç†éŠ·è²¨æ˜ç´°è®Šæ›´å¤±æ•—");
        }
    }

    /// <summary>
    /// è™•ç†æœ‰ä¸å¯åˆªé™¤æ˜ç´°çš„ç‹€æ…‹è®Šæ›´
    /// ç•¶æ˜ç´°å‹•æ…‹è®ŠåŒ–æ™‚ï¼ˆæ–°å¢å‡ºè²¨ã€æ’ç¨‹ã€æ”¶æ¬¾è¨˜éŒ„ç­‰ï¼‰ï¼Œé€™å€‹æ–¹æ³•æœƒè¢«èª¿ç”¨
    /// </summary>
    private async Task HandleHasUndeletableDetailsChanged(bool hasUndeletable)
    {
        try
        {
            if (hasUndeletableDetails != hasUndeletable)
            {
                hasUndeletableDetails = hasUndeletable;
                
                // æ›´æ–°æ¬„ä½çš„å”¯è®€ç‹€æ…‹
                UpdateFieldsReadOnlyState();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†æ˜ç´°é–å®šç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// æ›´æ–°æ¬„ä½çš„å”¯è®€ç‹€æ…‹ - æ ¹æ“šæ˜ç´°è½‰å–®ç‹€æ…‹
    /// ä½¿ç”¨ FormFieldLockHelper çµ±ä¸€è™•ç†æ¬„ä½é–å®šé‚è¼¯
    /// </summary>
    private async void UpdateFieldsReadOnlyState()
    {
        // ğŸ”‘ é—œéµï¼šç›´æ¥é‡æ–°åˆå§‹åŒ–è¡¨å–®æ¬„ä½ï¼ˆèˆ‡ PurchaseOrder ä¸€è‡´ï¼‰
        // InitializeFormFieldsAsync æœƒå‘¼å« GetCustomerActionButtonsAsync ç­‰æ–¹æ³•
        // é€™äº›æ–¹æ³•å…§éƒ¨å·²ç¶“æª¢æŸ¥ hasUndeletableDetailsï¼Œæœƒè‡ªå‹•æ±ºå®šæ˜¯å¦åŠ å…¥ ActionButtons
        await InvokeAsync(async () =>
        {
            await InitializeFormFieldsAsync();
            StateHasChanged();
        });
    }

    /// <summary>
    /// å–å¾—ç‹€æ…‹è¨Šæ¯ï¼ˆé ‚éƒ¨å¾½ç« ï¼‰
    /// ç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚ï¼Œé¡¯ç¤ºé–å®šæç¤º
    /// </summary>
    private async Task<(string Message, GenericEditModalComponent<SalesOrder, ISalesOrderService>.BadgeVariant Variant, string IconClass)?> 
        GetStatusMessage()
    {
        try
        {
            // å¦‚æœè³‡æ–™é‚„æ²’æº–å‚™å¥½ï¼Œä¸é¡¯ç¤ºè¨Šæ¯
            if (!isDetailDataReady || editModalComponent?.Entity == null)
                return null;
            
            // åªæœ‰åœ¨æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚æ‰é¡¯ç¤ºé–å®šè¨Šæ¯
            if (hasUndeletableDetails)
            {
                return (
                    "éƒ¨åˆ†æ˜ç´°æœ‰å‡ºè²¨/æ’ç¨‹/æ”¶æ¬¾è¨˜éŒ„ï¼Œä¸»æª”æ¬„ä½å·²é–å®š",
                    GenericEditModalComponent<SalesOrder, ISalesOrderService>.BadgeVariant.Warning,
                    "bi bi-lock"
                );
            }
            
            // æ­£å¸¸ç‹€æ…‹ä¸é¡¯ç¤ºè¨Šæ¯
            return null;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å–å¾—ç‹€æ…‹è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return null;
        }
    }

    /// <summary>
    /// å–å¾—è­¦å‘Šè¨Šæ¯ï¼ˆé¡¯ç¤ºåœ¨è¡¨å–®æ¬„ä½ä¸Šæ–¹ï¼‰- ä½œç‚ºå±¬æ€§ä»¥ç¢ºä¿æ­£ç¢ºçš„æ¸²æŸ“æ™‚æ©Ÿ
    /// ç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚ï¼Œé¡¯ç¤ºé–å®šè­¦å‘Šè¨Šæ¯
    /// </summary>
    private RenderFragment? WarningMessage => __builder =>
    {
        // åªåœ¨è³‡æ–™æº–å‚™å°±ç·’å¾Œæ‰é¡¯ç¤ºè¨Šæ¯
        if (!isDetailDataReady)
            return;
        
        // æ˜ç´°å·²è½‰å–®çš„è­¦å‘Šè¨Šæ¯
        <GenericLockedFieldMessage IsVisible="@hasUndeletableDetails"
                                  Message="å› éƒ¨åˆ†æ˜ç´°æœ‰å…¶ä»–å‹•ä½œï¼Œç‚ºä¿è­·è³‡æ–™å®Œæ•´æ€§ä¸»æª”æ¬„ä½å·²è¨­å”¯è®€ã€‚" />
    };

    /// <summary>
    /// å–å¾—é¸æ“‡çš„å®¢æˆ¶åç¨±ï¼ˆç”¨æ–¼è¼‰å…¥ç¢ºèªè¨Šæ¯ï¼‰
    /// </summary>
    private string GetSelectedCustomerName()
    {
        if (editModalComponent?.Entity?.CustomerId > 0)
        {
            var customer = customers.FirstOrDefault(c => c.Id == editModalComponent.Entity.CustomerId);
            return customer?.CompanyName ?? string.Empty;
        }
        return string.Empty;
    }

    /// <summary>
    /// å–å¾—é¸æ“‡çš„å ±åƒ¹å–®ç·¨è™Ÿï¼ˆç”¨æ–¼è¼‰å…¥ç¢ºèªè¨Šæ¯ï¼‰
    /// </summary>
    private string GetSelectedQuotationCode()
    {
        if (editModalComponent?.Entity?.QuotationId > 0)
        {
            var quotation = quotations.FirstOrDefault(q => q.Id == editModalComponent.Entity.QuotationId);
            return quotation?.Code ?? string.Empty;
        }
        return string.Empty;
    }

    /// <summary>
    /// å–å¾—ç¯©é¸çš„å•†å“åç¨±ï¼ˆç”¨æ–¼è¼‰å…¥ç¢ºèªè¨Šæ¯ï¼‰
    /// </summary>
    private string GetFilterProductName()
    {
        if (filterProductId.HasValue && filterProductId.Value > 0)
        {
            var product = products.FirstOrDefault(p => p.Id == filterProductId.Value);
            return product?.Name ?? string.Empty;
        }
        return string.Empty;
    }

    /// <summary>
    /// å–å¾—è‡ªè¨‚æ“ä½œæŒ‰éˆ•ï¼ˆé¡¯ç¤ºåœ¨ Modal é ‚éƒ¨å·¦å´ï¼‰
    /// </summary>
    private RenderFragment? GetCustomActionButtons() => __builder =>
    {
        @* è½‰éŠ·è²¨å‡ºè²¨å–®æŒ‰éˆ• - æ–°å¢æ¨¡å¼éœ€å…ˆå„²å­˜ï¼Œç·¨è¼¯æ¨¡å¼ç›´æ¥å¯ç”¨ *@
        @if (editModalComponent?.Entity != null && 
            SalesOrderId.HasValue)
        {
            
            <GenericButtonComponent Text="è½‰éŠ·è²¨" 
                                  Variant="ButtonVariant.Green" 
                                  OnClick="HandleCreateDeliveryFromOrder" />
            
            @* æ‰¹æ¬¡æ’ç¨‹ç®¡ç†æŒ‰éˆ• *@
            <GenericButtonComponent Text="æ’ç¨‹ç®¡ç†" 
                                  Variant="ButtonVariant.Yellow"
                                  OnClick="HandleBatchTransferToSchedule" />

            @* åº«å­˜æª¢è¦–æŒ‰éˆ• - æœ‰ä¸è¶³æ™‚é¡¯ç¤ºè­¦å‘Šæ¨£å¼ *@
            @if (isInventoryCheckLoading)
            {
                <GenericButtonComponent Text="æª¢æŸ¥ä¸­..." 
                                      Variant="ButtonVariant.Gray" 
                                      Icon="bi bi-hourglass-split"
                                      IsDisabled="true" />
            }
            else if (hasInventoryShortage)
            {
                <GenericButtonComponent Text="âš ï¸ æŸ¥åº«å­˜" 
                                      Variant="ButtonVariant.Yellow" 
                                      Icon="bi bi-exclamation-triangle-fill"
                                      OnClick="HandleShowInventoryCheck" />
            }
            else
            {
                <GenericButtonComponent Text="æŸ¥åº«å­˜" 
                                      Variant="ButtonVariant.Blue" 
                                      Icon="bi bi-box-seam"
                                      OnClick="HandleShowInventoryCheck" />
            }
        }
    };

    /// <summary>
    /// å¾è¨‚å–®è½‰éŠ·å”®é€€è²¨å–®
    /// </summary>
    private async Task HandleCreateReturnFromOrder()
    {
        try
        {
            // 1. é©—è­‰è¨‚å–®è³‡æ–™
            if (!SalesOrderId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("ç„¡æ³•è½‰éŠ·å”®é€€è²¨å–®ï¼šè¨‚å–®è³‡æ–™ä¸å­˜åœ¨");
                return;
            }
            
            // 2. é©—è­‰å®¢æˆ¶è³‡æ–™
            if (editModalComponent.Entity.CustomerId <= 0)
            {
                await NotificationService.ShowWarningAsync("è¨‚å–®ç¼ºå°‘å®¢æˆ¶è³‡è¨Šï¼Œç„¡æ³•è½‰éŠ·å”®é€€è²¨å–®");
                return;
            }
            
            // 3. æª¢æŸ¥æ˜¯å¦æœ‰æ˜ç´°è³‡æ–™
            if (!salesOrderDetails.Any())
            {
                await NotificationService.ShowWarningAsync("è¨‚å–®æ²’æœ‰æ˜ç´°è³‡æ–™ï¼Œç„¡æ³•è½‰éŠ·å”®é€€è²¨å–®");
                return;
            }
            
            // 4. æª¢æŸ¥æ˜¯å¦æœ‰å¯é€€è²¨çš„æ˜ç´°
            // æ³¨æ„ï¼šSalesOrderDetail ç›®å‰æ²’æœ‰ ReturnedQuantity æ¬„ä½
            // æš«æ™‚å…è¨±æ‰€æœ‰æœ‰æ˜ç´°çš„è¨‚å–®éƒ½å¯ä»¥è½‰é€€è²¨å–®
            // æœªä¾†å¦‚æœéœ€è¦æ›´ç²¾ç¢ºçš„é©—è­‰ï¼Œéœ€è¦åœ¨ SalesOrderDetail åŠ å…¥ ReturnedQuantity æ¬„ä½
            // var hasReturnableDetails = salesOrderDetails.Any(detail => 
            //     detail.ReturnedQuantity < detail.OrderQuantity
            // );
            // 
            // if (!hasReturnableDetails)
            // {
            //     await NotificationService.ShowWarningAsync("è¨‚å–®æ‰€æœ‰æ˜ç´°çš†å·²å®Œæˆé€€è²¨ï¼Œç„¡éœ€å†è½‰éŠ·å”®é€€è²¨å–®");
            //     return;
            // }
            
            // 5. å‘¼å«éŠ·å”®é€€è²¨å–®çµ„ä»¶çš„å…¬é–‹æ–¹æ³•
            if (salesReturnEditModal != null)
            {
                // æ³¨æ„ï¼šé€€è²¨æ‡‰è©²å¾å‡ºè²¨å–®ç”¢ç”Ÿï¼Œæ­¤è™•æš«æ™‚ä¿ç•™ä½†éœ€è¦é‡æ§‹
                await salesReturnEditModal.ShowAddModalWithPrefilledDelivery(
                    editModalComponent.Entity.CustomerId,
                    SalesOrderId.Value  // TODO: æ‡‰è©²æ”¹ç‚º SalesDeliveryId
                );
            }
            else
            {
                await NotificationService.ShowWarningAsync("éŠ·å”®é€€è²¨å–®çµ„ä»¶æœªåˆå§‹åŒ–ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCreateReturnFromOrder), GetType(), 
                additionalData: $"è½‰éŠ·å”®é€€è²¨å–®å¤±æ•— - OrderId: {SalesOrderId}");
            await NotificationService.ShowErrorAsync("è½‰éŠ·å”®é€€è²¨å–®æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    /// <summary>
    /// å¾è¨‚å–®è½‰éŠ·è²¨å‡ºè²¨å–® - ç°¡åŒ–ç‰ˆæœ¬ï¼Œæ‰€æœ‰æ¥­å‹™é©—è­‰äº¤çµ¦éŠ·è²¨å‡ºè²¨å–® Modal è™•ç†
    /// </summary>
    private async Task HandleCreateDeliveryFromOrder()
    {
        try
        {
            // æª¢æŸ¥ï¼šç¢ºä¿è¨‚å–®å·²å„²å­˜
            if (!SalesOrderId.HasValue)
            {
                await NotificationService.ShowWarningAsync("è«‹å…ˆå„²å­˜è¨‚å–®å¾Œï¼Œæ‰èƒ½è½‰éŠ·è²¨å‡ºè²¨å–®");
                return;
            }
            
            // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ Entity å·²è¼‰å…¥
            if (editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("è¨‚å–®è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å®¢æˆ¶è³‡æ–™
            if (editModalComponent.Entity.CustomerId <= 0)
            {
                await NotificationService.ShowWarningAsync("è¨‚å–®ç¼ºå°‘å®¢æˆ¶è³‡è¨Šï¼Œç„¡æ³•è½‰éŠ·è²¨å‡ºè²¨å–®");
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ˜ç´°è³‡æ–™
            if (!salesOrderDetails.Any())
            {
                await NotificationService.ShowWarningAsync("è¨‚å–®æ²’æœ‰æ˜ç´°è³‡æ–™ï¼Œç„¡æ³•è½‰éŠ·è²¨å‡ºè²¨å–®");
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰æ˜ç´°éƒ½å·²å®Œæˆå‡ºè²¨ï¼ˆå·²å‡ºè²¨æ•¸é‡ >= è¨‚è³¼æ•¸é‡ï¼‰
            var hasIncompleteDetails = salesOrderDetails.Any(detail => 
                detail.DeliveredQuantity < detail.OrderQuantity
            );
            
            if (!hasIncompleteDetails)
            {
                await NotificationService.ShowWarningAsync("è¨‚å–®æ‰€æœ‰æ˜ç´°çš†å·²å®Œæˆå‡ºè²¨ï¼Œç„¡éœ€å†è½‰å–®");
                return;
            }
            
            // ç›´æ¥é–‹å•ŸéŠ·è²¨å‡ºè²¨å–® Modalï¼Œä½¿ç”¨ Entity.Id ä½œç‚ºè¨‚å–® IDï¼ˆæœ€å¯é çš„ä¾†æºï¼‰
            await salesDeliveryEditModal!.ShowAddModalWithPrefilledOrder(
                editModalComponent.Entity.CustomerId,
                editModalComponent.Entity.Id  // ä½¿ç”¨ Entity.Id è€Œé SalesOrderId åƒæ•¸
            );
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCreateDeliveryFromOrder), GetType(), 
                additionalData: $"è½‰éŠ·è²¨å‡ºè²¨å–®å¤±æ•— - OrderId: {editModalComponent?.Entity?.Id}");
            await NotificationService.ShowErrorAsync($"è½‰éŠ·è²¨å‡ºè²¨å–®æ™‚ç™¼ç”ŸéŒ¯èª¤: {ex.Message}");
        }
    }

    /// <summary>
    /// è™•ç†éŠ·è²¨å‡ºè²¨å–®å„²å­˜å¾Œçš„äº‹ä»¶
    /// ä½¿ç”¨ ChildDocumentRefreshHelper çµ±ä¸€è™•ç†åˆ·æ–°é‚è¼¯
    /// </summary>
    private async Task HandleSalesDeliverySaved(SalesDelivery savedDelivery)
    {
        try
        {
            await ChildDocumentRefreshHelper.HandleChildDocumentSavedAsync(
                closeModal: () =>
                {
                    showSalesDeliveryModal = false;
                    selectedSalesDeliveryId = null;
                },
                reloadDetails: async () =>
                {
                    if (SalesOrderId.HasValue)
                    {
                        await LoadSalesOrderDetails(SalesOrderId.Value);
                        
                        // é‡æ–°è¨ˆç®—ç¸½é‡‘é¡å’Œç¨…é¡
                        if (editModalComponent?.Entity != null)
                        {
                            await HandleDetailsChanged(salesOrderDetails);
                        }
                    }
                },
                detailManager: salesOrderDetailManager,
                notificationMessage: null,
                stateHasChanged: StateHasChanged,
                invokeAsync: InvokeAsync,
                additionalActions: async () =>
                {
                    //  é‡æ–°è¼‰å…¥å‡ºè²¨æ•¸é‡è³‡è¨Š
                    // æ³¨æ„ï¼šSalesOrderTable ç›®å‰æ²’æœ‰ LoadDeliveredQuantitiesAsync æ–¹æ³•
                    // æœªä¾†å¦‚éœ€é‡æ–°è¼‰å…¥å‡ºè²¨æ•¸é‡ï¼Œéœ€è¦åœ¨ SalesOrderTable ä¸­å¯¦ä½œæ­¤æ–¹æ³•
                    await Task.CompletedTask;
                }
            );
            
            await NotificationService.ShowSuccessAsync($"éŠ·è²¨å‡ºè²¨å–® {savedDelivery.Code} å·²æ›´æ–°ï¼Œè¨‚å–®æ˜ç´°å·²åˆ·æ–°");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSalesDeliverySaved), GetType(), 
                additionalData: $"è™•ç†éŠ·è²¨å‡ºè²¨å–®å„²å­˜äº‹ä»¶å¤±æ•— - DeliveryId: {savedDelivery?.Id}");
        }
    }

    /// <summary>
    /// è™•ç†éŠ·å”®é€€è²¨å–®å„²å­˜å¾Œçš„äº‹ä»¶
    /// </summary>
    /// <summary>
    /// è™•ç†éŠ·å”®é€€è²¨å–®å„²å­˜å¾Œçš„äº‹ä»¶
    /// ä½¿ç”¨ ChildDocumentRefreshHelper çµ±ä¸€è™•ç†åˆ·æ–°é‚è¼¯
    /// </summary>
    private async Task HandleSalesReturnSaved(SalesReturn savedReturn)
    {
        try
        {
            await ChildDocumentRefreshHelper.HandleChildDocumentSavedAsync(
                closeModal: () =>
                {
                    showSalesReturnModal = false;
                    selectedSalesReturnId = null;
                },
                reloadDetails: async () =>
                {
                    if (SalesOrderId.HasValue)
                    {
                        await LoadSalesOrderDetails(SalesOrderId.Value);
                        
                        // é‡æ–°è¨ˆç®—ç¸½é‡‘é¡å’Œç¨…é¡
                        if (editModalComponent?.Entity != null)
                        {
                            await HandleDetailsChanged(salesOrderDetails);
                        }
                    }
                },
                detailManager: salesOrderDetailManager,
                notificationMessage: null,
                stateHasChanged: StateHasChanged,
                invokeAsync: InvokeAsync,
                additionalActions: async () =>
                {
                    //  é—œéµä¿®å¾©ï¼šå‘¼å« Table çµ„ä»¶çš„å…¬é–‹åˆ·æ–°æ–¹æ³•
                    // é‡æ–°è¼‰å…¥é€€è²¨æ•¸é‡è³‡è¨Š
                    if (salesOrderDetailManager != null)
                    {
                        await salesOrderDetailManager.LoadReturnedQuantitiesAsync();
                    }
                }
            );
            
            await NotificationService.ShowSuccessAsync($"éŠ·å”®é€€è²¨å–® {savedReturn.Code} å·²æ›´æ–°ï¼Œè¨‚å–®æ˜ç´°å·²åˆ·æ–°");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSalesReturnSaved), GetType(), 
                additionalData: $"è™•ç†éŠ·å”®é€€è²¨å–®å„²å­˜äº‹ä»¶å¤±æ•— - ReturnId: {savedReturn?.Id}");
        }
    }

    /// <summary>
    /// æ’ç¨‹ç®¡ç† - ç›´æ¥é–‹å•Ÿç”Ÿç”¢æ’ç¨‹ç·¨è¼¯ Modal
    /// </summary>
    private async Task HandleBatchTransferToSchedule()
    {
        try
        {
            // é©—è­‰è¨‚å–®è³‡æ–™
            if (!SalesOrderId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("ç„¡æ³•æ’ç¨‹ç®¡ç†ï¼šè¨‚å–®è³‡æ–™ä¸å­˜åœ¨");
                return;
            }
            
            // ç›´æ¥é–‹å•Ÿç”Ÿç”¢æ’ç¨‹ç·¨è¼¯ Modalï¼ˆæ–°å¢æ¨¡å¼ï¼‰
            selectedProductionScheduleId = null;
            showProductionScheduleModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleBatchTransferToSchedule), GetType(), 
                additionalData: $"é–‹å•Ÿç”Ÿç”¢æ’ç¨‹ Modal å¤±æ•— - OrderId: {SalesOrderId}");
        }
    }
    
    /// <summary>
    /// æª¢æŸ¥è¨‚å–®æ˜¯å¦æœ‰åº«å­˜ä¸è¶³çš„ç‹€æ³
    /// åªæª¢æŸ¥ç¬¬ä¸€å±¤ä¸»è¦æ˜ç´°ï¼Œä¸åŒ…å«å­ææ–™
    /// </summary>
    private async Task CheckInventoryShortageAsync()
    {
        try
        {
            // æ–°å¢æ¨¡å¼æˆ–æ²’æœ‰æ˜ç´°æ™‚ä¸æª¢æŸ¥
            if (!SalesOrderId.HasValue || !salesOrderDetails.Any())
            {
                hasInventoryShortage = false;
                return;
            }
            
            isInventoryCheckLoading = true;
            StateHasChanged();
            
            // å‘¼å« API å–å¾—åº«å­˜æª¢æŸ¥çµæœ
            var checkResult = await SalesOrderService.GetOrderInventoryCheckAsync(SalesOrderId.Value);
            
            if (checkResult != null)
            {
                // åªè¨ˆç®—ç¬¬ä¸€å±¤ä¸»è¦æ˜ç´°ï¼ˆéå­ææ–™ï¼‰çš„ä¸è¶³æ•¸é‡
                var mainItems = checkResult.Items.Where(x => x.Level == 1 || x.ParentDetailId == null).ToList();
                var insufficientCount = mainItems.Count(x => x.Status == InventoryStatus.Insufficient);
                
                hasInventoryShortage = insufficientCount > 0;
            }
            else
            {
                hasInventoryShortage = false;
            }
        }
        catch (Exception ex)
        {
            // æª¢æŸ¥å¤±æ•—ä¸å½±éŸ¿ä¸»æµç¨‹ï¼Œé è¨­ç‚ºæ²’æœ‰ä¸è¶³
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(CheckInventoryShortageAsync), GetType(),
                additionalData: $"æª¢æŸ¥åº«å­˜ä¸è¶³ç‹€æ…‹å¤±æ•— - OrderId: {SalesOrderId}");
            hasInventoryShortage = false;
        }
        finally
        {
            isInventoryCheckLoading = false;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// é¡¯ç¤ºè¨‚å–®åº«å­˜æª¢è¦–
    /// </summary>
    private async Task HandleShowInventoryCheck()
    {
        try
        {
            // é©—è­‰è¨‚å–®è³‡æ–™
            if (!SalesOrderId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("ç„¡æ³•æª¢è¦–åº«å­˜ï¼šè¨‚å–®è³‡æ–™ä¸å­˜åœ¨");
                return;
            }
            
            // é–‹å•Ÿåº«å­˜æª¢è¦– Modal
            showInventoryCheckModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleShowInventoryCheck), GetType(), 
                additionalData: $"é–‹å•Ÿåº«å­˜æª¢è¦– Modal å¤±æ•— - OrderId: {SalesOrderId}");
        }
    }
    
    /// <summary>
    /// è™•ç†ç”Ÿç”¢æ’ç¨‹ Modal å¯è¦‹æ€§è®Šæ›´äº‹ä»¶
    /// ç•¶ Modal é—œé–‰æ™‚åˆ·æ–°æ˜ç´°è³‡æ–™ï¼ˆè™•ç†åˆªé™¤æ’ç¨‹å¾Œçš„å›å¯«ï¼‰
    /// </summary>
    private async Task HandleProductionScheduleModalVisibleChanged(bool visible)
    {
        var wasVisible = showProductionScheduleModal;
        showProductionScheduleModal = visible;
        
        // å¦‚æœæ˜¯å¾é¡¯ç¤ºè®Šæˆéš±è—ï¼ˆModal é—œé–‰ï¼‰ï¼Œåˆ·æ–°æ˜ç´°è³‡æ–™
        if (wasVisible && !visible && SalesOrderId.HasValue)
        {
            try
            {
                // é‡æ–°è¼‰å…¥è¨‚å–®æ˜ç´°ï¼ˆåˆ·æ–°å·²æ’ç¨‹æ•¸é‡ï¼‰
                await LoadSalesOrderDetails(SalesOrderId.Value);
                
                // åˆ·æ–° Table å…ƒä»¶
                if (salesOrderDetailManager != null)
                {
                    await salesOrderDetailManager.RefreshDetailsAsync();
                }
                
                StateHasChanged();
            }
            catch (Exception ex)
            {
                await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleProductionScheduleModalVisibleChanged), GetType(), 
                    additionalData: $"åˆ·æ–°æ˜ç´°è³‡æ–™å¤±æ•— - OrderId: {SalesOrderId}");
            }
        }
    }
    
    /// <summary>
    /// è™•ç†ç”Ÿç”¢æ’ç¨‹ Modal é—œé–‰äº‹ä»¶ï¼ˆå–æ¶ˆæˆ–åˆªé™¤å¾Œï¼‰
    /// </summary>
    private async Task HandleProductionScheduleModalClosed()
    {
        showProductionScheduleModal = false;
        selectedProductionScheduleId = null;
        
        // åˆ·æ–°æ˜ç´°è³‡æ–™ï¼ˆè™•ç†åˆªé™¤æ’ç¨‹å¾Œçš„å›å¯«ï¼‰
        if (SalesOrderId.HasValue)
        {
            try
            {
                await LoadSalesOrderDetails(SalesOrderId.Value);
                
                if (salesOrderDetailManager != null)
                {
                    await salesOrderDetailManager.RefreshDetailsAsync();
                }
                
                StateHasChanged();
            }
            catch (Exception ex)
            {
                await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleProductionScheduleModalClosed), GetType(), 
                    additionalData: $"åˆ·æ–°æ˜ç´°è³‡æ–™å¤±æ•— - OrderId: {SalesOrderId}");
            }
        }
    }
    
    /// <summary>
    /// è™•ç†æ’ç¨‹å„²å­˜æˆåŠŸäº‹ä»¶
    /// </summary>
    private async Task HandleScheduleCreated(ProductionSchedule schedule)
    {
        try
        {
            // é—œé–‰ Modal
            showProductionScheduleModal = false;
            selectedProductionScheduleId = null;
            
            // é‡æ–°è¼‰å…¥è¨‚å–®æ˜ç´°ï¼ˆåˆ·æ–°å·²æ’ç¨‹æ•¸é‡ï¼‰
            if (SalesOrderId.HasValue)
            {
                await LoadSalesOrderDetails(SalesOrderId.Value);
            }
            
            await NotificationService.ShowSuccessAsync($"æ’ç¨‹å„²å­˜æˆåŠŸï¼š{schedule.Code}");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleScheduleCreated), GetType(), 
                additionalData: $"è™•ç†æ’ç¨‹å„²å­˜äº‹ä»¶å¤±æ•— - ScheduleId: {schedule?.Id}");
        }
    }

    /// <summary>
    /// è™•ç†åˆ—å°äº‹ä»¶ - é–‹å•Ÿå ±è¡¨é è¦½ Modal
    /// </summary>
    private async Task HandlePrint()
    {
        try
        {
            // ç¬¬ä¸€æ­¥ï¼šæª¢æŸ¥æ˜¯å¦å¯åˆ—å°ï¼ˆéœ€å…ˆå„²å­˜ï¼‰
            if (!canPrint || !SalesOrderId.HasValue)
            {
                await NotificationService.ShowWarningAsync("è«‹å…ˆå„²å­˜éŠ·è²¨å–®å¾Œå†é€²è¡Œåˆ—å°");
                return;
            }
            
            // ç¬¬äºŒæ­¥ï¼šå®‰å…¨æª¢æŸ¥ - ç¢ºä¿ Entity å·²è¼‰å…¥
            if (editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("éŠ·è²¨å–®è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
                return;
            }
            
            // ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆå ±è¡¨å…§å®¹ä¸¦é–‹å•Ÿé è¦½ Modal
            await OpenReportPreviewModal();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePrint), GetType(), 
                additionalData: $"éŠ·è²¨å–®åˆ—å°è™•ç†å¤±æ•— - ID: {editModalComponent?.Entity?.Id}");
            await NotificationService.ShowErrorAsync("åˆ—å°è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    /// <summary>
    /// é–‹å•Ÿå ±è¡¨é è¦½ Modal
    /// </summary>
    private async Task OpenReportPreviewModal()
    {
        try
        {
            if (editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("ç„¡æ³•é è¦½ï¼šéŠ·è²¨å–®è³‡æ–™ä¸å­˜åœ¨");
                return;
            }

            // ç”Ÿæˆå ±è¡¨æ–‡ä»¶
            _formattedDocument = await SalesOrderReportService.GenerateReportAsync(editModalComponent.Entity.Id);
            
            // æ¸²æŸ“ç‚ºé è¦½åœ–ç‰‡
            _reportPreviewImages = await SalesOrderReportService.RenderToImagesAsync(editModalComponent.Entity.Id);
            
            _reportDocumentName = $"éŠ·è²¨å–®-{editModalComponent.Entity.Code}";
            
            // é–‹å•Ÿé è¦½ Modal
            _showReportPreviewModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(OpenReportPreviewModal), GetType(), 
                additionalData: $"é–‹å•ŸéŠ·è²¨å–®é è¦½å¤±æ•— - ID: {editModalComponent?.Entity?.Id}");
            await NotificationService.ShowErrorAsync("é–‹å•Ÿé è¦½æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    /// <summary>
    /// è™•ç†å ±è¡¨åˆ—å°æˆåŠŸäº‹ä»¶
    /// </summary>
    private Task HandleReportPrintSuccess()
    {
        // åˆ—å°æˆåŠŸå¾Œå¯ä»¥åŸ·è¡Œçš„é¡å¤–é‚è¼¯ï¼ˆå¦‚è¨˜éŒ„åˆ—å°æ¬¡æ•¸ç­‰ï¼‰
        return Task.CompletedTask;
    }

    /// <summary>
    /// è™•ç†ç´™å¼µè¨­å®šè®Šæ›´äº‹ä»¶
    /// ç•¶ç”¨æˆ¶åœ¨é è¦½ Modal ä¸­è®Šæ›´ç´™å¼µæ™‚ï¼Œé‡æ–°æ¸²æŸ“é è¦½åœ–ç‰‡
    /// </summary>
    private async Task HandlePaperSettingChanged(PaperSetting paperSetting)
    {
        try
        {
            if (editModalComponent?.Entity == null) return;
            
            // æ›´æ–° FormattedDocument çš„ç´™å¼µå°ºå¯¸ï¼ˆç”¨æ–¼åˆ—å°æ™‚æ­£ç¢ºåˆ†é ï¼‰
            if (_formattedDocument != null)
            {
                _formattedDocument.PageSettings.PageWidth = (float)paperSetting.Width;
                _formattedDocument.PageSettings.PageHeight = (float)paperSetting.Height;
                _formattedDocument.PageSettings.LeftMargin = (float)(paperSetting.LeftMargin ?? 1.0m);
                _formattedDocument.PageSettings.TopMargin = (float)(paperSetting.TopMargin ?? 1.0m);
                _formattedDocument.PageSettings.RightMargin = (float)(paperSetting.RightMargin ?? 1.0m);
                _formattedDocument.PageSettings.BottomMargin = (float)(paperSetting.BottomMargin ?? 1.0m);
            }
            
            // æ ¹æ“šæ–°çš„ç´™å¼µè¨­å®šé‡æ–°æ¸²æŸ“é è¦½åœ–ç‰‡
            _reportPreviewImages = await SalesOrderReportService.RenderToImagesAsync(
                editModalComponent.Entity.Id, 
                paperSetting);
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePaperSettingChanged), GetType(),
                additionalData: $"é‡æ–°æ¸²æŸ“éŠ·è²¨å–®é è¦½å¤±æ•— - ID: {editModalComponent?.Entity?.Id}, ç´™å¼µ: {paperSetting?.Name}");
            await NotificationService.ShowErrorAsync("æ›´æ–°é è¦½æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    /// <summary>
    /// åŒ…è£æ–¹æ³• - æä¾›çµ¦ GenericEditModalComponent ä½¿ç”¨çš„å„²å­˜è™•ç†å™¨
    /// </summary>
    private async Task<bool> SaveSalesOrderWrapper(SalesOrder salesOrder)
    {
        return await SaveSalesOrderWithDetails(salesOrder);
    }

    /// <summary>
    /// è‡ªè¨‚å„²å­˜é‚è¼¯ - åŒæ™‚å„²å­˜ä¸»æª”å’Œæ˜ç´°
    /// </summary>
    private async Task<bool> SaveSalesOrderWithDetails(SalesOrder salesOrder)
    {
        try
        {
            if (salesOrder == null)
            {
                await NotificationService.ShowErrorAsync("æ²’æœ‰è¦å„²å­˜çš„è¨‚å–®è³‡æ–™");
                return false;
            }

            // 1. å…ˆé€²è¡Œæ˜ç´°é©—è­‰ (æª¢æŸ¥å–®åƒ¹æ˜¯å¦ç‚º0)
            if (salesOrderDetailManager != null)
            {
                var isValid = await salesOrderDetailManager.ValidateAsync();
                if (!isValid)
                {
                    // ValidateAsync å…§éƒ¨å·²é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼Œç›´æ¥è¿”å›
                    return false;
                }
            }
            else
            {
                // å¦‚æœæ²’æœ‰ç®¡ç†å™¨å¼•ç”¨ï¼Œé€²è¡ŒåŸºæœ¬æª¢æŸ¥
                var invalidPriceDetails = salesOrderDetails
                    .Where(d => d.ProductId > 0 && d.UnitPrice < 0)
                    .ToList();
                
                if (invalidPriceDetails.Any())
                {
                    await NotificationService.ShowErrorAsync("æ‰€æœ‰å•†å“çš„å–®åƒ¹ä¸å¯ç‚ºè² æ•¸ï¼Œè«‹æª¢æŸ¥ä¸¦ä¿®æ­£");
                    return false;
                }
            }

            // âœ“ ä¸éœ€è¦é‡æ–°è¨ˆç®—ç¨…é¡ï¼
            // HandleDetailsChanged å·²ç¶“æ ¹æ“šæ¯å€‹æ˜ç´°çš„å¯¦éš›ç¨…ç‡æ­£ç¢ºè¨ˆç®—äº† TotalAmountã€DiscountAmountã€SalesTaxAmountã€TotalAmountWithTax
            // é€™è£¡åªéœ€è¦ç¢ºä¿ç¸½é‡‘é¡æ­£ç¢ºå³å¯(é€šå¸¸å·²ç¶“æ­£ç¢º,é€™è¡Œä¹Ÿå¯çœç•¥)
            // salesOrder.TotalAmountã€SalesTaxAmountã€TotalAmountWithTax éƒ½å·²ç”± HandleDetailsChanged è¨­å®š

            var isEditMode = SalesOrderId.HasValue;
            
            // 2. ğŸ’¡ è¨‚å–®ä¸å½±éŸ¿åº«å­˜ï¼Œç„¡éœ€é©—è­‰å€‰åº«åº«å­˜
            // å€‰åº«é¸æ“‡å’Œåº«å­˜é©—è­‰æ‡‰åœ¨ã€ŒéŠ·è²¨å‡ºè²¨å–®ã€éšæ®µé€²è¡Œ
            
            List<SalesOrderDetail> originalDetails = new();
            
            // åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹ï¼Œå…ˆå–å¾—åŸå§‹æ˜ç´°è³‡æ–™
            if (isEditMode)
            {
                originalDetails = await SalesOrderDetailService.GetBySalesOrderIdAsync(SalesOrderId!.Value);
            }

            // å„²å­˜ä¸»æª”
            ServiceResult<SalesOrder> result;
            if (isEditMode)
            {
                result = await SalesOrderService.UpdateAsync(salesOrder);
            }
            else
            {
                result = await SalesOrderService.CreateAsync(salesOrder);
            }

            if (!result.IsSuccess || result.Data == null)
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "å„²å­˜è¨‚å–®å¤±æ•—");
                return false;
            }

            // å„²å­˜æ˜ç´°
            await SaveSalesOrderDetails(result.Data.Id, isEditMode, isEditMode ? originalDetails : new List<SalesOrderDetail>());
            
            // ğŸ”‘ å„²å­˜ BOM çµ„æˆæ˜ç´°
            await SaveSalesOrderCompositionDetails(result.Data.Id);
            
            // ğŸ’¡ è¨‚å–®ä¸å½±éŸ¿åº«å­˜ï¼Œç„¡éœ€æ‰£æ¸›åº«å­˜
            // åº«å­˜æ‰£æ¸›æ‡‰ç™¼ç”Ÿåœ¨ã€ŒéŠ·è²¨å‡ºè²¨å–®ã€éšæ®µï¼Œè€Œéã€Œè¨‚å–®ã€éšæ®µ

            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveSalesOrderWithDetails), GetType(), 
                additionalData: "å„²å­˜è¨‚å–®å’Œæ˜ç´°å¤±æ•—");
            await NotificationService.ShowErrorAsync($"å„²å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// å„²å­˜è¨‚å–®æ˜ç´°ï¼ˆæ”¯æ´æ–°å¢å’Œç·¨è¼¯æ¨¡å¼ï¼‰
    /// </summary>
    /// <param name="salesOrderId">è¨‚å–®ID</param>
    /// <param name="isEditMode">æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼</param>
    /// <param name="originalDetails">åŸå§‹æ˜ç´°åˆ—è¡¨ï¼ˆç·¨è¼¯æ¨¡å¼ä½¿ç”¨ï¼‰</param>
    private async Task SaveSalesOrderDetails(int salesOrderId, bool isEditMode = false, List<SalesOrderDetail>? originalDetails = null)
    {
        try
        {
            // åªè™•ç†æœ‰æ•ˆçš„æ˜ç´°ï¼ˆå·²é¸æ“‡å•†å“çš„ï¼‰
            var validDetails = salesOrderDetails.Where(d => d.ProductId > 0).ToList();
            

            // è¨­å®šä¸»æª”IDå’Œæ™‚é–“æˆ³è¨˜
            foreach (var detail in validDetails)
            {
                detail.SalesOrderId = salesOrderId;
                if (detail.Id == 0)
                {
                    detail.Status = EntityStatus.Active;
                    detail.CreatedAt = DateTime.Now;
                }
                else
                {
                    detail.UpdatedAt = DateTime.Now;
                }

            }

            // å…ˆç²å–ç¾æœ‰çš„æ˜ç´°ï¼ˆå¦‚æœæœªæä¾›ï¼‰
            var existingDetails = originalDetails ?? (await SalesOrderService.GetWithDetailsAsync(salesOrderId))?.SalesOrderDetails?.ToList() ?? new List<SalesOrderDetail>();
            
            // è™•ç†æ–°å¢å’Œæ›´æ–°çš„æ˜ç´°
            foreach (var detail in validDetails)
            {
                if (detail.Id == 0)
                {
                    // æ–°å¢æ˜ç´°
                    var createResult = await SalesOrderDetailService.CreateAsync(detail);
                    if (createResult.IsSuccess && createResult.Data != null)
                    {
                        // æ›´æ–°æœ¬åœ°æ˜ç´°çš„ ID
                        detail.Id = createResult.Data.Id;
                        
                        //  æ›´æ–°å ±åƒ¹å–®æ˜ç´°çš„å·²è½‰éŠ·è²¨æ•¸é‡
                        if (detail.QuotationDetailId.HasValue)
                        {
                            await UpdateQuotationDetailConvertedQuantity(
                                detail.QuotationDetailId.Value, 
                                detail.OrderQuantity, 
                                isAdding: true
                            );
                        }
                    }
                }
                else
                {
                    // æ›´æ–°æ˜ç´° - éœ€è¦æª¢æŸ¥æ•¸é‡è®ŠåŒ–
                    var originalDetail = existingDetails.FirstOrDefault(e => e.Id == detail.Id);
                    var quantityDiff = detail.OrderQuantity - (originalDetail?.OrderQuantity ?? 0);
                    
                    await SalesOrderDetailService.UpdateAsync(detail);
                    
                    //  å¦‚æœæ•¸é‡æœ‰è®ŠåŒ–ä¸”æœ‰å ±åƒ¹å–®ä¾†æºï¼Œæ›´æ–°å ±åƒ¹å–®æ˜ç´°çš„å·²è½‰éŠ·è²¨æ•¸é‡
                    if (quantityDiff != 0 && detail.QuotationDetailId.HasValue)
                    {
                        await UpdateQuotationDetailConvertedQuantity(
                            detail.QuotationDetailId.Value,
                            Math.Abs(quantityDiff),
                            isAdding: quantityDiff > 0
                        );
                    }
                }
            }

            // è™•ç†åˆªé™¤çš„æ˜ç´°ï¼ˆç¾æœ‰çš„ä½†ä¸åœ¨ç•¶å‰æœ‰æ•ˆåˆ—è¡¨ä¸­çš„ï¼‰
            var currentDetailIds = validDetails.Where(d => d.Id > 0).Select(d => d.Id).ToList();
            var detailsToDelete = existingDetails.Where(e => !currentDetailIds.Contains(e.Id)).ToList();
            

            foreach (var detailToDelete in detailsToDelete)
            {
                //  å¦‚æœæœ‰å ±åƒ¹å–®ä¾†æºï¼Œæ¸›å°‘å ±åƒ¹å–®æ˜ç´°çš„å·²è½‰éŠ·è²¨æ•¸é‡
                if (detailToDelete.QuotationDetailId.HasValue)
                {
                    await UpdateQuotationDetailConvertedQuantity(
                        detailToDelete.QuotationDetailId.Value,
                        detailToDelete.OrderQuantity,
                        isAdding: false
                    );
                }
                
                await SalesOrderDetailService.PermanentDeleteAsync(detailToDelete.Id);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveSalesOrderDetails), GetType(), 
                additionalData: $"å„²å­˜è¨‚å–®æ˜ç´°å¤±æ•— - OrderId: {salesOrderId}");
            throw; // é‡æ–°æ‹‹å‡ºä¾‹å¤–ï¼Œè®“ä¸Šå±¤è™•ç†
        }
    }

    /// <summary>
    /// æ›´æ–°å ±åƒ¹å–®æ˜ç´°çš„å·²è½‰éŠ·è²¨æ•¸é‡
    /// </summary>
    private async Task UpdateQuotationDetailConvertedQuantity(int quotationDetailId, decimal quantity, bool isAdding)
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var quotationDetail = await context.QuotationDetails.FindAsync(quotationDetailId);
            
            if (quotationDetail != null)
            {
                if (isAdding)
                {
                    quotationDetail.ConvertedQuantity += quantity;
                }
                else
                {
                    quotationDetail.ConvertedQuantity -= quantity;
                    // ç¢ºä¿ä¸æœƒè®Šæˆè² æ•¸
                    if (quotationDetail.ConvertedQuantity < 0)
                        quotationDetail.ConvertedQuantity = 0;
                }
                
                quotationDetail.UpdatedAt = DateTime.Now;
                await context.SaveChangesAsync();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(UpdateQuotationDetailConvertedQuantity), GetType(),
                additionalData: new { QuotationDetailId = quotationDetailId, Quantity = quantity, IsAdding = isAdding });
            // ä¸æ‹‹å‡ºç•°å¸¸ï¼Œé¿å…å½±éŸ¿ä¸»æµç¨‹
        }
    }

    /// <summary>
    /// å„²å­˜è¨‚å–®çµ„åˆæ˜ç´°ï¼ˆBOMï¼‰
    /// </summary>
    /// <summary>
    /// å„²å­˜è¨‚å–®çµ„åˆæ˜ç´°ï¼ˆBOMï¼‰
    /// è™•ç†è‡¨æ™‚ç´¢å¼•ï¼ˆè² æ•¸ï¼‰æ˜ å°„åˆ°å¯¦éš›å„²å­˜å¾Œçš„æ˜ç´°ID
    /// </summary>
    private async Task SaveSalesOrderCompositionDetails(int salesOrderId)
    {
        try
        {
            // å¾ SalesOrderTable çµ„ä»¶å–å¾—çµ„åˆæ˜ç´°è³‡æ–™
            if (salesOrderDetailManager == null)
            {
                return;
            }
            
            var compositionDetailsMap = salesOrderDetailManager.GetCompositionDetails();
            
            if (!compositionDetailsMap.Any())
            {
                return; // æ²’æœ‰è‡ªè¨‚ BOMï¼Œä¸éœ€è¦å„²å­˜
            }
            
            // âœ… ç°¡åŒ–é‚è¼¯ï¼šç›´æ¥ä½¿ç”¨ salesOrderDetailsï¼ˆSaveSalesOrderDetails å·²æ›´æ–°æ‰€æœ‰ IDï¼‰
            // ä¸éœ€è¦é‡æ–°æŸ¥è©¢è³‡æ–™åº«
            foreach (var kvp in compositionDetailsMap)
            {
                var salesOrderDetailId = kvp.Key;
                var compositionDetails = kvp.Value;
                
                int actualDetailId = 0;
                
                if (salesOrderDetailId > 0)
                {
                    // å·²å­˜åœ¨çš„æ˜ç´°ï¼Œç›´æ¥ä½¿ç”¨è©² ID
                    actualDetailId = salesOrderDetailId;
                }
                else
                {
                    // ğŸ”‘ è‡¨æ™‚ç´¢å¼•ï¼ˆè² æ•¸ï¼‰ï¼Œç›´æ¥å°æ‡‰åˆ° SalesItems ç´¢å¼•
                    // -(i+1) çš„åå‘è¨ˆç®—ï¼šå¾ -1 æ¨å›ç´¢å¼• 0ï¼Œå¾ -2 æ¨å›ç´¢å¼• 1
                    int salesItemIndex = Math.Abs(salesOrderDetailId) - 1;
                    
                    if (salesItemIndex >= 0 && salesItemIndex < salesOrderDetailManager.SalesItems.Count)
                    {
                        var salesItem = salesOrderDetailManager.SalesItems[salesItemIndex];
                        
                        // ğŸ”‘ é—œéµä¿®æ­£ï¼šæ‰¾åˆ°æ–°å¢çš„æ˜ç´°ï¼ˆæ²’æœ‰ ExistingDetailEntity çš„ï¼‰
                        // å› ç‚ºå¯èƒ½æœ‰å¤šç­†ç›¸åŒ ProductIdï¼Œéœ€è¦æŒ‰é †åºåŒ¹é…
                        var newDetails = salesOrderDetails
                            .Where(d => d.ProductId == salesItem.SelectedProduct?.Id)
                            .OrderBy(d => d.Id)
                            .ToList();
                        
                        // æ‰¾å‡ºé€™æ˜¯ç¬¬å¹¾å€‹æ–°å¢çš„è©²å•†å“æ˜ç´°
                        int newItemSequence = 0;
                        for (int idx = 0; idx <= salesItemIndex; idx++)
                        {
                            var checkItem = salesOrderDetailManager.SalesItems[idx];
                            if (checkItem.SelectedProduct?.Id == salesItem.SelectedProduct?.Id && 
                                checkItem.ExistingDetailEntity == null)
                            {
                                if (idx == salesItemIndex)
                                    break;
                                newItemSequence++;
                            }
                        }
                        
                        // æ’é™¤å·²å­˜åœ¨çš„æ˜ç´°ï¼Œå–ç¬¬ n å€‹æ–°å¢çš„
                        var existingCount = salesOrderDetailManager.SalesItems
                            .Count(x => x.SelectedProduct?.Id == salesItem.SelectedProduct?.Id && 
                                       x.ExistingDetailEntity != null);
                        
                        if (newItemSequence + existingCount < newDetails.Count)
                        {
                            var matchedDetail = newDetails[newItemSequence + existingCount];
                            actualDetailId = matchedDetail.Id;
                        }
                        else
                        {
                            continue;
                        }
                    }
                    else
                    {
                        continue;
                    }
                }
                
                if (actualDetailId <= 0)
                {
                    continue;
                }
                
                // æ‰¹æ¬¡å„²å­˜çµ„åˆæ˜ç´°ï¼ˆä½¿ç”¨å¯¦éš›çš„æ˜ç´°IDï¼‰
                await SalesOrderCompositionDetailService.SaveBatchAsync(
                    actualDetailId,
                    compositionDetails
                );
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveSalesOrderCompositionDetails), GetType(),
                additionalData: $"å„²å­˜è¨‚å–® BOM çµ„æˆå¤±æ•— - OrderId: {salesOrderId}");
            // ä¸æ‹‹å‡ºç•°å¸¸ï¼Œé¿å…å½±éŸ¿ä¸»æµç¨‹ï¼Œä½†è¨˜éŒ„éŒ¯èª¤
            await NotificationService.ShowWarningAsync($"BOM çµ„æˆå„²å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// ä½¿ç”¨FIFOæ–¹å¼æ‰£æ¸›åº«å­˜
    /// </summary>
    private async Task ReduceInventoryWithFIFOAsync(int salesOrderId)
    {
        try
        {
            // åªè™•ç†æœ‰æ•ˆçš„æ˜ç´°ï¼ˆå·²é¸æ“‡å•†å“å’Œå€‰åº«çš„ï¼‰
            var validDetails = salesOrderDetails
                .Where(d => d.ProductId > 0 && d.OrderQuantity > 0 && d.WarehouseId.HasValue)
                .ToList();

            foreach (var detail in validDetails)
            {
                if (!detail.WarehouseId.HasValue) continue;

                var result = await InventoryStockService.ReduceStockWithFIFOAsync(
                    detail.ProductId,
                    detail.WarehouseId.Value,
                    (int)Math.Ceiling(detail.OrderQuantity),
                    InventoryTransactionTypeEnum.Sale,
                    $"SO-{salesOrderId}",
                    null, // WarehouseLocationId - SalesOrderDetailæ²’æœ‰æ­¤æ¬„ä½ï¼Œå‚³å…¥null
                    $"è¨‚å–®å‡ºè²¨ - SO-{salesOrderId}",
                    detail.Id > 0 ? detail.Id : null // å‚³éæ˜ç´°IDç”¨æ–¼è¿½è¹¤
                );

                if (!result.IsSuccess)
                {
                    await NotificationService.ShowWarningAsync($"å•†å“ {detail.Product?.Name} åº«å­˜æ‰£æ¸›å¤±æ•—ï¼š{result.ErrorMessage}");
                    // ä¸ä¸­æ–·æµç¨‹ï¼Œåªè¨˜éŒ„è­¦å‘Š
                }
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ReduceInventoryWithFIFOAsync), GetType(), 
                additionalData: $"FIFOåº«å­˜æ‰£æ¸›å¤±æ•— - OrderId: {salesOrderId}");
            await NotificationService.ShowWarningAsync("åº«å­˜æ‰£æ¸›æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥åº«å­˜è¨˜éŒ„");
        }
    }
    
    // ===== å¾å ±åƒ¹å–®è½‰å–®ç›¸é—œæ–¹æ³• =====
    
    /// <summary>
    /// æ‰“é–‹æ–°å¢è¨‚å–® Modal ä¸¦é å¡«å ±åƒ¹å–®è³‡æ–™ï¼ˆå…¬é–‹æ–¹æ³•ï¼Œä¾›çˆ¶çµ„ä»¶å‘¼å«ï¼‰
    /// </summary>
    public async Task ShowAddModalWithPrefilledQuotation(int customerId, int companyId, int? employeeId, int quotationId)
    {
        try
        {
            // ä½¿ç”¨ DocumentConversionHelper è™•ç†è½‰å–®é‚è¼¯ï¼ˆè‡ªè¨‚è¼‰å…¥é‚è¼¯ç‰ˆæœ¬ï¼‰
            var success = await DocumentConversionHelper.ShowConversionModalWithCustomLoadAsync(
                resetEntityId: () => SalesOrderId = null,
                setPrefilledValues: () =>
                {
                    PrefilledCustomerId = customerId;
                    PrefilledQuotationId = quotationId;
                },
                isVisibleChanged: IsVisibleChanged,
                customLoadAction: async () =>
                {
                    await LoadQuotationDetailsToSalesOrder(quotationId);
                },
                detailManagerReady: () => salesOrderDetailManager != null,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("è½‰å–®æµç¨‹åŸ·è¡Œå¤±æ•—");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledQuotation), GetType(), 
                additionalData: $"é–‹å•Ÿé å¡«è¨‚å–®Modalå¤±æ•— - CustomerId: {customerId}, QuotationId: {quotationId}");
            await NotificationService.ShowErrorAsync("é–‹å•Ÿè¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    /// <summary>
    /// å¾å ±åƒ¹å–®è¼‰å…¥æ˜ç´°åˆ°è¨‚å–®æ˜ç´°è¡¨
    /// </summary>
    private async Task LoadQuotationDetailsToSalesOrder(int quotationId)
    {
        try
        {
            // è¼‰å…¥å ±åƒ¹å–®è³‡æ–™ï¼ˆå«æ˜ç´°å’Œå¯©æ ¸ç‹€æ…‹ï¼‰
            var quotation = await QuotationService.GetWithDetailsAsync(quotationId);
            if (quotation == null)
            {
                await NotificationService.ShowWarningAsync("æ‰¾ä¸åˆ°æŒ‡å®šçš„å ±åƒ¹å–®", "è¼‰å…¥å¤±æ•—");
                return;
            }
            
            // é©—è­‰å ±åƒ¹å–®æ˜ç´°
            if (quotation.QuotationDetails == null || !quotation.QuotationDetails.Any())
            {
                await NotificationService.ShowWarningAsync("å ±åƒ¹å–®æ²’æœ‰æ˜ç´°è³‡æ–™", "è¼‰å…¥å¤±æ•—");
                return;
            }
            
            // ä½¿ç”¨ SalesOrderTable çš„å…¬é–‹æ–¹æ³•è¼‰å…¥æ˜ç´°
            if (salesOrderDetailManager != null)
            {
                await salesOrderDetailManager.LoadQuotationDetails(
                    quotation.QuotationDetails.ToList(), 
                    quotationId, 
                    quotation.IsApproved
                );
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadQuotationDetailsToSalesOrder), GetType(),
                additionalData: new { QuotationId = quotationId });
            await NotificationService.ShowErrorAsync("è¼‰å…¥å ±åƒ¹å–®æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    /// <summary>
    /// å¾å ±åƒ¹å–®è¼‰å…¥è³‡æ–™åˆ°è¨‚å–®
    /// æ³¨æ„ï¼šå¯¦éš›çš„è½‰å–®é‚è¼¯ç”± QuotationEditModalComponent åœ¨å„²å­˜æ™‚è™•ç†
    /// é€™è£¡åªæ˜¯é ç•™åƒæ•¸ï¼Œå¯¦éš›ä½¿ç”¨ PrefilledCustomerId
    /// </summary>
    private async Task LoadDataFromQuotation(SalesOrder salesOrder, int quotationId)
    {
        try
        {
            // è¼‰å…¥å ±åƒ¹å–®è³‡æ–™ï¼ˆå«æ˜ç´°å’Œå¯©æ ¸ç‹€æ…‹ï¼‰
            var quotation = await QuotationService.GetWithDetailsAsync(quotationId);
            if (quotation == null)
            {
                await NotificationService.ShowWarningAsync("æ‰¾ä¸åˆ°æŒ‡å®šçš„å ±åƒ¹å–®", "è¼‰å…¥å¤±æ•—");
                return;
            }
            
            // è¨­å®šå ±åƒ¹å–®IDï¼ˆé‡è¦ï¼šé€™æ¨£å ±åƒ¹å–®æ¬„ä½æ‰æœƒæ­£ç¢ºé¡¯ç¤ºï¼‰
            salesOrder.QuotationId = quotationId;
            
            // è¨­å®šå®¢æˆ¶ID
            salesOrder.CustomerId = quotation.CustomerId;
            
            // è¨­å®šå…¬å¸ID
            salesOrder.CompanyId = quotation.CompanyId;
            
            // è¨­å®šæ¥­å‹™å“¡ID
            salesOrder.EmployeeId = quotation.EmployeeId;
            
            // è¨­å®šç¨…åˆ¥
            salesOrder.TaxCalculationMethod = quotation.TaxCalculationMethod;
            
            // æ³¨æ„ï¼šæ˜ç´°çš„è¼‰å…¥å°‡ç”±çˆ¶çµ„ä»¶ï¼ˆQuotationEditModalComponentï¼‰çš„ HandleCreateSalesOrderFromQuotation è™•ç†
            // é€™è£¡ä¸ç›´æ¥è™•ç†æ˜ç´°è½‰æ›ï¼Œåªè¨­å®šå¯©æ ¸ç‹€æ…‹å’Œå®¢æˆ¶
            salesOrderDetails.Clear();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDataFromQuotation), GetType(),
                additionalData: new { QuotationId = quotationId });
        }
    }
}
