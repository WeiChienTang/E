@using ERPCore2.Services.Reports.Interfaces
@using ERPCore2.Models.Reports
@inject ISalesOrderService SalesOrderService
@inject ISalesOrderDetailService SalesOrderDetailService
@inject ISalesOrderCompositionDetailService SalesOrderCompositionDetailService
@inject ICustomerService CustomerService
@inject ICompanyService CompanyService
@inject IProductService ProductService
@inject IEmployeeService EmployeeService
@inject IUnitService UnitService
@inject IWarehouseService WarehouseService
@inject ISystemParameterService SystemParameterService
@inject INotificationService NotificationService
@inject ActionButtonHelper ActionButtonHelper
@inject IJSRuntime JSRuntime
@inject IQuotationService QuotationService
@inject IQuotationDetailService QuotationDetailService
@inject ISalesOrderReportService SalesOrderReportService
@inject ERPCore2.Data.Context.AppDbContext DbContext
@inject IDbContextFactory<AppDbContext> DbContextFactory

<GenericEditModalComponent TEntity="SalesOrder" 
                          TService="ISalesOrderService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@SalesOrderId"
                          Service="@SalesOrderService"
                          EntityName="訂單"
                          EntityNamePlural="訂單"
                          ModalTitle="@(SalesOrderId.HasValue ? "編輯訂單" : "新增訂單")"
                          Size="GenericEditModalComponent<SalesOrder, ISalesOrderService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@autoCompleteConfig?.Prefillers"
                          AutoCompleteCollections="@autoCompleteConfig?.Collections"
                          AutoCompleteDisplayProperties="@autoCompleteConfig?.DisplayProperties"
                          AutoCompleteValueProperties="@autoCompleteConfig?.ValueProperties"
                          ModalManagers="@modalManagers?.AsDictionary()"
                          DataLoader="@LoadSalesOrderData"
                          SaveHandler="@SaveSalesOrderWithDetails"
                          SaveSuccessMessage="@(SalesOrderId.HasValue ? "訂單更新成功" : "訂單新增成功")"
                          SaveFailureMessage="訂單儲存失敗"
                          RequiredPermission="SalesOrder.Read"
                          OnEntitySaved="@OnSalesOrderSaved"
                          OnCancel="@OnCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          OnTaxMethodChanged="@(() => HandleDetailsChanged(salesOrderDetails))"
                          GetStatusMessage="@GetStatusMessage"
                          FormHeaderContent="@GetWarningMessage()"
                          CustomModules="@GetCustomModules()"
                          CustomActionButtons="@GetCustomActionButtons()"
                          ShowPrintButton="true"
                          ReportService="@SalesOrderReportService"
                          ReportId="@ReportIds.SalesOrder"
                          ReportPreviewTitle="銷貨單預覽"
                          GetReportDocumentName="@(e => $"銷貨單-{e.Code}")"
                          OnEntityLoaded="@HandleEntityLoaded">
</GenericEditModalComponent>

@* 客戶編輯 Modal *@
<CustomerEditModalComponent @ref="customerEditModal"
                           IsVisible="@customerModalManager.IsModalVisible"
                           IsVisibleChanged="@customerModalManager.HandleModalVisibilityChangedAsync"
                           CustomerId="@customerModalManager.SelectedEntityId"
                           OnCustomerSaved="@customerModalManager.OnSavedAsync"
                           OnCancel="@customerModalManager.HandleModalCancelAsync" />

@* 公司編輯 Modal *@
<CompanyEditModalComponent @ref="companyEditModal"
                          IsVisible="@companyModalManager.IsModalVisible"
                          IsVisibleChanged="@companyModalManager.HandleModalVisibilityChangedAsync"
                          CompanyId="@companyModalManager.SelectedEntityId"
                          OnCompanySaved="@companyModalManager.OnSavedAsync"
                          OnCancel="@companyModalManager.HandleModalCancelAsync" />

@* 業務員編輯 Modal *@
<EmployeeEditModalComponent @ref="employeeEditModal"
                           IsVisible="@employeeModalManager.IsModalVisible"
                           IsVisibleChanged="@employeeModalManager.HandleModalVisibilityChangedAsync"
                           EmployeeId="@employeeModalManager.SelectedEntityId"
                           OnEmployeeSaved="@employeeModalManager.OnSavedAsync"
                           OnCancel="@employeeModalManager.HandleModalCancelAsync" />

@* 銷貨退回編輯 Modal *@
<SalesReturnEditModalComponent @ref="salesReturnEditModal"
                              IsVisible="@showSalesReturnModal"
                              IsVisibleChanged="@((bool visible) => showSalesReturnModal = visible)"
                              SalesReturnId="@selectedSalesReturnId"
                              OnSalesReturnSaved="@HandleSalesReturnSaved"
                              OnCancel="@(() => showSalesReturnModal = false)" />

@* 銷貨出貨單編輯 Modal *@
<SalesDeliveryEditModalComponent @ref="salesDeliveryEditModal"
                                IsVisible="@showSalesDeliveryModal"
                                IsVisibleChanged="@(value => showSalesDeliveryModal = value)"
                                SalesDeliveryId="@selectedSalesDeliveryId"
                                OnSalesDeliverySaved="@HandleSalesDeliverySaved"
                                OnCancel="@(() => showSalesDeliveryModal = false)" />

@* 沖款單編輯 Modal *@
<SetoffDocumentEditModalComponent @ref="setoffDocumentEditModal"
                                 IsVisible="@showSetoffDocumentModal"
                                 IsVisibleChanged="@((bool visible) => showSetoffDocumentModal = visible)"
                                 SetoffDocumentId="@selectedSetoffDocumentId"
                                 OnSetoffDocumentSaved="@HandleSetoffDocumentSaved"
                                 OnCancel="@(() => showSetoffDocumentModal = false)" />

@* 生產排程編輯 Modal *@
<ProductionScheduleEditModalComponent @ref="productionScheduleEditModal"
                                     IsVisible="@showProductionScheduleModal"
                                     IsVisibleChanged="@HandleProductionScheduleModalVisibleChanged"
                                     ProductionScheduleId="@selectedProductionScheduleId"
                                     OnProductionScheduleSaved="@HandleScheduleCreated"
                                     OnCancel="@HandleProductionScheduleModalClosed" />

@* 訂單庫存檢視 Modal *@
<OrderInventoryCheckModal IsVisible="@showInventoryCheckModal"
                         IsVisibleChanged="@((bool visible) => showInventoryCheckModal = visible)"
                         SalesOrderId="@SalesOrderId"
                         OrderNumber="@(editModalComponent?.Entity?.Code)"
                         OnClose="@(() => showInventoryCheckModal = false)" />

@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SalesOrderId { get; set; }
    [Parameter] public EventCallback<SalesOrder> OnSalesOrderSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    
    // ===== 預填參數（用於從報價單轉單） =====
    [Parameter] public int? PrefilledCustomerId { get; set; }
    [Parameter] public int? PrefilledQuotationId { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<SalesOrder, ISalesOrderService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // AutoComplete 配置
    private AutoCompleteConfig? autoCompleteConfig;
    
    private List<Customer> customers = new();
    private List<Company> companies = new();
    private List<Employee> employees = new();
    private List<Product> products = new();
    private List<Unit> units = new();
    private List<Warehouse> warehouses = new();
    private List<Quotation> quotations = new();
    
    // 訂單明細
    private List<SalesOrderDetail> salesOrderDetails = new();
    
    private int _detailsDataVersion = 0;
    
    // 明細管理組件引用
    private SalesOrderTable<SalesOrder, SalesOrderDetail>? salesOrderDetailManager;
    
    // Modal Manager 集合
    private ModalManagerCollection? modalManagers;
    
    // Modal 管理器
    private CustomerEditModalComponent? customerEditModal;
    private RelatedEntityModalManager<Customer> customerModalManager = default!;
    private CompanyEditModalComponent? companyEditModal;
    private RelatedEntityModalManager<Company> companyModalManager = default!;
    private EmployeeEditModalComponent? employeeEditModal;
    private RelatedEntityModalManager<Employee> employeeModalManager = default!;
    private RelatedEntityModalManager<Product> productModalManager = default!;
    
    // 商品篩選
    private int? filterProductId = null;
    
    // ===== 相關單據 Modal =====
    private SalesReturnEditModalComponent? salesReturnEditModal;
    private SetoffDocumentEditModalComponent? setoffDocumentEditModal;
    private bool showSalesReturnModal = false;
    private bool showSetoffDocumentModal = false;
    private int? selectedSalesReturnId = null;
    private int? selectedSetoffDocumentId = null;
    
    // 銷貨出貨單 Modal
    private SalesDeliveryEditModalComponent? salesDeliveryEditModal;
    private bool showSalesDeliveryModal = false;
    private int? selectedSalesDeliveryId = null;
    
    // 生產排程編輯 Modal
    private ProductionScheduleEditModalComponent? productionScheduleEditModal;
    private bool showProductionScheduleModal = false;
    private int? selectedProductionScheduleId = null;
    
    // 訂單庫存檢視 Modal
    private bool showInventoryCheckModal = false;
    
    // 庫存不足狀態
    private bool hasInventoryShortage = false;
    private bool isInventoryCheckLoading = false;
    
    // 下拉選單選項
    private List<SelectOption> taxCalculationMethodOptions = new();
    
    // 稅率快取變數（一次性載入，避免每次計算都查詢資料庫）
    private decimal currentTaxRate = 5.0m; // 預設 5%，實際值會在初始化時從資料庫載入
    
    // ===== 鎖定狀態 =====
    private bool hasUndeletableDetails = false;
    private bool isDetailDataReady = false;
    private bool isDataLoaded = false;  // 資料載入狀態標記
    
    // ===== 必要方法 =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 使用 ModalManagerInitHelper 初始化所有 Manager
            modalManagers = ModalManagerInitHelper.CreateBuilder<SalesOrder, ISalesOrderService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Customer>(nameof(SalesOrder.CustomerId), "客戶")
                .AddManager<Company>(nameof(SalesOrder.CompanyId), "公司")
                .AddManager<Employee>(nameof(SalesOrder.EmployeeId), "業務員")
                .AddManager<Product>("FilterProductId", "商品")
                .Build();
            
            // 取得個別 Manager 供組件使用
            customerModalManager = modalManagers.Get<Customer>(nameof(SalesOrder.CustomerId));
            companyModalManager = modalManagers.Get<Company>(nameof(SalesOrder.CompanyId));
            employeeModalManager = modalManagers.Get<Employee>(nameof(SalesOrder.EmployeeId));
            productModalManager = modalManagers.Get<Product>("FilterProductId");
            
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化訂單編輯組件時發生錯誤");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            if (IsVisible && !isDataLoaded)
            {
                await LoadAdditionalDataAsync();
                await InitializeFormFieldsAsync();
                isDataLoaded = true;
            }
            else if (!IsVisible)
            {
                isDetailDataReady = false;
                isDataLoaded = false;
            }

            await base.OnParametersSetAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"參數設置時發生錯誤：{ex.Message}");
        }
    }
    private async Task<SalesOrder?> LoadSalesOrderData()
    {
        try
        {
            // 重置明細資料準備狀態
            isDetailDataReady = false;
            hasUndeletableDetails = false;
            
            if (!SalesOrderId.HasValue)
            {
                // 新增模式
                var newOrder = new SalesOrder
                {
                    Code = await EntityCodeGenerationHelper.GenerateForEntity<SalesOrder, ISalesOrderService>(SalesOrderService, DbContext),
                    OrderDate = DateTime.Today,
                    ExpectedDeliveryDate = DateTime.Today.AddDays(7),
                    Status = EntityStatus.Active,
                    TotalAmount = 0
                };
                
                // 取得預設公司
                var primaryCompany = await CompanyService.GetPrimaryCompanyAsync();
                newOrder.CompanyId = primaryCompany?.Id ?? 0;
                
                // 如果是從報價單轉單，載入報價單資料
                if (PrefilledQuotationId.HasValue)
                {
                    await LoadDataFromQuotation(newOrder, PrefilledQuotationId.Value);
                }
                else if (PrefilledCustomerId.HasValue)
                {
                    newOrder.CustomerId = PrefilledCustomerId.Value;
                }
                
                // 清空明細
                if (!PrefilledQuotationId.HasValue)
                {
                    salesOrderDetails.Clear();
                }
                
                isDetailDataReady = true;
                return newOrder;
            }

            // 編輯模式
            var salesOrder = await SalesOrderService.GetWithDetailsAsync(SalesOrderId.Value);
            
            if (salesOrder != null)
            {
                // 載入訂單明細
                await LoadSalesOrderDetails(SalesOrderId.Value);
                
                // 載入明細相關資料（退貨記錄、收款記錄）
                await LoadDetailRelatedDataAsync();
                
                // 檢查庫存不足狀態
                await CheckInventoryShortageAsync();
                
                isDetailDataReady = true;
                StateHasChanged();
            }
            else
            {
                isDetailDataReady = true;
            }
            
            return salesOrder;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入訂單資料時發生錯誤：{ex.Message}");
            isDetailDataReady = true; // 錯誤也要允許渲染
            return null;
        }
    }

    /// <summary>
    /// 載入明細相關資料（出貨、排程、收款記錄）- 用於判斷是否有不可刪除的明細
    /// 必須在 DataLoader 中同步執行，確保狀態訊息正確顯示
    /// 訂單需要檢查三種下一步動作：
    /// 1. DeliveredQuantity > 0：已有出貨記錄
    /// 2. ScheduledQuantity > 0：已有生產排程
    /// 3. TotalReceivedAmount > 0：已有收款記錄
    /// </summary>
    private async Task LoadDetailRelatedDataAsync()
    {
        try
        {
            if (!salesOrderDetails.Any())
            {
                hasUndeletableDetails = false;
                return;
            }

            bool hasUndeletable = false;
            
            foreach (var detail in salesOrderDetails.Where(d => d.Id > 0))
            {
                //  使用 DetailLockHelper 檢查三種下一步動作
                // 檢查 1：出貨記錄 (DeliveredQuantity)
                // 檢查 2：排程記錄 (ScheduledQuantity)
                // 檢查 3：收款記錄 (TotalReceivedAmount)
                bool canDelete = DetailLockHelper.CanDeleteItem(
                    detail, 
                    out string reason, 
                    checkDelivery: true,    // 檢查 DeliveredQuantity
                    checkSchedule: true,    // 檢查 ScheduledQuantity
                    checkPayment: true);    // 檢查 TotalReceivedAmount
                
                if (!canDelete)
                {
                    hasUndeletable = true;
                    break;
                }
            }
            
            hasUndeletableDetails = hasUndeletable;
            
            if (hasUndeletableDetails)
            {
                UpdateFieldsReadOnlyState();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入明細相關資料時發生錯誤：{ex.Message}");
            hasUndeletableDetails = false;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // 並行載入所有資料
            var tasks = new List<Task>
            {
                Task.Run(async () => customers = await CustomerService.GetAllAsync()),
                Task.Run(async () => companies = await CompanyService.GetAllAsync()),
                Task.Run(async () => employees = (await EmployeeService.GetAllAsync()).Where(e => !e.IsSuperAdmin).ToList()),
                Task.Run(async () => products = await ProductService.GetAllAsync()),
                Task.Run(async () => units = await UnitService.GetAllAsync()),
                Task.Run(async () => warehouses = await WarehouseService.GetAllAsync()),
                Task.Run(async () => quotations = await QuotationService.GetAllAsync())
            };
            
            await Task.WhenAll(tasks);
            
            // 一次性載入系統稅率（避免每次計算都查詢資料庫）
            currentTaxRate = await TaxCalculationHelper.LoadTaxRateAsync(SystemParameterService);
            
            taxCalculationMethodOptions = TaxCalculationHelper.GetTaxMethodOptions();
            
            // 建立 AutoComplete 配置
            autoCompleteConfig = new AutoCompleteConfigBuilder<SalesOrder>()
                .AddField(nameof(SalesOrder.CustomerId), "CompanyName", customers)
                .AddField(nameof(SalesOrder.CompanyId), "CompanyName", companies)
                .AddField(nameof(SalesOrder.EmployeeId), "Name", employees)
                .AddField(nameof(SalesOrder.QuotationId), "Code", quotations)
                .AddField("FilterProductId", "Name", products)
                .Build();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入額外資料時發生錯誤：{ex.Message}");
            
            // 設定安全的預設值
            customers = new List<Customer>();
            companies = new List<Company>();
            employees = new List<Employee>();
            products = new List<Product>();
            units = new List<Unit>();
            warehouses = new List<Warehouse>();
            quotations = new List<Quotation>();
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SalesOrder.Code),
                    Label = "銷貨單號",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入銷貨單號",
                    IsRequired = true,
                    MaxLength = 30,
                    HelpText = "訂單的唯一編號，新增時系統會自動產生，也可手動修改",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.CustomerId),
                    Label = "客戶",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇客戶",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "輸入客戶名稱進行搜尋，或直接選擇",
                    ActionButtons = await GetCustomerActionButtonsAsync(),
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = "FilterProductId", // 篩選用的虛擬欄位
                    Label = "商品",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇商品",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "選擇特定商品進行篩選，或留空顯示所有商品"
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesOrder.QuotationId),
                    Label = "報價單",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇報價單",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "此訂單所參考的報價單單號（若有）",
                    IsReadOnly = hasUndeletableDetails,
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.CompanyId),
                    Label = "公司",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請選擇公司",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "選擇進行此次銷貨的公司",
                    ActionButtons = await GetCompanyActionButtonsAsync(),
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.EmployeeId),
                    Label = "業務員",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請選擇業務員",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "選擇負責此訂單的業務員",
                    ActionButtons = await GetEmployeeActionButtonsAsync(),
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.OrderDate),
                    Label = "訂單日期",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "訂單建立日期",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.TaxCalculationMethod),
                    Label = "稅別",
                    FieldType = FormFieldType.Select,
                    IsRequired = true,
                    Options = taxCalculationMethodOptions,
                    HelpText = "稅額計算方式：外加稅（稅額另加）、內含稅（價格已含稅）、不含稅（免稅）",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.ExpectedDeliveryDate),
                    Label = "預交日",
                    FieldType = FormFieldType.Date,
                    IsRequired = false,
                    HelpText = "預計出貨給客戶的日期",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },

                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesOrder.TotalAmount),
                    Label = "金額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "銷貨單的總金額，根據明細自動計算（明細的數量 × 單價總和）",
                    IsReadOnly = true, // 總金額欄位始終為唯讀
                    CssClass = "text-warning fw-bold" // 使用黃色粗體顯示
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesOrder.DiscountAmount),
                    Label = "折扣",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "銷貨單的折扣金額，根據明細自動計算 = (數量 × 單價 × 折扣%)",
                    IsReadOnly = true, // 折扣欄位始終為唯讀
                    CssClass = "text-danger fw-bold" // 使用紅色粗體顯示
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesOrder.SalesTaxAmount),
                    Label = "稅額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "銷貨單的稅額，根據金額和稅率自動計算 = (折扣後金額 × 稅率%)",
                    IsReadOnly = true, // 稅額欄位始終為唯讀
                    CssClass = "text-info fw-bold" // 使用藍色粗體顯示
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesOrder.TotalAmountWithTax),
                    Label = "總額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "銷貨單的含稅總金額，根據明細自動計算（金額 - 折扣 + 稅額）",
                    IsReadOnly = true, // 含稅總金額欄位始終為唯讀
                    CssClass = "text-success fw-bold" // 使用綠色粗體顯示
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.PaymentTerms),
                    Label = "付款條件",
                    FieldType = FormFieldType.TextArea,
                    Placeholder = "請輸入付款條件",
                    IsRequired = false,
                    MaxLength = 100,
                    HelpText = "與客戶約定的付款方式和期限",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.DeliveryTerms),
                    Label = "交貨條件",
                    FieldType = FormFieldType.TextArea,
                    Placeholder = "請輸入交貨條件",
                    IsRequired = false,
                    MaxLength = 100,
                    HelpText = "與客戶約定的交貨方式和條件",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },

                FormFieldConfigurationHelper.CreateRemarksField<SalesOrder>(
                    containerCssClass: "col-6",
                    readOnly: hasUndeletableDetails // 根據明細狀態決定是否鎖定
                ),
            };

            formSections = FormSectionHelper<SalesOrder>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    so => so.Code,
                    so => so.CustomerId)
                .AddCustomFields(FormSectionNames.BasicInfo, "FilterProductId")  // 用字串指定虛擬欄位
                .AddToSection(FormSectionNames.BasicInfo,
                    so => so.QuotationId,
                    so => so.CompanyId,
                    so => so.EmployeeId,
                    so => so.OrderDate,
                    so => so.ExpectedDeliveryDate)
                .AddToSection(FormSectionNames.AmountInfo,
                    so => so.TaxCalculationMethod,
                    so => so.TotalAmount,      // 金額（折扣前）
                    so => so.DiscountAmount,   // 折扣
                    so => so.SalesTaxAmount,   // 稅額
                    so => so.TotalAmountWithTax) // 總額
                .AddToSection(FormSectionNames.AdditionalInfo,
                    so => so.PaymentTerms,
                    so => so.DeliveryTerms,
                    so => so.Remarks)
                .Build();
        }
        catch (Exception ex)
        {
            _ = ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(InitializeFormFieldsAsync), GetType(), 
                additionalData: "訂單編輯Modal表單欄位初始化失敗");
            
            // 設定安全的預設值
            formFields = new List<FormFieldDefinition>();
            formSections = new Dictionary<string, string>();
        }
    }

    // ===== AutoComplete 配置方法 =====

    /// <summary>
    /// 配置自訂模組
    /// </summary>
    private List<GenericEditModalComponent<SalesOrder, ISalesOrderService>.CustomModule> GetCustomModules()
    {
        return CustomModuleHelper.CreateSingle(editModalComponent, CreateProductManagerContent());
    }

    /// <summary>
    /// 創建商品管理器內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateProductManagerContent() => __builder =>
    {
        <DetailSectionWrapper IsEntityReady="@(editModalComponent?.Entity != null)"
                              IsDetailDataReady="@isDetailDataReady"
                              IsDataAvailable="@(products != null && products.Any() && units != null && units.Any())"
                              DataUnavailableMessage="無可用的商品或單位資料，請聯繫系統管理員"
                              IsPreconditionMet="@(editModalComponent?.Entity?.CustomerId > 0)"
                              PreconditionMessage="請先選擇客戶後再進行銷售明細管理">
            <SalesOrderTable @ref="salesOrderDetailManager"
                             TMainEntity="SalesOrder"
                             TDetailEntity="SalesOrderDetail"
                             MainEntity="@editModalComponent.Entity"
                             ExistingDetails="@salesOrderDetails"
                             DataVersion="@_detailsDataVersion"
                             IsParentLoading="@(editModalComponent?.IsLoading ?? false)"
                             Products="@products"
                             Warehouses="@warehouses"
                             SelectedCustomerId="@(editModalComponent?.Entity?.CustomerId ?? 0)"
                             SelectedCustomerName="@GetSelectedCustomerName()"
                             SelectedQuotationId="@(editModalComponent?.Entity?.QuotationId ?? 0)"
                             SelectedQuotationCode="@GetSelectedQuotationCode()"
                             FilterProductId="@filterProductId"
                             FilterProductName="@GetFilterProductName()"
                             TaxCalculationMethod="@(editModalComponent?.Entity?.TaxCalculationMethod ?? TaxCalculationMethod.TaxExclusive)"
                             IsReadOnly="false"
                             MainEntityIdPropertyName="SalesOrderId"
                             QuantityPropertyName="OrderQuantity"
                             UnitPricePropertyName="UnitPrice"
                             DiscountPercentagePropertyName="DiscountPercentage"
                             UnitIdPropertyName="UnitId"
                             WarehouseIdPropertyName="WarehouseId"
                             RemarksPropertyName="Remarks"
                             SourceQuotationId="@PrefilledQuotationId"
                             OnDetailsChanged="@HandleDetailsChanged"
                             OnHasUndeletableDetailsChanged="@HandleHasUndeletableDetailsChanged"
                             OnOpenRelatedDocument="@HandleOpenRelatedDocument"
                             ItemDisplayName="銷售商品"
                             EmptyMessage="尚未新增銷售商品" />
        </DetailSectionWrapper>
    };
    
    // ===== ActionButton 產生方法 =====
    
    /// <summary>
    /// 產生客戶操作按鈕 - 使用統一 Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetCustomerActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent,
            customerModalManager,
            nameof(SalesOrder.CustomerId)
        );
    }
    
    /// <summary>
    /// 產生公司操作按鈕 - 使用統一 Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetCompanyActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent,
            companyModalManager,
            nameof(SalesOrder.CompanyId)
        );
    }
    
    /// <summary>
    /// 產生業務員操作按鈕 - 使用統一 Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetEmployeeActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent,
            employeeModalManager,
            nameof(SalesOrder.EmployeeId)
        );
    }
    
    // ===== Modal 事件包裝器方法 =====
    
    /// <summary>
    /// 處理開啟相關單據的事件
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            if (args.type == RelatedDocumentType.ReturnDocument)
            {
                // 開啟銷貨退回單
                selectedSalesReturnId = args.id;
                showSalesReturnModal = true;
                StateHasChanged();
            }
            else if (args.type == RelatedDocumentType.SetoffDocument)
            {
                // 開啟沖款單
                selectedSetoffDocumentId = args.id;
                showSetoffDocumentModal = true;
                StateHasChanged();
            }
            else if (args.type == RelatedDocumentType.DeliveryDocument)
            {
                // 開啟銷貨出貨單
                selectedSalesDeliveryId = args.id;
                showSalesDeliveryModal = true;
                StateHasChanged();
            }
            else if (args.type == RelatedDocumentType.ProductionSchedule)
            {
                // 開啟生產排程
                selectedProductionScheduleId = args.id;
                showProductionScheduleModal = true;
                StateHasChanged();
            }
            else
            {
                await NotificationService.ShowWarningAsync("不支援的單據類型", "提示");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"開啟單據失敗：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 處理沖款單儲存後的事件
    /// </summary>
    private async Task HandleSetoffDocumentSaved(SetoffDocument savedDocument)
    {
        try
        {
            showSetoffDocumentModal = false;
            await NotificationService.ShowSuccessAsync("沖款單已更新");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理沖款單儲存事件失敗：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 處理欄位值變更事件 - 使用統一 Helper
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // 使用統一 Helper 處理客戶欄位變更
            if (fieldChange.PropertyName == nameof(SalesOrder.CustomerId))
            {
                //  關鍵：只有在沒有不可刪除明細時才更新 ActionButtons
                if (!hasUndeletableDetails)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        customerModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                }
                
                // 客戶變更時，觸發商品管理器重新渲染
                StateHasChanged();
            }
            // 處理公司欄位變更
            else if (fieldChange.PropertyName == nameof(SalesOrder.CompanyId))
            {
                //  關鍵：只有在沒有不可刪除明細時才更新 ActionButtons
                if (!hasUndeletableDetails)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        companyModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                }
            }
            // 處理業務員欄位變更
            else if (fieldChange.PropertyName == nameof(SalesOrder.EmployeeId))
            {
                //  關鍵：只有在沒有不可刪除明細時才更新 ActionButtons
                if (!hasUndeletableDetails)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        employeeModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                }
            }
            // 處理商品篩選變更
            else if (fieldChange.PropertyName == "FilterProductId")
            {
                // 更新商品篩選狀態 - 處理 int 或 string 類型
                int? parsedProductId = null;
                
                if (fieldChange.Value is int intValue && intValue > 0)
                {
                    parsedProductId = intValue;
                }
                else if (fieldChange.Value is string strValue && int.TryParse(strValue, out int parsedInt) && parsedInt > 0)
                {
                    parsedProductId = parsedInt;
                }
                
                filterProductId = parsedProductId;
                StateHasChanged();
            }
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("欄位變更處理時發生錯誤");
        }
    }

    // ===== 銷貨明細管理方法 =====
    
    private Task HandleEntityLoaded(int loadedEntityId)
    {
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    /// <summary>
    /// 載入訂單明細
    /// </summary>
    private async Task LoadSalesOrderDetails(int salesOrderId)
    {
        try
        {
            // 從現有的訂單取得明細
            var salesOrder = await SalesOrderService.GetWithDetailsAsync(salesOrderId);
            if (salesOrder?.SalesOrderDetails != null)
            {
                salesOrderDetails = salesOrder.SalesOrderDetails.ToList();
            }
            else
            {
                salesOrderDetails = new List<SalesOrderDetail>();
            }
            
            _detailsDataVersion++;
            await LoadDetailRelatedDataAsync();
            
            // 檢查庫存不足狀態
            await CheckInventoryShortageAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSalesOrderDetails), GetType(), 
                additionalData: $"載入訂單明細失敗 - OrderId: {salesOrderId}");
            salesOrderDetails = new List<SalesOrderDetail>();
        }
    }

    /// <summary>
    /// 處理銷貨明細變更
    /// </summary>
    private async Task HandleDetailsChanged(List<SalesOrderDetail> details)
    {
        try
        {
            salesOrderDetails = details ?? new List<SalesOrderDetail>();

            if (editModalComponent?.Entity != null)
            {
                var (net, tax, gross, discount) = TaxCalculationHelper.CalculateFromDetailsWithDiscount(
                    salesOrderDetails,
                    editModalComponent.Entity.TaxCalculationMethod,
                    currentTaxRate,
                    d => d.SubtotalAmount,
                    d => d.TaxRate,
                    d => d.OrderQuantity * d.UnitPrice);

                editModalComponent.Entity.TotalAmount = net;
                editModalComponent.Entity.SalesTaxAmount = tax;
                editModalComponent.Entity.DiscountAmount = discount;

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDetailsChanged), GetType(),
                additionalData: "處理銷貨明細變更失敗");
        }
    }

    /// <summary>
    /// 處理有不可刪除明細的狀態變更
    /// 當明細動態變化時（新增出貨、排程、收款記錄等），這個方法會被調用
    /// </summary>
    private async Task HandleHasUndeletableDetailsChanged(bool hasUndeletable)
    {
        try
        {
            if (hasUndeletableDetails != hasUndeletable)
            {
                hasUndeletableDetails = hasUndeletable;
                
                // 更新欄位的唯讀狀態
                UpdateFieldsReadOnlyState();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理明細鎖定狀態時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 更新欄位的唯讀狀態 - 根據明細轉單狀態
    /// 使用 FormFieldLockHelper 統一處理欄位鎖定邏輯
    /// </summary>
    private async void UpdateFieldsReadOnlyState()
    {
        // 使用 FormFieldLockHelper 一次處理所有欄位（含 ActionButtons）
        FormFieldLockHelper.LockMultipleFields(
            formFields,
            new[]
            {
                nameof(SalesOrder.Code),
                nameof(SalesOrder.CustomerId),
                nameof(SalesOrder.QuotationId),
                nameof(SalesOrder.CompanyId),
                nameof(SalesOrder.EmployeeId),
                nameof(SalesOrder.OrderDate),
                nameof(SalesOrder.TaxCalculationMethod),
                nameof(SalesOrder.ExpectedDeliveryDate),
                nameof(SalesOrder.PaymentTerms),
                nameof(SalesOrder.DeliveryTerms),
                nameof(BaseEntity.Remarks)
            },
            isLocked: hasUndeletableDetails,
            actionButtonsMap: new Dictionary<string, Func<Task<List<FieldActionButton>>>>
            {
                { nameof(SalesOrder.CustomerId), GetCustomerActionButtonsAsync },
                { nameof(SalesOrder.CompanyId), GetCompanyActionButtonsAsync },
                { nameof(SalesOrder.EmployeeId), GetEmployeeActionButtonsAsync }
            }
        );

        await InvokeAsync(() => StateHasChanged());
    }

    /// <summary>
    /// 取得狀態訊息（頂部徽章）
    /// 當有不可刪除的明細時，顯示鎖定提示
    /// </summary>
    private async Task<(string Message, GenericEditModalComponent<SalesOrder, ISalesOrderService>.BadgeVariant Variant, string IconClass)?> 
        GetStatusMessage()
    {
        try
        {
            // 如果資料還沒準備好，不顯示訊息
            if (!isDetailDataReady || editModalComponent?.Entity == null)
                return null;
            
            // 只有在有不可刪除的明細時才顯示鎖定訊息
            if (hasUndeletableDetails)
            {
                return (
                    "部分明細有出貨/排程/收款記錄，主檔欄位已鎖定",
                    GenericEditModalComponent<SalesOrder, ISalesOrderService>.BadgeVariant.Warning,
                    "bi bi-lock"
                );
            }
            
            // 正常狀態不顯示訊息
            return null;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"取得狀態訊息時發生錯誤：{ex.Message}");
            return null;
        }
    }

    /// <summary>
    /// 取得警告訊息（顯示在表單欄位上方）- 作為屬性以確保正確的渲染時機
    /// 當有不可刪除的明細時，顯示鎖定警告訊息
    /// </summary>
    private RenderFragment? GetWarningMessage() => __builder =>
    {
        // 只在資料準備就緒後才顯示訊息
        if (!isDetailDataReady)
            return;

        // 明細已轉單的警告訊息
        <GenericLockedFieldMessage IsVisible="@hasUndeletableDetails"
                                  Message="@EditModalMessages.UndeletableDetailsWarning" />
    };

    private string GetSelectedCustomerName()
        => EntityDisplayHelper.GetDisplayValue(editModalComponent?.Entity?.CustomerId, customers, c => c.CompanyName) ?? string.Empty;

    private string GetSelectedQuotationCode()
        => EntityDisplayHelper.GetDisplayValue(editModalComponent?.Entity?.QuotationId, quotations, q => q.Code) ?? string.Empty;

    private string GetFilterProductName()
        => EntityDisplayHelper.GetDisplayValue(filterProductId, products, p => p.Name) ?? string.Empty;

    /// <summary>
    /// 取得自訂操作按鈕（顯示在 Modal 頂部左側）
    /// </summary>
    private RenderFragment? GetCustomActionButtons() => __builder =>
    {
        @* 轉銷貨出貨單按鈕 - 新增模式需先儲存，編輯模式直接可用 *@
        @if (editModalComponent?.Entity != null && 
            SalesOrderId.HasValue)
        {
            
            <GenericButtonComponent Text="轉銷貨" 
                                  Variant="ButtonVariant.Green" 
                                  OnClick="HandleCreateDeliveryFromOrder" />
            
            @* 批次排程管理按鈕 *@
            <GenericButtonComponent Text="排程管理" 
                                  Variant="ButtonVariant.Yellow"
                                  OnClick="HandleBatchTransferToSchedule" />

            @* 庫存檢視按鈕 - 有不足時顯示警告樣式 *@
            @if (isInventoryCheckLoading)
            {
                <GenericButtonComponent Text="檢查中..." 
                                      Variant="ButtonVariant.Gray" 
                                      Icon="bi bi-hourglass-split"
                                      IsDisabled="true" />
            }
            else if (hasInventoryShortage)
            {
                <GenericButtonComponent Text="⚠️ 查庫存" 
                                      Variant="ButtonVariant.Yellow" 
                                      Icon="bi bi-exclamation-triangle-fill"
                                      OnClick="HandleShowInventoryCheck" />
            }
            else
            {
                <GenericButtonComponent Text="查庫存" 
                                      Variant="ButtonVariant.Blue" 
                                      Icon="bi bi-box-seam"
                                      OnClick="HandleShowInventoryCheck" />
            }
        }
    };

    /// <summary>
    /// 從訂單轉銷貨出貨單 - 簡化版本，所有業務驗證交給銷貨出貨單 Modal 處理
    /// </summary>
    private async Task HandleCreateDeliveryFromOrder()
    {
        try
        {
            // 檢查：確保訂單已儲存
            if (!SalesOrderId.HasValue)
            {
                await NotificationService.ShowWarningAsync("請先儲存訂單後，才能轉銷貨出貨單");
                return;
            }
            
            // 安全檢查：確保 Entity 已載入
            if (editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("訂單資料載入失敗，請重新整理頁面");
                return;
            }
            
            // 檢查是否有客戶資料
            if (editModalComponent.Entity.CustomerId <= 0)
            {
                await NotificationService.ShowWarningAsync("訂單缺少客戶資訊，無法轉銷貨出貨單");
                return;
            }
            
            // 檢查是否有明細資料
            if (!salesOrderDetails.Any())
            {
                await NotificationService.ShowWarningAsync("訂單沒有明細資料，無法轉銷貨出貨單");
                return;
            }
            
            // 檢查是否所有明細都已完成出貨（已出貨數量 >= 訂購數量）
            var hasIncompleteDetails = salesOrderDetails.Any(detail => 
                detail.DeliveredQuantity < detail.OrderQuantity
            );
            
            if (!hasIncompleteDetails)
            {
                await NotificationService.ShowWarningAsync("訂單所有明細皆已完成出貨，無需再轉單");
                return;
            }
            
            // 直接開啟銷貨出貨單 Modal，使用 Entity.Id 作為訂單 ID（最可靠的來源）
            await salesDeliveryEditModal!.ShowAddModalWithPrefilledOrder(
                editModalComponent.Entity.CustomerId,
                editModalComponent.Entity.Id  // 使用 Entity.Id 而非 SalesOrderId 參數
            );
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCreateDeliveryFromOrder), GetType(), 
                additionalData: $"轉銷貨出貨單失敗 - OrderId: {editModalComponent?.Entity?.Id}");
            await NotificationService.ShowErrorAsync($"轉銷貨出貨單時發生錯誤: {ex.Message}");
        }
    }

    /// <summary>
    /// 處理銷貨出貨單儲存後的事件
    /// 使用 ChildDocumentRefreshHelper 統一處理刷新邏輯
    /// </summary>
    private async Task HandleSalesDeliverySaved(SalesDelivery savedDelivery)
    {
        try
        {
            await ChildDocumentRefreshHelper.HandleChildDocumentSavedAsync(
                closeModal: () =>
                {
                    showSalesDeliveryModal = false;
                    selectedSalesDeliveryId = null;
                },
                reloadDetails: async () =>
                {
                    if (SalesOrderId.HasValue)
                    {
                        await LoadSalesOrderDetails(SalesOrderId.Value);
                        
                        // 重新計算總金額和稅額
                        if (editModalComponent?.Entity != null)
                        {
                            await HandleDetailsChanged(salesOrderDetails);
                        }
                    }
                },
                detailManager: salesOrderDetailManager,
                notificationMessage: null,
                stateHasChanged: StateHasChanged,
                invokeAsync: InvokeAsync,
                additionalActions: null
            );
            
            await NotificationService.ShowSuccessAsync($"銷貨出貨單 {savedDelivery.Code} 已更新，訂單明細已刷新");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSalesDeliverySaved), GetType(), 
                additionalData: $"處理銷貨出貨單儲存事件失敗 - DeliveryId: {savedDelivery?.Id}");
        }
    }

    /// <summary>
    /// 處理銷售退貨單儲存後的事件
    /// </summary>
    private async Task HandleSalesReturnSaved(SalesReturn savedReturn)
    {
        try
        {
            await ChildDocumentRefreshHelper.HandleChildDocumentSavedAsync(
                closeModal: () =>
                {
                    showSalesReturnModal = false;
                    selectedSalesReturnId = null;
                },
                reloadDetails: async () =>
                {
                    if (SalesOrderId.HasValue)
                    {
                        await LoadSalesOrderDetails(SalesOrderId.Value);
                        
                        // 重新計算總金額和稅額
                        if (editModalComponent?.Entity != null)
                        {
                            await HandleDetailsChanged(salesOrderDetails);
                        }
                    }
                },
                detailManager: salesOrderDetailManager,
                notificationMessage: null,
                stateHasChanged: StateHasChanged,
                invokeAsync: InvokeAsync,
                additionalActions: async () =>
                {
                    //  關鍵修復：呼叫 Table 組件的公開刷新方法
                    // 重新載入退貨數量資訊
                    if (salesOrderDetailManager != null)
                    {
                        await salesOrderDetailManager.LoadReturnedQuantitiesAsync();
                    }
                }
            );
            
            await NotificationService.ShowSuccessAsync($"銷售退貨單 {savedReturn.Code} 已更新，訂單明細已刷新");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSalesReturnSaved), GetType(), 
                additionalData: $"處理銷售退貨單儲存事件失敗 - ReturnId: {savedReturn?.Id}");
        }
    }

    /// <summary>
    /// 排程管理 - 直接開啟生產排程編輯 Modal
    /// </summary>
    private async Task HandleBatchTransferToSchedule()
    {
        try
        {
            // 驗證訂單資料
            if (!SalesOrderId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("無法排程管理：訂單資料不存在");
                return;
            }
            
            // 直接開啟生產排程編輯 Modal（新增模式）
            selectedProductionScheduleId = null;
            showProductionScheduleModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleBatchTransferToSchedule), GetType(), 
                additionalData: $"開啟生產排程 Modal 失敗 - OrderId: {SalesOrderId}");
        }
    }
    
    /// <summary>
    /// 檢查訂單是否有庫存不足的狀況
    /// 只檢查第一層主要明細，不包含子材料
    /// </summary>
    private async Task CheckInventoryShortageAsync()
    {
        try
        {
            // 新增模式或沒有明細時不檢查
            if (!SalesOrderId.HasValue || !salesOrderDetails.Any())
            {
                hasInventoryShortage = false;
                return;
            }
            
            isInventoryCheckLoading = true;
            StateHasChanged();
            
            // 呼叫 API 取得庫存檢查結果
            var checkResult = await SalesOrderService.GetOrderInventoryCheckAsync(SalesOrderId.Value);
            
            if (checkResult != null)
            {
                // 只計算第一層主要明細（非子材料）的不足數量
                var mainItems = checkResult.Items.Where(x => x.Level == 1 || x.ParentDetailId == null).ToList();
                var insufficientCount = mainItems.Count(x => x.Status == InventoryStatus.Insufficient);
                
                hasInventoryShortage = insufficientCount > 0;
            }
            else
            {
                hasInventoryShortage = false;
            }
        }
        catch (Exception ex)
        {
            // 檢查失敗不影響主流程，預設為沒有不足
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(CheckInventoryShortageAsync), GetType(),
                additionalData: $"檢查庫存不足狀態失敗 - OrderId: {SalesOrderId}");
            hasInventoryShortage = false;
        }
        finally
        {
            isInventoryCheckLoading = false;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// 顯示訂單庫存檢視
    /// </summary>
    private async Task HandleShowInventoryCheck()
    {
        try
        {
            // 驗證訂單資料
            if (!SalesOrderId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("無法檢視庫存：訂單資料不存在");
                return;
            }
            
            // 開啟庫存檢視 Modal
            showInventoryCheckModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleShowInventoryCheck), GetType(), 
                additionalData: $"開啟庫存檢視 Modal 失敗 - OrderId: {SalesOrderId}");
        }
    }
    
    /// <summary>
    /// 處理生產排程 Modal 可見性變更事件
    /// 當 Modal 關閉時刷新明細資料（處理刪除排程後的回寫）
    /// </summary>
    private async Task HandleProductionScheduleModalVisibleChanged(bool visible)
    {
        var wasVisible = showProductionScheduleModal;
        showProductionScheduleModal = visible;
        
        // 如果是從顯示變成隱藏（Modal 關閉），刷新明細資料
        if (wasVisible && !visible && SalesOrderId.HasValue)
        {
            try
            {
                // 重新載入訂單明細（刷新已排程數量）
                await LoadSalesOrderDetails(SalesOrderId.Value);
                
                // 刷新 Table 元件
                if (salesOrderDetailManager != null)
                {
                    await salesOrderDetailManager.RefreshDetailsAsync();
                }
                
                StateHasChanged();
            }
            catch (Exception ex)
            {
                await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleProductionScheduleModalVisibleChanged), GetType(), 
                    additionalData: $"刷新明細資料失敗 - OrderId: {SalesOrderId}");
            }
        }
    }
    
    /// <summary>
    /// 處理生產排程 Modal 關閉事件（取消或刪除後）
    /// </summary>
    private async Task HandleProductionScheduleModalClosed()
    {
        showProductionScheduleModal = false;
        selectedProductionScheduleId = null;
        
        // 刷新明細資料（處理刪除排程後的回寫）
        if (SalesOrderId.HasValue)
        {
            try
            {
                await LoadSalesOrderDetails(SalesOrderId.Value);
                
                if (salesOrderDetailManager != null)
                {
                    await salesOrderDetailManager.RefreshDetailsAsync();
                }
                
                StateHasChanged();
            }
            catch (Exception ex)
            {
                await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleProductionScheduleModalClosed), GetType(), 
                    additionalData: $"刷新明細資料失敗 - OrderId: {SalesOrderId}");
            }
        }
    }
    
    /// <summary>
    /// 處理排程儲存成功事件
    /// </summary>
    private async Task HandleScheduleCreated(ProductionSchedule schedule)
    {
        try
        {
            // 關閉 Modal
            showProductionScheduleModal = false;
            selectedProductionScheduleId = null;
            
            // 重新載入訂單明細（刷新已排程數量）
            if (SalesOrderId.HasValue)
            {
                await LoadSalesOrderDetails(SalesOrderId.Value);
            }
            
            await NotificationService.ShowSuccessAsync($"排程儲存成功：{schedule.Code}");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleScheduleCreated), GetType(), 
                additionalData: $"處理排程儲存事件失敗 - ScheduleId: {schedule?.Id}");
        }
    }

    /// <summary>
    /// 儲存邏輯 - 同時儲存主檔和明細
    /// </summary>
    private async Task<bool> SaveSalesOrderWithDetails(SalesOrder salesOrder)
    {
        try
        {
            if (salesOrder == null)
            {
                await NotificationService.ShowErrorAsync("沒有要儲存的訂單資料");
                return false;
            }

            // 1. 先進行明細驗證 (檢查單價是否為0)
            if (salesOrderDetailManager != null)
            {
                var isValid = await salesOrderDetailManager.ValidateAsync();
                if (!isValid)
                {
                    // ValidateAsync 內部已顯示錯誤訊息，直接返回
                    return false;
                }
            }
            else
            {
                // 如果沒有管理器引用，進行基本檢查
                var invalidPriceDetails = salesOrderDetails
                    .Where(d => d.ProductId > 0 && d.UnitPrice < 0)
                    .ToList();
                
                if (invalidPriceDetails.Any())
                {
                    await NotificationService.ShowErrorAsync("所有商品的單價不可為負數，請檢查並修正");
                    return false;
                }
            }

            var isEditMode = SalesOrderId.HasValue;
            List<SalesOrderDetail> originalDetails = new();
            
            // 在編輯模式下，先取得原始明細資料
            if (isEditMode)
            {
                originalDetails = await SalesOrderDetailService.GetBySalesOrderIdAsync(SalesOrderId!.Value);
            }

            // 儲存主檔
            ServiceResult<SalesOrder> result;
            if (isEditMode)
            {
                result = await SalesOrderService.UpdateAsync(salesOrder);
            }
            else
            {
                result = await SalesOrderService.CreateAsync(salesOrder);
            }

            if (!result.IsSuccess || result.Data == null)
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "儲存訂單失敗");
                return false;
            }

            // 儲存明細
            await SaveSalesOrderDetails(result.Data.Id, isEditMode, isEditMode ? originalDetails : new List<SalesOrderDetail>());
            
            await SaveSalesOrderCompositionDetails(result.Data.Id);

            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveSalesOrderWithDetails), GetType(), 
                additionalData: "儲存訂單和明細失敗");
            await NotificationService.ShowErrorAsync($"儲存時發生錯誤：{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// 儲存訂單明細（支援新增和編輯模式）
    /// </summary>
    /// <param name="salesOrderId">訂單ID</param>
    /// <param name="isEditMode">是否為編輯模式</param>
    /// <param name="originalDetails">原始明細列表（編輯模式使用）</param>
    private async Task SaveSalesOrderDetails(int salesOrderId, bool isEditMode = false, List<SalesOrderDetail>? originalDetails = null)
    {
        try
        {
            // 只處理有效的明細（已選擇商品的）
            var validDetails = salesOrderDetails.Where(d => d.ProductId > 0).ToList();

            // 設定主檔ID和時間戳記
            foreach (var detail in validDetails)
            {
                detail.SalesOrderId = salesOrderId;
                if (detail.Id == 0)
                {
                    detail.Status = EntityStatus.Active;
                    detail.CreatedAt = DateTime.Now;
                }
                else
                {
                    detail.UpdatedAt = DateTime.Now;
                }

            }

            // 先獲取現有的明細（如果未提供）
            var existingDetails = originalDetails ?? (await SalesOrderService.GetWithDetailsAsync(salesOrderId))?.SalesOrderDetails?.ToList() ?? new List<SalesOrderDetail>();
            
            // 處理新增和更新的明細
            foreach (var detail in validDetails)
            {
                if (detail.Id == 0)
                {
                    // 新增明細
                    var createResult = await SalesOrderDetailService.CreateAsync(detail);
                    if (createResult.IsSuccess && createResult.Data != null)
                    {
                        // 更新本地明細的 ID
                        detail.Id = createResult.Data.Id;
                        
                        //  更新報價單明細的已轉銷貨數量
                        if (detail.QuotationDetailId.HasValue)
                        {
                            await UpdateQuotationDetailConvertedQuantity(
                                detail.QuotationDetailId.Value, 
                                detail.OrderQuantity, 
                                isAdding: true
                            );
                        }
                    }
                }
                else
                {
                    // 更新明細 - 需要檢查數量變化
                    var originalDetail = existingDetails.FirstOrDefault(e => e.Id == detail.Id);
                    var quantityDiff = detail.OrderQuantity - (originalDetail?.OrderQuantity ?? 0);
                    
                    await SalesOrderDetailService.UpdateAsync(detail);
                    
                    //  如果數量有變化且有報價單來源，更新報價單明細的已轉銷貨數量
                    if (quantityDiff != 0 && detail.QuotationDetailId.HasValue)
                    {
                        await UpdateQuotationDetailConvertedQuantity(
                            detail.QuotationDetailId.Value,
                            Math.Abs(quantityDiff),
                            isAdding: quantityDiff > 0
                        );
                    }
                }
            }

            // 處理刪除的明細（現有的但不在當前有效列表中的）
            var currentDetailIds = validDetails.Where(d => d.Id > 0).Select(d => d.Id).ToList();
            var detailsToDelete = existingDetails.Where(e => !currentDetailIds.Contains(e.Id)).ToList();
            

            foreach (var detailToDelete in detailsToDelete)
            {
                //  如果有報價單來源，減少報價單明細的已轉銷貨數量
                if (detailToDelete.QuotationDetailId.HasValue)
                {
                    await UpdateQuotationDetailConvertedQuantity(
                        detailToDelete.QuotationDetailId.Value,
                        detailToDelete.OrderQuantity,
                        isAdding: false
                    );
                }
                
                await SalesOrderDetailService.PermanentDeleteAsync(detailToDelete.Id);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveSalesOrderDetails), GetType(), 
                additionalData: $"儲存訂單明細失敗 - OrderId: {salesOrderId}");
            throw; // 重新拋出例外，讓上層處理
        }
    }

    /// <summary>
    /// 更新報價單明細的已轉銷貨數量
    /// </summary>
    private async Task UpdateQuotationDetailConvertedQuantity(int quotationDetailId, decimal quantity, bool isAdding)
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var quotationDetail = await context.QuotationDetails.FindAsync(quotationDetailId);
            
            if (quotationDetail != null)
            {
                if (isAdding)
                {
                    quotationDetail.ConvertedQuantity += quantity;
                }
                else
                {
                    quotationDetail.ConvertedQuantity -= quantity;
                    // 確保不會變成負數
                    if (quotationDetail.ConvertedQuantity < 0)
                        quotationDetail.ConvertedQuantity = 0;
                }
                
                quotationDetail.UpdatedAt = DateTime.Now;
                await context.SaveChangesAsync();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(UpdateQuotationDetailConvertedQuantity), GetType(),
                additionalData: new { QuotationDetailId = quotationDetailId, Quantity = quantity, IsAdding = isAdding });
            // 不拋出異常，避免影響主流程
        }
    }

    /// <summary>
    /// 儲存訂單組合明細（BOM）- 處理臨時索引（負數）映射到實際儲存後的明細ID
    /// </summary>
    private async Task SaveSalesOrderCompositionDetails(int salesOrderId)
    {
        try
        {
            // 從 SalesOrderTable 組件取得組合明細資料
            if (salesOrderDetailManager == null)
            {
                return;
            }
            
            var compositionDetailsMap = salesOrderDetailManager.GetCompositionDetails();
            
            if (!compositionDetailsMap.Any())
            {
                return; // 沒有自訂 BOM，不需要儲存
            }
            
            // ✅ 簡化邏輯：直接使用 salesOrderDetails（SaveSalesOrderDetails 已更新所有 ID）
            // 不需要重新查詢資料庫
            foreach (var kvp in compositionDetailsMap)
            {
                var salesOrderDetailId = kvp.Key;
                var compositionDetails = kvp.Value;
                
                int actualDetailId = 0;
                
                if (salesOrderDetailId > 0)
                {
                    // 已存在的明細，直接使用該 ID
                    actualDetailId = salesOrderDetailId;
                }
                else
                {
                    // 🔑 臨時索引（負數），直接對應到 SalesItems 索引
                    // -(i+1) 的反向計算：從 -1 推回索引 0，從 -2 推回索引 1
                    int salesItemIndex = Math.Abs(salesOrderDetailId) - 1;
                    
                    if (salesItemIndex >= 0 && salesItemIndex < salesOrderDetailManager.SalesItems.Count)
                    {
                        var salesItem = salesOrderDetailManager.SalesItems[salesItemIndex];
                        
                        // 🔑 關鍵修正：找到新增的明細（沒有 ExistingDetailEntity 的）
                        // 因為可能有多筆相同 ProductId，需要按順序匹配
                        var newDetails = salesOrderDetails
                            .Where(d => d.ProductId == salesItem.SelectedProduct?.Id)
                            .OrderBy(d => d.Id)
                            .ToList();
                        
                        // 找出這是第幾個新增的該商品明細
                        int newItemSequence = 0;
                        for (int idx = 0; idx <= salesItemIndex; idx++)
                        {
                            var checkItem = salesOrderDetailManager.SalesItems[idx];
                            if (checkItem.SelectedProduct?.Id == salesItem.SelectedProduct?.Id && 
                                checkItem.ExistingDetailEntity == null)
                            {
                                if (idx == salesItemIndex)
                                    break;
                                newItemSequence++;
                            }
                        }
                        
                        // 排除已存在的明細，取第 n 個新增的
                        var existingCount = salesOrderDetailManager.SalesItems
                            .Count(x => x.SelectedProduct?.Id == salesItem.SelectedProduct?.Id && 
                                       x.ExistingDetailEntity != null);
                        
                        if (newItemSequence + existingCount < newDetails.Count)
                        {
                            var matchedDetail = newDetails[newItemSequence + existingCount];
                            actualDetailId = matchedDetail.Id;
                        }
                        else
                        {
                            continue;
                        }
                    }
                    else
                    {
                        continue;
                    }
                }
                
                if (actualDetailId <= 0)
                {
                    continue;
                }
                
                // 批次儲存組合明細（使用實際的明細ID）
                await SalesOrderCompositionDetailService.SaveBatchAsync(
                    actualDetailId,
                    compositionDetails
                );
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveSalesOrderCompositionDetails), GetType(),
                additionalData: $"儲存訂單 BOM 組成失敗 - OrderId: {salesOrderId}");
            // 不拋出異常，避免影響主流程，但記錄錯誤
            await NotificationService.ShowWarningAsync($"BOM 組成儲存時發生錯誤：{ex.Message}");
        }
    }

    // ===== 從報價單轉單相關方法 =====
    
    /// <summary>
    /// 打開新增訂單 Modal 並預填報價單資料（公開方法，供父組件呼叫）
    /// </summary>
    public async Task ShowAddModalWithPrefilledQuotation(int customerId, int companyId, int? employeeId, int quotationId)
    {
        try
        {
            // 使用 DocumentConversionHelper 處理轉單邏輯（自訂載入邏輯版本）
            var success = await DocumentConversionHelper.ShowConversionModalWithCustomLoadAsync(
                resetEntityId: () => SalesOrderId = null,
                setPrefilledValues: () =>
                {
                    PrefilledCustomerId = customerId;
                    PrefilledQuotationId = quotationId;
                },
                isVisibleChanged: IsVisibleChanged,
                customLoadAction: async () =>
                {
                    await LoadQuotationDetailsToSalesOrder(quotationId);
                },
                detailManagerReady: () => salesOrderDetailManager != null,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("轉單流程執行失敗");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledQuotation), GetType(), 
                additionalData: $"開啟預填訂單Modal失敗 - CustomerId: {customerId}, QuotationId: {quotationId}");
            await NotificationService.ShowErrorAsync("開啟訂單時發生錯誤");
        }
    }
    
    /// <summary>
    /// 從報價單載入明細到訂單明細表
    /// </summary>
    private async Task LoadQuotationDetailsToSalesOrder(int quotationId)
    {
        try
        {
            // 載入報價單資料（含明細和審核狀態）
            var quotation = await QuotationService.GetWithDetailsAsync(quotationId);
            if (quotation == null)
            {
                await NotificationService.ShowWarningAsync("找不到指定的報價單", "載入失敗");
                return;
            }
            
            // 驗證報價單明細
            if (quotation.QuotationDetails == null || !quotation.QuotationDetails.Any())
            {
                await NotificationService.ShowWarningAsync("報價單沒有明細資料", "載入失敗");
                return;
            }
            
            // 使用 SalesOrderTable 的公開方法載入明細
            if (salesOrderDetailManager != null)
            {
                await salesOrderDetailManager.LoadQuotationDetails(
                    quotation.QuotationDetails.ToList(), 
                    quotationId, 
                    quotation.IsApproved
                );
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadQuotationDetailsToSalesOrder), GetType(),
                additionalData: new { QuotationId = quotationId });
            await NotificationService.ShowErrorAsync("載入報價單明細時發生錯誤");
        }
    }
    
    /// <summary>
    /// 從報價單載入資料到訂單
    /// 注意：實際的轉單邏輯由 QuotationEditModalComponent 在儲存時處理
    /// 這裡只是預留參數，實際使用 PrefilledCustomerId
    /// </summary>
    private async Task LoadDataFromQuotation(SalesOrder salesOrder, int quotationId)
    {
        try
        {
            // 載入報價單資料（含明細和審核狀態）
            var quotation = await QuotationService.GetWithDetailsAsync(quotationId);
            if (quotation == null)
            {
                await NotificationService.ShowWarningAsync("找不到指定的報價單", "載入失敗");
                return;
            }
            
            // 設定報價單ID（重要：這樣報價單欄位才會正確顯示）
            salesOrder.QuotationId = quotationId;
            
            // 設定客戶ID
            salesOrder.CustomerId = quotation.CustomerId;
            
            // 設定公司ID
            salesOrder.CompanyId = quotation.CompanyId;
            
            // 設定業務員ID
            salesOrder.EmployeeId = quotation.EmployeeId;
            
            // 設定稅別
            salesOrder.TaxCalculationMethod = quotation.TaxCalculationMethod;
            
            // 注意：明細的載入將由父組件（QuotationEditModalComponent）的 HandleCreateSalesOrderFromQuotation 處理
            // 這裡不直接處理明細轉換，只設定審核狀態和客戶
            salesOrderDetails.Clear();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDataFromQuotation), GetType(),
                additionalData: new { QuotationId = quotationId });
        }
    }
}
