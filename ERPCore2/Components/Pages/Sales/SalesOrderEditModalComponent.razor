@inject ISalesOrderService SalesOrderService
@inject ISalesOrderDetailService SalesOrderDetailService
@inject ISalesReturnDetailService SalesReturnDetailService
@inject IInventoryStockService InventoryStockService
@inject ICustomerService CustomerService
@inject ICompanyService CompanyService
@inject IProductService ProductService
@inject IEmployeeService EmployeeService
@inject IUnitService UnitService
@inject IWarehouseService WarehouseService
@inject ISystemParameterService SystemParameterService
@inject INotificationService NotificationService
@inject NavigationManager NavigationManager
@inject ActionButtonHelper ActionButtonHelper
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ISalesReturnService SalesReturnService
@inject ISetoffDocumentService SetoffDocumentService
@inject IReportPrintConfigurationService ReportPrintConfigurationService
@inject IQuotationService QuotationService
@inject IQuotationDetailService QuotationDetailService
@inject ERPCore2.Data.Context.AppDbContext DbContext
@inject IDbContextFactory<AppDbContext> DbContextFactory

<GenericEditModalComponent TEntity="SalesOrder" 
                          TService="ISalesOrderService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@SalesOrderId"
                          Service="@SalesOrderService"
                          EntityName="銷貨訂單"
                          EntityNamePlural="銷貨訂單"
                          ModalTitle="@(SalesOrderId.HasValue ? "編輯銷貨訂單" : "新增銷貨訂單")"
                          Size="GenericEditModalComponent<SalesOrder, ISalesOrderService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@autoCompleteConfig?.Prefillers"
                          AutoCompleteCollections="@autoCompleteConfig?.Collections"
                          AutoCompleteDisplayProperties="@autoCompleteConfig?.DisplayProperties"
                          AutoCompleteValueProperties="@autoCompleteConfig?.ValueProperties"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadSalesOrderData"
                          AdditionalDataLoader="@LoadAdditionalDataAsync"
                          SaveHandler="@SaveSalesOrderWrapper"
                          SaveSuccessMessage="@(SalesOrderId.HasValue ? "銷貨訂單更新成功" : "銷貨訂單新增成功")"
                          SaveFailureMessage="銷貨訂單儲存失敗"
                          RequiredPermission="SalesOrder.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          GetStatusMessage="@GetStatusMessage"
                          FormHeaderContent="@GetWarningMessage()"
                          CustomModules="@GetCustomModules()"
                          CustomActionButtons="@GetCustomActionButtons()"
                          ShowPrintButton="true"
                          OnPrint="@HandlePrint"
                          OnEntityLoaded="@HandleEntityLoaded"
                          >

</GenericEditModalComponent>

@* 客戶編輯 Modal *@
<CustomerEditModalComponent @ref="customerEditModal"
                           IsVisible="@customerModalManager.IsModalVisible"
                           IsVisibleChanged="@customerModalManager.HandleModalVisibilityChangedAsync"
                           CustomerId="@customerModalManager.SelectedEntityId"
                           OnCustomerSaved="@OnCustomerSavedWrapper"
                           OnCancel="@customerModalManager.HandleModalCancelAsync" />

@* 公司編輯 Modal *@
<CompanyEditModalComponent @ref="companyEditModal"
                          IsVisible="@companyModalManager.IsModalVisible"
                          IsVisibleChanged="@companyModalManager.HandleModalVisibilityChangedAsync"
                          CompanyId="@companyModalManager.SelectedEntityId"
                          OnCompanySaved="@OnCompanySavedWrapper"
                          OnCancel="@companyModalManager.HandleModalCancelAsync" />

@* 業務員編輯 Modal *@
<EmployeeEditModalComponent @ref="employeeEditModal"
                           IsVisible="@employeeModalManager.IsModalVisible"
                           IsVisibleChanged="@employeeModalManager.HandleModalVisibilityChangedAsync"
                           EmployeeId="@employeeModalManager.SelectedEntityId"
                           OnEmployeeSaved="@OnEmployeeSavedWrapper"
                           OnCancel="@employeeModalManager.HandleModalCancelAsync" />

@* 銷貨退回編輯 Modal *@
<SalesReturnEditModalComponent @ref="salesReturnEditModal"
                              IsVisible="@showSalesReturnModal"
                              IsVisibleChanged="@((bool visible) => showSalesReturnModal = visible)"
                              SalesReturnId="@selectedSalesReturnId"
                              OnSalesReturnSaved="@HandleSalesReturnSaved"
                              OnCancel="@(() => showSalesReturnModal = false)" />

@* 銷貨出貨單編輯 Modal *@
<SalesDeliveryEditModalComponent @ref="salesDeliveryEditModal"
                                IsVisible="@showSalesDeliveryModal"
                                IsVisibleChanged="@(value => showSalesDeliveryModal = value)"
                                SalesDeliveryId="@selectedSalesDeliveryId"
                                OnSalesDeliverySaved="@HandleSalesDeliverySaved"
                                OnCancel="@(() => showSalesDeliveryModal = false)" />

@* 沖款單編輯 Modal *@
<SetoffDocumentEditModalComponent @ref="setoffDocumentEditModal"
                                 IsVisible="@showSetoffDocumentModal"
                                 IsVisibleChanged="@((bool visible) => showSetoffDocumentModal = visible)"
                                 SetoffDocumentId="@selectedSetoffDocumentId"
                                 OnSetoffDocumentSaved="@HandleSetoffDocumentSaved"
                                 OnCancel="@(() => showSetoffDocumentModal = false)" />

@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SalesOrderId { get; set; }
    [Parameter] public EventCallback<SalesOrder> OnSalesOrderSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    
    // ===== 預填參數（用於從報價單轉單） =====
    [Parameter] public int? PrefilledCustomerId { get; set; }
    [Parameter] public int? PrefilledCompanyId { get; set; }
    [Parameter] public int? PrefilledQuotationId { get; set; }
    
    // ===== 審核控制 =====
    private bool isApprovalEnabled = false; // 系統參數：是否啟用報價單審核
    private bool? isSourceQuotationApproved = null; // 來源報價單是否已審核

    // ===== 內部狀態 =====
    private GenericEditModalComponent<SalesOrder, ISalesOrderService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // AutoComplete 配置
    private AutoCompleteConfig? autoCompleteConfig;
    
    // 原始資料集合（用於 AutoComplete）
    private List<Customer> availableCustomers = new();
    private List<Company> availableCompanies = new();
    private List<Employee> availableEmployees = new();
    private List<Product> availableProducts = new();
    private List<Unit> availableUnits = new();
    private List<Warehouse> availableWarehouses = new();
    
    // 銷貨訂單明細
    private List<SalesOrderDetail> salesOrderDetails = new();
    
    // 明細管理組件引用
    private SalesOrderTable<SalesOrder, SalesOrderDetail>? salesOrderDetailManager;
    
    // Modal Manager 集合
    private ModalManagerCollection? modalManagers;
    
    // Modal 管理器
    private CustomerEditModalComponent? customerEditModal;
    private RelatedEntityModalManager<Customer> customerModalManager = default!;
    private CompanyEditModalComponent? companyEditModal;
    private RelatedEntityModalManager<Company> companyModalManager = default!;
    private EmployeeEditModalComponent? employeeEditModal;
    private RelatedEntityModalManager<Employee> employeeModalManager = default!;
    
    // ===== 相關單據 Modal =====
    private SalesReturnEditModalComponent? salesReturnEditModal;
    private SetoffDocumentEditModalComponent? setoffDocumentEditModal;
    private bool showSalesReturnModal = false;
    private bool showSetoffDocumentModal = false;
    private int? selectedSalesReturnId = null;
    private int? selectedSetoffDocumentId = null;
    
    // 銷貨出貨單 Modal
    private SalesDeliveryEditModalComponent? salesDeliveryEditModal;
    private bool showSalesDeliveryModal = false;
    private int? selectedSalesDeliveryId = null;
    
    // ===== 轉單狀態 =====
    private bool canCreateDelivery = false; 
    // 是否可以轉銷貨出貨單（新增模式需先儲存，編輯模式直接為 true）
    
    // 下拉選單選項（向下相容）
    private List<Customer> customers = new();
    private List<Company> companies = new();
    private List<Employee> employees = new();
    private List<SelectOption> customerOptions = new();
    private List<SelectOption> companyOptions = new();
    private List<SelectOption> employeeOptions = new();
    private List<SelectOption> statusOptions = new();
    private List<SelectOption> taxCalculationMethodOptions = new();
    
    // 稅率快取變數（一次性載入，避免每次計算都查詢資料庫）
    private decimal currentTaxRate = 5.0m; // 預設 5%，實際值會在初始化時從資料庫載入
    
    // ===== 鎖定狀態 =====
    private bool hasUndeletableDetails = false;
    private bool isDetailDataReady = false;

    // ===== 必要方法 =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 使用 ModalManagerInitHelper 初始化所有 Manager
            modalManagers = ModalManagerInitHelper.CreateBuilder<SalesOrder, ISalesOrderService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Customer>(nameof(SalesOrder.CustomerId), "客戶")
                .AddManager<Company>(nameof(SalesOrder.CompanyId), "公司")
                .AddManager<Employee>(nameof(SalesOrder.EmployeeId), "業務員")
                .Build();
            
            // 取得個別 Manager 供組件使用
            customerModalManager = modalManagers.Get<Customer>(nameof(SalesOrder.CustomerId));
            companyModalManager = modalManagers.Get<Company>(nameof(SalesOrder.CompanyId));
            employeeModalManager = modalManagers.Get<Employee>(nameof(SalesOrder.EmployeeId));
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化銷貨訂單編輯組件時發生錯誤");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible)
        {
            // 打開時,如果是新增模式,重置鎖定狀態
            if (!SalesOrderId.HasValue)
            {
                hasUndeletableDetails = false;
            }
            
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
        }
        else
        {
            //  Modal 關閉時重置明細資料準備狀態
            isDetailDataReady = false;
        }
    }

    private async Task HandleSaveSuccess()
    {
        try
        {
            if (OnSalesOrderSaved.HasDelegate && editModalComponent?.Entity != null)
            {
                await OnSalesOrderSaved.InvokeAsync(editModalComponent.Entity);
            }
            // CloseModal 已由 GenericEditModalComponent 統一控制
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSaveSuccess), GetType(), 
                additionalData: "銷貨訂單編輯Modal儲存成功處理失敗");
        }
    }

    private async Task HandleCancel()
    {
        try
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }
            // 不要直接調用 CloseModal，讓 GenericEditModalComponent 處理
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCancel), GetType(), 
                additionalData: "銷貨訂單編輯Modal取消處理失敗");
        }
    }

    private async Task CloseModal()
    {
        try
        {
            if (IsVisibleChanged.HasDelegate)
            {
                await IsVisibleChanged.InvokeAsync(false);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(CloseModal), GetType(), 
                additionalData: "銷貨訂單編輯Modal關閉失敗");
        }
    }

    private async Task<SalesOrder?> LoadSalesOrderData()
    {
        try
        {
            isDetailDataReady = false;
            hasUndeletableDetails = false;
            
            if (!SalesOrderId.HasValue)
            {
                // 新增模式 - 自動產生銷貨訂單號並設定預設公司
                var generatedCode = await EntityCodeGenerationHelper.GenerateForEntity<SalesOrder, ISalesOrderService>(SalesOrderService, DbContext);
                
                // 新增模式：必須先儲存才能轉銷貨
                canCreateDelivery = false;
                
                // 取得預設公司
                var primaryCompany = await CompanyService.GetPrimaryCompanyAsync();
                
                var newOrder = new SalesOrder
                {
                    OrderDate = DateTime.Today,
                    ExpectedDeliveryDate = DateTime.Today.AddDays(7),
                    Status = EntityStatus.Active,
                    TotalAmount = 0,
                    Code = generatedCode,
                    CompanyId = primaryCompany?.Id ?? 0 // 設定預設公司
                };
                
                // 如果是從報價單轉單，載入報價單資料
                if (PrefilledQuotationId.HasValue)
                {
                    await LoadDataFromQuotation(newOrder, PrefilledQuotationId.Value);
                }
                // 否則使用預填客戶和公司
                else
                {
                    if (PrefilledCustomerId.HasValue)
                    {
                        newOrder.CustomerId = PrefilledCustomerId.Value;
                    }
                    if (PrefilledCompanyId.HasValue)
                    {
                        newOrder.CompanyId = PrefilledCompanyId.Value;
                    }
                }
                
                // 清空明細（如果沒有從報價單載入）
                if (!PrefilledQuotationId.HasValue)
                {
                    salesOrderDetails.Clear();
                }
                
                isDetailDataReady = true;
                
                return newOrder;
            }

            // 編輯模式：可以直接轉銷貨
            canCreateDelivery = true;
            
            // 編輯模式 - 載入銷貨訂單和明細
            var salesOrder = await SalesOrderService.GetWithDetailsAsync(SalesOrderId.Value);
            
            if (salesOrder != null)
            {
                // 載入銷貨訂單明細
                await LoadSalesOrderDetails(SalesOrderId.Value);
                
                //  關鍵：載入明細相關資料（退貨記錄、收款記錄）
                await LoadDetailRelatedDataAsync();
                isDetailDataReady = true;
                StateHasChanged();
                
                // 在實體載入後重新初始化表單欄位
                await Task.Delay(10); // 短暫延遲確保實體已設定
                _ = Task.Run(async () =>
                {
                    await InvokeAsync(async () =>
                    {
                        await InitializeFormFieldsAsync();
                        StateHasChanged();
                    });
                });
                
                // 觸發重新渲染以更新 ProductManagerComponent
                StateHasChanged();
            }
            else
            {
                isDetailDataReady = true;
            }
            
            return salesOrder;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSalesOrderData), GetType(), 
                additionalData: $"載入銷貨訂單資料失敗 - ID: {SalesOrderId}");
            await NotificationService.ShowErrorAsync($"載入銷貨訂單資料時發生錯誤：{ex.Message}");
            isDetailDataReady = true; // 錯誤也要允許渲染
            return null;
        }
    }

    /// <summary>
    /// 載入明細相關資料（退貨記錄、收款記錄）- 用於判斷是否有不可刪除的明細
    /// 必須在 DataLoader 中同步執行，確保狀態訊息正確顯示
    /// </summary>
    private async Task LoadDetailRelatedDataAsync()
    {
        try
        {
            if (!salesOrderDetails.Any())
            {
                hasUndeletableDetails = false;
                return;
            }

            bool hasUndeletable = false;
            
            foreach (var detail in salesOrderDetails.Where(d => d.Id > 0))
            {
                // 檢查退貨記錄
                var returnedQty = await SalesReturnDetailService.GetReturnedQuantityByOrderDetailAsync(detail.Id);
                if (returnedQty > 0)
                {
                    hasUndeletable = true;
                    break;
                }
                
                // 檢查收款記錄
                if (detail.TotalReceivedAmount > 0)
                {
                    hasUndeletable = true;
                    break;
                }
            }
            
            hasUndeletableDetails = hasUndeletable;
            
            if (hasUndeletableDetails)
            {
                UpdateFieldsReadOnlyState();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDetailRelatedDataAsync), GetType());
            hasUndeletableDetails = false;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // 載入客戶選項
            customers = await CustomerService.GetAllAsync();
            availableCustomers = customers; // 用於 AutoComplete
            customerOptions = customers.Where(c => c.Status == EntityStatus.Active)
                .Select(c => new SelectOption
                {
                    Text = c.CompanyName ?? "",
                    Value = c.Id.ToString()
                }).ToList();

            // 載入公司選項
            companies = await CompanyService.GetAllAsync();
            availableCompanies = companies; // 用於 AutoComplete
            companyOptions = companies.Where(c => c.Status == EntityStatus.Active)
                .Select(c => new SelectOption
                {
                    Text = c.CompanyName,
                    Value = c.Id.ToString()
                }).ToList();

            // 載入員工選項
            employees = await EmployeeService.GetAllAsync();
            availableEmployees = employees; // 用於 AutoComplete
            employeeOptions = employees.Where(e => e.Status == EntityStatus.Active)
                .Select(e => new SelectOption
                {
                    Text = e.Name ?? string.Empty,
                    Value = e.Id.ToString()
                }).ToList();

            // 載入商品資料
            availableProducts = await ProductService.GetAllAsync();

            // 載入單位資料
            availableUnits = await UnitService.GetAllAsync();

            // 載入倉庫資料
            availableWarehouses = await WarehouseService.GetAllAsync();

            // 初始化狀態選項
            statusOptions = new List<SelectOption>
            {
                new SelectOption { Text = "啟用", Value = "Active" },
                new SelectOption { Text = "停用", Value = "Inactive" }
            };
            
            // 初始化稅別選項
            taxCalculationMethodOptions = new List<SelectOption>
            {
                new SelectOption { Text = "外加稅", Value = ((int)TaxCalculationMethod.TaxExclusive).ToString() },
                new SelectOption { Text = "內含稅", Value = ((int)TaxCalculationMethod.TaxInclusive).ToString() },
                new SelectOption { Text = "不含稅", Value = ((int)TaxCalculationMethod.NoTax).ToString() }
            };
            
            //  一次性載入系統稅率（避免每次計算都查詢資料庫）
            currentTaxRate = await TaxCalculationHelper.LoadTaxRateAsync(SystemParameterService);
            
            // 使用 AutoCompleteConfigHelper 建立配置
            autoCompleteConfig = new AutoCompleteConfigBuilder<SalesOrder>()
                .AddField(nameof(SalesOrder.CustomerId), "CompanyName", availableCustomers)
                .AddField(nameof(SalesOrder.CompanyId), "CompanyName", availableCompanies)
                .AddField(nameof(SalesOrder.EmployeeId), "Name", availableEmployees)
                .Build();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadAdditionalDataAsync), GetType(), 
                additionalData: "銷貨訂單編輯Modal載入額外資料失敗");
            
            // 設定安全的預設值
            customerOptions = new List<SelectOption>();
            companyOptions = new List<SelectOption>();
            employeeOptions = new List<SelectOption>();
            statusOptions = new List<SelectOption>();
            availableProducts = new List<Product>();
            availableUnits = new List<Unit>();
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SalesOrder.Code),
                    Label = "銷貨單號",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入銷貨單號",
                    IsRequired = true,
                    MaxLength = 30,
                    HelpText = "銷貨訂單的唯一編號，新增時系統會自動產生，也可手動修改",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.CustomerId),
                    Label = "客戶",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇客戶",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "輸入客戶名稱進行搜尋，或直接選擇",
                    ActionButtons = await GetCustomerActionButtonsAsync(),
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.CompanyId),
                    Label = "公司",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請選擇公司",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "選擇進行此次銷貨的公司",
                    ActionButtons = await GetCompanyActionButtonsAsync(),
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.EmployeeId),
                    Label = "業務員",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請選擇業務員",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "選擇負責此訂單的業務員",
                    ActionButtons = await GetEmployeeActionButtonsAsync(),
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.OrderDate),
                    Label = "訂單日期",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "銷貨訂單建立日期",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.TaxCalculationMethod),
                    Label = "稅別",
                    FieldType = FormFieldType.Select,
                    IsRequired = true,
                    Options = taxCalculationMethodOptions,
                    HelpText = "稅額計算方式：外加稅（稅額另加）、內含稅（價格已含稅）、不含稅（免稅）",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.ExpectedDeliveryDate),
                    Label = "預定出貨日期",
                    FieldType = FormFieldType.Date,
                    IsRequired = false,
                    HelpText = "預計出貨給客戶的日期",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },

                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesOrder.TotalAmount),
                    Label = "金額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "銷貨單的總金額，根據明細自動計算（明細的數量 × 單價總和）",
                    IsReadOnly = true, // 總金額欄位始終為唯讀
                    CssClass = "text-warning fw-bold" // 使用黃色粗體顯示
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesOrder.DiscountAmount),
                    Label = "折扣",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "銷貨單的折扣金額，根據明細自動計算 = (數量 × 單價 × 折扣%)",
                    IsReadOnly = true, // 折扣欄位始終為唯讀
                    CssClass = "text-danger fw-bold" // 使用紅色粗體顯示
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesOrder.SalesTaxAmount),
                    Label = "稅額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "銷貨單的稅額，根據金額和稅率自動計算 = (折扣後金額 × 稅率%)",
                    IsReadOnly = true, // 稅額欄位始終為唯讀
                    CssClass = "text-info fw-bold" // 使用藍色粗體顯示
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesOrder.TotalAmountWithTax),
                    Label = "總額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "銷貨單的含稅總金額，根據明細自動計算（金額 - 折扣 + 稅額）",
                    IsReadOnly = true, // 含稅總金額欄位始終為唯讀
                    CssClass = "text-success fw-bold" // 使用綠色粗體顯示
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.PaymentTerms),
                    Label = "付款條件",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入付款條件",
                    IsRequired = false,
                    MaxLength = 100,
                    HelpText = "與客戶約定的付款方式和期限",
                    ContainerCssClass = "col-3",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(SalesOrder.DeliveryTerms),
                    Label = "交貨條件",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入交貨條件",
                    IsRequired = false,
                    MaxLength = 100,
                    HelpText = "與客戶約定的交貨方式和條件",
                    ContainerCssClass = "col-3",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },

                FormFieldConfigurationHelper.CreateRemarksField<SalesOrder>(
                    containerCssClass: "col-6",
                    readOnly: hasUndeletableDetails // 根據明細狀態決定是否鎖定
                ),
            };

            formSections = FormSectionHelper<SalesOrder>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    so => so.Code,
                    so => so.CustomerId,
                    so => so.CompanyId,
                    so => so.EmployeeId,
                    so => so.OrderDate,
                    so => so.TaxCalculationMethod,
                    so => so.ExpectedDeliveryDate)
                .AddToSection(FormSectionNames.AmountInfo,
                    so => so.TotalAmount,      // 金額（折扣前）
                    so => so.DiscountAmount,   // 折扣
                    so => so.SalesTaxAmount,   // 稅額
                    so => so.TotalAmountWithTax) // 總額
                .AddToSection(FormSectionNames.AdditionalInfo,
                    so => so.PaymentTerms,
                    so => so.DeliveryTerms,
                    so => so.Remarks)
                .Build();
        }
        catch (Exception ex)
        {
            _ = ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(InitializeFormFieldsAsync), GetType(), 
                additionalData: "銷貨訂單編輯Modal表單欄位初始化失敗");
            
            // 設定安全的預設值
            formFields = new List<FormFieldDefinition>();
            formSections = new Dictionary<string, string>();
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }

    /// <summary>
    /// 生成銷貨訂單號
    /// </summary>
    
    // ===== AutoComplete 配置方法 =====
    
    /// <summary>
    /// 配置 Modal 管理器
    /// </summary>
    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(SalesOrder.CustomerId), customerModalManager },
            { nameof(SalesOrder.CompanyId), companyModalManager },
            { nameof(SalesOrder.EmployeeId), employeeModalManager }
        };
    }
    
    /// <summary>
    /// 配置自訂模組
    /// </summary>
    private List<GenericEditModalComponent<SalesOrder, ISalesOrderService>.CustomModule> GetCustomModules()
    {
        // 確保只在需要時才返回模組，並且檢查所有必要的條件
        if (editModalComponent == null)
        {
            return new List<GenericEditModalComponent<SalesOrder, ISalesOrderService>.CustomModule>();
        }

        return new List<GenericEditModalComponent<SalesOrder, ISalesOrderService>.CustomModule>
        {
            new GenericEditModalComponent<SalesOrder, ISalesOrderService>.CustomModule
            {
                Order = 1,
                IsVisible = true,
                Content = CreateProductManagerContent()
            }
        };
    }

    /// <summary>
    /// 創建商品管理器內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateProductManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null)
            {
                @if (!isDetailDataReady)
                {
                    <div class="d-flex justify-content-center align-items-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span class="text-muted">載入明細資料中...</span>
                    </div>
                }
                // 檢查是否有可用的商品和單位資料
                else if (availableProducts != null && availableProducts.Any() && availableUnits != null && availableUnits.Any())
                {
                    // 檢查是否已選擇客戶
                    @if (editModalComponent.Entity.CustomerId > 0)
                    {
                        <SalesOrderTable @ref="salesOrderDetailManager"
                                                          TMainEntity="SalesOrder" 
                                                          TDetailEntity="SalesOrderDetail"
                                                          MainEntity="@editModalComponent.Entity"
                                                          ExistingDetails="@salesOrderDetails"
                                                          Products="@availableProducts"
                                                          Warehouses="@availableWarehouses"
                                                          SelectedCustomerId="@editModalComponent.Entity.CustomerId"
                                                          TaxCalculationMethod="@editModalComponent.Entity.TaxCalculationMethod"
                                                          IsReadOnly="false"
                                                          MainEntityIdPropertyName="SalesOrderId"
                                                          QuantityPropertyName="OrderQuantity"
                                                          UnitPricePropertyName="UnitPrice"
                                                          DiscountPercentagePropertyName="DiscountPercentage"
                                                          UnitIdPropertyName="UnitId"
                                                          WarehouseIdPropertyName="WarehouseId"
                                                          RemarksPropertyName="DetailRemarks"
                                                          IsApprovalEnabled="@isApprovalEnabled"
                                                          SourceQuotationId="@PrefilledQuotationId"
                                                          IsSourceQuotationApproved="@isSourceQuotationApproved"
                                                          OnDetailsChanged="@HandleDetailsChanged"
                                                          OnHasUndeletableDetailsChanged="@HandleHasUndeletableDetailsChanged"
                                                          OnOpenRelatedDocument="@HandleOpenRelatedDocument"
                                                          ItemDisplayName="銷售產品"
                                                          EmptyMessage="尚未新增銷售產品" />
                    }
                    else
                    {
                        <div class="alert alert-info text-center" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            請先選擇客戶後再進行銷售明細管理
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-warning text-center" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        無可用的商品或單位資料，請聯繫系統管理員
                    </div>
                }
            }
            else
            {
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">載入中...</span>
                    </div>
                </div>
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                載入明細管理器時發生錯誤，請重新整理頁面。
            </div>
        }
    };
    
    // ===== ActionButton 產生方法 =====
    
    /// <summary>
    /// 產生客戶操作按鈕 - 使用統一 Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetCustomerActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            customerModalManager, 
            nameof(SalesOrder.CustomerId)
        );
    }
    
    /// <summary>
    /// 產生公司操作按鈕 - 使用統一 Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetCompanyActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            companyModalManager, 
            nameof(SalesOrder.CompanyId)
        );
    }
    
    /// <summary>
    /// 產生業務員操作按鈕 - 使用統一 Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetEmployeeActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            employeeModalManager, 
            nameof(SalesOrder.EmployeeId)
        );
    }
    
    // ===== Modal 事件包裝器方法 =====
    
    /// <summary>
    /// 包裝客戶儲存事件
    /// </summary>
    private async Task OnCustomerSavedWrapper(Customer savedCustomer)
    {
        await customerModalManager.HandleEntitySavedAsync(savedCustomer, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// 包裝公司儲存事件
    /// </summary>
    private async Task OnCompanySavedWrapper(Company savedCompany)
    {
        await companyModalManager.HandleEntitySavedAsync(savedCompany, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// 包裝業務員儲存事件
    /// </summary>
    private async Task OnEmployeeSavedWrapper(Employee savedEmployee)
    {
        await employeeModalManager.HandleEntitySavedAsync(savedEmployee, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// 處理開啟相關單據的事件
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            if (args.type == RelatedDocumentType.ReturnDocument)
            {
                // 開啟銷貨退回單
                selectedSalesReturnId = args.id;
                showSalesReturnModal = true;
                StateHasChanged();
            }
            else if (args.type == RelatedDocumentType.SetoffDocument)
            {
                // 開啟沖款單
                selectedSetoffDocumentId = args.id;
                showSetoffDocumentModal = true;
                StateHasChanged();
            }
            else
            {
                await NotificationService.ShowWarningAsync("不支援的單據類型", "提示");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"開啟單據失敗：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 處理沖款單儲存後的事件
    /// </summary>
    private async Task HandleSetoffDocumentSaved(SetoffDocument savedDocument)
    {
        try
        {
            showSetoffDocumentModal = false;
            await NotificationService.ShowSuccessAsync("沖款單已更新");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理沖款單儲存事件失敗：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 處理欄位值變更事件 - 使用統一 Helper
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // 使用統一 Helper 處理客戶欄位變更
            if (fieldChange.PropertyName == nameof(SalesOrder.CustomerId))
            {
                //  關鍵：只有在沒有不可刪除明細時才更新 ActionButtons
                if (!hasUndeletableDetails)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        customerModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                }
                
                // 客戶變更時，觸發商品管理器重新渲染
                StateHasChanged();
            }
            // 處理公司欄位變更
            else if (fieldChange.PropertyName == nameof(SalesOrder.CompanyId))
            {
                //  關鍵：只有在沒有不可刪除明細時才更新 ActionButtons
                if (!hasUndeletableDetails)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        companyModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                }
            }
            // 處理業務員欄位變更
            else if (fieldChange.PropertyName == nameof(SalesOrder.EmployeeId))
            {
                //  關鍵：只有在沒有不可刪除明細時才更新 ActionButtons
                if (!hasUndeletableDetails)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        employeeModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                }
            }
            // 處理稅別變更
            else if (fieldChange.PropertyName == nameof(SalesOrder.TaxCalculationMethod))
            {
                // 稅別變更時，重新計算金額和稅額
                await HandleDetailsChanged(salesOrderDetails);
                StateHasChanged();
            }
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("欄位變更處理時發生錯誤");
        }
    }

    // ===== 銷貨明細管理方法 =====
    
    /// <summary>
    /// 處理實體載入完成事件（由 GenericEditModalComponent 的導航觸發）
    /// 當上下筆切換時，重新載入對應的明細資料
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            //  關鍵修復：導航到已存在的記錄時，允許轉單
            canCreateDelivery = true;
            
            // 1. 重新載入明細資料
            await LoadSalesOrderDetails(loadedEntityId);
            
            //  關鍵修正：立即觸發 UI 更新，確保 Table 元件收到新的 ExistingDetails 參數
            // 這樣 RefreshDetailsAsync() 才能讀取到正確的明細資料
            StateHasChanged();
            
            // 2. 載入明細相關資料（退貨數量、收款記錄等）
            await LoadDetailRelatedDataAsync();
            
            // 3. 觸發 Table 元件刷新（此時 ExistingDetails 已經是新的資料）
            if (salesOrderDetailManager != null)
            {
                await salesOrderDetailManager.RefreshDetailsAsync();
            }
            
            // 4. 最後再次更新 UI（確保所有變更都反映在畫面上）
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleEntityLoaded), GetType(), 
                additionalData: $"處理實體載入事件失敗 - EntityId: {loadedEntityId}");
            await NotificationService.ShowErrorAsync("載入明細資料時發生錯誤");
        }
    }
    
    /// <summary>
    /// 載入銷貨訂單明細
    /// </summary>
    private async Task LoadSalesOrderDetails(int salesOrderId)
    {
        try
        {
            // 從現有的銷貨訂單取得明細
            var salesOrder = await SalesOrderService.GetWithDetailsAsync(salesOrderId);
            if (salesOrder?.SalesOrderDetails != null)
            {
                salesOrderDetails = salesOrder.SalesOrderDetails.ToList();
            }
            else
            {
                salesOrderDetails = new List<SalesOrderDetail>();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSalesOrderDetails), GetType(), 
                additionalData: $"載入銷貨訂單明細失敗 - OrderId: {salesOrderId}");
            salesOrderDetails = new List<SalesOrderDetail>();
        }
    }

    /// <summary>
    /// 處理銷貨明細變更
    /// </summary>
    private async Task HandleDetailsChanged(List<SalesOrderDetail> details)
    {
        try
        {
            salesOrderDetails = details ?? new List<SalesOrderDetail>();
            
            // 更新主檔的金額、折扣、稅額和總額
            if (editModalComponent?.Entity != null)
            {
                // 根據稅別計算金額和稅額
                switch (editModalComponent.Entity.TaxCalculationMethod)
                {
                    case TaxCalculationMethod.TaxExclusive:
                        // 外加稅：稅額另外加上
                        // 1. 金額（未稅）= Σ(數量 × 單價 × (1 - 折扣%))
                        editModalComponent.Entity.TotalAmount = Math.Round(
                            salesOrderDetails.Sum(d => d.OrderQuantity * d.UnitPrice * (1 - d.DiscountPercentage / 100)), 
                            0, MidpointRounding.AwayFromZero);
                        
                        // 2. 折扣金額 = Σ(數量 × 單價 × 折扣%)
                        editModalComponent.Entity.DiscountAmount = Math.Round(
                            salesOrderDetails.Sum(d => d.OrderQuantity * d.UnitPrice * (d.DiscountPercentage / 100)), 
                            0, MidpointRounding.AwayFromZero);
                        
                        // 3. 稅額 = Σ(數量 × 單價 × (1 - 折扣%) × 稅率%)（每筆四捨五入）
                        editModalComponent.Entity.SalesTaxAmount = salesOrderDetails.Sum(d =>
                        {
                            var baseAmount = d.OrderQuantity * d.UnitPrice * (1 - d.DiscountPercentage / 100);
                            var taxRate = d.TaxRate ?? 5.0m;
                            return Math.Round(baseAmount * (taxRate / 100), 0, MidpointRounding.AwayFromZero);
                        });
                        break;

                    case TaxCalculationMethod.TaxInclusive:
                        // 內含稅：總價已包含稅
                        // 1. 總額（含稅）= Σ(數量 × 單價 × (1 - 折扣%))
                        var totalWithTax = Math.Round(
                            salesOrderDetails.Sum(d => d.OrderQuantity * d.UnitPrice * (1 - d.DiscountPercentage / 100)), 
                            0, MidpointRounding.AwayFromZero);
                        
                        // 2. 折扣金額 = Σ(數量 × 單價 × 折扣%)
                        editModalComponent.Entity.DiscountAmount = Math.Round(
                            salesOrderDetails.Sum(d => d.OrderQuantity * d.UnitPrice * (d.DiscountPercentage / 100)), 
                            0, MidpointRounding.AwayFromZero);
                        
                        // 3. 稅額 = Σ(小計 / (1 + 稅率%) × 稅率%)（每筆四捨五入）
                        editModalComponent.Entity.SalesTaxAmount = salesOrderDetails.Sum(d =>
                        {
                            var subtotal = d.OrderQuantity * d.UnitPrice * (1 - d.DiscountPercentage / 100);
                            var taxRate = d.TaxRate ?? 5.0m;
                            return Math.Round(subtotal / (1 + taxRate / 100) * (taxRate / 100), 0, MidpointRounding.AwayFromZero);
                        });
                        
                        // 4. 金額（未稅）= 總額 - 稅額
                        editModalComponent.Entity.TotalAmount = Math.Round(totalWithTax - editModalComponent.Entity.SalesTaxAmount, 0, MidpointRounding.AwayFromZero);
                        break;

                    case TaxCalculationMethod.NoTax:
                        // 免稅：完全不計稅
                        // 1. 金額 = Σ(數量 × 單價 × (1 - 折扣%))
                        editModalComponent.Entity.TotalAmount = Math.Round(
                            salesOrderDetails.Sum(d => d.OrderQuantity * d.UnitPrice * (1 - d.DiscountPercentage / 100)), 
                            0, MidpointRounding.AwayFromZero);
                        
                        // 2. 折扣金額 = Σ(數量 × 單價 × 折扣%)
                        editModalComponent.Entity.DiscountAmount = Math.Round(
                            salesOrderDetails.Sum(d => d.OrderQuantity * d.UnitPrice * (d.DiscountPercentage / 100)), 
                            0, MidpointRounding.AwayFromZero);
                        
                        // 3. 稅額 = 0
                        editModalComponent.Entity.SalesTaxAmount = 0;
                        break;
                }
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDetailsChanged), GetType(), 
                additionalData: "處理銷貨明細變更失敗");
        }
    }

    /// <summary>
    /// 處理有不可刪除明細的狀態變更
    /// 當有不可刪除的明細時(已退貨或已收款),鎖定主檔的所有使用者可輸入欄位
    /// </summary>
    private async Task HandleHasUndeletableDetailsChanged(bool hasUndeletable)
    {
        try
        {
            hasUndeletableDetails = hasUndeletable;
            
            // 更新欄位的唯讀狀態
            UpdateFieldsReadOnlyState();
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理明細鎖定狀態時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 更新欄位的唯讀狀態
    /// 當有不可刪除的明細時,所有使用者可輸入的欄位都應設為唯讀:
    /// - 銷貨單號 (SalesOrderNumber)
    /// - 客戶 (CustomerId) - 同時禁用新增/編輯按鈕
    /// - 業務員 (EmployeeId) - 同時禁用新增/編輯按鈕
    /// - 訂單日期 (OrderDate)
    /// - 預定出貨日期 (ExpectedDeliveryDate)
    /// - 付款條件 (PaymentTerms)
    /// - 交貨條件 (DeliveryTerms)
    /// - 備註 (Remarks)
    /// </summary>
    /// <summary>
    /// 更新欄位的唯讀狀態 - 根據是否有不可刪除的明細
    /// 使用 FormFieldLockHelper 統一處理欄位鎖定邏輯
    /// </summary>
    private void UpdateFieldsReadOnlyState()
    {
        // 使用 FormFieldLockHelper 批次鎖定/解鎖欄位
        var fieldsToLock = new[]
        {
            nameof(SalesOrder.Code),
            nameof(SalesOrder.OrderDate),
            nameof(SalesOrder.TaxCalculationMethod),
            nameof(SalesOrder.ExpectedDeliveryDate),
            nameof(SalesOrder.PaymentTerms),
            nameof(SalesOrder.DeliveryTerms),
            nameof(BaseEntity.Remarks)
        };
        
        // 鎖定或解鎖一般欄位（不需要 ActionButtons）
        FormFieldLockHelper.LockMultipleFieldsSimple(
            formFields, 
            fieldsToLock, 
            isLocked: hasUndeletableDetails
        );
        
        // 特殊處理有 ActionButtons 的欄位
        var fieldsWithActionButtons = new Dictionary<string, Func<Task<List<FieldActionButton>>>>
        {
            { nameof(SalesOrder.CustomerId), GetCustomerActionButtonsAsync },
            { nameof(SalesOrder.CompanyId), GetCompanyActionButtonsAsync },
            { nameof(SalesOrder.EmployeeId), GetEmployeeActionButtonsAsync }
        };

        foreach (var kvp in fieldsWithActionButtons)
        {
            if (hasUndeletableDetails)
            {
                // 鎖定：移除 ActionButtons
                FormFieldLockHelper.LockField(
                    formFields,
                    kvp.Key,
                    isLocked: true
                );
            }
            else
            {
                // 解鎖：恢復 ActionButtons
                FormFieldLockHelper.LockField(
                    formFields,
                    kvp.Key,
                    isLocked: false,
                    actionButtonsGetter: kvp.Value
                );
            }
        }
    }

    /// <summary>
    /// 取得狀態訊息（頂部徽章）
    /// 當有不可刪除的明細時，顯示鎖定提示
    /// </summary>
    private async Task<(string Message, GenericEditModalComponent<SalesOrder, ISalesOrderService>.BadgeVariant Variant, string IconClass)?> 
        GetStatusMessage()
    {
        try
        {
            if (!isDetailDataReady || editModalComponent?.Entity == null)
                return null;
            
            if (hasUndeletableDetails)
            {
                return (
                    "明細有其他動作，主檔欄位已鎖定",
                    GenericEditModalComponent<SalesOrder, ISalesOrderService>.BadgeVariant.Warning,
                    "fas fa-lock"
                );
            }
            
            return null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetStatusMessage), GetType());
            return null;
        }
    }

    /// <summary>
    /// 取得警告訊息（表單頂部）
    /// 當有不可刪除的明細時，顯示詳細說明
    /// </summary>
    private RenderFragment? GetWarningMessage() => __builder =>
    {
        <GenericLockedFieldMessage IsVisible="@(isDetailDataReady && hasUndeletableDetails)"
                                  Message="因部分明細有其他動作，為保護資料完整性主檔欄位已設唯讀。"
                                  Type="GenericLockedFieldMessage.MessageType.Warning"
                                  IconClass="fas fa-lock" />
    };

    /// <summary>
    /// 取得自訂操作按鈕（顯示在 Modal 頂部左側）
    /// </summary>
    private RenderFragment? GetCustomActionButtons() => __builder =>
    {
        @* 轉銷貨出貨單按鈕 - 新增模式需先儲存，編輯模式直接可用 *@
        @if (editModalComponent?.Entity != null && 
            SalesOrderId.HasValue)
        {
            <GenericButtonComponent Text="轉銷貨" 
                                  Variant="ButtonVariant.Green" 
                                  OnClick="HandleCreateDeliveryFromOrder" />
        }
    };

    /// <summary>
    /// 從銷貨訂單轉銷售退貨單
    /// </summary>
    private async Task HandleCreateReturnFromOrder()
    {
        try
        {
            // 1. 驗證銷貨訂單資料
            if (!SalesOrderId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("無法轉銷售退貨單：銷貨訂單資料不存在");
                return;
            }
            
            // 2. 驗證客戶資料
            if (editModalComponent.Entity.CustomerId <= 0)
            {
                await NotificationService.ShowWarningAsync("銷貨訂單缺少客戶資訊，無法轉銷售退貨單");
                return;
            }
            
            // 3. 檢查是否有明細資料
            if (!salesOrderDetails.Any())
            {
                await NotificationService.ShowWarningAsync("銷貨訂單沒有明細資料，無法轉銷售退貨單");
                return;
            }
            
            // 4. 檢查是否有可退貨的明細
            // 注意：SalesOrderDetail 目前沒有 ReturnedQuantity 欄位
            // 暫時允許所有有明細的訂單都可以轉退貨單
            // 未來如果需要更精確的驗證，需要在 SalesOrderDetail 加入 ReturnedQuantity 欄位
            // var hasReturnableDetails = salesOrderDetails.Any(detail => 
            //     detail.ReturnedQuantity < detail.OrderQuantity
            // );
            // 
            // if (!hasReturnableDetails)
            // {
            //     await NotificationService.ShowWarningAsync("銷貨訂單所有明細皆已完成退貨，無需再轉銷售退貨單");
            //     return;
            // }
            
            // 5. 呼叫銷售退貨單組件的公開方法
            if (salesReturnEditModal != null)
            {
                await salesReturnEditModal.ShowAddModalWithPrefilledOrder(
                    editModalComponent.Entity.CustomerId,
                    SalesOrderId.Value
                );
            }
            else
            {
                await NotificationService.ShowWarningAsync("銷售退貨單組件未初始化，請重新整理頁面");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCreateReturnFromOrder), GetType(), 
                additionalData: $"轉銷售退貨單失敗 - OrderId: {SalesOrderId}");
            await NotificationService.ShowErrorAsync("轉銷售退貨單時發生錯誤");
        }
    }

    /// <summary>
    /// 從銷貨訂單轉銷貨出貨單 - 簡化版本，所有業務驗證交給銷貨出貨單 Modal 處理
    /// </summary>
    private async Task HandleCreateDeliveryFromOrder()
    {
        try
        {
            // 唯一檢查：確認是否已儲存（新增模式需先儲存，編輯模式直接通過）
            if (!canCreateDelivery)
            {
                await NotificationService.ShowWarningAsync("請先儲存銷貨訂單後，才能轉銷貨出貨單");
                return;
            }
            
            // 安全檢查：確保 Entity 已載入（canCreateDelivery = true 時理論上一定有值）
            if (editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("銷貨訂單資料載入失敗，請重新整理頁面");
                return;
            }
            
            // 直接開啟銷貨出貨單 Modal，使用 Entity.Id 作為銷貨訂單 ID（最可靠的來源）
            // 所有業務驗證（客戶、明細、已出貨等）交給 Modal 內部處理
            await salesDeliveryEditModal!.ShowAddModalWithPrefilledOrder(
                editModalComponent.Entity.CustomerId,
                editModalComponent.Entity.Id  // 使用 Entity.Id 而非 SalesOrderId 參數
            );
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCreateDeliveryFromOrder), GetType(), 
                additionalData: $"轉銷貨出貨單失敗 - OrderId: {editModalComponent?.Entity?.Id}");
            await NotificationService.ShowErrorAsync($"轉銷貨出貨單時發生錯誤: {ex.Message}");
        }
    }

    /// <summary>
    /// 處理銷貨出貨單儲存後的事件
    /// 使用 ChildDocumentRefreshHelper 統一處理刷新邏輯
    /// </summary>
    private async Task HandleSalesDeliverySaved(SalesDelivery savedDelivery)
    {
        try
        {
            await ChildDocumentRefreshHelper.HandleChildDocumentSavedAsync(
                closeModal: () =>
                {
                    showSalesDeliveryModal = false;
                    selectedSalesDeliveryId = null;
                },
                reloadDetails: async () =>
                {
                    if (SalesOrderId.HasValue)
                    {
                        await LoadSalesOrderDetails(SalesOrderId.Value);
                        
                        // 重新計算總金額和稅額
                        if (editModalComponent?.Entity != null)
                        {
                            await HandleDetailsChanged(salesOrderDetails);
                        }
                    }
                },
                detailManager: salesOrderDetailManager,
                notificationMessage: null,
                stateHasChanged: StateHasChanged,
                invokeAsync: InvokeAsync,
                additionalActions: async () =>
                {
                    //  重新載入出貨數量資訊
                    // 注意：SalesOrderTable 目前沒有 LoadDeliveredQuantitiesAsync 方法
                    // 未來如需重新載入出貨數量，需要在 SalesOrderTable 中實作此方法
                    await Task.CompletedTask;
                }
            );
            
            await NotificationService.ShowSuccessAsync($"銷貨出貨單 {savedDelivery.Code} 已更新，銷貨訂單明細已刷新");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSalesDeliverySaved), GetType(), 
                additionalData: $"處理銷貨出貨單儲存事件失敗 - DeliveryId: {savedDelivery?.Id}");
        }
    }

    /// <summary>
    /// 處理銷售退貨單儲存後的事件
    /// </summary>
    /// <summary>
    /// 處理銷售退貨單儲存後的事件
    /// 使用 ChildDocumentRefreshHelper 統一處理刷新邏輯
    /// </summary>
    private async Task HandleSalesReturnSaved(SalesReturn savedReturn)
    {
        try
        {
            await ChildDocumentRefreshHelper.HandleChildDocumentSavedAsync(
                closeModal: () =>
                {
                    showSalesReturnModal = false;
                    selectedSalesReturnId = null;
                },
                reloadDetails: async () =>
                {
                    if (SalesOrderId.HasValue)
                    {
                        await LoadSalesOrderDetails(SalesOrderId.Value);
                        
                        // 重新計算總金額和稅額
                        if (editModalComponent?.Entity != null)
                        {
                            await HandleDetailsChanged(salesOrderDetails);
                        }
                    }
                },
                detailManager: salesOrderDetailManager,
                notificationMessage: null,
                stateHasChanged: StateHasChanged,
                invokeAsync: InvokeAsync,
                additionalActions: async () =>
                {
                    //  關鍵修復：呼叫 Table 組件的公開刷新方法
                    // 重新載入退貨數量資訊
                    if (salesOrderDetailManager != null)
                    {
                        await salesOrderDetailManager.LoadReturnedQuantitiesAsync();
                    }
                }
            );
            
            await NotificationService.ShowSuccessAsync($"銷售退貨單 {savedReturn.Code} 已更新，銷貨訂單明細已刷新");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSalesReturnSaved), GetType(), 
                additionalData: $"處理銷售退貨單儲存事件失敗 - ReturnId: {savedReturn?.Id}");
        }
    }

    /// <summary>
    /// 處理列印事件
    /// </summary>
    private async Task HandlePrint()
    {
        try
        {
            // 使用通用 Helper 進行完整驗證（實體、ID）
            // 銷貨單不需要核准即可列印
            var (isValid, errorMessage) = ReportPrintHelper.ValidateForPrint(
                entity: editModalComponent?.Entity,
                entityId: SalesOrderId,
                isApproved: true, // 不需要核准狀態檢查
                entityName: "銷貨單",
                requireApproval: false // 銷貨單不需要核准即可列印
            );
            
            if (!isValid)
            {
                await NotificationService.ShowWarningAsync(errorMessage);
                return;
            }
            
            // 直接執行列印，使用預設設定
            await HandleDirectPrint(null);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePrint), GetType(), 
                additionalData: $"銷貨單列印處理失敗 - ID: {SalesOrderId}");
            await NotificationService.ShowErrorAsync("列印失敗，請稍後再試");
        }
    }

    /// <summary>
    /// 直接執行列印 - 可以使用指定的列印配置或預設配置
    /// </summary>
    private async Task HandleDirectPrint(ReportPrintConfiguration? printConfig)
    {
        try
        {
            // 建立列印 URL - 使用新的路由格式 /api/sales-report/order/{id}
            var printUrl = ReportPrintHelper.BuildPrintUrl(
                baseUrl: NavigationManager.BaseUri,
                reportType: "sales-report/order",
                documentId: SalesOrderId!.Value,
                configuration: printConfig,
                autoprint: true
            );

            // 使用隱藏 iframe 列印（不阻擋主視窗操作）
            var printSuccess = await ReportPrintHelper.ExecutePrintWithHiddenIframeAsync(
                printUrl: printUrl,
                jsRuntime: JSRuntime,
                iframeId: "salesOrderPrintFrame"
            );

            if (printSuccess)
            {
                await NotificationService.ShowSuccessAsync("列印指令已送出");
            }
            else
            {
                await NotificationService.ShowWarningAsync("列印指令送出失敗，請稍後再試");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDirectPrint), GetType(), 
                additionalData: $"銷貨單直接列印失敗 - ID: {SalesOrderId}");
            await NotificationService.ShowErrorAsync($"執行列印時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 包裝方法 - 提供給 GenericEditModalComponent 使用的儲存處理器
    /// </summary>
    private async Task<bool> SaveSalesOrderWrapper(SalesOrder salesOrder)
    {
        var result = await SaveSalesOrderWithDetails(salesOrder);
        
        // 儲存成功後允許轉銷貨
        if (result)
        {
            canCreateDelivery = true;
        }
        
        return result;
    }

    /// <summary>
    /// 自訂儲存邏輯 - 同時儲存主檔和明細
    /// </summary>
    private async Task<bool> SaveSalesOrderWithDetails(SalesOrder salesOrder)
    {
        try
        {
            if (salesOrder == null)
            {
                await NotificationService.ShowErrorAsync("沒有要儲存的銷貨訂單資料");
                return false;
            }

            // 1. 先進行明細驗證 (檢查單價是否為0)
            if (salesOrderDetailManager != null)
            {
                var isValid = await salesOrderDetailManager.ValidateAsync();
                if (!isValid)
                {
                    // ValidateAsync 內部已顯示錯誤訊息，直接返回
                    return false;
                }
            }
            else
            {
                // 如果沒有管理器引用，進行基本檢查
                var invalidPriceDetails = salesOrderDetails
                    .Where(d => d.ProductId > 0 && d.UnitPrice < 0)
                    .ToList();
                
                if (invalidPriceDetails.Any())
                {
                    await NotificationService.ShowErrorAsync("所有產品的單價不可為負數，請檢查並修正");
                    return false;
                }
            }

            // 更新總金額和稅額（使用 TaxCalculationHelper 統一處理）
            salesOrder.TotalAmount = salesOrderDetails.Sum(d => d.SubtotalAmount);
            salesOrder.SalesTaxAmount = TaxCalculationHelper.CalculateTax(
                salesOrder.TotalAmount, 
                currentTaxRate
            );

            var isEditMode = SalesOrderId.HasValue;
            
            // 2. 💡 銷貨訂單不影響庫存，無需驗證倉庫庫存
            // 倉庫選擇和庫存驗證應在「銷貨出貨單」階段進行
            
            List<SalesOrderDetail> originalDetails = new();
            
            // 在編輯模式下，先取得原始明細資料
            if (isEditMode)
            {
                originalDetails = await SalesOrderDetailService.GetBySalesOrderIdAsync(SalesOrderId!.Value);
            }

            // 儲存主檔
            ServiceResult<SalesOrder> result;
            if (isEditMode)
            {
                result = await SalesOrderService.UpdateAsync(salesOrder);
            }
            else
            {
                result = await SalesOrderService.CreateAsync(salesOrder);
            }

            if (!result.IsSuccess || result.Data == null)
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "儲存銷貨訂單失敗");
                return false;
            }

            // 儲存明細
            await SaveSalesOrderDetails(result.Data.Id, isEditMode, isEditMode ? originalDetails : new List<SalesOrderDetail>());
            
            // 💡 銷貨訂單不影響庫存，無需扣減庫存
            // 庫存扣減應發生在「銷貨出貨單」階段，而非「銷貨訂單」階段

            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveSalesOrderWithDetails), GetType(), 
                additionalData: "儲存銷貨訂單和明細失敗");
            await NotificationService.ShowErrorAsync($"儲存時發生錯誤：{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// 儲存銷貨訂單明細（支援新增和編輯模式）
    /// </summary>
    /// <param name="salesOrderId">銷貨訂單ID</param>
    /// <param name="isEditMode">是否為編輯模式</param>
    /// <param name="originalDetails">原始明細列表（編輯模式使用）</param>
    private async Task SaveSalesOrderDetails(int salesOrderId, bool isEditMode = false, List<SalesOrderDetail>? originalDetails = null)
    {
        try
        {
            // 只處理有效的明細（已選擇產品的）
            var validDetails = salesOrderDetails.Where(d => d.ProductId > 0).ToList();
            

            // 設定主檔ID和時間戳記
            foreach (var detail in validDetails)
            {
                detail.SalesOrderId = salesOrderId;
                if (detail.Id == 0)
                {
                    detail.Status = EntityStatus.Active;
                    detail.CreatedAt = DateTime.Now;
                }
                else
                {
                    detail.UpdatedAt = DateTime.Now;
                }

            }

            // 先獲取現有的明細（如果未提供）
            var existingDetails = originalDetails ?? (await SalesOrderService.GetWithDetailsAsync(salesOrderId))?.SalesOrderDetails?.ToList() ?? new List<SalesOrderDetail>();
            
            // 處理新增和更新的明細
            foreach (var detail in validDetails)
            {
                if (detail.Id == 0)
                {
                    // 新增明細
                    var createResult = await SalesOrderDetailService.CreateAsync(detail);
                    if (createResult.IsSuccess && createResult.Data != null)
                    {
                        // 更新本地明細的 ID
                        detail.Id = createResult.Data.Id;
                        
                        //  更新報價單明細的已轉銷貨數量
                        if (detail.QuotationDetailId.HasValue)
                        {
                            await UpdateQuotationDetailConvertedQuantity(
                                detail.QuotationDetailId.Value, 
                                detail.OrderQuantity, 
                                isAdding: true
                            );
                        }
                    }
                }
                else
                {
                    // 更新明細 - 需要檢查數量變化
                    var originalDetail = existingDetails.FirstOrDefault(e => e.Id == detail.Id);
                    var quantityDiff = detail.OrderQuantity - (originalDetail?.OrderQuantity ?? 0);
                    
                    await SalesOrderDetailService.UpdateAsync(detail);
                    
                    //  如果數量有變化且有報價單來源，更新報價單明細的已轉銷貨數量
                    if (quantityDiff != 0 && detail.QuotationDetailId.HasValue)
                    {
                        await UpdateQuotationDetailConvertedQuantity(
                            detail.QuotationDetailId.Value,
                            Math.Abs(quantityDiff),
                            isAdding: quantityDiff > 0
                        );
                    }
                }
            }

            // 處理刪除的明細（現有的但不在當前有效列表中的）
            var currentDetailIds = validDetails.Where(d => d.Id > 0).Select(d => d.Id).ToList();
            var detailsToDelete = existingDetails.Where(e => !currentDetailIds.Contains(e.Id)).ToList();
            

            foreach (var detailToDelete in detailsToDelete)
            {
                //  如果有報價單來源，減少報價單明細的已轉銷貨數量
                if (detailToDelete.QuotationDetailId.HasValue)
                {
                    await UpdateQuotationDetailConvertedQuantity(
                        detailToDelete.QuotationDetailId.Value,
                        detailToDelete.OrderQuantity,
                        isAdding: false
                    );
                }
                
                await SalesOrderDetailService.PermanentDeleteAsync(detailToDelete.Id);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveSalesOrderDetails), GetType(), 
                additionalData: $"儲存銷貨訂單明細失敗 - OrderId: {salesOrderId}");
            throw; // 重新拋出例外，讓上層處理
        }
    }

    /// <summary>
    /// 更新報價單明細的已轉銷貨數量
    /// </summary>
    private async Task UpdateQuotationDetailConvertedQuantity(int quotationDetailId, decimal quantity, bool isAdding)
    {
        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var quotationDetail = await context.QuotationDetails.FindAsync(quotationDetailId);
            
            if (quotationDetail != null)
            {
                if (isAdding)
                {
                    quotationDetail.ConvertedQuantity += quantity;
                }
                else
                {
                    quotationDetail.ConvertedQuantity -= quantity;
                    // 確保不會變成負數
                    if (quotationDetail.ConvertedQuantity < 0)
                        quotationDetail.ConvertedQuantity = 0;
                }
                
                quotationDetail.UpdatedAt = DateTime.Now;
                await context.SaveChangesAsync();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(UpdateQuotationDetailConvertedQuantity), GetType(),
                additionalData: new { QuotationDetailId = quotationDetailId, Quantity = quantity, IsAdding = isAdding });
            // 不拋出異常，避免影響主流程
        }
    }

    /// <summary>
    /// 使用FIFO方式扣減庫存
    /// </summary>
    private async Task ReduceInventoryWithFIFOAsync(int salesOrderId)
    {
        try
        {
            // 只處理有效的明細（已選擇產品和倉庫的）
            var validDetails = salesOrderDetails
                .Where(d => d.ProductId > 0 && d.OrderQuantity > 0 && d.WarehouseId.HasValue)
                .ToList();

            foreach (var detail in validDetails)
            {
                if (!detail.WarehouseId.HasValue) continue;

                var result = await InventoryStockService.ReduceStockWithFIFOAsync(
                    detail.ProductId,
                    detail.WarehouseId.Value,
                    (int)Math.Ceiling(detail.OrderQuantity),
                    InventoryTransactionTypeEnum.Sale,
                    $"SO-{salesOrderId}",
                    null, // WarehouseLocationId - SalesOrderDetail沒有此欄位，傳入null
                    $"銷貨訂單出貨 - SO-{salesOrderId}",
                    detail.Id > 0 ? detail.Id : null // 傳遞明細ID用於追蹤
                );

                if (!result.IsSuccess)
                {
                    await NotificationService.ShowWarningAsync($"商品 {detail.Product?.Name} 庫存扣減失敗：{result.ErrorMessage}");
                    // 不中斷流程，只記錄警告
                }
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ReduceInventoryWithFIFOAsync), GetType(), 
                additionalData: $"FIFO庫存扣減失敗 - OrderId: {salesOrderId}");
            await NotificationService.ShowWarningAsync("庫存扣減時發生錯誤，請檢查庫存記錄");
        }
    }
    
    // ===== 從報價單轉單相關方法 =====
    
    /// <summary>
    /// 打開新增銷貨訂單 Modal 並預填報價單資料（公開方法，供父組件呼叫）
    /// </summary>
    public async Task ShowAddModalWithPrefilledQuotation(int customerId, int companyId, int quotationId)
    {
        try
        {
            // 使用 DocumentConversionHelper 處理轉單邏輯（自訂載入邏輯版本）
            var success = await DocumentConversionHelper.ShowConversionModalWithCustomLoadAsync(
                resetEntityId: () => SalesOrderId = null,
                setPrefilledValues: () =>
                {
                    PrefilledCustomerId = customerId;
                    PrefilledCompanyId = companyId;
                    PrefilledQuotationId = quotationId;
                },
                isVisibleChanged: IsVisibleChanged,
                customLoadAction: async () =>
                {
                    await LoadQuotationDetailsToSalesOrder(quotationId);
                },
                detailManagerReady: () => salesOrderDetailManager != null,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("轉單流程執行失敗");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledQuotation), GetType(), 
                additionalData: $"開啟預填銷貨訂單Modal失敗 - CustomerId: {customerId}, CompanyId: {companyId}, QuotationId: {quotationId}");
            await NotificationService.ShowErrorAsync("開啟銷貨訂單時發生錯誤");
        }
    }
    
    /// <summary>
    /// 從報價單載入明細到銷貨訂單明細表
    /// </summary>
    private async Task LoadQuotationDetailsToSalesOrder(int quotationId)
    {
        try
        {
            // 載入報價單資料（含明細和審核狀態）
            var quotation = await QuotationService.GetWithDetailsAsync(quotationId);
            if (quotation == null)
            {
                await NotificationService.ShowWarningAsync("找不到指定的報價單", "載入失敗");
                return;
            }
            
            // 記錄審核狀態
            isSourceQuotationApproved = quotation.IsApproved;
            
            // 載入系統參數：是否啟用報價單審核
            var systemParameter = await SystemParameterService.GetSystemParameterAsync();
            isApprovalEnabled = systemParameter?.EnableQuotationApproval ?? false;
            
            // 驗證報價單明細
            if (quotation.QuotationDetails == null || !quotation.QuotationDetails.Any())
            {
                await NotificationService.ShowWarningAsync("報價單沒有明細資料", "載入失敗");
                return;
            }
            
            // 使用 SalesOrderTable 的公開方法載入明細
            if (salesOrderDetailManager != null)
            {
                await salesOrderDetailManager.LoadQuotationDetails(
                    quotation.QuotationDetails.ToList(), 
                    quotationId, 
                    quotation.IsApproved
                );
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadQuotationDetailsToSalesOrder), GetType(),
                additionalData: new { QuotationId = quotationId });
            await NotificationService.ShowErrorAsync("載入報價單明細時發生錯誤");
        }
    }
    
    /// <summary>
    /// 從報價單載入資料到銷貨訂單
    /// 注意：實際的轉單邏輯由 QuotationEditModalComponent 在儲存時處理
    /// 這裡只是預留參數，實際使用 PrefilledCustomerId
    /// </summary>
    private async Task LoadDataFromQuotation(SalesOrder salesOrder, int quotationId)
    {
        try
        {
            // 載入報價單資料（含明細和審核狀態）
            var quotation = await QuotationService.GetWithDetailsAsync(quotationId);
            if (quotation == null)
            {
                await NotificationService.ShowWarningAsync("找不到指定的報價單", "載入失敗");
                return;
            }
            
            // 設定客戶ID
            salesOrder.CustomerId = quotation.CustomerId;
            
            // 設定公司ID
            salesOrder.CompanyId = quotation.CompanyId;
            
            // 記錄審核狀態
            isSourceQuotationApproved = quotation.IsApproved;
            
            // 載入系統參數：是否啟用報價單審核
            var systemParameter = await SystemParameterService.GetSystemParameterAsync();
            isApprovalEnabled = systemParameter?.EnableQuotationApproval ?? false;
            
            // 注意：明細的載入將由父組件（QuotationEditModalComponent）的 HandleCreateSalesOrderFromQuotation 處理
            // 這裡不直接處理明細轉換，只設定審核狀態和客戶
            salesOrderDetails.Clear();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDataFromQuotation), GetType(),
                additionalData: new { QuotationId = quotationId });
        }
    }
}
