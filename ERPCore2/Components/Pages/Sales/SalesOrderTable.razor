@* éŠ·è²¨è¨‚å–®æ˜ç´°ç®¡ç†çµ„ä»¶ - ä½¿ç”¨ InteractiveTableComponent çµ±ä¸€UI ä¸¦æ•´åˆè‡ªå‹•ç©ºè¡ŒåŠŸèƒ½ *@

@using ERPCore2.Models
@using ERPCore2.Data.Enums
@using ERPCore2.Helpers
@inject IProductService ProductService
@inject ISalesOrderDetailService SalesOrderDetailService
@inject ISalesReturnDetailService SalesReturnDetailService
@inject INotificationService NotificationService
@inject RelatedDocumentsHelper RelatedDocumentsHelper
@inject IInventoryStockService InventoryStockService
@inject ISystemParameterService SystemParameterService
@inject IQuotationService QuotationService
@inject ISalesOrderCompositionDetailService SalesOrderCompositionDetailService
@inject IQuotationCompositionDetailService QuotationCompositionDetailService
@inject IProductCompositionService ProductCompositionService
@inject IJSRuntime JSRuntime

@typeparam TMainEntity where TMainEntity : BaseEntity
@typeparam TDetailEntity where TDetailEntity : BaseEntity, new()

@if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="customer-warning">
                <i class="bi bi-exclamation-triangle text-warning fs-1 mb-3"></i>
                <p class="text-muted">è«‹å…ˆé¸æ“‡å®¢æˆ¶æ‰èƒ½æ–°å¢éŠ·è²¨æ˜ç´°</p>
            </div>
        </div>
    </div>
}
else
{
    @* è­¦å‘Šè¨Šæ¯ï¼šé¡¯ç¤ºæœªå¯©æ ¸çš„å ±åƒ¹å–®æ˜ç´° *@
    @if (IsApprovalEnabled && GetUnapprovedItemsCount() > 0)
    {
        <div class="alert alert-warning mb-3" role="alert">
            <div class="d-flex align-items-start">
                <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                <div>
                    <strong>æ³¨æ„ï¼š</strong>ç›®å‰æœ‰ <strong>@GetUnapprovedItemsCount()</strong> é …æ˜ç´°ä¾†è‡ªæœªå¯©æ ¸çš„å ±åƒ¹å–®ã€‚
                    <br/>
                    <small class="text-muted">é€™äº›æ˜ç´°å°‡ç„¡æ³•å„²å­˜ï¼Œè«‹ç¢ºèªç›¸é—œå ±åƒ¹å–®å·²å®Œæˆå¯©æ ¸å¾Œå†é€²è¡ŒéŠ·è²¨ä½œæ¥­ã€‚</small>
                </div>
            </div>
        </div>
    }
    
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="SalesItem" 
                                      Items="SalesItems"
                                      ColumnDefinitions="GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"                                      
                                      EmptyMessage="@EmptyMessage"
                                      ShowBuiltInActions="@(!IsReadOnly)"
                                      ShowBuiltInDeleteButton="false"
                                      CustomActionsTemplate="GetCustomActionsTemplate"
                                      ActionsColumnWidth = "60px"
                                      OnItemDelete="HandleItemDelete"
                                      EnableAutoEmptyRow="true"
                                      AllowAddNewRow="@(!_hasUndeletableDetails && !IsReadOnly)"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@(() => new SalesItem())"/>
        </div>

        <div class="card-footer">
            <div class="d-flex justify-content-between">
                <div class="d-flex gap-2">
                    <GenericButtonComponent Text="æ™ºèƒ½ä¸‹å–®"
                                          Variant="ButtonVariant.DarkBlue"
                                          Icon="fas fa-magic"
                                          OnClick="LoadSmartOrderItems"
                                          IsDisabled="@(!CanLoadSmartOrder || _hasUndeletableDetails)"
                                          Title="@GetSmartOrderTooltip()" />
                    <GenericButtonComponent Text="è¼‰å…¥å ±åƒ¹"
                                          Variant="ButtonVariant.DarkBlue"
                                          Icon="fas fa-file-invoice"
                                          OnClick="LoadQuotationItems"
                                          IsDisabled="@(!CanLoadQuotation || _hasUndeletableDetails)"
                                          Title="@GetLoadQuotationTooltip()" />
                </div>
                <div class="d-flex gap-2">
                    <GenericButtonComponent Text="æ¸…é™¤æ˜ç´°"
                                          Variant="ButtonVariant.Red"
                                          OnClick="ClearAllDetails"
                                          IsDisabled="@(IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetClearAllDetailsTooltip()" />
                </div>
            </div>
        </div>
    </div>
}

<!-- ç›¸é—œå–®æ“šæŸ¥çœ‹ Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

<!-- é…æ–¹é¸æ“‡ Modal -->
<CompositionSelectorModal IsVisible="@showCompositionSelectorModal"
                         IsVisibleChanged="@((bool visible) => showCompositionSelectorModal = visible)"
                         ProductName="@selectedCompositionProductName"
                         Compositions="@availableCompositions"
                         CurrentCustomerId="@SelectedCustomerId"
                         OnSelected="@HandleCompositionSelected" />

<!-- BOM çµ„åˆç·¨è¼¯/æŸ¥çœ‹ Modal -->
<QuotationCompositionEditModal TCompositionDetail="SalesOrderCompositionDetail"
                              IsVisible="@showCompositionModal"
                              IsVisibleChanged="@((bool visible) => showCompositionModal = visible)"
                              DetailId="@GetSelectedSalesOrderDetailId()"
                              ProductName="@selectedCompositionProductName"
                              ProductId="@selectedCompositionProductId"
                              SelectedCompositionId="@selectedCompositionId"
                              IsCustomMode="@isCustomCompositionMode"
                              IsReselecting="@isReselectingComposition"
                              IsReadOnly="@GetCompositionModalReadOnlyState()"
                              GetCompositionsByDetailId="@SalesOrderCompositionDetailService.GetBySalesOrderDetailIdAsync"
                              CopyFromComposition="@SalesOrderCompositionDetailService.CopyFromCompositionAsync"
                              OnSave="@HandleCompositionSave"
                              OnCancel="@HandleCompositionCancel"
                              OnRequestCachedData="@GetCachedCompositionData"
                              OnReselect="@HandleCompositionReselect" />

@code {
    // ===== InteractiveTableComponent åƒè€ƒ =====
    private InteractiveTableComponent<SalesItem>? tableComponent;
    
    // ===== è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜ =====
    private bool _dataLoadCompleted = true;  // è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜
    
    // ===== åŸºæœ¬åƒæ•¸ =====
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public EventCallback<List<SalesItem>> OnSalesItemsChanged { get; set; }
    
    // ===== å®¢æˆ¶éæ¿¾åƒæ•¸ =====
    [Parameter] public int? SelectedCustomerId { get; set; }
    
    // ===== å ±åƒ¹å–®åƒæ•¸ =====
    [Parameter] public int? SelectedQuotationId { get; set; }
    
    // ===== ç¯©é¸åƒæ•¸ =====
    [Parameter] public int? FilterProductId { get; set; }
    
    // ===== æ³›å‹åƒæ•¸ =====
    [Parameter] public TMainEntity? MainEntity { get; set; }
    [Parameter] public List<TDetailEntity> ExistingDetails { get; set; } = new List<TDetailEntity>();
    [Parameter] public EventCallback<List<TDetailEntity>> OnDetailsChanged { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    [Parameter] public EventCallback<SalesItem> OnItemRemoved { get; set; }
    
    /// <summary>
    /// ç‹€æ…‹é€šçŸ¥åƒæ•¸ - é€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
    /// </summary>
    [Parameter] public EventCallback<bool> OnHasUndeletableDetailsChanged { get; set; }
    
    // ===== ç›¸é—œå–®æ“šé–‹å•Ÿäº‹ä»¶ =====
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }
    
    // ===== æ¬„ä½æ˜ å°„åƒæ•¸ =====
    [Parameter] public string MainEntityIdPropertyName { get; set; } = string.Empty;
    [Parameter] public string QuantityPropertyName { get; set; } = "OrderQuantity";
    [Parameter] public string UnitPricePropertyName { get; set; } = "UnitPrice";
    [Parameter] public string RemarksPropertyName { get; set; } = "DetailRemarks";
    [Parameter] public string? UnitIdPropertyName { get; set; }
    [Parameter] public string? WarehouseIdPropertyName { get; set; }
    [Parameter] public string? DiscountPercentagePropertyName { get; set; } = "DiscountPercentage";
    [Parameter] public string? SubtotalPropertyName { get; set; } = "Subtotal";    

    
    // ===== é¡¯ç¤ºè¨­å®š =====
    [Parameter] public string Title { get; set; } = "éŠ·è²¨æ˜ç´°";
    [Parameter] public string Subtitle { get; set; } = "";
    [Parameter] public string Icon { get; set; } = "cart-plus";
    [Parameter] public string ItemDisplayName { get; set; } = "å•†å“";
    [Parameter] public string EmptyIcon { get; set; } = "cart";
    [Parameter] public string EmptyMessage { get; set; } = "å°šæœªæ–°å¢éŠ·è²¨å•†å“";
    
    // ===== å”¯è®€æ¨¡å¼åƒæ•¸ =====
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== ä¸‹æ‹‰é¸é …åƒæ•¸ =====
    [Parameter] public List<Warehouse> Warehouses { get; set; } = new List<Warehouse>();
    
    // ===== ç¨…åˆ¥åƒæ•¸ï¼ˆæ–°å¢ï¼‰=====
    [Parameter] public TaxCalculationMethod TaxCalculationMethod { get; set; } = TaxCalculationMethod.TaxExclusive;

    // ===== è¼”åŠ©è¨ˆç®—å±¬æ€§ =====
    private bool IsTaxCalculationMethodNoTax => TaxCalculationMethod == TaxCalculationMethod.NoTax;
    
    // ===== å¯©æ ¸ç®¡ç†åƒæ•¸ =====
    [Parameter] public bool IsApprovalEnabled { get; set; } = false; // æ˜¯å¦å•Ÿç”¨å ±åƒ¹å–®å¯©æ ¸ï¼ˆå¾ç³»çµ±åƒæ•¸è¼‰å…¥ï¼‰
    [Parameter] public int? SourceQuotationId { get; set; } // ä¾†æºå ±åƒ¹å–®IDï¼ˆç”¨æ–¼å¾å ±åƒ¹å–®è½‰å–®æ™‚ï¼‰
    [Parameter] public bool? IsSourceQuotationApproved { get; set; } // ä¾†æºå ±åƒ¹å–®æ˜¯å¦å·²å¯©æ ¸

    public List<SalesItem> SalesItems { get; set; } = new List<SalesItem>();
    private List<Product> AvailableProducts { get; set; } = new List<Product>();
    private int? _previousSelectedCustomerId = null;
    private int? _previousFilterProductId = null;
    private List<int> _deletedDetailIds { get; set; } = new List<int>();
    private int _previousExistingDetailsCount = 0;  // è¿½è¹¤ ExistingDetails æ•¸é‡è®ŠåŒ–
    
    // ===== é€€è²¨æ•¸é‡ç®¡ç† =====
    private Dictionary<int, decimal> _returnedQuantities = new(); // Key: SalesOrderDetailId, Value: å·²é€€è²¨æ•¸é‡

    // ===== ç›¸é—œå–®æ“šæŸ¥çœ‹ =====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;
    
    // ===== BOM çµ„åˆç·¨è¼¯ç›¸é—œ =====
    private bool showCompositionModal = false;
    private bool showCompositionSelectorModal = false;
    private int? selectedSalesItemIndex = null;
    private string selectedCompositionProductName = string.Empty;
    private int? selectedCompositionProductId = null;
    private int? selectedCompositionId = null;
    private bool isCustomCompositionMode = false;
    private bool isReselectingComposition = false;
    private List<ProductComposition> availableCompositions = new();
    private Dictionary<int, List<SalesOrderCompositionDetail>> compositionDetailsCache = new();
    private HashSet<int> productsWithComposition = new();  // å¿«å–æœ‰ BOM çš„å•†å“ ID
    private bool _hasUndeletableDetails = false;  // æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²æœ‰å‡ºè²¨è¨˜éŒ„ï¼‰
    
    // ===== è¨ˆç®—å±¬æ€§ =====
    
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦è™•æ–¼ç·¨è¼¯æ¨¡å¼ï¼ˆæœ‰ç¾æœ‰çš„å·²å„²å­˜æ˜ç´°ï¼‰
    /// </summary>
    private bool IsEditMode => ExistingDetails?.Any() == true;
    
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦å¯ä»¥ä½¿ç”¨ã€Œæ™ºèƒ½ä¸‹å–®ã€åŠŸèƒ½
    /// è¦å‰‡ï¼š
    /// 1. å¿…é ˆé¸æ“‡å®¢æˆ¶
    /// 2. ä¸å¯åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹ä½¿ç”¨ï¼ˆé¿å…è¦†è“‹ç¾æœ‰è³‡æ–™ï¼‰
    /// </summary>
    private bool CanLoadSmartOrder => 
        SelectedCustomerId.HasValue && 
        SelectedCustomerId.Value > 0 &&
        !IsReadOnly &&
        !IsEditMode; // ç·¨è¼¯æ¨¡å¼ä¸‹ç¦ç”¨æ­¤æŒ‰éˆ•
    
    /// <summary>
    /// å–å¾—ã€Œæ™ºèƒ½ä¸‹å–®ã€æŒ‰éˆ•çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetSmartOrderTooltip()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
            return "è«‹å…ˆé¸æ“‡å®¢æˆ¶";
        
        if (IsReadOnly)
            return "å”¯è®€æ¨¡å¼ä¸‹ç„¡æ³•ä½¿ç”¨æ™ºèƒ½ä¸‹å–®";
        
        if (IsEditMode)
            return "ç·¨è¼¯æ¨¡å¼ä¸‹ç„¡æ³•ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè«‹åœ¨æ–°å¢æ¨¡å¼æ™‚ä½¿ç”¨";
        
        if (_hasUndeletableDetails)
            return "éƒ¨åˆ†æ˜ç´°å·²æœ‰å‡ºè²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ä½¿ç”¨æ™ºèƒ½ä¸‹å–®";
        
        return "è¼‰å…¥è©²å®¢æˆ¶ä¸Šæ¬¡è¨‚è³¼çš„å•†å“æ˜ç´°";
    }
    
    /// <summary>
    /// å–å¾—ã€Œè¼‰å…¥å ±åƒ¹ã€æŒ‰éˆ•çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetLoadQuotationTooltip()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
            return "è«‹å…ˆé¸æ“‡å®¢æˆ¶";
        
        if (!SelectedQuotationId.HasValue || SelectedQuotationId.Value <= 0)
            return "è«‹å…ˆé¸æ“‡å ±åƒ¹å–®";
        
        if (IsReadOnly)
            return "å”¯è®€æ¨¡å¼ä¸‹ç„¡æ³•è¼‰å…¥å ±åƒ¹";
        
        if (IsEditMode)
            return "ç·¨è¼¯æ¨¡å¼ä¸‹ç„¡æ³•ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè«‹åœ¨æ–°å¢æ¨¡å¼æ™‚ä½¿ç”¨";
        
        if (_hasUndeletableDetails)
            return "éƒ¨åˆ†æ˜ç´°å·²æœ‰å‡ºè²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•è¼‰å…¥å ±åƒ¹";
        
        return "è¼‰å…¥è©²å ±åƒ¹å–®çš„å•†å“æ˜ç´°";
    }
    
    /// <summary>
    /// å–å¾—æ¸…é™¤æ˜ç´°æŒ‰éˆ•çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetClearAllDetailsTooltip()
    {
        if (IsReadOnly)
            return "å”¯è®€æ¨¡å¼ç„¡æ³•ä½¿ç”¨";
        
        if (_hasUndeletableDetails)
            return "éƒ¨åˆ†æ˜ç´°å·²æœ‰å‡ºè²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•æ¸…é™¤æ˜ç´°";
        
        return "æ¸…ç©ºæ‰€æœ‰éŠ€è²¨æ˜ç´°";
    }
    /// åˆ¤æ–·æ˜¯å¦å¯ä»¥ä½¿ç”¨ã€Œè¼‰å…¥å ±åƒ¹ã€åŠŸèƒ½
    /// è¦å‰‡ï¼š
    /// 1. å¿…é ˆé¸æ“‡å®¢æˆ¶
    /// 2. å¿…é ˆé¸æ“‡å ±åƒ¹å–®
    /// 3. ä¸å¯åœ¨å”¯è®€æ¨¡å¼
    /// 4. ä¸å¯åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹ä½¿ç”¨ï¼ˆé¿å…è¦†è“‹ç¾æœ‰è³‡æ–™ï¼‰
    /// </summary>
    private bool CanLoadQuotation => 
        SelectedCustomerId.HasValue && 
        SelectedCustomerId.Value > 0 &&
        SelectedQuotationId.HasValue &&
        SelectedQuotationId.Value > 0 &&
        !IsReadOnly &&
        !IsEditMode;
    
    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦æœ‰è¢«é–å®šçš„æ˜ç´°ï¼ˆæœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„çš„æ˜ç´°ï¼‰
    /// </summary>
    private bool HasLockedDetails()
    {
        return SalesItems.Any(item => 
            item.SelectedProduct != null &&
            (HasReturnRecord(item) || HasPaymentRecord(item)));
    }
    
    /// <summary>
    /// å–å¾—æœªå¯©æ ¸çš„æ˜ç´°æ•¸é‡
    /// </summary>
    private int GetUnapprovedItemsCount()
    {
        if (!IsApprovalEnabled)
            return 0;
        
        return SalesItems
            .Where(item => item.SelectedProduct != null &&
                          item.SourceQuotationId.HasValue &&
                          !(item.IsQuotationApproved ?? false))
            .Count();
    }

    protected override async Task OnInitializedAsync()
    {
        // åˆå§‹åŒ–è¿½è¹¤è®Šæ•¸ (åœ¨è¼‰å…¥è³‡æ–™å‰è¨­å®šï¼Œé¿å… OnParametersSetAsync èª¤åˆ¤)
        _previousSelectedCustomerId = SelectedCustomerId;
        _previousFilterProductId = FilterProductId;
        _previousExistingDetailsCount = ExistingDetails?.Count ?? 0;
        
        await LoadAvailableProductsAsync();
        await LoadExistingDetailsAsync();
        
        // è¼‰å…¥æœ‰ BOM çµ„æˆçš„å•†å“åˆ—è¡¨
        await LoadProductCompositionsAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        
        // æª¢æŸ¥ç¯©é¸åƒæ•¸æ˜¯å¦è®Šæ›´
        bool customerChanged = _previousSelectedCustomerId != SelectedCustomerId;
        bool productFilterChanged = _previousFilterProductId != FilterProductId;
        int currentExistingDetailsCount = ExistingDetails?.Count ?? 0;
        bool existingDetailsChanged = _previousExistingDetailsCount != currentExistingDetailsCount;
        
        //  é—œéµï¼šå¦‚æœ ExistingDetails æœ‰è®ŠåŒ–ï¼ˆä¾‹å¦‚å¾ç·¨è¼¯æ¨¡å¼è¿”å›ï¼‰ï¼Œä¸è¦æ¸…ç©ºè³‡æ–™
        // åªåœ¨çœŸæ­£çš„å®¢æˆ¶è®Šæ›´æ™‚æ‰é‡æ–°è¼‰å…¥
        if (customerChanged && !existingDetailsChanged)
        {
            _previousSelectedCustomerId = SelectedCustomerId;
            _previousFilterProductId = FilterProductId;
            _previousExistingDetailsCount = currentExistingDetailsCount;
            
            await LoadAvailableProductsAsync();
            
            // å®¢æˆ¶è®Šæ›´æ™‚æ¸…ç©ºç¾æœ‰é¸é …ä¸¦é‡æ–°è¼‰å…¥
            SalesItems.Clear();
            await LoadExistingDetailsAsync();
            return;
        }
        
        // æ›´æ–°è¿½è¹¤è®Šæ•¸
        if (existingDetailsChanged)
        {
            _previousExistingDetailsCount = currentExistingDetailsCount;
        }
        
        // å¦‚æœåªæ˜¯å•†å“ç¯©é¸è®Šæ›´ï¼Œåªéœ€è¦æ›´æ–°ç¯©é¸ç‹€æ…‹ä¸¦é‡æ–°æ¸²æŸ“
        if (productFilterChanged)
        {
            _previousFilterProductId = FilterProductId;
            StateHasChanged();
            return;
        }
    }

    // ===== é€€è²¨æ•¸é‡ç®¡ç†æ–¹æ³• =====
    
    /// <summary>
    /// è¼‰å…¥æ‰€æœ‰éŠ·è²¨è¨‚å–®æ˜ç´°çš„é€€è²¨æ•¸é‡ï¼ˆå…¬é–‹æ–¹æ³•ï¼Œä¾›çˆ¶çµ„ä»¶å‘¼å«ï¼‰
    /// ç”¨æ–¼å­å–®æ“šå„²å­˜å¾Œï¼Œé‡æ–°è¼‰å…¥æ˜ç´°ä»¥æ›´æ–°é€€è²¨æ•¸é‡
    /// </summary>
    public async Task LoadReturnedQuantitiesAsync()
    {
        _returnedQuantities.Clear();
        
        // åªè™•ç†æœ‰ç¾æœ‰å¯¦é«”çš„é …ç›®
        var itemsToProcess = SalesItems
            .Where(x => x.ExistingDetailEntity != null)
            .ToList();
        
        foreach (var item in itemsToProcess)
        {
            if (item.ExistingDetailEntity is SalesOrderDetail detail && detail.Id > 0)
            {
                // TODO: é€€è²¨ç¾åœ¨å¾å‡ºè²¨å–®ç”¢ç”Ÿï¼Œä¸ç›´æ¥å¾è¨‚å–®
                // var returnedQty = await SalesReturnDetailService.GetReturnedQuantityByDeliveryDetailAsync(detail.Id);
                // if (returnedQty > 0)
                // {
                //     _returnedQuantities[detail.Id] = returnedQty;
                // }
            }
        }
        
        // è¼‰å…¥é€€è²¨æ•¸é‡å¾Œï¼Œé€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
        await NotifyHasUndeletableDetailsChanged();
        
        StateHasChanged();
    }
    
    /// <summary>
    /// æª¢æŸ¥æŒ‡å®šçš„éŠ·è²¨è¨‚å–®æ˜ç´°é …ç›®æ˜¯å¦æœ‰é€€è²¨è¨˜éŒ„
    /// </summary>
    private bool HasReturnRecord(SalesItem item)
    {
        if (item.ExistingDetailEntity is SalesOrderDetail detail && detail.Id > 0)
        {
            return _returnedQuantities.ContainsKey(detail.Id);
        }
        return false;
    }
    
    /// <summary>
    /// å–å¾—æŒ‡å®šéŠ·è²¨è¨‚å–®æ˜ç´°é …ç›®çš„å·²é€€è²¨æ•¸é‡
    /// </summary>
    private decimal GetReturnedQuantity(SalesItem item)
    {
        if (item.ExistingDetailEntity is SalesOrderDetail detail && detail.Id > 0)
        {
            return _returnedQuantities.TryGetValue(detail.Id, out var qty) ? qty : 0;
        }
        return 0;
    }
    
    /// <summary>
    /// æª¢æŸ¥æŒ‡å®šçš„éŠ·è²¨è¨‚å–®æ˜ç´°é …ç›®æ˜¯å¦æœ‰æ²–æ¬¾è¨˜éŒ„
    /// æª¢æŸ¥é‚è¼¯ï¼š
    /// - è³‡æ–™è¡¨ï¼šSalesOrderDetail
    /// - æ¬„ä½ï¼šTotalReceivedAmount (ç´¯è¨ˆæ”¶æ¬¾é‡‘é¡)
    /// - æ¢ä»¶ï¼šTotalReceivedAmount > 0 è¡¨ç¤ºå·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œä¸å¯åˆªé™¤
    /// </summary>
    /// <param name="item">è¦æª¢æŸ¥çš„éŠ·è²¨è¨‚å–®æ˜ç´°é …ç›®</param>
    /// <returns>true è¡¨ç¤ºæœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œfalse è¡¨ç¤ºæ²’æœ‰</returns>
    private bool HasPaymentRecord(SalesItem item)
    {
        if (item.ExistingDetailEntity is SalesOrderDetail detail && detail.Id > 0)
        {
            return detail.TotalReceivedAmount > 0;
        }
        return false;
    }
    
    /// <summary>
    /// å–å¾—æŒ‡å®šéŠ·è²¨è¨‚å–®æ˜ç´°é …ç›®çš„å·²æ”¶æ¬¾é‡‘é¡
    /// </summary>
    /// <param name="item">è¦æª¢æŸ¥çš„éŠ·è²¨è¨‚å–®æ˜ç´°é …ç›®</param>
    /// <returns>å·²æ”¶æ¬¾é‡‘é¡</returns>
    private decimal GetReceivedAmount(SalesItem item)
    {
        if (item.ExistingDetailEntity is SalesOrderDetail detail && detail.Id > 0)
        {
            return detail.TotalReceivedAmount;
        }
        return 0;
    }
    
    /// <summary>
    /// æª¢æŸ¥é …ç›®æ˜¯å¦å¯ä»¥åˆªé™¤ - ä½¿ç”¨ DetailLockHelper çµ±ä¸€è™•ç†
    /// éŠ·è²¨è¨‚å–®æ˜ç´°éœ€æª¢æŸ¥ä¸‰ç¨®ä¸‹ä¸€æ­¥å‹•ä½œï¼š
    /// 1. DeliveredQuantity > 0ï¼šå·²æœ‰å‡ºè²¨è¨˜éŒ„
    /// 2. ScheduledQuantity > 0ï¼šå·²æœ‰ç”Ÿç”¢æ’ç¨‹
    /// 3. TotalReceivedAmount > 0ï¼šå·²æœ‰æ”¶æ¬¾è¨˜éŒ„
    /// </summary>
    /// <param name="item">è¦æª¢æŸ¥çš„é …ç›®</param>
    /// <param name="reason">ä¸å¯åˆªé™¤çš„åŸå› ï¼ˆè¼¸å‡ºåƒæ•¸ï¼‰</param>
    /// <returns>true è¡¨ç¤ºå¯ä»¥åˆªé™¤ï¼Œfalse è¡¨ç¤ºä¸å¯åˆªé™¤</returns>
    private bool CanDeleteItem(SalesItem item, out string reason)
    {
        // ğŸ”¥ ä½¿ç”¨ DetailLockHelper çµ±ä¸€æª¢æŸ¥ï¼ˆæª¢æŸ¥ï¼šå‡ºè²¨ã€æ’ç¨‹ã€æ”¶æ¬¾ï¼‰
        // æ³¨æ„ï¼šéŠ·è²¨è¨‚å–®éœ€è¦åŒæ™‚æª¢æŸ¥å¤šå€‹æ¢ä»¶
        return DetailLockHelper.CanDeleteItem(
            item.ExistingDetailEntity,
            out reason,
            checkDelivery: true,    // æª¢æŸ¥ DeliveredQuantity
            checkSchedule: true,    // æª¢æŸ¥ ScheduledQuantity  
            checkPayment: true      // æª¢æŸ¥ TotalReceivedAmount
        );
    }

    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼‰
    /// </summary>
    private bool HasUndeletableDetails()
    {
        return SalesItems.Any(item => 
            item.SelectedProduct != null && !CanDeleteItem(item, out _));
    }

    /// <summary>
    /// é€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
    /// </summary>
    private async Task NotifyHasUndeletableDetailsChanged()
    {
        if (OnHasUndeletableDetailsChanged.HasDelegate)
        {
            var hasUndeletableDetails = HasUndeletableDetails();
            
            // ç‹€æ…‹è®Šæ›´æ™‚æ‰é€šçŸ¥çˆ¶çµ„ä»¶ä¸¦è§¸ç™¼ UI æ›´æ–°
            if (_hasUndeletableDetails != hasUndeletableDetails)
            {
                _hasUndeletableDetails = hasUndeletableDetails;
                await OnHasUndeletableDetailsChanged.InvokeAsync(hasUndeletableDetails);
                tableComponent?.RefreshEmptyRow();  // åˆ·æ–°ç©ºè¡Œç‹€æ…‹
                StateHasChanged();  // è§¸ç™¼ UI æ›´æ–°ï¼Œè®“ AllowAddNewRow åƒæ•¸ç”Ÿæ•ˆ
            }
        }
    }

    // ===== BOM çµ„åˆç·¨è¼¯ç›¸é—œæ–¹æ³• =====
    
    /// <summary>
    /// è¼‰å…¥æœ‰ BOM çµ„æˆçš„å•†å“åˆ—è¡¨ï¼ˆç”¨æ–¼å¿«å–æª¢æŸ¥ï¼‰
    /// </summary>
    private async Task LoadProductCompositionsAsync()
    {
        try
        {
            // è¼‰å…¥æ‰€æœ‰æœ‰ BOM çµ„æˆçš„å•†å“ ID
            var allCompositions = await ProductCompositionService.GetAllAsync();
            productsWithComposition = allCompositions
                .Select(pc => pc.ParentProductId)
                .ToHashSet();
        }
        catch (Exception ex)
        {
            // è¼‰å…¥å¤±æ•—ä¸å½±éŸ¿ä¸»æµç¨‹
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ BOM è³‡æ–™å¤±æ•—ï¼š{ex.Message}");
            productsWithComposition = new HashSet<int>();
        }
    }
    
    /// <summary>
    /// æª¢æŸ¥å•†å“æ˜¯å¦æœ‰ BOM çµ„æˆ
    /// </summary>
    private bool HasProductComposition(int productId)
    {
        return productsWithComposition.Contains(productId);
    }
    
    /// <summary>
    /// é¡¯ç¤º BOM çµ„åˆç·¨è¼¯å™¨ - æ™ºèƒ½åˆ¤æ–·æ˜¯å¦éœ€è¦é¸æ“‡é…æ–¹
    /// </summary>
    private async Task ShowCompositionEditor(SalesItem item)
    {
        if (item.SelectedProduct == null)
        {
            return;
        }
        
        // æ‰¾å‡º SalesItem çš„ç´¢å¼•
        selectedSalesItemIndex = SalesItems.IndexOf(item);
        selectedCompositionProductName = item.SelectedProduct.Name;
        selectedCompositionProductId = item.SelectedProduct.Id;
        
        // å–å¾—æ˜ç´° ID
        var detailId = (item.ExistingDetailEntity as SalesOrderDetail)?.Id ?? 0;
        
        // ğŸ”‘ é—œéµä¿®æ­£ï¼šå¦‚æœæ˜¯å·²å„²å­˜çš„æ˜ç´°ï¼ˆDetailId > 0ï¼‰ä½†æ²’æœ‰å¿«å–è³‡æ–™ï¼Œç›´æ¥é–‹å•Ÿ Modal
        // Modal æœƒè‡ªå‹•å¾è³‡æ–™åº«è¼‰å…¥ BOM çµ„åˆæ˜ç´°
        if (detailId > 0 && !item.HasCompositionData)
        {
            selectedCompositionId = null;  // è®“ Modal è‡ªå·±åˆ¤æ–·
            isCustomCompositionMode = false;
            showCompositionModal = true;
        }
        // æª¢æŸ¥æ˜¯å¦å·²æœ‰çµ„åˆè³‡æ–™ï¼ˆå¿«å–ï¼‰
        else if (item.HasCompositionData)
        {
            // å·²æœ‰è³‡æ–™ï¼Œç›´æ¥é–‹å•Ÿç·¨è¼¯å™¨
            selectedCompositionId = item.SelectedCompositionId;
            isCustomCompositionMode = item.IsCustomComposition;
            showCompositionModal = true;
        }
        else
        {
            // å°šæœªé¸æ“‡é…æ–¹ï¼Œé¡¯ç¤ºé¸æ“‡å™¨
            availableCompositions = await ProductCompositionService
                .GetCompositionsByProductIdAsync(item.SelectedProduct.Id);
            showCompositionSelectorModal = true;
        }
        
        StateHasChanged();
    }
    
    /// <summary>
    /// è™•ç†é…æ–¹é¸æ“‡
    /// </summary>
    private async Task HandleCompositionSelected((int? compositionId, bool isCustomMode) selection)
    {
        showCompositionSelectorModal = false;
        
        selectedCompositionId = selection.compositionId;
        isCustomCompositionMode = selection.isCustomMode;
        
        // è¨˜éŒ„é¸æ“‡è³‡è¨Šåˆ° SalesItem
        if (selectedSalesItemIndex.HasValue)
        {
            var item = SalesItems.ElementAtOrDefault(selectedSalesItemIndex.Value);
            if (item != null)
            {
                item.SelectedCompositionId = selection.compositionId;
                item.IsCustomComposition = selection.isCustomMode;
                
                // å¦‚æœæ˜¯é‡æ–°é¸æ“‡ï¼Œæ¸…é™¤èˆŠçš„å¿«å–è³‡æ–™
                if (isReselectingComposition)
                {
                    item.CustomCompositionDetails = null;
                }
                
                // ğŸ”‘ é—œéµï¼šå¦‚æœé¸æ“‡çš„æ˜¯é…æ–¹ï¼ˆéè‡ªå®šç¾©ï¼‰ï¼Œç«‹å³å¾é…æ–¹è¤‡è£½çµ„åˆæ˜ç´°
                if (selection.compositionId.HasValue && !selection.isCustomMode)
                {
                    try
                    {
                        // ä½¿ç”¨è‡¨æ™‚ DetailIdï¼ˆæ–°å¢æ˜ç´°æ™‚ç”¨è² æ•¸è¡¨ç¤ºï¼‰
                        var tempDetailId = item.ExistingDetailEntity?.Id ?? -(selectedSalesItemIndex.Value + 1);
                        var copiedDetails = await SalesOrderCompositionDetailService.CopyFromCompositionAsync(
                            tempDetailId,
                            selection.compositionId.Value
                        );
                        
                        item.CustomCompositionDetails = copiedDetails;
                    }
                    catch (Exception ex)
                    {
                        await NotificationService.ShowErrorAsync($"è¼‰å…¥é…æ–¹å¤±æ•—ï¼š{ex.Message}");
                    }
                }
            }
        }
        
        // é–‹å•Ÿ BOM ç·¨è¼¯å™¨
        showCompositionModal = true;
        StateHasChanged();
    }
    
    /// <summary>
    /// è™•ç†é‡æ–°é¸æ“‡é…æ–¹
    /// </summary>
    private async Task HandleCompositionReselect()
    {
        // å…ˆæ¨™è¨˜ç‚ºé‡æ–°é¸æ“‡æ¨¡å¼ï¼ˆåœ¨é—œé–‰ Modal ä¹‹å‰ï¼‰
        isReselectingComposition = true;
        
        // é—œé–‰ç•¶å‰çš„ BOM ç·¨è¼¯ Modal
        showCompositionModal = false;
        
        // æ¸…é™¤ç•¶å‰é¸æ“‡çš„é…æ–¹è³‡è¨Š
        if (selectedSalesItemIndex.HasValue)
        {
            var item = SalesItems.ElementAtOrDefault(selectedSalesItemIndex.Value);
            if (item?.SelectedProduct != null)
            {
                // é‡æ–°è¼‰å…¥é…æ–¹æ¸…å–®
                availableCompositions = await ProductCompositionService
                    .GetCompositionsByProductIdAsync(item.SelectedProduct.Id);
                
                // é¡¯ç¤ºé…æ–¹é¸æ“‡å™¨
                showCompositionSelectorModal = true;
                StateHasChanged();
            }
        }
    }
    
    /// <summary>
    /// å–å¾— BOM ç·¨è¼¯ Modal çš„å”¯è®€ç‹€æ…‹
    /// å¦‚æœå…¨åŸŸå”¯è®€æˆ–ç•¶å‰é¸ä¸­çš„æ˜ç´°å·²è½‰å–®/æœ‰é€€è²¨/æœ‰æ²–æ¬¾ï¼Œå‰‡ Modal æ‡‰è©²ç‚ºå”¯è®€
    /// </summary>
    private bool GetCompositionModalReadOnlyState()
    {
        // å…¨åŸŸå”¯è®€æ¨¡å¼
        if (IsReadOnly) return true;
        
        // æª¢æŸ¥é¸ä¸­çš„é …ç›®
        if (!selectedSalesItemIndex.HasValue || selectedSalesItemIndex.Value >= SalesItems.Count)
            return false;
        
        var item = SalesItems[selectedSalesItemIndex.Value];
        
        // æª¢æŸ¥æ˜¯å¦æœ‰é€€è²¨è¨˜éŒ„
        if (HasReturnRecord(item)) return true;
        
        // æª¢æŸ¥æ˜¯å¦æœ‰æ²–æ¬¾è¨˜éŒ„
        if (HasPaymentRecord(item)) return true;
        
        // æª¢æŸ¥æ˜¯å¦å·²è½‰ä¸‹ä¸€æ­¥ï¼ˆå·²å‡ºè²¨ï¼‰
        if (item.DeliveredQuantity > 0) return true;
        
        // å…¶ä»–æƒ…æ³å¯ç·¨è¼¯
        return false;
    }
    
    /// <summary>
    /// å–å¾—é¸ä¸­çš„éŠ·è²¨è¨‚å–®æ˜ç´° IDï¼ˆç”¨æ–¼ Modalï¼‰
    /// </summary>
    private int? GetSelectedSalesOrderDetailId()
    {
        if (!selectedSalesItemIndex.HasValue || selectedSalesItemIndex.Value >= SalesItems.Count)
        {
            return null;
        }
        
        var item = SalesItems[selectedSalesItemIndex.Value];
        var detailId = (item.ExistingDetailEntity as SalesOrderDetail)?.Id;
        
        return detailId;
    }
    
    /// <summary>
    /// è™•ç† BOM çµ„åˆå„²å­˜
    /// </summary>
    private async Task HandleCompositionSave(List<SalesOrderCompositionDetail> compositionDetails)
    {
        if (!selectedSalesItemIndex.HasValue || !selectedCompositionProductId.HasValue)
        {
            return;
        }
            
        try
        {
            // æš«å­˜åˆ°å¿«å–ï¼ˆå¯¦éš›å„²å­˜æœƒåœ¨éŠ·è²¨è¨‚å–®å„²å­˜æ™‚ä¸€ä½µè™•ç†ï¼‰
            var item = SalesItems[selectedSalesItemIndex.Value];
            item.CustomCompositionDetails = compositionDetails;
            
            // ç¢ºä¿é¸æ“‡è³‡è¨Šå·²è¨˜éŒ„ï¼ˆå¦‚æœé‚„æ²’è¨˜éŒ„çš„è©±ï¼‰
            if (!item.SelectedCompositionId.HasValue && !item.IsCustomComposition)
            {
                item.SelectedCompositionId = selectedCompositionId;
                item.IsCustomComposition = isCustomCompositionMode;
            }
            
            await NotificationService.ShowSuccessAsync("BOM çµ„æˆå·²æ›´æ–°ï¼ˆå°‡åœ¨éŠ·è²¨è¨‚å–®å„²å­˜æ™‚ä¸€ä½µä¿å­˜ï¼‰");
            showCompositionModal = false;
            isReselectingComposition = false;  // å„²å­˜å®Œæˆå¾Œé‡ç½®
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å„²å­˜ BOM çµ„æˆå¤±æ•—ï¼š{ex.Message}");
        }
    }
    
    /// <summary>
    /// è™•ç† BOM çµ„åˆå–æ¶ˆ
    /// </summary>
    private void HandleCompositionCancel()
    {
        showCompositionModal = false;
        isReselectingComposition = false;
    }
    
    /// <summary>
    /// å–å¾—å¿«å–çš„çµ„åˆæ˜ç´°è³‡æ–™ï¼ˆä¾› Modal ä½¿ç”¨ï¼‰
    /// </summary>
    private List<SalesOrderCompositionDetail>? GetCachedCompositionData()
    {
        if (!selectedSalesItemIndex.HasValue)
        {
            return null;
        }
        
        if (selectedSalesItemIndex.Value >= SalesItems.Count)
        {
            return null;
        }
        
        var item = SalesItems[selectedSalesItemIndex.Value];
        var data = item.CustomCompositionDetails;
        
        return data;
    }

    // ===== å»ºç«‹ç©ºé …ç›®æ–¹æ³• =====
    
    private Task LoadAvailableProductsAsync()
    {
        try
        {
            if (SelectedCustomerId.HasValue && SelectedCustomerId.Value > 0)
            {
                // åªé¡¯ç¤ºå•†å“é¡åˆ¥æ¨™è¨˜ç‚ºå¯è²©å”®çš„å•†å“
                AvailableProducts = Products
                    .Where(p => p.ProductCategory != null && 
                               p.ProductCategory.IsSaleable)
                    .ToList();
            }
            else
            {
                AvailableProducts = new List<Product>();
            }
        }
        catch (Exception)
        {
            AvailableProducts = new List<Product>();
        }
        
        return Task.CompletedTask;
    }

    /// <summary>
    /// å…¬é–‹çš„åˆ·æ–°æ–¹æ³•ï¼Œç”¨æ–¼å¤–éƒ¨è§¸ç™¼æ˜ç´°åˆ·æ–°ï¼ˆä¾‹å¦‚ï¼šä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼‰
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadExistingDetailsAsync();
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }
    
    /// <summary>
    /// å–å¾—æ‰€æœ‰éŠ·è²¨è¨‚å–®çµ„åˆæ˜ç´°è³‡æ–™ï¼ˆä¾›çˆ¶çµ„ä»¶å„²å­˜ä½¿ç”¨ï¼‰
    /// </summary>
    public Dictionary<int, List<SalesOrderCompositionDetail>> GetCompositionDetails()
    {
        var result = new Dictionary<int, List<SalesOrderCompositionDetail>>();
        
        for (int i = 0; i < SalesItems.Count; i++)
        {
            var item = SalesItems[i];
            if (item.SelectedProduct == null) continue;
            
            var detailId = item.ExistingDetailEntity?.Id ?? 0;
            
            // å¦‚æœæœ‰è‡ªè¨‚çš„çµ„åˆæ˜ç´°
            if (item.CustomCompositionDetails?.Any() == true)
            {
                if (detailId > 0)
                {
                    // å·²å­˜åœ¨çš„æ˜ç´°ï¼Œä½¿ç”¨å¯¦éš› ID
                    result[detailId] = item.CustomCompositionDetails;
                }
                else
                {
                    // ä½¿ç”¨è² çš„ SalesItems ç´¢å¼•ä½œç‚ºè‡¨æ™‚ ID
                    // -(i+1) ç¢ºä¿å¾ -1 é–‹å§‹ï¼Œé¿å…èˆ‡ 0 æ··æ·†
                    int tempIndex = -(i + 1);
                    
                    foreach (var detail in item.CustomCompositionDetails)
                    {
                        detail.SalesOrderDetailId = tempIndex; // æš«å­˜è‡¨æ™‚ç´¢å¼•
                    }
                    result[tempIndex] = item.CustomCompositionDetails;
                }
            }
        }
        
        return result;
    }
    
    private async Task LoadExistingDetailsAsync()
    {
        if (ExistingDetails?.Any() != true) 
        {
            SalesItems.Clear();
            _dataLoadCompleted = true;
            tableComponent?.RefreshEmptyRow();
            StateHasChanged();
            return;
        }
        
        //  é–‹å§‹è¼‰å…¥è³‡æ–™ - è¨­å®šç‚ºæœªå®Œæˆ
        _dataLoadCompleted = false;
        
        SalesItems.Clear();
        
        foreach (var detail in ExistingDetails)
        {
            // è½‰æ›ç‚ºæ­£ç¢ºçš„å¯¦é«”é¡å‹
            if (detail is SalesOrderDetail salesDetail)
            {
                var systemTaxRate = await SystemParameterService.GetTaxRateAsync();
                var finalTaxRate = salesDetail.TaxRate ?? salesDetail.Product?.TaxRate ?? systemTaxRate;
                
                var salesItem = new SalesItem
                {
                    SelectedProduct = salesDetail.Product ?? Products.FirstOrDefault(p => p.Id == salesDetail.ProductId),
                    OrderQuantity = salesDetail.OrderQuantity,
                    DeliveredQuantity = salesDetail.DeliveredQuantity,
                    UnitPrice = salesDetail.UnitPrice,
                    DiscountPercentage = salesDetail.DiscountPercentage,
                    TaxRate = finalTaxRate,
                    Subtotal = salesDetail.SubtotalAmount,
                    DetailRemarks = salesDetail.Remarks ?? "",
                    ExistingDetailEntity = detail
                };
                
                // ğŸ”‘ è¼‰å…¥è©²æ˜ç´°çš„ BOM çµ„æˆè³‡æ–™ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                try
                {
                    var compositions = await SalesOrderCompositionDetailService.GetBySalesOrderDetailIdAsync(salesDetail.Id);
                    
                    if (compositions?.Any() == true)
                    {
                        salesItem.CustomCompositionDetails = compositions;
                        salesItem.IsCustomComposition = true;  // æ¨™è¨˜ç‚ºè‡ªè¨‚çµ„åˆ
                        salesItem.SelectedCompositionId = null;  // è‡ªè¨‚çµ„åˆæ²’æœ‰é…æ–¹ ID
                    }
                }
                catch
                {
                    // BOM è¼‰å…¥å¤±æ•—ä¸å½±éŸ¿ä¸»æµç¨‹
                }
                
                // åˆå§‹åŒ– ProductSearchValue
                if (salesItem.SelectedProduct != null)
                {
                    salesItem.ProductSearchValue = FormatProductDisplayText(salesItem.SelectedProduct);
                }
                
                SalesItems.Add(salesItem);
            }
            else
            {
                // é€šç”¨è½‰æ›é‚è¼¯
                var salesItem = new SalesItem
                {
                    ExistingDetailEntity = detail
                };
                
                // ä½¿ç”¨åå°„è¨­å®šå±¬æ€§
                var productId = GetPropertyValue<int>(detail, "ProductId");
                salesItem.SelectedProduct = Products.FirstOrDefault(p => p.Id == productId);
                
                // åˆå§‹åŒ– ProductSearchValue
                if (salesItem.SelectedProduct != null)
                {
                    salesItem.ProductSearchValue = FormatProductDisplayText(salesItem.SelectedProduct);
                }
                
                salesItem.OrderQuantity = GetPropertyValue<decimal>(detail, QuantityPropertyName);
                salesItem.UnitPrice = GetPropertyValue<decimal>(detail, UnitPricePropertyName);
                salesItem.DetailRemarks = GetPropertyValue<string>(detail, RemarksPropertyName) ?? "";
                
                if (!string.IsNullOrEmpty(DiscountPercentagePropertyName))
                    salesItem.DiscountPercentage = GetPropertyValue<decimal>(detail, DiscountPercentagePropertyName);
                    
                if (!string.IsNullOrEmpty(SubtotalPropertyName))
                    salesItem.Subtotal = GetPropertyValue<decimal>(detail, SubtotalPropertyName);
                
                // è¨­å®šç¨…ç‡ï¼ˆå„ªå…ˆä½¿ç”¨æ˜ç´°ç¨…ç‡ï¼Œå…¶æ¬¡å•†å“ç¨…ç‡ï¼Œæœ€å¾Œç³»çµ±é è¨­å€¼ï¼‰
                var detailTaxRate = GetPropertyValue<decimal?>(detail, "TaxRate");
                var systemTaxRate2 = await SystemParameterService.GetTaxRateAsync();
                salesItem.TaxRate = detailTaxRate ?? salesItem.SelectedProduct?.TaxRate ?? systemTaxRate2;
                
                SalesItems.Add(salesItem);
            }
        }
        
        // ğŸ”¥ é—œéµï¼šè¼‰å…¥å¾Œç«‹å³æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
        bool hasUndeletableDetails = SalesItems.Any(item => 
            item.SelectedProduct != null && 
            !DetailLockHelper.CanDeleteItem(
                item.ExistingDetailEntity, 
                out _, 
                checkDelivery: true,    // æª¢æŸ¥ DeliveredQuantity
                checkSchedule: true,    // æª¢æŸ¥ ScheduledQuantity
                checkPayment: true      // æª¢æŸ¥ TotalReceivedAmount
            )
        );
        
        if (_hasUndeletableDetails != hasUndeletableDetails)
        {
            _hasUndeletableDetails = hasUndeletableDetails;
        }
        
        //  è³‡æ–™è¼‰å…¥å®Œæˆ - è§¸ç™¼ç©ºè¡Œæª¢æŸ¥
        _dataLoadCompleted = true;
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }

    private List<TDetailEntity> ConvertToDetailEntities()
    {
        var details = new List<TDetailEntity>();
        
        foreach (var item in SalesItems.Where(x => x.SelectedProduct != null))
        {
            TDetailEntity detail;
            
            if (item.ExistingDetailEntity != null)
            {
                // æ›´æ–°ç¾æœ‰æ˜ç´°
                detail = item.ExistingDetailEntity;
                
                // æ›´æ–°åŸºæœ¬è³‡è¨Š
                SetPropertyValue(detail, "ProductId", item.SelectedProduct!.Id);
                SetPropertyValue(detail, QuantityPropertyName, item.OrderQuantity);
                SetPropertyValue(detail, UnitPricePropertyName, item.UnitPrice);
                SetPropertyValue(detail, RemarksPropertyName, item.DetailRemarks);
                
                // æ›´æ–°å¯é¸å±¬æ€§
                if (!string.IsNullOrEmpty(DiscountPercentagePropertyName))
                    SetPropertyValue(detail, DiscountPercentagePropertyName, item.DiscountPercentage);
                    
                if (!string.IsNullOrEmpty(SubtotalPropertyName))
                    SetPropertyValue(detail, SubtotalPropertyName, item.Subtotal);
                
                // æ›´æ–°ç¨…ç‡
                SetPropertyValue(detail, "TaxRate", item.TaxRate);
                
                // æ›´æ–°å ±åƒ¹å–®æ˜ç´°ä¾†æºï¼ˆå¦‚æœæœ‰ï¼‰
                if (item.SourceQuotationDetailId.HasValue)
                    SetPropertyValue(detail, "QuotationDetailId", item.SourceQuotationDetailId.Value);
            }
            else
            {
                
                // æ–°å¢æ˜ç´°
                detail = new TDetailEntity();
                
                // è¨­å®šä¸»å¯¦é«”é—œè¯
                if (MainEntity != null)
                    SetPropertyValue(detail, MainEntityIdPropertyName, GetPropertyValue<int>(MainEntity, "Id"));
                
                // è¨­å®šåŸºæœ¬è³‡è¨Š
                SetPropertyValue(detail, "ProductId", item.SelectedProduct!.Id);
                SetPropertyValue(detail, QuantityPropertyName, item.OrderQuantity);
                SetPropertyValue(detail, UnitPricePropertyName, item.UnitPrice);
                SetPropertyValue(detail, RemarksPropertyName, item.DetailRemarks);
                
                // è¨­å®šå¯é¸å±¬æ€§
                if (!string.IsNullOrEmpty(DiscountPercentagePropertyName))
                    SetPropertyValue(detail, DiscountPercentagePropertyName, item.DiscountPercentage);
                    
                if (!string.IsNullOrEmpty(SubtotalPropertyName))
                    SetPropertyValue(detail, SubtotalPropertyName, item.Subtotal);
                
                // è¨­å®šç¨…ç‡
                SetPropertyValue(detail, "TaxRate", item.TaxRate);
                
                // è¨­å®šå ±åƒ¹å–®æ˜ç´°ä¾†æºï¼ˆå¦‚æœæœ‰ï¼‰
                if (item.SourceQuotationDetailId.HasValue)
                    SetPropertyValue(detail, "QuotationDetailId", item.SourceQuotationDetailId.Value);
            }
            
            details.Add(detail);
        }
        
        return details;
    }

    private async Task NotifyDetailsChanged()
    {
        var details = ConvertToDetailEntities();
        await DetailSyncHelper.SyncToParentAsync(details, OnDetailsChanged);
        
        // é€šçŸ¥å·²åˆªé™¤çš„æ˜ç´° ID
        if (OnDeletedDetailsChanged.HasDelegate && _deletedDetailIds.Any())
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds.ToList());
            _deletedDetailIds.Clear(); // æ¸…ç©ºå·²é€šçŸ¥çš„åˆªé™¤ID
        }
        
        // é€šçŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
        await NotifyHasUndeletableDetailsChanged();
    }

    private T? GetPropertyValue<T>(object obj, string propertyName)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property == null) return default(T);
        
        var value = property.GetValue(obj);
        if (value == null) return default(T);
        
        if (typeof(T) == typeof(object)) return (T)value;
        
        return (T)Convert.ChangeType(value, typeof(T));
    }

    private void SetPropertyValue(object obj, string propertyName, object? value)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property != null && property.CanWrite)
        {
            if (value != null && property.PropertyType != value.GetType())
            {
                // è™•ç†é¡å‹è½‰æ›
                if (property.PropertyType.IsGenericType && property.PropertyType.GetGenericTypeDefinition() == typeof(Nullable<>))
                {
                    var underlyingType = Nullable.GetUnderlyingType(property.PropertyType);
                    value = underlyingType != null ? Convert.ChangeType(value, underlyingType) : value;
                }
                else
                {
                    value = Convert.ChangeType(value, property.PropertyType);
                }
            }
            property.SetValue(obj, value);
        }
    }

    // ===== InteractiveTableComponent æ–¹æ³• =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // å•†å“é¸æ“‡æ¬„ä½ - ä½¿ç”¨ SearchableSelect é¡å‹
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å•†å“ç·¨è™Ÿ/åç¨±",
            PropertyName = "ProductSearchValue",
            EmptyCheckPropertyName = "SelectedProduct",
            TriggerEmptyRowOnFilled = true,
            ColumnType = InteractiveColumnType.SearchableSelect,
            Width = "250px",
            Tooltip = "æœå°‹ä¸¦é¸æ“‡è¦éŠ·å”®çš„å•†å“ã€‚å·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„çš„å•†å“å°‡ç„¡æ³•è®Šæ›´",
            Placeholder = "è«‹è¼¸å…¥å•†å“ç·¨è™Ÿæˆ–åç¨±",
            SearchValuePropertyName = nameof(SalesItem.ProductSearchValue),
            FilteredItemsPropertyName = nameof(SalesItem.FilteredProducts),
            ShowDropdownPropertyName = nameof(SalesItem.ShowProductDropdown),
            SelectedIndexPropertyName = nameof(SalesItem.ProductSelectedIndex),
            ItemDisplayFormatter = (item) =>
            {
                var product = (Product)item;
                return FormatProductDisplayText(product);
            },
            IsDisabledFunc = item =>
            {
                var salesItem = (SalesItem)item;
                var isEmptyRow = salesItem.SelectedProduct == null;
                return !CanDeleteItem(salesItem, out _) && !isEmptyRow;
            },
            TooltipFunc = item =>
            {
                var salesItem = (SalesItem)item;
                if (!CanDeleteItem(salesItem, out string reason))
                    return reason;
                return null;
            },
            OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, (tuple) =>
            {
                var (item, searchValue) = tuple;
                OnProductSearchInput((SalesItem)item, searchValue);
            }),
            OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
            {
                var (item, selectedItem) = tuple;
                await OnProductSelectItem((SalesItem)item, (Product?)selectedItem);
            }),
            OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnProductFocus((SalesItem)item);
            }),
            OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnProductBlur((SalesItem)item);
            }),
            EnableKeyboardNavigation = true,
            GetDropdownItems = (item) => ((SalesItem)item).FilteredProducts,
            GetSelectedIndex = (item) => ((SalesItem)item).ProductSelectedIndex,
            SetSelectedIndex = (item, index) => ((SalesItem)item).ProductSelectedIndex = index,
            GetShowDropdown = (item) => ((SalesItem)item).ShowProductDropdown,
            SetShowDropdown = (item, show) => ((SalesItem)item).ShowProductDropdown = show,
            MaxDisplayItems = 20
        });
        
        // è¨‚å–®æ•¸é‡æ¬„ä½ - ä½¿ç”¨ CanDeleteItem çµ±ä¸€æª¢æŸ¥ï¼ˆå‡ºè²¨ã€æ’ç¨‹ã€é€€è²¨ã€æ”¶æ¬¾ï¼‰
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "è¨‚å–®æ•¸é‡", 
            PropertyName = nameof(SalesItem.OrderQuantity),
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            Tooltip = "éŠ·å”®çš„å•†å“æ•¸é‡ã€‚å·²æœ‰ä¸‹ä¸€æ­¥å‹•ä½œçš„å•†å“å°‡ç„¡æ³•ä¿®æ”¹æ•¸é‡",
            IsDisabledFunc = item =>
            {
                var salesItem = (SalesItem)item;
                var isEmptyRow = salesItem.SelectedProduct == null;
                return !CanDeleteItem(salesItem, out _) && !isEmptyRow;
            },
            TooltipFunc = item =>
            {
                var salesItem = (SalesItem)item;
                if (CanDeleteItem(salesItem, out string reason))
                    return null;
                return reason + "ï¼Œç„¡æ³•ä¿®æ”¹è¨‚å–®æ•¸é‡";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnOrderQuantityInput((SalesItem)item, valueString);
            })
        });

        // éŠ·è²¨æ•¸é‡æ¬„ä½ï¼ˆå·²å‡ºè²¨æ•¸é‡ï¼‰- å”¯è®€é¡¯ç¤º
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "éŠ·è²¨æ•¸é‡",
            PropertyName = nameof(SalesItem.DeliveredQuantity),
            ColumnType = InteractiveColumnType.Display,
            Width = "100px",
            SmartDecimalDisplay = true,
            TextAlign = "right",
            HideOnMobile = true,
            Tooltip = "å·²å‡ºè²¨çš„æ•¸é‡ï¼ˆå”¯è®€ï¼‰"
        });

        // å–®åƒ¹æ¬„ä½ - ä½¿ç”¨ CanDeleteItem çµ±ä¸€æª¢æŸ¥ï¼ˆå‡ºè²¨ã€æ’ç¨‹ã€é€€è²¨ã€æ”¶æ¬¾ï¼‰
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å–®åƒ¹", 
            PropertyName = nameof(SalesItem.UnitPrice),
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            Tooltip = "å•†å“çš„éŠ·å”®å–®åƒ¹ã€‚å·²æœ‰ä¸‹ä¸€æ­¥å‹•ä½œçš„å•†å“å°‡ç„¡æ³•ä¿®æ”¹åƒ¹æ ¼",
            IsDisabledFunc = item =>
            {
                var salesItem = (SalesItem)item;
                var isEmptyRow = salesItem.SelectedProduct == null;
                return !CanDeleteItem(salesItem, out _) && !isEmptyRow;
            },
            TooltipFunc = item =>
            {
                var salesItem = (SalesItem)item;
                if (CanDeleteItem(salesItem, out string reason))
                    return null;
                return reason + "ï¼Œç„¡æ³•ä¿®æ”¹å–®åƒ¹";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnUnitPriceInput((SalesItem)item, valueString);
            })
        });        

        // æŠ˜æ‰£æ¬„ä½ - ä½¿ç”¨ CanDeleteItem çµ±ä¸€æª¢æŸ¥ï¼ˆå‡ºè²¨ã€æ’ç¨‹ã€é€€è²¨ã€æ”¶æ¬¾ï¼‰
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "æŠ˜æ‰£%", 
            PropertyName = nameof(SalesItem.DiscountPercentage),
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            HideOnMobile = true,
            Tooltip = "æŠ˜æ‰£ç™¾åˆ†æ¯”ï¼ˆ0-100%ï¼‰ã€‚å·²æœ‰ä¸‹ä¸€æ­¥å‹•ä½œçš„å•†å“å°‡ç„¡æ³•ä¿®æ”¹æŠ˜æ‰£",
            IsDisabledFunc = item =>
            {
                var salesItem = (SalesItem)item;
                var isEmptyRow = salesItem.SelectedProduct == null;
                return !CanDeleteItem(salesItem, out _) && !isEmptyRow;
            },
            TooltipFunc = item =>
            {
                var salesItem = (SalesItem)item;
                if (CanDeleteItem(salesItem, out string reason))
                    return null;
                return reason + "ï¼Œç„¡æ³•ä¿®æ”¹æŠ˜æ‰£";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnDiscountPercentageInput((SalesItem)item, valueString);
            })
        });
        
        // ç¨…ç‡æ¬„ä½ - ä½¿ç”¨ CanDeleteItem çµ±ä¸€æª¢æŸ¥ï¼ˆå‡ºè²¨ã€æ’ç¨‹ã€é€€è²¨ã€æ”¶æ¬¾ï¼‰ï¼Œå…ç¨…æ¨¡å¼å–®ç¨åˆ¤æ–·
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "ç¨…ç‡%", 
            PropertyName = nameof(SalesItem.TaxRate),
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            HideOnMobile = true,
            Tooltip = "ç¨…ç‡ç™¾åˆ†æ¯”ï¼ˆ0-100%ï¼‰",
            IsDisabledFunc = item =>
            {
                var salesItem = (SalesItem)item;
                var isEmptyRow = salesItem.SelectedProduct == null;
                // å…ç¨…æ¨¡å¼ æˆ– å·²æœ‰ä¸‹ä¸€æ­¥å‹•ä½œæ™‚ç¦ç”¨
                return IsTaxCalculationMethodNoTax ||
                       (!CanDeleteItem(salesItem, out _) && !isEmptyRow);
            },
            TooltipFunc = item =>
            {
                var salesItem = (SalesItem)item;
                
                // å…ç¨…æ™‚é¡¯ç¤ºç‰¹æ®Šæç¤º
                if (IsTaxCalculationMethodNoTax)
                    return "ä¸»æª”è¨­å®šç‚ºã€Œä¸å«ç¨…ã€ï¼Œç¨…ç‡æ¬„ä½å·²ç¦ç”¨";
                
                if (CanDeleteItem(salesItem, out string reason))
                    return null;
                    
                return reason + "ï¼Œç„¡æ³•ä¿®æ”¹ç¨…ç‡";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnTaxRateInput((SalesItem)item, valueString);
            })
        });

        // å°è¨ˆæ¬„ä½ï¼ˆæ ¹æ“šç¨…åˆ¥è¨ˆç®—ï¼‰
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å°è¨ˆ",
            Tooltip = GetSubtotalTooltip(),
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item =>
            {
                var salesItem = (SalesItem)item;
                var subtotal = CalculateItemSubtotal(salesItem);
                var displayValue = NumberFormatHelper.FormatSmartZeroAsEmpty(subtotal);
                return @<div class="text-end fw-bold text-success">@displayValue</div>;
            }
        });

        // å‚™è¨»æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å‚™è¨»", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "150px",
            HideOnMobile = true,
            Tooltip = "é¸å¡«ã€‚å¯è¨˜éŒ„éŠ·è²¨ç›¸é—œçš„å‚™è¨»è³‡è¨Š",
            CustomTemplate = item => 
            {
                var salesItem = (SalesItem)item;
                
                return @<input type="text" class="form-control "
                              value="@salesItem.DetailRemarks"
                              @oninput="(e) => OnRemarksInput(salesItem, e.Value?.ToString())"
                              readonly="@IsReadOnly"/>;
            }
        });

        return columns;
    }

    private RenderFragment<SalesItem> GetCustomActionsTemplate => item => __builder =>
    {
        var salesItem = (SalesItem)item;
        var isEmptyRow = salesItem.SelectedProduct == null;
        var canDelete = CanDeleteItem(item, out _);
        var hasComposition = salesItem.SelectedProduct != null && HasProductComposition(salesItem.SelectedProduct.Id);
        var isCompositionReadOnly = GetCompositionModalReadOnlyState();
        
        <div class="d-flex gap-1">
            @* BOM ç·¨è¼¯/æŸ¥çœ‹æŒ‰éˆ•ï¼ˆå¦‚æœå•†å“æœ‰ BOM çµ„æˆï¼‰ *@
            @if (hasComposition && !isEmptyRow)
            {
                var buttonTitle = isCompositionReadOnly ? "æŸ¥çœ‹ BOM çµ„æˆ" : "ç·¨è¼¯ BOM çµ„æˆ";
                var buttonVariant = isCompositionReadOnly ? ButtonVariant.Blue : ButtonVariant.DarkBlue;
                
                <GenericButtonComponent Variant="@buttonVariant"
                                       IconClass="bi bi-diagram-3 text-white"
                                       Size="ButtonSize.Large"
                                       Title="@buttonTitle"
                                       OnClick="() => ShowCompositionEditor(salesItem)"
                                       StopPropagation="true"
                                       CssClass="btn-square" />
            }
            
            @* åŸæœ‰çš„åˆªé™¤/æŸ¥çœ‹æŒ‰éˆ• *@
            @if (canDelete)
            {
                // å¯ä»¥åˆªé™¤ï¼šé¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
                <GenericButtonComponent Variant="ButtonVariant.Red"
                                       IconClass="bi bi-trash text-white"
                                       Size="ButtonSize.Large"
                                       IsDisabled="@IsReadOnly"
                                       Title="åˆªé™¤"
                                       OnClick="async () => await HandleItemDelete(item)"
                                       StopPropagation="true"
                                       CssClass="btn-square" />
            }
            else
            {
                // ä¸èƒ½åˆªé™¤ï¼šé¡¯ç¤ºæŸ¥çœ‹æŒ‰éˆ•
                <GenericButtonComponent Variant="ButtonVariant.Blue"
                                       IconClass="bi bi-eye text-white"
                                       Size="ButtonSize.Large"
                                       Title="æŸ¥çœ‹ç›¸é—œå–®æ“š"
                                       OnClick="async () => await ShowRelatedDocuments(item)"
                                       StopPropagation="true"
                                       CssClass="btn-square" />
            }
        </div>
    };

    private async Task HandleItemDelete(SalesItem item)
    {
        // ä½¿ç”¨ç¶œåˆæª¢æŸ¥æ–¹æ³•ï¼Œç¢ºèªæ˜¯å¦å¯ä»¥åˆªé™¤
        if (!CanDeleteItem(item, out string reason))
        {
            await NotificationService.ShowWarningAsync(reason, "æ“ä½œé™åˆ¶");
            return;
        }
        
        var index = SalesItems.IndexOf(item);
        await RemoveItemAsync(index);
    }

    /// <summary>
    /// é¡¯ç¤ºç›¸é—œå–®æ“šï¼ˆé€€è²¨å–®å’Œæ²–æ¬¾å–®ï¼‰
    /// </summary>
    private async Task ShowRelatedDocuments(SalesItem item)
    {
        // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰çš„æ˜ç´°å¯¦é«” ID
        if (item.ExistingDetailEntity is not SalesOrderDetail detail || detail.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("æ­¤é …ç›®å°šæœªå„²å­˜ï¼Œç„¡æ³•æŸ¥çœ‹ç›¸é—œå–®æ“š", "æç¤º");
            return;
        }

        // è¨­å®šå•†å“åç¨±
        selectedProductName = item.SelectedProduct?.Name ?? "æœªçŸ¥å•†å“";

        // é¡¯ç¤º Modal ä¸¦é–‹å§‹è¼‰å…¥
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            // æŸ¥è©¢ç›¸é—œå–®æ“š
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsForSalesOrderDetailAsync(detail.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ç›¸é—œå–®æ“šå¤±æ•—ï¼š{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// è™•ç†é»æ“Šç›¸é—œå–®æ“šçš„äº‹ä»¶
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // è§¸ç™¼äº‹ä»¶ï¼Œè®“çˆ¶çµ„ä»¶ï¼ˆEditModalï¼‰è™•ç†é–‹å•Ÿç›¸é—œå–®æ“š
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            // å¦‚æœçˆ¶çµ„ä»¶æ²’æœ‰è™•ç†ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
            await NotificationService.ShowInfoAsync(
                $"è«‹åœ¨ä¸»ç•«é¢ä¸­é–‹å•Ÿ {document.TypeDisplayName}: {document.DocumentNumber}", 
                "æç¤º"
            );
        }
    }

    private List<Product> GetAvailableProducts()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
        {
            return new List<Product>();
        }
        
        return AvailableProducts;
    }

    private decimal GetTotalAmount()
    {
        return SalesItems
            .Where(item => item.SelectedProduct != null)
            .Sum(item => item.Subtotal);
    }

    public class SalesItem
    {
        public Product? SelectedProduct { get; set; }
        public decimal OrderQuantity { get; set; } = 0;
        public decimal DeliveredQuantity { get; set; } = 0;
        public decimal UnitPrice { get; set; } = 0;
        public decimal DiscountPercentage { get; set; } = 0;
        public decimal Subtotal { get; set; } = 0;
        public decimal TaxRate { get; set; } = 0;
        public string DetailRemarks { get; set; } = string.Empty;
        public TDetailEntity? ExistingDetailEntity { get; set; }
        
        // === å ±åƒ¹å–®ä¾†æºç›¸é—œå±¬æ€§ ===
        public int? SourceQuotationId { get; set; }
        public int? SourceQuotationDetailId { get; set; }
        public bool? IsQuotationApproved { get; set; }
        
        /// <summary>
        /// è‡ªè¨‚çš„ BOM çµ„åˆæ˜ç´°ï¼ˆç”¨æ–¼æš«å­˜ç·¨è¼¯çµæœï¼‰
        /// </summary>
        public List<SalesOrderCompositionDetail>? CustomCompositionDetails { get; set; }
        
        /// <summary>
        /// é¸æ“‡çš„é…æ–¹ IDï¼ˆnull è¡¨ç¤ºè‡ªå®šç¾©æ¨¡å¼ï¼‰
        /// </summary>
        public int? SelectedCompositionId { get; set; }
        
        /// <summary>
        /// æ˜¯å¦ç‚ºè‡ªå®šç¾©çµ„åˆæ¨¡å¼
        /// </summary>
        public bool IsCustomComposition { get; set; }
        
        /// <summary>
        /// è¨ˆç®—å±¬æ€§ï¼šæ˜¯å¦å·²æœ‰ BOM çµ„åˆè³‡æ–™
        /// </summary>
        public bool HasCompositionData => CustomCompositionDetails?.Any() == true;
        
        // === SearchableSelect æ”¯æ´å±¬æ€§ ===
        public string ProductSearchValue { get; set; } = string.Empty;
        public List<Product> FilteredProducts { get; set; } = new();
        public bool ShowProductDropdown { get; set; } = false;
        public int ProductSelectedIndex { get; set; } = -1;
        
        /// <summary>
        /// è¨ˆç®—å°è¨ˆ
        /// </summary>
        public void CalculateSubtotal()
        {
            // å°è¨ˆ = æ•¸é‡ Ã— å–®åƒ¹ Ã— (1 - æŠ˜æ‰£% / 100)
            // ä¾‹å¦‚ï¼š50 Ã— 62 Ã— (1 - 1/100) = 50 Ã— 62 Ã— 0.99 = 3069
            Subtotal = Math.Round(OrderQuantity * UnitPrice * (1 - DiscountPercentage / 100), 2);
            
            // ç¢ºä¿å°è¨ˆä¸ç‚ºè² æ•¸
            if (Subtotal < 0) Subtotal = 0;
        }
        
        /// <summary>
        /// å–å¾—é¡¯ç¤ºç”¨çš„å•†å“åç¨±
        /// </summary>
        public string DisplayName => 
            SelectedProduct != null 
                ? $"{SelectedProduct.Code} - {SelectedProduct.Name}" 
                : "";
    }

    // ===== äº‹ä»¶è™•ç†æ–¹æ³• =====
    
    // ===== å•†å“ SearchableSelect äº‹ä»¶è™•ç† =====
    
    /// <summary>
    /// å•†å“æœå°‹è¼¸å…¥è™•ç†
    /// </summary>
    private void OnProductSearchInput(SalesItem item, string? searchValue)
    {
        item.ProductSearchValue = searchValue ?? string.Empty;
        
        var availableProducts = GetAvailableProducts();
        
        // ç¢ºä¿ç•¶å‰é¸ä¸­çš„å•†å“ä¹Ÿåœ¨åˆ—è¡¨ä¸­
        if (item.SelectedProduct != null && 
            !availableProducts.Any(p => p.Id == item.SelectedProduct.Id))
        {
            availableProducts = new List<Product>(availableProducts) { item.SelectedProduct };
        }
        
        if (string.IsNullOrWhiteSpace(searchValue))
        {
            item.FilteredProducts = availableProducts.Take(20).ToList();
        }
        else
        {
            item.FilteredProducts = availableProducts
                .Where(p => 
                    (p.Code?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (p.Name?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false))
                .Take(20)
                .ToList();
        }
        
        item.ShowProductDropdown = true;
        item.ProductSelectedIndex = -1;
        StateHasChanged();
    }
    
    /// <summary>
    /// å•†å“è¼¸å…¥æ¡†ç²å¾—ç„¦é»
    /// </summary>
    private void OnProductFocus(SalesItem item)
    {
        var availableProducts = GetAvailableProducts();
        
        // ç¢ºä¿ç•¶å‰é¸ä¸­çš„å•†å“ä¹Ÿåœ¨åˆ—è¡¨ä¸­
        if (item.SelectedProduct != null && 
            !availableProducts.Any(p => p.Id == item.SelectedProduct.Id))
        {
            availableProducts = new List<Product>(availableProducts) { item.SelectedProduct };
        }
        
        item.FilteredProducts = availableProducts.Take(20).ToList();
        item.ShowProductDropdown = true;
        item.ProductSelectedIndex = -1;
        StateHasChanged();
    }
    
    /// <summary>
    /// å•†å“è¼¸å…¥æ¡†å¤±å»ç„¦é»
    /// </summary>
    private void OnProductBlur(SalesItem item)
    {
        Task.Delay(200).ContinueWith(_ =>
        {
            item.ShowProductDropdown = false;
            InvokeAsync(StateHasChanged);
        });
    }
    
    /// <summary>
    /// é¸æ“‡å•†å“é …ç›®
    /// </summary>
    private async Task OnProductSelectItem(SalesItem item, Product? selectedProduct)
    {
        if (selectedProduct == null)
        {
            item.SelectedProduct = null;
            item.ProductSearchValue = string.Empty;
            item.ShowProductDropdown = false;
            item.ProductSelectedIndex = -1;
            await NotifyDetailsChanged();
            return;
        }
        
        item.SelectedProduct = selectedProduct;
        item.ProductSearchValue = FormatProductDisplayText(selectedProduct);
        item.ShowProductDropdown = false;
        item.ProductSelectedIndex = -1;
        
        // è‡ªå‹•å¸¶å…¥å•†å“ç¨…ç‡ï¼ˆå„ªå…ˆä½¿ç”¨å•†å“ç¨…ç‡ï¼Œæ²’æœ‰å‰‡ä½¿ç”¨ç³»çµ±é è¨­å€¼ï¼‰
        item.TaxRate = selectedProduct.TaxRate ?? await SystemParameterService.GetTaxRateAsync();
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }
    
    /// <summary>
    /// æ ¼å¼åŒ–å•†å“é¡¯ç¤ºæ–‡å­—ï¼ˆç”¨æ–¼ä¸‹æ‹‰é¸å–®ï¼‰
    /// </summary>
    private string FormatProductDisplayText(Product product)
    {
        if (product == null) return "";
        
        return !string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name)
            ? $"[{product.Code}] {product.Name}"
            : (!string.IsNullOrEmpty(product.Code) ? $"[{product.Code}]" : product.Name ?? "");
    }
    
    // ===== å•†å“é¸æ“‡äº‹ä»¶è™•ç†ï¼ˆèˆŠæ–¹æ³•ï¼Œä¿ç•™ä»¥é˜²å…¶ä»–åœ°æ–¹ä½¿ç”¨ï¼‰ =====
    private async Task OnProductChanged(SalesItem item, object? value)
    {
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹
        if (!CanDeleteItem(item, out string reason))
        {
            await NotificationService.ShowWarningAsync(
                "ç„¡æ³•ä¿®æ”¹å•†å“",
                reason
            );
            StateHasChanged(); // å¼·åˆ¶é‡æ–°æ¸²æŸ“ä»¥æ¢å¾©åŸå€¼
            return;
        }
        
        var productIdStr = value?.ToString();
        if (string.IsNullOrEmpty(productIdStr))
        {
            item.SelectedProduct = null;
        }
        else if (int.TryParse(productIdStr, out var productId))
        {
            var product = GetAvailableProducts().FirstOrDefault(p => p.Id == productId);
            item.SelectedProduct = product;
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnOrderQuantityInput(SalesItem item, string? value)
    {
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹
        if (!CanDeleteItem(item, out string reason))
        {
            var friendlyMessage = HasReturnRecord(item)
                ? "æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹æ•¸é‡"
                : "æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹æ•¸é‡";
            
            await NotificationService.ShowWarningAsync(friendlyMessage, "æ“ä½œé™åˆ¶");
            return;
        }
        
        if (string.IsNullOrEmpty(value))
        {
            item.OrderQuantity = 0;
        }
        else if (decimal.TryParse(value, out var quantity))
        {
            item.OrderQuantity = quantity;
        }
        
        item.CalculateSubtotal();
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnUnitPriceInput(SalesItem item, string? value)
    {
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹
        if (!CanDeleteItem(item, out string reason))
        {
            var friendlyMessage = HasReturnRecord(item)
                ? "æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹å–®åƒ¹"
                : "æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹å–®åƒ¹";
            
            await NotificationService.ShowWarningAsync(friendlyMessage, "æ“ä½œé™åˆ¶");
            return;
        }
        
        if (string.IsNullOrEmpty(value))
        {
            item.UnitPrice = 0;
        }
        else if (decimal.TryParse(value, out var price))
        {
            item.UnitPrice = price;
        }
        
        item.CalculateSubtotal();
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnDiscountPercentageInput(SalesItem item, string? value)
    {
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹
        if (!CanDeleteItem(item, out string reason))
        {
            var friendlyMessage = HasReturnRecord(item)
                ? "æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹æŠ˜æ‰£"
                : "æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹æŠ˜æ‰£";
            
            await NotificationService.ShowWarningAsync(friendlyMessage, "æ“ä½œé™åˆ¶");
            return;
        }
        
        item.DiscountPercentage = InputEventHelper.HandlePercentageInput(value, 0, 100, 0);
        
        // é‡æ–°è¨ˆç®—å°è¨ˆï¼ˆæœƒæ ¹æ“šæŠ˜æ‰£ç™¾åˆ†æ¯”è¨ˆç®—ï¼‰
        item.CalculateSubtotal();
        
        // é€šçŸ¥çˆ¶çµ„ä»¶è³‡æ–™å·²è®Šæ›´ï¼ˆé€™æœƒè§¸ç™¼ HandleDetailsChangedï¼‰
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    /// <summary>
    /// è™•ç†ç¨…ç‡è¼¸å…¥
    /// </summary>
    private async Task OnTaxRateInput(SalesItem item, string? valueString)
    {
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹
        if (!CanDeleteItem(item, out string reason))
        {
            var friendlyMessage = HasReturnRecord(item)
                ? "æ­¤å•†å“å·²æœ‰é€€è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹ç¨…ç‡"
                : "æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹ç¨…ç‡";
            
            await NotificationService.ShowWarningAsync(friendlyMessage, "æ“ä½œé™åˆ¶");
            return;
        }
        
        item.TaxRate = InputEventHelper.HandlePercentageInput(valueString, 0, 100, 0);
        
        // é€šçŸ¥çˆ¶çµ„ä»¶è³‡æ–™å·²è®Šæ›´
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// è¨ˆç®—æ˜ç´°é …ç›®çš„å°è¨ˆï¼ˆæ ¹æ“šç¨…åˆ¥ï¼Œå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
    /// </summary>
    private decimal CalculateItemSubtotal(SalesItem item)
    {
        if (item.SelectedProduct == null || item.OrderQuantity <= 0 || item.UnitPrice <= 0)
            return 0;

        var subtotal = CalculationHelper.CalculateSubtotal(
            item.OrderQuantity,
            item.UnitPrice,
            item.DiscountPercentage,
            item.TaxRate,
            TaxCalculationMethod
        );
        
        // å››æ¨äº”å…¥åˆ°æ•´æ•¸
        return CalculationHelper.Round(subtotal, 0);
    }

    /// <summary>
    /// å–å¾—å°è¨ˆæ¬„ä½çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetSubtotalTooltip()
    {
        return TaxCalculationMethod switch
        {
            TaxCalculationMethod.TaxExclusive => "å°è¨ˆï¼ˆå«ç¨…ï¼‰= æ•¸é‡ Ã— å–®åƒ¹ Ã— (1 - æŠ˜æ‰£%) Ã— (1 + ç¨…ç‡%)",
            TaxCalculationMethod.TaxInclusive => "å°è¨ˆï¼ˆå«ç¨…ï¼‰= æ•¸é‡ Ã— å–®åƒ¹ Ã— (1 - æŠ˜æ‰£%)ï¼ˆå–®åƒ¹å·²å…§å«ç¨…ï¼‰",
            TaxCalculationMethod.NoTax => "å°è¨ˆï¼ˆæœªç¨…ï¼‰= æ•¸é‡ Ã— å–®åƒ¹ Ã— (1 - æŠ˜æ‰£%)ï¼ˆå…ç¨…ï¼‰",
            _ => "å°è¨ˆ"
        };
    }

    private async Task OnRemarksInput(SalesItem item, string? value)
    {
        item.DetailRemarks = value ?? string.Empty;
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    public async Task RemoveItemAsync(int index)
    {
        if (IsReadOnly || index < 0 || index >= SalesItems.Count) return;
        
        var removedItem = SalesItems[index];
        
        // è¨˜éŒ„è¦åˆªé™¤çš„è³‡æ–™åº«å¯¦é«”ID
        if (removedItem.ExistingDetailEntity != null)
        {
            var entityId = GetExistingDetailId(removedItem.ExistingDetailEntity!);
            if (entityId > 0)
            {
                _deletedDetailIds.Add(entityId);
            }
        }
        
        // é€šçŸ¥çˆ¶çµ„ä»¶é …ç›®å³å°‡è¢«ç§»é™¤
        if (OnItemRemoved.HasDelegate)
        {
            await OnItemRemoved.InvokeAsync(removedItem);
        }
        
        SalesItems.RemoveAt(index);
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    /// <summary>
    /// å–å¾—ç¾æœ‰æ˜ç´°å¯¦é«”çš„ID
    /// </summary>
    private int GetExistingDetailId(TDetailEntity entity)
    {
        if (entity == null) return 0;
        
        // å‡è¨­æ‰€æœ‰çš„ BaseEntity éƒ½æœ‰ Id å±¬æ€§
        var idProperty = entity.GetType().GetProperty("Id");
        if (idProperty != null && idProperty.PropertyType == typeof(int))
        {
            return (int)(idProperty.GetValue(entity) ?? 0);
        }
        
        return 0;
    }

    // ===== æ¥­å‹™é‚è¼¯æ–¹æ³• =====
    
    /// <summary>
    /// æ¸…ç©ºæ‰€æœ‰éŠ·è²¨æ˜ç´°ï¼ˆåªç§»é™¤æœªé–å®šçš„æ˜ç´°ï¼Œä¿ç•™å·²é–å®šçš„ï¼‰
    /// </summary>
    private async Task ClearAllDetails()
    {
        if (IsReadOnly) return;
        
        var nonEmptyItems = SalesItems.Where(item => item.SelectedProduct != null).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("æ²’æœ‰å¯ç§»é™¤çš„æ˜ç´°é …ç›®", "æç¤º");
            return;
        }
        
        // å€åˆ†å¯åˆªé™¤å’Œè¢«é–å®šçš„æ˜ç´°
        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
        
        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "æ‰€æœ‰æ˜ç´°éƒ½å·²æœ‰é€€è²¨æˆ–æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ç§»é™¤", 
                "æ“ä½œé™åˆ¶");
            return;
        }
        
        // é€šçŸ¥çˆ¶çµ„ä»¶é …ç›®å³å°‡è¢«ç§»é™¤
        if (OnItemRemoved.HasDelegate)
        {
            foreach (var item in unlocked)
            {
                await OnItemRemoved.InvokeAsync(item);
            }
        }
        
        // è¨˜éŒ„æ‰€æœ‰è¦åˆªé™¤çš„ç¾æœ‰æ˜ç´° ID
        foreach (var item in unlocked.Where(item => item.ExistingDetailEntity != null))
        {
            var entityId = GetExistingDetailId(item.ExistingDetailEntity!);
            if (entityId > 0)
            {
                _deletedDetailIds.Add(entityId);
            }
        }
        
        // å¾åˆ—è¡¨ä¸­ç§»é™¤æœªé–å®šçš„é …ç›®ï¼Œä¿ç•™å·²é–å®šçš„é …ç›®
        foreach (var item in unlocked)
        {
            SalesItems.Remove(item);
        }
        
        await NotifyDetailsChanged();
        
        var message = $"å·²ç§»é™¤ {unlocked.Count} é …æ˜ç´°";
        if (locked.Any())
        {
            message += $"\nï¼ˆå·²ä¿ç•™ {locked.Count} é …å·²é–å®šçš„æ˜ç´°ï¼‰";
        }
        await NotificationService.ShowSuccessAsync(message);
    }

    /// <summary>
    /// è¼‰å…¥æ™ºèƒ½ä¸‹å–®é …ç›® - æ ¹æ“šå®¢æˆ¶æœ€è¿‘ä¸€æ¬¡å®Œæ•´çš„éŠ·è²¨è¨‚å–®
    /// </summary>
    /// <summary>
    /// è¼‰å…¥å ±åƒ¹å–®æ˜ç´°åˆ°éŠ·è²¨è¨‚å–®æ˜ç´°è¡¨
    /// </summary>
    private async Task LoadQuotationItems()
    {
        if (IsReadOnly || !SelectedCustomerId.HasValue || !SelectedQuotationId.HasValue) return;
        
        try
        {
            // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰è³‡æ–™
            var hasExistingData = SalesItems.Any(item => item.SelectedProduct != null);
            
            if (hasExistingData)
            {
                if (!await ShowConfirmationAsync("è¼‰å…¥å ±åƒ¹æ˜ç´°", "æ­¤æ“ä½œå°‡è¦†è“‹ç¾æœ‰çš„éŠ·è²¨æ˜ç´°ï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ"))
                {
                    return;
                }
            }

            // å¾æœå‹™ç²å–å ±åƒ¹å–®è³‡æ–™
            var quotation = await QuotationService.GetWithDetailsAsync(SelectedQuotationId.Value);
            
            if (quotation == null)
            {
                await NotificationService.ShowWarningAsync("æ‰¾ä¸åˆ°æŒ‡å®šçš„å ±åƒ¹å–®", "è¼‰å…¥å¤±æ•—");
                return;
            }
            
            // é©—è­‰å ±åƒ¹å–®çš„å®¢æˆ¶æ˜¯å¦èˆ‡é¸æ“‡çš„å®¢æˆ¶ä¸€è‡´
            if (quotation.CustomerId != SelectedCustomerId.Value)
            {
                await NotificationService.ShowWarningAsync("å ±åƒ¹å–®çš„å®¢æˆ¶èˆ‡ç•¶å‰é¸æ“‡çš„å®¢æˆ¶ä¸ä¸€è‡´", "è¼‰å…¥å¤±æ•—");
                return;
            }
            
            if (quotation.QuotationDetails == null || !quotation.QuotationDetails.Any())
            {
                await NotificationService.ShowInfoAsync("å ±åƒ¹å–®æ²’æœ‰æ˜ç´°è³‡æ–™", "è¼‰å…¥å¤±æ•—");
                return;
            }

            // æ¸…ç©ºç¾æœ‰é …ç›®
            SalesItems.Clear();
            _deletedDetailIds.Clear();

            // å°‡å ±åƒ¹å–®æ˜ç´°è½‰æ›ç‚ºéŠ·è²¨é …ç›®
            var loadedCount = 0;
            foreach (var quotationDetail in quotation.QuotationDetails)
            {
                // åªè¼‰å…¥å°šæœªè½‰å–®çš„æ•¸é‡ï¼ˆå ±åƒ¹æ•¸é‡ - å·²è½‰æ•¸é‡ï¼‰
                var pendingQuantity = quotationDetail.Quantity - quotationDetail.ConvertedQuantity;
                
                // å¦‚æœè©²æ˜ç´°å·²ç¶“å…¨éƒ¨è½‰å®Œï¼Œè·³éä¸è¼‰å…¥
                if (pendingQuantity <= 0)
                {
                    continue;
                }
                
                var salesItem = new SalesItem
                {
                    SelectedProduct = quotationDetail.Product,
                    OrderQuantity = pendingQuantity,
                    UnitPrice = quotationDetail.UnitPrice,
                    DiscountPercentage = quotationDetail.DiscountPercentage,
                    TaxRate = quotationDetail.TaxRate ?? quotationDetail.Product?.TaxRate ?? await SystemParameterService.GetTaxRateAsync(),
                    DetailRemarks = quotationDetail.Remarks ?? "",
                    // è¨­å®šå ±åƒ¹å–®ä¾†æºè³‡è¨Š
                    SourceQuotationId = SelectedQuotationId.Value,
                    SourceQuotationDetailId = quotationDetail.Id,
                    IsQuotationApproved = quotation.IsApproved
                };
                
                // åˆå§‹åŒ– ProductSearchValue
                if (salesItem.SelectedProduct != null)
                {
                    salesItem.ProductSearchValue = FormatProductDisplayText(salesItem.SelectedProduct);
                }
                
                // è¨ˆç®—å°è¨ˆ
                salesItem.CalculateSubtotal();
                
                SalesItems.Add(salesItem);
                loadedCount++;
            }
            
            await NotifyDetailsChanged();
            
            if (loadedCount > 0)
            {
                await NotificationService.ShowSuccessAsync($"å·²è¼‰å…¥ {loadedCount} é …æœªè½‰å®Œçš„å ±åƒ¹æ˜ç´°", "è¼‰å…¥æˆåŠŸ");
            }
            else
            {
                await NotificationService.ShowInfoAsync("æ‰€æœ‰å ±åƒ¹æ˜ç´°éƒ½å·²å®Œæˆè½‰å–®ï¼Œç„¡éœ€å†è½‰å–®", "æç¤º");
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadQuotationItems), GetType());
            await NotificationService.ShowErrorAsync("è¼‰å…¥å ±åƒ¹å–®æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤", "éŒ¯èª¤");
        }
    }
    
    private async Task LoadSmartOrderItems()
    {
        if (IsReadOnly || !SelectedCustomerId.HasValue) return;
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰è³‡æ–™
        var hasExistingData = SalesItems.Any(item => item.SelectedProduct != null);
        
        if (hasExistingData)
        {
            if (!await ShowConfirmationAsync("è¼‰å…¥æ™ºèƒ½ä¸‹å–®", "æ­¤æ“ä½œå°‡è¦†è“‹ç¾æœ‰çš„éŠ·è²¨æ˜ç´°ï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ"))
            {
                return;
            }
        }

        // å¾æœå‹™ç²å–å®¢æˆ¶çš„æœ€è¿‘ä¸€æ¬¡å®Œæ•´éŠ·è²¨
        var lastSalesDetails = await SalesOrderDetailService.GetLastCompleteSalesAsync(SelectedCustomerId.Value);
        
        if (!lastSalesDetails.Any())
        {
            await NotificationService.ShowInfoAsync("è©²å®¢æˆ¶æ²’æœ‰éŠ·è²¨æ­·å²ç´€éŒ„å¯åƒè€ƒ", "æ™ºèƒ½ä¸‹å–®");
            return;
        }

        // æ¸…ç©ºç¾æœ‰é …ç›®
        SalesItems.Clear();
        _deletedDetailIds.Clear();

        // å°‡æ­·å²éŠ·è²¨è½‰æ›ç‚ºæ–°çš„éŠ·è²¨é …ç›®
        foreach (var detail in lastSalesDetails)
        {
            var salesItem = new SalesItem
            {
                SelectedProduct = detail.Product,
                OrderQuantity = detail.OrderQuantity,
                UnitPrice = detail.UnitPrice,
                TaxRate = detail.TaxRate ?? detail.Product?.TaxRate ?? await SystemParameterService.GetTaxRateAsync(),
                DetailRemarks = detail.Remarks ?? ""
            };
            
            // åˆå§‹åŒ– ProductSearchValue
            if (salesItem.SelectedProduct != null)
            {
                salesItem.ProductSearchValue = FormatProductDisplayText(salesItem.SelectedProduct);
            }
            
            salesItem.CalculateSubtotal();
            SalesItems.Add(salesItem);
        }
        
        await NotifyDetailsChanged();
        await NotificationService.ShowSuccessAsync($"å·²è¼‰å…¥ {lastSalesDetails.Count} é …å•†å“ä½œç‚ºåƒè€ƒ", "æ™ºèƒ½ä¸‹å–®å®Œæˆ");
        
        StateHasChanged();
    }

    /// <summary>
    /// å¾å ±åƒ¹å–®è¼‰å…¥æ˜ç´°ï¼ˆå…¬é–‹æ–¹æ³•ï¼Œä¾›çˆ¶çµ„ä»¶å‘¼å«ï¼‰
    /// </summary>
    /// <param name="quotationDetails">å ±åƒ¹å–®æ˜ç´°åˆ—è¡¨</param>
    /// <param name="quotationId">å ±åƒ¹å–®ID</param>
    /// <param name="isQuotationApproved">å ±åƒ¹å–®æ˜¯å¦å·²å¯©æ ¸</param>
    public async Task LoadQuotationDetails(List<QuotationDetail> quotationDetails, int quotationId, bool isQuotationApproved)
    {
        if (IsReadOnly) return;
        
        try
        {
            if (quotationDetails == null || !quotationDetails.Any())
            {
                await NotificationService.ShowWarningAsync("å ±åƒ¹å–®æ²’æœ‰æ˜ç´°è³‡æ–™", "è¼‰å…¥å¤±æ•—");
                return;
            }

            // æ¸…ç©ºç¾æœ‰é …ç›®
            SalesItems.Clear();

            // å°‡å ±åƒ¹å–®æ˜ç´°è½‰æ›ç‚ºéŠ·è²¨é …ç›®
            foreach (var quotationDetail in quotationDetails)
            {
                //  é—œéµä¿®æ”¹ï¼šåªè¼‰å…¥å°šæœªè½‰å–®çš„æ•¸é‡ï¼ˆå ±åƒ¹æ•¸é‡ - å·²è½‰æ•¸é‡ï¼‰
                var pendingQuantity = quotationDetail.Quantity - quotationDetail.ConvertedQuantity;
                
                // å¦‚æœè©²æ˜ç´°å·²ç¶“å…¨éƒ¨è½‰å®Œï¼Œè·³éä¸è¼‰å…¥
                if (pendingQuantity <= 0)
                {
                    continue;
                }
                
                var salesItem = new SalesItem
                {
                    SelectedProduct = quotationDetail.Product,
                    OrderQuantity = pendingQuantity,  // ä½¿ç”¨å‰©é¤˜æ•¸é‡ï¼Œè€Œéå…¨éƒ¨æ•¸é‡
                    UnitPrice = quotationDetail.UnitPrice,
                    DiscountPercentage = quotationDetail.DiscountPercentage,
                    TaxRate = quotationDetail.TaxRate ?? quotationDetail.Product?.TaxRate ?? await SystemParameterService.GetTaxRateAsync(),
                    DetailRemarks = quotationDetail.Remarks ?? "",
                    // è¨­å®šå ±åƒ¹å–®ä¾†æºè³‡è¨Šï¼ˆç”¨æ–¼å¯©æ ¸æª¢æŸ¥å’Œè½‰å–®è¿½è¹¤ï¼‰
                    SourceQuotationId = quotationId,
                    SourceQuotationDetailId = quotationDetail.Id,
                    IsQuotationApproved = isQuotationApproved
                };
                
                // ğŸ”‘ è¼‰å…¥å ±åƒ¹å–®æ˜ç´°çš„ BOM çµ„æˆä¸¦è½‰æ›ç‚ºéŠ·è²¨è¨‚å–® BOM çµ„æˆ
                try
                {
                    var quotationCompositions = await QuotationCompositionDetailService.GetByQuotationDetailIdAsync(quotationDetail.Id);
                    
                    if (quotationCompositions?.Any() == true)
                    {
                        // è½‰æ› QuotationCompositionDetail ç‚º SalesOrderCompositionDetail
                        salesItem.CustomCompositionDetails = quotationCompositions.Select(qc => new SalesOrderCompositionDetail
                        {
                            ComponentProductId = qc.ComponentProductId,
                            ComponentProduct = qc.ComponentProduct,
                            Quantity = qc.Quantity,
                            UnitId = qc.UnitId,
                            Unit = qc.Unit,
                            ComponentCost = qc.ComponentCost,
                            Remarks = qc.Remarks,
                            Status = qc.Status
                        }).ToList();
                        
                        // ğŸ”‘ è¨­å®š BOM ç›¸é—œç‹€æ…‹ï¼ˆé‡è¦ï¼šè®“ Modal çŸ¥é“é€™æ˜¯è‡ªè¨‚çµ„åˆï¼‰
                        salesItem.IsCustomComposition = true;
                        salesItem.SelectedCompositionId = null; // è‡ªè¨‚çµ„åˆæ²’æœ‰é…æ–¹ ID
                    }
                }
                catch
                {
                    // BOM è¼‰å…¥å¤±æ•—ä¸å½±éŸ¿ä¸»æµç¨‹
                }
                
                // åˆå§‹åŒ– ProductSearchValue
                if (salesItem.SelectedProduct != null)
                {
                    salesItem.ProductSearchValue = FormatProductDisplayText(salesItem.SelectedProduct);
                }
                
                // è¨ˆç®—å°è¨ˆ
                salesItem.CalculateSubtotal();
                
                SalesItems.Add(salesItem);
            }
            
            await NotifyDetailsChanged();
            
            // è¨ˆç®—å¯¦éš›è¼‰å…¥çš„æ˜ç´°æ•¸é‡
            var loadedCount = SalesItems.Count(item => item.SelectedProduct != null);
            if (loadedCount > 0)
            {
                await NotificationService.ShowSuccessAsync($"å·²è¼‰å…¥ {loadedCount} é …æœªè½‰å®Œçš„å ±åƒ¹æ˜ç´°", "è¼‰å…¥æˆåŠŸ");
            }
            else
            {
                await NotificationService.ShowInfoAsync("æ‰€æœ‰å ±åƒ¹æ˜ç´°éƒ½å·²å®Œæˆè½‰å–®ï¼Œç„¡éœ€å†è½‰å–®", "æç¤º");
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadQuotationDetails), GetType());
            await NotificationService.ShowErrorAsync("è¼‰å…¥å ±åƒ¹å–®æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤", "éŒ¯èª¤");
        }
    }

    /// <summary>
    /// é¡¯ç¤ºç¢ºèªå°è©±æ¡†
    /// </summary>
    private async Task<bool> ShowConfirmationAsync(string title, string message)
    {
        // æš«æ™‚ä½¿ç”¨ç°¡å–®çš„é€šçŸ¥ï¼Œç­‰å¾…ç¢ºèªå¾ŒåŸ·è¡Œ
        // åœ¨å¯¦éš›å°ˆæ¡ˆä¸­å¯èƒ½æœƒä½¿ç”¨æ›´ç²¾ç¾çš„å°è©±æ¡†çµ„ä»¶
        try 
        {
            await NotificationService.ShowInfoAsync(message, title);
            return true;
        }
        catch
        {
            return false;
        }
    }

    /// <summary>
    /// é©—è­‰éŠ·è²¨æ˜ç´°
    /// </summary>
    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        // æª¢æŸ¥æ˜¯å¦è‡³å°‘æœ‰ä¸€é …éç©ºæ˜ç´°
        if (!SalesItems.Any(item => item.SelectedProduct != null))
        {
            errors.Add("è‡³å°‘éœ€è¦ä¸€é …éŠ·è²¨æ˜ç´°");
        }
        else
        {
            // === å¯©æ ¸æª¢æŸ¥ ===
            if (IsApprovalEnabled)
            {
                var unapprovedItems = SalesItems
                    .Where(item => item.SelectedProduct != null &&
                                  item.SourceQuotationId.HasValue &&
                                  !(item.IsQuotationApproved ?? false))
                    .ToList();
                
                if (unapprovedItems.Any())
                {
                    errors.Add($"æœ‰ {unapprovedItems.Count} é …æ˜ç´°ä¾†è‡ªæœªå¯©æ ¸çš„å ±åƒ¹å–®ï¼Œç„¡æ³•å„²å­˜ã€‚è«‹å…ˆå®Œæˆå ±åƒ¹å–®å¯©æ ¸ã€‚");
                }
            }
            
            var lineNumber = 1;
            foreach (var item in SalesItems.Where(x => x.SelectedProduct != null))
            {
                if (item.SelectedProduct == null)
                {
                    errors.Add($"ç¬¬ {lineNumber} è¡Œï¼šè«‹é¸æ“‡å•†å“");
                }

                if (item.OrderQuantity <= 0)
                {
                    errors.Add($"ç¬¬ {lineNumber} è¡Œï¼šè¨‚å–®æ•¸é‡å¿…é ˆå¤§æ–¼ 0");
                }

                if (item.UnitPrice < 0)
                {
                    errors.Add($"ç¬¬ {lineNumber} è¡Œï¼šå–®åƒ¹ä¸å¯ç‚ºè² æ•¸");
                }

                if (item.DiscountPercentage < 0 || item.DiscountPercentage > 100)
                {
                    errors.Add($"ç¬¬ {lineNumber} è¡Œï¼šæŠ˜æ‰£æ¯”ä¾‹å¿…é ˆä»‹æ–¼ 0-100 ä¹‹é–“");
                }

                lineNumber++;
            }
        }
          
        if (errors.Any())
        {
            await NotificationService.ShowErrorAsync(string.Join("\n", errors), "éŠ·è²¨æ˜ç´°é©—è­‰å¤±æ•—");
            return false;
        }
        
        return true;
    }
}
