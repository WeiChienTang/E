@* 訂單庫存檢視 Modal *@
@using ERPCore2.Data.Entities
@using ERPCore2.Models
@using ERPCore2.Helpers
@inject ISalesOrderService SalesOrderService
@inject INotificationService NotificationService
@inject IStringLocalizer<SharedResource> L

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@GetModalTitle()"
                   Icon="bi bi-box-seam"
                   HeaderColor="BaseModalComponent.HeaderVariant.Info"
                   ShowFooter="false"
                   CloseOnBackdropClick="true"
                   CloseOnEscape="true"
                   IsLoading="@isLoading"
                   LoadingMessage="@L["Inventory.LoadingMessage"]"
                   BodyContent="@BodyContent" />

@code {
    // ===== 參數定義 =====
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SalesOrderId { get; set; }
    [Parameter] public string OrderNumber { get; set; } = string.Empty;
    [Parameter] public EventCallback OnClose { get; set; }

    // ===== 私有欄位 =====
    private bool isLoading = false;
    private OrderInventoryCheckResult? checkResult;
    private Dictionary<object, bool> expandedItems = new();

    // ===== 生命週期 =====
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && SalesOrderId.HasValue)
        {
            await LoadInventoryCheckAsync();
        }
    }

    private async Task LoadInventoryCheckAsync()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            checkResult = await SalesOrderService.GetOrderInventoryCheckAsync(SalesOrderId!.Value);
            
            // 預設收合所有項目
            expandedItems.Clear();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"{ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private string GetModalTitle()
    {
        if (!string.IsNullOrEmpty(OrderNumber))
        {
            return string.Format(L["Inventory.CheckTitleWithOrder"].ToString(), OrderNumber);
        }
        return L["Inventory.CheckTitle"].ToString();
    }

    private void ToggleExpand(int detailId)
    {
        if (expandedItems.ContainsKey(detailId))
        {
            expandedItems[detailId] = !expandedItems[detailId];
        }
        else
        {
            expandedItems[detailId] = true;
        }
        StateHasChanged();
    }

    private bool IsExpanded(int detailId)
    {
        return expandedItems.GetValueOrDefault(detailId, false);
    }

    private void ToggleExpandByKey(string key)
    {
        if (expandedItems.ContainsKey(key))
        {
            expandedItems[key] = !expandedItems[key];
        }
        else
        {
            expandedItems[key] = true;
        }
        StateHasChanged();
    }

    private async Task HandleClose()
    {
        if (OnClose.HasDelegate)
        {
            await OnClose.InvokeAsync();
        }
        await IsVisibleChanged.InvokeAsync(false);
    }

    // ===== Render Fragments =====
    private RenderFragment BodyContent => builder =>
    {
        if (checkResult == null)
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "text-center text-muted py-4");
            builder.AddContent(2, L["Inventory.CannotLoad"].ToString());
            builder.CloseElement();
            return;
        }

        // 統計摘要區塊
        RenderSummaryCard(builder);

        // 明細列表
        builder.OpenElement(3, "div");
        builder.AddAttribute(4, "class", "inventory-check-list");
        
        foreach (var item in checkResult.Items)
        {
            RenderInventoryItem(builder, item);
        }
        
        builder.CloseElement(); // inventory-check-list
    };

    private void RenderInventoryItem(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder builder, OrderInventoryCheckItem item)
    {
        // 主項目容器 - 單行顯示
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "border-bottom py-2 d-flex align-items-center");
        
        // 展開/收合按鈕 (如果有子項目)
        if (item.IsComposition && item.Children.Any() && item.DetailId.HasValue)
        {
            builder.OpenElement(2, "button");
            builder.AddAttribute(3, "type", "button");
            builder.AddAttribute(4, "class", "btn btn-sm btn-link text-decoration-none p-0 me-2");
            builder.AddAttribute(5, "onclick", EventCallback.Factory.Create(this, () => ToggleExpand(item.DetailId.Value)));
            builder.AddContent(6, IsExpanded(item.DetailId.Value) ? "▼" : "▶");
            builder.CloseElement(); // button
        }
        else
        {
            builder.OpenElement(7, "span");
            builder.AddAttribute(8, "class", "me-2");
            builder.AddAttribute(9, "style", "width: 16px; display: inline-block;");
            builder.CloseElement();
        }
        
        // 狀態圖示
        builder.OpenElement(10, "span");
        builder.AddAttribute(11, "class", "me-2");
        builder.AddContent(12, item.StatusIcon);
        builder.CloseElement();
        
        // 產品編號和名稱
        builder.OpenElement(13, "strong");
        builder.AddAttribute(14, "class", "me-2");
        builder.AddContent(15, $"{item.ProductCode}");
        builder.CloseElement();
        
        builder.OpenElement(16, "span");
        builder.AddAttribute(17, "class", "me-3");
        builder.AddContent(18, item.ProductName);
        builder.CloseElement();
        
        // 數量資訊 - 單行
        builder.OpenElement(19, "span");
        builder.AddAttribute(20, "class", "text-muted small");
        
        builder.AddContent(21, L["Inventory.Required"].ToString());
        builder.OpenElement(22, "strong");
        builder.AddAttribute(23, "class", "mx-1");
        builder.AddContent(24, NumberFormatHelper.FormatSmart(item.RequiredQuantity));
        builder.CloseElement();

        builder.AddContent(25, " " + L["Inventory.Stock"].ToString());
        builder.OpenElement(26, "strong");
        builder.AddAttribute(27, "class", $"mx-1 {item.StatusClass}");
        builder.AddContent(28, NumberFormatHelper.FormatSmart(item.AvailableStock));
        builder.CloseElement();

        if (item.ShortageQuantity > 0)
        {
            builder.AddContent(29, " " + L["Inventory.Shortage"].ToString());
            builder.OpenElement(30, "strong");
            builder.AddAttribute(31, "class", "mx-1 text-danger");
            builder.AddContent(32, NumberFormatHelper.FormatSmart(item.ShortageQuantity));
            builder.CloseElement();
        }
        
        builder.AddContent(33, $" ({item.UnitName})");
        builder.CloseElement(); // text-muted small
        
        builder.CloseElement(); // 主項目容器
        
        // 子項目 (組成元件)
        if (item.IsComposition && item.Children.Any() && item.DetailId.HasValue && IsExpanded(item.DetailId.Value))
        {
            builder.OpenElement(34, "div");
            builder.AddAttribute(35, "class", "ps-4 border-start border-2 ms-2");
            
            foreach (var child in item.Children)
            {
                RenderChildItem(builder, child, level: 2);
            }
            
            builder.CloseElement(); // children container
        }
    }

    private void RenderChildItem(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder builder, OrderInventoryCheckItem child, int level)
    {
        // 根據層級調整縮排
        var indentStyle = level > 2 ? $"padding-left: {(level - 2) * 16}px;" : "";
        
        // 子項目容器 - 單行顯示
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "py-1 d-flex align-items-center small");
        builder.AddAttribute(2, "style", indentStyle);
        
        // 展開/收合按鈕 (如果有子項目)
        if (child.IsComposition && child.Children.Any())
        {
            var childExpandKey = $"{child.ProductId}_level{level}";
            var isChildExpanded = expandedItems.GetValueOrDefault(childExpandKey, true);
            expandedItems.TryAdd(childExpandKey, true);
            
            builder.OpenElement(3, "button");
            builder.AddAttribute(4, "type", "button");
            builder.AddAttribute(5, "class", "btn btn-sm btn-link text-decoration-none p-0 me-2");
            builder.AddAttribute(6, "onclick", EventCallback.Factory.Create(this, () => ToggleExpandByKey(childExpandKey)));
            builder.AddContent(7, isChildExpanded ? "▼" : "▶");
            builder.CloseElement(); // button
        }
        else
        {
            builder.OpenElement(8, "span");
            builder.AddAttribute(9, "class", "me-2");
            builder.AddAttribute(10, "style", "width: 16px; display: inline-block;");
            builder.CloseElement();
        }
        
        // 狀態圖示
        builder.OpenElement(11, "span");
        builder.AddAttribute(12, "class", "me-2");
        builder.AddContent(13, child.StatusIcon);
        builder.CloseElement();
        
        // 產品編號和名稱
        builder.OpenElement(14, "strong");
        builder.AddAttribute(15, "class", "me-2");
        builder.AddContent(16, child.ProductCode);
        builder.CloseElement();
        
        builder.OpenElement(17, "span");
        builder.AddAttribute(18, "class", "me-3");
        builder.AddContent(19, child.ProductName);
        builder.CloseElement();
        
        // 數量資訊 - 單行
        builder.OpenElement(20, "span");
        builder.AddAttribute(21, "class", "text-muted");
        
        builder.AddContent(22, L["Inventory.Required"].ToString());
        builder.OpenElement(23, "strong");
        builder.AddAttribute(24, "class", "mx-1");
        builder.AddContent(25, NumberFormatHelper.FormatSmart(child.RequiredQuantity));
        builder.CloseElement();

        builder.AddContent(26, " " + L["Inventory.Stock"].ToString());
        builder.OpenElement(27, "strong");
        builder.AddAttribute(28, "class", $"mx-1 {child.StatusClass}");
        builder.AddContent(29, NumberFormatHelper.FormatSmart(child.AvailableStock));
        builder.CloseElement();

        if (child.ShortageQuantity > 0)
        {
            builder.AddContent(30, " " + L["Inventory.Shortage"].ToString());
            builder.OpenElement(31, "strong");
            builder.AddAttribute(32, "class", "mx-1 text-danger");
            builder.AddContent(33, NumberFormatHelper.FormatSmart(child.ShortageQuantity));
            builder.CloseElement();
        }
        
        builder.AddContent(34, $" ({child.UnitName})");
        builder.CloseElement(); // text-muted
        
        builder.CloseElement(); // 子項目容器
        
        // 遞迴渲染：如果有子項目且已展開，遞迴顯示
        if (child.IsComposition && child.Children.Any())
        {
            var childExpandKey = $"{child.ProductId}_level{level}";
            var isChildExpanded = expandedItems.GetValueOrDefault(childExpandKey, true);
            
            if (isChildExpanded)
            {
                foreach (var grandChild in child.Children)
                {
                    RenderChildItem(builder, grandChild, level + 1);
                }
            }
        }
    }

    private void RenderSummaryCard(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder builder)
    {
        if (checkResult == null) return;

        var alertClass = GetOverallAlertClass();

        // 統計摘要卡片
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", $"alert alert-{alertClass} mb-3");
        builder.AddAttribute(2, "style", "border-left: 5px solid currentColor;");
        
        // 標題行
        builder.OpenElement(3, "div");
        builder.AddAttribute(4, "class", "d-flex justify-content-between align-items-center");
        builder.OpenElement(5, "strong");
        builder.AddContent(6, L["Inventory.SummaryTitle"].ToString());
        builder.CloseElement(); // strong
        builder.OpenElement(7, "small");
        builder.AddAttribute(8, "class", "text-muted");
        builder.AddContent(9, L["Inventory.SummaryNote"].ToString());
        builder.CloseElement(); // small
        builder.CloseElement(); // d-flex
        
        builder.CloseElement(); // alert
    }

    private void ExpandInsufficientItems()
    {
        if (checkResult == null) return;

        // 找出所有不足的組合產品項目
        var insufficientItems = checkResult.Items
            .Where(x => x.Status == InventoryStatus.Insufficient && x.IsComposition && x.DetailId.HasValue)
            .ToList();

        if (!insufficientItems.Any()) return;

        // 檢查是否所有不足項目都已展開
        bool allExpanded = insufficientItems.All(x => expandedItems.GetValueOrDefault(x.DetailId!.Value, false));

        // 如果全部已展開則收合，否則展開
        foreach (var item in insufficientItems)
        {
            expandedItems[item.DetailId!.Value] = !allExpanded;
        }
        
        StateHasChanged();
    }

    private string GetOverallAlertClass()
    {
        if (checkResult == null) return "secondary";
        
        if (checkResult.InsufficientItemCount > 0)
            return "danger";
        
        if (checkResult.WarningItemCount > 0)
            return "warning";
        
        return "success";
    }

    private string GetStatusBadgeClass(InventoryStatus status)
    {
        return status switch
        {
            InventoryStatus.Sufficient => "success",
            InventoryStatus.Warning => "warning",
            InventoryStatus.Insufficient => "danger",
            _ => "secondary"
        };
    }
}
