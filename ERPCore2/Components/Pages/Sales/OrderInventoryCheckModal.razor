@* è¨‚å–®åº«å­˜æª¢è¦– Modal *@
@using ERPCore2.Data.Entities
@using ERPCore2.Models
@inject ISalesOrderService SalesOrderService
@inject INotificationService NotificationService

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@GetModalTitle()"
                   Icon="bi bi-box-seam"
                   HeaderColor="BaseModalComponent.HeaderVariant.Info"
                   ShowFooter="false"
                   CloseOnBackdropClick="true"
                   CloseOnEscape="true"
                   IsLoading="@isLoading"
                   LoadingMessage="è¼‰å…¥åº«å­˜è³‡è¨Šä¸­..."
                   BodyContent="@BodyContent" />

@code {
    // ===== åƒæ•¸å®šç¾© =====
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SalesOrderId { get; set; }
    [Parameter] public string OrderNumber { get; set; } = string.Empty;
    [Parameter] public EventCallback OnClose { get; set; }

    // ===== ç§æœ‰æ¬„ä½ =====
    private bool isLoading = false;
    private OrderInventoryCheckResult? checkResult;
    private Dictionary<object, bool> expandedItems = new();

    // ===== ç”Ÿå‘½é€±æœŸ =====
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && SalesOrderId.HasValue)
        {
            await LoadInventoryCheckAsync();
        }
    }

    private async Task LoadInventoryCheckAsync()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            checkResult = await SalesOrderService.GetOrderInventoryCheckAsync(SalesOrderId!.Value);
            
            // é è¨­æ”¶åˆæ‰€æœ‰é …ç›®
            expandedItems.Clear();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥åº«å­˜æª¢æŸ¥è³‡è¨Šå¤±æ•—: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private string GetModalTitle()
    {
        if (!string.IsNullOrEmpty(OrderNumber))
        {
            return $"åº«å­˜æª¢è¦– - {OrderNumber}";
        }
        return "è¨‚å–®åº«å­˜æª¢è¦–";
    }

    private void ToggleExpand(int detailId)
    {
        if (expandedItems.ContainsKey(detailId))
        {
            expandedItems[detailId] = !expandedItems[detailId];
        }
        else
        {
            expandedItems[detailId] = true;
        }
        StateHasChanged();
    }

    private bool IsExpanded(int detailId)
    {
        return expandedItems.GetValueOrDefault(detailId, false);
    }

    private void ToggleExpandByKey(string key)
    {
        if (expandedItems.ContainsKey(key))
        {
            expandedItems[key] = !expandedItems[key];
        }
        else
        {
            expandedItems[key] = true;
        }
        StateHasChanged();
    }

    private async Task HandleClose()
    {
        if (OnClose.HasDelegate)
        {
            await OnClose.InvokeAsync();
        }
        await IsVisibleChanged.InvokeAsync(false);
    }

    // ===== Render Fragments =====
    private RenderFragment BodyContent => builder =>
    {
        if (checkResult == null)
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "text-center text-muted py-4");
            builder.AddContent(2, "ç„¡æ³•è¼‰å…¥åº«å­˜è³‡è¨Š");
            builder.CloseElement();
            return;
        }

        // çµ±è¨ˆæ‘˜è¦å€å¡Š
        RenderSummaryCard(builder);

        // æ˜ç´°åˆ—è¡¨
        builder.OpenElement(3, "div");
        builder.AddAttribute(4, "class", "inventory-check-list");
        
        foreach (var item in checkResult.Items)
        {
            RenderInventoryItem(builder, item);
        }
        
        builder.CloseElement(); // inventory-check-list
    };

    private void RenderInventoryItem(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder builder, OrderInventoryCheckItem item)
    {
        // ä¸»é …ç›®å®¹å™¨
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "card mb-2");
        
        // å¡ç‰‡å…§å®¹
        builder.OpenElement(2, "div");
        builder.AddAttribute(3, "class", "card-body p-3");
        
        // ä¸»é …ç›®è³‡è¨Š
        builder.OpenElement(4, "div");
        builder.AddAttribute(5, "class", "d-flex justify-content-between align-items-start");
        
        // å·¦å´ï¼šç”¢å“è³‡è¨Š
        builder.OpenElement(6, "div");
        builder.AddAttribute(7, "class", "flex-grow-1");
        
        // ç”¢å“æ¨™é¡Œè¡Œ
        builder.OpenElement(8, "div");
        builder.AddAttribute(9, "class", "d-flex align-items-center mb-2");
        
        // å±•é–‹/æ”¶åˆæŒ‰éˆ• (å¦‚æœæœ‰å­é …ç›®)
        if (item.IsComposition && item.Children.Any() && item.DetailId.HasValue)
        {
            builder.OpenElement(10, "button");
            builder.AddAttribute(11, "type", "button");
            builder.AddAttribute(12, "class", "btn btn-sm btn-link text-decoration-none p-0 me-2");
            builder.AddAttribute(13, "onclick", EventCallback.Factory.Create(this, () => ToggleExpand(item.DetailId.Value)));
            builder.AddContent(14, IsExpanded(item.DetailId.Value) ? "â–¼" : "â–¶");
            builder.CloseElement(); // button
        }
        else if (item.IsComposition)
        {
            builder.OpenElement(15, "span");
            builder.AddAttribute(16, "class", "me-2");
            builder.AddAttribute(17, "style", "width: 20px; display: inline-block;");
            builder.AddContent(18, "ğŸ“¦");
            builder.CloseElement();
        }
        else
        {
            builder.OpenElement(19, "span");
            builder.AddAttribute(20, "class", "me-2");
            builder.AddAttribute(21, "style", "width: 20px; display: inline-block;");
            builder.AddContent(22, "ğŸ“¦");
            builder.CloseElement();
        }
        
        // ç”¢å“ç·¨è™Ÿå’Œåç¨±
        builder.OpenElement(23, "strong");
        builder.AddContent(24, $"{item.ProductCode} - {item.ProductName}");
        builder.CloseElement(); // strong
        
        if (!string.IsNullOrEmpty(item.ProductSpecification))
        {
            builder.OpenElement(25, "span");
            builder.AddAttribute(26, "class", "text-muted ms-2");
            builder.AddAttribute(27, "style", "font-size: 0.9em;");
            builder.AddContent(28, $"({item.ProductSpecification})");
            builder.CloseElement();
        }
        
        builder.CloseElement(); // d-flex (æ¨™é¡Œè¡Œ)
        
        // æ•¸é‡è³‡è¨Š
        builder.OpenElement(29, "div");
        builder.AddAttribute(30, "class", "row g-2 small");
        
        // éœ€æ±‚æ•¸é‡
        builder.OpenElement(31, "div");
        builder.AddAttribute(32, "class", "col-auto");
        builder.AddContent(33, $"éœ€æ±‚: ");
        builder.OpenElement(34, "strong");
        builder.AddContent(35, $"{item.RequiredQuantity:N2} {item.UnitName}");
        builder.CloseElement();
        builder.CloseElement(); // col
        
        // åº«å­˜æ•¸é‡
        builder.OpenElement(36, "div");
        builder.AddAttribute(37, "class", "col-auto");
        builder.AddContent(38, $"åº«å­˜: ");
        builder.OpenElement(39, "strong");
        builder.AddAttribute(40, "class", item.StatusClass);
        builder.AddContent(41, $"{item.AvailableStock:N2} {item.UnitName}");
        builder.CloseElement();
        builder.CloseElement(); // col
        
        // ç¼ºå£ (å¦‚æœæœ‰)
        if (item.ShortageQuantity > 0)
        {
            builder.OpenElement(42, "div");
            builder.AddAttribute(43, "class", "col-auto");
            builder.AddContent(44, $"ç¼ºå£: ");
            builder.OpenElement(45, "strong");
            builder.AddAttribute(46, "class", "text-danger");
            builder.AddContent(47, $"{item.ShortageQuantity:N2} {item.UnitName}");
            builder.CloseElement();
            builder.CloseElement(); // col
        }
        
        builder.CloseElement(); // row
        
        builder.CloseElement(); // flex-grow-1
        
        // å³å´ï¼šç‹€æ…‹æ¨™ç±¤
        builder.OpenElement(48, "div");
        builder.AddAttribute(49, "class", "ms-3");
        builder.OpenElement(50, "span");
        builder.AddAttribute(51, "class", "badge bg-" + GetStatusBadgeClass(item.Status));
        builder.AddAttribute(52, "style", "font-size: 1em;");
        builder.AddContent(53, $"{item.StatusIcon} {item.StatusText}");
        builder.CloseElement(); // badge
        builder.CloseElement(); // ms-3
        
        builder.CloseElement(); // d-flex
        
        // å­é …ç›® (çµ„æˆå…ƒä»¶)
        if (item.IsComposition && item.Children.Any() && item.DetailId.HasValue && IsExpanded(item.DetailId.Value))
        {
            builder.OpenElement(54, "div");
            builder.AddAttribute(55, "class", "mt-3 ps-4 border-start border-2");
            
            foreach (var child in item.Children)
            {
                RenderChildItem(builder, child, level: 2);
            }
            
            builder.CloseElement(); // children container
        }
        
        builder.CloseElement(); // card-body
        builder.CloseElement(); // card
    }

    private void RenderChildItem(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder builder, OrderInventoryCheckItem child, int level)
    {
        // æ ¹æ“šå±¤ç´šèª¿æ•´ç¸®æ’å’ŒèƒŒæ™¯é¡è‰²
        var indentClass = level > 2 ? $"ms-{(level - 2) * 3}" : "";
        var bgClass = level switch
        {
            2 => "bg-light",
            3 => "bg-white",
            _ => "bg-light"
        };
        
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", $"mb-2 p-2 {bgClass} rounded {indentClass}");
        
        // ç”¢å“è³‡è¨Š
        builder.OpenElement(2, "div");
        builder.AddAttribute(3, "class", "d-flex justify-content-between align-items-start");
        
        // å·¦å´
        builder.OpenElement(4, "div");
        builder.AddAttribute(5, "class", "flex-grow-1");
        
        builder.OpenElement(6, "div");
        builder.AddAttribute(7, "class", "mb-1");
        
        // å±¤ç´šæŒ‡ç¤ºç¬¦ & å±•é–‹/æ”¶åˆæŒ‰éˆ•
        if (child.IsComposition && child.Children.Any())
        {
            // æœ‰å­é …ç›®çš„çµ„åˆç”¢å“ - é¡¯ç¤ºå±•é–‹/æ”¶åˆæŒ‰éˆ•
            var childExpandKey = $"{child.ProductId}_level{level}";
            var isChildExpanded = expandedItems.GetValueOrDefault(childExpandKey, true);
            
            builder.OpenElement(8, "button");
            builder.AddAttribute(9, "type", "button");
            builder.AddAttribute(10, "class", "btn btn-sm btn-link text-decoration-none p-0 me-2");
            builder.AddAttribute(11, "onclick", EventCallback.Factory.Create(this, () => ToggleExpandByKey(childExpandKey)));
            builder.AddContent(12, isChildExpanded ? "â–¼" : "â–¶");
            builder.CloseElement(); // button
            
            expandedItems.TryAdd(childExpandKey, true); // é è¨­å±•é–‹
        }
        else
        {
            // ä¸€èˆ¬å…ƒä»¶ - é¡¯ç¤ºå±¤ç´šåœ–ç¤º
            var icon = level switch
            {
                2 => "ğŸ”©",
                3 => "â€¢",
                _ => "â–«"
            };
            
            builder.OpenElement(13, "span");
            builder.AddAttribute(14, "class", "me-2");
            builder.AddContent(15, icon);
            builder.CloseElement();
        }
        
        builder.OpenElement(11, "strong");
        builder.AddAttribute(12, "style", "font-size: 0.95em;");
        builder.AddContent(13, $"{child.ProductCode} - {child.ProductName}");
        builder.CloseElement();
        
        if (!string.IsNullOrEmpty(child.ProductSpecification))
        {
            builder.OpenElement(14, "span");
            builder.AddAttribute(15, "class", "text-muted ms-2");
            builder.AddAttribute(16, "style", "font-size: 0.85em;");
            builder.AddContent(17, $"({child.ProductSpecification})");
            builder.CloseElement();
        }
        builder.CloseElement(); // mb-1
        
        // æ•¸é‡è³‡è¨Š (è¼ƒå°)
        builder.OpenElement(18, "div");
        builder.AddAttribute(19, "class", "small text-muted");
        
        if (child.CompositionMultiplier.HasValue)
        {
            builder.AddContent(20, $"æ¯çµ„: {child.CompositionMultiplier.Value:N2} {child.UnitName} | ");
        }
        
        builder.AddContent(21, $"éœ€æ±‚: ");
        builder.OpenElement(22, "span");
        builder.AddAttribute(23, "class", "fw-bold");
        builder.AddContent(24, $"{child.RequiredQuantity:N2}");
        builder.CloseElement();
        builder.AddContent(25, $" {child.UnitName} | åº«å­˜: ");
        
        builder.OpenElement(26, "span");
        builder.AddAttribute(27, "class", "fw-bold " + child.StatusClass);
        builder.AddContent(28, $"{child.AvailableStock:N2}");
        builder.CloseElement();
        builder.AddContent(29, $" {child.UnitName}");
        
        if (child.ShortageQuantity > 0)
        {
            builder.AddContent(30, $" | ç¼ºå£: ");
            builder.OpenElement(31, "span");
            builder.AddAttribute(32, "class", "fw-bold text-danger");
            builder.AddContent(33, $"{child.ShortageQuantity:N2}");
            builder.CloseElement();
            builder.AddContent(34, $" {child.UnitName}");
        }
        
        builder.CloseElement(); // small
        builder.CloseElement(); // flex-grow-1
        
        // å³å´ï¼šç‹€æ…‹
        builder.OpenElement(35, "div");
        builder.OpenElement(36, "span");
        builder.AddAttribute(37, "class", "badge bg-" + GetStatusBadgeClass(child.Status));
        builder.AddContent(38, $"{child.StatusIcon} {child.StatusText}");
        builder.CloseElement();
        builder.CloseElement();
        
        builder.CloseElement(); // d-flex
        
        //  éè¿´æ¸²æŸ“ï¼šå¦‚æœæœ‰å­é …ç›®ä¸”å·²å±•é–‹ï¼Œéè¿´é¡¯ç¤º
        if (child.IsComposition && child.Children.Any())
        {
            var childExpandKey = $"{child.ProductId}_level{level}";
            var isChildExpanded = expandedItems.GetValueOrDefault(childExpandKey, true);
            
            if (isChildExpanded)
            {
                builder.OpenElement(39, "div");
                builder.AddAttribute(40, "class", "mt-2 ps-3 border-start border-2 border-secondary");
                
                foreach (var grandChild in child.Children)
                {
                    // éè¿´å‘¼å«ï¼Œå±¤ç´š +1
                    RenderChildItem(builder, grandChild, level + 1);
                }
                
                builder.CloseElement(); // nested children container
            }
        }
        
        builder.CloseElement(); // container
    }

    private void RenderSummaryCard(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder builder)
    {
        if (checkResult == null) return;

        // åªè¨ˆç®—ä¸»è¦è¨‚å–®æ˜ç´°ï¼ˆç¬¬ä¸€å±¤ï¼‰ï¼Œä¸åŒ…å«å­ææ–™
        var mainItems = checkResult.Items.Where(x => x.Level == 1 || x.ParentDetailId == null).ToList();
        var totalItems = mainItems.Count;
        var insufficientCount = mainItems.Count(x => x.Status == InventoryStatus.Insufficient);
        var warningCount = mainItems.Count(x => x.Status == InventoryStatus.Warning);
        var sufficientCount = totalItems - insufficientCount - warningCount;
        var alertClass = GetOverallAlertClass();

        // çµ±è¨ˆæ‘˜è¦å¡ç‰‡
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", $"alert alert-{alertClass} mb-3");
        builder.AddAttribute(2, "style", "border-left: 5px solid currentColor;");
        
        // æ¨™é¡Œè¡Œ
        builder.OpenElement(3, "div");
        builder.AddAttribute(4, "class", "d-flex align-items-center mb-2");
        builder.OpenElement(5, "h6");
        builder.AddAttribute(6, "class", "mb-0 me-3");
        builder.OpenElement(7, "i");
        builder.AddAttribute(8, "class", "bi bi-clipboard-data me-2");
        builder.CloseElement();
        builder.AddContent(9, "åº«å­˜ç‹€æ³æ‘˜è¦");
        builder.CloseElement(); // h6
        builder.CloseElement(); // d-flex
        
        // çµ±è¨ˆè³‡è¨Š
        builder.OpenElement(10, "div");
        builder.AddAttribute(11, "class", "row g-3");
        
        // ç¸½é …ç›®æ•¸
        builder.OpenElement(12, "div");
        builder.AddAttribute(13, "class", "col-auto");
        builder.OpenElement(14, "div");
        builder.AddAttribute(15, "class", "d-flex align-items-center");
        builder.OpenElement(16, "span");
        builder.AddAttribute(17, "class", "badge bg-secondary me-2");
        builder.AddAttribute(18, "style", "font-size: 1.1em; min-width: 40px;");
        builder.AddContent(19, totalItems.ToString());
        builder.CloseElement();
        builder.OpenElement(20, "span");
        builder.AddContent(21, "ç¸½é …ç›®");
        builder.CloseElement();
        builder.CloseElement();
        builder.CloseElement(); // col
        
        // å……è¶³é …ç›®æ•¸
        if (sufficientCount > 0)
        {
            builder.OpenElement(22, "div");
            builder.AddAttribute(23, "class", "col-auto");
            builder.OpenElement(24, "div");
            builder.AddAttribute(25, "class", "d-flex align-items-center");
            builder.OpenElement(26, "span");
            builder.AddAttribute(27, "class", "badge bg-success me-2");
            builder.AddAttribute(28, "style", "font-size: 1.1em; min-width: 40px;");
            builder.AddContent(29, sufficientCount.ToString());
            builder.CloseElement();
            builder.OpenElement(30, "span");
            builder.AddContent(31, "ğŸŸ¢ å……è¶³");
            builder.CloseElement();
            builder.CloseElement();
            builder.CloseElement(); // col
        }
        
        // è­¦æˆ’é …ç›®æ•¸
        if (warningCount > 0)
        {
            builder.OpenElement(32, "div");
            builder.AddAttribute(33, "class", "col-auto");
            builder.OpenElement(34, "div");
            builder.AddAttribute(35, "class", "d-flex align-items-center");
            builder.OpenElement(36, "span");
            builder.AddAttribute(37, "class", "badge bg-warning text-dark me-2");
            builder.AddAttribute(38, "style", "font-size: 1.1em; min-width: 40px;");
            builder.AddContent(39, warningCount.ToString());
            builder.CloseElement();
            builder.OpenElement(40, "span");
            builder.AddContent(41, "ğŸŸ¡ è­¦æˆ’");
            builder.CloseElement();
            builder.CloseElement();
            builder.CloseElement(); // col
        }
        
        // ä¸è¶³é …ç›®æ•¸
        if (insufficientCount > 0)
        {
            builder.OpenElement(42, "div");
            builder.AddAttribute(43, "class", "col-auto");
            builder.OpenElement(44, "div");
            builder.AddAttribute(45, "class", "d-flex align-items-center");
            builder.OpenElement(46, "span");
            builder.AddAttribute(47, "class", "badge bg-danger me-2");
            builder.AddAttribute(48, "style", "font-size: 1.1em; min-width: 40px; cursor: pointer;");
            builder.AddAttribute(49, "title", "é»æ“Šå±•é–‹æ‰€æœ‰ä¸è¶³é …ç›®");
            builder.AddAttribute(50, "onclick", EventCallback.Factory.Create(this, ExpandInsufficientItems));
            builder.AddContent(51, insufficientCount.ToString());
            builder.CloseElement();
            builder.OpenElement(52, "span");
            builder.AddContent(53, "ğŸ”´ ä¸è¶³");
            builder.CloseElement();
            builder.CloseElement();
            builder.CloseElement(); // col
        }
        
        builder.CloseElement(); // row
        builder.CloseElement(); // alert
    }

    private void ExpandInsufficientItems()
    {
        if (checkResult == null) return;

        // æ‰¾å‡ºæ‰€æœ‰ä¸è¶³çš„çµ„åˆç”¢å“é …ç›®
        var insufficientItems = checkResult.Items
            .Where(x => x.Status == InventoryStatus.Insufficient && x.IsComposition && x.DetailId.HasValue)
            .ToList();

        if (!insufficientItems.Any()) return;

        // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰ä¸è¶³é …ç›®éƒ½å·²å±•é–‹
        bool allExpanded = insufficientItems.All(x => expandedItems.GetValueOrDefault(x.DetailId!.Value, false));

        // å¦‚æœå…¨éƒ¨å·²å±•é–‹å‰‡æ”¶åˆï¼Œå¦å‰‡å±•é–‹
        foreach (var item in insufficientItems)
        {
            expandedItems[item.DetailId!.Value] = !allExpanded;
        }
        
        StateHasChanged();
    }

    private string GetOverallAlertClass()
    {
        if (checkResult == null) return "secondary";
        
        if (checkResult.InsufficientItemCount > 0)
            return "danger";
        
        if (checkResult.WarningItemCount > 0)
            return "warning";
        
        return "success";
    }

    private string GetStatusBadgeClass(InventoryStatus status)
    {
        return status switch
        {
            InventoryStatus.Sufficient => "success",
            InventoryStatus.Warning => "warning",
            InventoryStatus.Insufficient => "danger",
            _ => "secondary"
        };
    }
}
