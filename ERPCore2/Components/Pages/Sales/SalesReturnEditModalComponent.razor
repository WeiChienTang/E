@* éŠ·å”®é€€è²¨ç·¨è¼¯æ¨¡æ…‹çµ„ä»¶ *@
@inject ISalesReturnService SalesReturnService
@inject ISalesReturnDetailService SalesReturnDetailService
@inject ISalesOrderService SalesOrderService
@inject ISalesOrderDetailService SalesOrderDetailService
@inject IWarehouseService WarehouseService
@inject IWarehouseLocationService WarehouseLocationService
@inject ISalesReturnReasonService SalesReturnReasonService
@inject INotificationService NotificationService
@inject ICustomerService CustomerService
@inject IEmployeeService EmployeeService
@inject IProductService ProductService
@inject ISystemParameterService SystemParameterService
@inject ActionButtonHelper ActionButtonHelper
@implements IDisposable

@using ERPCore2.FieldConfiguration
@using ERPCore2.Services.Sales

<GenericEditModalComponent TEntity="SalesReturn" 
                          TService="ISalesReturnService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          Id="@SalesReturnId"
                          Service="@SalesReturnService"
                          EntityName="éŠ·å”®é€€è²¨"
                          EntityNamePlural="éŠ·å”®é€€è²¨"
                          ModalTitle="@(SalesReturnId.HasValue ? "ç·¨è¼¯éŠ·å”®é€€è²¨" : "æ–°å¢é€€è²¨å–®")"
                          Size="GenericEditModalComponent<SalesReturn, ISalesReturnService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@GetAutoCompletePrefillers()"
                          AutoCompleteCollections="@GetAutoCompleteCollections()"
                          AutoCompleteDisplayProperties="@GetAutoCompleteDisplayProperties()"
                          AutoCompleteValueProperties="@GetAutoCompleteValueProperties()"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadSalesReturnData"
                          AdditionalDataLoader="@LoadAdditionalDataAsync"
                          UseGenericSave="false"
                          CustomValidator="@ValidateSalesReturnDetailsAsync"
                          SaveHandler="@SaveSalesReturnWithDetails"
                          SaveSuccessMessage="@(SalesReturnId.HasValue ? "éŠ·å”®é€€è²¨æ›´æ–°æˆåŠŸ" : "éŠ·å”®é€€è²¨æ–°å¢æˆåŠŸ")"
                          SaveFailureMessage="éŠ·å”®é€€è²¨å„²å­˜å¤±æ•—"
                          RequiredPermission="SalesReturn.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          CustomModules="@GetCustomModules()" />

@* å®¢æˆ¶ç·¨è¼¯ Modal *@
<CustomerEditModalComponent @ref="customerEditModal"
                           IsVisible="@customerModalManager.IsModalVisible"
                           IsVisibleChanged="@customerModalManager.HandleModalVisibilityChangedAsync"
                           CustomerId="@customerModalManager.SelectedEntityId"
                           OnCustomerSaved="@OnCustomerSavedWrapper"
                           OnCancel="@customerModalManager.HandleModalCancelAsync" />

@code {
    // ===== å¿…è¦åƒæ•¸ =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SalesReturnId { get; set; }
    [Parameter] public EventCallback<SalesReturn> OnSalesReturnSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== å…§éƒ¨ç‹€æ…‹ =====
    private GenericEditModalComponent<SalesReturn, ISalesReturnService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    private List<SalesOrder> salesOrders = new();
    private List<Warehouse> warehouses = new();
    private List<WarehouseLocation> warehouseLocations = new();
    private List<Customer> customers = new();
    private List<Employee> employees = new();
    private List<Product> products = new();
    private List<ERPCore2.Data.Entities.SalesReturnReason> returnReasons = new();
    
    // ===== éŠ·å”®é€€è²¨æ˜ç´° =====
    private List<SalesReturnDetail> salesReturnDetails = new();
    private SalesReturnDetailManagerComponent? salesReturnDetailManager;
    
    // ===== ç¯©é¸ç‹€æ…‹ =====
    private int? filterProductId = null;
    private int? FilterProductId => filterProductId;
    private int? FilterSalesOrderId = null;
    
    // ===== ç¨…ç‡å¿«å– =====
    private decimal currentTaxRate = 5.0m; // é è¨­ 5%ï¼Œå¯¦éš›å€¼æœƒåœ¨åˆå§‹åŒ–æ™‚å¾è³‡æ–™åº«è¼‰å…¥
    
    // ===== Modal ç®¡ç†å™¨ =====
    private CustomerEditModalComponent? customerEditModal;
    private RelatedEntityModalManager<Customer> customerModalManager = default!;

    // ===== å¿…è¦æ–¹æ³• =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // åˆå§‹åŒ– Modal ç®¡ç†å™¨
            InitializeCustomerModalManager();
            await Task.CompletedTask;
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–çµ„ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        try
        {
            if (IsVisible)
            {
                await LoadAdditionalDataAsync();
                await InitializeFormFieldsAsync();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"åƒæ•¸è¨­ç½®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è™•ç†å„²å­˜æˆåŠŸäº‹ä»¶
    /// </summary>
    private async Task HandleSaveSuccess()
    {
        try
        {
            // å¦‚æœçˆ¶çµ„ä»¶éœ€è¦çŸ¥é“éŠ·å”®é€€è²¨å·²å„²å­˜
            if (editModalComponent?.Entity != null && OnSalesReturnSaved.HasDelegate)
            {
                await OnSalesReturnSaved.InvokeAsync(editModalComponent.Entity);
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†å„²å­˜æˆåŠŸäº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è™•ç†å–æ¶ˆäº‹ä»¶
    /// </summary>
    private async Task HandleCancel()
    {
        try
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†å–æ¶ˆäº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è¼‰å…¥éŠ·å”®é€€è²¨è³‡æ–™
    /// </summary>
    private async Task<SalesReturn?> LoadSalesReturnData()
    {
        try
        {
            if (SalesReturnId.HasValue)
            {
                // ç·¨è¼¯æ¨¡å¼ï¼šè¼‰å…¥ç¾æœ‰è³‡æ–™
                var salesReturn = await SalesReturnService.GetByIdAsync(SalesReturnId.Value);
                if (salesReturn != null)
                {
                    // è¼‰å…¥å°æ‡‰çš„é€€è²¨æ˜ç´°
                    await LoadSalesReturnDetails(salesReturn.Id);
                }
                return salesReturn;
            }
            else
            {
                // æ–°å¢æ¨¡å¼ï¼šå»ºç«‹æ–°çš„é€€è²¨å–®ä¸¦ç”Ÿæˆé€€è²¨å–®è™Ÿ
                var newSalesReturn = new SalesReturn
                {
                    SalesReturnNumber = await GenerateReturnNumberAsync(),
                    ReturnDate = DateTime.Today,
                    TotalReturnAmount = 0,
                    ReturnReasonId = null // é è¨­ç‚º nullï¼Œé¸æ“‡æ€§å¡«å¯«
                };
                
                // åˆå§‹åŒ–ç©ºçš„æ˜ç´°åˆ—è¡¨
                salesReturnDetails = new List<SalesReturnDetail>();
                
                return newSalesReturn;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥éŠ·å”®é€€è²¨è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return null;
        }
    }

    /// <summary>
    /// è¼‰å…¥é¡å¤–è³‡æ–™
    /// </summary>
    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            await LoadSalesOrdersAsync();
            await LoadWarehousesAsync();
            await LoadWarehouseLocationsAsync();
            await LoadCustomersAsync();
            await LoadEmployeesAsync();
            await LoadProductsAsync();
            await LoadReturnReasonsAsync();
            
            // ğŸ”‘ ä¸€æ¬¡æ€§è¼‰å…¥ç³»çµ±ç¨…ç‡ï¼ˆé¿å…æ¯æ¬¡è¨ˆç®—éƒ½æŸ¥è©¢è³‡æ–™åº«ï¼‰
            await LoadTaxRateAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥é¡å¤–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    private async Task LoadSalesOrdersAsync()
    {
        try
        {
            salesOrders = await SalesOrderService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥éŠ·å”®è¨‚å–®è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            salesOrders = new List<SalesOrder>();
        }
    }

    private async Task LoadWarehousesAsync()
    {
        try
        {
            warehouses = await WarehouseService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å€‰åº«è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            warehouses = new List<Warehouse>();
        }
    }

    private async Task LoadWarehouseLocationsAsync()
    {
        try
        {
            warehouseLocations = await WarehouseLocationService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å€‰åº«ä½ç½®è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            warehouseLocations = new List<WarehouseLocation>();
        }
    }

    private async Task LoadCustomersAsync()
    {
        try
        {
            customers = await CustomerService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å®¢æˆ¶è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            customers = new List<Customer>();
        }
    }

    private async Task LoadEmployeesAsync()
    {
        try
        {
            var result = await EmployeeService.GetActiveEmployeesAsync();
            if (result.IsSuccess && result.Data != null)
            {
                employees = result.Data;
            }
            else
            {
                employees = new List<Employee>();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å“¡å·¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            employees = new List<Employee>();
        }
    }

    private async Task LoadProductsAsync()
    {
        try
        {
            products = await ProductService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å•†å“è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            products = new List<Product>();
        }
    }

    private async Task LoadReturnReasonsAsync()
    {
        try
        {
            returnReasons = await SalesReturnReasonService.GetActiveReasonsAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥é€€è²¨åŸå› è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            returnReasons = new List<ERPCore2.Data.Entities.SalesReturnReason>();
        }
    }

    /// <summary>
    /// è¼‰å…¥ç³»çµ±ç¨…ç‡ - ä¸€æ¬¡æ€§è¼‰å…¥ä¸¦å¿«å–ï¼Œé¿å…æ¯æ¬¡è¨ˆç®—éƒ½æŸ¥è©¢è³‡æ–™åº«
    /// </summary>
    private async Task LoadTaxRateAsync()
    {
        try
        {
            currentTaxRate = await SystemParameterService.GetTaxRateAsync();
        }
        catch (Exception)
        {
            // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼ 5%
            currentTaxRate = 5.0m;
        }
    }

    /// <summary>
    /// æ›´æ–°éŠ·å”®å–®é¸é … - æ ¹æ“šå®¢æˆ¶IDéæ¿¾ï¼Œä¸¦æ’é™¤å·²å®Œæˆçš„éŠ·å”®å–®
    /// </summary>
    private async Task UpdateSalesOrderOptions(int? customerId = null)
    {
        try
        {
            var filteredSalesOrders = salesOrders;

            if (customerId.HasValue)
            {
                // æ ¹æ“šé¸æ“‡çš„å®¢æˆ¶éæ¿¾éŠ·å”®å–®
                filteredSalesOrders = salesOrders
                    .Where(so => so.CustomerId == customerId.Value && !IsOrderFullyReturned(so))
                    .ToList();
            }
            else
            {
                // é¡¯ç¤ºæ‰€æœ‰æœªå®Œå…¨é€€è²¨çš„éŠ·å”®å–®
                filteredSalesOrders = salesOrders
                    .Where(so => !IsOrderFullyReturned(so))
                    .ToList();
            }

            // æ›´æ–°è¡¨å–®ä¸­éŠ·å”®å–®é¸é …
            var salesOrderField = formFields.FirstOrDefault(f => f.PropertyName == nameof(SalesReturn.SalesOrderId));
            if (salesOrderField != null)
            {
                salesOrderField.Options = filteredSalesOrders.Select(so => new SelectOption
                {
                    Text = $"{so.SalesOrderNumber} - {so.Customer?.CompanyName ?? ""}",
                    Value = so.Id.ToString()
                }).ToList();
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æ›´æ–°éŠ·å”®å–®é¸é …æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// åˆ¤æ–·éŠ·å”®å–®æ˜¯å¦å·²å®Œå…¨é€€è²¨
    /// é€€è²¨æ¢ä»¶ï¼šæ‰€æœ‰æ˜ç´°éƒ½å·²å®Œæˆé€€è²¨ï¼ˆé€€è²¨æ•¸é‡ == éŠ·å”®æ•¸é‡ æˆ– æ¨™è¨˜ç‚ºå·²å®Œæˆï¼‰
    /// </summary>
    private bool IsOrderFullyReturned(SalesOrder salesOrder)
    {
        try
        {
            // å¦‚æœæ²’æœ‰æ˜ç´°ï¼Œè¦–ç‚ºæœªå®Œæˆ
            if (salesOrder.SalesOrderDetails == null || !salesOrder.SalesOrderDetails.Any())
                return false;

            // é€™è£¡éœ€è¦å¯¦ä½œæª¢æŸ¥é‚è¼¯ï¼Œæš«æ™‚å›å‚³ false
            // æª¢æŸ¥æ‰€æœ‰æ˜ç´°æ˜¯å¦éƒ½å·²å®Œæˆé€€è²¨
            // return salesOrder.SalesOrderDetails.All(detail => detail.ReturnedQuantity >= detail.Quantity);
            return false;
        }
        catch
        {
            // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œè¦–ç‚ºæœªå®Œæˆ
            return false;
        }
    }

    /// <summary>
    /// åˆå§‹åŒ–è¡¨å–®æ¬„ä½
    /// </summary>
    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SalesReturn.SalesReturnNumber),
                    Label = "é€€è²¨å–®è™Ÿ",
                    FieldType = FormFieldType.Text,
                    Placeholder = "ç³»çµ±è‡ªå‹•ç”¢ç”Ÿ",
                    IsRequired = true,
                    IsReadOnly = true,
                    MaxLength = 50,
                    HelpText = "ç³»çµ±è‡ªå‹•ç”¢ç”Ÿçš„é€€è²¨å–®è™Ÿ"
                },
                new()
                {
                    PropertyName = nameof(SalesReturn.CustomerId),
                    Label = "å®¢æˆ¶",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡å®¢æˆ¶",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "è¼¸å…¥å®¢æˆ¶åç¨±é€²è¡Œç¯©é¸ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                    ActionButtons = await GetCustomerActionButtonsAsync()
                },
                new()
                {
                    PropertyName = "FilterProductId", // ç¯©é¸ç”¨çš„è™›æ“¬æ¬„ä½
                    Label = "ç¯©é¸ç”¢å“",
                    FieldType = FormFieldType.Select,
                    IsRequired = false,
                    Options = await GetFilterProductOptions(),
                    HelpText = "é¸æ“‡ç‰¹å®šç”¢å“é€²è¡Œç¯©é¸ï¼Œæˆ–ç•™ç©ºé¡¯ç¤ºæ‰€æœ‰ç”¢å“"
                },
                new()
                {
                    PropertyName = nameof(SalesReturn.SalesOrderId),
                    Label = "éŠ·å”®å–®",
                    FieldType = FormFieldType.Select,
                    IsRequired = false,
                    HelpText = "å¯é¸æ“‡ç‰¹å®šéŠ·å”®å–®é€²è¡Œç¯©é¸ï¼Œæˆ–ç•™ç©ºä½¿ç”¨å¤šéŠ·å”®å–®æ¨¡å¼"
                },
                new()
                {
                    PropertyName = nameof(SalesReturn.ReturnDate),
                    Label = "é€€è²¨æ—¥æœŸ",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "è²¨å“å¯¦éš›é€€è²¨æ—¥æœŸ"
                },
                new()
                {
                    PropertyName = nameof(SalesReturn.ReturnReasonId),
                    Label = "é€€è²¨åŸå› ",
                    FieldType = FormFieldType.Select,
                    IsRequired = false,
                    Options = new List<SelectOption> 
                    { 
                        new SelectOption { Text = "è«‹é¸æ“‡...", Value = "" } 
                    }
                    .Concat(returnReasons.Select(r => new SelectOption
                    {
                        Text = r.Name,
                        Value = r.Id.ToString()
                    })).ToList(),
                    HelpText = "é¸æ“‡æ€§å¡«å¯«é€€è²¨åŸå› "
                },

                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesReturn.TotalReturnAmount),
                    Label = "é€€è²¨ç¸½é‡‘é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "é€€è²¨å–®çš„ç¸½é‡‘é¡ï¼Œæ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—",
                    IsReadOnly = true // ç¸½é‡‘é¡æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                },
                new FormFieldDefinition
                {
                    PropertyName = nameof(SalesReturn.ReturnTaxAmount),
                    Label = $"é€€è²¨ç¨…é¡({currentTaxRate:F2}%)",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = $"é€€è²¨å–®çš„ç¨…é¡ï¼Œæ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—ï¼ˆç¨…ç‡ï¼š{currentTaxRate:F2}%ï¼‰",
                    IsReadOnly = true // ç¨…é¡æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                },
                new FormFieldDefinition
                {
                    PropertyName = nameof(SalesReturn.TotalReturnAmountWithTax),
                    Label = "å«ç¨…ç¸½é‡‘é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "é€€è²¨å–®çš„å«ç¨…ç¸½é‡‘é¡ï¼Œæ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—",
                    IsReadOnly = true // å«ç¨…ç¸½é‡‘é¡æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                },

                FormFieldConfigurationHelper.CreateRemarksField<SalesReturn>()
            };

            formSections = new Dictionary<string, string>
            {
                { nameof(SalesReturn.SalesReturnNumber), "åŸºæœ¬è³‡è¨Š" },
                { nameof(SalesReturn.CustomerId), "åŸºæœ¬è³‡è¨Š" },
                { "FilterProductId", "åŸºæœ¬è³‡è¨Š" },
                { nameof(SalesReturn.SalesOrderId), "åŸºæœ¬è³‡è¨Š" },
                { nameof(SalesReturn.ReturnDate), "åŸºæœ¬è³‡è¨Š" },
                { nameof(SalesReturn.ReturnReasonId), "åŸºæœ¬è³‡è¨Š" },
                { nameof(SalesReturn.TotalReturnAmount), "é‡‘é¡è³‡è¨Š(ç³»çµ±è‡ªå‹•è¨ˆç®—)" },
                { nameof(SalesReturn.ReturnTaxAmount), "é‡‘é¡è³‡è¨Š(ç³»çµ±è‡ªå‹•è¨ˆç®—)" },
                { nameof(SalesReturn.TotalReturnAmountWithTax), "é‡‘é¡è³‡è¨Š(ç³»çµ±è‡ªå‹•è¨ˆç®—)" },
                { nameof(BaseEntity.Remarks), "å…¶ä»–è³‡è¨Š" }
            };
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"åˆå§‹åŒ–è¡¨å–®æ¬„ä½æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// å–å¾—ç”¢å“ç¯©é¸é¸é … - æ ¹æ“šé¸æ“‡çš„å®¢æˆ¶ç¯©é¸
    /// </summary>
    private async Task<List<SelectOption>> GetFilterProductOptions()
    {
        try
        {
            var options = new List<SelectOption>();
            
            // ç›®å‰æš«æ™‚é¡¯ç¤ºæ‰€æœ‰ç”¢å“ï¼Œæœªä¾†å¯ä»¥æ ¹æ“šå®¢æˆ¶-ç”¢å“é—œè¯ä¾†ç¯©é¸
            options.AddRange(products.Select(p => new SelectOption
            {
                Value = p.Id.ToString(),
                Text = $"{p.Code} - {p.Name}"
            }));
            
            return options;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ç”¢å“é¸é …æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return new List<SelectOption>();
        }
    }

    /// <summary>
    /// æ›´æ–°ç”¢å“ç¯©é¸é¸é … - ç•¶å®¢æˆ¶è®Šæ›´æ™‚èª¿ç”¨
    /// </summary>
    private async Task UpdateFilterProductOptions(int? customerId = null)
    {
        try
        {
            // æ‰¾åˆ°ç”¢å“ç¯©é¸æ¬„ä½ä¸¦æ›´æ–°å…¶é¸é …
            var filterProductField = formFields.FirstOrDefault(f => f.PropertyName == "FilterProductId");
            if (filterProductField != null)
            {
                var options = new List<SelectOption>();
                
                // ç›®å‰æš«æ™‚é¡¯ç¤ºæ‰€æœ‰ç”¢å“ï¼Œæœªä¾†å¯ä»¥æ ¹æ“šå®¢æˆ¶-ç”¢å“é—œè¯ä¾†ç¯©é¸
                options.AddRange(products.Select(p => new SelectOption
                {
                    Value = p.Id.ToString(),
                    Text = $"{p.Code} - {p.Name}"
                }));
                
                filterProductField.Options = options;
                
                // æ¸…ç©ºç›®å‰çš„ç”¢å“ç¯©é¸é¸æ“‡
                filterProductId = null;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æ›´æ–°ç”¢å“ç¯©é¸é¸é …æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// å–å¾—è¡¨å–®æ¬„ä½æ¸…å–®
    /// </summary>
    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }

    /// <summary>
    /// é…ç½® AutoComplete é å¡«å™¨
    /// </summary>
    private Dictionary<string, Func<string, Dictionary<string, object?>>> GetAutoCompletePrefillers()
    {
        return new Dictionary<string, Func<string, Dictionary<string, object?>>>
        {
            {
                nameof(SalesReturn.CustomerId),
                searchTerm => new Dictionary<string, object?>
                {
                    ["CompanyName"] = searchTerm
                }
            }
        };
    }

    /// <summary>
    /// é…ç½® Modal ç®¡ç†å™¨
    /// </summary>
    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(SalesReturn.CustomerId), customerModalManager }
        };
    }

    /// <summary>
    /// é…ç½® AutoComplete è³‡æ–™é›†åˆ
    /// </summary>
    private Dictionary<string, IEnumerable<object>> GetAutoCompleteCollections()
    {
        return new Dictionary<string, IEnumerable<object>>
        {
            { nameof(SalesReturn.CustomerId), customers.Cast<object>() }
        };
    }

    /// <summary>
    /// é…ç½® AutoComplete é¡¯ç¤ºå±¬æ€§
    /// </summary>
    private Dictionary<string, string> GetAutoCompleteDisplayProperties()
    {
        return new Dictionary<string, string>
        {
            { nameof(SalesReturn.CustomerId), "CompanyName" }
        };
    }

    /// <summary>
    /// é…ç½® AutoComplete å€¼å±¬æ€§
    /// </summary>
    private Dictionary<string, string> GetAutoCompleteValueProperties()
    {
        return new Dictionary<string, string>
        {
            { nameof(SalesReturn.CustomerId), "Id" }
        };
    }

    /// <summary>
    /// ç”ŸæˆéŠ·å”®é€€è²¨å–®è™Ÿ
    /// </summary>
    private Task<string> GenerateReturnNumberAsync()
    {
        // ç°¡åŒ–å¯¦ä½œï¼Œç›´æ¥ä½¿ç”¨æ™‚é–“æˆ³ç”Ÿæˆ
        var timestamp = DateTime.Now.ToString("yyyyMMddHHmmss");
        return Task.FromResult($"SR{timestamp}");
    }

    // ===== éŠ·å”®é€€è²¨æ˜ç´°ç®¡ç†æ–¹æ³• =====
    
    /// <summary>
    /// è¼‰å…¥éŠ·å”®é€€è²¨æ˜ç´°
    /// </summary>
    private async Task LoadSalesReturnDetails(int salesReturnId)
    {
        try
        {
            salesReturnDetails = await SalesReturnDetailService.GetBySalesReturnIdAsync(salesReturnId);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥é€€è²¨æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            salesReturnDetails = new List<SalesReturnDetail>();
        }
    }

    /// <summary>
    /// è™•ç†é€€è²¨æ˜ç´°è®Šæ›´ - è‡ªå‹•è¨ˆç®—ç¸½é‡‘é¡å’Œç¨…é¡
    /// </summary>
    private async Task HandleReturnDetailsChanged(List<SalesReturnDetail> details)
    {
        try
        {
            salesReturnDetails = details;
            
            if (editModalComponent?.Entity != null)
            {
                // 1. è¨ˆç®—ç¸½é‡‘é¡ï¼ˆæœªç¨…ï¼‰- è€ƒæ…®æŠ˜æ‰£
                editModalComponent.Entity.TotalReturnAmount = details
                    .Where(d => d.ProductId > 0)
                    .Sum(d => d.ReturnQuantity * d.OriginalUnitPrice * (1 - d.DiscountPercentage / 100));
                
                // 2. è¨ˆç®—ç¨…é¡ = ç¸½é‡‘é¡ Ã— ç¨…ç‡ï¼ˆä½¿ç”¨å¿«å–çš„ç¨…ç‡ï¼Œé¿å…æ¯æ¬¡éƒ½æŸ¥è©¢è³‡æ–™åº«ï¼‰
                editModalComponent.Entity.ReturnTaxAmount = Math.Round(
                    editModalComponent.Entity.TotalReturnAmount * (currentTaxRate / 100), 
                    2  // å››æ¨äº”å…¥åˆ°å°æ•¸é»å¾Œ2ä½
                );
                
                // 3. å«ç¨…ç¸½é‡‘é¡æœƒè‡ªå‹•è¨ˆç®—ï¼ˆTotalReturnAmountWithTax æ˜¯è¨ˆç®—å±¬æ€§ï¼‰
                //    = TotalReturnAmount + ReturnTaxAmount
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†é€€è²¨æ˜ç´°è®Šæ›´æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è™•ç†æ¬„ä½å€¼è®Šæ›´äº‹ä»¶
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            switch (fieldChange.PropertyName)
            {
                case nameof(SalesReturn.CustomerId):
                    if (int.TryParse(fieldChange.Value?.ToString(), out var customerId))
                    {
                        // ç•¶å®¢æˆ¶è®Šæ›´æ™‚ï¼Œæ›´æ–°éŠ·å”®å–®é¸é …å’Œç”¢å“ç¯©é¸é¸é …
                        await UpdateSalesOrderOptions(customerId);
                        await UpdateFilterProductOptions(customerId);
                        
                        // ä½¿ç”¨çµ±ä¸€ Helper æ›´æ–°å®¢æˆ¶æ¬„ä½çš„æ“ä½œæŒ‰éˆ•
                        await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                            customerModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                        
                        // æ¸…é™¤ç¾æœ‰çš„éŠ·å”®å–®é¸æ“‡
                        if (editModalComponent?.Entity != null)
                        {
                            editModalComponent.Entity.SalesOrderId = null;
                            StateHasChanged();
                        }
                    }
                    break;

                case "FilterProductId":
                    if (int.TryParse(fieldChange.Value?.ToString(), out var productId))
                    {
                        filterProductId = productId == 0 ? null : productId;
                        
                        // é€šçŸ¥é€€è²¨æ˜ç´°ç®¡ç†å™¨ç¯©é¸è®Šæ›´
                        // if (salesReturnDetailManager != null)
                        // {
                        //     // é€™è£¡å¯ä»¥èª¿ç”¨æ˜ç´°ç®¡ç†å™¨çš„ç¯©é¸æ–¹æ³•
                        //     StateHasChanged();
                        // }
                        StateHasChanged();
                    }
                    break;

                case nameof(SalesReturn.SalesOrderId):
                    // ç•¶éŠ·å”®å–®IDè®Šæ›´æ™‚ï¼Œè§¸ç™¼é‡æ–°æ¸²æŸ“ä»¥ç¯©é¸å°æ‡‰çš„éŠ·å”®æ˜ç´°
                    StateHasChanged();
                    break;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†æ¬„ä½è®Šæ›´æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// é©—è­‰éŠ·å”®é€€è²¨æ˜ç´° - åœ¨å„²å­˜ä¸»æª”ä¹‹å‰åŸ·è¡Œ
    /// </summary>
    private async Task<bool> ValidateSalesReturnDetailsAsync(SalesReturn salesReturn)
    {
        try
        {
            // é©—è­‰å¿…å¡«æ¬„ä½
            if (salesReturn.CustomerId <= 0)
            {
                await NotificationService.ShowErrorAsync("è«‹é¸æ“‡å®¢æˆ¶");
                return false;
            }
            
            // é¦–å…ˆå‘¼å«æ˜ç´°ç®¡ç†å™¨çš„é©—è­‰æ–¹æ³•
            if (salesReturnDetailManager != null)
            {
                bool isValidDetails = await salesReturnDetailManager.ValidateAsync();
                if (!isValidDetails)
                {
                    return false;
                }
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„æ˜ç´°
            var validDetails = salesReturnDetails.Where(d => d.ProductId > 0 && d.ReturnQuantity > 0).ToList();
            if (!validDetails.Any())
            {
                await NotificationService.ShowErrorAsync("è‡³å°‘éœ€è¦ä¸€ç­†é€€è²¨æ˜ç´°");
                return false;
            }
            
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é©—è­‰é€€è²¨æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// è‡ªè¨‚å„²å­˜é‚è¼¯ - åŒæ™‚å„²å­˜ä¸»æª”å’Œæ˜ç´°ï¼Œä¸¦æ›´æ–°åº«å­˜
    /// </summary>
    private async Task<bool> SaveSalesReturnWithDetails(SalesReturn salesReturn)
    {
        try
        {
            if (salesReturn == null)
            {
                return false;
            }
            
            // å…ˆåŸ·è¡Œè‡ªè¨‚é©—è­‰
            if (!await ValidateSalesReturnDetailsAsync(salesReturn))
            {
                return false;
            }
            
            if (SalesReturnService == null)
            {
                return false;
            }
            
            if (salesReturnDetails == null)
            {
                salesReturnDetails = new List<SalesReturnDetail>();
            }
            
            // ğŸ”‘ å„²å­˜å‰å†æ¬¡è¨ˆç®—ç¸½é‡‘é¡å’Œç¨…é¡ï¼ˆç¢ºä¿è³‡æ–™ä¸€è‡´æ€§ï¼‰
            salesReturn.TotalReturnAmount = salesReturnDetails
                .Where(d => d.ProductId > 0)
                .Sum(d => d.ReturnQuantity * d.OriginalUnitPrice * (1 - d.DiscountPercentage / 100));
            
            salesReturn.ReturnTaxAmount = Math.Round(
                salesReturn.TotalReturnAmount * (currentTaxRate / 100), 
                2
            );
                        
            // å‘¼å«æœå‹™çš„ SaveWithDetailsAsync æ–¹æ³•
            var result = await SalesReturnService.SaveWithDetailsAsync(salesReturn, salesReturnDetails);
            
            if (result == null)
            {
                return false;
            }
            
            if (result.IsSuccess)
            {
                return true;
            }
            else
            {
                await NotificationService.ShowErrorAsync($"å„²å­˜å¤±æ•—ï¼š{result.ErrorMessage}");
                return false;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å„²å­˜éŠ·è²¨é€€å›æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// é…ç½®è‡ªè¨‚æ¨¡çµ„
    /// </summary>
    private List<GenericEditModalComponent<SalesReturn, ISalesReturnService>.CustomModule> GetCustomModules()
    {
        try
        {
            return new List<GenericEditModalComponent<SalesReturn, ISalesReturnService>.CustomModule>
            {
                new()
                {
                    Title = "",
                    Content = CreateReturnDetailManagerContent(),
                    Order = 1
                }
            };
        }
        catch
        {
            return new List<GenericEditModalComponent<SalesReturn, ISalesReturnService>.CustomModule>();
        }
    }

    /// <summary>
    /// å‰µå»ºé€€è²¨æ˜ç´°ç®¡ç†å™¨å…§å®¹çš„ RenderFragment
    /// </summary>
    private RenderFragment CreateReturnDetailManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null)
            {
                // æª¢æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„å•†å“å’Œå€‰åº«è³‡æ–™
                @if (products != null && products.Any() && warehouses != null && warehouses.Any())
                {
                    // æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡å®¢æˆ¶
                    @if (editModalComponent.Entity.CustomerId > 0)
                    {
                        <SalesReturnDetailManagerComponent @ref="salesReturnDetailManager"
                            Products="@products"
                            CustomerId="@(editModalComponent?.Entity?.CustomerId)"
                            FilterSalesOrderId="@FilterSalesOrderId"
                            FilterProductId="@FilterProductId"
                            ExistingReturnDetails="@salesReturnDetails"
                            OnReturnDetailsChanged="@HandleReturnDetailsChanged"
                            IsEditMode="@SalesReturnId.HasValue" />
                    }
                    else
                    {
                        <div class="alert alert-info text-center" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            è«‹å…ˆé¸æ“‡å®¢æˆ¶å¾Œå†é€²è¡Œé€€è²¨æ˜ç´°ç®¡ç†
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-warning text-center" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ç„¡å¯ç”¨çš„å•†å“æˆ–å€‰åº«è³‡æ–™ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡
                    </div>
                }
            }
            else
            {
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
            }
        }
        catch
        {
            <div class="alert alert-warning text-center" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                æ˜ç´°ç®¡ç†å™¨è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚
            </div>
        }
    };
    
    // ===== Modal ç®¡ç†å™¨åˆå§‹åŒ–æ–¹æ³• =====
    
    /// <summary>
    /// åˆå§‹åŒ–å®¢æˆ¶ Modal ç®¡ç†å™¨
    /// </summary>
    private void InitializeCustomerModalManager()
    {
        customerModalManager = new RelatedEntityManagerBuilder<Customer>(NotificationService, "å®¢æˆ¶")
            .WithPropertyName(nameof(SalesReturn.CustomerId))
            .WithReloadCallback(LoadAdditionalDataAsync)
            .WithStateChangedCallback(StateHasChanged)
            .WithAutoSelectCallback(customerId => 
            {
                if (editModalComponent?.Entity != null)
                {
                    editModalComponent.Entity.CustomerId = customerId;
                }
            })
            .WithCustomPostProcess(async customer => 
            {
                await InitializeFormFieldsAsync();
            })
            .Build();
    }

    /// <summary>
    /// ç”¢ç”Ÿå®¢æˆ¶æ“ä½œæŒ‰éˆ• - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetCustomerActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            customerModalManager, 
            nameof(SalesReturn.CustomerId)
        );
    }

    /// <summary>
    /// åŒ…è£å®¢æˆ¶å„²å­˜äº‹ä»¶
    /// </summary>
    private async Task OnCustomerSavedWrapper(Customer savedCustomer)
    {
        await customerModalManager.HandleEntitySavedAsync(savedCustomer, shouldAutoSelect: true);
    }

    /// <summary>
    /// å»ºç«‹åº«å­˜äº¤æ˜“è¨˜éŒ„ - æ–°å¢æ¨¡å¼
    /// </summary>
    private async Task CreateInventoryTransactionsAsync(List<SalesReturnDetail> details, string returnNumber)
    {
        // é€™è£¡æ‡‰è©²å¯¦ä½œåº«å­˜äº¤æ˜“å»ºç«‹é‚è¼¯
        // é€€è²¨æœƒå¢åŠ åº«å­˜ï¼Œæ‰€ä»¥äº¤æ˜“é¡å‹ç‚ºæ­£æ•¸
        await Task.CompletedTask;
    }

    /// <summary>
    /// ä½¿ç”¨å·®ç•°æ¯”è¼ƒæ›´æ–°åº«å­˜
    /// </summary>
    private async Task UpdateInventoryByDifferenceAsync(List<SalesReturnDetail> originalDetails, List<SalesReturnDetail> newDetails, string returnNumber)
    {
        // é€™è£¡æ‡‰è©²å¯¦ä½œåº«å­˜å·®ç•°æ›´æ–°é‚è¼¯
        // æ¯”è¼ƒåŸå§‹æ˜ç´°å’Œæ–°æ˜ç´°çš„å·®ç•°ï¼Œåªæ›´æ–°è®Šæ›´çš„éƒ¨åˆ†
        await Task.CompletedTask;
    }

    /// <summary>
    /// é‡‹æ”¾è³‡æº
    /// </summary>
    public void Dispose()
    {
        try
        {
            // æ¸…ç†è³‡æº
            editModalComponent = null;
            salesReturnDetailManager = null;
            // customerEditModal = null;
            
            // æ¸…ç†äº‹ä»¶è¨‚é–±ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            // ...
        }
        catch
        {
            // å¿½ç•¥æ¸…ç†éç¨‹ä¸­çš„éŒ¯èª¤
        }
    }
}