@* éŠ·å”®é€€è²¨ç·¨è¼¯æ¨¡æ…‹çµ„ä»¶ *@
@inject ISalesReturnService SalesReturnService
@inject ISalesReturnDetailService SalesReturnDetailService
@inject ISalesDeliveryService SalesDeliveryService
@inject ISalesDeliveryDetailService SalesDeliveryDetailService
@inject IWarehouseService WarehouseService
@inject IWarehouseLocationService WarehouseLocationService
@inject ISalesReturnReasonService SalesReturnReasonService
@inject INotificationService NotificationService
@inject ICustomerService CustomerService
@inject IEmployeeService EmployeeService
@inject IProductService ProductService
@inject ISystemParameterService SystemParameterService
@inject ActionButtonHelper ActionButtonHelper
@inject ISetoffDocumentService SetoffDocumentService
@inject IReportPrintConfigurationService ReportPrintConfigurationService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ERPCore2.Data.Context.AppDbContext DbContext
@implements IDisposable

@using ERPCore2.FieldConfiguration
@using ERPCore2.Data.Enums
@using ERPCore2.Helpers.InteractiveTableComponentHelper

<GenericEditModalComponent TEntity="SalesReturn" 
                          TService="ISalesReturnService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@SalesReturnId"
                          Service="@SalesReturnService"
                          EntityName="éŠ·å”®é€€è²¨"
                          EntityNamePlural="éŠ·å”®é€€è²¨"
                          ModalTitle="@(SalesReturnId.HasValue ? "ç·¨è¼¯éŠ·å”®é€€è²¨" : "æ–°å¢é€€è²¨å–®")"
                          Size="GenericEditModalComponent<SalesReturn, ISalesReturnService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@(autoCompleteConfig?.Prefillers)"
                          AutoCompleteCollections="@(autoCompleteConfig?.Collections)"
                          AutoCompleteDisplayProperties="@(autoCompleteConfig?.DisplayProperties)"
                          AutoCompleteValueProperties="@(autoCompleteConfig?.ValueProperties)"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadSalesReturnData"
                          UseGenericSave="false"
                          CustomValidator="@ValidateSalesReturnDetailsAsync"
                          SaveHandler="@SaveSalesReturnWithDetails"
                          SaveSuccessMessage="@(SalesReturnId.HasValue ? "éŠ·å”®é€€è²¨æ›´æ–°æˆåŠŸ" : "éŠ·å”®é€€è²¨æ–°å¢æˆåŠŸ")"
                          SaveFailureMessage="éŠ·å”®é€€è²¨å„²å­˜å¤±æ•—"
                          RequiredPermission="SalesReturn.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          GetStatusMessage="@GetStatusMessage"
                          FormHeaderContent="@GetWarningMessage()"
                          CustomModules="@GetCustomModules()"
                          ShowPrintButton="true"
                          OnPrint="@HandlePrint"
                          OnEntityLoaded="@HandleEntityLoaded" />

@* å®¢æˆ¶ç·¨è¼¯ Modal *@
<CustomerEditModalComponent @ref="customerEditModal"
                           IsVisible="@customerModalManager.IsModalVisible"
                           IsVisibleChanged="@customerModalManager.HandleModalVisibilityChangedAsync"
                           CustomerId="@customerModalManager.SelectedEntityId"
                           OnCustomerSaved="@OnCustomerSavedWrapper"
                           OnCancel="@customerModalManager.HandleModalCancelAsync" />

@* æ²–æ¬¾å–®ç·¨è¼¯ Modal *@
<SetoffDocumentEditModalComponent @ref="setoffDocumentEditModal"
                                 IsVisible="@showSetoffDocumentModal"
                                 IsVisibleChanged="@((bool visible) => showSetoffDocumentModal = visible)"
                                 SetoffDocumentId="@selectedSetoffDocumentId"
                                 OnSetoffDocumentSaved="@HandleSetoffDocumentSaved"
                                 OnCancel="@(() => showSetoffDocumentModal = false)" />

@code {
    // ===== å¿…è¦åƒæ•¸ =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SalesReturnId { get; set; }
    [Parameter] public EventCallback<SalesReturn> OnSalesReturnSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== é å¡«åƒæ•¸ï¼ˆç”¨æ–¼å¾å‡ºè²¨å–®è½‰å–®ï¼‰ =====
    [Parameter] public int? PrefilledCustomerId { get; set; }
    [Parameter] public int? PrefilledSalesDeliveryId { get; set; }  // å¾å‡ºè²¨å–®è½‰é€€è²¨æ™‚ä½¿ç”¨

    // ===== å…§éƒ¨ç‹€æ…‹ =====
    
    private GenericEditModalComponent<SalesReturn, ISalesReturnService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // åŸå§‹è³‡æ–™é›†åˆï¼ˆç”¨æ–¼ AutoCompleteï¼‰
    private List<SalesDelivery> availableSalesDeliveries = new();
    private List<Warehouse> availableWarehouses = new();
    private List<WarehouseLocation> availableWarehouseLocations = new();
    private List<Customer> availableCustomers = new();
    private List<Employee> availableEmployees = new();
    private List<Product> availableProducts = new();
    private List<ERPCore2.Data.Entities.SalesReturnReason> availableReturnReasons = new();
    
    // ä¸‹æ‹‰é¸å–®é¸é …ï¼ˆå‘ä¸‹ç›¸å®¹ï¼Œç”¨æ–¼éæ¿¾å¾Œçš„é¸é …ï¼‰
    private List<SalesDelivery> salesDeliveries = new();
    private List<Warehouse> warehouses = new();
    private List<WarehouseLocation> warehouseLocations = new();
    private List<Customer> customers = new();
    private List<Employee> employees = new();
    private List<Product> products = new();
    private List<ERPCore2.Data.Entities.SalesReturnReason> returnReasons = new();
    private List<SelectOption> taxCalculationMethodOptions = new();
    
    // AutoComplete é…ç½®
    private AutoCompleteConfig? autoCompleteConfig;
    
    // ===== éŠ·å”®é€€è²¨æ˜ç´° =====
    private List<SalesReturnDetail> salesReturnDetails = new();
    private SalesReturnTable? salesReturnDetailManager;
    
    // ===== ç¯©é¸ç‹€æ…‹ =====
    private int? filterProductId = null;
    private int? FilterProductId => filterProductId;
    private int? FilterSalesDeliveryId = null;
    
    // ===== æ˜ç´°è¼‰å…¥ç‹€æ…‹ =====
    private bool shouldAutoLoadReturnable = false;  // æ¨™è¨˜æ˜¯å¦éœ€è¦è‡ªå‹•è¼‰å…¥å¯é€€è²¨å•†å“
    
    // ===== ç¨…ç‡å¿«å– =====
    private decimal currentTaxRate = 5.0m; // é è¨­ 5%ï¼Œå¯¦éš›å€¼æœƒåœ¨åˆå§‹åŒ–æ™‚å¾è³‡æ–™åº«è¼‰å…¥
    
    // ===== é–å®šç‹€æ…‹ =====
    private bool hasUndeletableDetails = false;
    private bool isDetailDataReady = false;
    
    // ===== Modal Manager é›†åˆ =====
    private ModalManagerCollection? modalManagers;
    
    // ===== Modal ç®¡ç†å™¨ =====
    private CustomerEditModalComponent? customerEditModal;
    private RelatedEntityModalManager<Customer> customerModalManager = default!;
    
    // ===== ç›¸é—œå–®æ“š Modal =====
    private SetoffDocumentEditModalComponent? setoffDocumentEditModal;
    private bool showSetoffDocumentModal = false;
    private int? selectedSetoffDocumentId = null;
    
    // è³‡æ–™è¼‰å…¥ç‹€æ…‹æ¨™è¨˜
    private bool isDataLoaded = false;

    // ===== å¿…è¦æ–¹æ³• =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // ä½¿ç”¨ ModalManagerInitHelper åˆå§‹åŒ–æ‰€æœ‰ Manager
            modalManagers = ModalManagerInitHelper.CreateBuilder<SalesReturn, ISalesReturnService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Customer>(nameof(SalesReturn.CustomerId), "å®¢æˆ¶")
                .Build();
            
            // å–å¾—å€‹åˆ¥ Manager ä¾›çµ„ä»¶ä½¿ç”¨
            customerModalManager = modalManagers.Get<Customer>(nameof(SalesReturn.CustomerId));
            
            // ç§»é™¤è‡ªå‹•è¼‰å…¥è³‡æ–™ï¼Œæ”¹ç‚ºåœ¨ OnParametersSetAsync ä¸­æ ¹æ“š IsVisible è¼‰å…¥
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–çµ„ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        try
        {
            if (IsVisible && !isDataLoaded)
            {
                await LoadAdditionalDataAsync();
                await InitializeFormFieldsAsync();
                isDataLoaded = true;
                
                // å†æ¬¡è§¸ç™¼é¸é …æ›´æ–°ï¼ˆåœ¨è¡¨å–®æ¬„ä½åˆå§‹åŒ–å¾Œï¼‰
                // ç•¶å¾å‡ºè²¨å–®è½‰å–®æ™‚ï¼Œç¢ºä¿éŠ·å”®å–®é¸é …æ­£ç¢ºç¯©é¸
                if (PrefilledCustomerId.HasValue && PrefilledCustomerId.Value > 0)
                {
                    await UpdateSalesDeliveryOptions(PrefilledCustomerId.Value);
                    await UpdateFilterProductOptions(PrefilledCustomerId.Value);
                    StateHasChanged(); // å¼·åˆ¶UIæ›´æ–°
                }
            }
            else if (!IsVisible)
            {
                // ğŸ”‘ Modal é—œé–‰æ™‚é‡ç½®è‡ªå‹•è¼‰å…¥ç›¸é—œæ¨™è¨˜å’Œè³‡æ–™è¼‰å…¥æ¨™è¨˜
                shouldAutoLoadReturnable = false;
                isDataLoaded = false;
            }
            
            await base.OnParametersSetAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"åƒæ•¸è¨­ç½®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// é–‹å•Ÿæ–°å¢éŠ·å”®é€€è²¨å–® Modal ä¸¦é å¡«å‡ºè²¨å–®è³‡è¨Šï¼ˆå…¬é–‹æ–¹æ³•ä¾›å¤–éƒ¨èª¿ç”¨ï¼‰
    /// </summary>
    public async Task ShowAddModalWithPrefilledDelivery(int customerId, int salesDeliveryId)
    {
        try
        {
            // ä½¿ç”¨ DocumentConversionHelper çµ±ä¸€è™•ç†è½‰å–®é‚è¼¯
            var success = await DocumentConversionHelper.ShowConversionModalAsync(
                setPrefilledValues: () =>
                {
                    SalesReturnId = null;
                    PrefilledCustomerId = customerId;
                    PrefilledSalesDeliveryId = salesDeliveryId;
                    shouldAutoLoadReturnable = true;
                },
                isVisibleChanged: IsVisibleChanged,
                autoLoadAction: async () =>
                {
                    shouldAutoLoadReturnable = false;
                    if (salesReturnDetailManager != null)
                    {
                        await salesReturnDetailManager.LoadAllReturnableItems();
                    }
                },
                detailManagerReady: () => salesReturnDetailManager != null,
                shouldAutoLoad: () => shouldAutoLoadReturnable,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("è½‰å–®æµç¨‹åŸ·è¡Œå¤±æ•—");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledDelivery), GetType(), 
                additionalData: $"é–‹å•Ÿé å¡«éŠ·å”®é€€è²¨å–®Modalå¤±æ•— - CustomerId: {customerId}, DeliveryId: {salesDeliveryId}");
            await NotificationService.ShowErrorAsync("é–‹å•ŸéŠ·å”®é€€è²¨å–®æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    /// <summary>
    /// è™•ç†å„²å­˜æˆåŠŸäº‹ä»¶
    /// </summary>
    private async Task HandleSaveSuccess()
    {
        try
        {
            // å¦‚æœçˆ¶çµ„ä»¶éœ€è¦çŸ¥é“éŠ·å”®é€€è²¨å·²å„²å­˜
            if (editModalComponent?.Entity != null && OnSalesReturnSaved.HasDelegate)
            {
                await OnSalesReturnSaved.InvokeAsync(editModalComponent.Entity);
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†å„²å­˜æˆåŠŸäº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è™•ç†å–æ¶ˆäº‹ä»¶
    /// </summary>
    private async Task HandleCancel()
    {
        try
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†å–æ¶ˆäº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è™•ç†åˆ—å°äº‹ä»¶
    /// </summary>
    private async Task HandlePrint()
    {
        try
        {
            // ä½¿ç”¨é€šç”¨ Helper é€²è¡Œå®Œæ•´é©—è­‰ï¼ˆå¯¦é«”ã€IDï¼‰
            // éŠ·è²¨é€€å›å–®ä¸éœ€è¦æ ¸å‡†å³å¯åˆ—å°
            var (isValid, errorMessage) = ReportPrintHelper.ValidateForPrint(
                entity: editModalComponent?.Entity,
                entityId: SalesReturnId,
                isApproved: true, // ä¸éœ€è¦æ ¸å‡†ç‹€æ…‹æª¢æŸ¥
                entityName: "éŠ·è²¨é€€å›å–®",
                requireApproval: false // éŠ·è²¨é€€å›å–®ä¸éœ€è¦æ ¸å‡†å³å¯åˆ—å°
            );
            
            if (!isValid)
            {
                await NotificationService.ShowWarningAsync(errorMessage);
                return;
            }
            
            // ç›´æ¥åŸ·è¡Œåˆ—å°ï¼Œä½¿ç”¨é è¨­è¨­å®š
            await HandleDirectPrint(null);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePrint), GetType(), 
                additionalData: $"éŠ·è²¨é€€å›å–®åˆ—å°è™•ç†å¤±æ•— - ID: {SalesReturnId}");
            await NotificationService.ShowErrorAsync("åˆ—å°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
    }

    /// <summary>
    /// ç›´æ¥åŸ·è¡Œåˆ—å° - å¯ä»¥ä½¿ç”¨æŒ‡å®šçš„åˆ—å°é…ç½®æˆ–é è¨­é…ç½®
    /// </summary>
    private async Task HandleDirectPrint(ReportPrintConfiguration? printConfig)
    {
        try
        {
            // å»ºç«‹åˆ—å° URL - ä½¿ç”¨æ–°çš„è·¯ç”±æ ¼å¼ /api/sales-report/return/{id}
            var printUrl = ReportPrintHelper.BuildPrintUrl(
                baseUrl: NavigationManager.BaseUri,
                reportType: "sales-report/return",
                documentId: SalesReturnId!.Value,
                configuration: printConfig,
                autoprint: true
            );

            // ä½¿ç”¨éš±è— iframe åˆ—å°ï¼ˆä¸é˜»æ“‹ä¸»è¦–çª—æ“ä½œï¼‰
            var printSuccess = await ReportPrintHelper.ExecutePrintWithHiddenIframeAsync(
                printUrl: printUrl,
                jsRuntime: JSRuntime,
                iframeId: "salesReturnPrintFrame"
            );

            if (printSuccess)
            {
                await NotificationService.ShowSuccessAsync("åˆ—å°æŒ‡ä»¤å·²é€å‡º");
            }
            else
            {
                await NotificationService.ShowWarningAsync("åˆ—å°æŒ‡ä»¤é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDirectPrint), GetType(), 
                additionalData: $"éŠ·è²¨é€€å›å–®ç›´æ¥åˆ—å°å¤±æ•— - ID: {SalesReturnId}");
            await NotificationService.ShowErrorAsync($"åŸ·è¡Œåˆ—å°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è¼‰å…¥éŠ·å”®é€€è²¨è³‡æ–™
    /// </summary>
    private async Task<SalesReturn?> LoadSalesReturnData()
    {
        try
        {
            isDetailDataReady = false;
            hasUndeletableDetails = false;
            
            if (SalesReturnId.HasValue)
            {
                // ç·¨è¼¯æ¨¡å¼ï¼šè¼‰å…¥ç¾æœ‰è³‡æ–™
                var salesReturn = await SalesReturnService.GetByIdAsync(SalesReturnId.Value);
                if (salesReturn != null)
                {
                    // è¼‰å…¥å°æ‡‰çš„é€€è²¨æ˜ç´°
                    await LoadSalesReturnDetails(salesReturn.Id);
                    
                    // ğŸ”‘ é—œéµï¼šè¼‰å…¥æ˜ç´°ç›¸é—œè³‡æ–™ï¼ˆæ²–æ¬¾è¨˜éŒ„ï¼‰
                    await LoadDetailRelatedDataAsync();
                    isDetailDataReady = true;
                    StateHasChanged();
                }
                else
                {
                    isDetailDataReady = true;
                }
                return salesReturn;
            }
            else
            {
                // æ–°å¢æ¨¡å¼ï¼šå»ºç«‹æ–°çš„é€€è²¨å–®ä¸¦ç”Ÿæˆé€€è²¨å–®è™Ÿ
                var newSalesReturn = new SalesReturn
                {
                    Code = await GenerateReturnNumberAsync(),
                    ReturnDate = DateTime.Today,
                    TotalReturnAmount = 0,
                    ReturnReasonId = null // é è¨­ç‚º nullï¼Œé¸æ“‡æ€§å¡«å¯«
                };
                
                // ğŸ”‘ ä½¿ç”¨é å¡«åƒæ•¸ï¼ˆå¾å‡ºè²¨å–®è½‰å–®æ™‚ï¼‰
                if (PrefilledCustomerId.HasValue && PrefilledCustomerId.Value > 0)
                {
                    newSalesReturn.CustomerId = PrefilledCustomerId.Value;
                }
                
                if (PrefilledSalesDeliveryId.HasValue && PrefilledSalesDeliveryId.Value > 0)
                {
                    newSalesReturn.SalesDeliveryId = PrefilledSalesDeliveryId.Value;
                    // è¨­å®šç¯©é¸æ¢ä»¶ï¼Œè®“æ˜ç´°ç®¡ç†å™¨åªé¡¯ç¤ºé€™å¼µå‡ºè²¨å–®çš„å¯é€€è²¨å•†å“
                    FilterSalesDeliveryId = PrefilledSalesDeliveryId.Value;
                }
                
                // åˆå§‹åŒ–ç©ºçš„æ˜ç´°åˆ—è¡¨
                salesReturnDetails = new List<SalesReturnDetail>();
                isDetailDataReady = true;
                
                return newSalesReturn;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥éŠ·å”®é€€è²¨è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            isDetailDataReady = true; // éŒ¯èª¤ä¹Ÿè¦å…è¨±æ¸²æŸ“
            return null;
        }
    }

    /// <summary>
    /// è¼‰å…¥æ˜ç´°ç›¸é—œè³‡æ–™ï¼ˆæ²–æ¬¾è¨˜éŒ„ï¼‰- ç”¨æ–¼åˆ¤æ–·æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
    /// å¿…é ˆåœ¨ DataLoader ä¸­åŒæ­¥åŸ·è¡Œï¼Œç¢ºä¿ç‹€æ…‹è¨Šæ¯æ­£ç¢ºé¡¯ç¤º
    /// </summary>
    private async Task LoadDetailRelatedDataAsync()
    {
        try
        {
            if (!salesReturnDetails.Any())
            {
                hasUndeletableDetails = false;
                return;
            }

            bool hasUndeletable = false;
            
            foreach (var detail in salesReturnDetails.Where(d => d.Id > 0))
            {
                // æª¢æŸ¥æ²–æ¬¾è¨˜éŒ„
                if (detail.TotalPaidAmount > 0)
                {
                    hasUndeletable = true;
                    break;
                }
            }
            
            hasUndeletableDetails = hasUndeletable;
            
            if (hasUndeletableDetails)
            {
                UpdateFieldsReadOnlyState();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDetailRelatedDataAsync), GetType());
            hasUndeletableDetails = false;
        }
    }

    /// <summary>
    /// è¼‰å…¥é¡å¤–è³‡æ–™
    /// </summary>
    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            await LoadsalesDeliveriesAsync();
            await LoadWarehousesAsync();
            await LoadWarehouseLocationsAsync();
            await LoadCustomersAsync();
            await LoadEmployeesAsync();
            await LoadProductsAsync();
            await LoadReturnReasonsAsync();
            
            // ğŸ”‘ ä¸€æ¬¡æ€§è¼‰å…¥ç³»çµ±ç¨…ç‡ï¼ˆé¿å…æ¯æ¬¡è¨ˆç®—éƒ½æŸ¥è©¢è³‡æ–™åº«ï¼‰
            await LoadTaxRateAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥é¡å¤–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    private async Task LoadsalesDeliveriesAsync()
    {
        try
        {
            availableSalesDeliveries = await SalesDeliveryService.GetAllAsync();
            salesDeliveries = availableSalesDeliveries; // å‘ä¸‹ç›¸å®¹
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å‡ºè²¨å–®è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            availableSalesDeliveries = new List<SalesDelivery>();
            salesDeliveries = new List<SalesDelivery>();
        }
    }

    private async Task LoadWarehousesAsync()
    {
        try
        {
            availableWarehouses = await WarehouseService.GetAllAsync();
            warehouses = availableWarehouses; // å‘ä¸‹ç›¸å®¹
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å€‰åº«è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            availableWarehouses = new List<Warehouse>();
            warehouses = new List<Warehouse>();
        }
    }

    private async Task LoadWarehouseLocationsAsync()
    {
        try
        {
            availableWarehouseLocations = await WarehouseLocationService.GetAllAsync();
            warehouseLocations = availableWarehouseLocations; // å‘ä¸‹ç›¸å®¹
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å€‰åº«ä½ç½®è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            availableWarehouseLocations = new List<WarehouseLocation>();
            warehouseLocations = new List<WarehouseLocation>();
        }
    }

    private async Task LoadCustomersAsync()
    {
        try
        {
            availableCustomers = await CustomerService.GetAllAsync();
            customers = availableCustomers; // å‘ä¸‹ç›¸å®¹
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å®¢æˆ¶è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            availableCustomers = new List<Customer>();
            customers = new List<Customer>();
        }
    }

    private async Task LoadEmployeesAsync()
    {
        try
        {
            var result = await EmployeeService.GetActiveEmployeesAsync();
            if (result.IsSuccess && result.Data != null)
            {
                availableEmployees = result.Data;
                employees = availableEmployees; // å‘ä¸‹ç›¸å®¹
            }
            else
            {
                availableEmployees = new List<Employee>();
                employees = new List<Employee>();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å“¡å·¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            availableEmployees = new List<Employee>();
            employees = new List<Employee>();
        }
    }

    private async Task LoadProductsAsync()
    {
        try
        {
            availableProducts = await ProductService.GetAllAsync();
            products = availableProducts; // å‘ä¸‹ç›¸å®¹
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å•†å“è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            availableProducts = new List<Product>();
            products = new List<Product>();
        }
    }

    private async Task LoadReturnReasonsAsync()
    {
        try
        {
            availableReturnReasons = await SalesReturnReasonService.GetActiveReasonsAsync();
            returnReasons = availableReturnReasons; // å‘ä¸‹ç›¸å®¹
            
            // é…ç½® AutoComplete - ä½¿ç”¨ available* é›†åˆç¢ºä¿é¡¯ç¤ºå®Œæ•´è³‡æ–™
            autoCompleteConfig = new AutoCompleteConfigBuilder<SalesReturn>()
                .AddField(nameof(SalesReturn.CustomerId), "CompanyName", availableCustomers)
                .AddField(nameof(SalesReturn.SalesDeliveryId), "Code", availableSalesDeliveries)
                .Build();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥é€€è²¨åŸå› è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            availableReturnReasons = new List<ERPCore2.Data.Entities.SalesReturnReason>();
            returnReasons = new List<ERPCore2.Data.Entities.SalesReturnReason>();
        }
    }

    /// <summary>
    /// è¼‰å…¥ç³»çµ±ç¨…ç‡ - ä¸€æ¬¡æ€§è¼‰å…¥ä¸¦å¿«å–ï¼Œé¿å…æ¯æ¬¡è¨ˆç®—éƒ½æŸ¥è©¢è³‡æ–™åº«
    /// </summary>
    private async Task LoadTaxRateAsync()
    {
        currentTaxRate = await TaxCalculationHelper.LoadTaxRateAsync(SystemParameterService);
    }

    /// <summary>
    /// æ›´æ–°éŠ·å”®å–®é¸é … - æ ¹æ“šå®¢æˆ¶IDéæ¿¾ï¼Œä¸¦æ’é™¤å·²å®Œæˆçš„éŠ·å”®å–®
    /// </summary>
    private async Task UpdateSalesDeliveryOptions(int? customerId = null)
    {
        try
        {
            var filteredsalesDeliveries = salesDeliveries;

            if (customerId.HasValue)
            {
                // æ ¹æ“šé¸æ“‡çš„å®¢æˆ¶éæ¿¾éŠ·å”®å–®
                filteredsalesDeliveries = salesDeliveries
                    .Where(so => so.CustomerId == customerId.Value && !IsDeliveryFullyReturned(so))
                    .ToList();
            }
            else
            {
                // é¡¯ç¤ºæ‰€æœ‰æœªå®Œå…¨é€€è²¨çš„éŠ·å”®å–®
                filteredsalesDeliveries = salesDeliveries
                    .Where(so => !IsDeliveryFullyReturned(so))
                    .ToList();
            }

            // æ›´æ–°è¡¨å–®ä¸­éŠ·å”®å–®é¸é …
            var salesDeliveryField = formFields.FirstOrDefault(f => f.PropertyName == nameof(SalesReturn.SalesDeliveryId));
            if (salesDeliveryField != null)
            {
                salesDeliveryField.Options = filteredsalesDeliveries.Select(so => new SelectOption
                {
                    Text = so.Code ?? string.Empty,
                    Value = so.Id.ToString()
                }).ToList();
                
                // âŒ ç§»é™¤ StateHasChanged() - è®“å‘¼å«è€…çµ±ä¸€æ§åˆ¶æ¸²æŸ“
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æ›´æ–°éŠ·å”®å–®é¸é …æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// åˆ¤æ–·éŠ·å”®å–®æ˜¯å¦å·²å®Œå…¨é€€è²¨
    /// é€€è²¨æ¢ä»¶ï¼šæ‰€æœ‰æ˜ç´°éƒ½å·²å®Œæˆé€€è²¨ï¼ˆé€€è²¨æ•¸é‡ == éŠ·å”®æ•¸é‡ æˆ– æ¨™è¨˜ç‚ºå·²å®Œæˆï¼‰
    /// </summary>
    private bool IsDeliveryFullyReturned(SalesDelivery salesDelivery)
    {
        try
        {
            // å¦‚æœæ²’æœ‰æ˜ç´°ï¼Œè¦–ç‚ºæœªå®Œæˆ
            if (salesDelivery.DeliveryDetails == null || !salesDelivery.DeliveryDetails.Any())
                return false;

            // é€™è£¡éœ€è¦å¯¦ä½œæª¢æŸ¥é‚è¼¯ï¼Œæš«æ™‚å›å‚³ false
            // æª¢æŸ¥æ‰€æœ‰æ˜ç´°æ˜¯å¦éƒ½å·²å®Œæˆé€€è²¨
            // return salesDelivery.DeliveryDetails.All(detail => detail.ReturnedQuantity >= detail.Quantity);
            return false;
        }
        catch
        {
            // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œè¦–ç‚ºæœªå®Œæˆ
            return false;
        }
    }

    /// <summary>
    /// åˆå§‹åŒ–è¡¨å–®æ¬„ä½
    /// </summary>
    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SalesReturn.Code),
                    Label = "é€€è²¨å–®è™Ÿ",
                    FieldType = FormFieldType.Text,
                    Placeholder = "ç³»çµ±è‡ªå‹•ç”¢ç”Ÿ",
                    IsRequired = true,
                    IsReadOnly = true,
                    MaxLength = 50,
                    HelpText = "ç³»çµ±è‡ªå‹•ç”¢ç”Ÿçš„é€€è²¨å–®è™Ÿ"
                },
                new()
                {
                    PropertyName = nameof(SalesReturn.CustomerId),
                    Label = "å®¢æˆ¶",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡å®¢æˆ¶",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "è¼¸å…¥å®¢æˆ¶åç¨±é€²è¡Œç¯©é¸ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                    ActionButtons = await GetCustomerActionButtonsAsync(), // ğŸ”‘ æ ¹æ“š hasUndeletableDetails æ±ºå®šæ˜¯å¦é¡¯ç¤º
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = "FilterProductId", // ç¯©é¸ç”¨çš„è™›æ“¬æ¬„ä½
                    Label = "å•†å“",
                    FieldType = FormFieldType.Select,
                    IsRequired = false,
                    Options = await GetFilterProductOptions(),
                    HelpText = "é¸æ“‡ç‰¹å®šå•†å“é€²è¡Œç¯©é¸ï¼Œæˆ–ç•™ç©ºé¡¯ç¤ºæ‰€æœ‰å•†å“",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(SalesReturn.SalesDeliveryId),
                    Label = "éŠ·è²¨å–®",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹é¸æ“‡éŠ·è²¨å–®è™Ÿ",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "å¯é¸æ“‡ç‰¹å®šéŠ·è²¨å–®é€²è¡Œç¯©é¸ï¼Œæˆ–ç•™ç©ºä½¿ç”¨å¤šéŠ·è²¨å–®æ¨¡å¼",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(SalesReturn.ReturnDate),
                    Label = "é€€è²¨æ—¥æœŸ",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "è²¨å“å¯¦éš›é€€è²¨æ—¥æœŸ",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(SalesReturn.ReturnReasonId),
                    Label = "é€€è²¨åŸå› ",
                    FieldType = FormFieldType.Select,
                    IsRequired = false,
                    Options = new List<SelectOption> {}
                    .Concat(returnReasons.Select(r => new SelectOption
                    {
                        Text = r.Name,
                        Value = r.Id.ToString()
                    })).ToList(),
                    HelpText = "é¸æ“‡æ€§å¡«å¯«é€€è²¨åŸå› ",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },

                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesReturn.TotalReturnAmount),
                    Label = "é‡‘é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "é€€è²¨å–®çš„ç¸½é‡‘é¡ï¼Œæ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—",
                    IsReadOnly = true, // ç¸½é‡‘é¡æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                    CssClass = "text-warning fw-bold" // ä½¿ç”¨é»ƒè‰²ç²—é«”é¡¯ç¤º
                },

                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesReturn.DiscountAmount),
                    Label = "æŠ˜æ‰£",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "é€€è²¨å–®çš„æŠ˜æ‰£é‡‘é¡ï¼Œæ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—",
                    IsReadOnly = true,
                    CssClass = "text-danger fw-bold" // ä½¿ç”¨ç´…è‰²ç²—é«”é¡¯ç¤º
                },
                
                new FormFieldDefinition
                {
                    PropertyName = nameof(SalesReturn.ReturnTaxAmount),
                    Label = "ç¨…é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "é€€è²¨å–®çš„ç¨…é¡ï¼Œæ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—",
                    IsReadOnly = true, // ç¨…é¡æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                    CssClass = "text-info fw-bold" // ä½¿ç”¨è—è‰²ç²—é«”é¡¯ç¤º
                },
                new FormFieldDefinition
                {
                    PropertyName = nameof(SalesReturn.TotalReturnAmountWithTax),
                    Label = "ç¸½é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "é€€è²¨å–®çš„å«ç¨…ç¸½é‡‘é¡ï¼Œæ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—",
                    IsReadOnly = true, // å«ç¨…ç¸½é‡‘é¡æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                    CssClass = "text-success fw-bold" // ä½¿ç”¨ç¶ è‰²ç²—é«”é¡¯ç¤º
                },

                FormFieldConfigurationHelper.CreateRemarksField<SalesReturn>(
                    readOnly: hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                )
            };

            formSections = FormSectionHelper<SalesReturn>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    sr => sr.Code,
                    sr => sr.CustomerId)                    
                .AddCustomFields(FormSectionNames.BasicInfo, "FilterProductId")
                .AddToSection(FormSectionNames.BasicInfo,
                    sr => sr.ReturnReasonId,
                    sr => sr.ReturnDate)
                .AddToSection(FormSectionNames.AmountInfoAutoCalculated,
                    sr => sr.TotalReturnAmount,
                    sr => sr.DiscountAmount,
                    sr => sr.ReturnTaxAmount,
                    sr => sr.TotalReturnAmountWithTax)
                .AddToSection(FormSectionNames.OtherInfo,
                    sr => sr.Remarks)
                .Build();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"åˆå§‹åŒ–è¡¨å–®æ¬„ä½æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// å–å¾—å•†å“ç¯©é¸é¸é … - æ ¹æ“šé¸æ“‡çš„å®¢æˆ¶ç¯©é¸
    /// </summary>
    private async Task<List<SelectOption>> GetFilterProductOptions()
    {
        try
        {
            var options = new List<SelectOption>();
            
            // ç›®å‰æš«æ™‚é¡¯ç¤ºæ‰€æœ‰å•†å“ï¼Œæœªä¾†å¯ä»¥æ ¹æ“šå®¢æˆ¶-å•†å“é—œè¯ä¾†ç¯©é¸
            options.AddRange(products.Select(p => new SelectOption
            {
                Value = p.Id.ToString(),
                Text = $"{p.Code} - {p.Name}"
            }));
            
            return options;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å•†å“é¸é …æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return new List<SelectOption>();
        }
    }

    /// <summary>
    /// æ›´æ–°å•†å“ç¯©é¸é¸é … - ç•¶å®¢æˆ¶è®Šæ›´æ™‚èª¿ç”¨
    /// </summary>
    private async Task UpdateFilterProductOptions(int? customerId = null)
    {
        try
        {
            // æ‰¾åˆ°å•†å“ç¯©é¸æ¬„ä½ä¸¦æ›´æ–°å…¶é¸é …
            var filterProductField = formFields.FirstOrDefault(f => f.PropertyName == "FilterProductId");
            if (filterProductField != null)
            {
                var options = new List<SelectOption>();
                
                // ç›®å‰æš«æ™‚é¡¯ç¤ºæ‰€æœ‰å•†å“ï¼Œæœªä¾†å¯ä»¥æ ¹æ“šå®¢æˆ¶-å•†å“é—œè¯ä¾†ç¯©é¸
                options.AddRange(products.Select(p => new SelectOption
                {
                    Value = p.Id.ToString(),
                    Text = $"{p.Code} - {p.Name}"
                }));
                
                filterProductField.Options = options;
                
                // æ¸…ç©ºç›®å‰çš„å•†å“ç¯©é¸é¸æ“‡
                filterProductId = null;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æ›´æ–°å•†å“ç¯©é¸é¸é …æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// å–å¾—è¡¨å–®æ¬„ä½æ¸…å–®
    /// </summary>
    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }

    /// <summary>
    /// é…ç½® Modal ç®¡ç†å™¨
    /// </summary>
    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(SalesReturn.CustomerId), customerModalManager }
        };
    }

    /// <summary>
    /// ç”ŸæˆéŠ·å”®é€€è²¨å–®è™Ÿ
    /// </summary>
    private async Task<string> GenerateReturnNumberAsync()
    {
        return await EntityCodeGenerationHelper.GenerateForEntity<SalesReturn, ISalesReturnService>(SalesReturnService, DbContext);
    }

    // ===== éŠ·å”®é€€è²¨æ˜ç´°ç®¡ç†æ–¹æ³• =====
    
    /// <summary>
    /// è™•ç†å¯¦é«”è¼‰å…¥å®Œæˆäº‹ä»¶ï¼ˆç”± GenericEditModalComponent çš„å°èˆªè§¸ç™¼ï¼‰
    /// ç•¶ä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼Œé‡æ–°è¼‰å…¥å°æ‡‰çš„æ˜ç´°è³‡æ–™
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            // ğŸ”‘ é—œéµï¼šé‡ç½®ç‹€æ…‹æ¨™è¨˜
            isDetailDataReady = false;
            hasUndeletableDetails = false;
            
            // 1. é‡æ–°è¼‰å…¥æ˜ç´°è³‡æ–™
            await LoadSalesReturnDetails(loadedEntityId);
            
            // ğŸ”‘ é—œéµä¿®æ­£ï¼šç«‹å³è§¸ç™¼ UI æ›´æ–°ï¼Œç¢ºä¿ Table å…ƒä»¶æ”¶åˆ°æ–°çš„ ExistingReturnDetails åƒæ•¸
            // é€™æ¨£ RefreshDetailsAsync() æ‰èƒ½è®€å–åˆ°æ­£ç¢ºçš„æ˜ç´°è³‡æ–™
            StateHasChanged();
            
            // 2. è¼‰å…¥æ˜ç´°ç›¸é—œè³‡æ–™ï¼ˆæ²–æ¬¾è¨˜éŒ„ï¼‰ä»¥æª¢æŸ¥é–å®šç‹€æ…‹
            await LoadDetailRelatedDataAsync();
            isDetailDataReady = true;
            
            // 3. è§¸ç™¼ Table å…ƒä»¶åˆ·æ–°ï¼ˆæ­¤æ™‚ ExistingReturnDetails å·²ç¶“æ˜¯æ–°çš„è³‡æ–™ï¼‰
            if (salesReturnDetailManager != null)
            {
                await salesReturnDetailManager.RefreshDetailsAsync();
            }
            
            // 4. æœ€å¾Œå†æ¬¡æ›´æ–° UIï¼ˆç¢ºä¿æ‰€æœ‰è®Šæ›´éƒ½åæ˜ åœ¨ç•«é¢ä¸Šï¼‰
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleEntityLoaded), GetType(), 
                additionalData: $"è™•ç†å¯¦é«”è¼‰å…¥äº‹ä»¶å¤±æ•— - EntityId: {loadedEntityId}");
            await NotificationService.ShowErrorAsync("è¼‰å…¥æ˜ç´°è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
            isDetailDataReady = true; // å³ä½¿éŒ¯èª¤ä¹Ÿè¦å…è¨±æ¸²æŸ“
        }
    }
    
    /// <summary>
    /// è¼‰å…¥éŠ·å”®é€€è²¨æ˜ç´°
    /// </summary>
    private async Task LoadSalesReturnDetails(int salesReturnId)
    {
        try
        {
            salesReturnDetails = await SalesReturnDetailService.GetBySalesReturnIdAsync(salesReturnId);
            
            // âš ï¸ é—œéµï¼šè¼‰å…¥æ˜ç´°å¾Œå¿…é ˆåŒæ­¥è¼‰å…¥é—œè¯è³‡æ–™ï¼ˆProductï¼‰ï¼Œå¦å‰‡é–å®šæª¢æŸ¥æœƒå¤±æ•ˆ
            // å› ç‚º DetailLockHelper éœ€è¦è®€å– TotalPaidAmount æ¬„ä½
            if (salesReturnDetails.Any())
            {
                // æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼‰
                var hasUndeletable = salesReturnDetails.Any(d => 
                    DetailLockHelper.HasPaymentRecord(d));
                
                // åŒæ­¥æ›´æ–°é–å®šç‹€æ…‹
                if (hasUndeletableDetails != hasUndeletable)
                {
                    await HandleHasUndeletableDetailsChanged(hasUndeletable);
                }
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥é€€è²¨æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            salesReturnDetails = new List<SalesReturnDetail>();
        }
    }

    /// <summary>
    /// è™•ç†é€€è²¨æ˜ç´°è®Šæ›´ - è‡ªå‹•è¨ˆç®—ç¸½é‡‘é¡å’Œç¨…é¡
    /// </summary>
    private async Task HandleReturnDetailsChanged(List<SalesReturnDetail> details)
    {
        try
        {
            salesReturnDetails = details;
            
            if (editModalComponent?.Entity != null)
            {
                // æ ¹æ“šç¨…åˆ¥è¨ˆç®—é‡‘é¡å’Œç¨…é¡
                switch (editModalComponent.Entity.TaxCalculationMethod)
                {
                    case TaxCalculationMethod.TaxExclusive:
                        // å¤–åŠ ç¨…ï¼šé‡‘é¡ï¼ˆæœªç¨…ï¼‰= âˆ‘(æ•¸é‡ Ã— å–®åƒ¹ Ã— (1 - æŠ˜æ‰£%))
                        //        ç¨…é¡ = âˆ‘(å°è¨ˆ Ã— ç¨…ç‡%)
                        editModalComponent.Entity.TotalReturnAmount = Math.Round(
                            details.Where(d => d.ProductId > 0)
                                   .Sum(d => d.ReturnQuantity * d.OriginalUnitPrice * (1 - d.DiscountPercentage / 100)),
                            0, MidpointRounding.AwayFromZero);
                        
                        editModalComponent.Entity.ReturnTaxAmount = Math.Round(
                            details.Where(d => d.ProductId > 0)
                                   .Sum(d => d.ReturnQuantity * d.OriginalUnitPrice * (1 - d.DiscountPercentage / 100) * (d.TaxRate ?? 0) / 100),
                            0, MidpointRounding.AwayFromZero);
                        break;
                    
                    case TaxCalculationMethod.TaxInclusive:
                        // å…§å«ç¨…ï¼šç¸½é¡ï¼ˆå«ç¨…ï¼‰= âˆ‘(æ•¸é‡ Ã— å–®åƒ¹ Ã— (1 - æŠ˜æ‰£%))
                        //        ç¨…é¡ = âˆ‘(å°è¨ˆ / (1 + ç¨…ç‡%) Ã— ç¨…ç‡%)
                        //        é‡‘é¡ï¼ˆæœªç¨…ï¼‰= ç¸½é¡ - ç¨…é¡
                        var totalWithTax = Math.Round(
                            details.Where(d => d.ProductId > 0)
                                   .Sum(d => d.ReturnQuantity * d.OriginalUnitPrice * (1 - d.DiscountPercentage / 100)),
                            0, MidpointRounding.AwayFromZero);
                        
                        var taxAmount = Math.Round(
                            details.Where(d => d.ProductId > 0)
                                   .Sum(d => 
                                   {
                                       var subtotal = d.ReturnQuantity * d.OriginalUnitPrice * (1 - d.DiscountPercentage / 100);
                                       var taxRate = d.TaxRate ?? 0;
                                       return Math.Round(subtotal / (1 + taxRate / 100) * taxRate / 100, 0, MidpointRounding.AwayFromZero);
                                   }),
                            0, MidpointRounding.AwayFromZero);
                        
                        editModalComponent.Entity.ReturnTaxAmount = taxAmount;
                        editModalComponent.Entity.TotalReturnAmount = Math.Round(totalWithTax - taxAmount, 0, MidpointRounding.AwayFromZero);
                        break;
                    
                    case TaxCalculationMethod.NoTax:
                        // å…ç¨…ï¼šé‡‘é¡ = âˆ‘(æ•¸é‡ Ã— å–®åƒ¹ Ã— (1 - æŠ˜æ‰£%))
                        //      ç¨…é¡ = 0
                        editModalComponent.Entity.TotalReturnAmount = Math.Round(
                            details.Where(d => d.ProductId > 0)
                                   .Sum(d => d.ReturnQuantity * d.OriginalUnitPrice * (1 - d.DiscountPercentage / 100)),
                            0, MidpointRounding.AwayFromZero);
                        
                        editModalComponent.Entity.ReturnTaxAmount = 0;
                        break;
                }
                
                // âŒ ç§»é™¤ StateHasChanged() - è®“å‘¼å«è€…çµ±ä¸€è™•ç†æ¸²æŸ“
                // StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†é€€è²¨æ˜ç´°è®Šæ›´æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è™•ç†æœ‰ä¸å¯åˆªé™¤æ˜ç´°çš„ç‹€æ…‹è®Šæ›´
    /// ç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚(å·²æœ‰æ²–æ¬¾è¨˜éŒ„),é–å®šä¸»æª”çš„æ‰€æœ‰ä½¿ç”¨è€…å¯è¼¸å…¥æ¬„ä½
    /// </summary>
    private async Task HandleHasUndeletableDetailsChanged(bool hasUndeletable)
    {
        try
        {
            if (hasUndeletableDetails != hasUndeletable)
            {
                hasUndeletableDetails = hasUndeletable;
                
                // æ›´æ–°æ¬„ä½çš„å”¯è®€ç‹€æ…‹
                UpdateFieldsReadOnlyState();
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†æ˜ç´°é–å®šç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// æ ¹æ“š hasUndeletableDetails ç‹€æ…‹æ›´æ–°æ¬„ä½çš„å”¯è®€ç‹€æ…‹
    /// </summary>
    private void UpdateFieldsReadOnlyState()
    {
        // ä½¿ç”¨ FormFieldLockHelper æ‰¹æ¬¡é–å®š/è§£é–æ¬„ä½
        var fieldsToLock = new[]
        {
            nameof(SalesReturn.ReturnDate),
            nameof(SalesReturn.ReturnReasonId),
            "FilterProductId",
            nameof(BaseEntity.Remarks)
        };
        
        // é–å®šæˆ–è§£é–ä¸€èˆ¬æ¬„ä½ï¼ˆä¸éœ€è¦ ActionButtonsï¼‰
        FormFieldLockHelper.LockMultipleFieldsSimple(
            formFields, 
            fieldsToLock, 
            isLocked: hasUndeletableDetails
        );
        
        // ç‰¹æ®Šè™•ç†å®¢æˆ¶æ¬„ä½ï¼ˆéœ€è¦ ActionButtonsï¼‰
        if (hasUndeletableDetails)
        {
            // é–å®šï¼šç§»é™¤ ActionButtons
            FormFieldLockHelper.LockField(
                formFields,
                nameof(SalesReturn.CustomerId),
                isLocked: true
            );
        }
        else
        {
            // è§£é–ï¼šæ¢å¾© ActionButtons
            FormFieldLockHelper.LockField(
                formFields,
                nameof(SalesReturn.CustomerId),
                isLocked: false,
                actionButtonsGetter: GetCustomerActionButtonsAsync
            );
        }
    }

    /// <summary>
    /// å–å¾—ç‹€æ…‹è¨Šæ¯ï¼ˆé ‚éƒ¨å¾½ç« ï¼‰
    /// ç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚ï¼Œé¡¯ç¤ºé–å®šæç¤º
    /// </summary>
    private async Task<(string Message, GenericEditModalComponent<SalesReturn, ISalesReturnService>.BadgeVariant Variant, string IconClass)?> 
        GetStatusMessage()
    {
        try
        {
            if (!isDetailDataReady || editModalComponent?.Entity == null)
                return null;
            
            if (hasUndeletableDetails)
            {
                return (
                    "æ˜ç´°æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œä¸»æª”æ¬„ä½å·²é–å®š",
                    GenericEditModalComponent<SalesReturn, ISalesReturnService>.BadgeVariant.Warning,
                    "fas fa-lock"
                );
            }
            
            return null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetStatusMessage), GetType());
            return null;
        }
    }

    /// <summary>
    /// å–å¾—è­¦å‘Šè¨Šæ¯ï¼ˆè¡¨å–®é ‚éƒ¨ï¼‰
    /// ç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚ï¼Œé¡¯ç¤ºè©³ç´°èªªæ˜
    /// </summary>
    private RenderFragment? GetWarningMessage() => __builder =>
    {
            <GenericLockedFieldMessage IsVisible="@(isDetailDataReady && hasUndeletableDetails)"
                    Message="å› éƒ¨åˆ†æ˜ç´°æœ‰å…¶ä»–å‹•ä½œï¼Œç‚ºä¿è­·è³‡æ–™å®Œæ•´æ€§ä¸»æª”æ¬„ä½å·²è¨­å”¯è®€ã€‚"/>
    };

    /// <summary>
    /// è™•ç†æ¬„ä½å€¼è®Šæ›´äº‹ä»¶
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            switch (fieldChange.PropertyName)
            {
                case nameof(SalesReturn.CustomerId):
                    if (int.TryParse(fieldChange.Value?.ToString(), out var customerId))
                    {
                        // åªæœ‰åœ¨æ²’æœ‰ä¸å¯åˆªé™¤æ˜ç´°æ™‚æ‰æ›´æ–° ActionButtons
                        if (!hasUndeletableDetails)
                        {
                            await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                                customerModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                        }
                        
                        // å®¢æˆ¶è®Šæ›´æ™‚ï¼Œè§¸ç™¼é€€è²¨æ˜ç´°ç®¡ç†å™¨é‡æ–°æ¸²æŸ“
                        StateHasChanged();
                    }
                    break;

                case "FilterProductId":
                    if (int.TryParse(fieldChange.Value?.ToString(), out var productId))
                    {
                        filterProductId = productId == 0 ? null : productId;
                        // âœ… æ¬„ä½ä¾è³´è®ŠåŒ–ï¼šç¯©é¸æ¢ä»¶æ”¹è®Šéœ€è¦ç«‹å³æ›´æ–°æ˜ç´°è¡¨æ ¼
                        StateHasChanged();
                    }
                    break;

                case nameof(SalesReturn.SalesDeliveryId):
                    // âœ… æ¬„ä½ä¾è³´è®ŠåŒ–ï¼šéŠ·å”®å–®ç¯©é¸æ”¹è®Šéœ€è¦ç«‹å³æ›´æ–°æ˜ç´°è¡¨æ ¼
                    StateHasChanged();
                    break;
                
                case nameof(SalesReturn.TaxCalculationMethod):
                    // ç•¶ç¨…åˆ¥è®Šæ›´æ™‚ï¼Œé‡æ–°è¨ˆç®—é‡‘é¡å’Œç¨…é¡
                    await HandleReturnDetailsChanged(salesReturnDetails);
                    // ğŸ”‘ ç¨…åˆ¥è®Šæ›´æ™‚ï¼Œè§¸ç™¼ Table çµ„ä»¶é‡æ–°æ¸²æŸ“ï¼ˆå½±éŸ¿å°è¨ˆé¡¯ç¤ºï¼‰
                    StateHasChanged();
                    break;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†æ¬„ä½è®Šæ›´æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// é©—è­‰éŠ·å”®é€€è²¨æ˜ç´° - åœ¨å„²å­˜ä¸»æª”ä¹‹å‰åŸ·è¡Œ
    /// </summary>
    private async Task<bool> ValidateSalesReturnDetailsAsync(SalesReturn salesReturn)
    {
        try
        {
            // é©—è­‰å¿…å¡«æ¬„ä½
            if (salesReturn.CustomerId <= 0)
            {
                await NotificationService.ShowErrorAsync("è«‹é¸æ“‡å®¢æˆ¶");
                return false;
            }
            
            // é¦–å…ˆå‘¼å«æ˜ç´°ç®¡ç†å™¨çš„é©—è­‰æ–¹æ³•
            if (salesReturnDetailManager != null)
            {
                bool isValidDetails = await salesReturnDetailManager.ValidateAsync();
                if (!isValidDetails)
                {
                    return false;
                }
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„æ˜ç´°
            var validDetails = salesReturnDetails.Where(d => d.ProductId > 0 && d.ReturnQuantity > 0).ToList();
            if (!validDetails.Any())
            {
                await NotificationService.ShowErrorAsync("è‡³å°‘éœ€è¦ä¸€ç­†é€€è²¨æ˜ç´°");
                return false;
            }
            
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é©—è­‰é€€è²¨æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// è‡ªè¨‚å„²å­˜é‚è¼¯ - åŒæ™‚å„²å­˜ä¸»æª”å’Œæ˜ç´°ï¼Œä¸¦æ›´æ–°åº«å­˜
    /// </summary>
    private async Task<bool> SaveSalesReturnWithDetails(SalesReturn salesReturn)
    {
        try
        {
            if (salesReturn == null)
            {
                return false;
            }
            
            // å…ˆåŸ·è¡Œè‡ªè¨‚é©—è­‰
            if (!await ValidateSalesReturnDetailsAsync(salesReturn))
            {
                return false;
            }
            
            if (SalesReturnService == null)
            {
                return false;
            }
            
            if (salesReturnDetails == null)
            {
                salesReturnDetails = new List<SalesReturnDetail>();
            }
            
            // ğŸ”‘ å„²å­˜å‰å†æ¬¡è¨ˆç®—ç¸½é‡‘é¡å’Œç¨…é¡ï¼ˆç¢ºä¿è³‡æ–™ä¸€è‡´æ€§ï¼‰
            switch (salesReturn.TaxCalculationMethod)
            {
                case TaxCalculationMethod.TaxExclusive:
                    // å¤–åŠ ç¨…
                    salesReturn.TotalReturnAmount = Math.Round(
                        salesReturnDetails.Where(d => d.ProductId > 0)
                                         .Sum(d => d.ReturnQuantity * d.OriginalUnitPrice * (1 - d.DiscountPercentage / 100)),
                        0, MidpointRounding.AwayFromZero);
                    
                    salesReturn.ReturnTaxAmount = Math.Round(
                        salesReturnDetails.Where(d => d.ProductId > 0)
                                         .Sum(d => d.ReturnQuantity * d.OriginalUnitPrice * (1 - d.DiscountPercentage / 100) * (d.TaxRate ?? 0) / 100),
                        0, MidpointRounding.AwayFromZero);
                    break;
                
                case TaxCalculationMethod.TaxInclusive:
                    // å…§å«ç¨…
                    var totalWithTax = Math.Round(
                        salesReturnDetails.Where(d => d.ProductId > 0)
                                         .Sum(d => d.ReturnQuantity * d.OriginalUnitPrice * (1 - d.DiscountPercentage / 100)),
                        0, MidpointRounding.AwayFromZero);
                    
                    var taxAmount = Math.Round(
                        salesReturnDetails.Where(d => d.ProductId > 0)
                                         .Sum(d => 
                                         {
                                             var subtotal = d.ReturnQuantity * d.OriginalUnitPrice * (1 - d.DiscountPercentage / 100);
                                             var taxRate = d.TaxRate ?? 0;
                                             return Math.Round(subtotal / (1 + taxRate / 100) * taxRate / 100, 0, MidpointRounding.AwayFromZero);
                                         }),
                        0, MidpointRounding.AwayFromZero);
                    
                    salesReturn.ReturnTaxAmount = taxAmount;
                    salesReturn.TotalReturnAmount = Math.Round(totalWithTax - taxAmount, 0, MidpointRounding.AwayFromZero);
                    break;
                
                case TaxCalculationMethod.NoTax:
                    // å…ç¨…
                    salesReturn.TotalReturnAmount = Math.Round(
                        salesReturnDetails.Where(d => d.ProductId > 0)
                                         .Sum(d => d.ReturnQuantity * d.OriginalUnitPrice * (1 - d.DiscountPercentage / 100)),
                        0, MidpointRounding.AwayFromZero);
                    
                    salesReturn.ReturnTaxAmount = 0;
                    break;
            }
                        
            // å‘¼å«æœå‹™çš„ SaveWithDetailsAsync æ–¹æ³•
            var result = await SalesReturnService.SaveWithDetailsAsync(salesReturn, salesReturnDetails);
            
            if (result == null)
            {
                return false;
            }
            
            if (!result.IsSuccess)
            {
                await NotificationService.ShowErrorAsync($"å„²å­˜å¤±æ•—ï¼š{result.ErrorMessage}");
                return false;
            }

            // ğŸ”¥ é—œéµï¼šå„²å­˜æˆåŠŸå¾Œï¼Œä½¿ç”¨å·®ç•°è¨ˆç®—æ›´æ–°åº«å­˜
            if (result.Data != null)
            {
                await UpdateInventoryByDifferenceAsync(result.Data.Id);
            }
            
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å„²å­˜éŠ·è²¨é€€å›æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// é…ç½®è‡ªè¨‚æ¨¡çµ„
    /// </summary>
    private List<GenericEditModalComponent<SalesReturn, ISalesReturnService>.CustomModule> GetCustomModules()
    {
        try
        {
            return new List<GenericEditModalComponent<SalesReturn, ISalesReturnService>.CustomModule>
            {
                new()
                {
                    Title = "",
                    Content = CreateReturnDetailManagerContent(),
                    Order = 1
                }
            };
        }
        catch
        {
            return new List<GenericEditModalComponent<SalesReturn, ISalesReturnService>.CustomModule>();
        }
    }

    /// <summary>
    /// å‰µå»ºé€€è²¨æ˜ç´°ç®¡ç†å™¨å…§å®¹çš„ RenderFragment
    /// </summary>
    private RenderFragment CreateReturnDetailManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null)
            {
                @if (!isDetailDataReady)
                {
                    <div class="d-flex justify-content-center align-items-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span class="text-muted">è¼‰å…¥æ˜ç´°è³‡æ–™ä¸­...</span>
                    </div>
                }
                // æª¢æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„å•†å“å’Œå€‰åº«è³‡æ–™
                else if (products != null && products.Any() && warehouses != null && warehouses.Any())
                {
                    // æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡å®¢æˆ¶
                    @if (editModalComponent.Entity.CustomerId > 0)
                    {
                        <SalesReturnTable @ref="salesReturnDetailManager"
                            Products="@products"
                            CustomerId="@(editModalComponent?.Entity?.CustomerId)"
                            FilterSalesDeliveryId="@FilterSalesDeliveryId"
                            FilterProductId="@FilterProductId"
                            ExistingReturnDetails="@salesReturnDetails"
                            TaxCalculationMethod="@(editModalComponent?.Entity?.TaxCalculationMethod ?? TaxCalculationMethod.TaxExclusive)"
                            OnReturnDetailsChanged="@HandleReturnDetailsChanged"
                            OnHasUndeletableDetailsChanged="@HandleHasUndeletableDetailsChanged"
                            OnOpenRelatedDocument="@HandleOpenRelatedDocument"
                            IsEditMode="@SalesReturnId.HasValue" />
                    }
                    else
                    {
                        <div class="alert alert-info text-center" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            è«‹å…ˆé¸æ“‡å®¢æˆ¶å¾Œå†é€²è¡Œé€€è²¨æ˜ç´°ç®¡ç†
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-warning text-center" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ç„¡å¯ç”¨çš„å•†å“æˆ–å€‰åº«è³‡æ–™ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡
                    </div>
                }
            }
            else
            {
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
            }
        }
        catch
        {
            <div class="alert alert-warning text-center" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                æ˜ç´°ç®¡ç†å™¨è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚
            </div>
        }
    };
    
    /// <summary>
    /// ç”¢ç”Ÿå®¢æˆ¶æ“ä½œæŒ‰éˆ• - ä½¿ç”¨çµ±ä¸€ Helper
    /// ğŸ”‘ é—œéµï¼šç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚ï¼Œä¸é¡¯ç¤º ActionButtons
    /// </summary>
    private async Task<List<FieldActionButton>> GetCustomerActionButtonsAsync()
    {
        // ğŸ”‘ é—œéµï¼šç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚ï¼Œä¸é¡¯ç¤º ActionButtons
        if (hasUndeletableDetails)
        {
            return new List<FieldActionButton>();
        }
        
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            customerModalManager, 
            nameof(SalesReturn.CustomerId)
        );
    }

    /// <summary>
    /// åŒ…è£å®¢æˆ¶å„²å­˜äº‹ä»¶
    /// </summary>
    private async Task OnCustomerSavedWrapper(Customer savedCustomer)
    {
        await customerModalManager.HandleEntitySavedAsync(savedCustomer, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// è™•ç†é–‹å•Ÿç›¸é—œå–®æ“šçš„äº‹ä»¶
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            if (args.type == RelatedDocumentType.SetoffDocument)
            {
                // é–‹å•Ÿæ²–æ¬¾å–®
                selectedSetoffDocumentId = args.id;
                showSetoffDocumentModal = true;
                StateHasChanged();
            }
            else
            {
                await NotificationService.ShowWarningAsync("ä¸æ”¯æ´çš„å–®æ“šé¡å‹", "æç¤º");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é–‹å•Ÿå–®æ“šå¤±æ•—ï¼š{ex.Message}");
        }
    }
    
    /// <summary>
    /// è™•ç†æ²–æ¬¾å–®å„²å­˜å¾Œçš„äº‹ä»¶
    /// </summary>
    /// <summary>
    /// è™•ç†æ²–æ¬¾å–®å„²å­˜å¾Œçš„äº‹ä»¶
    /// ä½¿ç”¨ ChildDocumentRefreshHelper çµ±ä¸€è™•ç†åˆ·æ–°é‚è¼¯
    /// </summary>
    private async Task HandleSetoffDocumentSaved(SetoffDocument savedDocument)
    {
        try
        {
            await ChildDocumentRefreshHelper.HandleChildDocumentSavedSimpleAsync(
                closeModal: () =>
                {
                    showSetoffDocumentModal = false;
                },
                stateHasChanged: StateHasChanged,
                additionalActions: async () =>
                {
                    // é—œéµä¿®å¾©ï¼šå‘¼å« Table çµ„ä»¶çš„å…¬é–‹åˆ·æ–°æ–¹æ³•
                    // é‡æ–°è¼‰å…¥æ˜ç´°è³‡æ–™ä»¥æ›´æ–°æ²–æ¬¾ç›¸é—œè³‡è¨Š
                    if (salesReturnDetailManager != null)
                    {
                        await salesReturnDetailManager.RefreshDetails();
                    }
                    
                    await NotificationService.ShowSuccessAsync("æ²–æ¬¾å–®å·²æ›´æ–°ï¼ŒéŠ·å”®é€€è²¨æ˜ç´°å·²åˆ·æ–°");
                }
            );
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†æ²–æ¬¾å–®å„²å­˜äº‹ä»¶å¤±æ•—ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// å»ºç«‹åº«å­˜äº¤æ˜“è¨˜éŒ„ - æ–°å¢æ¨¡å¼ï¼ˆå·²æ£„ç”¨ï¼Œæ”¹ç”¨ UpdateInventoryByDifferenceAsyncï¼‰
    /// </summary>
    private async Task CreateInventoryTransactionsAsync(List<SalesReturnDetail> details, string returnNumber)
    {
        // ğŸ”¥ æ–°ç‰ˆæœ¬çµ±ä¸€ä½¿ç”¨ UpdateInventoryByDifferenceAsync è™•ç†æ–°å¢å’Œç·¨è¼¯
        // é€™å€‹æ–¹æ³•ä¿ç•™åªæ˜¯ç‚ºäº†å‘ä¸‹ç›¸å®¹ï¼Œå¯¦éš›ä¸å†ä½¿ç”¨
        await Task.CompletedTask;
    }

    /// <summary>
    /// ä½¿ç”¨å·®ç•°æ¯”è¼ƒæ›´æ–°åº«å­˜ï¼ˆçµ±ä¸€è™•ç†æ–°å¢å’Œç·¨è¼¯ï¼‰
    /// </summary>
    private async Task UpdateInventoryByDifferenceAsync(int salesReturnId)
    {
        var inventoryUpdateResult = await SalesReturnService.UpdateInventoryByDifferenceAsync(salesReturnId);
        
        if (!inventoryUpdateResult.IsSuccess)
        {
            await NotificationService.ShowErrorAsync($"åº«å­˜æ›´æ–°å¤±æ•—ï¼š{inventoryUpdateResult.ErrorMessage}");
            throw new Exception($"åº«å­˜æ›´æ–°å¤±æ•—ï¼š{inventoryUpdateResult.ErrorMessage}");
        }
    }

    /// <summary>
    /// é‡‹æ”¾è³‡æº
    /// </summary>
    public void Dispose()
    {
        try
        {
            // æ¸…ç†è³‡æº
            editModalComponent = null;
            salesReturnDetailManager = null;
            // customerEditModal = null;
            
            // æ¸…ç†äº‹ä»¶è¨‚é–±ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            // ...
        }
        catch
        {
            // å¿½ç•¥æ¸…ç†éç¨‹ä¸­çš„éŒ¯èª¤
        }
    }
}

