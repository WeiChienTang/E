@* 銷售退貨編輯模態組件 *@
@using ERPCore2.Services.Reports.Interfaces
@using ERPCore2.Models.Reports
@inject ISalesReturnService SalesReturnService
@inject ISalesReturnDetailService SalesReturnDetailService
@inject ISalesDeliveryService SalesDeliveryService
@inject ISalesDeliveryDetailService SalesDeliveryDetailService
@inject IWarehouseService WarehouseService
@inject IWarehouseLocationService WarehouseLocationService
@inject ISalesReturnReasonService SalesReturnReasonService
@inject INotificationService NotificationService
@inject ICustomerService CustomerService
@inject IEmployeeService EmployeeService
@inject IProductService ProductService
@inject ISystemParameterService SystemParameterService
@inject ActionButtonHelper ActionButtonHelper
@inject ISetoffDocumentService SetoffDocumentService
@inject ISalesReturnReportService SalesReturnReportService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ERPCore2.Data.Context.AppDbContext DbContext
@implements IDisposable

@using ERPCore2.FieldConfiguration
@using ERPCore2.Models.Enums
@using ERPCore2.Helpers.InteractiveTableComponentHelper

<GenericEditModalComponent TEntity="SalesReturn" 
                          TService="ISalesReturnService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@SalesReturnId"
                          Service="@SalesReturnService"
                          EntityName="銷售退貨"
                          EntityNamePlural="銷售退貨"
                          ModalTitle="@(SalesReturnId.HasValue ? "編輯銷售退貨" : "新增退貨單")"
                          Size="GenericEditModalComponent<SalesReturn, ISalesReturnService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@(autoCompleteConfig?.Prefillers)"
                          AutoCompleteCollections="@(autoCompleteConfig?.Collections)"
                          AutoCompleteDisplayProperties="@(autoCompleteConfig?.DisplayProperties)"
                          AutoCompleteValueProperties="@(autoCompleteConfig?.ValueProperties)"
                          ModalManagers="@modalManagers?.AsDictionary()"
                          DataLoader="@LoadSalesReturnData"
                          UseGenericSave="false"
                          CustomValidator="@ValidateSalesReturnDetailsAsync"
                          SaveHandler="@SaveSalesReturnWithDetails"
                          SaveSuccessMessage="@(SalesReturnId.HasValue ? "銷售退貨更新成功" : "銷售退貨新增成功")"
                          SaveFailureMessage="銷售退貨儲存失敗"
                          RequiredPermission="SalesReturn.Read"
                          OnEntitySaved="@OnSalesReturnSaved"
                          OnCancel="@OnCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          OnTaxMethodChanged="@(() => HandleReturnDetailsChanged(salesReturnDetails))"
                          GetStatusMessage="@GetStatusMessage"
                          FormHeaderContent="@GetWarningMessage()"
                          CustomModules="@GetCustomModules()"
                          CustomActionButtons="@GetCustomActionButtons()"
                          ShowPrintButton="true"
                          ReportService="@SalesReturnReportService"
                          ReportId="@ReportIds.SalesReturn"
                          ReportPreviewTitle="銷貨退回單預覽"
                          GetReportDocumentName="@(e => $"銷貨退回單-{e.Code}")"
/>

@* 客戶編輯 Modal *@
<CustomerEditModalComponent @ref="customerEditModal"
                           IsVisible="@customerModalManager.IsModalVisible"
                           IsVisibleChanged="@customerModalManager.HandleModalVisibilityChangedAsync"
                           CustomerId="@customerModalManager.SelectedEntityId"
                           OnCustomerSaved="@customerModalManager.OnSavedAsync"
                           OnCancel="@customerModalManager.HandleModalCancelAsync" />

@* 沖款單編輯 Modal *@
<SetoffDocumentEditModalComponent @ref="setoffDocumentEditModal"
                                 IsVisible="@showSetoffDocumentModal"
                                 IsVisibleChanged="@((bool visible) => showSetoffDocumentModal = visible)"
                                 SetoffDocumentId="@selectedSetoffDocumentId"
                                 OnSetoffDocumentSaved="@HandleSetoffDocumentSaved"
                                 OnCancel="@(() => showSetoffDocumentModal = false)" />

@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SalesReturnId { get; set; }
    [Parameter] public EventCallback<SalesReturn> OnSalesReturnSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== 預填參數（用於從出貨單轉單） =====
    [Parameter] public int? PrefilledCustomerId { get; set; }
    [Parameter] public int? PrefilledSalesDeliveryId { get; set; }  // 從出貨單轉退貨時使用

    // ===== 內部狀態 =====
    
    private GenericEditModalComponent<SalesReturn, ISalesReturnService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // 原始資料集合（用於 AutoComplete）
    private List<SalesDelivery> availableSalesDeliveries = new();
    private List<Warehouse> availableWarehouses = new();
    private List<WarehouseLocation> availableWarehouseLocations = new();
    private List<Customer> availableCustomers = new();
    private List<Employee> availableEmployees = new();
    private List<Product> availableProducts = new();
    private List<ERPCore2.Data.Entities.SalesReturnReason> availableReturnReasons = new();
    
    // 下拉選單選項（向下相容，用於過濾後的選項）
    private List<SalesDelivery> salesDeliveries = new();
    private List<Warehouse> warehouses = new();
    private List<WarehouseLocation> warehouseLocations = new();
    private List<Customer> customers = new();
    private List<Employee> employees = new();
    private List<Product> products = new();
    private List<ERPCore2.Data.Entities.SalesReturnReason> returnReasons = new();
    private List<SelectOption> taxCalculationMethodOptions = new();
    
    // AutoComplete 配置
    private AutoCompleteConfig? autoCompleteConfig;
    
    // ===== 銷售退貨明細 =====
    private List<SalesReturnDetail> salesReturnDetails = new();
    private SalesReturnTable? salesReturnDetailManager;
    
    // 方案 D 改良版：資料版本計數器
    private int _detailsDataVersion = 0;
    
    // ===== 篩選狀態 =====
    private int? filterProductId = null;
    private int? FilterProductId => filterProductId;
    private int? FilterSalesDeliveryId = null;
    
    // ===== 明細載入狀態 =====
    private bool shouldAutoLoadReturnable = false;  // 標記是否需要自動載入可退貨商品
    
    // ===== 稅率快取 =====
    private decimal currentTaxRate = 5.0m; // 預設 5%，實際值會在初始化時從資料庫載入
    
    // ===== 鎖定狀態 =====
    private bool hasUndeletableDetails = false;
    private bool isDetailDataReady = false;
    
    // ===== Modal Manager 集合 =====
    private ModalManagerCollection? modalManagers;
    
    // ===== Modal 管理器 =====
    private CustomerEditModalComponent? customerEditModal;
    private RelatedEntityModalManager<Customer> customerModalManager = default!;
    
    // ===== 相關單據 Modal =====
    private SetoffDocumentEditModalComponent? setoffDocumentEditModal;
    private bool showSetoffDocumentModal = false;
    private int? selectedSetoffDocumentId = null;
    
    // 資料載入狀態標記
    private bool isDataLoaded = false;

    // ===== 必要方法 =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 使用 ModalManagerInitHelper 初始化所有 Manager
            modalManagers = ModalManagerInitHelper.CreateBuilder<SalesReturn, ISalesReturnService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Customer>(nameof(SalesReturn.CustomerId), "客戶")
                .Build();
            
            // 取得個別 Manager 供組件使用
            customerModalManager = modalManagers.Get<Customer>(nameof(SalesReturn.CustomerId));
            
            // 移除自動載入資料，改為在 OnParametersSetAsync 中根據 IsVisible 載入
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化組件時發生錯誤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        try
        {
            if (IsVisible && !isDataLoaded)
            {
                await LoadAdditionalDataAsync();
                await InitializeFormFieldsAsync();
                isDataLoaded = true;
                
                // 再次觸發選項更新（在表單欄位初始化後）
                // 當從出貨單轉單時，確保銷售單選項正確篩選
                if (PrefilledCustomerId.HasValue && PrefilledCustomerId.Value > 0)
                {
                    await UpdateSalesDeliveryOptions(PrefilledCustomerId.Value);
                    await UpdateFilterProductOptions(PrefilledCustomerId.Value);
                    StateHasChanged(); // 強制UI更新
                }
            }
            else if (!IsVisible)
            {
                //  Modal 關閉時重置自動載入相關標記和資料載入標記
                shouldAutoLoadReturnable = false;
                isDataLoaded = false;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"參數設置時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 開啟新增銷售退貨單 Modal 並預填出貨單資訊（公開方法供外部調用）
    /// </summary>
    public async Task ShowAddModalWithPrefilledDelivery(int customerId, int salesDeliveryId)
    {
        try
        {
            // 使用 DocumentConversionHelper 統一處理轉單邏輯
            var success = await DocumentConversionHelper.ShowConversionModalAsync(
                setPrefilledValues: () =>
                {
                    SalesReturnId = null;
                    PrefilledCustomerId = customerId;
                    PrefilledSalesDeliveryId = salesDeliveryId;
                    shouldAutoLoadReturnable = true;
                },
                isVisibleChanged: IsVisibleChanged,
                autoLoadAction: async () =>
                {
                    shouldAutoLoadReturnable = false;
                    if (salesReturnDetailManager != null)
                    {
                        await salesReturnDetailManager.LoadAllReturnableItems();
                    }
                },
                detailManagerReady: () => salesReturnDetailManager != null,
                shouldAutoLoad: () => shouldAutoLoadReturnable,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("轉單流程執行失敗");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledDelivery), GetType(), 
                additionalData: $"開啟預填銷售退貨單Modal失敗 - CustomerId: {customerId}, DeliveryId: {salesDeliveryId}");
            await NotificationService.ShowErrorAsync("開啟銷售退貨單時發生錯誤");
        }
    }
    /// <summary>
    /// 載入銷售退貨資料
    /// </summary>
    private async Task<SalesReturn?> LoadSalesReturnData()
    {
        try
        {
            isDetailDataReady = false;
            hasUndeletableDetails = false;
            
            if (SalesReturnId.HasValue)
            {
                // 編輯模式：載入現有資料
                var salesReturn = await SalesReturnService.GetByIdAsync(SalesReturnId.Value);
                if (salesReturn != null)
                {
                    // 載入對應的退貨明細
                    await LoadSalesReturnDetails(salesReturn.Id);
                    
                    //  關鍵：載入明細相關資料（沖款記錄）
                    await LoadDetailRelatedDataAsync();
                    isDetailDataReady = true;
                    StateHasChanged();
                }
                else
                {
                    isDetailDataReady = true;
                }
                return salesReturn;
            }
            else
            {
                // 新增模式：建立新的退貨單並生成退貨單號
                var newSalesReturn = new SalesReturn
                {
                    Code = await GenerateReturnNumberAsync(),
                    ReturnDate = DateTime.Today,
                    TotalReturnAmount = 0,
                    ReturnReasonId = null // 預設為 null，選擇性填寫
                };
                
                //  使用預填參數（從出貨單轉單時）
                if (PrefilledCustomerId.HasValue && PrefilledCustomerId.Value > 0)
                {
                    newSalesReturn.CustomerId = PrefilledCustomerId.Value;
                }
                
                if (PrefilledSalesDeliveryId.HasValue && PrefilledSalesDeliveryId.Value > 0)
                {
                    newSalesReturn.SalesDeliveryId = PrefilledSalesDeliveryId.Value;
                    // 設定篩選條件，讓明細管理器只顯示這張出貨單的可退貨商品
                    FilterSalesDeliveryId = PrefilledSalesDeliveryId.Value;
                }
                
                // 初始化空的明細列表
                salesReturnDetails = new List<SalesReturnDetail>();
                isDetailDataReady = true;
                
                return newSalesReturn;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入銷售退貨資料時發生錯誤：{ex.Message}");
            isDetailDataReady = true; // 錯誤也要允許渲染
            return null;
        }
    }

    /// <summary>
    /// 載入明細相關資料（沖款記錄）- 用於判斷是否有不可刪除的明細
    /// 必須在 DataLoader 中同步執行，確保狀態訊息正確顯示
    /// </summary>
    private async Task LoadDetailRelatedDataAsync()
    {
        try
        {
            if (!salesReturnDetails.Any())
            {
                hasUndeletableDetails = false;
                return;
            }

            bool hasUndeletable = false;
            
            foreach (var detail in salesReturnDetails.Where(d => d.Id > 0))
            {
                // 檢查沖款記錄
                if (detail.TotalPaidAmount > 0)
                {
                    hasUndeletable = true;
                    break;
                }
            }
            
            hasUndeletableDetails = hasUndeletable;
            
            if (hasUndeletableDetails)
            {
                UpdateFieldsReadOnlyState();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDetailRelatedDataAsync), GetType());
            hasUndeletableDetails = false;
        }
    }

    /// <summary>
    /// 載入額外資料
    /// </summary>
    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            await LoadsalesDeliveriesAsync();
            await LoadWarehousesAsync();
            await LoadWarehouseLocationsAsync();
            await LoadCustomersAsync();
            await LoadEmployeesAsync();
            await LoadProductsAsync();
            await LoadReturnReasonsAsync();
            
            //  一次性載入系統稅率（避免每次計算都查詢資料庫）
            await LoadTaxRateAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入額外資料時發生錯誤：{ex.Message}");
        }
    }

    private async Task LoadsalesDeliveriesAsync()
    {
        try
        {
            availableSalesDeliveries = await SalesDeliveryService.GetAllAsync();
            salesDeliveries = availableSalesDeliveries; // 向下相容
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入出貨單資料時發生錯誤：{ex.Message}");
            availableSalesDeliveries = new List<SalesDelivery>();
            salesDeliveries = new List<SalesDelivery>();
        }
    }

    private async Task LoadWarehousesAsync()
    {
        try
        {
            availableWarehouses = await WarehouseService.GetAllAsync();
            warehouses = availableWarehouses; // 向下相容
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入倉庫資料時發生錯誤：{ex.Message}");
            availableWarehouses = new List<Warehouse>();
            warehouses = new List<Warehouse>();
        }
    }

    private async Task LoadWarehouseLocationsAsync()
    {
        try
        {
            availableWarehouseLocations = await WarehouseLocationService.GetAllAsync();
            warehouseLocations = availableWarehouseLocations; // 向下相容
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入倉庫位置資料時發生錯誤：{ex.Message}");
            availableWarehouseLocations = new List<WarehouseLocation>();
            warehouseLocations = new List<WarehouseLocation>();
        }
    }

    private async Task LoadCustomersAsync()
    {
        try
        {
            availableCustomers = await CustomerService.GetAllAsync();
            customers = availableCustomers; // 向下相容
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入客戶資料時發生錯誤：{ex.Message}");
            availableCustomers = new List<Customer>();
            customers = new List<Customer>();
        }
    }

    private async Task LoadEmployeesAsync()
    {
        try
        {
            var result = await EmployeeService.GetActiveEmployeesAsync();
            if (result.IsSuccess && result.Data != null)
            {
                availableEmployees = result.Data;
                employees = availableEmployees; // 向下相容
            }
            else
            {
                availableEmployees = new List<Employee>();
                employees = new List<Employee>();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入員工資料時發生錯誤：{ex.Message}");
            availableEmployees = new List<Employee>();
            employees = new List<Employee>();
        }
    }

    private async Task LoadProductsAsync()
    {
        try
        {
            availableProducts = await ProductService.GetAllAsync();
            products = availableProducts; // 向下相容
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入商品資料時發生錯誤：{ex.Message}");
            availableProducts = new List<Product>();
            products = new List<Product>();
        }
    }

    private async Task LoadReturnReasonsAsync()
    {
        try
        {
            availableReturnReasons = await SalesReturnReasonService.GetActiveReasonsAsync();
            returnReasons = availableReturnReasons; // 向下相容
            
            // 配置 AutoComplete - 使用 available* 集合確保顯示完整資料
            autoCompleteConfig = new AutoCompleteConfigBuilder<SalesReturn>()
                .AddField(nameof(SalesReturn.CustomerId), "CompanyName", availableCustomers)
                .AddField(nameof(SalesReturn.SalesDeliveryId), "Code", availableSalesDeliveries)
                .AddField("FilterProductId", "Name", availableProducts)
                .Build();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入退貨原因資料時發生錯誤：{ex.Message}");
            availableReturnReasons = new List<ERPCore2.Data.Entities.SalesReturnReason>();
            returnReasons = new List<ERPCore2.Data.Entities.SalesReturnReason>();
        }
    }

    /// <summary>
    /// 載入系統稅率 - 一次性載入並快取，避免每次計算都查詢資料庫
    /// </summary>
    private async Task LoadTaxRateAsync()
    {
        currentTaxRate = await TaxCalculationHelper.LoadTaxRateAsync(SystemParameterService);
    }

    /// <summary>
    /// 更新銷售單選項 - 根據客戶ID過濾，並排除已完成的銷售單
    /// </summary>
    private async Task UpdateSalesDeliveryOptions(int? customerId = null)
    {
        try
        {
            var filteredsalesDeliveries = salesDeliveries;

            if (customerId.HasValue)
            {
                // 根據選擇的客戶過濾銷售單
                filteredsalesDeliveries = salesDeliveries
                    .Where(so => so.CustomerId == customerId.Value && !IsDeliveryFullyReturned(so))
                    .ToList();
            }
            else
            {
                // 顯示所有未完全退貨的銷售單
                filteredsalesDeliveries = salesDeliveries
                    .Where(so => !IsDeliveryFullyReturned(so))
                    .ToList();
            }

            // 更新表單中銷售單選項
            var salesDeliveryField = formFields.FirstOrDefault(f => f.PropertyName == nameof(SalesReturn.SalesDeliveryId));
            if (salesDeliveryField != null)
            {
                salesDeliveryField.Options = filteredsalesDeliveries.Select(so => new SelectOption
                {
                    Text = so.Code ?? string.Empty,
                    Value = so.Id.ToString()
                }).ToList();
                
                // ❌ 移除 StateHasChanged() - 讓呼叫者統一控制渲染
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"更新銷售單選項時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 判斷銷售單是否已完全退貨
    /// 退貨條件：所有明細都已完成退貨（退貨數量 == 銷售數量 或 標記為已完成）
    /// </summary>
    private bool IsDeliveryFullyReturned(SalesDelivery salesDelivery)
    {
        try
        {
            // 如果沒有明細，視為未完成
            if (salesDelivery.DeliveryDetails == null || !salesDelivery.DeliveryDetails.Any())
                return false;

            // 這裡需要實作檢查邏輯，暫時回傳 false
            // 檢查所有明細是否都已完成退貨
            // return salesDelivery.DeliveryDetails.All(detail => detail.ReturnedQuantity >= detail.Quantity);
            return false;
        }
        catch
        {
            // 發生錯誤時，視為未完成
            return false;
        }
    }

    /// <summary>
    /// 初始化表單欄位
    /// </summary>
    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SalesReturn.Code),
                    Label = "退貨單號",
                    FieldType = FormFieldType.Text,
                    Placeholder = "系統自動產生",
                    IsRequired = true,
                    IsReadOnly = true,
                    MaxLength = 50,
                    HelpText = "系統自動產生的退貨單號"
                },
                new()
                {
                    PropertyName = nameof(SalesReturn.CustomerId),
                    Label = "客戶",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇客戶",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "輸入客戶名稱進行篩選，或直接選擇",
                    ActionButtons = await GetCustomerActionButtonsAsync(), //  根據 hasUndeletableDetails 決定是否顯示
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = "FilterProductId", // 篩選用的虛擬欄位，不儲存至資料庫
                    Label = "商品",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇商品",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "輸入商品代碼或名稱進行篩選，或留空顯示所有商品。此欄位不會儲存。",
                    IsReadOnly = hasUndeletableDetails,
                    IsFilterOnly = true
                },
                new()
                {
                    PropertyName = nameof(SalesReturn.SalesDeliveryId),
                    Label = "銷貨單",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請選擇銷貨單號",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "可選擇特定銷貨單進行篩選，或留空使用多銷貨單模式",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(SalesReturn.ReturnDate),
                    Label = "退貨日期",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "貨品實際退貨日期",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(SalesReturn.ReturnReasonId),
                    Label = "退貨原因",
                    FieldType = FormFieldType.Select,
                    IsRequired = false,
                    Options = new List<SelectOption> {}
                    .Concat(returnReasons.Select(r => new SelectOption
                    {
                        Text = r.Name,
                        Value = r.Id.ToString()
                    })).ToList(),
                    HelpText = "選擇性填寫退貨原因",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },

                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesReturn.TotalReturnAmount),
                    Label = "金額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "退貨單的總金額，根據明細自動計算",
                    IsReadOnly = true, // 總金額欄位始終為唯讀
                    CssClass = "text-warning fw-bold" // 使用黃色粗體顯示
                },

                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesReturn.DiscountAmount),
                    Label = "折扣",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "退貨單的折扣金額，根據明細自動計算",
                    IsReadOnly = true,
                    CssClass = "text-danger fw-bold" // 使用紅色粗體顯示
                },
                
                new FormFieldDefinition
                {
                    PropertyName = nameof(SalesReturn.ReturnTaxAmount),
                    Label = "稅額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "退貨單的稅額，根據明細自動計算",
                    IsReadOnly = true, // 稅額欄位始終為唯讀
                    CssClass = "text-info fw-bold" // 使用藍色粗體顯示
                },
                new FormFieldDefinition
                {
                    PropertyName = nameof(SalesReturn.TotalReturnAmountWithTax),
                    Label = "總額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "退貨單的含稅總金額，根據明細自動計算",
                    IsReadOnly = true, // 含稅總金額欄位始終為唯讀
                    CssClass = "text-success fw-bold" // 使用綠色粗體顯示
                },

                FormFieldConfigurationHelper.CreateRemarksField<SalesReturn>(
                    readOnly: hasUndeletableDetails // 根據明細狀態決定是否鎖定
                )
            };

            formSections = FormSectionHelper<SalesReturn>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    sr => sr.Code,
                    sr => sr.CustomerId,
                    sr => sr.SalesDeliveryId,
                    sr => sr.ReturnReasonId,
                    sr => sr.ReturnDate)
                .AddCustomFields(FormSectionNames.FilterConditions, "FilterProductId")  // 虛擬篩選欄位，不存DB
                .AddToSection(FormSectionNames.AmountInfo,
                    sr => sr.TotalReturnAmount,
                    sr => sr.DiscountAmount,
                    sr => sr.ReturnTaxAmount,
                    sr => sr.TotalReturnAmountWithTax)
                .AddToSection(FormSectionNames.OtherInfo,
                    sr => sr.Remarks)
                .Build();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"初始化表單欄位時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 取得商品篩選選項 - 根據選擇的客戶篩選
    /// </summary>
    private async Task<List<SelectOption>> GetFilterProductOptions()
    {
        try
        {
            var options = new List<SelectOption>();
            
            // 目前暫時顯示所有商品，未來可以根據客戶-商品關聯來篩選
            options.AddRange(products.Select(p => new SelectOption
            {
                Value = p.Id.ToString(),
                Text = $"{p.Code} - {p.Name}"
            }));
            
            return options;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入商品選項時發生錯誤：{ex.Message}");
            return new List<SelectOption>();
        }
    }

    /// <summary>
    /// 更新商品篩選選項 - 當客戶變更時調用
    /// </summary>
    private async Task UpdateFilterProductOptions(int? customerId = null)
    {
        try
        {
            // 找到商品篩選欄位並更新其選項
            var filterProductField = formFields.FirstOrDefault(f => f.PropertyName == "FilterProductId");
            if (filterProductField != null)
            {
                var options = new List<SelectOption>();
                
                // 目前暫時顯示所有商品，未來可以根據客戶-商品關聯來篩選
                options.AddRange(products.Select(p => new SelectOption
                {
                    Value = p.Id.ToString(),
                    Text = $"{p.Code} - {p.Name}"
                }));
                
                filterProductField.Options = options;
                
                // 清空目前的商品篩選選擇
                filterProductId = null;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"更新商品篩選選項時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 生成銷售退貨單號
    /// </summary>
    private async Task<string> GenerateReturnNumberAsync()
    {
        return await EntityCodeGenerationHelper.GenerateForEntity<SalesReturn, ISalesReturnService>(SalesReturnService, DbContext);
    }
    /// <summary>
    /// 載入銷售退貨明細
    /// </summary>
    private async Task LoadSalesReturnDetails(int salesReturnId)
    {
        try
        {
            salesReturnDetails = await SalesReturnDetailService.GetBySalesReturnIdAsync(salesReturnId);
            
            // 方案 D 改良版：遞增版本號
            _detailsDataVersion++;
            
            // ⚠️ 關鍵：載入明細後必須同步載入關聯資料（Product），否則鎖定檢查會失效
            // 因為 DetailLockHelper 需要讀取 TotalPaidAmount 欄位
            if (salesReturnDetails.Any())
            {
                // 檢查是否有不可刪除的明細（已有沖款記錄）
                var hasUndeletable = salesReturnDetails.Any(d => 
                    DetailLockHelper.HasPaymentRecord(d));
                
                // 同步更新鎖定狀態
                if (hasUndeletableDetails != hasUndeletable)
                {
                    await HandleHasUndeletableDetailsChanged(hasUndeletable);
                }
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入退貨明細時發生錯誤：{ex.Message}");
            salesReturnDetails = new List<SalesReturnDetail>();
        }
    }

    /// <summary>
    /// 處理退貨明細變更 - 自動計算總金額和稅額
    /// </summary>
    private async Task HandleReturnDetailsChanged(List<SalesReturnDetail> details)
    {
        try
        {
            salesReturnDetails = details;

            if (editModalComponent?.Entity != null)
            {
                var (total, tax) = TaxCalculationHelper.CalculateFromDetails(
                    details.Where(d => d.ProductId > 0),
                    editModalComponent.Entity.TaxCalculationMethod,
                    currentTaxRate,
                    d => d.ReturnSubtotalAmount,
                    d => d.TaxRate);
                editModalComponent.Entity.TotalReturnAmount = total;
                editModalComponent.Entity.ReturnTaxAmount = tax;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理退貨明細變更時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 處理有不可刪除明細的狀態變更
    /// 當有不可刪除的明細時(已有沖款記錄),鎖定主檔的所有使用者可輸入欄位
    /// </summary>
    private async Task HandleHasUndeletableDetailsChanged(bool hasUndeletable)
    {
        try
        {
            if (hasUndeletableDetails != hasUndeletable)
            {
                hasUndeletableDetails = hasUndeletable;
                
                // 更新欄位的唯讀狀態
                UpdateFieldsReadOnlyState();
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理明細鎖定狀態時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 根據 hasUndeletableDetails 狀態更新欄位的唯讀狀態
    /// </summary>
    private void UpdateFieldsReadOnlyState()
    {
        // 使用 FormFieldLockHelper 一次處理所有欄位（含 ActionButtons）
        FormFieldLockHelper.LockMultipleFields(
            formFields,
            new[]
            {
                nameof(SalesReturn.ReturnDate),
                nameof(SalesReturn.ReturnReasonId),
                "FilterProductId",
                nameof(BaseEntity.Remarks),
                nameof(SalesReturn.CustomerId)
            },
            isLocked: hasUndeletableDetails,
            actionButtonsMap: new Dictionary<string, Func<Task<List<FieldActionButton>>>>
            {
                { nameof(SalesReturn.CustomerId), GetCustomerActionButtonsAsync }
            }
        );
    }

    /// <summary>
    /// 取得狀態訊息（頂部徽章）
    /// 當有不可刪除的明細時，顯示鎖定提示
    /// </summary>
    private async Task<(string Message, GenericEditModalComponent<SalesReturn, ISalesReturnService>.BadgeVariant Variant, string IconClass)?> 
        GetStatusMessage()
    {
        try
        {
            if (!isDetailDataReady || editModalComponent?.Entity == null)
                return null;
            
            if (hasUndeletableDetails)
            {
                return (
                    "明細有沖款記錄，主檔欄位已鎖定",
                    GenericEditModalComponent<SalesReturn, ISalesReturnService>.BadgeVariant.Warning,
                    "fas fa-lock"
                );
            }
            
            return null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetStatusMessage), GetType());
            return null;
        }
    }

    /// <summary>
    /// 取得警告訊息（表單頂部）
    /// 當有不可刪除的明細時，顯示詳細說明
    /// </summary>
    private RenderFragment? GetWarningMessage() => __builder =>
    {
            <GenericLockedFieldMessage IsVisible="@(isDetailDataReady && hasUndeletableDetails)"
                    Message="@EditModalMessages.UndeletableDetailsWarning"/>
    };

    /// <summary>
    /// 處理欄位值變更事件
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            switch (fieldChange.PropertyName)
            {
                case nameof(SalesReturn.CustomerId):
                    // 客戶變更時，觸發退貨明細管理器重新渲染
                    StateHasChanged();
                    break;

                case "FilterProductId":
                    //  修正：處理清除值的情況
                    // AutoComplete 清除時可能傳回 null、空字串、"0" 或數字 0
                    {
                        var valueStr = fieldChange.Value?.ToString();
                        if (string.IsNullOrWhiteSpace(valueStr) || valueStr == "0")
                        {
                            filterProductId = null;
                        }
                        else if (int.TryParse(valueStr, out var parsedProductId) && parsedProductId > 0)
                        {
                            filterProductId = parsedProductId;
                        }
                        else
                        {
                            // 無法解析的值也視為清除
                            filterProductId = null;
                        }
                    }
                    // ✅ 欄位依賴變化：篩選條件改變需要立即更新明細表格
                    StateHasChanged();
                    break;

                case nameof(SalesReturn.SalesDeliveryId):
                    //  修正：同步更新 FilterSalesDeliveryId 以正確過濾明細表格
                    // AutoComplete 清除時可能傳回 null、空字串、"0" 或數字 0
                    {
                        var valueStr = fieldChange.Value?.ToString();
                        if (string.IsNullOrWhiteSpace(valueStr) || valueStr == "0")
                        {
                            FilterSalesDeliveryId = null;
                        }
                        else if (int.TryParse(valueStr, out var parsedDeliveryId) && parsedDeliveryId > 0)
                        {
                            FilterSalesDeliveryId = parsedDeliveryId;
                        }
                        else
                        {
                            // 無法解析的值也視為清除
                            FilterSalesDeliveryId = null;
                        }
                    }
                    // ✅ 欄位依賴變化：銷售單篩選改變需要立即更新明細表格
                    StateHasChanged();
                    break;
                
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理欄位變更時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 驗證銷售退貨明細 - 在儲存主檔之前執行
    /// </summary>
    private async Task<bool> ValidateSalesReturnDetailsAsync(SalesReturn salesReturn)
    {
        try
        {
            // 驗證必填欄位
            if (salesReturn.CustomerId <= 0)
            {
                await NotificationService.ShowErrorAsync("請選擇客戶");
                return false;
            }
            
            // 首先呼叫明細管理器的驗證方法
            if (salesReturnDetailManager != null)
            {
                bool isValidDetails = await salesReturnDetailManager.ValidateAsync();
                if (!isValidDetails)
                {
                    return false;
                }
            }
            
            // 檢查是否有有效的明細
            var validDetails = salesReturnDetails.Where(d => d.ProductId > 0 && d.ReturnQuantity > 0).ToList();
            if (!validDetails.Any())
            {
                await NotificationService.ShowErrorAsync("至少需要一筆退貨明細");
                return false;
            }
            
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"驗證退貨明細時發生錯誤：{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// 自訂儲存邏輯 - 同時儲存主檔和明細，並更新庫存
    /// </summary>
    private async Task<bool> SaveSalesReturnWithDetails(SalesReturn salesReturn)
    {
        try
        {
            if (salesReturn == null)
            {
                return false;
            }
            
            // 先執行自訂驗證
            if (!await ValidateSalesReturnDetailsAsync(salesReturn))
            {
                return false;
            }
            
            if (SalesReturnService == null)
            {
                return false;
            }
            
            if (salesReturnDetails == null)
            {
                salesReturnDetails = new List<SalesReturnDetail>();
            }
            
            //  儲存前再次計算總金額和稅額（確保資料一致性）
            switch (salesReturn.TaxCalculationMethod)
            {
                case TaxCalculationMethod.TaxExclusive:
                    // 外加稅
                    salesReturn.TotalReturnAmount = Math.Round(
                        salesReturnDetails.Where(d => d.ProductId > 0)
                                         .Sum(d => d.ReturnQuantity * d.OriginalUnitPrice * (1 - d.DiscountPercentage / 100)),
                        0, MidpointRounding.AwayFromZero);
                    
                    salesReturn.ReturnTaxAmount = Math.Round(
                        salesReturnDetails.Where(d => d.ProductId > 0)
                                         .Sum(d => d.ReturnQuantity * d.OriginalUnitPrice * (1 - d.DiscountPercentage / 100) * (d.TaxRate ?? 0) / 100),
                        0, MidpointRounding.AwayFromZero);
                    break;
                
                case TaxCalculationMethod.TaxInclusive:
                    // 內含稅
                    var totalWithTax = Math.Round(
                        salesReturnDetails.Where(d => d.ProductId > 0)
                                         .Sum(d => d.ReturnQuantity * d.OriginalUnitPrice * (1 - d.DiscountPercentage / 100)),
                        0, MidpointRounding.AwayFromZero);
                    
                    var taxAmount = Math.Round(
                        salesReturnDetails.Where(d => d.ProductId > 0)
                                         .Sum(d => 
                                         {
                                             var subtotal = d.ReturnQuantity * d.OriginalUnitPrice * (1 - d.DiscountPercentage / 100);
                                             var taxRate = d.TaxRate ?? 0;
                                             return Math.Round(subtotal / (1 + taxRate / 100) * taxRate / 100, 0, MidpointRounding.AwayFromZero);
                                         }),
                        0, MidpointRounding.AwayFromZero);
                    
                    salesReturn.ReturnTaxAmount = taxAmount;
                    salesReturn.TotalReturnAmount = Math.Round(totalWithTax - taxAmount, 0, MidpointRounding.AwayFromZero);
                    break;
                
                case TaxCalculationMethod.NoTax:
                    // 免稅
                    salesReturn.TotalReturnAmount = Math.Round(
                        salesReturnDetails.Where(d => d.ProductId > 0)
                                         .Sum(d => d.ReturnQuantity * d.OriginalUnitPrice * (1 - d.DiscountPercentage / 100)),
                        0, MidpointRounding.AwayFromZero);
                    
                    salesReturn.ReturnTaxAmount = 0;
                    break;
            }
                        
            // 呼叫服務的 SaveWithDetailsAsync 方法
            var result = await SalesReturnService.SaveWithDetailsAsync(salesReturn, salesReturnDetails);
            
            if (result == null)
            {
                return false;
            }
            
            if (!result.IsSuccess)
            {
                await NotificationService.ShowErrorAsync($"儲存失敗：{result.ErrorMessage}");
                return false;
            }

            //  關鍵：儲存成功後，使用差異計算更新庫存
            if (result.Data != null)
            {
                await UpdateInventoryByDifferenceAsync(result.Data.Id);
            }
            
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"儲存銷貨退回時發生錯誤：{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// 配置自訂模組
    /// </summary>
    private List<GenericEditModalComponent<SalesReturn, ISalesReturnService>.CustomModule> GetCustomModules()
    {
        return CustomModuleHelper.CreateSingle(editModalComponent, CreateReturnDetailManagerContent());
    }

    /// <summary>
    /// 創建退貨明細管理器內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateReturnDetailManagerContent() => __builder =>
    {
        <DetailSectionWrapper IsEntityReady="@(editModalComponent?.Entity != null)"
                              IsDetailDataReady="@isDetailDataReady"
                              IsDataAvailable="@(products != null && products.Any() && warehouses != null && warehouses.Any())"
                              DataUnavailableMessage="無可用的商品或倉庫資料，請聯繫系統管理員"
                              IsPreconditionMet="@(editModalComponent?.Entity?.CustomerId > 0)"
                              PreconditionMessage="請先選擇客戶後再進行退貨明細管理">
            <SalesReturnTable @ref="salesReturnDetailManager"
                              Products="@products"
                              CustomerId="@(editModalComponent?.Entity?.CustomerId)"
                              FilterSalesDeliveryId="@FilterSalesDeliveryId"
                              FilterProductId="@FilterProductId"
                              SelectedCustomerName="@GetSelectedCustomerName()"
                              SelectedSalesDeliveryCode="@GetSelectedSalesDeliveryCode()"
                              FilterProductName="@GetFilterProductName()"
                              ExistingReturnDetails="@salesReturnDetails"
                              DataVersion="@_detailsDataVersion"
                              IsParentLoading="@(editModalComponent?.IsLoading ?? false)"
                              TaxCalculationMethod="@(editModalComponent?.Entity?.TaxCalculationMethod ?? TaxCalculationMethod.TaxExclusive)"
                              OnReturnDetailsChanged="@HandleReturnDetailsChanged"
                              OnHasUndeletableDetailsChanged="@HandleHasUndeletableDetailsChanged"
                              OnOpenRelatedDocument="@HandleOpenRelatedDocument"
                              IsEditMode="@SalesReturnId.HasValue" />
        </DetailSectionWrapper>
    };
    
    /// <summary>
    /// 產生客戶操作按鈕 - 使用統一 Helper
    ///  關鍵：當有不可刪除的明細時，不顯示 ActionButtons
    /// </summary>
    private async Task<List<FieldActionButton>> GetCustomerActionButtonsAsync()
    {
        //  關鍵：當有不可刪除的明細時，不顯示 ActionButtons
        if (hasUndeletableDetails)
        {
            return new List<FieldActionButton>();
        }
        
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            customerModalManager, 
            nameof(SalesReturn.CustomerId)
        );
    }

    /// <summary>
    /// 處理開啟相關單據的事件
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            if (args.type == RelatedDocumentType.SetoffDocument)
            {
                // 開啟沖款單
                selectedSetoffDocumentId = args.id;
                showSetoffDocumentModal = true;
                StateHasChanged();
            }
            else
            {
                await NotificationService.ShowWarningAsync("不支援的單據類型", "提示");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"開啟單據失敗：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 處理沖款單儲存後的事件
    /// </summary>
    /// <summary>
    /// 處理沖款單儲存後的事件
    /// 使用 ChildDocumentRefreshHelper 統一處理刷新邏輯
    /// </summary>
    private async Task HandleSetoffDocumentSaved(SetoffDocument savedDocument)
    {
        try
        {
            await ChildDocumentRefreshHelper.HandleChildDocumentSavedSimpleAsync(
                closeModal: () =>
                {
                    showSetoffDocumentModal = false;
                },
                stateHasChanged: StateHasChanged,
                additionalActions: async () =>
                {
                    // 關鍵修復：呼叫 Table 組件的公開刷新方法
                    // 重新載入明細資料以更新沖款相關資訊
                    if (salesReturnDetailManager != null)
                    {
                        await salesReturnDetailManager.RefreshDetails();
                    }
                    
                    await NotificationService.ShowSuccessAsync("沖款單已更新，銷售退貨明細已刷新");
                }
            );
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理沖款單儲存事件失敗：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 取得自訂操作按鈕（顯示在 Modal 頂部左側）
    /// </summary>
    private RenderFragment? GetCustomActionButtons() => __builder =>
    {
        @* 轉沖款按鈕 - 只在銷貨退回已儲存時顯示 *@
        @if (editModalComponent?.Entity != null && SalesReturnId.HasValue)
        {
            <GenericButtonComponent Text="轉沖款" 
                                  Variant="ButtonVariant.Green" 
                                  OnClick="HandleCreateSetoffFromSalesReturn" />
        }
    };

    /// <summary>
    /// 從銷貨退回轉沖款單
    /// </summary>
    private async Task HandleCreateSetoffFromSalesReturn()
    {
        try
        {
            // 1. 驗證銷貨退回資料
            if (!SalesReturnId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("無法轉沖款：銷貨退回資料不存在");
                return;
            }
            
            // 2. 驗證客戶資料
            if (editModalComponent.Entity.CustomerId <= 0)
            {
                await NotificationService.ShowWarningAsync("銷貨退回缺少客戶資訊，無法轉沖款");
                return;
            }
            
            // 3. 檢查是否有明細
            if (!salesReturnDetails.Any())
            {
                await NotificationService.ShowWarningAsync("銷貨退回沒有明細資料，無法轉沖款");
                return;
            }
            
            // 4. 檢查是否有可沖款的明細（有未結清餘額）
            bool hasUnsettledDetails = salesReturnDetails
                .Any(detail => detail.ReturnSubtotalAmount > detail.TotalPaidAmount && !detail.IsSettled);
            
            if (!hasUnsettledDetails)
            {
                await NotificationService.ShowWarningAsync("銷貨退回所有明細皆已完成沖款，無需再轉沖款");
                return;
            }
            
            // 5. 呼叫沖款單組件的公開方法
            await setoffDocumentEditModal!.ShowAddModalWithPrefilledSalesReturn(
                editModalComponent.Entity.CustomerId,
                SalesReturnId.Value
            );
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCreateSetoffFromSalesReturn), GetType(), 
                additionalData: $"轉沖款失敗 - SalesReturnId: {SalesReturnId}");
            await NotificationService.ShowErrorAsync("轉沖款時發生錯誤");
        }
    }
    
    // ===== 輔助方法：取得選項名稱 =====
    
    private string? GetSelectedCustomerName()
        => EntityDisplayHelper.GetDisplayValue(editModalComponent?.Entity?.CustomerId, customers, c => c.CompanyName);

    private string? GetSelectedSalesDeliveryCode()
        => EntityDisplayHelper.GetDisplayValue(FilterSalesDeliveryId, salesDeliveries, sd => sd.Code);

    private string? GetFilterProductName()
        => EntityDisplayHelper.GetDisplayValue(filterProductId, products, p => $"{p.Code} {p.Name}");

    /// <summary>
    /// 使用差異比較更新庫存（統一處理新增和編輯）
    /// </summary>
    private async Task UpdateInventoryByDifferenceAsync(int salesReturnId)
    {
        var inventoryUpdateResult = await SalesReturnService.UpdateInventoryByDifferenceAsync(salesReturnId);
        
        if (!inventoryUpdateResult.IsSuccess)
        {
            await NotificationService.ShowErrorAsync($"庫存更新失敗：{inventoryUpdateResult.ErrorMessage}");
            throw new Exception($"庫存更新失敗：{inventoryUpdateResult.ErrorMessage}");
        }
    }

    /// <summary>
    /// 釋放資源
    /// </summary>
    public void Dispose()
    {
        try
        {
            // 清理資源
            editModalComponent = null;
            salesReturnDetailManager = null;
            // customerEditModal = null;
            
            // 清理事件訂閱（如果有的話）
            // ...
        }
        catch
        {
            // 忽略清理過程中的錯誤
        }
    }
}

