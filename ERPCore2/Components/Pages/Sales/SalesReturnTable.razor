@* éŠ·å”®é€€è²¨å•†å“æ˜ç´°ç®¡ç†å…ƒä»¶ - ä½¿ç”¨ InteractiveTableComponent çµ±ä¸€UI ä¸¦æ•´åˆè‡ªå‹•ç©ºè¡ŒåŠŸèƒ½ *@

@using ERPCore2.Helpers.InteractiveTableComponentHelper
@using ERPCore2.Models.Enums
@using ERPCore2.Helpers
@inject ISalesDeliveryDetailService SalesDeliveryDetailService
@inject ISalesReturnDetailService SalesReturnDetailService
@inject INotificationService NotificationService
@inject IWarehouseLocationService WarehouseLocationService
@inject ISystemParameterService SystemParameterService
@inject IProductService ProductService
@inject RelatedDocumentsHelper RelatedDocumentsHelper
@inject IJSRuntime JSRuntime

@if (!EffectiveCustomerId.HasValue || EffectiveCustomerId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="customer-warning">
                <i class="fas fa-user fa-2x mb-3 text-muted"></i>
                <p class="text-muted">é¸æ“‡å®¢æˆ¶å¾Œå³å¯æŸ¥çœ‹è©²å®¢æˆ¶å¯é€€è²¨çš„å•†å“</p>
            </div>
        </div>
    </div>
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="ReturnItem" 
                                      Items="@ReturnItems"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"                                      
                                      EmptyMessage="@EmptyMessage"
                                      ShowBuiltInActions="true"                                      
                                      ShowBuiltInDeleteButton="false"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"     
                                      ActionsColumnWidth = "60px"
                                      EnableAutoEmptyRow="true"
                                      AllowAddNewRow="@(!_hasUndeletableDetails && !IsReadOnly)"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@(() => new ReturnItem())"/>
        </div>

        <div class="card-footer">
            <div class="table-action-bar">
                <div class="btn-group-left">
                    <GenericButtonComponent Text="è¼‰å…¥"
                                          Variant="ButtonVariant.DarkBlue"
                                          IsDisabled="@(IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetLoadAllReturnableTooltip()"
                                          OnClick="ShowLoadConfirmModal" />
                </div>
                <div class="btn-group-right">
                    <GenericButtonComponent Text="é€€è²¨å…¨å¡«"
                                          Icon="fill-drip"
                                          Variant="ButtonVariant.DarkBlue"
                                          IsDisabled="@(!HasReturnItems || IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetFillAllQuantitiesTooltip()"
                                          OnClick="@FillAllQuantities" />
                    <GenericButtonComponent Text="é€€è²¨æ¸…ç©º"
                                          Icon="eraser"
                                          Variant="ButtonVariant.Red"
                                          IsDisabled="@(!HasReturnItems || IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetClearAllQuantitiesTooltip()"
                                          OnClick="@ClearAllQuantities" />
                    <GenericButtonComponent Text="æ¸…é™¤æ˜ç´°"
                                          Icon="trash-alt"
                                          Variant="ButtonVariant.Red"
                                          IsDisabled="@(!HasReturnItems || IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetClearAllDetailsTooltip()"
                                          OnClick="@ClearAllDetails" />
                </div>
            </div>
        </div>
    </div>
}

<!-- ç›¸é—œå–®æ“šæŸ¥çœ‹ Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

<!-- è¼‰å…¥ç¢ºèª Modal -->
<GenericConfirmModalComponent IsVisible="@_showLoadConfirmModal"
                             IsVisibleChanged="@((bool visible) => _showLoadConfirmModal = visible)"
                             Title="è¼‰å…¥ç¢ºèª"
                             Icon="bi-box-arrow-in-down"
                             Message="å³å°‡è¼‰å…¥ä»¥ä¸‹æ¢ä»¶çš„å¯é€€è²¨æ˜ç´°ï¼š"
                             Conditions="@_loadConditions"
                             SummaryMessage="@_loadSummaryMessage"
                             ConfirmButtonVariant="ButtonVariant.Blue"
                             OnConfirm="@ExecuteLoadAllReturnableItems"
                             OnCancel="@(() => _showLoadConfirmModal = false)" />

@code {
    // ===== InteractiveTableComponent åƒè€ƒ =====
    private InteractiveTableComponent<ReturnItem>? tableComponent;
    
    // ===== è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜ =====
    private bool _dataLoadCompleted = true;  // è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜
    private bool _hasUndeletableDetails = false;  // æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°(å·²æœ‰æ²–æ¬¾è¨˜éŒ„)
    
    // ===== åŸºæœ¬åƒæ•¸ =====
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public EventCallback<List<ReturnItem>> OnReturnItemsChanged { get; set; }
    
    // ===== å®¢æˆ¶éæ¿¾åƒæ•¸ =====
    [Parameter] public int? CustomerId { get; set; }
    [Parameter] public int? SelectedCustomerId { get; set; }
    
    // ===== ç¯©é¸åƒæ•¸ =====
    [Parameter] public int? SelectedSalesDeliveryId { get; set; }
    [Parameter] public int? FilterSalesDeliveryId { get; set; }
    [Parameter] public int? FilterProductId { get; set; }
    
    // ===== é¡å¤–åƒæ•¸ï¼ˆç”¨æ–¼é¡¯ç¤ºç¢ºèªè¨Šæ¯ï¼‰=====
    [Parameter] public string? SelectedCustomerName { get; set; }
    [Parameter] public string? SelectedSalesDeliveryCode { get; set; }
    [Parameter] public string? FilterProductName { get; set; }
    
    // ===== ç¾æœ‰æ˜ç´°åƒæ•¸ =====
    [Parameter] public List<SalesReturnDetail> ExistingReturnDetails { get; set; } = new List<SalesReturnDetail>();
    [Parameter] public EventCallback<List<SalesReturnDetail>> OnDetailsChanged { get; set; }
    [Parameter] public EventCallback<List<SalesReturnDetail>> OnReturnDetailsChanged { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    [Parameter] public EventCallback<ReturnItem> OnItemRemoved { get; set; }
    
    // ===== ç·¨è¼¯æ¨¡å¼åƒæ•¸ =====
    [Parameter] public bool IsEditMode { get; set; } = false;
    
    // ===== é¡¯ç¤ºè¨­å®š =====
    [Parameter] public string Title { get; set; } = "é€€è²¨æ˜ç´°";
    [Parameter] public string Subtitle { get; set; } = "";
    [Parameter] public string Icon { get; set; } = "undo";
    [Parameter] public string ItemDisplayName { get; set; } = "å•†å“";
    [Parameter] public string EmptyMessage { get; set; } = "å°šæœªæ–°å¢é€€è²¨å•†å“";
    
    // ===== å”¯è®€æ¨¡å¼åƒæ•¸ =====
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== ç¨…åˆ¥åƒæ•¸ï¼ˆæ–°å¢ï¼‰=====
    [Parameter] public TaxCalculationMethod TaxCalculationMethod { get; set; } = TaxCalculationMethod.TaxExclusive;

    // ===== è¼”åŠ©è¨ˆç®—å±¬æ€§ =====
    private bool IsTaxCalculationMethodNoTax => TaxCalculationMethod == TaxCalculationMethod.NoTax;
    
    // ===== ç‹€æ…‹é€šçŸ¥åƒæ•¸ =====
    /// <summary>
    /// ç‹€æ…‹é€šçŸ¥åƒæ•¸ - é€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
    /// </summary>
    [Parameter] public EventCallback<bool> OnHasUndeletableDetailsChanged { get; set; }
    
    // ===== ç›¸é—œå–®æ“šé–‹å•Ÿäº‹ä»¶ =====
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }

    private List<ReturnItem> ReturnItems { get; set; } = new List<ReturnItem>();
    private List<Product> AvailableProducts { get; set; } = new List<Product>();
    private List<SalesDeliveryDetail> AvailableDeliveryDetails { get; set; } = new List<SalesDeliveryDetail>();
    private int? _previousSelectedCustomerId = null;
    private int? _previousSelectedSalesDeliveryId = null;
    private int? _previousFilterProductId = null;
    private List<int> _deletedDetailIds { get; set; } = new List<int>();
    
    // ===== ç›¸é—œå–®æ“šæŸ¥çœ‹ =====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;
    
    // ===== è¼‰å…¥ç¢ºèª Modal =====
    private bool _showLoadConfirmModal = false;
    private List<string> _loadConditions = new();
    private string _loadSummaryMessage = string.Empty;

    // ===== è¨ˆç®—å±¬æ€§ =====
    private int? EffectiveCustomerId => CustomerId ?? SelectedCustomerId;
    private int? EffectiveSalesDeliveryId => FilterSalesDeliveryId ?? SelectedSalesDeliveryId;
    private int? EffectiveFilterProductId => FilterProductId;
    private EventCallback<List<SalesReturnDetail>> EffectiveDetailsChangedCallback => 
        OnReturnDetailsChanged.HasDelegate ? OnReturnDetailsChanged : OnDetailsChanged;
    
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦å¯ä»¥ä½¿ç”¨ã€Œè¼‰å…¥å…¨éƒ¨å¯é€€ã€åŠŸèƒ½
    /// è¦å‰‡ï¼š
    /// 1. å¿…é ˆé¸æ“‡å®¢æˆ¶
    /// 2. ç„¡å·²æœ‰æ²–æ¬¾è¨˜éŒ„çš„æ˜ç´°
    /// æ³¨æ„ï¼šå…¶ä»–æ¢ä»¶æª¢æŸ¥ç§»è‡³ LoadAllReturnableItems æ–¹æ³•ä¸­ï¼Œè¼‰å…¥æ™‚æç¤ºä½¿ç”¨è€…
    /// </summary>
    private bool CanLoadAllReturnable => 
        EffectiveCustomerId.HasValue && 
        EffectiveCustomerId.Value > 0 && 
        !_hasUndeletableDetails;
    
    /// <summary>
    /// å–å¾—ã€Œè¼‰å…¥å¯é€€è²¨ã€æŒ‰éˆ•çš„æç¤ºè¨Šæ¯
    /// </summary>
    private string GetLoadAllReturnableTooltip()
    {
        if (IsReadOnly)
            return "å”¯è®€æ¨¡å¼ç„¡æ³•ä½¿ç”¨";
        
        if (_hasUndeletableDetails)
            return "éƒ¨åˆ†æ˜ç´°å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ä½¿ç”¨è¼‰å…¥åŠŸèƒ½";
        
        return "è¼‰å…¥ç¬¦åˆæ¢ä»¶çš„å¯é€€è²¨å‡ºè²¨æ˜ç´°";
    }
    
    /// <summary>
    /// è¨ˆç®—å±¬æ€§ï¼šæ˜¯å¦æœ‰é€€è²¨æ˜ç´°é …ç›®
    /// </summary>
    private bool HasReturnItems =>
        ReturnItems.Any(item => item.SelectedProduct != null);
    
    /// <summary>
    /// å–å¾—é€€è²¨å…¨å¡«æŒ‰éˆ•çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetFillAllQuantitiesTooltip()
    {
        if (!HasReturnItems)
            return "ç›®å‰ç„¡æ˜ç´°å¯å¡«å…¥";
        
        if (IsReadOnly)
            return "å”¯è®€æ¨¡å¼ç„¡æ³•ä½¿ç”¨";
        
        if (_hasUndeletableDetails)
            return "éƒ¨åˆ†æ˜ç´°å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•æ‰¹æ¬¡å¡«å…¥æ•¸é‡";
        
        return "å°‡æ‰€æœ‰æ˜ç´°çš„é€€è²¨æ•¸é‡å¡«å…¥å¯é€€è²¨çš„æœ€å¤§æ•¸é‡";
    }
    
    /// <summary>
    /// å–å¾—é€€è²¨æ¸…ç©ºæŒ‰éˆ•çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetClearAllQuantitiesTooltip()
    {
        if (!HasReturnItems)
            return "ç›®å‰ç„¡æ˜ç´°å¯æ¸…ç©º";
        
        if (IsReadOnly)
            return "å”¯è®€æ¨¡å¼ç„¡æ³•ä½¿ç”¨";
        
        if (_hasUndeletableDetails)
            return "éƒ¨åˆ†æ˜ç´°å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•æ‰¹æ¬¡æ¸…ç©ºæ•¸é‡";
        
        return "æ¸…ç©ºæ‰€æœ‰æ˜ç´°çš„é€€è²¨æ•¸é‡";
    }
    
    /// <summary>
    /// å–å¾—æ¸…é™¤æ˜ç´°æŒ‰éˆ•çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetClearAllDetailsTooltip()
    {
        if (!HasReturnItems)
            return "ç›®å‰ç„¡æ˜ç´°å¯æ¸…é™¤";
        
        if (IsReadOnly)
            return "å”¯è®€æ¨¡å¼ç„¡æ³•ä½¿ç”¨";
        
        if (_hasUndeletableDetails)
            return "éƒ¨åˆ†æ˜ç´°å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•æ¸…é™¤æ˜ç´°";
        
        return "æ¸…ç©ºæ‰€æœ‰é€€è²¨æ˜ç´°";
    }
    
    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦æœ‰è¢«é–å®šçš„æ˜ç´°ï¼ˆæœ‰æ²–æ¬¾è¨˜éŒ„çš„æ˜ç´°ï¼‰
    /// </summary>
    private bool HasLockedDetails()
    {
        return ReturnItems.Any(item => 
            item.SelectedProduct != null && HasPaymentRecord(item));
    }

    protected override async Task OnInitializedAsync()
    {
        // åˆå§‹åŒ–å‰ä¸€å€‹ç‹€æ…‹å€¼ï¼Œé¿å… OnParametersSetAsync èª¤åˆ¤ç‚ºè®Šæ›´
        _previousSelectedCustomerId = EffectiveCustomerId;
        _previousSelectedSalesDeliveryId = EffectiveSalesDeliveryId;
        _previousFilterProductId = EffectiveFilterProductId;
        
        await LoadAvailableProductsAsync();
        await LoadExistingDetailsAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        
        // æª¢æŸ¥ç¯©é¸åƒæ•¸æ˜¯å¦è®Šæ›´
        bool customerChanged = _previousSelectedCustomerId != EffectiveCustomerId;
        bool salesDeliveryChanged = _previousSelectedSalesDeliveryId != EffectiveSalesDeliveryId;
        bool productFilterChanged = _previousFilterProductId != EffectiveFilterProductId;
        
        // âœ… å¦‚æœæ²’æœ‰ä»»ä½•è®ŠåŒ–,ç›´æ¥è¿”å›
        if (!customerChanged && !salesDeliveryChanged && !productFilterChanged)
        {
            return;
        }
        
        // å¦‚æœå®¢æˆ¶è®Šæ›´ï¼Œéœ€è¦é‡æ–°è¼‰å…¥æ‰€æœ‰è³‡æ–™
        if (customerChanged)
        {
            _previousSelectedCustomerId = EffectiveCustomerId;
            _previousSelectedSalesDeliveryId = EffectiveSalesDeliveryId;
            _previousFilterProductId = EffectiveFilterProductId;
            
            await LoadAvailableProductsAsync();
            
            // å®¢æˆ¶è®Šæ›´æ™‚é‡æ–°è¼‰å…¥æ˜ç´°ï¼ˆLoadExistingDetailsAsync å…§éƒ¨æœƒè‡ªå‹• Clearï¼‰
            await LoadExistingDetailsAsync();
            return;
        }
        
        // å¦‚æœåªæ˜¯å‡ºè²¨å–®æˆ–å•†å“ç¯©é¸è®Šæ›´ï¼Œåªéœ€è¦æ›´æ–°ç¯©é¸ç‹€æ…‹ä¸¦é‡æ–°æ¸²æŸ“
        if (salesDeliveryChanged || productFilterChanged)
        {
            _previousSelectedSalesDeliveryId = EffectiveSalesDeliveryId;
            _previousFilterProductId = EffectiveFilterProductId;
            
            // è§¸ç™¼é‡æ–°æ¸²æŸ“ä»¥å¥—ç”¨æ–°çš„ç¯©é¸
            StateHasChanged();
            return;
        }
    }
    
    /// <summary>
    /// å…¬é–‹çš„åˆ·æ–°æ–¹æ³•ï¼Œç”¨æ–¼å¤–éƒ¨è§¸ç™¼æ˜ç´°åˆ·æ–°ï¼ˆä¾‹å¦‚ï¼šä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼‰
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadAvailableProductsAsync();
        await LoadExistingDetailsAsync();
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }

    // ===== æ²–æ¬¾è¨˜éŒ„æª¢æŸ¥æ–¹æ³• =====
    
    /// <summary>
    /// æª¢æŸ¥æŒ‡å®šçš„éŠ·è²¨é€€å›æ˜ç´°é …ç›®æ˜¯å¦æœ‰æ²–æ¬¾è¨˜éŒ„
    /// æª¢æŸ¥é‚è¼¯ï¼š
    /// - è³‡æ–™è¡¨ï¼šSalesReturnDetail
    /// - æ¬„ä½ï¼šTotalPaidAmount (ç´¯è¨ˆä»˜æ¬¾é‡‘é¡)
    /// - æ¢ä»¶ï¼šTotalPaidAmount > 0 è¡¨ç¤ºå·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œä¸å¯åˆªé™¤
    /// </summary>
    /// <param name="item">è¦æª¢æŸ¥çš„é€€è²¨æ˜ç´°é …ç›®</param>
    /// <returns>true è¡¨ç¤ºæœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œfalse è¡¨ç¤ºæ²’æœ‰</returns>
    private bool HasPaymentRecord(ReturnItem item)
    {
        if (item.ExistingDetailEntity != null && item.ExistingDetailEntity.Id > 0)
        {
            // æª¢æŸ¥ TotalPaidAmount æ˜¯å¦å¤§æ–¼ 0
            return item.ExistingDetailEntity.TotalPaidAmount > 0;
        }
        return false;
    }
    
    /// <summary>
    /// å–å¾—æŒ‡å®šé€€è²¨æ˜ç´°é …ç›®çš„å·²æ²–æ¬¾é‡‘é¡
    /// </summary>
    /// <param name="item">è¦æª¢æŸ¥çš„é€€è²¨æ˜ç´°é …ç›®</param>
    /// <returns>å·²æ²–æ¬¾é‡‘é¡</returns>
    private decimal GetPaidAmount(ReturnItem item)
    {
        if (item.ExistingDetailEntity != null && item.ExistingDetailEntity.Id > 0)
        {
            return item.ExistingDetailEntity.TotalPaidAmount;
        }
        return 0;
    }
    
    /// <summary>
    /// æª¢æŸ¥é …ç›®æ˜¯å¦å¯ä»¥åˆªé™¤
    /// æª¢æŸ¥æ¢ä»¶ï¼š
    /// 1. æ²–æ¬¾è¨˜éŒ„æª¢æŸ¥ (HasPaymentRecord)
    ///    - è³‡æ–™ä¾†æºï¼šç›´æ¥è®€å– SalesReturnDetail å¯¦é«”
    ///    - æª¢æŸ¥è³‡æ–™è¡¨ï¼šSalesReturnDetail (éŠ·è²¨é€€å›æ˜ç´°)
    ///    - æª¢æŸ¥æ¬„ä½ï¼šTotalPaidAmount (ç´¯è¨ˆä»˜æ¬¾é‡‘é¡)
    ///    - é™åˆ¶åŸå› ï¼šå·²æ²–æ¬¾çš„é€€è²¨æ˜ç´°ä¸å¯åˆªé™¤ï¼Œé¿å…è²¡å‹™è³‡æ–™éŒ¯äº‚
    /// </summary>
    /// <param name="item">è¦æª¢æŸ¥çš„é …ç›®</param>
    /// <param name="reason">ä¸å¯åˆªé™¤çš„åŸå› ï¼ˆè¼¸å‡ºåƒæ•¸ï¼‰</param>
    /// <returns>true è¡¨ç¤ºå¯ä»¥åˆªé™¤ï¼Œfalse è¡¨ç¤ºä¸å¯åˆªé™¤</returns>
    private bool CanDeleteItem(ReturnItem item, out string reason)
    {
        var canDelete = DetailLockHelper.CanDeleteItem(
            item.ExistingDetailEntity, 
            out reason, 
            checkPayment: true);
        
        if (!canDelete && item.ExistingDetailEntity != null)
        {
            // æ˜ç´°è¢«é–å®š
        }
        
        return canDelete;
    }
    
    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼‰
    /// </summary>
    private bool HasUndeletableDetails()
    {
        return ReturnItems.Any(item => 
            item.SelectedProduct != null && !CanDeleteItem(item, out _));
    }

    /// <summary>
    /// é€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
    /// </summary>
    private async Task NotifyHasUndeletableDetailsChanged()
    {
        if (OnHasUndeletableDetailsChanged.HasDelegate)
        {
            var hasUndeletableDetails = HasUndeletableDetails();
            _hasUndeletableDetails = hasUndeletableDetails;
            await OnHasUndeletableDetailsChanged.InvokeAsync(hasUndeletableDetails);
            tableComponent?.RefreshEmptyRow();  // åˆ·æ–°ç©ºè¡Œç‹€æ…‹
            StateHasChanged();
        }
    }

    // ===== InteractiveTableComponent æ–¹æ³• =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // å‡ºè²¨æ˜ç´°é¸æ“‡æ¬„ä½ - ä½¿ç”¨ SearchableSelect é¡å‹ï¼ˆåªé¡¯ç¤ºæœ‰éŠ·è²¨çš„å•†å“ï¼‰
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å•†å“ç·¨è™Ÿ/åç¨±",
            PropertyName = "DeliveryDetailSearchValue",
            EmptyCheckPropertyName = "SelectedDeliveryDetail",  //  æª¢æŸ¥ç‰©ä»¶å±¬æ€§æ˜¯å¦ç‚ºç©º
            TriggerEmptyRowOnFilled = true,  //  é¸æ“‡å¾Œè‡ªå‹•æ–°å¢ç©ºè¡Œ
            ColumnType = InteractiveColumnType.SearchableSelect,
            Width = "300px",
            Tooltip = "æœå°‹ä¸¦é¸æ“‡è¦é€€è²¨çš„éŠ·å”®å•†å“ã€‚å·²æœ‰æ²–æ¬¾è¨˜éŒ„çš„å•†å“å°‡ç„¡æ³•è®Šæ›´",
            Placeholder = "è«‹è¼¸å…¥å‡ºè²¨å–®è™Ÿæˆ–å•†å“ç·¨è™Ÿ/åç¨±",
            SearchValuePropertyName = nameof(ReturnItem.DeliveryDetailSearchValue),
            FilteredItemsPropertyName = nameof(ReturnItem.FilteredDeliveryDetails),
            ShowDropdownPropertyName = nameof(ReturnItem.ShowDropdown),
            SelectedIndexPropertyName = nameof(ReturnItem.SelectedIndex),
            ItemDisplayFormatter = (item) =>
            {
                if (item is SalesDeliveryDetail detail)
                    return FormatDeliveryDetailDropdownText(detail);
                return string.Empty;
            },
            IsDisabledFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                return HasPaymentRecord(returnItem);
            },
            TooltipFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                var hasPaymentRecord = HasPaymentRecord(returnItem);
                if (!hasPaymentRecord) return null;
                
                return $"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ²–æ¬¾ {GetPaidAmount(returnItem):N0} å…ƒï¼‰ï¼Œç„¡æ³•ä¿®æ”¹å•†å“é¸æ“‡";
            },
            OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async (tuple) =>
            {
                var (item, searchValue) = tuple;
                await OnDeliveryDetailSearch((ReturnItem)item, searchValue);
            }),
            OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
            {
                var (item, selectedItem) = tuple;
                await OnDeliveryDetailSelect((ReturnItem)item, selectedItem);
            }),
            OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnDeliveryDetailFocus((ReturnItem)item);
            }),
            OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnDeliveryDetailBlur((ReturnItem)item);
            }),
            EnableKeyboardNavigation = true,
            GetDropdownItems = (item) => ((ReturnItem)item).FilteredDeliveryDetails,
            GetSelectedIndex = (item) => ((ReturnItem)item).SelectedIndex,
            SetSelectedIndex = (item, index) => ((ReturnItem)item).SelectedIndex = index,
            GetShowDropdown = (item) => ((ReturnItem)item).ShowDropdown,
            SetShowDropdown = (item, show) => ((ReturnItem)item).ShowDropdown = show,
            MaxDisplayItems = 20
        });

        // åŸå§‹éŠ·å”®æ•¸é‡æ¬„ä½ (åªè®€é¡¯ç¤º)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "åŸå§‹æ•¸é‡", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            Tooltip = "ç•¶åˆéŠ·å”®æ™‚çš„åŸå§‹æ•¸é‡ï¼ˆå”¯è®€ï¼‰",
            CustomTemplate = item => 
            {
                var returnItem = (ReturnItem)item;
                if (returnItem.SelectedDeliveryDetail == null) return @<span class="text-muted">-</span>;
                return @<div class="d-flex align-items-center justify-content-end">
                    <span>@returnItem.OriginalQuantity.ToString("N0")</span>
                </div>;
            }
        });

        // é€€è²¨æ•¸é‡æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "é€€è²¨æ•¸é‡", 
            PropertyName = nameof(ReturnItem.ReturnQuantity),
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            Tooltip = "è¦é€€å›çš„å•†å“æ•¸é‡ã€‚å·²æœ‰æ²–æ¬¾è¨˜éŒ„çš„å•†å“å°‡ç„¡æ³•ä¿®æ”¹æ•¸é‡",
            IsDisabledFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                return HasPaymentRecord(returnItem);
            },
            TooltipFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                var hasPaymentRecord = HasPaymentRecord(returnItem);
                if (!hasPaymentRecord) return null;
                
                return $"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ²–æ¬¾ {GetPaidAmount(returnItem):N0} å…ƒï¼‰ï¼Œç„¡æ³•ä¿®æ”¹é€€è²¨æ•¸é‡";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnReturnQuantityInput((ReturnItem)item, valueString);
            })
        });

        // å–®åƒ¹æ¬„ä½ (åªè®€é¡¯ç¤º)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "é€€è²¨å–®åƒ¹", 
            PropertyName = nameof(ReturnItem.OriginalUnitPrice),
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            Tooltip = "å•†å“çš„åŸå§‹éŠ·å”®å–®åƒ¹ï¼ˆå”¯è®€ï¼‰",
            IsReadOnly = true
        });

        // æŠ˜æ‰£æ¬„ä½ (åªè®€é¡¯ç¤º)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "ç•¶åˆæŠ˜æ‰£(%)", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "100px",
            Tooltip = "ç•¶åˆéŠ·å”®æ™‚çµ¦äºˆçš„æŠ˜æ‰£ç™¾åˆ†æ¯”ï¼ˆå”¯è®€ï¼‰",
            CustomTemplate = item => 
            {
                var returnItem = (ReturnItem)item;
                var discount = returnItem.SelectedDeliveryDetail?.DiscountPercentage ?? 0;
                
                return @<div class="d-flex align-items-center justify-content-end">
                    <span>@(discount % 1 == 0 ? discount.ToString("F0") : discount.ToString())</span>
                </div>;
            }
        });

        // ç¨…ç‡æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "ç¨…ç‡(%)", 
            PropertyName = nameof(ReturnItem.TaxRate),
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            Tooltip = "é€€è²¨çš„ç¨…ç‡ç™¾åˆ†æ¯”ï¼ˆå…ç¨…æ™‚ç„¡æ³•ç·¨è¼¯ï¼‰",
            IsDisabledFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                return IsTaxCalculationMethodNoTax || HasPaymentRecord(returnItem);
            },
            TooltipFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                if (IsTaxCalculationMethodNoTax)
                    return "ç•¶å‰ç¨…åˆ¥ç‚ºå…ç¨…ï¼Œç„¡æ³•ç·¨è¼¯ç¨…ç‡";
                var hasPaymentRecord = HasPaymentRecord(returnItem);
                if (!hasPaymentRecord) return null;
                
                return $"æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼ˆå·²æ²–æ¬¾ {GetPaidAmount(returnItem):N0} å…ƒï¼‰ï¼Œç„¡æ³•ä¿®æ”¹ç¨…ç‡";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnTaxRateInput((ReturnItem)item, valueString);
            })
        });

        // å°è¨ˆæ¬„ä½ (åªè®€é¡¯ç¤º)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å°è¨ˆ", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            Tooltip = GetSubtotalTooltip(),
            CustomTemplate = item => 
            {
                var returnItem = (ReturnItem)item;
                var subtotal = CalculateItemSubtotal(returnItem);
                var displayValue = NumberFormatHelper.FormatSmartZeroAsEmpty(subtotal);
                
                return @<div class="text-end fw-bold text-success">
                    @displayValue
                </div>;
            }
        });

        // å‚™è¨»æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å‚™è¨»", 
            PropertyName = nameof(ReturnItem.Remarks),
            ColumnType = InteractiveColumnType.Input,
            Width = "150px",
            Tooltip = "é¸å¡«ã€‚å¯è¨˜éŒ„é€€è²¨ç›¸é—œçš„å‚™è¨»è³‡è¨Šï¼ˆå¦‚é€€è²¨åŸå› ç­‰ï¼‰",
            IsDisabledFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                return returnItem.SelectedDeliveryDetail == null;
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnRemarksInput((ReturnItem)item, valueString);
            })
        });

        return columns;
    }

    private RenderFragment<ReturnItem> GetCustomActionsTemplate => item => __builder =>
    {
        // æª¢æŸ¥é …ç›®æ˜¯å¦å¯ä»¥åˆªé™¤ï¼ˆç¶œåˆé€€è²¨è¨˜éŒ„å’Œæ²–æ¬¾è¨˜éŒ„æª¢æŸ¥ï¼‰
        var canDelete = CanDeleteItem(item, out _);
        var isLastEmptyRow = tableComponent?.IsLastEmptyRow(item) ?? false;
        
        if (isLastEmptyRow)
        {
            // æœ€å¾Œä¸€å€‹ç©ºè¡Œï¼šé¡¯ç¤ºç¦ç”¨çš„åˆªé™¤æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Red"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="true"
                                   Title="è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹ç©ºè¡Œ"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else if (canDelete)
        {
            // å¯ä»¥åˆªé™¤ï¼šé¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Red"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="@IsReadOnly"
                                   Title="åˆªé™¤"
                                   OnClick="async () => await HandleItemDelete(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else
        {
            // ä¸èƒ½åˆªé™¤ï¼šé¡¯ç¤ºæŸ¥çœ‹æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Blue"
                                   IconClass="bi bi-eye text-white"
                                   Size="ButtonSize.Large"
                                   Title="æŸ¥çœ‹ç›¸é—œå–®æ“š"
                                   OnClick="async () => await ShowRelatedDocuments(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
    };

    private async Task HandleItemDelete(ReturnItem item)
    {
        // ä½¿ç”¨ç¶œåˆæª¢æŸ¥æ–¹æ³•ï¼Œç¢ºèªæ˜¯å¦å¯ä»¥åˆªé™¤
        if (!CanDeleteItem(item, out string reason))
        {
            await NotificationService.ShowWarningAsync(
                reason, 
                "æ“ä½œé™åˆ¶"
            );
            return;
        }
        
        var index = ReturnItems.IndexOf(item);
        await RemoveItemAsync(index);
    }

    /// <summary>
    /// é¡¯ç¤ºç›¸é—œå–®æ“šï¼ˆé€€è²¨å–®å’Œæ²–æ¬¾å–®ï¼‰
    /// </summary>
    private async Task ShowRelatedDocuments(ReturnItem item)
    {
        // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰çš„æ˜ç´°å¯¦é«” ID
        if (item.ExistingDetailEntity is not SalesReturnDetail detail || detail.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("æ­¤é …ç›®å°šæœªå„²å­˜ï¼Œç„¡æ³•æŸ¥çœ‹ç›¸é—œå–®æ“š", "æç¤º");
            return;
        }

        // è¨­å®šå•†å“åç¨±
        selectedProductName = item.SelectedProduct?.Name ?? "æœªçŸ¥å•†å“";

        // é¡¯ç¤º Modal ä¸¦é–‹å§‹è¼‰å…¥
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            // æŸ¥è©¢ç›¸é—œå–®æ“š
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsForSalesReturnDetailAsync(detail.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ç›¸é—œå–®æ“šå¤±æ•—ï¼š{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// è™•ç†é»æ“Šç›¸é—œå–®æ“šçš„äº‹ä»¶
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // è§¸ç™¼äº‹ä»¶ï¼Œè®“çˆ¶çµ„ä»¶ï¼ˆEditModalï¼‰è™•ç†é–‹å•Ÿç›¸é—œå–®æ“š
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            // å¦‚æœçˆ¶çµ„ä»¶æ²’æœ‰è™•ç†ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
            await NotificationService.ShowInfoAsync(
                $"è«‹åœ¨ä¸»ç•«é¢ä¸­é–‹å•Ÿ {document.TypeDisplayName}: {document.DocumentNumber}", 
                "æç¤º"
            );
        }
    }

    // ===== å…§éƒ¨æ–¹æ³• =====
    private async Task LoadAvailableProductsAsync()
    {
        try
        {
            AvailableProducts = Products?.ToList() ?? new List<Product>();
            
            // åŒæ™‚è¼‰å…¥å‡ºè²¨æ˜ç´°
            await LoadAvailableDeliveryDetailsAsync();
        }
        catch (Exception)
        {
            AvailableProducts = new List<Product>();
            AvailableDeliveryDetails = new List<SalesDeliveryDetail>();
        }
    }

    private async Task LoadAvailableDeliveryDetailsAsync()
    {
        try
        {
            if (EffectiveCustomerId.HasValue && EffectiveCustomerId.Value > 0)
            {
                // è¼‰å…¥è©²å®¢æˆ¶çš„å¯é€€è²¨å‡ºè²¨å–®æ˜ç´°
                AvailableDeliveryDetails = await SalesDeliveryDetailService.GetReturnableDetailsByCustomerAsync(EffectiveCustomerId.Value);
            }
            else
            {
                AvailableDeliveryDetails = new List<SalesDeliveryDetail>();
            }
        }
        catch (Exception)
        {
            AvailableDeliveryDetails = new List<SalesDeliveryDetail>();
        }
    }

    /// <summary>
    /// å…¬é–‹æ–¹æ³•ï¼šåˆ·æ–°æ˜ç´°è³‡æ–™ï¼ˆä¾›çˆ¶çµ„ä»¶å‘¼å«ï¼‰
    /// ç”¨æ–¼æ²–æ¬¾å–®å„²å­˜å¾Œï¼Œé‡æ–°è¼‰å…¥æ˜ç´°ä»¥æ›´æ–°æ²–æ¬¾ç›¸é—œè³‡è¨Š
    /// </summary>
    public async Task RefreshDetails()
    {
        // é‡æ–°è¼‰å…¥ç¾æœ‰æ˜ç´°ï¼ˆæœƒå¾ ExistingReturnDetails åƒæ•¸é‡æ–°è¼‰å…¥ï¼‰
        await LoadExistingDetailsAsync();
        
        // å¼·åˆ¶ UI æ›´æ–°
        StateHasChanged();
    }
    
    /// <summary>
    /// å¾ç¾æœ‰æ˜ç´°è³‡æ–™è¼‰å…¥åˆ° ReturnItems
    /// </summary>
    private async Task LoadExistingDetailsAsync()
    {
        if (ExistingReturnDetails?.Any() != true) 
        {
            ReturnItems.Clear();
            _dataLoadCompleted = true;
            tableComponent?.RefreshEmptyRow();
            StateHasChanged();
            return;
        }

        //  é–‹å§‹è¼‰å…¥è³‡æ–™
        _dataLoadCompleted = false;
        ReturnItems.Clear();
        _deletedDetailIds.Clear(); // æ¸…ç©ºå·²åˆªé™¤IDåˆ—è¡¨
        
        // è¼‰å…¥ç³»çµ±é è¨­ç¨…ç‡
        var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();
        
        foreach (var detail in ExistingReturnDetails)
        {
            // ç›´æ¥ä½¿ç”¨ Navigation Properties - æ›´å¯é çš„æ–¹å¼
            var deliveryDetail = detail.SalesDeliveryDetail;
            
            var item = new ReturnItem
            {
                // ç›´æ¥ä½¿ç”¨ Navigation Properties
                SelectedProduct = detail.Product,
                SelectedDeliveryDetail = deliveryDetail,
                DeliveryDetailSearchValue = deliveryDetail != null 
                    ? FormatDeliveryDetailDisplayText(deliveryDetail)
                    : (detail.Product != null ? $"[{detail.Product.Code}] {detail.Product.Name}" : ""),
                OriginalQuantity = (int)(deliveryDetail?.DeliveryQuantity ?? 0),
                AlreadyReturnedQuantity = GetAlreadyReturnedQuantity(deliveryDetail?.Id ?? 0),
                ReturnQuantity = (int)detail.ReturnQuantity,
                OriginalUnitPrice = deliveryDetail?.UnitPrice ?? detail.OriginalUnitPrice,
                DiscountPercentage = deliveryDetail?.DiscountPercentage ?? detail.DiscountPercentage,
                TaxRate = detail.TaxRate ?? deliveryDetail?.TaxRate ?? detail.Product?.TaxRate ?? defaultTaxRate,  //  å„ªå…ˆé †åºï¼šæ˜ç´° > éŠ€è²¨å‡ºè²¨æ˜ç´° > å•†å“ > ç³»çµ±
                ReturnReason = string.Empty,
                Remarks = detail.Remarks ?? string.Empty,
                ExistingDetailEntity = detail
            };
            
            ReturnItems.Add(item);
        }
        
        // ğŸ”¥ é—œéµï¼šè¼‰å…¥å¾Œç«‹å³æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆèˆ‡ PurchaseReceivingTable ä¸€è‡´ï¼‰
        bool hasUndeletableDetails = ReturnItems.Any(item => 
            item.ExistingDetailEntity != null && 
            !DetailLockHelper.CanDeleteItem(item.ExistingDetailEntity, out _, checkPayment: true));
        
        if (_hasUndeletableDetails != hasUndeletableDetails)
        {
            _hasUndeletableDetails = hasUndeletableDetails;
        }
        
        //  è³‡æ–™è¼‰å…¥å®Œæˆ
        _dataLoadCompleted = true;
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }

    private List<SalesDeliveryDetail> GetAvailableDeliveryDetails()
    {
        var filteredDetails = AvailableDeliveryDetails.AsQueryable();
        
        // æ ¹æ“šå‡ºè²¨å–®ç¯©é¸
        if (EffectiveSalesDeliveryId.HasValue && EffectiveSalesDeliveryId.Value > 0)
        {
            filteredDetails = filteredDetails.Where(od => od.SalesDeliveryId == EffectiveSalesDeliveryId.Value);
        }
        
        // æ ¹æ“šå•†å“ç¯©é¸
        if (EffectiveFilterProductId.HasValue && EffectiveFilterProductId.Value > 0)
        {
            filteredDetails = filteredDetails.Where(od => od.ProductId == EffectiveFilterProductId.Value);
        }
        
        // åªé¡¯ç¤ºé‚„æœ‰å¯é€€å›æ•¸é‡çš„æ˜ç´°
        return filteredDetails.Where(od => GetAvailableReturnQuantity(od) > 0).ToList();
    }

    /// <summary>
    /// å»ºæ§‹ç¯©é¸æ¢ä»¶è¨Šæ¯ï¼Œç”¨æ–¼æç¤ºä½¿ç”¨è€…ç›®å‰çš„ç¯©é¸ç‹€æ…‹
    /// </summary>
    private string BuildFilterConditionsMessage()
    {
        var conditions = new List<string>();
        
        // å®¢æˆ¶æ¢ä»¶ï¼ˆå¿…å¡«ï¼‰
        if (EffectiveCustomerId.HasValue && EffectiveCustomerId.Value > 0)
        {
            // å¾ AvailableDeliveryDetails å–å¾—å®¢æˆ¶åç¨±
            var customerName = AvailableDeliveryDetails.FirstOrDefault()?.SalesDelivery?.Customer?.CompanyName;
            conditions.Add($"â€¢ å®¢æˆ¶ï¼š{customerName ?? $"ID {EffectiveCustomerId.Value}"}");
        }
        
        // éŠ·è²¨å–®æ¢ä»¶ï¼ˆé¸å¡«ï¼‰
        if (EffectiveSalesDeliveryId.HasValue && EffectiveSalesDeliveryId.Value > 0)
        {
            var deliveryCode = AvailableDeliveryDetails
                .FirstOrDefault(d => d.SalesDeliveryId == EffectiveSalesDeliveryId.Value)?
                .SalesDelivery?.Code;
            conditions.Add($"â€¢ éŠ·è²¨å–®ï¼š{deliveryCode ?? $"ID {EffectiveSalesDeliveryId.Value}"}");
        }
        
        // å•†å“æ¢ä»¶ï¼ˆé¸å¡«ï¼‰
        if (EffectiveFilterProductId.HasValue && EffectiveFilterProductId.Value > 0)
        {
            var product = Products.FirstOrDefault(p => p.Id == EffectiveFilterProductId.Value);
            var productDisplay = product != null 
                ? $"{product.Code} {product.Name}".Trim() 
                : $"ID {EffectiveFilterProductId.Value}";
            conditions.Add($"â€¢ å•†å“ï¼š{productDisplay}");
        }
        
        // é è¨­æ¢ä»¶èªªæ˜
        conditions.Add("â€¢ å•†å“éœ€æœ‰å¯é€€è²¨æ•¸é‡");
        
        return string.Join("\n", conditions);
    }

    // ===== äº‹ä»¶è™•ç†æ–¹æ³• =====
    
    // ===== å‡ºè²¨æ˜ç´°é¸æ“‡äº‹ä»¶è™•ç† =====
    
    /// <summary>
    /// æ ¼å¼åŒ–å‡ºè²¨æ˜ç´°é¡¯ç¤ºæ–‡å­—ï¼ˆç”¨æ–¼ä¸‹æ‹‰é¸å–® - å…©è¡Œé¡¯ç¤ºï¼‰
    /// ç¬¬ä¸€è¡Œï¼šå‡ºè²¨å–®è™Ÿ + å¯é€€æ•¸é‡ï¼ˆå°å­—è—è‰²ï¼‰
    /// ç¬¬äºŒè¡Œï¼šå•†å“ç·¨è™Ÿ å•†å“åç¨±
    /// </summary>
    private string FormatDeliveryDetailDropdownText(SalesDeliveryDetail detail)
    {
        if (detail?.Product == null) return "";
        
        var product = detail.Product;
        var deliveryCode = detail.SalesDelivery?.Code ?? "N/A";
        var availableQty = GetAvailableReturnQuantity(detail);
        
        var productDisplay = !string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name)
            ? $"{product.Code} {product.Name}"
            : (!string.IsNullOrEmpty(product.Code) ? product.Code : product.Name ?? "");
        
        // å…©è¡Œé¡¯ç¤ºï¼šå‡ºè²¨å–®è™Ÿåœ¨ä¸Šï¼ˆå°å­—è—è‰²ï¼‰ï¼Œå•†å“è³‡è¨Šåœ¨ä¸‹
        return $"<div style='line-height: 1.3;'>" +
               $"<small class='text-primary'>å‡ºè²¨: {deliveryCode} (å¯é€€: {availableQty:G29})</small><br/>" +
               $"<span>{productDisplay}</span></div>";
    }
    
    /// <summary>
    /// æ ¼å¼åŒ–å‡ºè²¨æ˜ç´°é¡¯ç¤ºæ–‡å­—ï¼ˆç”¨æ–¼è¼¸å…¥æ¡†é¡¯ç¤º - å–®è¡Œç°¡æ½”æ ¼å¼ï¼‰
    /// </summary>
    private string FormatDeliveryDetailDisplayText(SalesDeliveryDetail detail)
    {
        if (detail?.Product == null) return "";
        
        var product = detail.Product;
        var deliveryCode = detail.SalesDelivery?.Code ?? "N/A";
        
        var productDisplay = !string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name)
            ? $"{product.Code} {product.Name}"
            : (!string.IsNullOrEmpty(product.Code) ? product.Code : product.Name ?? "");
        
        // è¼¸å…¥æ¡†é¡¯ç¤ºï¼šç°¡æ½”çš„å–®è¡Œæ ¼å¼
        return $"{deliveryCode} | {productDisplay}";
    }

    // ===== å‡ºè²¨æ˜ç´°é¸æ“‡äº‹ä»¶è™•ç†ï¼ˆSearchableSelectï¼‰=====

    /// <summary>
    /// å‡ºè²¨æ˜ç´°æœå°‹è¼¸å…¥äº‹ä»¶ï¼ˆåªé¡¯ç¤ºæœ‰éŠ·è²¨çš„å•†å“ï¼‰
    /// </summary>
    private Task OnDeliveryDetailSearch(ReturnItem item, string? searchValue)
    {
        item.DeliveryDetailSearchValue = searchValue ?? string.Empty;
        
        var availableDetails = GetAvailableDeliveryDetails();
        
        if (!string.IsNullOrWhiteSpace(searchValue))
        {
            var searchLower = searchValue.ToLower();
            
            // æœå°‹ï¼šå‡ºè²¨å–®è™Ÿã€å•†å“ç·¨è™Ÿã€å•†å“åç¨±
            var filteredDetails = availableDetails.Where(detail =>
            {
                var deliveryCode = detail.SalesDelivery?.Code?.ToLower() ?? "";
                var productCode = detail.Product?.Code?.ToLower() ?? "";
                var productName = detail.Product?.Name?.ToLower() ?? "";
                
                return deliveryCode.Contains(searchLower) ||
                       productCode.Contains(searchLower) ||
                       productName.Contains(searchLower);
            }).Take(20).ToList();
            
            item.FilteredDeliveryDetails = filteredDetails.Cast<object>().ToList();
        }
        else
        {
            // æœªè¼¸å…¥æœå°‹å€¼ï¼Œé¡¯ç¤ºå‰ 20 ç­†
            item.FilteredDeliveryDetails = availableDetails.Take(20).Cast<object>().ToList();
        }
        
        item.ShowDropdown = true;
        item.SelectedIndex = -1;
        
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    /// <summary>
    /// å‡ºè²¨æ˜ç´°è¼¸å…¥æ¡†ç²å¾—ç„¦é»
    /// </summary>
    private void OnDeliveryDetailFocus(ReturnItem item)
    {
        _ = OnDeliveryDetailSearch(item, item.DeliveryDetailSearchValue);
    }
    
    /// <summary>
    /// å‡ºè²¨æ˜ç´°è¼¸å…¥æ¡†å¤±å»ç„¦é»
    /// </summary>
    private void OnDeliveryDetailBlur(ReturnItem item)
    {
        Task.Delay(200).ContinueWith(_ =>
        {
            item.ShowDropdown = false;
            InvokeAsync(StateHasChanged);
        });
    }
    
    /// <summary>
    /// é¸æ“‡å‡ºè²¨æ˜ç´°é …ç›®
    /// </summary>
    private async Task OnDeliveryDetailSelect(ReturnItem item, object? selectedItem)
    {
        if (selectedItem is SalesDeliveryDetail detail)
        {
            // è¼‰å…¥ç³»çµ±é è¨­ç¨…ç‡
            var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();
            
            item.SelectedDeliveryDetail = detail;
            item.SelectedProduct = detail.Product;
            item.OriginalQuantity = (int)detail.DeliveryQuantity;
            item.AlreadyReturnedQuantity = GetAlreadyReturnedQuantity(detail.Id);
            item.ReturnQuantity = 0;
            item.OriginalUnitPrice = detail.UnitPrice;
            item.DiscountPercentage = detail.DiscountPercentage;
            item.TaxRate = detail.TaxRate ?? detail.Product?.TaxRate ?? defaultTaxRate;
            
            // æ›´æ–°æœå°‹æ¡†é¡¯ç¤º
            item.DeliveryDetailSearchValue = FormatDeliveryDetailDisplayText(detail);
        }
        else
        {
            item.SelectedDeliveryDetail = null;
            item.SelectedProduct = null;
            item.OriginalQuantity = 0;
            item.AlreadyReturnedQuantity = 0;
            item.ReturnQuantity = 0;
            item.OriginalUnitPrice = 0;
            item.DiscountPercentage = 0;
            item.TaxRate = null;
            item.DeliveryDetailSearchValue = string.Empty;
        }
        
        item.ShowDropdown = false;
        item.SelectedIndex = -1;
        
        await NotifyDetailsChanged();
    }

    private async Task OnReturnQuantityInput(ReturnItem returnItem, string? value)
    {
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ä¿®æ”¹
        if (!CanDeleteItem(returnItem, out string reason))
        {
            await NotificationService.ShowWarningAsync(
                "æ­¤å•†å“å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹é€€è²¨æ•¸é‡", 
                "æ“ä½œé™åˆ¶"
            );
            return;
        }
        
        if (int.TryParse(value, out var quantity) && quantity >= 0)
        {
            var maxQuantity = returnItem.AvailableQuantity;
            returnItem.ReturnQuantity = Math.Min(quantity, maxQuantity);
            returnItem.ValidationError = quantity > maxQuantity ? $"æœ€å¤§å¯é€€æ•¸é‡ï¼š{maxQuantity}" : null;
        }
        else
        {
            returnItem.ReturnQuantity = 0;
            returnItem.ValidationError = null;
        }
        
        await NotifyDetailsChanged();
    }

    private async Task OnReturnReasonInput(ReturnItem returnItem, string? value)
    {
        returnItem.ReturnReason = InputEventHelper.HandleTextInput(value);
        await NotifyDetailsChanged();
    }

    private async Task OnRemarksInput(ReturnItem returnItem, string? value)
    {
        returnItem.Remarks = InputEventHelper.HandleTextInput(value);
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// è™•ç†ç¨…ç‡è¼¸å…¥
    /// </summary>
    private async Task OnTaxRateInput(ReturnItem returnItem, string? valueString)
    {
        if (string.IsNullOrWhiteSpace(valueString))
        {
            returnItem.TaxRate = null;
        }
        else if (decimal.TryParse(valueString, out var taxRate))
        {
            returnItem.TaxRate = Math.Max(0, Math.Min(100, taxRate));
        }
        
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// è¨ˆç®—æ˜ç´°é …ç›®çš„å°è¨ˆï¼ˆæ ¹æ“šç¨…åˆ¥ï¼Œå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
    /// </summary>
    private decimal CalculateItemSubtotal(ReturnItem item)
    {
        if (item.SelectedProduct == null || item.ReturnQuantity <= 0 || item.OriginalUnitPrice <= 0)
            return 0;
        
        var subtotal = CalculationHelper.CalculateSubtotal(
            item.ReturnQuantity,
            item.OriginalUnitPrice,
            item.DiscountPercentage,
            item.TaxRate ?? 0,
            TaxCalculationMethod
        );
        
        // å››æ¨äº”å…¥åˆ°æ•´æ•¸
        return CalculationHelper.Round(subtotal, 0);
    }

    /// <summary>
    /// å–å¾—å°è¨ˆæ¬„ä½çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetSubtotalTooltip()
    {
        return TaxCalculationMethod switch
        {
            TaxCalculationMethod.TaxExclusive => "é€€è²¨é‡‘é¡å°è¨ˆï¼ˆå«ç¨…ï¼‰ = æ•¸é‡ Ã— å–®åƒ¹ Ã— (1 - æŠ˜æ‰£%) Ã— (1 + ç¨…ç‡%)",
            TaxCalculationMethod.TaxInclusive => "é€€è²¨é‡‘é¡å°è¨ˆï¼ˆå…§å«ç¨…ï¼‰ = æ•¸é‡ Ã— å–®åƒ¹ Ã— (1 - æŠ˜æ‰£%)",
            TaxCalculationMethod.NoTax => "é€€è²¨é‡‘é¡å°è¨ˆï¼ˆå…ç¨…ï¼‰ = æ•¸é‡ Ã— å–®åƒ¹ Ã— (1 - æŠ˜æ‰£%)",
            _ => "é€€è²¨é‡‘é¡å°è¨ˆ"
        };
    }

    /// <summary>
    /// é¡¯ç¤ºè¼‰å…¥ç¢ºèª Modal - æ”¶é›†è¼‰å…¥æ¢ä»¶ä¸¦é¡¯ç¤ºçµ¦ä½¿ç”¨è€…ç¢ºèª
    /// </summary>
    private async Task ShowLoadConfirmModal()
    {
        try
        {
            // æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡å®¢æˆ¶
            if (!EffectiveCustomerId.HasValue || EffectiveCustomerId.Value <= 0)
            {
                await NotificationService.ShowWarningAsync("è«‹å…ˆé¸æ“‡å®¢æˆ¶");
                return;
            }
            
            // å»ºç«‹è¼‰å…¥æ¢ä»¶æ¸…å–®
            _loadConditions = new List<string>();
            
            // æ¢ä»¶1ï¼šå®¢æˆ¶
            var customerName = !string.IsNullOrWhiteSpace(SelectedCustomerName) 
                ? SelectedCustomerName 
                : $"å®¢æˆ¶ ID: {EffectiveCustomerId.Value}";
            _loadConditions.Add($"å®¢æˆ¶ï¼š{customerName}");
            
            // æ¢ä»¶2ï¼šå‡ºè²¨å–®ï¼ˆå¦‚æœ‰é¸æ“‡ï¼‰
            if (EffectiveSalesDeliveryId.HasValue && EffectiveSalesDeliveryId.Value > 0)
            {
                var deliveryCode = !string.IsNullOrWhiteSpace(SelectedSalesDeliveryCode)
                    ? SelectedSalesDeliveryCode
                    : $"å‡ºè²¨å–® ID: {EffectiveSalesDeliveryId.Value}";
                _loadConditions.Add($"å‡ºè²¨å–®ï¼š{deliveryCode}");
            }
            else
            {
                _loadConditions.Add("å‡ºè²¨å–®ï¼šå…¨éƒ¨å¯é€€è²¨å‡ºè²¨å–®");
            }
            
            // æ¢ä»¶3ï¼šå•†å“ç¯©é¸ï¼ˆå¦‚æœ‰é¸æ“‡ï¼‰
            if (EffectiveFilterProductId.HasValue && EffectiveFilterProductId.Value > 0)
            {
                var productName = !string.IsNullOrWhiteSpace(FilterProductName)
                    ? FilterProductName
                    : $"å•†å“ ID: {EffectiveFilterProductId.Value}";
                _loadConditions.Add($"å•†å“ç¯©é¸ï¼š{productName}");
            }
            
            // è¨ˆç®—ç¬¦åˆæ¢ä»¶çš„æ˜ç´°æ•¸é‡
            var availableDetails = GetAvailableDeliveryDetails();
            int matchingCount = availableDetails.Count;
            
            if (matchingCount == 0)
            {
                await NotificationService.ShowInfoAsync("ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å¯é€€è²¨æ˜ç´°");
                return;
            }
            
            _loadSummaryMessage = $"å…± {matchingCount} ç­†ï¼Œæ˜¯å¦ç¢ºå®šè¼‰å…¥ï¼Ÿ";
            
            // é¡¯ç¤ºç¢ºèª Modal
            _showLoadConfirmModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æº–å‚™è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// åŸ·è¡Œè¼‰å…¥æ‰€æœ‰å¯é€€è²¨å•†å“ - ä½¿ç”¨è€…ç¢ºèªå¾ŒåŸ·è¡Œ
    /// </summary>
    private async Task ExecuteLoadAllReturnableItems()
    {
        try
        {
            var availableDetails = GetAvailableDeliveryDetails();
            
            if (!availableDetails.Any())
            {
                await NotificationService.ShowWarningAsync("æ²’æœ‰å¯é€€è²¨çš„å‡ºè²¨æ˜ç´°", "æç¤º");
                return;
            }
            
            // æ¸…é™¤ç¾æœ‰é …ç›®ä½†ä¿ç•™å·²æœ‰è³‡æ–™çš„é …ç›®
            var existingItems = ReturnItems.Where(item => item.SelectedProduct != null).ToList();
            ReturnItems.Clear();
            ReturnItems.AddRange(existingItems);
            
            // è¼‰å…¥ç³»çµ±é è¨­ç¨…ç‡
            var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();
            
            // æ–°å¢æ‰€æœ‰å¯é€€è²¨çš„é …ç›®
            int addedCount = 0;
            foreach (var deliveryDetail in availableDetails)
            {
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“å­˜åœ¨ç›¸åŒçš„æ˜ç´°
                if (ReturnItems.Any(item => item.SelectedDeliveryDetail?.Id == deliveryDetail.Id))
                    continue;
                
                // å–å¾—ç¨…ç‡ï¼ˆå„ªå…ˆé †åºï¼šéŠ·è²¨å‡ºè²¨æ˜ç´°ç¨…ç‡ > å•†å“ç¨…ç‡ > ç³»çµ±é è¨­ç¨…ç‡ï¼‰
                var taxRate = deliveryDetail.TaxRate ?? deliveryDetail.Product?.TaxRate ?? defaultTaxRate;
                
                var newItem = new ReturnItem
                {
                    SelectedDeliveryDetail = deliveryDetail,
                    SelectedProduct = deliveryDetail.Product,
                    DeliveryDetailSearchValue = FormatDeliveryDetailDisplayText(deliveryDetail),
                    OriginalQuantity = (int)deliveryDetail.DeliveryQuantity,
                    AlreadyReturnedQuantity = GetAlreadyReturnedQuantity(deliveryDetail.Id),
                    ReturnQuantity = 0,
                    OriginalUnitPrice = deliveryDetail.UnitPrice,
                    DiscountPercentage = deliveryDetail.DiscountPercentage,
                    TaxRate = taxRate
                };
                
                ReturnItems.Add(newItem);
                addedCount++;
            }
            
            await NotifyDetailsChanged();
            await NotificationService.ShowSuccessAsync($"å·²è¼‰å…¥ {addedCount} ç­†å¯é€€è²¨å•†å“");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å¯é€€è²¨å•†å“æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è¼‰å…¥æ‰€æœ‰å¯é€€è²¨å•†å“çš„ä¸»è¦æ–¹æ³•ï¼ˆå…¬é–‹æ–¹æ³•ï¼Œä¾›çˆ¶çµ„ä»¶èª¿ç”¨ï¼‰
    /// </summary>
    public async Task LoadAllReturnableItems()
    {
        await ExecuteLoadAllReturnableItems();
    }

    private async Task RemoveItemAsync(int index)
    {
        if (index >= 0 && index < ReturnItems.Count)
        {
            var item = ReturnItems[index];
            
            // é€šçŸ¥çˆ¶çµ„ä»¶é …ç›®å³å°‡è¢«ç§»é™¤
            if (OnItemRemoved.HasDelegate)
            {
                await OnItemRemoved.InvokeAsync(item);
            }
            
            // å¦‚æœæ˜¯ç¾æœ‰æ˜ç´°ï¼Œè¨˜éŒ„IDä»¥ä¾¿åˆªé™¤
            if (item.ExistingDetailEntity?.Id > 0)
            {
                _deletedDetailIds.Add(item.ExistingDetailEntity.Id);
            }
            
            ReturnItems.RemoveAt(index);
            await NotifyDetailsChanged();
        }
    }

    private decimal GetTotalAmount()
    {
        return ReturnItems.Where(item => item.SelectedProduct != null)
                          .Sum(item => item.ReturnSubtotalAmount);
    }

    private async Task NotifyDetailsChanged()
    {
        // è½‰æ›ç‚º SalesReturnDetail å¯¦é«”ï¼ˆåªåŒ…å«æœ‰é€€è²¨æ•¸é‡çš„æ˜ç´°ï¼‰
        var details = ReturnItems.Where(item => item.SelectedProduct != null && item.ReturnQuantity > 0)
                                 .Select(item => ConvertToEntity(item))
                                 .Where(entity => entity != null)
                                 .ToList();
        
        if (EffectiveDetailsChangedCallback.HasDelegate)
        {
            await DetailSyncHelper.SyncToParentAsync(details!, EffectiveDetailsChangedCallback);
        }
        
        // é€šçŸ¥å·²åˆªé™¤çš„æ˜ç´° ID
        if (OnDeletedDetailsChanged.HasDelegate && _deletedDetailIds.Any())
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds.ToList());
            _deletedDetailIds.Clear(); // æ¸…ç©ºå·²é€šçŸ¥çš„ID
        }
        
        if (OnReturnItemsChanged.HasDelegate)
        {
            await OnReturnItemsChanged.InvokeAsync(ReturnItems);
        }
        
        //  é€šçŸ¥çˆ¶çµ„ä»¶æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
        await NotifyHasUndeletableDetailsChanged();
    }

    private SalesReturnDetail? ConvertToEntity(ReturnItem item)
    {
        // åªè¦é¸æ“‡äº†å•†å“å°±è½‰æ›ï¼Œå³ä½¿ ReturnQuantity ç‚º 0ï¼ˆç”¨æ–¼è¨ˆç®—ï¼‰
        if (item.SelectedDeliveryDetail == null || item.SelectedProduct == null)
        {
            return null;
        }
        
        // å¦‚æœå·²æœ‰å¯¦é«”ï¼Œæ›´æ–°å®ƒ
        if (item.ExistingDetailEntity != null)
        {
            item.ExistingDetailEntity.SalesDeliveryDetailId = item.SelectedDeliveryDetail.Id;
            item.ExistingDetailEntity.ProductId = item.SelectedProduct.Id;
            item.ExistingDetailEntity.ReturnQuantity = item.ReturnQuantity;
            item.ExistingDetailEntity.OriginalUnitPrice = item.OriginalUnitPrice;
            item.ExistingDetailEntity.DiscountPercentage = item.DiscountPercentage;
            item.ExistingDetailEntity.TaxRate = item.TaxRate;  //  å¯«å…¥ç¨…ç‡
            item.ExistingDetailEntity.Remarks = item.Remarks;
            
            return item.ExistingDetailEntity;
        }
        
        // å‰µå»ºæ–°å¯¦é«”
        return new SalesReturnDetail
        {
            SalesDeliveryDetailId = item.SelectedDeliveryDetail.Id,
            ProductId = item.SelectedProduct.Id,
            ReturnQuantity = item.ReturnQuantity,
            OriginalUnitPrice = item.OriginalUnitPrice,
            DiscountPercentage = item.DiscountPercentage,
            TaxRate = item.TaxRate,  //  å¯«å…¥ç¨…ç‡
            Remarks = item.Remarks
        };
    }

    // ===== è¼”åŠ©æ–¹æ³• =====
    private int GetAlreadyReturnedQuantity(int deliveryDetailId)
    {
        // é€™è£¡æ‡‰è©²æŸ¥è©¢è³‡æ–™åº«ç²å–å·²é€€è²¨æ•¸é‡ï¼Œç›®å‰æš«æ™‚å›å‚³0
        // å¯èƒ½éœ€è¦å‘¼å«æœå‹™ä¾†ç²å–
        return 0;
    }
    
    private int GetAvailableReturnQuantity(SalesDeliveryDetail deliveryDetail)
    {
        var alreadyReturned = GetAlreadyReturnedQuantity(deliveryDetail.Id);
        return (int)(deliveryDetail.DeliveryQuantity - alreadyReturned);
    }

    /// <summary>
    /// é€€è²¨é‡å…¨å¡«ï¼ˆåªè™•ç†æœªé–å®šçš„æ˜ç´°ï¼‰
    /// </summary>
    private async Task FillAllQuantities()
    {
        var nonEmptyItems = ReturnItems.Where(item => item.SelectedProduct != null).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("æ²’æœ‰å¯æ›´æ–°çš„æ˜ç´°é …ç›®", "æç¤º");
            return;
        }
        
        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
        
        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "æ‰€æœ‰æ˜ç´°éƒ½å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•æ‰¹æ¬¡å¡«å…¥æ•¸é‡", 
                "æ“ä½œé™åˆ¶");
            return;
        }
        
        foreach (var item in unlocked)
        {
            if (item.SelectedDeliveryDetail != null)
            {
                item.ReturnQuantity = item.AvailableQuantity;
                item.ValidationError = null;
            }
        }
        
        var message = $"å·²å¡«å…¥ {unlocked.Count} é …æ˜ç´°çš„é€€è²¨æ•¸é‡";
        if (locked.Any())
        {
            message += $"\nï¼ˆå·²è·³é {locked.Count} é …å·²é–å®šçš„æ˜ç´°ï¼‰";
        }
        await NotificationService.ShowSuccessAsync(message);
        
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// é€€è²¨é‡æ¸…ç©ºï¼ˆåªè™•ç†æœªé–å®šçš„æ˜ç´°ï¼‰
    /// </summary>
    private async Task ClearAllQuantities()
    {
        var nonEmptyItems = ReturnItems.Where(item => item.SelectedProduct != null).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("æ²’æœ‰å¯æ›´æ–°çš„æ˜ç´°é …ç›®", "æç¤º");
            return;
        }
        
        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
        
        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "æ‰€æœ‰æ˜ç´°éƒ½å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•æ‰¹æ¬¡æ¸…ç©ºæ•¸é‡", 
                "æ“ä½œé™åˆ¶");
            return;
        }
        
        foreach (var item in unlocked)
        {
            item.ReturnQuantity = 0;
        }
        
        var message = $"å·²æ¸…ç©º {unlocked.Count} é …æ˜ç´°çš„é€€è²¨æ•¸é‡";
        if (locked.Any())
        {
            message += $"\nï¼ˆå·²è·³é {locked.Count} é …å·²é–å®šçš„æ˜ç´°ï¼‰";
        }
        await NotificationService.ShowSuccessAsync(message);
        
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// æ¸…é™¤æ˜ç´°ï¼ˆåªç§»é™¤æœªé–å®šçš„æ˜ç´°ï¼Œä¿ç•™å·²é–å®šçš„ï¼‰
    /// </summary>
    private async Task ClearAllDetails()
    {
        var nonEmptyItems = ReturnItems.Where(item => item.SelectedProduct != null).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("æ²’æœ‰å¯ç§»é™¤çš„æ˜ç´°é …ç›®", "æç¤º");
            return;
        }
        
        // å€åˆ†å¯åˆªé™¤å’Œè¢«é–å®šçš„æ˜ç´°
        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
        
        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "æ‰€æœ‰æ˜ç´°éƒ½å·²æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç„¡æ³•ç§»é™¤", 
                "æ“ä½œé™åˆ¶");
            return;
        }
        
        // é€šçŸ¥çˆ¶çµ„ä»¶é …ç›®å³å°‡è¢«ç§»é™¤
        if (OnItemRemoved.HasDelegate)
        {
            foreach (var item in unlocked)
            {
                await OnItemRemoved.InvokeAsync(item);
            }
        }
        
        // è¨˜éŒ„æ‰€æœ‰è¦åˆªé™¤çš„ç¾æœ‰æ˜ç´° ID
        foreach (var item in unlocked.Where(item => item.ExistingDetailEntity?.Id > 0))
        {
            _deletedDetailIds.Add(item.ExistingDetailEntity!.Id);
        }
        
        // å¾åˆ—è¡¨ä¸­ç§»é™¤æœªé–å®šçš„é …ç›®ï¼Œä¿ç•™å·²é–å®šçš„é …ç›®
        foreach (var item in unlocked)
        {
            ReturnItems.Remove(item);
        }
        
        await NotifyDetailsChanged();
        
        var message = $"å·²ç§»é™¤ {unlocked.Count} é …æ˜ç´°";
        if (locked.Any())
        {
            message += $"\nï¼ˆå·²ä¿ç•™ {locked.Count} é …å·²é–å®šçš„æ˜ç´°ï¼‰";
        }
        await NotificationService.ShowSuccessAsync(message);
    }

    // ===== å…¬é–‹æ–¹æ³• - ä¾›çˆ¶çµ„ä»¶èª¿ç”¨ =====
    public async Task<bool> ValidateAsync()
    {
        try
        {
            var errors = new List<string>();
            
            // æª¢æŸ¥æ˜¯å¦æœ‰é€€è²¨é …ç›®
            var potentialItems = ReturnItems.Where(item => item.SelectedProduct != null && item.ReturnQuantity > 0).ToList();
            if (!potentialItems.Any())
            {
                errors.Add("è‡³å°‘éœ€è¦ä¸€å€‹é€€è²¨é …ç›®");
            }
            
            // æª¢æŸ¥å¿…å¡«æ¬„ä½å’ŒåŸºæœ¬é©—è­‰
            foreach (var item in potentialItems)
            {
                if (item.SelectedDeliveryDetail == null)
                {
                    errors.Add("è«‹é¸æ“‡æœ‰æ•ˆçš„å‡ºè²¨æ˜ç´°");
                    continue;
                }
                
                if (item.ReturnQuantity > item.AvailableQuantity)
                {
                    errors.Add($"å•†å“ {item.SelectedProduct?.Code} çš„é€€è²¨æ•¸é‡è¶…éå¯é€€æ•¸é‡");
                }
                
                if (item.OriginalUnitPrice < 0)
                {
                    errors.Add($"å•†å“ {item.SelectedProduct?.Code} çš„åŸå§‹å–®åƒ¹ä¸å¯ç‚ºè² æ•¸");
                }
            }
            
            if (errors.Any())
            {
                var errorMessage = string.Join("\n", errors);
                await NotificationService.ShowErrorAsync(errorMessage);
                return false;
            }
            
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é©—è­‰æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }
    
    // ===== ReturnItem å…§éƒ¨é¡åˆ¥ =====
    public class ReturnItem
    {
        public Product? SelectedProduct { get; set; }
        public SalesDeliveryDetail? SelectedDeliveryDetail { get; set; }
        
        // === SearchableSelect æ”¯æ´å±¬æ€§ï¼ˆå‡ºè²¨æ˜ç´°æœå°‹ï¼‰===
        public string DeliveryDetailSearchValue { get; set; } = string.Empty;
        public List<object> FilteredDeliveryDetails { get; set; } = new();
        public bool ShowDropdown { get; set; } = false;
        public int SelectedIndex { get; set; } = -1;
        
        public int OriginalQuantity { get; set; } = 0;
        public int AlreadyReturnedQuantity { get; set; } = 0;
        public int ReturnQuantity { get; set; } = 0;
        
        public decimal OriginalUnitPrice { get; set; } = 0;
        public decimal DiscountPercentage { get; set; } = 0;
        public decimal? TaxRate { get; set; }  //  æ–°å¢ç¨…ç‡å±¬æ€§
        
        public string ReturnReason { get; set; } = string.Empty;
        public string Remarks { get; set; } = string.Empty;
        
        public SalesReturnDetail? ExistingDetailEntity { get; set; }
        public string? ValidationError { get; set; }
        
        // è¨ˆç®—å±¬æ€§
        public decimal ReturnSubtotalAmount => Math.Round(ReturnQuantity * OriginalUnitPrice * (1 - DiscountPercentage / 100), 2);
        public int AvailableQuantity => OriginalQuantity - AlreadyReturnedQuantity;
        
        /// <summary>
        /// å–å¾—é¡¯ç¤ºç”¨çš„å•†å“åç¨±ï¼ˆåŒ…å«å‡ºè²¨å–®è™Ÿï¼‰
        /// </summary>
        public string DisplayName => 
            SelectedProduct != null 
                ? $"[{SelectedDeliveryDetail?.SalesDelivery?.Code ?? "N/A"}] {SelectedProduct.Code} - {SelectedProduct.Name}"
                : string.Empty;
    }
}

