@* 銷售退貨商品明細管理元件 - 使用 InteractiveTableComponent 統一UI 並整合自動空行功能 *@

@using ERPCore2.Helpers.InteractiveTableComponentHelper
@using ERPCore2.Models.Enums
@using ERPCore2.Helpers
@inject IStringLocalizer<SharedResource> L
@inject ISalesDeliveryDetailService SalesDeliveryDetailService
@inject ISalesReturnDetailService SalesReturnDetailService
@inject INotificationService NotificationService
@inject IWarehouseLocationService WarehouseLocationService
@inject ISystemParameterService SystemParameterService
@inject IProductService ProductService
@inject RelatedDocumentsHelper RelatedDocumentsHelper
@inject IJSRuntime JSRuntime

@inherits BaseDetailTableComponent<SalesReturn, SalesReturnDetail, SalesReturnTable.ReturnItem>

@if (!EffectiveCustomerId.HasValue || EffectiveCustomerId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="customer-warning">
                <i class="fas fa-user fa-2x mb-3 text-muted"></i>
                <p class="text-muted">選擇客戶後即可查看該客戶可退貨的商品</p>
            </div>
        </div>
    </div>
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="ReturnItem"
                                      OnDataChanged="@NotifyDetailsChangedAsync"
                                      Items="@Items"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"                                      
                                      EmptyMessage="@EmptyMessage"
                                      ShowBuiltInActions="true"                                      
                                      ShowBuiltInDeleteButton="false"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"     
                                      ActionsColumnWidth = "60px"
                                      EnableAutoEmptyRow="true"
                                      AllowAddNewRow="@(!_hasUndeletableDetails && !IsReadOnly)"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@(() => new ReturnItem())"/>
        </div>

        <div class="card-footer">
            <div class="table-action-bar">
                <div class="btn-group-left">
                    <GenericButtonComponent Text="載入"
                                          Variant="ButtonVariant.DarkBlue"
                                          IsDisabled="@(IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetLoadAllReturnableTooltip()"
                                          OnClick="ShowLoadConfirmModal" />
                </div>
                <div class="btn-group-right">
                    <GenericButtonComponent Text="退貨全填"
                                          Icon="fill-drip"
                                          Variant="ButtonVariant.DarkBlue"
                                          IsDisabled="@(!HasReturnItems || IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetFillAllQuantitiesTooltip()"
                                          OnClick="@FillAllQuantities" />
                    <GenericButtonComponent Text="退貨清空"
                                          Icon="eraser"
                                          Variant="ButtonVariant.Red"
                                          IsDisabled="@(!HasReturnItems || IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetClearAllQuantitiesTooltip()"
                                          OnClick="@ClearAllQuantities" />
                    <GenericButtonComponent Text="清除明細"
                                          Icon="trash-alt"
                                          Variant="ButtonVariant.Red"
                                          IsDisabled="@(!HasReturnItems || IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetClearAllDetailsTooltip()"
                                          OnClick="@ClearAllDetails" />
                </div>
            </div>
        </div>
    </div>
}

<!-- 相關單據查看 Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

<!-- 載入確認 Modal -->
<GenericConfirmModalComponent IsVisible="@_showLoadConfirmModal"
                             IsVisibleChanged="@((bool visible) => _showLoadConfirmModal = visible)"
                             Title="載入確認"
                             Icon="bi-box-arrow-in-down"
                             Message="即將載入以下條件的可退貨明細："
                             Conditions="@_loadConditions"
                             SummaryMessage="@_loadSummaryMessage"
                             ConfirmButtonVariant="ButtonVariant.Blue"
                             OnConfirm="@ExecuteLoadAllReturnableItems"
                             OnCancel="@(() => _showLoadConfirmModal = false)" />

@code {
    // ===== 基本參數 =====
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public EventCallback<List<ReturnItem>> OnReturnItemsChanged { get; set; }

    // ===== 客戶過濾參數 =====
    // CustomerId: module-specific direct customer ID (e.g. from main entity)
    // SelectedSupplierId (from base): used when customer is selected via dropdown/picker
    [Parameter] public int? CustomerId { get; set; }

    // ===== 篩選參數 =====
    [Parameter] public int? SelectedSalesDeliveryId { get; set; }
    [Parameter] public int? FilterSalesDeliveryId { get; set; }
    [Parameter] public int? FilterProductId { get; set; }

    // ===== 額外參數（用於顯示確認訊息）=====
    [Parameter] public string? SelectedCustomerName { get; set; }
    [Parameter] public string? SelectedSalesDeliveryCode { get; set; }
    [Parameter] public string? FilterProductName { get; set; }

    // ===== 現有明細參數（由 base 的 ExistingDetails 取代）=====
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    [Parameter] public EventCallback<ReturnItem> OnItemRemoved { get; set; }

    // ===== 編輯模式參數 =====
    [Parameter] public bool IsEditMode { get; set; } = false;

    // ===== 顯示設定 =====
    [Parameter] public string Title { get; set; } = "退貨明細";
    [Parameter] public string Subtitle { get; set; } = "";
    [Parameter] public string Icon { get; set; } = "undo";
    [Parameter] public string ItemDisplayName { get; set; } = "商品";
    [Parameter] public string EmptyMessage { get; set; } = "尚未新增退貨商品";

    // ===== 稅別參數 =====
    [Parameter] public TaxCalculationMethod TaxCalculationMethod { get; set; } = TaxCalculationMethod.TaxExclusive;

    // ===== 輔助計算屬性 =====
    private bool IsTaxCalculationMethodNoTax => TaxCalculationMethod == TaxCalculationMethod.NoTax;

    // ===== 相關單據開啟事件 =====
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }

    private List<Product> AvailableProducts { get; set; } = new List<Product>();
    private List<SalesDeliveryDetail> AvailableDeliveryDetails { get; set; } = new List<SalesDeliveryDetail>();
    private int? _previousSelectedSalesDeliveryId = null;
    private int? _previousFilterProductId = null;
    private List<int> _deletedDetailIds { get; set; } = new List<int>();
    
    // ===== 相關單據查看 =====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;
    
    // ===== 載入確認 Modal =====
    private bool _showLoadConfirmModal = false;
    private List<string> _loadConditions = new();
    private string _loadSummaryMessage = string.Empty;

    // ===== 計算屬性 =====
    // SelectedSupplierId (from base) serves as SelectedCustomerId for counterparty tracking
    private int? EffectiveCustomerId => CustomerId ?? SelectedSupplierId;
    private int? EffectiveSalesDeliveryId => FilterSalesDeliveryId ?? SelectedSalesDeliveryId;
    private int? EffectiveFilterProductId => FilterProductId;
    
    /// <summary>
    /// 判斷是否可以使用「載入全部可退」功能
    /// 規則：
    /// 1. 必須選擇客戶
    /// 2. 無已有沖款記錄的明細
    /// 注意：其他條件檢查移至 LoadAllReturnableItems 方法中，載入時提示使用者
    /// </summary>
    private bool CanLoadAllReturnable => 
        EffectiveCustomerId.HasValue && 
        EffectiveCustomerId.Value > 0 && 
        !_hasUndeletableDetails;
    
    /// <summary>
    /// 取得「載入可退貨」按鈕的提示訊息
    /// </summary>
    private string GetLoadAllReturnableTooltip()
    {
        if (IsReadOnly)
            return "唯讀模式無法使用";
        
        if (_hasUndeletableDetails)
            return "部分明細已有沖款記錄，無法使用載入功能";
        
        return "載入符合條件的可退貨出貨明細";
    }
    
    /// <summary>
    /// 計算屬性：是否有退貨明細項目
    /// </summary>
    private bool HasReturnItems =>
        Items.Any(item => item.SelectedProduct != null);
    
    /// <summary>
    /// 取得退貨全填按鈕的提示文字
    /// </summary>
    private string GetFillAllQuantitiesTooltip()
    {
        if (!HasReturnItems)
            return "目前無明細可填入";
        
        if (IsReadOnly)
            return "唯讀模式無法使用";
        
        if (_hasUndeletableDetails)
            return "部分明細已有沖款記錄，無法批次填入數量";
        
        return "將所有明細的退貨數量填入可退貨的最大數量";
    }
    
    /// <summary>
    /// 取得退貨清空按鈕的提示文字
    /// </summary>
    private string GetClearAllQuantitiesTooltip()
    {
        if (!HasReturnItems)
            return "目前無明細可清空";
        
        if (IsReadOnly)
            return "唯讀模式無法使用";
        
        if (_hasUndeletableDetails)
            return "部分明細已有沖款記錄，無法批次清空數量";
        
        return "清空所有明細的退貨數量";
    }
    
    /// <summary>
    /// 取得清除明細按鈕的提示文字
    /// </summary>
    private string GetClearAllDetailsTooltip()
    {
        if (!HasReturnItems)
            return "目前無明細可清除";
        
        if (IsReadOnly)
            return "唯讀模式無法使用";
        
        if (_hasUndeletableDetails)
            return "部分明細已有沖款記錄，無法清除明細";
        
        return "清空所有退貨明細";
    }
    
    /// <summary>
    /// 檢查是否有被鎖定的明細（有沖款記錄的明細）
    /// </summary>
    private bool HasLockedDetails()
    {
        return Items.Any(item =>
            item.SelectedProduct != null && HasPaymentRecord(item));
    }

    protected override async Task OnInitializedAsync()
    {
        _previousSelectedSalesDeliveryId = EffectiveSalesDeliveryId;
        _previousFilterProductId = EffectiveFilterProductId;
        await LoadAvailableProductsAsync();
        await base.OnInitializedAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        bool salesDeliveryChanged = _previousSelectedSalesDeliveryId != EffectiveSalesDeliveryId;
        bool productFilterChanged = _previousFilterProductId != EffectiveFilterProductId;

        await base.OnParametersSetAsync();

        if (salesDeliveryChanged || productFilterChanged)
        {
            _previousSelectedSalesDeliveryId = EffectiveSalesDeliveryId;
            _previousFilterProductId = EffectiveFilterProductId;
            StateHasChanged();
        }
    }

    /// <summary>
    /// 當 SelectedSupplierId (客戶) 改變時，重新載入可退貨出貨明細
    /// </summary>
    protected override async Task OnCounterpartyChangedAsync()
    {
        await LoadAvailableDeliveryDetailsAsync();
    }

    /// <summary>
    /// 將 ExistingDetails 對應到 Items 列表
    /// </summary>
    protected override async Task LoadItemsFromDetailsAsync()
    {
        if (ExistingDetails?.Any() != true)
            return;

        _deletedDetailIds.Clear();

        var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();

        foreach (var detail in ExistingDetails)
        {
            var deliveryDetail = detail.SalesDeliveryDetail;

            var item = new ReturnItem
            {
                SelectedProduct = detail.Product,
                SelectedDeliveryDetail = deliveryDetail,
                DeliveryDetailSearchValue = deliveryDetail != null
                    ? FormatDeliveryDetailDisplayText(deliveryDetail)
                    : (detail.Product != null ? $"[{detail.Product.Code}] {detail.Product.Name}" : ""),
                OriginalQuantity = (int)(deliveryDetail?.DeliveryQuantity ?? 0),
                AlreadyReturnedQuantity = GetAlreadyReturnedQuantity(deliveryDetail?.Id ?? 0),
                ReturnQuantity = (int)detail.ReturnQuantity,
                OriginalUnitPrice = deliveryDetail?.UnitPrice ?? detail.OriginalUnitPrice,
                DiscountPercentage = deliveryDetail?.DiscountPercentage ?? detail.DiscountPercentage,
                TaxRate = detail.TaxRate ?? deliveryDetail?.TaxRate ?? detail.Product?.TaxRate ?? defaultTaxRate,
                ReturnReason = string.Empty,
                Remarks = detail.Remarks ?? string.Empty,
                ExistingDetailEntity = detail
            };

            Items.Add(item);
        }
    }

    /// <summary>
    /// 判斷目前 Items 中是否有不可刪除的明細
    /// </summary>
    protected override bool ComputeHasUndeletableDetails()
    {
        return Items.Any(item =>
            item.ExistingDetailEntity != null &&
            !DetailLockHelper.CanDeleteItem(item.ExistingDetailEntity, out _, checkPayment: true));
    }

    /// <summary>
    /// 將 Items 轉換回 SalesReturnDetail 列表（用於通知父元件）
    /// </summary>
    protected override List<SalesReturnDetail> ConvertItemsToDetails()
    {
        return Items.Where(item => item.SelectedProduct != null)
                    .Select(item => ConvertToEntity(item))
                    .Where(entity => entity != null)
                    .ToList()!;
    }

    // ===== 沖款記錄檢查方法 =====
    
    /// <summary>
    /// 檢查指定的銷貨退回明細項目是否有沖款記錄
    /// 檢查邏輯：
    /// - 資料表：SalesReturnDetail
    /// - 欄位：TotalPaidAmount (累計付款金額)
    /// - 條件：TotalPaidAmount > 0 表示已有沖款記錄，不可刪除
    /// </summary>
    /// <param name="item">要檢查的退貨明細項目</param>
    /// <returns>true 表示有沖款記錄，false 表示沒有</returns>
    private bool HasPaymentRecord(ReturnItem item)
    {
        if (item.ExistingDetailEntity != null && item.ExistingDetailEntity.Id > 0)
        {
            // 檢查 TotalPaidAmount 是否大於 0
            return item.ExistingDetailEntity.TotalPaidAmount > 0;
        }
        return false;
    }
    
    /// <summary>
    /// 取得指定退貨明細項目的已沖款金額
    /// </summary>
    /// <param name="item">要檢查的退貨明細項目</param>
    /// <returns>已沖款金額</returns>
    private decimal GetPaidAmount(ReturnItem item)
    {
        if (item.ExistingDetailEntity != null && item.ExistingDetailEntity.Id > 0)
        {
            return item.ExistingDetailEntity.TotalPaidAmount;
        }
        return 0;
    }
    
    /// <summary>
    /// 檢查項目是否可以刪除
    /// 檢查條件：
    /// 1. 沖款記錄檢查 (HasPaymentRecord)
    ///    - 資料來源：直接讀取 SalesReturnDetail 實體
    ///    - 檢查資料表：SalesReturnDetail (銷貨退回明細)
    ///    - 檢查欄位：TotalPaidAmount (累計付款金額)
    ///    - 限制原因：已沖款的退貨明細不可刪除，避免財務資料錯亂
    /// </summary>
    /// <param name="item">要檢查的項目</param>
    /// <param name="reason">不可刪除的原因（輸出參數）</param>
    /// <returns>true 表示可以刪除，false 表示不可刪除</returns>
    private bool CanDeleteItem(ReturnItem item, out string reason)
    {
        var canDelete = DetailLockHelper.CanDeleteItem(
            item.ExistingDetailEntity, 
            out reason, 
            checkPayment: true);
        
        if (!canDelete && item.ExistingDetailEntity != null)
        {
            // 明細被鎖定
        }
        
        return canDelete;
    }
    

    // ===== InteractiveTableComponent 方法 =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // 出貨明細選擇欄位 - 使用 SearchableSelect 類型（只顯示有銷貨的商品）
        columns.Add(new InteractiveColumnDefinition
        {
            Title = L["Column.ProductCodeName"],
            PropertyName = "DeliveryDetailSearchValue",
            EmptyCheckPropertyName = "SelectedDeliveryDetail",  //  檢查物件屬性是否為空
            TriggerEmptyRowOnFilled = true,  //  選擇後自動新增空行
            ColumnType = InteractiveColumnType.SearchableSelect,
            Width = "300px",
            Tooltip = "搜尋並選擇要退貨的銷售商品。已有沖款記錄的商品將無法變更",
            Placeholder = "請輸入出貨單號或商品編號/名稱",
            SearchValuePropertyName = nameof(ReturnItem.DeliveryDetailSearchValue),
            FilteredItemsPropertyName = nameof(ReturnItem.FilteredDeliveryDetails),
            ShowDropdownPropertyName = nameof(ReturnItem.ShowDropdown),
            SelectedIndexPropertyName = nameof(ReturnItem.SelectedIndex),
            ItemDisplayFormatter = (item) =>
            {
                if (item is SalesDeliveryDetail detail)
                    return FormatDeliveryDetailDropdownText(detail);
                return string.Empty;
            },
            IsDisabledFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                return HasPaymentRecord(returnItem);
            },
            TooltipFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                var hasPaymentRecord = HasPaymentRecord(returnItem);
                if (!hasPaymentRecord) return null;
                
                return $"此商品已有沖款記錄（已沖款 {GetPaidAmount(returnItem):N0} 元），無法修改商品選擇";
            },
            OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async (tuple) =>
            {
                var (item, searchValue) = tuple;
                await OnDeliveryDetailSearch((ReturnItem)item, searchValue);
            }),
            OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
            {
                var (item, selectedItem) = tuple;
                await OnDeliveryDetailSelect((ReturnItem)item, selectedItem);
            }),
            OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnDeliveryDetailFocus((ReturnItem)item);
            }),
            OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnDeliveryDetailBlur((ReturnItem)item);
            }),
            EnableKeyboardNavigation = true,
            GetDropdownItems = (item) => ((ReturnItem)item).FilteredDeliveryDetails,
            GetSelectedIndex = (item) => ((ReturnItem)item).SelectedIndex,
            SetSelectedIndex = (item, index) => ((ReturnItem)item).SelectedIndex = index,
            GetShowDropdown = (item) => ((ReturnItem)item).ShowDropdown,
            SetShowDropdown = (item, show) => ((ReturnItem)item).ShowDropdown = show,
            MaxDisplayItems = 20
        });

        // 原始銷售數量欄位 (只讀顯示)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = L["Column.OriginalQuantity"],
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            Tooltip = "當初銷售時的原始數量（唯讀）",
            CustomTemplate = item => 
            {
                var returnItem = (ReturnItem)item;
                if (returnItem.SelectedDeliveryDetail == null) return @<span class="text-muted">-</span>;
                return @<div class="d-flex align-items-center justify-content-end">
                    <span>@returnItem.OriginalQuantity.ToString("N0")</span>
                </div>;
            }
        });

        // 退貨數量欄位
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = L["Column.SalesReturnQuantity"],
            PropertyName = nameof(ReturnItem.ReturnQuantity),
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            Tooltip = "要退回的商品數量。已有沖款記錄的商品將無法修改數量",
            IsDisabledFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                return HasPaymentRecord(returnItem);
            },
            TooltipFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                var hasPaymentRecord = HasPaymentRecord(returnItem);
                if (!hasPaymentRecord) return null;
                
                return $"此商品已有沖款記錄（已沖款 {GetPaidAmount(returnItem):N0} 元），無法修改退貨數量";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnReturnQuantityInput((ReturnItem)item, valueString);
            })
        });

        // 單價欄位 (只讀顯示)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = L["Column.ReturnUnitPrice"],
            PropertyName = nameof(ReturnItem.OriginalUnitPrice),
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            Tooltip = "商品的原始銷售單價（唯讀）",
            IsReadOnly = true
        });

        // 折扣欄位 (只讀顯示)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = L["Column.OriginalDiscount"],
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "100px",
            Tooltip = "當初銷售時給予的折扣百分比（唯讀）",
            CustomTemplate = item => 
            {
                var returnItem = (ReturnItem)item;
                var discount = returnItem.SelectedDeliveryDetail?.DiscountPercentage ?? 0;
                
                return @<div class="d-flex align-items-center justify-content-end">
                    <span>@(discount % 1 == 0 ? discount.ToString("F0") : discount.ToString())</span>
                </div>;
            }
        });

        // 稅率欄位
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = L["Field.TaxRate"],
            PropertyName = nameof(ReturnItem.TaxRate),
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            Tooltip = "退貨的稅率百分比（免稅時無法編輯）",
            IsDisabledFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                return IsTaxCalculationMethodNoTax || HasPaymentRecord(returnItem);
            },
            TooltipFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                if (IsTaxCalculationMethodNoTax)
                    return "當前稅別為免稅，無法編輯稅率";
                var hasPaymentRecord = HasPaymentRecord(returnItem);
                if (!hasPaymentRecord) return null;
                
                return $"此商品已有沖款記錄（已沖款 {GetPaidAmount(returnItem):N0} 元），無法修改稅率";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnTaxRateInput((ReturnItem)item, valueString);
            })
        });

        // 小計欄位 (只讀顯示)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = L["Column.Subtotal"],
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            Tooltip = GetSubtotalTooltip(),
            CustomTemplate = item => 
            {
                var returnItem = (ReturnItem)item;
                var subtotal = CalculateItemSubtotal(returnItem);
                var displayValue = NumberFormatHelper.FormatSmartZeroAsEmpty(subtotal);
                
                return @<div class="text-end fw-bold text-success">
                    @displayValue
                </div>;
            }
        });

        // 備註欄位
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = L["Label.Remarks"],
            PropertyName = nameof(ReturnItem.Remarks),
            ColumnType = InteractiveColumnType.Input,
            Width = "150px",
            Tooltip = "選填。可記錄退貨相關的備註資訊（如退貨原因等）",
            IsDisabledFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                return returnItem.SelectedDeliveryDetail == null;
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnRemarksInput((ReturnItem)item, valueString);
            })
        });

        return columns;
    }

    private RenderFragment<ReturnItem> GetCustomActionsTemplate => item => __builder =>
    {
        // 檢查項目是否可以刪除（綜合退貨記錄和沖款記錄檢查）
        var canDelete = CanDeleteItem(item, out _);
        var isLastEmptyRow = tableComponent?.IsLastEmptyRow(item) ?? false;
        
        if (isLastEmptyRow)
        {
            // 最後一個空行：顯示禁用的刪除按鈕
            <GenericButtonComponent Variant="ButtonVariant.Red"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="true"
                                   Title="至少需要保留一個空行"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else if (canDelete)
        {
            // 可以刪除：顯示刪除按鈕
            <GenericButtonComponent Variant="ButtonVariant.Red"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="@IsReadOnly"
                                   Title="刪除"
                                   OnClick="async () => await HandleItemDelete(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else
        {
            // 不能刪除：顯示查看按鈕
            <GenericButtonComponent Variant="ButtonVariant.Blue"
                                   IconClass="bi bi-eye text-white"
                                   Size="ButtonSize.Large"
                                   Title="查看相關單據"
                                   OnClick="async () => await ShowRelatedDocuments(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
    };

    private async Task HandleItemDelete(ReturnItem item)
    {
        // 使用綜合檢查方法，確認是否可以刪除
        if (!CanDeleteItem(item, out string reason))
        {
            await NotificationService.ShowWarningAsync(
                reason, 
                "操作限制"
            );
            return;
        }
        
        var index = Items.IndexOf(item);
        await RemoveItemAsync(index);
    }

    /// <summary>
    /// 顯示相關單據（退貨單和沖款單）
    /// </summary>
    private async Task ShowRelatedDocuments(ReturnItem item)
    {
        // 檢查是否有現有的明細實體 ID
        if (item.ExistingDetailEntity is not SalesReturnDetail detail || detail.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("此項目尚未儲存，無法查看相關單據", "提示");
            return;
        }

        // 設定商品名稱
        selectedProductName = item.SelectedProduct?.Name ?? "未知商品";

        // 顯示 Modal 並開始載入
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            // 查詢相關單據
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsForSalesReturnDetailAsync(detail.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入相關單據失敗：{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// 處理點擊相關單據的事件
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // 觸發事件，讓父組件（EditModal）處理開啟相關單據
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            // 如果父組件沒有處理，顯示提示訊息
            await NotificationService.ShowInfoAsync(
                $"請在主畫面中開啟 {document.TypeDisplayName}: {document.DocumentNumber}", 
                "提示"
            );
        }
    }

    // ===== 內部方法 =====
    private async Task LoadAvailableProductsAsync()
    {
        try
        {
            AvailableProducts = Products?.ToList() ?? new List<Product>();
            
            // 同時載入出貨明細
            await LoadAvailableDeliveryDetailsAsync();
        }
        catch (Exception)
        {
            AvailableProducts = new List<Product>();
            AvailableDeliveryDetails = new List<SalesDeliveryDetail>();
        }
    }

    private async Task LoadAvailableDeliveryDetailsAsync()
    {
        try
        {
            if (EffectiveCustomerId.HasValue && EffectiveCustomerId.Value > 0)
            {
                // 載入該客戶的可退貨出貨單明細
                AvailableDeliveryDetails = await SalesDeliveryDetailService.GetReturnableDetailsByCustomerAsync(EffectiveCustomerId.Value);
            }
            else
            {
                AvailableDeliveryDetails = new List<SalesDeliveryDetail>();
            }
        }
        catch (Exception)
        {
            AvailableDeliveryDetails = new List<SalesDeliveryDetail>();
        }
    }

    /// <summary>
    /// 公開方法：刷新明細資料（供父組件呼叫，例如沖款單儲存後）
    /// 使用 base.RefreshDetailsAsync() 重新載入明細
    /// </summary>
    public async Task RefreshDetails()
    {
        await RefreshDetailsAsync();
    }

    private List<SalesDeliveryDetail> GetAvailableDeliveryDetails()
    {
        var filteredDetails = AvailableDeliveryDetails.AsQueryable();
        
        // 根據出貨單篩選
        if (EffectiveSalesDeliveryId.HasValue && EffectiveSalesDeliveryId.Value > 0)
        {
            filteredDetails = filteredDetails.Where(od => od.SalesDeliveryId == EffectiveSalesDeliveryId.Value);
        }
        
        // 根據商品篩選
        if (EffectiveFilterProductId.HasValue && EffectiveFilterProductId.Value > 0)
        {
            filteredDetails = filteredDetails.Where(od => od.ProductId == EffectiveFilterProductId.Value);
        }
        
        // 只顯示還有可退回數量的明細
        return filteredDetails.Where(od => GetAvailableReturnQuantity(od) > 0).ToList();
    }

    /// <summary>
    /// 建構篩選條件訊息，用於提示使用者目前的篩選狀態
    /// </summary>
    private string BuildFilterConditionsMessage()
    {
        var conditions = new List<string>();
        
        // 客戶條件（必填）
        if (EffectiveCustomerId.HasValue && EffectiveCustomerId.Value > 0)
        {
            // 從 AvailableDeliveryDetails 取得客戶名稱
            var customerName = AvailableDeliveryDetails.FirstOrDefault()?.SalesDelivery?.Customer?.CompanyName;
            conditions.Add($"• 客戶：{customerName ?? $"ID {EffectiveCustomerId.Value}"}");
        }
        
        // 銷貨單條件（選填）
        if (EffectiveSalesDeliveryId.HasValue && EffectiveSalesDeliveryId.Value > 0)
        {
            var deliveryCode = AvailableDeliveryDetails
                .FirstOrDefault(d => d.SalesDeliveryId == EffectiveSalesDeliveryId.Value)?
                .SalesDelivery?.Code;
            conditions.Add($"• 銷貨單：{deliveryCode ?? $"ID {EffectiveSalesDeliveryId.Value}"}");
        }
        
        // 商品條件（選填）
        if (EffectiveFilterProductId.HasValue && EffectiveFilterProductId.Value > 0)
        {
            var product = Products.FirstOrDefault(p => p.Id == EffectiveFilterProductId.Value);
            var productDisplay = product != null 
                ? $"{product.Code} {product.Name}".Trim() 
                : $"ID {EffectiveFilterProductId.Value}";
            conditions.Add($"• 商品：{productDisplay}");
        }
        
        // 預設條件說明
        conditions.Add("• 商品需有可退貨數量");
        
        return string.Join("\n", conditions);
    }

    // ===== 事件處理方法 =====
    
    // ===== 出貨明細選擇事件處理 =====
    
    /// <summary>
    /// 格式化出貨明細顯示文字（用於下拉選單 - 兩行顯示）
    /// 第一行：出貨單號 + 可退數量（小字藍色）
    /// 第二行：商品編號 商品名稱
    /// </summary>
    private string FormatDeliveryDetailDropdownText(SalesDeliveryDetail detail)
    {
        if (detail?.Product == null) return "";
        
        var product = detail.Product;
        var deliveryCode = detail.SalesDelivery?.Code ?? "N/A";
        var availableQty = GetAvailableReturnQuantity(detail);
        
        var productDisplay = !string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name)
            ? $"{product.Code} {product.Name}"
            : (!string.IsNullOrEmpty(product.Code) ? product.Code : product.Name ?? "");
        
        // 兩行顯示：出貨單號在上（小字藍色），商品資訊在下
        return $"<div style='line-height: 1.3;'>" +
               $"<small class='text-primary'>出貨: {deliveryCode} (可退: {availableQty:G29})</small><br/>" +
               $"<span>{productDisplay}</span></div>";
    }
    
    /// <summary>
    /// 格式化出貨明細顯示文字（用於輸入框顯示 - 單行簡潔格式）
    /// </summary>
    private string FormatDeliveryDetailDisplayText(SalesDeliveryDetail detail)
    {
        if (detail?.Product == null) return "";
        
        var product = detail.Product;
        var deliveryCode = detail.SalesDelivery?.Code ?? "N/A";
        
        var productDisplay = !string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name)
            ? $"{product.Code} {product.Name}"
            : (!string.IsNullOrEmpty(product.Code) ? product.Code : product.Name ?? "");
        
        // 輸入框顯示：簡潔的單行格式
        return $"{deliveryCode} | {productDisplay}";
    }

    // ===== 出貨明細選擇事件處理（SearchableSelect）=====

    /// <summary>
    /// 出貨明細搜尋輸入事件（只顯示有銷貨的商品）
    /// </summary>
    private Task OnDeliveryDetailSearch(ReturnItem item, string? searchValue)
    {
        item.DeliveryDetailSearchValue = searchValue ?? string.Empty;
        
        var availableDetails = GetAvailableDeliveryDetails();
        
        if (!string.IsNullOrWhiteSpace(searchValue))
        {
            var searchLower = searchValue.ToLower();
            
            // 搜尋：出貨單號、商品編號、商品名稱
            var filteredDetails = availableDetails.Where(detail =>
            {
                var deliveryCode = detail.SalesDelivery?.Code?.ToLower() ?? "";
                var productCode = detail.Product?.Code?.ToLower() ?? "";
                var productName = detail.Product?.Name?.ToLower() ?? "";
                
                return deliveryCode.Contains(searchLower) ||
                       productCode.Contains(searchLower) ||
                       productName.Contains(searchLower);
            }).Take(20).ToList();
            
            item.FilteredDeliveryDetails = filteredDetails.Cast<object>().ToList();
        }
        else
        {
            // 未輸入搜尋值，顯示前 20 筆
            item.FilteredDeliveryDetails = availableDetails.Take(20).Cast<object>().ToList();
        }
        
        item.ShowDropdown = true;
        item.SelectedIndex = -1;
        
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    /// <summary>
    /// 出貨明細輸入框獲得焦點
    /// </summary>
    private void OnDeliveryDetailFocus(ReturnItem item)
    {
        _ = OnDeliveryDetailSearch(item, item.DeliveryDetailSearchValue);
    }
    
    /// <summary>
    /// 出貨明細輸入框失去焦點
    /// </summary>
    private void OnDeliveryDetailBlur(ReturnItem item)
    {
        Task.Delay(200).ContinueWith(_ =>
        {
            item.ShowDropdown = false;
            InvokeAsync(StateHasChanged);
        });
    }
    
    /// <summary>
    /// 選擇出貨明細項目
    /// </summary>
    private async Task OnDeliveryDetailSelect(ReturnItem item, object? selectedItem)
    {
        if (selectedItem is SalesDeliveryDetail detail)
        {
            // 載入系統預設稅率
            var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();
            
            item.SelectedDeliveryDetail = detail;
            item.SelectedProduct = detail.Product;
            item.OriginalQuantity = (int)detail.DeliveryQuantity;
            item.AlreadyReturnedQuantity = GetAlreadyReturnedQuantity(detail.Id);
            item.ReturnQuantity = 0;
            item.OriginalUnitPrice = detail.UnitPrice;
            item.DiscountPercentage = detail.DiscountPercentage;
            item.TaxRate = detail.TaxRate ?? detail.Product?.TaxRate ?? defaultTaxRate;
            
            // 更新搜尋框顯示
            item.DeliveryDetailSearchValue = FormatDeliveryDetailDisplayText(detail);
        }
        else
        {
            item.SelectedDeliveryDetail = null;
            item.SelectedProduct = null;
            item.OriginalQuantity = 0;
            item.AlreadyReturnedQuantity = 0;
            item.ReturnQuantity = 0;
            item.OriginalUnitPrice = 0;
            item.DiscountPercentage = 0;
            item.TaxRate = null;
            item.DeliveryDetailSearchValue = string.Empty;
        }
        
        item.ShowDropdown = false;
        item.SelectedIndex = -1;
        
        await NotifyDetailsChanged();
    }

    private async Task OnReturnQuantityInput(ReturnItem returnItem, string? value)
    {
        // 檢查是否可以修改
        if (!CanDeleteItem(returnItem, out string reason))
        {
            await NotificationService.ShowWarningAsync(
                "此商品已有沖款記錄，無法修改退貨數量", 
                "操作限制"
            );
            return;
        }
        
        if (int.TryParse(value, out var quantity) && quantity >= 0)
        {
            var maxQuantity = returnItem.AvailableQuantity;
            returnItem.ReturnQuantity = Math.Min(quantity, maxQuantity);
            returnItem.ValidationError = quantity > maxQuantity ? $"最大可退數量：{maxQuantity}" : null;
        }
        else
        {
            returnItem.ReturnQuantity = 0;
            returnItem.ValidationError = null;
        }
        
        await NotifyDetailsChanged();
    }

    private async Task OnReturnReasonInput(ReturnItem returnItem, string? value)
    {
        returnItem.ReturnReason = InputEventHelper.HandleTextInput(value);
        await NotifyDetailsChanged();
    }

    private async Task OnRemarksInput(ReturnItem returnItem, string? value)
    {
        returnItem.Remarks = InputEventHelper.HandleTextInput(value);
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// 處理稅率輸入
    /// </summary>
    private async Task OnTaxRateInput(ReturnItem returnItem, string? valueString)
    {
        if (string.IsNullOrWhiteSpace(valueString))
        {
            returnItem.TaxRate = null;
        }
        else if (decimal.TryParse(valueString, out var taxRate))
        {
            returnItem.TaxRate = Math.Max(0, Math.Min(100, taxRate));
        }
        
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// 計算明細項目的小計（根據稅別，四捨五入到整數）
    /// </summary>
    private decimal CalculateItemSubtotal(ReturnItem item)
    {
        if (item.SelectedProduct == null || item.ReturnQuantity <= 0 || item.OriginalUnitPrice <= 0)
            return 0;
        
        var subtotal = CalculationHelper.CalculateSubtotal(
            item.ReturnQuantity,
            item.OriginalUnitPrice,
            item.DiscountPercentage,
            item.TaxRate ?? 0,
            TaxCalculationMethod
        );
        
        // 四捨五入到整數
        return CalculationHelper.Round(subtotal, 0);
    }

    /// <summary>
    /// 取得小計欄位的提示文字
    /// </summary>
    private string GetSubtotalTooltip()
    {
        return TaxCalculationMethod switch
        {
            TaxCalculationMethod.TaxExclusive => "退貨金額小計（含稅） = 數量 × 單價 × (1 - 折扣%) × (1 + 稅率%)",
            TaxCalculationMethod.TaxInclusive => "退貨金額小計（內含稅） = 數量 × 單價 × (1 - 折扣%)",
            TaxCalculationMethod.NoTax => "退貨金額小計（免稅） = 數量 × 單價 × (1 - 折扣%)",
            _ => "退貨金額小計"
        };
    }

    /// <summary>
    /// 顯示載入確認 Modal - 收集載入條件並顯示給使用者確認
    /// </summary>
    private async Task ShowLoadConfirmModal()
    {
        try
        {
            // 檢查是否已選擇客戶
            if (!EffectiveCustomerId.HasValue || EffectiveCustomerId.Value <= 0)
            {
                await NotificationService.ShowWarningAsync("請先選擇客戶");
                return;
            }
            
            // 建立載入條件清單
            _loadConditions = new List<string>();
            
            // 條件1：客戶
            var customerName = !string.IsNullOrWhiteSpace(SelectedCustomerName) 
                ? SelectedCustomerName 
                : $"客戶 ID: {EffectiveCustomerId.Value}";
            _loadConditions.Add($"客戶：{customerName}");
            
            // 條件2：出貨單（如有選擇）
            if (EffectiveSalesDeliveryId.HasValue && EffectiveSalesDeliveryId.Value > 0)
            {
                var deliveryCode = !string.IsNullOrWhiteSpace(SelectedSalesDeliveryCode)
                    ? SelectedSalesDeliveryCode
                    : $"出貨單 ID: {EffectiveSalesDeliveryId.Value}";
                _loadConditions.Add($"出貨單：{deliveryCode}");
            }
            else
            {
                _loadConditions.Add("出貨單：全部可退貨出貨單");
            }
            
            // 條件3：商品篩選（如有選擇）
            if (EffectiveFilterProductId.HasValue && EffectiveFilterProductId.Value > 0)
            {
                var productName = !string.IsNullOrWhiteSpace(FilterProductName)
                    ? FilterProductName
                    : $"商品 ID: {EffectiveFilterProductId.Value}";
                _loadConditions.Add($"商品篩選：{productName}");
            }
            
            // 計算符合條件的明細數量
            var availableDetails = GetAvailableDeliveryDetails();
            int matchingCount = availableDetails.Count;
            
            if (matchingCount == 0)
            {
                await NotificationService.ShowInfoAsync("目前沒有符合條件的可退貨明細");
                return;
            }
            
            _loadSummaryMessage = $"共 {matchingCount} 筆，是否確定載入？";
            
            // 顯示確認 Modal
            _showLoadConfirmModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"準備載入資料時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 執行載入所有可退貨商品 - 使用者確認後執行
    /// </summary>
    private async Task ExecuteLoadAllReturnableItems()
    {
        try
        {
            var availableDetails = GetAvailableDeliveryDetails();
            
            if (!availableDetails.Any())
            {
                await NotificationService.ShowWarningAsync("沒有可退貨的出貨明細", "提示");
                return;
            }
            
            // 清除現有項目但保留已有資料的項目
            var existingItems = Items.Where(item => item.SelectedProduct != null).ToList();
            Items.Clear();
            Items.AddRange(existingItems);
            
            // 載入系統預設稅率
            var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();
            
            // 新增所有可退貨的項目
            int addedCount = 0;
            foreach (var deliveryDetail in availableDetails)
            {
                // 檢查是否已經存在相同的明細
                if (Items.Any(item => item.SelectedDeliveryDetail?.Id == deliveryDetail.Id))
                    continue;
                
                // 取得稅率（優先順序：銷貨出貨明細稅率 > 商品稅率 > 系統預設稅率）
                var taxRate = deliveryDetail.TaxRate ?? deliveryDetail.Product?.TaxRate ?? defaultTaxRate;
                
                var newItem = new ReturnItem
                {
                    SelectedDeliveryDetail = deliveryDetail,
                    SelectedProduct = deliveryDetail.Product,
                    DeliveryDetailSearchValue = FormatDeliveryDetailDisplayText(deliveryDetail),
                    OriginalQuantity = (int)deliveryDetail.DeliveryQuantity,
                    AlreadyReturnedQuantity = GetAlreadyReturnedQuantity(deliveryDetail.Id),
                    ReturnQuantity = 0,
                    OriginalUnitPrice = deliveryDetail.UnitPrice,
                    DiscountPercentage = deliveryDetail.DiscountPercentage,
                    TaxRate = taxRate
                };
                
                Items.Add(newItem);
                addedCount++;
            }
            
            await NotifyDetailsChanged();
            await NotificationService.ShowSuccessAsync($"已載入 {addedCount} 筆可退貨商品");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入可退貨商品時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 載入所有可退貨商品的主要方法（公開方法，供父組件調用）
    /// </summary>
    public async Task LoadAllReturnableItems()
    {
        await ExecuteLoadAllReturnableItems();
    }

    private async Task RemoveItemAsync(int index)
    {
        if (index >= 0 && index < Items.Count)
        {
            var item = Items[index];
            
            // 通知父組件項目即將被移除
            if (OnItemRemoved.HasDelegate)
            {
                await OnItemRemoved.InvokeAsync(item);
            }
            
            // 如果是現有明細，記錄ID以便刪除
            if (item.ExistingDetailEntity?.Id > 0)
            {
                _deletedDetailIds.Add(item.ExistingDetailEntity.Id);
            }
            
            Items.RemoveAt(index);
            await NotifyDetailsChanged();
        }
    }

    private decimal GetTotalAmount()
    {
        return Items.Where(item => item.SelectedProduct != null)
                    .Sum(item => item.ReturnSubtotalAmount);
    }

    /// <summary>
    /// 通知明細變更，並處理此模組特有的額外通知（已刪除 ID、ReturnItems 清單）
    /// </summary>
    private async Task NotifyDetailsChanged()
    {
        // 通知已刪除的明細 ID
        if (OnDeletedDetailsChanged.HasDelegate && _deletedDetailIds.Any())
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds.ToList());
            _deletedDetailIds.Clear();
        }

        if (OnReturnItemsChanged.HasDelegate)
        {
            await OnReturnItemsChanged.InvokeAsync(Items);
        }

        // 委派給 base 執行標準的 OnDetailsChanged + _hasUndeletableDetails 更新
        await NotifyDetailsChangedAsync();
    }

    private SalesReturnDetail? ConvertToEntity(ReturnItem item)
    {
        // 只要選擇了商品就轉換，即使 ReturnQuantity 為 0（用於計算）
        if (item.SelectedDeliveryDetail == null || item.SelectedProduct == null)
        {
            return null;
        }
        
        // 如果已有實體，更新它
        if (item.ExistingDetailEntity != null)
        {
            item.ExistingDetailEntity.SalesDeliveryDetailId = item.SelectedDeliveryDetail.Id;
            item.ExistingDetailEntity.ProductId = item.SelectedProduct.Id;
            item.ExistingDetailEntity.ReturnQuantity = item.ReturnQuantity;
            item.ExistingDetailEntity.OriginalUnitPrice = item.OriginalUnitPrice;
            item.ExistingDetailEntity.DiscountPercentage = item.DiscountPercentage;
            item.ExistingDetailEntity.TaxRate = item.TaxRate;  //  寫入稅率
            item.ExistingDetailEntity.Remarks = item.Remarks;
            
            return item.ExistingDetailEntity;
        }
        
        // 創建新實體
        return new SalesReturnDetail
        {
            SalesDeliveryDetailId = item.SelectedDeliveryDetail.Id,
            ProductId = item.SelectedProduct.Id,
            ReturnQuantity = item.ReturnQuantity,
            OriginalUnitPrice = item.OriginalUnitPrice,
            DiscountPercentage = item.DiscountPercentage,
            TaxRate = item.TaxRate,  //  寫入稅率
            Remarks = item.Remarks
        };
    }

    // ===== 輔助方法 =====
    private int GetAlreadyReturnedQuantity(int deliveryDetailId)
    {
        // 這裡應該查詢資料庫獲取已退貨數量，目前暫時回傳0
        // 可能需要呼叫服務來獲取
        return 0;
    }
    
    private int GetAvailableReturnQuantity(SalesDeliveryDetail deliveryDetail)
    {
        var alreadyReturned = GetAlreadyReturnedQuantity(deliveryDetail.Id);
        return (int)(deliveryDetail.DeliveryQuantity - alreadyReturned);
    }

    /// <summary>
    /// 退貨量全填（只處理未鎖定的明細）
    /// </summary>
    private async Task FillAllQuantities()
    {
        var nonEmptyItems = Items.Where(item => item.SelectedProduct != null).ToList();

        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("沒有可更新的明細項目", "提示");
            return;
        }

        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();

        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "所有明細都已有沖款記錄，無法批次填入數量",
                "操作限制");
            return;
        }
        
        foreach (var item in unlocked)
        {
            if (item.SelectedDeliveryDetail != null)
            {
                item.ReturnQuantity = item.AvailableQuantity;
                item.ValidationError = null;
            }
        }
        
        var message = $"已填入 {unlocked.Count} 項明細的退貨數量";
        if (locked.Any())
        {
            message += $"\n（已跳過 {locked.Count} 項已鎖定的明細）";
        }
        await NotificationService.ShowSuccessAsync(message);
        
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// 退貨量清空（只處理未鎖定的明細）
    /// </summary>
    private async Task ClearAllQuantities()
    {
        var nonEmptyItems = Items.Where(item => item.SelectedProduct != null).ToList();

        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("沒有可更新的明細項目", "提示");
            return;
        }

        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();

        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "所有明細都已有沖款記錄，無法批次清空數量",
                "操作限制");
            return;
        }
        
        foreach (var item in unlocked)
        {
            item.ReturnQuantity = 0;
        }
        
        var message = $"已清空 {unlocked.Count} 項明細的退貨數量";
        if (locked.Any())
        {
            message += $"\n（已跳過 {locked.Count} 項已鎖定的明細）";
        }
        await NotificationService.ShowSuccessAsync(message);
        
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// 清除明細（只移除未鎖定的明細，保留已鎖定的）
    /// </summary>
    private async Task ClearAllDetails()
    {
        var nonEmptyItems = Items.Where(item => item.SelectedProduct != null).ToList();

        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("沒有可移除的明細項目", "提示");
            return;
        }

        // 區分可刪除和被鎖定的明細
        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
        
        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "所有明細都已有沖款記錄，無法移除", 
                "操作限制");
            return;
        }
        
        // 通知父組件項目即將被移除
        if (OnItemRemoved.HasDelegate)
        {
            foreach (var item in unlocked)
            {
                await OnItemRemoved.InvokeAsync(item);
            }
        }
        
        // 記錄所有要刪除的現有明細 ID
        foreach (var item in unlocked.Where(item => item.ExistingDetailEntity?.Id > 0))
        {
            _deletedDetailIds.Add(item.ExistingDetailEntity!.Id);
        }
        
        // 從列表中移除未鎖定的項目，保留已鎖定的項目
        foreach (var item in unlocked)
        {
            Items.Remove(item);
        }
        
        await NotifyDetailsChanged();
        
        var message = $"已移除 {unlocked.Count} 項明細";
        if (locked.Any())
        {
            message += $"\n（已保留 {locked.Count} 項已鎖定的明細）";
        }
        await NotificationService.ShowSuccessAsync(message);
    }

    // ===== 公開方法 - 供父組件調用 =====
    public async Task<bool> ValidateAsync()
    {
        try
        {
            var errors = new List<string>();
            
            // 檢查是否有退貨項目
            var potentialItems = Items.Where(item => item.SelectedProduct != null && item.ReturnQuantity > 0).ToList();
            if (!potentialItems.Any())
            {
                errors.Add("至少需要一個退貨項目");
            }
            
            // 檢查必填欄位和基本驗證
            foreach (var item in potentialItems)
            {
                if (item.SelectedDeliveryDetail == null)
                {
                    errors.Add("請選擇有效的出貨明細");
                    continue;
                }
                
                if (item.ReturnQuantity > item.AvailableQuantity)
                {
                    errors.Add($"商品 {item.SelectedProduct?.Code} 的退貨數量超過可退數量");
                }
                
                if (item.OriginalUnitPrice < 0)
                {
                    errors.Add($"商品 {item.SelectedProduct?.Code} 的原始單價不可為負數");
                }
            }
            
            if (errors.Any())
            {
                var errorMessage = string.Join("\n", errors);
                await NotificationService.ShowErrorAsync(errorMessage);
                return false;
            }
            
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"驗證時發生錯誤：{ex.Message}");
            return false;
        }
    }
    
    // ===== ReturnItem 內部類別 =====
    public class ReturnItem
    {
        public Product? SelectedProduct { get; set; }
        public SalesDeliveryDetail? SelectedDeliveryDetail { get; set; }
        
        // === SearchableSelect 支援屬性（出貨明細搜尋）===
        public string DeliveryDetailSearchValue { get; set; } = string.Empty;
        public List<object> FilteredDeliveryDetails { get; set; } = new();
        public bool ShowDropdown { get; set; } = false;
        public int SelectedIndex { get; set; } = -1;
        
        public int OriginalQuantity { get; set; } = 0;
        public int AlreadyReturnedQuantity { get; set; } = 0;
        public int ReturnQuantity { get; set; } = 0;
        
        public decimal OriginalUnitPrice { get; set; } = 0;
        public decimal DiscountPercentage { get; set; } = 0;
        public decimal? TaxRate { get; set; }  //  新增稅率屬性
        
        public string ReturnReason { get; set; } = string.Empty;
        public string Remarks { get; set; } = string.Empty;
        
        public SalesReturnDetail? ExistingDetailEntity { get; set; }
        public string? ValidationError { get; set; }
        
        // 計算屬性
        public decimal ReturnSubtotalAmount => Math.Round(ReturnQuantity * OriginalUnitPrice * (1 - DiscountPercentage / 100), 2);
        public int AvailableQuantity => OriginalQuantity - AlreadyReturnedQuantity;
        
        /// <summary>
        /// 取得顯示用的商品名稱（包含出貨單號）
        /// </summary>
        public string DisplayName => 
            SelectedProduct != null 
                ? $"[{SelectedDeliveryDetail?.SalesDelivery?.Code ?? "N/A"}] {SelectedProduct.Code} - {SelectedProduct.Name}"
                : string.Empty;
    }
}

