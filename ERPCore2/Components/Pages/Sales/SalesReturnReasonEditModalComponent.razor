@* 銷貨退貨原因編輯組件 *@
@inject ISalesReturnReasonService SalesReturnReasonService
@inject INotificationService NotificationService
@inject IStringLocalizer<SharedResource> L

<GenericEditModalComponent TEntity="SalesReturnReason" 
                          TService="ISalesReturnReasonService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@SalesReturnReasonId"
                          Service="@SalesReturnReasonService"
                          EntityName="@L["Entity.SalesReturnReason"]"
                          EntityNamePlural="@L["Entity.SalesReturnReason"]"
                          ModalTitle="@(SalesReturnReasonId.HasValue ? L["Message.EditTitle", L["Entity.SalesReturnReason"]].ToString() : L["Message.CreateTitle", L["Entity.SalesReturnReason"]].ToString())"
                          Size="GenericEditModalComponent<SalesReturnReason, ISalesReturnReasonService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          DataLoader="@LoadSalesReturnReasonData"
                          UseGenericSave="true"
                          SaveSuccessMessage="@(SalesReturnReasonId.HasValue ? L["Message.UpdateSuccess", L["Entity.SalesReturnReason"]].ToString() : L["Message.CreateSuccess", L["Entity.SalesReturnReason"]].ToString())"
                          SaveFailureMessage="@L["Message.SaveFailure", L["Entity.SalesReturnReason"]]"
                          RequiredPermission="SalesReturnReason.Read"
                          OnEntitySaved="@OnSalesReturnReasonSaved"
                          OnCancel="@OnCancel"
                          OnEntityLoaded="@HandleEntityLoaded" />

@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SalesReturnReasonId { get; set; }
    [Parameter] public EventCallback<SalesReturnReason> OnSalesReturnReasonSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public Dictionary<string, object?>? PrefilledValues { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<SalesReturnReason, ISalesReturnReasonService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();

    // ===== 必要方法 =====
    
    /// <summary>
    /// 處理實體載入完成事件（由 GenericEditModalComponent 的導航觸發）
    /// 當上下筆切換時觸發 UI 更新，確保表單欄位正確渲染
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            // 對於沒有明細的純主檔組件，只需要觸發 UI 更新即可
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入資料時發生錯誤：{ex.Message}");
        }
    }

    private async Task<SalesReturnReason?> LoadSalesReturnReasonData()
    {
        try
        {
            if (!SalesReturnReasonId.HasValue)
            {
                // 新增模式 - 返回預設值
                var newReason = new SalesReturnReason
                {
                    Name = string.Empty,
                    Code = await EntityCodeGenerationHelper.GenerateForEntity<SalesReturnReason, ISalesReturnReasonService>(SalesReturnReasonService, "RR"),
                    Status = EntityStatus.Active
                };
                
                // 應用預填值
                PrefilledValueHelper.ApplyPrefilledValues(newReason, PrefilledValues);
                
                return newReason;
            }
            else
            {
                // 編輯模式 - 載入現有資料
                return await SalesReturnReasonService.GetByIdAsync(SalesReturnReasonId.Value);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSalesReturnReasonData), GetType(), additionalData: "載入退貨原因資料失敗");
            await NotificationService.ShowErrorAsync("載入退貨原因資料失敗");
            return null;
        }
    }


    protected override void OnParametersSet()
    {
        if (IsVisible)
        {
            InitializeFormFields();
        }
    }

    private void InitializeFormFields()
    {
        formFields = new List<FormFieldDefinition>
        {
            new()
            {
                PropertyName = nameof(SalesReturnReason.Code),
                Label = L["Field.ReasonCode"],
                FieldType = FormFieldType.Text,
                Placeholder = L["Placeholder.AutoGenerated"],
                IsRequired = true,
                IsReadOnly = true,
                MaxLength = 20,
                HelpText = "退貨原因的唯一識別編號，系統自動生成"
            },
            new()
            {
                PropertyName = nameof(SalesReturnReason.Name),
                Label = L["Field.ReasonName"],
                FieldType = FormFieldType.Text,
                Placeholder = L["Placeholder.PleaseInput", L["Field.ReasonName"]],
                IsRequired = true,
                MaxLength = 50,
                HelpText = "退貨原因的顯示名稱"
            },
            FormFieldConfigurationHelper.CreateRemarksField<SalesReturnReason>(),
        };

        formSections = FormSectionHelper<SalesReturnReason>.Create()
            .AddToSection(FormSectionNames.BasicInfo,
                srr => srr.Code,
                srr => srr.Name)
            .AddToSection(FormSectionNames.AdditionalData,
                srr => srr.Remarks)
            .Build();
    }
}
