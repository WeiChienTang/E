@inject ISalesDeliveryService SalesDeliveryService
@inject ISalesDeliveryDetailService SalesDeliveryDetailService
@inject ISalesOrderService SalesOrderService
@inject ISalesOrderDetailService SalesOrderDetailService
@inject ICustomerService CustomerService
@inject IProductService ProductService
@inject IEmployeeService EmployeeService
@inject IUnitService UnitService
@inject IWarehouseService WarehouseService
@inject IWarehouseLocationService WarehouseLocationService
@inject ISystemParameterService SystemParameterService
@inject INotificationService NotificationService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ActionButtonHelper ActionButtonHelper
@inject ERPCore2.Data.Context.AppDbContext DbContext

<GenericEditModalComponent TEntity="SalesDelivery" 
                          TService="ISalesDeliveryService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@SalesDeliveryId"
                          Service="@SalesDeliveryService"
                          EntityName="å‡ºè²¨å–®"
                          EntityNamePlural="å‡ºè²¨å–®"
                          ModalTitle="@(SalesDeliveryId.HasValue ? "ç·¨è¼¯å‡ºè²¨å–®" : "æ–°å¢å‡ºè²¨å–®")"
                          Size="GenericEditModalComponent<SalesDelivery, ISalesDeliveryService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          AutoCompleteCollections="@(autoCompleteConfig?.Collections)"
                          AutoCompleteDisplayProperties="@(autoCompleteConfig?.DisplayProperties)"
                          AutoCompleteValueProperties="@(autoCompleteConfig?.ValueProperties)"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadSalesDeliveryData"
                          AdditionalDataLoader="@LoadAdditionalDataAsync"
                          UseGenericSave="true"
                          CustomValidator="@ValidateSalesDeliveryDetailsAsync"
                          AfterSave="@SaveSalesDeliveryDetailsAsync"
                          SaveSuccessMessage="@(SalesDeliveryId.HasValue ? "å‡ºè²¨å–®æ›´æ–°æˆåŠŸ" : "å‡ºè²¨å–®æ–°å¢æˆåŠŸ")"
                          SaveFailureMessage="å‡ºè²¨å–®å„²å­˜å¤±æ•—"
                          RequiredPermission="SalesDelivery.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          CustomModules="@GetCustomModules()"
                          OnEntityLoaded="@HandleEntityLoaded">
</GenericEditModalComponent>

@* å®¢æˆ¶ç·¨è¼¯ Modal *@
<CustomerEditModalComponent @ref="customerEditModal"
                           IsVisible="@customerModalManager.IsModalVisible"
                           IsVisibleChanged="@customerModalManager.HandleModalVisibilityChangedAsync"
                           CustomerId="@customerModalManager.SelectedEntityId"
                           OnCustomerSaved="@OnCustomerSavedWrapper"
                           OnCancel="@customerModalManager.HandleModalCancelAsync" />

@* æ¥­å‹™å“¡ç·¨è¼¯ Modal *@
<EmployeeEditModalComponent @ref="employeeEditModal"
                           IsVisible="@employeeModalManager.IsModalVisible"
                           IsVisibleChanged="@employeeModalManager.HandleModalVisibilityChangedAsync"
                           EmployeeId="@employeeModalManager.SelectedEntityId"
                           OnEmployeeSaved="@OnEmployeeSavedWrapper"
                           OnCancel="@employeeModalManager.HandleModalCancelAsync" />

@code {
    // ===== å¿…è¦åƒæ•¸ =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SalesDeliveryId { get; set; }
    [Parameter] public EventCallback<SalesDelivery> OnSalesDeliverySaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    
    // ===== é å¡«åƒæ•¸ï¼ˆç”¨æ–¼å¾éŠ·å”®è¨‚å–®è½‰å–®ï¼‰ =====
    [Parameter] public int? PrefilledCustomerId { get; set; }
    [Parameter] public int? PrefilledSalesOrderId { get; set; }

    // ===== å…§éƒ¨ç‹€æ…‹ =====
    private GenericEditModalComponent<SalesDelivery, ISalesDeliveryService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // åŸå§‹è³‡æ–™é›†åˆï¼ˆç”¨æ–¼ AutoCompleteï¼‰
    private List<Customer> availableCustomers = new();
    private List<Employee> availableEmployees = new();
    private List<Product> availableProducts = new();
    private List<Unit> availableUnits = new();
    private List<Warehouse> availableWarehouses = new();
    private List<SalesOrder> availableSalesOrders = new();
    
    // AutoComplete é…ç½®
    private AutoCompleteConfig? autoCompleteConfig;
    
    // éŠ·è²¨å‡ºè²¨æ˜ç´°
    private List<SalesDeliveryDetail> salesDeliveryDetails = new();
    
    // æ˜ç´°ç®¡ç†çµ„ä»¶å¼•ç”¨
    private SalesDeliveryTable<SalesDelivery, SalesDeliveryDetail>? salesDeliveryDetailManager;
    
    // ===== æ˜ç´°è¼‰å…¥ç‹€æ…‹ =====
    private bool shouldAutoLoadUndelivered = false;  // æ¨™è¨˜æ˜¯å¦éœ€è¦è‡ªå‹•è¼‰å…¥æœªå‡ºè²¨å•†å“
    
    // Modal Manager é›†åˆ
    private ModalManagerCollection? modalManagers;
    
    // Modal ç®¡ç†å™¨
    private CustomerEditModalComponent? customerEditModal;
    private RelatedEntityModalManager<Customer> customerModalManager = default!;
    private EmployeeEditModalComponent? employeeEditModal;
    private RelatedEntityModalManager<Employee> employeeModalManager = default!;
    
    // ä¸‹æ‹‰é¸å–®é¸é …ï¼ˆå‘ä¸‹ç›¸å®¹ï¼‰
    private List<Customer> customers = new();
    private List<Employee> employees = new();
    private List<Warehouse> warehouses = new();
    private List<WarehouseLocation> warehouseLocations = new();
    private List<SalesOrder> salesOrders = new();
    private List<SelectOption> customerOptions = new();
    private List<SelectOption> employeeOptions = new();
    private List<SelectOption> warehouseOptions = new();
    private List<SelectOption> salesOrderOptions = new();
    
    // ç¨…ç‡å¿«å–è®Šæ•¸
    private decimal currentTaxRate = 5.0m;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // ä½¿ç”¨ ModalManagerInitHelper åˆå§‹åŒ–æ‰€æœ‰ Manager
            modalManagers = ModalManagerInitHelper.CreateBuilder<SalesDelivery, ISalesDeliveryService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Customer>(nameof(SalesDelivery.CustomerId), "å®¢æˆ¶")
                .AddManager<Employee>(nameof(SalesDelivery.EmployeeId), "æ¥­å‹™å“¡")
                .Build();
            
            // å–å¾—å€‹åˆ¥ Manager ä¾›çµ„ä»¶ä½¿ç”¨
            customerModalManager = modalManagers.Get<Customer>(nameof(SalesDelivery.CustomerId));
            employeeModalManager = modalManagers.Get<Employee>(nameof(SalesDelivery.EmployeeId));
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–å‡ºè²¨å–®ç·¨è¼¯çµ„ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible)
        {
            // æ‰“é–‹æ™‚,å¦‚æœæ˜¯æ–°å¢æ¨¡å¼,é‡ç½®ç‹€æ…‹
            if (!SalesDeliveryId.HasValue)
            {
                shouldAutoLoadUndelivered = false;
            }
            
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
        }
    }

    private async Task HandleSaveSuccess()
    {
        try
        {
            // é‡æ–°è¼‰å…¥å‰›å„²å­˜çš„æ˜ç´°è³‡æ–™
            if (editModalComponent?.Entity != null && editModalComponent.Entity.Id > 0)
            {
                await LoadSalesDeliveryDetailsInternal(editModalComponent.Entity.Id);
                
                // åˆ·æ–° Table å…ƒä»¶
                if (salesDeliveryDetailManager != null)
                {
                    await salesDeliveryDetailManager.RefreshDetailsAsync();
                }
                
                StateHasChanged();
            }
            
            if (OnSalesDeliverySaved.HasDelegate && editModalComponent?.Entity != null)
            {
                await OnSalesDeliverySaved.InvokeAsync(editModalComponent.Entity);
            }
            // CloseModal å·²ç”± GenericEditModalComponent çµ±ä¸€æ§åˆ¶
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSaveSuccess), GetType(), 
                additionalData: "è™•ç†å‡ºè²¨å–®å„²å­˜æˆåŠŸäº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    private async Task HandleCancel()
    {
        try
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCancel), GetType(), 
                additionalData: "å‡ºè²¨å–®ç·¨è¼¯Modalå–æ¶ˆè™•ç†å¤±æ•—");
        }
    }

    private async Task CloseModal()
    {
        try
        {
            if (IsVisibleChanged.HasDelegate)
            {
                await IsVisibleChanged.InvokeAsync(false);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(CloseModal), GetType(), 
                additionalData: "å‡ºè²¨å–®ç·¨è¼¯Modalé—œé–‰å¤±æ•—");
        }
    }

    /// <summary>
    /// é–‹å•Ÿæ–°å¢å‡ºè²¨å–® Modal ä¸¦é å¡«éŠ·å”®è¨‚å–®è³‡è¨Šï¼ˆå…¬é–‹æ–¹æ³•ä¾›å¤–éƒ¨èª¿ç”¨ï¼‰
    /// </summary>
    public async Task ShowAddModalWithPrefilledOrder(int customerId, int salesOrderId)
    {
        try
        {
            // ä½¿ç”¨ DocumentConversionHelper çµ±ä¸€è™•ç†è½‰å–®é‚è¼¯ï¼ˆåƒç…§æ¡è³¼æ¨¡çµ„ï¼‰
            var success = await DocumentConversionHelper.ShowConversionModalAsync(
                setPrefilledValues: () =>
                {
                    SalesDeliveryId = null;
                    PrefilledCustomerId = customerId;
                    PrefilledSalesOrderId = salesOrderId;
                    shouldAutoLoadUndelivered = true;  // ğŸ”‘ æ¨™è¨˜éœ€è¦è‡ªå‹•è¼‰å…¥
                },
                isVisibleChanged: IsVisibleChanged,
                autoLoadAction: async () =>
                {
                    shouldAutoLoadUndelivered = false;
                    if (salesDeliveryDetailManager != null)
                    {
                        await salesDeliveryDetailManager.LoadAllUndeliveredItems();
                    }
                },
                detailManagerReady: () => salesDeliveryDetailManager != null,
                shouldAutoLoad: () => shouldAutoLoadUndelivered,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("è½‰å–®æµç¨‹åŸ·è¡Œå¤±æ•—");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledOrder), GetType(), 
                additionalData: $"é–‹å•Ÿé å¡«å‡ºè²¨å–®Modalå¤±æ•— - CustomerId: {customerId}, SalesOrderId: {salesOrderId}");
            await NotificationService.ShowErrorAsync("é–‹å•Ÿå‡ºè²¨å–®æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    private async Task<SalesDelivery?> LoadSalesDeliveryData()
    {
        try
        {
            if (!SalesDeliveryId.HasValue)
            {
                // æ–°å¢æ¨¡å¼ - è‡ªå‹•ç”¢ç”Ÿå‡ºè²¨å–®è™Ÿ
                var generatedCode = await EntityCodeGenerationHelper.GenerateForEntity<SalesDelivery, ISalesDeliveryService>(SalesDeliveryService, DbContext);
                
                var newDelivery = new SalesDelivery
                {
                    DeliveryDate = DateTime.Today,
                    Status = EntityStatus.Active,
                    TotalAmount = 0,
                    Code = generatedCode,
                    IsShipped = false,
                    IsApproved = false
                };
                
                // ğŸ”‘ ä¿®æ­£ï¼šä¸åœ¨é€™è£¡è¼‰å…¥æ˜ç´°ï¼Œæ”¹ç‚ºè¨­å®šé å¡«å€¼å¾Œç”± DocumentConversionHelper è§¸ç™¼è‡ªå‹•è¼‰å…¥
                // é€™æ¨£å¯ä»¥ç¢ºä¿ SalesDeliveryTable çµ„ä»¶å·²ç¶“æ¸²æŸ“å®Œæˆ
                if (PrefilledSalesOrderId.HasValue)
                {
                    newDelivery.SalesOrderId = PrefilledSalesOrderId.Value;
                    // è¼‰å…¥è¨‚å–®åŸºæœ¬è³‡æ–™ï¼ˆå®¢æˆ¶ã€æ¥­å‹™å“¡ç­‰ï¼‰
                    var salesOrder = await SalesOrderService.GetWithDetailsAsync(PrefilledSalesOrderId.Value);
                    if (salesOrder != null)
                    {
                        newDelivery.CustomerId = salesOrder.CustomerId;
                        newDelivery.EmployeeId = salesOrder.EmployeeId;
                    }
                    // æ˜ç´°è¼‰å…¥æœƒåœ¨ OnAfterRenderAsync ä¸­ç”± DocumentConversionHelper è‡ªå‹•è§¸ç™¼
                }
                else if (PrefilledCustomerId.HasValue)
                {
                    newDelivery.CustomerId = PrefilledCustomerId.Value;
                }
                
                if (!PrefilledSalesOrderId.HasValue)
                {
                    salesDeliveryDetails.Clear();
                }
                
                return newDelivery;
            }

            // ç·¨è¼¯æ¨¡å¼ - è¼‰å…¥éŠ·è²¨å‡ºè²¨å–®å’Œæ˜ç´°
            var salesDelivery = await SalesDeliveryService.GetByIdAsync(SalesDeliveryId.Value);
            
            if (salesDelivery != null)
            {
                // è¼‰å…¥éŠ·è²¨å‡ºè²¨æ˜ç´°
                await LoadSalesDeliveryDetailsInternal(SalesDeliveryId.Value);
                StateHasChanged();
                
                // é‡æ–°åˆå§‹åŒ–è¡¨å–®æ¬„ä½
                await Task.Delay(10);
                _ = Task.Run(async () =>
                {
                    await InvokeAsync(async () =>
                    {
                        await InitializeFormFieldsAsync();
                        StateHasChanged();
                    });
                });
                
                StateHasChanged();
            }
            else
            {
            }
            
            return salesDelivery;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSalesDeliveryData), GetType(), 
                additionalData: $"è¼‰å…¥å‡ºè²¨å–®è³‡æ–™å¤±æ•— - ID: {SalesDeliveryId}");
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å‡ºè²¨å–®è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return null;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // è¼‰å…¥å®¢æˆ¶é¸é …
            customers = await CustomerService.GetAllAsync();
            availableCustomers = customers;
            customerOptions = customers.Where(c => c.Status == EntityStatus.Active)
                .Select(c => new SelectOption
                {
                    Text = c.CompanyName ?? "",
                    Value = c.Id.ToString()
                }).ToList();

            // è¼‰å…¥å“¡å·¥é¸é …
            employees = await EmployeeService.GetAllAsync();
            availableEmployees = employees;
            employeeOptions = employees.Where(e => e.Status == EntityStatus.Active)
                .Select(e => new SelectOption
                {
                    Text = e.Name ?? string.Empty,
                    Value = e.Id.ToString()
                }).ToList();

            // è¼‰å…¥å€‰åº«é¸é …
            warehouses = await WarehouseService.GetAllAsync();
            availableWarehouses = warehouses;
            warehouseOptions = warehouses.Where(w => w.Status == EntityStatus.Active)
                .Select(w => new SelectOption
                {
                    Text = w.Name,
                    Value = w.Id.ToString()
                }).ToList();

            // è¼‰å…¥å€‰åº«ä½ç½®é¸é …
            warehouseLocations = await WarehouseLocationService.GetAllAsync();

            // è¼‰å…¥éŠ·å”®è¨‚å–®
            salesOrders = await SalesOrderService.GetAllAsync();
            availableSalesOrders = salesOrders;
            salesOrderOptions = salesOrders.Where(so => so.Status == EntityStatus.Active)
                .Select(so => new SelectOption
                {
                    Text = so.Code ?? string.Empty,
                    Value = so.Id.ToString()
                }).ToList();

            // è¼‰å…¥å•†å“è³‡æ–™
            availableProducts = await ProductService.GetAllAsync();

            // è¼‰å…¥å–®ä½è³‡æ–™
            availableUnits = await UnitService.GetAllAsync();
            
            // è¼‰å…¥ç³»çµ±ç¨…ç‡
            currentTaxRate = await TaxCalculationHelper.LoadTaxRateAsync(SystemParameterService);
            
            // é…ç½® AutoComplete
            autoCompleteConfig = new AutoCompleteConfigBuilder<SalesDelivery>()
                .AddField(nameof(SalesDelivery.CustomerId), "CompanyName", availableCustomers)
                .AddField(nameof(SalesDelivery.EmployeeId), "Name", availableEmployees)
                .AddField(nameof(SalesDelivery.WarehouseId), "Name", availableWarehouses)
                .AddField(nameof(SalesDelivery.SalesOrderId), "Code", availableSalesOrders)
                .Build();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadAdditionalDataAsync), GetType(), 
                additionalData: "å‡ºè²¨å–®ç·¨è¼¯Modalè¼‰å…¥é¡å¤–è³‡æ–™å¤±æ•—");
            
            customerOptions = new List<SelectOption>();
            employeeOptions = new List<SelectOption>();
            warehouseOptions = new List<SelectOption>();
            salesOrderOptions = new List<SelectOption>();
            availableProducts = new List<Product>();
            availableUnits = new List<Unit>();
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SalesDelivery.Code),
                    Label = "å‡ºè²¨å–®è™Ÿ",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥å‡ºè²¨å–®è™Ÿ",
                    IsRequired = true,
                    MaxLength = 30,
                    HelpText = "å‡ºè²¨å–®çš„å”¯ä¸€ç·¨è™Ÿï¼Œæ–°å¢æ™‚ç³»çµ±æœƒè‡ªå‹•ç”¢ç”Ÿï¼Œä¹Ÿå¯æ‰‹å‹•ä¿®æ”¹"
                },
                new()
                {
                    PropertyName = nameof(SalesDelivery.CustomerId),
                    Label = "å®¢æˆ¶",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡å®¢æˆ¶",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "è¼¸å…¥å®¢æˆ¶åç¨±é€²è¡Œæœå°‹ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                    ActionButtons = await GetCustomerActionButtonsAsync()
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesDelivery.SalesOrderId),
                    Label = "éŠ·å”®è¨‚å–®",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹é¸æ“‡éŠ·å”®è¨‚å–®",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "é¸æ“‡é—œè¯çš„éŠ·å”®è¨‚å–®ï¼ˆå¯é¸ï¼‰"
                },
                new()
                {
                    PropertyName = nameof(SalesDelivery.EmployeeId),
                    Label = "æ¥­å‹™å“¡",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹é¸æ“‡æ¥­å‹™å“¡",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "é¸æ“‡è² è²¬æ­¤å‡ºè²¨çš„æ¥­å‹™å“¡",
                    ActionButtons = await GetEmployeeActionButtonsAsync()
                },
                new()
                {
                    PropertyName = nameof(SalesDelivery.DeliveryDate),
                    Label = "å‡ºè²¨æ—¥æœŸ",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "å‡ºè²¨æ—¥æœŸ"
                },
                new()
                {
                    PropertyName = nameof(SalesDelivery.TotalAmount),
                    Label = "å‡ºè²¨ç¸½é‡‘é¡",
                    FieldType = FormFieldType.Number,
                    Placeholder = "0.00",
                    IsRequired = true,
                    IsReadOnly = true,
                    HelpText = "ç³»çµ±è‡ªå‹•è¨ˆç®—ï¼Œç”±æ˜ç´°é‡‘é¡ç¸½å’Œå¾—å‡º"
                },
                    FormFieldConfigurationHelper.CreateRemarksField<SalesDelivery>()
            };


            formSections = FormSectionHelper<SalesDelivery>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    sd => sd.Code,
                    sd => sd.CustomerId,
                    sd => sd.SalesOrderId,
                    sd => sd.EmployeeId,
                    sd => sd.DeliveryDate)
                .AddToSection(FormSectionNames.AmountInfo,
                    sd => sd.TotalAmount)
                .AddToSection(FormSectionNames.OtherInfo,
                    sd => sd.DeliveryAddress,
                    sd => sd.Remarks)
                .Build();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(InitializeFormFieldsAsync), GetType());
        }
    }

    // ===== è‡ªå‹•ç”¢ç”Ÿå–®è™Ÿ =====
    // ===== å¾éŠ·å”®è¨‚å–®è¼‰å…¥è³‡æ–™ =====
    private async Task LoadDataFromSalesOrder(SalesDelivery delivery, int salesOrderId)
    {
        try
        {
            var salesOrder = await SalesOrderService.GetWithDetailsAsync(salesOrderId);
            if (salesOrder == null) return;

            delivery.SalesOrderId = salesOrderId;
            delivery.CustomerId = salesOrder.CustomerId;
            delivery.EmployeeId = salesOrder.EmployeeId;

            var orderDetails = await SalesOrderDetailService.GetBySalesOrderIdAsync(salesOrderId);
            salesDeliveryDetails.Clear();

            foreach (var orderDetail in orderDetails)
            {
                var remainingQty = orderDetail.OrderQuantity - orderDetail.DeliveredQuantity;
                if (remainingQty > 0)
                {
                    salesDeliveryDetails.Add(new SalesDeliveryDetail
                    {
                        SalesOrderDetailId = orderDetail.Id,
                        ProductId = orderDetail.ProductId,
                        DeliveryQuantity = remainingQty,
                        UnitPrice = orderDetail.UnitPrice,
                        UnitId = orderDetail.UnitId
                    });
                }
            }

            await NotificationService.ShowSuccessAsync($"å·²å¾è¨‚å–® {salesOrder.Code} è¼‰å…¥è³‡æ–™");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDataFromSalesOrder), GetType());
            await NotificationService.ShowErrorAsync("è¼‰å…¥è¨‚å–®è³‡æ–™å¤±æ•—");
        }
    }

    
    // ===== è¼‰å…¥æ˜ç´° =====
    
    /// <summary>
    /// è™•ç†å¯¦é«”è¼‰å…¥å®Œæˆäº‹ä»¶ï¼ˆç”± GenericEditModalComponent çš„å°èˆªè§¸ç™¼ï¼‰
    /// ç•¶ä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼Œé‡æ–°è¼‰å…¥å°æ‡‰çš„æ˜ç´°è³‡æ–™
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            // é‡æ–°è¼‰å…¥æ˜ç´°è³‡æ–™
            await LoadSalesDeliveryDetailsInternal(loadedEntityId);
            
            // è§¸ç™¼ Table å…ƒä»¶åˆ·æ–°
            if (salesDeliveryDetailManager != null)
            {
                await salesDeliveryDetailManager.RefreshDetailsAsync();
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleEntityLoaded), GetType(), 
                additionalData: $"è™•ç†å¯¦é«”è¼‰å…¥äº‹ä»¶å¤±æ•— - EntityId: {loadedEntityId}");
            await NotificationService.ShowErrorAsync("è¼‰å…¥æ˜ç´°è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    private async Task LoadSalesDeliveryDetailsInternal(int salesDeliveryId)
    {
        try
        {
            salesDeliveryDetails = await SalesDeliveryDetailService.GetByDeliveryIdAsync(salesDeliveryId);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSalesDeliveryDetailsInternal), GetType());
            salesDeliveryDetails = new List<SalesDeliveryDetail>();
        }
    }

    private async Task<List<FieldActionButton>> GetCustomerActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent,
            customerModalManager,
            nameof(SalesDelivery.CustomerId));
    }

    private async Task<List<FieldActionButton>> GetEmployeeActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent,
            employeeModalManager,
            nameof(SalesDelivery.EmployeeId));
    }

    private async Task OnCustomerSavedWrapper(Customer customer)
    {
        await customerModalManager.HandleEntitySavedAsync(customer, shouldAutoSelect: true);
    }

    private async Task OnEmployeeSavedWrapper(Employee employee)
    {
        await employeeModalManager.HandleEntitySavedAsync(employee, shouldAutoSelect: true);
    }

    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(SalesDelivery.CustomerId), customerModalManager },
            { nameof(SalesDelivery.EmployeeId), employeeModalManager }
        };
    }
    
    // ===== æ¬„ä½è®Šæ›´è™•ç† =====
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // å®¢æˆ¶è®Šæ›´æ™‚ï¼Œè‡ªå‹•è¼‰å…¥åœ°å€ä¸¦æ›´æ–° ActionButtons
            if (fieldChange.PropertyName == nameof(SalesDelivery.CustomerId))
            {
                if (fieldChange.Value != null)
                {
                    await HandleCustomerChanged((int)fieldChange.Value);
                }
                
                // æ›´æ–°å®¢æˆ¶æ¬„ä½çš„æ“ä½œæŒ‰éˆ•
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    customerModalManager, 
                    formFields, 
                    nameof(SalesDelivery.CustomerId), 
                    fieldChange.Value
                );
                
                // âœ… åªåœ¨å®¢æˆ¶è®Šæ›´æ™‚æ‰è§¸ç™¼é‡æ–°æ¸²æŸ“
                StateHasChanged();
                return; // âœ… é‡è¦ï¼šè™•ç†å®Œå°±è¿”å›ï¼Œé¿å…ç¹¼çºŒåŸ·è¡Œ
            }
            
            // æ¥­å‹™å“¡è®Šæ›´æ™‚ï¼Œæ›´æ–° ActionButtons
            if (fieldChange.PropertyName == nameof(SalesDelivery.EmployeeId))
            {
                // æ›´æ–°æ¥­å‹™å“¡æ¬„ä½çš„æ“ä½œæŒ‰éˆ•
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    employeeModalManager, 
                    formFields, 
                    nameof(SalesDelivery.EmployeeId), 
                    fieldChange.Value
                );
                
                // âœ… åªåœ¨æ¥­å‹™å“¡è®Šæ›´æ™‚æ‰è§¸ç™¼é‡æ–°æ¸²æŸ“
                StateHasChanged();
                return; // âœ… é‡è¦ï¼šè™•ç†å®Œå°±è¿”å›ï¼Œé¿å…ç¹¼çºŒåŸ·è¡Œ
            }
            
            // âœ… å…¶ä»–æ¬„ä½è®Šæ›´ä¸éœ€è¦ StateHasChanged
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(OnFieldValueChanged), GetType());
        }
    }

    private async Task HandleCustomerChanged(int customerId)
    {
        try
        {
            var customer = availableCustomers.FirstOrDefault(c => c.Id == customerId);
            if (customer != null && editModalComponent?.Entity != null)
            {
                editModalComponent.Entity.DeliveryAddress = customer.ShippingAddress ?? customer.ContactAddress;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCustomerChanged), GetType());
        }
    }

    // ===== å‡ºè²¨æ˜ç´°ç®¡ç†æ–¹æ³• =====
    
    /// <summary>
    /// è¼‰å…¥å‡ºè²¨æ˜ç´°
    /// </summary>
    private async Task LoadSalesDeliveryDetails(int salesDeliveryId)
    {
        try
        {
            salesDeliveryDetails = await SalesDeliveryDetailService.GetByDeliveryIdAsync(salesDeliveryId);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSalesDeliveryDetails), GetType());
            salesDeliveryDetails = new List<SalesDeliveryDetail>();
        }
    }

    /// <summary>
    /// è™•ç†å‡ºè²¨æ˜ç´°è®Šæ›´ - è‡ªå‹•è¨ˆç®—ç¸½é‡‘é¡
    /// </summary>
    private Task HandleDeliveryDetailsChanged(List<SalesDeliveryDetail> details)
    {
        salesDeliveryDetails = details;
        
        if (editModalComponent?.Entity != null)
        {
            // è¨ˆç®—ç¸½é‡‘é¡
            var totalAmount = salesDeliveryDetails.Sum(d => d.SubtotalAmount);
            editModalComponent.Entity.TotalAmount = totalAmount;
            
            StateHasChanged();
        }
        
        return Task.CompletedTask;
    }

    /// <summary>
    /// è™•ç†å·²åˆªé™¤çš„å‡ºè²¨æ˜ç´°ID
    /// </summary>
    private async Task HandleDeletedDetailsChanged(List<int> deletedDetailIds)
    {
        try
        {
            foreach (var detailId in deletedDetailIds)
            {
                var detailToDelete = await SalesDeliveryDetailService.GetByIdAsync(detailId);
                if (detailToDelete != null)
                {
                    await SalesDeliveryDetailService.DeleteAsync(detailId);
                }
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDeletedDetailsChanged), GetType());
        }
    }

    /// <summary>
    /// é©—è­‰å‡ºè²¨æ˜ç´° - åœ¨å„²å­˜ä¸»æª”ä¹‹å‰åŸ·è¡Œ
    /// </summary>
    private async Task<bool> ValidateSalesDeliveryDetailsAsync(SalesDelivery salesDelivery)
    {
        if (salesDeliveryDetailManager == null)
            return true;

        return await salesDeliveryDetailManager.ValidateAsync();
    }

    /// <summary>
    /// AfterSave å›èª¿æ–¹æ³• - åœ¨ä¸»æª”å„²å­˜å¾Œè™•ç†æ˜ç´°
    /// </summary>
    private async Task SaveSalesDeliveryDetailsAsync(SalesDelivery salesDelivery)
    {
        try
        {
            // åªæœ‰åœ¨å‡ºè²¨å–®IDå­˜åœ¨æ™‚æ‰è™•ç†æ˜ç´°ï¼ˆæ–°å¢å‡ºè²¨å–®æ™‚å¯èƒ½IDé‚„æ˜¯0ï¼‰
            if (salesDelivery.Id <= 0)
            {
                return; // æ–°å¢çš„å‡ºè²¨å–®ï¼ŒIDå¯èƒ½é‚„æ²’è¨­å®šï¼Œè·³éæ˜ç´°å„²å­˜
            }

            // å„²å­˜æœ‰æ•ˆçš„æ˜ç´°è³‡æ–™ï¼ˆæœ‰é¸æ“‡å•†å“çš„è¨˜éŒ„ï¼‰
            var validDetails = salesDeliveryDetails
                .Where(d => d.ProductId > 0 && d.DeliveryQuantity > 0)
                .ToList();

            if (validDetails.Any())
            {
                foreach (var detail in validDetails)
                {
                    detail.SalesDeliveryId = salesDelivery.Id;
                    
                    if (detail.Id == 0)
                    {
                        await SalesDeliveryDetailService.CreateAsync(detail);
                    }
                    else
                    {
                        await SalesDeliveryDetailService.UpdateAsync(detail);
                    }
                }

                // ğŸ”‘ é—œéµï¼šé‡æ–°è¼‰å…¥æ˜ç´°è³‡æ–™ä»¥æ›´æ–°UIé¡¯ç¤º
                salesDeliveryDetails = await SalesDeliveryDetailService.GetByDeliveryIdAsync(salesDelivery.Id);
            }

            // æ›´æ–°ä¸»æª”ç¸½é‡‘é¡
            var totalAmount = salesDeliveryDetails.Sum(d => d.SubtotalAmount);
            if (salesDelivery.TotalAmount != totalAmount)
            {
                salesDelivery.TotalAmount = totalAmount;
                await SalesDeliveryService.UpdateAsync(salesDelivery);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveSalesDeliveryDetailsAsync), GetType());
            throw;
        }
    }

    /// <summary>
    /// é…ç½®è‡ªè¨‚æ¨¡çµ„
    /// </summary>
    private List<GenericEditModalComponent<SalesDelivery, ISalesDeliveryService>.CustomModule> GetCustomModules()
    {
        return new List<GenericEditModalComponent<SalesDelivery, ISalesDeliveryService>.CustomModule>
        {
            new GenericEditModalComponent<SalesDelivery, ISalesDeliveryService>.CustomModule
            {
                Title = "",
                Order = 1,
                Content = CreateDeliveryDetailManagerContent()
            }
        };
    }

    /// <summary>
    /// å‰µå»ºå‡ºè²¨æ˜ç´°ç®¡ç†å™¨å…§å®¹çš„ RenderFragment
    /// </summary>
    private RenderFragment CreateDeliveryDetailManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null)
            {
                // åªæœ‰é¸æ“‡å®¢æˆ¶å¾Œæ‰é¡¯ç¤ºæ˜ç´°ç®¡ç†å™¨
                @if (editModalComponent.Entity.CustomerId > 0)
                {
                    try
                    {
                        <SalesDeliveryTable @ref="salesDeliveryDetailManager"
                                           TMainEntity="SalesDelivery"
                                           TDetailEntity="SalesDeliveryDetail"
                                           MainEntity="@editModalComponent.Entity"
                                           ExistingDetails="@salesDeliveryDetails"
                                           OnDetailsChanged="@HandleDeliveryDetailsChanged"
                                           OnDeletedDetailsChanged="@HandleDeletedDetailsChanged"
                                           Products="@availableProducts"
                                           Warehouses="@warehouses"
                                           WarehouseLocations="@warehouseLocations"
                                           SelectedCustomerId="@editModalComponent.Entity.CustomerId"
                                           SelectedSalesOrderId="@editModalComponent.Entity.SalesOrderId"
                                           MainEntityIdPropertyName="@nameof(SalesDeliveryDetail.SalesDeliveryId)"
                                           QuantityPropertyName="@nameof(SalesDeliveryDetail.DeliveryQuantity)"
                                           UnitPricePropertyName="@nameof(SalesDeliveryDetail.UnitPrice)"
                                           RemarksPropertyName="@nameof(SalesDeliveryDetail.Remarks)"
                                           WarehouseIdPropertyName="@nameof(SalesDeliveryDetail.WarehouseId)"
                                           WarehouseLocationIdPropertyName="@nameof(SalesDeliveryDetail.WarehouseLocationId)"
                                           ShowWarehouse="true"
                                           ShowWarehouseLocation="false"
                                           IsReadOnly="false" />
                    }
                    catch
                    {
                        <div class="alert alert-warning" role="alert">
                            è¼‰å…¥æ˜ç´°ç®¡ç†å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-info text-center" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        è«‹å…ˆé¸æ“‡å®¢æˆ¶å¾Œå†é€²è¡Œå‡ºè²¨æ˜ç´°ç®¡ç†
                    </div>
                }
            }
            else
            {
                <div class="text-center py-3">
                    <span class="text-muted">è«‹å…ˆé¸æ“‡å®¢æˆ¶å¾Œå†ç®¡ç†å‡ºè²¨æ˜ç´°</span>
                </div>
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                è¼‰å…¥æ˜ç´°ç®¡ç†å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚
            </div>
        }
    };
    
    // ===== ActionButton ç”¢ç”Ÿæ–¹æ³• =====
}