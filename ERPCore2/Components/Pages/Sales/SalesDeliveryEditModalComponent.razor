@using ERPCore2.Services.Reports.Interfaces
@using ERPCore2.Models.Reports
@inject ISalesDeliveryService SalesDeliveryService
@inject ISalesDeliveryDetailService SalesDeliveryDetailService
@inject ISalesOrderService SalesOrderService
@inject ISalesOrderDetailService SalesOrderDetailService
@inject ISalesReturnDetailService SalesReturnDetailService
@inject ICustomerService CustomerService
@inject IProductService ProductService
@inject IEmployeeService EmployeeService
@inject IUnitService UnitService
@inject IWarehouseService WarehouseService
@inject IWarehouseLocationService WarehouseLocationService
@inject ISystemParameterService SystemParameterService
@inject INotificationService NotificationService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ActionButtonHelper ActionButtonHelper
@inject ISalesDeliveryReportService SalesDeliveryReportService
@inject ERPCore2.Data.Context.AppDbContext DbContext
@inject IStringLocalizer<SharedResource> L

<GenericEditModalComponent TEntity="SalesDelivery" 
                          TService="ISalesDeliveryService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@SalesDeliveryId"
                          Service="@SalesDeliveryService"
                          EntityName="@L["Entity.SalesDelivery"]"
                          EntityNamePlural="@L["Entity.SalesDelivery"]"
                          ModalTitle="@(SalesDeliveryId.HasValue ? L["Message.EditTitle", L["Entity.SalesDelivery"]].ToString() : L["Message.CreateTitle", L["Entity.SalesDelivery"]].ToString())"
                          Size="GenericEditModalComponent<SalesDelivery, ISalesDeliveryService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          AutoCompleteCollections="@(autoCompleteConfig?.Collections)"
                          AutoCompleteDisplayProperties="@(autoCompleteConfig?.DisplayProperties)"
                          AutoCompleteValueProperties="@(autoCompleteConfig?.ValueProperties)"
                          ModalManagers="@modalManagers?.AsDictionary()"
                          DataLoader="@LoadSalesDeliveryData"
                          UseGenericSave="true"
                          CustomValidator="@ValidateSalesDeliveryDetailsAsync"
                          AfterSave="@SaveSalesDeliveryDetailsAsync"
                          SaveSuccessMessage="@(SalesDeliveryId.HasValue ? L["Message.UpdateSuccess", L["Entity.SalesDelivery"]].ToString() : L["Message.CreateSuccess", L["Entity.SalesDelivery"]].ToString())"
                          SaveFailureMessage="@L["Message.SaveFailure", L["Entity.SalesDelivery"]]"
                          RequiredPermission="SalesDelivery.Read"
                          OnEntitySaved="@OnSalesDeliverySaved"
                          OnCancel="@OnCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          OnTaxMethodChanged="@(() => HandleDeliveryDetailsChanged(salesDeliveryDetails))"
                          GetStatusMessage="@GetSalesDeliveryStatusMessage"
                          FormHeaderContent="@GetWarningMessage()"
                          TabDefinitions="@tabDefinitions"
                          CustomActionButtons="@GetCustomActionButtons()"
                          ShowPrintButton="true"
                          PrintButtonText="@L["Button.Print"]"
                          ReportService="@SalesDeliveryReportService"
                          ReportId="@ReportIds.SalesDelivery"
                          ReportPreviewTitle="@L["Label.DocumentPreview", L["Entity.SalesDelivery"]]"
                          GetReportDocumentName="@(e => $"出貨單-{e.Code}")"
                          OnEntityLoaded="@HandleEntityLoaded">
</GenericEditModalComponent>

@* 客戶編輯 Modal *@
<CustomerEditModalComponent @ref="customerEditModal"
                           IsVisible="@customerModalManager.IsModalVisible"
                           IsVisibleChanged="@customerModalManager.HandleModalVisibilityChangedAsync"
                           CustomerId="@customerModalManager.SelectedEntityId"
                           OnCustomerSaved="@customerModalManager.OnSavedAsync"
                           OnCancel="@customerModalManager.HandleModalCancelAsync" />

@* 業務員編輯 Modal *@
<EmployeeEditModalComponent @ref="employeeEditModal"
                           IsVisible="@employeeModalManager.IsModalVisible"
                           IsVisibleChanged="@employeeModalManager.HandleModalVisibilityChangedAsync"
                           EmployeeId="@employeeModalManager.SelectedEntityId"
                           OnEmployeeSaved="@employeeModalManager.OnSavedAsync"
                           OnCancel="@employeeModalManager.HandleModalCancelAsync" />

@* 銷貨退貨編輯 Modal *@
<SalesReturnEditModalComponent @ref="salesReturnEditModal"
                              IsVisible="@showSalesReturnModal"
                              IsVisibleChanged="@((bool visible) => showSalesReturnModal = visible)"
                              SalesReturnId="@selectedSalesReturnId"
                              OnSalesReturnSaved="@HandleSalesReturnSaved"
                              OnCancel="@(() => showSalesReturnModal = false)" />

@* 沖款單編輯 Modal *@
<SetoffDocumentEditModalComponent @ref="setoffDocumentEditModal"
                                 IsVisible="@showSetoffDocumentModal"
                                 IsVisibleChanged="@((bool visible) => showSetoffDocumentModal = visible)"
                                 SetoffDocumentId="@selectedSetoffDocumentId"
                                 OnSetoffDocumentSaved="@HandleSetoffDocumentSaved"
                                 OnCancel="@(() => showSetoffDocumentModal = false)" />

@* 銷售訂單編輯 Modal（由 OrderTab 開啟） *@
<SalesOrderEditModalComponent @ref="salesOrderEditModal"
                              IsVisible="@showSalesOrderModal"
                              IsVisibleChanged="@((bool visible) => showSalesOrderModal = visible)"
                              SalesOrderId="@selectedSalesOrderId"
                              OnCancel="@(() => showSalesOrderModal = false)" />

@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SalesDeliveryId { get; set; }
    [Parameter] public EventCallback<SalesDelivery> OnSalesDeliverySaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    
    // ===== 預填參數（用於從銷售訂單轉單） =====
    [Parameter] public int? PrefilledCustomerId { get; set; }
    [Parameter] public int? PrefilledSalesOrderId { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<SalesDelivery, ISalesDeliveryService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    private List<FormTabDefinition>? tabDefinitions;

    // ===== 關聯文件 Tabs =====
    private SalesDeliveryReturnTab? returnTab;
    private SalesDeliverySetoffTab? setoffTab;
    private SalesDeliveryOrderTab? orderTab;

    // ===== 銷售訂單 Modal（由 OrderTab 開啟） =====
    private SalesOrderEditModalComponent? salesOrderEditModal;
    private bool showSalesOrderModal = false;
    private int? selectedSalesOrderId = null;
    
    // 原始資料集合（用於 AutoComplete）
    private List<Customer> availableCustomers = new();
    private List<Employee> availableEmployees = new();
    private List<Product> availableProducts = new();
    private List<Unit> availableUnits = new();
    private List<Warehouse> availableWarehouses = new();
    private List<SalesOrder> availableSalesOrders = new();
    
    // AutoComplete 配置
    private AutoCompleteConfig? autoCompleteConfig;
    
    // 銷貨出貨明細
    private List<SalesDeliveryDetail> salesDeliveryDetails = new();
    
    // 方案 D 改良版：資料版本計數器
    private int _detailsDataVersion = 0;
    
    // 明細管理組件引用
    private SalesDeliveryTable<SalesDelivery, SalesDeliveryDetail>? salesDeliveryDetailManager;
    
    // 商品篩選欄位（用於載入時過濾）
    private int? filterProductId = null;
    private int? FilterProductId => filterProductId;
    private int? filterSalesOrderId = null;
    
    // 退貨數量快取字典（Key: DetailId, Value: 已退貨數量）
    private Dictionary<int, decimal> returnedQuantities = new();
    
    // ===== 明細載入狀態 =====
    private bool shouldAutoLoadUndelivered = false;  // 標記是否需要自動載入未出貨商品
    private bool isDetailDataReady = false;  // 標記明細相關資料是否已完整載入（包括退貨數量）
    
    // ===== 轉單狀態 =====
    private bool canCreateReturn = false;  // 是否可以轉退貨（新增模式需先儲存，編輯模式直接為 true）
    
    // ===== 鎖定狀態 =====
    private bool hasUndeletableDetails = false;  // 是否有不可刪除的明細（已有退貨記錄）
    
    // Modal Manager 集合
    private ModalManagerCollection? modalManagers;
    
    // Modal 管理器
    private CustomerEditModalComponent? customerEditModal;
    private RelatedEntityModalManager<Customer> customerModalManager = default!;
    private EmployeeEditModalComponent? employeeEditModal;
    private RelatedEntityModalManager<Employee> employeeModalManager = default!;
    
    // ===== 相關單據 Modal =====
    private SalesReturnEditModalComponent? salesReturnEditModal;
    private bool showSalesReturnModal = false;
    private int? selectedSalesReturnId = null;
    
    // ===== 沖款單 Modal =====
    private SetoffDocumentEditModalComponent? setoffDocumentEditModal;
    private bool showSetoffDocumentModal = false;
    private int? selectedSetoffDocumentId = null;
    
    // 下拉選單選項（向下相容）
    private List<Customer> customers = new();
    private List<Employee> employees = new();
    private List<Warehouse> warehouses = new();
    private List<WarehouseLocation> warehouseLocations = new();
    private List<SalesOrder> salesOrders = new();
    private List<SelectOption> customerOptions = new();
    private List<SelectOption> employeeOptions = new();
    private List<SelectOption> warehouseOptions = new();
    private List<SelectOption> salesOrderOptions = new();
    private List<SelectOption> taxCalculationMethodOptions = new();
    
    // 稅率快取變數
    private decimal currentTaxRate = 5.0m;
    
    // 資料載入狀態標記
    private bool isDataLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 使用 ModalManagerInitHelper 初始化所有 Manager
            modalManagers = ModalManagerInitHelper.CreateBuilder<SalesDelivery, ISalesDeliveryService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Customer>(nameof(SalesDelivery.CustomerId), "客戶")
                .AddManager<Employee>(nameof(SalesDelivery.EmployeeId), "業務員")
                .Build();
            
            // 取得個別 Manager 供組件使用
            customerModalManager = modalManagers.Get<Customer>(nameof(SalesDelivery.CustomerId));
            employeeModalManager = modalManagers.Get<Employee>(nameof(SalesDelivery.EmployeeId));
            
            // 移除自動載入資料，改為在 OnParametersSetAsync 中根據 IsVisible 載入
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化出貨單編輯組件時發生錯誤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
        }
    }
    /// <summary>
    /// 取得出貨單狀態訊息（顯示鎖定狀態）
    /// </summary>
    private async Task<(string Message, GenericEditModalComponent<SalesDelivery, ISalesDeliveryService>.BadgeVariant Variant, string IconClass)?> GetSalesDeliveryStatusMessage()
    {
        try
        {
            if (!isDetailDataReady)
            {
                return null;
            }

            if (hasUndeletableDetails)
            {
                return (
                    "明細有退貨或沖款記錄，主檔欄位已鎖定",
                    GenericEditModalComponent<SalesDelivery, ISalesDeliveryService>.BadgeVariant.Warning,
                    "fas fa-lock"
                );
            }

            return null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetSalesDeliveryStatusMessage), GetType());
            return null;
        }
    }

    /// <summary>
    /// 取得警告訊息（顯示在表單最上方）
    /// </summary>
    private RenderFragment? GetWarningMessage() => __builder =>
    {
        <GenericLockedFieldMessage IsVisible="@(isDetailDataReady && hasUndeletableDetails)"
                                  Message="@EditModalMessages.UndeletableDetailsWarning" />
    };

    /// <summary>
    /// 開啟新增出貨單 Modal 並預填銷售訂單資訊（公開方法供外部調用）
    /// </summary>
    /// <summary>
    /// 打開新增銷貨出貨單 Modal 並預填銷貨訂單資料（公開方法，供父組件呼叫）
    /// </summary>
    public async Task ShowAddModalWithPrefilledOrder(int customerId, int salesOrderId)
    {
        try
        {
            // 使用 DocumentConversionHelper 統一處理轉單邏輯（參照採購模組）
            var success = await DocumentConversionHelper.ShowConversionModalAsync(
                setPrefilledValues: () =>
                {
                    SalesDeliveryId = null;
                    PrefilledCustomerId = customerId;
                    PrefilledSalesOrderId = salesOrderId;
                    shouldAutoLoadUndelivered = true;  //  標記需要自動載入
                },
                isVisibleChanged: IsVisibleChanged,
                autoLoadAction: async () =>
                {
                    shouldAutoLoadUndelivered = false;
                    if (salesDeliveryDetailManager != null)
                    {
                        await salesDeliveryDetailManager.LoadAllUndeliveredItems();
                    }
                },
                detailManagerReady: () => salesDeliveryDetailManager != null,
                shouldAutoLoad: () => shouldAutoLoadUndelivered,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("轉單流程執行失敗");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledOrder), GetType(), 
                additionalData: $"開啟預填出貨單Modal失敗 - CustomerId: {customerId}, SalesOrderId: {salesOrderId}");
            await NotificationService.ShowErrorAsync("開啟出貨單時發生錯誤");
        }
    }

    private async Task<SalesDelivery?> LoadSalesDeliveryData()
    {
        try
        {
            //  關鍵修正：每次載入資料時重置狀態變數，避免上次編輯的狀態殘留到新增模式
            isDetailDataReady = false;
            hasUndeletableDetails = false;
            
            if (!SalesDeliveryId.HasValue)
            {
                // 新增模式 - 自動產生出貨單號
                var generatedCode = await EntityCodeGenerationHelper.GenerateForEntity<SalesDelivery, ISalesDeliveryService>(SalesDeliveryService, DbContext);
                
                var newDelivery = new SalesDelivery
                {
                    DeliveryDate = DateTime.Today,
                    Status = EntityStatus.Active,
                    TotalAmount = 0,
                    Code = generatedCode,
                    IsShipped = false,
                    IsApproved = false
                };
                
                // 新增模式：必須先儲存才能轉退貨
                canCreateReturn = false;
                
                //  修正：不在這裡載入明細，改為設定預填值後由 DocumentConversionHelper 觸發自動載入
                // 這樣可以確保 SalesDeliveryTable 組件已經渲染完成
                if (PrefilledSalesOrderId.HasValue)
                {
                    // 初始化篩選狀態（SalesOrderId 已從實體移除，改用虛擬篩選欄位）
                    filterSalesOrderId = PrefilledSalesOrderId.Value;
                    // 載入訂單基本資料（客戶、業務員等）
                    var salesOrder = await SalesOrderService.GetWithDetailsAsync(PrefilledSalesOrderId.Value);
                    if (salesOrder != null)
                    {
                        newDelivery.CustomerId = salesOrder.CustomerId;
                        newDelivery.EmployeeId = salesOrder.EmployeeId;
                    }
                    // 明細載入會在 OnAfterRenderAsync 中由 DocumentConversionHelper 自動觸發
                }
                else if (PrefilledCustomerId.HasValue)
                {
                    newDelivery.CustomerId = PrefilledCustomerId.Value;
                }
                
                if (!PrefilledSalesOrderId.HasValue)
                {
                    salesDeliveryDetails.Clear();
                }
                
                return newDelivery;
            }
            
            // 編輯模式 - 載入銷貨出貨單和明細
            canCreateReturn = true;  // 編輯模式：可以直接轉退貨
            var salesDelivery = await SalesDeliveryService.GetByIdAsync(SalesDeliveryId.Value);
            
            if (salesDelivery != null)
            {
                // 載入銷貨出貨明細
                await LoadSalesDeliveryDetailsInternal(SalesDeliveryId.Value);
                StateHasChanged();
                
                // 重新初始化表單欄位
                await Task.Delay(10);
                _ = Task.Run(async () =>
                {
                    await InvokeAsync(async () =>
                    {
                        await InitializeFormFieldsAsync();
                        StateHasChanged();
                    });
                });
                
                StateHasChanged();
            }
            else
            {
            }
            
            return salesDelivery;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSalesDeliveryData), GetType(), 
                additionalData: $"載入出貨單資料失敗 - ID: {SalesDeliveryId}");
            await NotificationService.ShowErrorAsync($"載入出貨單資料時發生錯誤：{ex.Message}");
            return null;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // 載入客戶選項
            customers = await CustomerService.GetAllAsync();
            availableCustomers = customers;
            customerOptions = customers.Where(c => c.Status == EntityStatus.Active)
                .Select(c => new SelectOption
                {
                    Text = c.CompanyName ?? "",
                    Value = c.Id.ToString()
                }).ToList();

            // 載入員工選項（排除超級管理員）
            var allEmployees = await EmployeeService.GetAllAsync();
            employees = allEmployees.Where(e => !e.IsSuperAdmin).ToList();
            availableEmployees = employees;
            employeeOptions = employees.Where(e => e.Status == EntityStatus.Active)
                .Select(e => new SelectOption
                {
                    Text = e.Name ?? string.Empty,
                    Value = e.Id.ToString()
                }).ToList();

            // 載入倉庫選項
            warehouses = await WarehouseService.GetAllAsync();
            availableWarehouses = warehouses;
            warehouseOptions = warehouses.Where(w => w.Status == EntityStatus.Active)
                .Select(w => new SelectOption
                {
                    Text = w.Name,
                    Value = w.Id.ToString()
                }).ToList();

            // 載入倉庫位置選項
            warehouseLocations = await WarehouseLocationService.GetAllAsync();

            // 載入銷售訂單
            salesOrders = await SalesOrderService.GetAllAsync();
            availableSalesOrders = salesOrders;
            salesOrderOptions = salesOrders.Where(so => so.Status == EntityStatus.Active)
                .Select(so => new SelectOption
                {
                    Text = so.Code ?? string.Empty,
                    Value = so.Id.ToString()
                }).ToList();

            // 載入商品資料
            availableProducts = await ProductService.GetAllAsync();

            // 載入單位資料
            availableUnits = await UnitService.GetAllAsync();
            
            taxCalculationMethodOptions = TaxCalculationHelper.GetTaxMethodOptions();
            
            // 載入系統稅率
            currentTaxRate = await TaxCalculationHelper.LoadTaxRateAsync(SystemParameterService);
            
            // 配置 AutoComplete
            autoCompleteConfig = new AutoCompleteConfigBuilder<SalesDelivery>()
                .AddField(nameof(SalesDelivery.CustomerId), "CompanyName", availableCustomers)
                .AddField(nameof(SalesDelivery.EmployeeId), "Name", availableEmployees)
                .AddField(nameof(SalesDelivery.WarehouseId), "Name", availableWarehouses)
                .AddField("FilterSalesOrderId", "Code", availableSalesOrders)
                .AddField("FilterProductId", "Name", availableProducts)
                .Build();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadAdditionalDataAsync), GetType(), 
                additionalData: "出貨單編輯Modal載入額外資料失敗");
            
            customerOptions = new List<SelectOption>();
            employeeOptions = new List<SelectOption>();
            warehouseOptions = new List<SelectOption>();
            salesOrderOptions = new List<SelectOption>();
            availableProducts = new List<Product>();
            availableUnits = new List<Unit>();
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SalesDelivery.Code),
                    Label = L["Field.SalesDeliveryCode"],
                    FieldType = FormFieldType.Text,
                    Placeholder = L["Placeholder.PleaseInput", L["Field.SalesDeliveryCode"]],
                    IsRequired = true,
                    MaxLength = 30,
                    HelpText = "出貨單的唯一編號，新增時系統會自動產生，也可手動修改"
                },
                new()
                {
                    PropertyName = nameof(SalesDelivery.CustomerId),
                    Label = L["Entity.Customer"],
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = L["Placeholder.PleaseInputOrSelect", L["Entity.Customer"]],
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "輸入客戶名稱進行搜尋，或直接選擇",
                    ActionButtons = await GetCustomerActionButtonsAsync(),
                    IsReadOnly = hasUndeletableDetails
                },
                new FormFieldDefinition()
                {
                    PropertyName = "FilterProductId", // 篩選用的虛擬欄位，不儲存至資料庫
                    Label = L["Entity.Product"],
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = L["Placeholder.PleaseInputOrSelect", L["Entity.Product"]],
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "選擇商品後，點擊載入只會載入該商品的訂單明細。此欄位不會儲存。",
                    IsReadOnly = true, // 預設停用，等待客戶選取後由 UpdateFilterFieldsState 更新
                    IsFilterOnly = true
                },
                new FormFieldDefinition()
                {
                    PropertyName = "FilterSalesOrderId", // 篩選用的虛擬欄位，不儲存至資料庫
                    Label = L["Entity.SalesOrder"],
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = L["Placeholder.PleaseSelect", L["Entity.SalesOrder"]],
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "選擇特定訂單進行篩選，或留空顯示所有訂單明細。此欄位不會儲存。",
                    IsReadOnly = true, // 預設停用，等待客戶選取後由 UpdateFilterFieldsState 更新
                    IsFilterOnly = true
                },
                new()
                {
                    PropertyName = nameof(SalesDelivery.EmployeeId),
                    Label = L["Field.SalesPerson"],
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = L["Placeholder.PleaseSelect", L["Field.SalesPerson"]],
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "選擇負責此出貨的業務員",
                    ActionButtons = await GetEmployeeActionButtonsAsync()
                },
                new()
                {
                    PropertyName = nameof(SalesDelivery.DeliveryDate),
                    Label = L["Field.SalesDeliveryDate"],
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "出貨日期",
                    IsReadOnly = hasUndeletableDetails
                },
                new()
                {
                    PropertyName = nameof(SalesDelivery.TaxCalculationMethod),
                    Label = L["Field.TaxType"],
                    FieldType = FormFieldType.Select,
                    IsRequired = true,
                    Options = taxCalculationMethodOptions,
                    HelpText = "選擇該出貨單的計稅方式（外加稅/內含稅/不含稅）",
                    IsReadOnly = hasUndeletableDetails
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesDelivery.TotalAmount),
                    Label = L["Field.Amount"],
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "系統根據明細自動計算（折扣前金額）",
                    CssClass = "text-warning fw-bold"
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesDelivery.DiscountAmount),
                    Label = L["Field.Discount"],
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "系統根據明細自動計算 = (數量 × 單價 × 折扣%)",
                    CssClass = "text-danger fw-bold"
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesDelivery.TaxAmount),
                    Label = L["Field.TaxAmount"],
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "系統根據明細自動計算 = (折扣後金額 × 稅率%)",
                    CssClass = "text-info fw-bold"
                },
                new()
                {
                    PropertyName = nameof(SalesDelivery.TotalAmountWithTax),
                    Label = L["Field.TotalAmount"],
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "系統根據明細自動計算（金額 - 折扣 + 稅額）",
                    CssClass = "text-success fw-bold"
                },
                    FormFieldConfigurationHelper.CreateRemarksField<SalesDelivery>(readOnly: hasUndeletableDetails)
            };


            var layout = FormSectionHelper<SalesDelivery>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    sd => sd.Code,
                    sd => sd.CustomerId,
                    sd => sd.EmployeeId,
                    sd => sd.DeliveryDate)
                .AddCustomFields(FormSectionNames.FilterConditions, "FilterSalesOrderId", "FilterProductId")  // 虛擬篩選欄位，不存DB
                .AddToSection(FormSectionNames.AmountInfo,
                    sd => sd.TaxCalculationMethod,
                    sd => sd.TotalAmount,
                    sd => sd.DiscountAmount,
                    sd => sd.TaxAmount,
                    sd => sd.TotalAmountWithTax)
                .AddToSection(FormSectionNames.OtherInfo,
                    sd => sd.DeliveryAddress,
                    sd => sd.Remarks)
                .GroupIntoTab("出貨資料", "bi-file-earmark-text",
                    FormSectionNames.BasicInfo, FormSectionNames.FilterConditions,
                    FormSectionNames.AmountInfo, FormSectionNames.OtherInfo)
                .GroupIntoCustomTab("出貨明細", "bi-list-ul", CreateDeliveryDetailManagerContent())
                .GroupIntoCustomTab("退回記錄", "bi-arrow-return-left", CreateReturnTabContent())
                .GroupIntoCustomTab("沖款記錄", "bi-cash-coin", CreateSetoffTabContent())
                .GroupIntoCustomTab("來源訂單", "bi-file-earmark-arrow-up", CreateOrderTabContent())
                .BuildAll();
            formSections = layout.FieldSections;
            tabDefinitions = layout.TabDefinitions;
            
            // 重置篩選狀態
            filterProductId = null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(InitializeFormFieldsAsync), GetType());
        }
    }

    // ===== 自動產生單號 =====
    // ===== 從銷售訂單載入資料 =====
    private async Task LoadDataFromSalesOrder(SalesDelivery delivery, int salesOrderId)
    {
        try
        {
            var salesOrder = await SalesOrderService.GetWithDetailsAsync(salesOrderId);
            if (salesOrder == null) return;

            filterSalesOrderId = salesOrderId;
            delivery.CustomerId = salesOrder.CustomerId;
            delivery.EmployeeId = salesOrder.EmployeeId;

            var orderDetails = await SalesOrderDetailService.GetBySalesOrderIdAsync(salesOrderId);
            salesDeliveryDetails.Clear();

            foreach (var orderDetail in orderDetails)
            {
                var remainingQty = orderDetail.OrderQuantity - orderDetail.DeliveredQuantity;
                if (remainingQty > 0)
                {
                    salesDeliveryDetails.Add(new SalesDeliveryDetail
                    {
                        SalesOrderDetailId = orderDetail.Id,
                        ProductId = orderDetail.ProductId,
                        DeliveryQuantity = remainingQty,
                        UnitPrice = orderDetail.UnitPrice,
                        UnitId = orderDetail.UnitId
                    });
                }
            }

            await NotificationService.ShowSuccessAsync($"已從訂單 {salesOrder.Code} 載入資料");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDataFromSalesOrder), GetType());
            await NotificationService.ShowErrorAsync("載入訂單資料失敗");
        }
    }

    
    // ===== 載入明細 =====
    
    /// <summary>
    /// 處理實體載入完成事件（由 GenericEditModalComponent 的導航觸發）
    /// 方案 A + D 重構：明細已由 DataLoader 載入，Table 自動偵測參數變化
    /// 只需處理 UI 刷新
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            UpdateFilterFieldsState();
            if (loadedEntityId > 0)
            {
                if (returnTab != null) await returnTab.LoadAsync(loadedEntityId);
                if (setoffTab != null) await setoffTab.LoadAsync(loadedEntityId);
                if (orderTab != null) await orderTab.LoadAsync(loadedEntityId);
            }
            else
            {
                returnTab?.Clear();
                setoffTab?.Clear();
                orderTab?.Clear();
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleEntityLoaded), GetType(),
                additionalData: $"處理實體載入事件失敗 - EntityId: {loadedEntityId}");
            await NotificationService.ShowErrorAsync("載入明細資料時發生錯誤");
        }
    }
    
    private async Task LoadSalesDeliveryDetailsInternal(int salesDeliveryId)
    {
        try
        {
            //  關鍵修正：使用 GetWithDetailsAsync 重新載入完整實體（包含關聯資料）
            // 這確保 Product 等關聯物件都已載入，與 QuotationEditModalComponent 保持一致
            var salesDelivery = await SalesDeliveryService.GetByIdAsync(salesDeliveryId);
            salesDeliveryDetails = await SalesDeliveryDetailService.GetByDeliveryIdAsync(salesDeliveryId);
            
            // 方案 D 改良版：遞增版本號
            _detailsDataVersion++;
            
            //  關鍵：載入退貨數量資料，用於判斷是否可刪除明細
            await LoadDetailRelatedDataAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSalesDeliveryDetailsInternal), GetType());
            salesDeliveryDetails = new List<SalesDeliveryDetail>();
        }
    }

    /// <summary>
    /// 載入明細相關資料（退貨數量等）
    /// 這個方法在主檔載入時就同步執行，確保 hasUndeletableDetails 狀態在渲染前就正確
    /// </summary>
    private async Task LoadDetailRelatedDataAsync()
    {
        try
        {
            if (!salesDeliveryDetails.Any())
            {
                isDetailDataReady = true;
                hasUndeletableDetails = false;
                return;
            }

            //  簡化版：直接從 SalesDeliveryDetail.TotalReturnedQuantity 欄位讀取
            // 不再需要查詢 SalesReturnDetail 表，效能大幅提升
            returnedQuantities.Clear();
            foreach (var detail in salesDeliveryDetails)
            {
                if (detail.TotalReturnedQuantity > 0)
                {
                    returnedQuantities[detail.Id] = detail.TotalReturnedQuantity;
                }
            }

            // 檢查是否有不可刪除的明細（已有退貨或沖款記錄）
            bool hasUndeletable = salesDeliveryDetails.Any(detail =>
                DetailLockHelper.HasReturnRecord(detail, returnedQuantities) ||
                detail.TotalReceivedAmount > 0);

            if (hasUndeletableDetails != hasUndeletable)
            {
                hasUndeletableDetails = hasUndeletable;
                UpdateFieldsReadOnlyState();
            }

            isDetailDataReady = true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDetailRelatedDataAsync), GetType());
            isDetailDataReady = true;
        }
    }

    /// <summary>
    /// 處理有不可刪除明細的狀態變更
    /// 當有不可刪除的明細時(已退貨),鎖定主檔的客戶和訂單欄位
    /// </summary>
    private async Task HandleHasUndeletableDetailsChanged(bool hasUndeletable)
    {
        try
        {
            if (hasUndeletableDetails != hasUndeletable)
            {
                hasUndeletableDetails = hasUndeletable;
                UpdateFieldsReadOnlyState();
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleHasUndeletableDetailsChanged), GetType());
        }
    }

    /// <summary>
    /// 根據 hasUndeletableDetails 狀態更新欄位的唯讀狀態
    /// </summary>
    private void UpdateFieldsReadOnlyState()
    {
        // 使用 FormFieldLockHelper 一次處理所有欄位（含 ActionButtons）
        FormFieldLockHelper.LockMultipleFields(
            formFields,
            new[]
            {
                nameof(SalesDelivery.CustomerId),
                nameof(SalesDelivery.DeliveryDate),
                nameof(SalesDelivery.TaxCalculationMethod),
                nameof(BaseEntity.Remarks)
            },
            isLocked: hasUndeletableDetails,
            actionButtonsMap: new Dictionary<string, Func<Task<List<FieldActionButton>>>>
            {
                { nameof(SalesDelivery.CustomerId), GetCustomerActionButtonsAsync }
            }
        );

        UpdateFilterFieldsState();
    }

    private void UpdateFilterFieldsState()
    {
        bool noCustomer = !(editModalComponent?.Entity?.CustomerId > 0);
        var salesOrderFilter = formFields.FirstOrDefault(f => f.PropertyName == "FilterSalesOrderId");
        if (salesOrderFilter != null) salesOrderFilter.IsReadOnly = noCustomer || hasUndeletableDetails;
        var productFilter = formFields.FirstOrDefault(f => f.PropertyName == "FilterProductId");
        if (productFilter != null) productFilter.IsReadOnly = noCustomer || hasUndeletableDetails;
    }

    private async Task<List<FieldActionButton>> GetCustomerActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent,
            customerModalManager,
            nameof(SalesDelivery.CustomerId));
    }

    private async Task<List<FieldActionButton>> GetEmployeeActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent,
            employeeModalManager,
            nameof(SalesDelivery.EmployeeId));
    }


    // ===== 欄位變更處理 =====
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // 客戶變更時，清除訂單篩選並更新篩選欄位停用狀態
            if (fieldChange.PropertyName == nameof(SalesDelivery.CustomerId))
            {
                filterSalesOrderId = null;
                bool noCustomer = !(int.TryParse(fieldChange.Value?.ToString(), out int cId) && cId > 0);
                var salesOrderFilter = formFields.FirstOrDefault(f => f.PropertyName == "FilterSalesOrderId");
                if (salesOrderFilter != null) salesOrderFilter.IsReadOnly = noCustomer || hasUndeletableDetails;
                var productFilter = formFields.FirstOrDefault(f => f.PropertyName == "FilterProductId");
                if (productFilter != null) productFilter.IsReadOnly = noCustomer || hasUndeletableDetails;
                if (fieldChange.Value != null)
                {
                    await HandleCustomerChanged((int)fieldChange.Value);
                }
                StateHasChanged();
                return;
            }

            // 訂單篩選變更時
            if (fieldChange.PropertyName == "FilterSalesOrderId")
            {
                var valueStr = fieldChange.Value?.ToString();
                if (string.IsNullOrWhiteSpace(valueStr) || valueStr == "0")
                    filterSalesOrderId = null;
                else if (int.TryParse(valueStr, out var parsedId) && parsedId > 0)
                    filterSalesOrderId = parsedId;
                else
                    filterSalesOrderId = null;
                StateHasChanged();
                return;
            }

            // 商品篩選變更時
            if (fieldChange.PropertyName == "FilterProductId")
            {
                var valueStr = fieldChange.Value?.ToString();
                if (string.IsNullOrWhiteSpace(valueStr) || valueStr == "0")
                    filterProductId = null;
                else if (int.TryParse(valueStr, out var parsedProductId) && parsedProductId > 0)
                    filterProductId = parsedProductId;
                else
                    filterProductId = null;
                // ✅ 欄位依賴變化：篩選條件改變需要立即更新明細表格
                StateHasChanged();
                return;
            }

            // ✅ 其他欄位變更不需要 StateHasChanged
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(OnFieldValueChanged), GetType());
        }
    }

    private async Task HandleCustomerChanged(int customerId)
    {
        try
        {
            var customer = availableCustomers.FirstOrDefault(c => c.Id == customerId);
            if (customer != null && editModalComponent?.Entity != null)
            {
                editModalComponent.Entity.DeliveryAddress = customer.ShippingAddress ?? customer.ContactAddress;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCustomerChanged), GetType());
        }
    }

    // ===== 出貨明細管理方法 =====
    
    /// <summary>
    /// 載入出貨明細
    /// </summary>
    private async Task LoadSalesDeliveryDetails(int salesDeliveryId)
    {
        try
        {
            salesDeliveryDetails = await SalesDeliveryDetailService.GetByDeliveryIdAsync(salesDeliveryId);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSalesDeliveryDetails), GetType());
            salesDeliveryDetails = new List<SalesDeliveryDetail>();
        }
    }

    /// <summary>
    /// 處理出貨明細變更 - 根據稅別自動計算金額欄位
    /// </summary>
    private Task HandleDeliveryDetailsChanged(List<SalesDeliveryDetail> details)
    {
        editModalComponent?.MarkDirty();
        salesDeliveryDetails = details;

        if (editModalComponent?.Entity != null)
        {
            var (net, tax, gross, discount) = TaxCalculationHelper.CalculateFromDetailsWithDiscount(
                details,
                editModalComponent.Entity.TaxCalculationMethod,
                currentTaxRate,
                d => d.SubtotalAmount,
                d => d.TaxRate,
                d => d.DeliveryQuantity * d.UnitPrice);

            editModalComponent.Entity.TotalAmount = net;
            editModalComponent.Entity.TaxAmount = tax;
            editModalComponent.Entity.DiscountAmount = discount;

            StateHasChanged();
        }

        return Task.CompletedTask;
    }

    /// <summary>
    /// 處理已刪除的出貨明細ID
    /// </summary>
    private async Task HandleDeletedDetailsChanged(List<int> deletedDetailIds)
    {
        try
        {
            foreach (var detailId in deletedDetailIds)
            {
                var detailToDelete = await SalesDeliveryDetailService.GetByIdAsync(detailId);
                if (detailToDelete != null)
                {
                    await SalesDeliveryDetailService.DeleteAsync(detailId);
                }
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDeletedDetailsChanged), GetType());
        }
    }

    /// <summary>
    /// 驗證出貨明細 - 在儲存主檔之前執行
    /// </summary>
    private async Task<bool> ValidateSalesDeliveryDetailsAsync(SalesDelivery salesDelivery)
    {
        if (salesDeliveryDetailManager == null)
            return true;

        return await salesDeliveryDetailManager.ValidateAsync();
    }

    /// <summary>
    /// AfterSave 回調方法 - 在主檔儲存後處理明細
    /// </summary>
    private async Task SaveSalesDeliveryDetailsAsync(SalesDelivery salesDelivery)
    {
        try
        {
            // 只有在出貨單ID存在時才處理明細（新增出貨單時可能ID還是0）
            if (salesDelivery.Id <= 0)
            {
                return; // 新增的出貨單，ID可能還沒設定，跳過明細儲存
            }

            // 儲存有效的明細資料（有選擇商品的記錄）
            var validDetails = salesDeliveryDetails
                .Where(d => d.ProductId > 0 && d.DeliveryQuantity > 0)
                .ToList();

            if (validDetails.Any())
            {
                foreach (var detail in validDetails)
                {
                    detail.SalesDeliveryId = salesDelivery.Id;
                    
                    if (detail.Id == 0)
                    {
                        await SalesDeliveryDetailService.CreateAsync(detail);
                    }
                    else
                    {
                        await SalesDeliveryDetailService.UpdateAsync(detail);
                    }
                }

                //  關鍵：重新載入明細資料以更新UI顯示
                salesDeliveryDetails = await SalesDeliveryDetailService.GetByDeliveryIdAsync(salesDelivery.Id);
            }

            //  關鍵1：更新庫存（使用差異計算方式，避免重複累加）
            var inventoryUpdateResult = await SalesDeliveryService.UpdateInventoryByDifferenceAsync(salesDelivery.Id);
            if (!inventoryUpdateResult.IsSuccess)
            {
                await NotificationService.ShowErrorAsync($"庫存更新失敗：{inventoryUpdateResult.ErrorMessage}");
                throw new Exception($"庫存更新失敗：{inventoryUpdateResult.ErrorMessage}");
            }
            
            //  關鍵2：更新相關銷貨訂單明細的已出貨量（僅處理有訂單的明細）
            if (validDetails.Any())
            {
                var uniqueSalesOrderDetailIds = validDetails
                    .Where(d => d.SalesOrderDetailId.HasValue && d.SalesOrderDetailId.Value > 0)
                    .Select(d => d.SalesOrderDetailId!.Value)
                    .Distinct();

                foreach (var salesOrderDetailId in uniqueSalesOrderDetailIds)
                {
                    var recalculateResult = await SalesOrderDetailService.RecalculateDeliveredQuantityAsync(salesOrderDetailId);
                    
                    if (!recalculateResult.IsSuccess)
                    {
                        await NotificationService.ShowWarningAsync($"銷貨訂單明細已出貨量更新失敗：{recalculateResult.ErrorMessage}");
                    }
                }
            }

            // 更新主檔總金額
            var totalAmount = salesDeliveryDetails.Sum(d => d.SubtotalAmount);
            if (salesDelivery.TotalAmount != totalAmount)
            {
                salesDelivery.TotalAmount = totalAmount;
                await SalesDeliveryService.UpdateAsync(salesDelivery);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveSalesDeliveryDetailsAsync), GetType());
            throw;
        }
    }

    /// <summary>
    /// 創建出貨明細管理器內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateDeliveryDetailManagerContent() => __builder =>
    {
        <DetailSectionWrapper IsEntityReady="@(editModalComponent?.Entity != null)"
                              EntityLoadingVariant="DetailSectionWrapper.LoadingVariant.Text"
                              EntityLoadingMessage="請先選擇客戶後再管理出貨明細"
                              IsPreconditionMet="@(editModalComponent?.Entity?.CustomerId > 0)"
                              PreconditionMessage="請先選擇客戶後再進行出貨明細管理">
            <SalesDeliveryTable @ref="salesDeliveryDetailManager"
                                TMainEntity="SalesDelivery"
                                TDetailEntity="SalesDeliveryDetail"
                                MainEntity="@editModalComponent!.Entity"
                                ExistingDetails="@salesDeliveryDetails"
                                DataVersion="@_detailsDataVersion"
                                IsParentLoading="@(editModalComponent?.IsLoading ?? false)"
                                OnDetailsChanged="@HandleDeliveryDetailsChanged"
                                OnDeletedDetailsChanged="@HandleDeletedDetailsChanged"
                                OnHasUndeletableDetailsChanged="@HandleHasUndeletableDetailsChanged"
                                ReturnedQuantities="@returnedQuantities"
                                Products="@availableProducts"
                                Warehouses="@warehouses"
                                WarehouseLocations="@warehouseLocations"
                                SelectedCustomerId="@(editModalComponent?.Entity?.CustomerId ?? 0)"
                                SelectedSalesOrderId="@(filterSalesOrderId ?? 0)"
                                FilterProductId="@FilterProductId"
                                SelectedCustomerName="@GetSelectedCustomerName()"
                                SelectedSalesOrderCode="@GetSelectedSalesOrderCode()"
                                FilterProductName="@GetFilterProductName()"
                                TaxCalculationMethod="@(editModalComponent?.Entity?.TaxCalculationMethod ?? TaxCalculationMethod.TaxExclusive)"
                                MainEntityIdPropertyName="@nameof(SalesDeliveryDetail.SalesDeliveryId)"
                                QuantityPropertyName="@nameof(SalesDeliveryDetail.DeliveryQuantity)"
                                UnitPricePropertyName="@nameof(SalesDeliveryDetail.UnitPrice)"
                                RemarksPropertyName="@nameof(SalesDeliveryDetail.Remarks)"
                                WarehouseIdPropertyName="@nameof(SalesDeliveryDetail.WarehouseId)"
                                WarehouseLocationIdPropertyName="@nameof(SalesDeliveryDetail.WarehouseLocationId)"
                                ShowWarehouse="true"
                                ShowWarehouseLocation="false"
                                OnOpenRelatedDocument="@HandleOpenRelatedDocument"
                                IsReadOnly="false" />
        </DetailSectionWrapper>
    };
    
    private RenderFragment CreateReturnTabContent() => __builder =>
    {
        <SalesDeliveryReturnTab @ref="returnTab"
                                OnOpenReturn="@HandleOpenReturnFromTab" />
    };

    private RenderFragment CreateSetoffTabContent() => __builder =>
    {
        <SalesDeliverySetoffTab @ref="setoffTab"
                                OnOpenSetoff="@HandleOpenSetoffFromTab" />
    };

    private RenderFragment CreateOrderTabContent() => __builder =>
    {
        <SalesDeliveryOrderTab @ref="orderTab"
                               OnOpenOrder="@HandleOpenOrderFromTab" />
    };

    private void HandleOpenReturnFromTab(int returnId)
    {
        selectedSalesReturnId = returnId;
        showSalesReturnModal = true;
        StateHasChanged();
    }

    private void HandleOpenSetoffFromTab(int setoffId)
    {
        selectedSetoffDocumentId = setoffId;
        showSetoffDocumentModal = true;
        StateHasChanged();
    }

    private void HandleOpenOrderFromTab(int orderId)
    {
        selectedSalesOrderId = orderId;
        showSalesOrderModal = true;
        StateHasChanged();
    }

    /// <summary>
    /// 取得自訂操作按鈕（顯示在 Modal 頂部左側）- 作為屬性以確保正確的渲染時機
    /// </summary>
    private RenderFragment? GetCustomActionButtons()
    {
        return __builder =>
        {
            @* 轉退貨按鈕 - 新增模式需先儲存，編輯模式直接可用 *@
            @if (canCreateReturn)
            {
                <GenericButtonComponent Text="@L["Button.ConvertToSalesReturn"]"
                                      Variant="ButtonVariant.Red"
                                      Size="ButtonSize.Small"
                                      OnClick="HandleCreateReturnFromDelivery" />
                <GenericButtonComponent Text="@L["Button.ConvertToSetoff"]"
                                      Variant="ButtonVariant.Green"
                                      Size="ButtonSize.Small"
                                      OnClick="HandleCreateSetoffFromDelivery" />
            }
        };
    }
    
    /// <summary>
    /// 從出貨單轉退貨單 - 簡化版本，所有業務驗證交給退貨單 Modal 處理
    /// </summary>
    private async Task HandleCreateReturnFromDelivery()
    {
        try
        {
            // 唯一檢查：確認是否已儲存（新增模式需先儲存，編輯模式直接通過）
            if (!canCreateReturn)
            {
                await NotificationService.ShowWarningAsync("請先儲存出貨單後，才能轉退貨");
                return;
            }
            
            // 安全檢查：確保 Entity 已載入（canCreateReturn = true 時理論上一定有值）
            if (editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("出貨單資料載入失敗，請重新整理頁面");
                return;
            }
            
            // 檢查是否有客戶資料
            if (editModalComponent.Entity.CustomerId <= 0)
            {
                await NotificationService.ShowWarningAsync("出貨單缺少客戶資訊，無法轉退貨");
                return;
            }
            
            // 檢查是否有明細資料
            if (!salesDeliveryDetails.Any())
            {
                await NotificationService.ShowWarningAsync("出貨單沒有明細資料，無法轉退貨");
                return;
            }
            
            // 檢查是否所有明細都已完成退貨（已退貨數量 >= 出貨數量）
            bool hasIncompleteDetails = false;
            foreach (var detail in salesDeliveryDetails)
            {
                var returnedQty = await SalesReturnDetailService.GetReturnedQuantityByDeliveryDetailAsync(detail.Id);
                if (detail.DeliveryQuantity > returnedQty)
                {
                    hasIncompleteDetails = true;
                    break;
                }
            }
            
            if (!hasIncompleteDetails)
            {
                await NotificationService.ShowWarningAsync("出貨單所有明細皆已完成退貨，無需再轉單");
                return;
            }
            
            // 直接開啟退貨單 Modal，使用 Entity.Id 作為出貨單 ID（最可靠的來源）
            await salesReturnEditModal!.ShowAddModalWithPrefilledDelivery(
                editModalComponent.Entity.CustomerId,
                editModalComponent.Entity.Id  // 使用 Entity.Id 而非 SalesDeliveryId 參數
            );
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCreateReturnFromDelivery), GetType(), 
                additionalData: $"轉退貨單失敗 - DeliveryId: {editModalComponent?.Entity?.Id}");
            await NotificationService.ShowErrorAsync($"轉退貨時發生錯誤: {ex.Message}");
        }
    }
    
    /// <summary>
    /// 處理退貨單儲存後的事件（出貨單轉單）
    /// 使用 ChildDocumentRefreshHelper 統一處理刷新邏輯
    /// </summary>
    private async Task HandleSalesReturnSaved(SalesReturn savedSalesReturn)
    {
        try
        {
            // 使用統一 Helper 處理子單據儲存後的刷新邏輯
            await ChildDocumentRefreshHelper.HandleChildDocumentSavedAsync(
                closeModal: () =>
                {
                    showSalesReturnModal = false;
                    selectedSalesReturnId = null;
                },
                reloadDetails: async () =>
                {
                    //  關鍵修復：從資料庫重新載入明細資料
                    // 這確保 ReturnedQuantity 等欄位都是最新的資料
                    if (editModalComponent?.Entity?.Id > 0)
                    {
                        await LoadSalesDeliveryDetailsInternal(editModalComponent.Entity.Id);
                    }
                },
                detailManager: salesDeliveryDetailManager,
                notificationMessage: $"退貨單 {savedSalesReturn.Code} 已更新，出貨明細已刷新",
                stateHasChanged: StateHasChanged,
                invokeAsync: InvokeAsync,
                additionalActions: async () =>
                {
                    //  關鍵修復：先確保 UI 更新（參數傳遞），再刷新 Table 組件
                    // 這樣可以確保 SalesDeliveryTable 的 ExistingDetails 參數已收到最新的 salesDeliveryDetails
                    await InvokeAsync(StateHasChanged);
                    
                    // 延遲一小段時間，確保 Blazor 完成參數綁定
                    await Task.Delay(50);
                    
                    // 呼叫 Table 組件的公開刷新方法來更新 UI 顯示
                    if (salesDeliveryDetailManager != null)
                    {
                        await salesDeliveryDetailManager.RefreshDetailsAsync();
                    }
                }
            );
            
            await NotificationService.ShowSuccessAsync($"已成功從出貨單轉為退貨單（退貨單編號：{savedSalesReturn.Code}）");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSalesReturnSaved), GetType());
        }
    }
    
    /// <summary>
    /// 處理沖款單儲存後的事件
    /// </summary>
    private async Task HandleSetoffDocumentSaved(SetoffDocument savedDocument)
    {
        try
        {
            showSetoffDocumentModal = false;
            await NotificationService.ShowSuccessAsync("沖款單已更新");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理沖款單儲存事件失敗：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 處理開啟相關單據的事件（從 SalesDeliveryTable 的相關單據 Modal 點擊觸發）
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            if (args.type == RelatedDocumentType.ReturnDocument)
            {
                // 開啟銷貨退貨 Modal
                selectedSalesReturnId = args.id;
                showSalesReturnModal = true;
            }
            else if (args.type == RelatedDocumentType.SetoffDocument)
            {
                // 開啟沖款單 Modal
                selectedSetoffDocumentId = args.id;
                showSetoffDocumentModal = true;
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"開啟單據失敗：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 從出貨單轉沖款單
    /// </summary>
    private async Task HandleCreateSetoffFromDelivery()
    {
        try
        {
            // 1. 驗證出貨單資料
            if (!SalesDeliveryId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("無法轉沖款：出貨單資料不存在");
                return;
            }
            
            // 2. 驗證客戶資料
            if (editModalComponent.Entity.CustomerId <= 0)
            {
                await NotificationService.ShowWarningAsync("出貨單缺少客戶資訊，無法轉沖款");
                return;
            }
            
            // 3. 檢查是否有明細
            if (!salesDeliveryDetails.Any())
            {
                await NotificationService.ShowWarningAsync("出貨單沒有明細資料，無法轉沖款");
                return;
            }
            
            // 4. 檢查是否有可沖款的明細（有未結清餘額）
            bool hasUnsettledDetails = salesDeliveryDetails
                .Any(detail => detail.SubtotalAmount > detail.TotalReceivedAmount && !detail.IsSettled);
            
            if (!hasUnsettledDetails)
            {
                await NotificationService.ShowWarningAsync("出貨單所有明細皆已完成沖款，無需再轉沖款");
                return;
            }
            
            // 5. 呼叫沖款單組件的公開方法
            await setoffDocumentEditModal!.ShowAddModalWithPrefilledDelivery(
                editModalComponent.Entity.CustomerId,
                SalesDeliveryId.Value
            );
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCreateSetoffFromDelivery), GetType(), 
                additionalData: $"轉沖款失敗 - SalesDeliveryId: {SalesDeliveryId}");
            await NotificationService.ShowErrorAsync("轉沖款時發生錯誤");
        }
    }
    
    // ===== ActionButton 產生方法 =====
    
    // ===== 輔助方法：取得選項名稱 =====
    
    private string? GetSelectedCustomerName()
        => EntityDisplayHelper.GetDisplayValue(editModalComponent?.Entity?.CustomerId, customers, c => c.CompanyName);

    private string? GetSelectedSalesOrderCode()
        => EntityDisplayHelper.GetDisplayValue(filterSalesOrderId, salesOrders, so => so.Code);

    private string? GetFilterProductName()
        => EntityDisplayHelper.GetDisplayValue(filterProductId, availableProducts, p => $"{p.Code} {p.Name}");
}
