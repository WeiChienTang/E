@inject ISalesDeliveryService SalesDeliveryService
@inject ISalesDeliveryDetailService SalesDeliveryDetailService
@inject ISalesOrderService SalesOrderService
@inject ISalesOrderDetailService SalesOrderDetailService
@inject ISalesReturnDetailService SalesReturnDetailService
@inject ICustomerService CustomerService
@inject IProductService ProductService
@inject IEmployeeService EmployeeService
@inject IUnitService UnitService
@inject IWarehouseService WarehouseService
@inject IWarehouseLocationService WarehouseLocationService
@inject ISystemParameterService SystemParameterService
@inject INotificationService NotificationService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ActionButtonHelper ActionButtonHelper
@inject ERPCore2.Data.Context.AppDbContext DbContext

<GenericEditModalComponent TEntity="SalesDelivery" 
                          TService="ISalesDeliveryService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@SalesDeliveryId"
                          Service="@SalesDeliveryService"
                          EntityName="å‡ºè²¨å–®"
                          EntityNamePlural="å‡ºè²¨å–®"
                          ModalTitle="@(SalesDeliveryId.HasValue ? "ç·¨è¼¯å‡ºè²¨å–®" : "æ–°å¢å‡ºè²¨å–®")"
                          Size="GenericEditModalComponent<SalesDelivery, ISalesDeliveryService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          AutoCompleteCollections="@(autoCompleteConfig?.Collections)"
                          AutoCompleteDisplayProperties="@(autoCompleteConfig?.DisplayProperties)"
                          AutoCompleteValueProperties="@(autoCompleteConfig?.ValueProperties)"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadSalesDeliveryData"
                          UseGenericSave="true"
                          CustomValidator="@ValidateSalesDeliveryDetailsAsync"
                          AfterSave="@SaveSalesDeliveryDetailsAsync"
                          SaveSuccessMessage="@(SalesDeliveryId.HasValue ? "å‡ºè²¨å–®æ›´æ–°æˆåŠŸ" : "å‡ºè²¨å–®æ–°å¢æˆåŠŸ")"
                          SaveFailureMessage="å‡ºè²¨å–®å„²å­˜å¤±æ•—"
                          RequiredPermission="SalesDelivery.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          GetStatusMessage="@GetSalesDeliveryStatusMessage"
                          FormHeaderContent="@GetWarningMessage()"
                          CustomModules="@GetCustomModules()"
                          CustomActionButtons="@CustomActionButtons"
                          OnEntityLoaded="@HandleEntityLoaded">
</GenericEditModalComponent>

@* å®¢æˆ¶ç·¨è¼¯ Modal *@
<CustomerEditModalComponent @ref="customerEditModal"
                           IsVisible="@customerModalManager.IsModalVisible"
                           IsVisibleChanged="@customerModalManager.HandleModalVisibilityChangedAsync"
                           CustomerId="@customerModalManager.SelectedEntityId"
                           OnCustomerSaved="@OnCustomerSavedWrapper"
                           OnCancel="@customerModalManager.HandleModalCancelAsync" />

@* æ¥­å‹™å“¡ç·¨è¼¯ Modal *@
<EmployeeEditModalComponent @ref="employeeEditModal"
                           IsVisible="@employeeModalManager.IsModalVisible"
                           IsVisibleChanged="@employeeModalManager.HandleModalVisibilityChangedAsync"
                           EmployeeId="@employeeModalManager.SelectedEntityId"
                           OnEmployeeSaved="@OnEmployeeSavedWrapper"
                           OnCancel="@employeeModalManager.HandleModalCancelAsync" />

@* éŠ·è²¨é€€è²¨ç·¨è¼¯ Modal *@
<SalesReturnEditModalComponent @ref="salesReturnEditModal"
                              IsVisible="@showSalesReturnModal"
                              IsVisibleChanged="@((bool visible) => showSalesReturnModal = visible)"
                              SalesReturnId="@selectedSalesReturnId"
                              OnSalesReturnSaved="@HandleSalesReturnSaved"
                              OnCancel="@(() => showSalesReturnModal = false)" />

@code {
    // ===== å¿…è¦åƒæ•¸ =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SalesDeliveryId { get; set; }
    [Parameter] public EventCallback<SalesDelivery> OnSalesDeliverySaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    
    // ===== é å¡«åƒæ•¸ï¼ˆç”¨æ–¼å¾éŠ·å”®è¨‚å–®è½‰å–®ï¼‰ =====
    [Parameter] public int? PrefilledCustomerId { get; set; }
    [Parameter] public int? PrefilledSalesOrderId { get; set; }

    // ===== å…§éƒ¨ç‹€æ…‹ =====
    private GenericEditModalComponent<SalesDelivery, ISalesDeliveryService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // åŸå§‹è³‡æ–™é›†åˆï¼ˆç”¨æ–¼ AutoCompleteï¼‰
    private List<Customer> availableCustomers = new();
    private List<Employee> availableEmployees = new();
    private List<Product> availableProducts = new();
    private List<Unit> availableUnits = new();
    private List<Warehouse> availableWarehouses = new();
    private List<SalesOrder> availableSalesOrders = new();
    
    // AutoComplete é…ç½®
    private AutoCompleteConfig? autoCompleteConfig;
    
    // éŠ·è²¨å‡ºè²¨æ˜ç´°
    private List<SalesDeliveryDetail> salesDeliveryDetails = new();
    
    // æ˜ç´°ç®¡ç†çµ„ä»¶å¼•ç”¨
    private SalesDeliveryTable<SalesDelivery, SalesDeliveryDetail>? salesDeliveryDetailManager;
    
    // é€€è²¨æ•¸é‡å¿«å–å­—å…¸ï¼ˆKey: DetailId, Value: å·²é€€è²¨æ•¸é‡ï¼‰
    private Dictionary<int, decimal> returnedQuantities = new();
    
    // ===== æ˜ç´°è¼‰å…¥ç‹€æ…‹ =====
    private bool shouldAutoLoadUndelivered = false;  // æ¨™è¨˜æ˜¯å¦éœ€è¦è‡ªå‹•è¼‰å…¥æœªå‡ºè²¨å•†å“
    private bool isDetailDataReady = false;  // æ¨™è¨˜æ˜ç´°ç›¸é—œè³‡æ–™æ˜¯å¦å·²å®Œæ•´è¼‰å…¥ï¼ˆåŒ…æ‹¬é€€è²¨æ•¸é‡ï¼‰
    
    // ===== è½‰å–®ç‹€æ…‹ =====
    private bool canCreateReturn = false;  // æ˜¯å¦å¯ä»¥è½‰é€€è²¨ï¼ˆæ–°å¢æ¨¡å¼éœ€å…ˆå„²å­˜ï¼Œç·¨è¼¯æ¨¡å¼ç›´æ¥ç‚º trueï¼‰
    
    // ===== é–å®šç‹€æ…‹ =====
    private bool hasUndeletableDetails = false;  // æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²æœ‰é€€è²¨è¨˜éŒ„ï¼‰
    
    // Modal Manager é›†åˆ
    private ModalManagerCollection? modalManagers;
    
    // Modal ç®¡ç†å™¨
    private CustomerEditModalComponent? customerEditModal;
    private RelatedEntityModalManager<Customer> customerModalManager = default!;
    private EmployeeEditModalComponent? employeeEditModal;
    private RelatedEntityModalManager<Employee> employeeModalManager = default!;
    
    // ===== ç›¸é—œå–®æ“š Modal =====
    private SalesReturnEditModalComponent? salesReturnEditModal;
    private bool showSalesReturnModal = false;
    private int? selectedSalesReturnId = null;
    
    // ä¸‹æ‹‰é¸å–®é¸é …ï¼ˆå‘ä¸‹ç›¸å®¹ï¼‰
    private List<Customer> customers = new();
    private List<Employee> employees = new();
    private List<Warehouse> warehouses = new();
    private List<WarehouseLocation> warehouseLocations = new();
    private List<SalesOrder> salesOrders = new();
    private List<SelectOption> customerOptions = new();
    private List<SelectOption> employeeOptions = new();
    private List<SelectOption> warehouseOptions = new();
    private List<SelectOption> salesOrderOptions = new();
    private List<SelectOption> taxCalculationMethodOptions = new();
    
    // ç¨…ç‡å¿«å–è®Šæ•¸
    private decimal currentTaxRate = 5.0m;
    
    // è³‡æ–™è¼‰å…¥ç‹€æ…‹æ¨™è¨˜
    private bool isDataLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // ä½¿ç”¨ ModalManagerInitHelper åˆå§‹åŒ–æ‰€æœ‰ Manager
            modalManagers = ModalManagerInitHelper.CreateBuilder<SalesDelivery, ISalesDeliveryService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Customer>(nameof(SalesDelivery.CustomerId), "å®¢æˆ¶")
                .AddManager<Employee>(nameof(SalesDelivery.EmployeeId), "æ¥­å‹™å“¡")
                .Build();
            
            // å–å¾—å€‹åˆ¥ Manager ä¾›çµ„ä»¶ä½¿ç”¨
            customerModalManager = modalManagers.Get<Customer>(nameof(SalesDelivery.CustomerId));
            employeeModalManager = modalManagers.Get<Employee>(nameof(SalesDelivery.EmployeeId));
            
            // ç§»é™¤è‡ªå‹•è¼‰å…¥è³‡æ–™ï¼Œæ”¹ç‚ºåœ¨ OnParametersSetAsync ä¸­æ ¹æ“š IsVisible è¼‰å…¥
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–å‡ºè²¨å–®ç·¨è¼¯çµ„ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
        }
    }

    private async Task HandleSaveSuccess()
    {
        try
        {
            // å„²å­˜æˆåŠŸå¾Œå…è¨±è½‰é€€è²¨
            canCreateReturn = true;
            
            // é‡æ–°è¼‰å…¥å‰›å„²å­˜çš„æ˜ç´°è³‡æ–™
            if (editModalComponent?.Entity != null && editModalComponent.Entity.Id > 0)
            {
                await LoadSalesDeliveryDetailsInternal(editModalComponent.Entity.Id);
                
                // åˆ·æ–° Table å…ƒä»¶
                if (salesDeliveryDetailManager != null)
                {
                    await salesDeliveryDetailManager.RefreshDetailsAsync();
                }
                
                StateHasChanged();
            }
            
            if (OnSalesDeliverySaved.HasDelegate && editModalComponent?.Entity != null)
            {
                await OnSalesDeliverySaved.InvokeAsync(editModalComponent.Entity);
            }
            // CloseModal å·²ç”± GenericEditModalComponent çµ±ä¸€æ§åˆ¶
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSaveSuccess), GetType(), 
                additionalData: "è™•ç†å‡ºè²¨å–®å„²å­˜æˆåŠŸäº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    private async Task HandleCancel()
    {
        try
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCancel), GetType(), 
                additionalData: "å‡ºè²¨å–®ç·¨è¼¯Modalå–æ¶ˆè™•ç†å¤±æ•—");
        }
    }

    private async Task CloseModal()
    {
        try
        {
            if (IsVisibleChanged.HasDelegate)
            {
                await IsVisibleChanged.InvokeAsync(false);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(CloseModal), GetType(), 
                additionalData: "å‡ºè²¨å–®ç·¨è¼¯Modalé—œé–‰å¤±æ•—");
        }
    }

    /// <summary>
    /// å–å¾—å‡ºè²¨å–®ç‹€æ…‹è¨Šæ¯ï¼ˆé¡¯ç¤ºé–å®šç‹€æ…‹ï¼‰
    /// </summary>
    private async Task<(string Message, GenericEditModalComponent<SalesDelivery, ISalesDeliveryService>.BadgeVariant Variant, string IconClass)?> GetSalesDeliveryStatusMessage()
    {
        try
        {
            if (!isDetailDataReady)
            {
                return null;
            }

            if (hasUndeletableDetails)
            {
                return (
                    "éƒ¨åˆ†æ˜ç´°å·²æœ‰é€€è²¨è¨˜éŒ„ï¼Œå®¢æˆ¶å’Œè¨‚å–®æ¬„ä½å·²é–å®š",
                    GenericEditModalComponent<SalesDelivery, ISalesDeliveryService>.BadgeVariant.Warning,
                    "fas fa-lock"
                );
            }

            return null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetSalesDeliveryStatusMessage), GetType());
            return null;
        }
    }

    /// <summary>
    /// å–å¾—è­¦å‘Šè¨Šæ¯ï¼ˆé¡¯ç¤ºåœ¨è¡¨å–®æœ€ä¸Šæ–¹ï¼‰
    /// </summary>
    private RenderFragment? GetWarningMessage() => __builder =>
    {
        <GenericLockedFieldMessage IsVisible="@(isDetailDataReady && hasUndeletableDetails)"
                                  Message="éƒ¨åˆ†æ˜ç´°å·²æœ‰é€€è²¨è¨˜éŒ„ï¼Œä¸»æª”çš„å®¢æˆ¶å’Œè¨‚å–®æ¬„ä½å·²è¢«é–å®šï¼Œç„¡æ³•ä¿®æ”¹ã€‚" />
    };

    /// <summary>
    /// é–‹å•Ÿæ–°å¢å‡ºè²¨å–® Modal ä¸¦é å¡«éŠ·å”®è¨‚å–®è³‡è¨Šï¼ˆå…¬é–‹æ–¹æ³•ä¾›å¤–éƒ¨èª¿ç”¨ï¼‰
    /// </summary>
    /// <summary>
    /// æ‰“é–‹æ–°å¢éŠ·è²¨å‡ºè²¨å–® Modal ä¸¦é å¡«éŠ·è²¨è¨‚å–®è³‡æ–™ï¼ˆå…¬é–‹æ–¹æ³•ï¼Œä¾›çˆ¶çµ„ä»¶å‘¼å«ï¼‰
    /// </summary>
    public async Task ShowAddModalWithPrefilledOrder(int customerId, int salesOrderId)
    {
        try
        {
            // ä½¿ç”¨ DocumentConversionHelper çµ±ä¸€è™•ç†è½‰å–®é‚è¼¯ï¼ˆåƒç…§æ¡è³¼æ¨¡çµ„ï¼‰
            var success = await DocumentConversionHelper.ShowConversionModalAsync(
                setPrefilledValues: () =>
                {
                    SalesDeliveryId = null;
                    PrefilledCustomerId = customerId;
                    PrefilledSalesOrderId = salesOrderId;
                    shouldAutoLoadUndelivered = true;  // ğŸ”‘ æ¨™è¨˜éœ€è¦è‡ªå‹•è¼‰å…¥
                },
                isVisibleChanged: IsVisibleChanged,
                autoLoadAction: async () =>
                {
                    shouldAutoLoadUndelivered = false;
                    if (salesDeliveryDetailManager != null)
                    {
                        await salesDeliveryDetailManager.LoadAllUndeliveredItems();
                    }
                },
                detailManagerReady: () => salesDeliveryDetailManager != null,
                shouldAutoLoad: () => shouldAutoLoadUndelivered,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("è½‰å–®æµç¨‹åŸ·è¡Œå¤±æ•—");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledOrder), GetType(), 
                additionalData: $"é–‹å•Ÿé å¡«å‡ºè²¨å–®Modalå¤±æ•— - CustomerId: {customerId}, SalesOrderId: {salesOrderId}");
            await NotificationService.ShowErrorAsync("é–‹å•Ÿå‡ºè²¨å–®æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    private async Task<SalesDelivery?> LoadSalesDeliveryData()
    {
        try
        {
            if (!SalesDeliveryId.HasValue)
            {
                // æ–°å¢æ¨¡å¼ - è‡ªå‹•ç”¢ç”Ÿå‡ºè²¨å–®è™Ÿ
                var generatedCode = await EntityCodeGenerationHelper.GenerateForEntity<SalesDelivery, ISalesDeliveryService>(SalesDeliveryService, DbContext);
                
                var newDelivery = new SalesDelivery
                {
                    DeliveryDate = DateTime.Today,
                    Status = EntityStatus.Active,
                    TotalAmount = 0,
                    Code = generatedCode,
                    IsShipped = false,
                    IsApproved = false
                };
                
                // æ–°å¢æ¨¡å¼ï¼šå¿…é ˆå…ˆå„²å­˜æ‰èƒ½è½‰é€€è²¨
                canCreateReturn = false;
                
                // ğŸ”‘ ä¿®æ­£ï¼šä¸åœ¨é€™è£¡è¼‰å…¥æ˜ç´°ï¼Œæ”¹ç‚ºè¨­å®šé å¡«å€¼å¾Œç”± DocumentConversionHelper è§¸ç™¼è‡ªå‹•è¼‰å…¥
                // é€™æ¨£å¯ä»¥ç¢ºä¿ SalesDeliveryTable çµ„ä»¶å·²ç¶“æ¸²æŸ“å®Œæˆ
                if (PrefilledSalesOrderId.HasValue)
                {
                    newDelivery.SalesOrderId = PrefilledSalesOrderId.Value;
                    // è¼‰å…¥è¨‚å–®åŸºæœ¬è³‡æ–™ï¼ˆå®¢æˆ¶ã€æ¥­å‹™å“¡ç­‰ï¼‰
                    var salesOrder = await SalesOrderService.GetWithDetailsAsync(PrefilledSalesOrderId.Value);
                    if (salesOrder != null)
                    {
                        newDelivery.CustomerId = salesOrder.CustomerId;
                        newDelivery.EmployeeId = salesOrder.EmployeeId;
                    }
                    // æ˜ç´°è¼‰å…¥æœƒåœ¨ OnAfterRenderAsync ä¸­ç”± DocumentConversionHelper è‡ªå‹•è§¸ç™¼
                }
                else if (PrefilledCustomerId.HasValue)
                {
                    newDelivery.CustomerId = PrefilledCustomerId.Value;
                }
                
                if (!PrefilledSalesOrderId.HasValue)
                {
                    salesDeliveryDetails.Clear();
                }
                
                return newDelivery;
            }

            // ç·¨è¼¯æ¨¡å¼ - è¼‰å…¥éŠ·è²¨å‡ºè²¨å–®å’Œæ˜ç´°
            canCreateReturn = true;  // ç·¨è¼¯æ¨¡å¼ï¼šå¯ä»¥ç›´æ¥è½‰é€€è²¨
            var salesDelivery = await SalesDeliveryService.GetByIdAsync(SalesDeliveryId.Value);
            
            if (salesDelivery != null)
            {
                // è¼‰å…¥éŠ·è²¨å‡ºè²¨æ˜ç´°
                await LoadSalesDeliveryDetailsInternal(SalesDeliveryId.Value);
                StateHasChanged();
                
                // é‡æ–°åˆå§‹åŒ–è¡¨å–®æ¬„ä½
                await Task.Delay(10);
                _ = Task.Run(async () =>
                {
                    await InvokeAsync(async () =>
                    {
                        await InitializeFormFieldsAsync();
                        StateHasChanged();
                    });
                });
                
                StateHasChanged();
            }
            else
            {
            }
            
            return salesDelivery;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSalesDeliveryData), GetType(), 
                additionalData: $"è¼‰å…¥å‡ºè²¨å–®è³‡æ–™å¤±æ•— - ID: {SalesDeliveryId}");
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å‡ºè²¨å–®è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return null;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // è¼‰å…¥å®¢æˆ¶é¸é …
            customers = await CustomerService.GetAllAsync();
            availableCustomers = customers;
            customerOptions = customers.Where(c => c.Status == EntityStatus.Active)
                .Select(c => new SelectOption
                {
                    Text = c.CompanyName ?? "",
                    Value = c.Id.ToString()
                }).ToList();

            // è¼‰å…¥å“¡å·¥é¸é …
            employees = await EmployeeService.GetAllAsync();
            availableEmployees = employees;
            employeeOptions = employees.Where(e => e.Status == EntityStatus.Active)
                .Select(e => new SelectOption
                {
                    Text = e.Name ?? string.Empty,
                    Value = e.Id.ToString()
                }).ToList();

            // è¼‰å…¥å€‰åº«é¸é …
            warehouses = await WarehouseService.GetAllAsync();
            availableWarehouses = warehouses;
            warehouseOptions = warehouses.Where(w => w.Status == EntityStatus.Active)
                .Select(w => new SelectOption
                {
                    Text = w.Name,
                    Value = w.Id.ToString()
                }).ToList();

            // è¼‰å…¥å€‰åº«ä½ç½®é¸é …
            warehouseLocations = await WarehouseLocationService.GetAllAsync();

            // è¼‰å…¥éŠ·å”®è¨‚å–®
            salesOrders = await SalesOrderService.GetAllAsync();
            availableSalesOrders = salesOrders;
            salesOrderOptions = salesOrders.Where(so => so.Status == EntityStatus.Active)
                .Select(so => new SelectOption
                {
                    Text = so.Code ?? string.Empty,
                    Value = so.Id.ToString()
                }).ToList();

            // è¼‰å…¥å•†å“è³‡æ–™
            availableProducts = await ProductService.GetAllAsync();

            // è¼‰å…¥å–®ä½è³‡æ–™
            availableUnits = await UnitService.GetAllAsync();
            
            // åˆå§‹åŒ–ç¨…åˆ¥é¸é …
            taxCalculationMethodOptions = new List<SelectOption>
            {
                new SelectOption { Value = ((int)TaxCalculationMethod.TaxExclusive).ToString(), Text = "å¤–åŠ ç¨…" },
                new SelectOption { Value = ((int)TaxCalculationMethod.TaxInclusive).ToString(), Text = "å…§å«ç¨…" },
                new SelectOption { Value = ((int)TaxCalculationMethod.NoTax).ToString(), Text = "ä¸å«ç¨…" }
            };
            
            // è¼‰å…¥ç³»çµ±ç¨…ç‡
            currentTaxRate = await TaxCalculationHelper.LoadTaxRateAsync(SystemParameterService);
            
            // é…ç½® AutoComplete
            autoCompleteConfig = new AutoCompleteConfigBuilder<SalesDelivery>()
                .AddField(nameof(SalesDelivery.CustomerId), "CompanyName", availableCustomers)
                .AddField(nameof(SalesDelivery.EmployeeId), "Name", availableEmployees)
                .AddField(nameof(SalesDelivery.WarehouseId), "Name", availableWarehouses)
                .AddField(nameof(SalesDelivery.SalesOrderId), "Code", availableSalesOrders)
                .Build();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadAdditionalDataAsync), GetType(), 
                additionalData: "å‡ºè²¨å–®ç·¨è¼¯Modalè¼‰å…¥é¡å¤–è³‡æ–™å¤±æ•—");
            
            customerOptions = new List<SelectOption>();
            employeeOptions = new List<SelectOption>();
            warehouseOptions = new List<SelectOption>();
            salesOrderOptions = new List<SelectOption>();
            availableProducts = new List<Product>();
            availableUnits = new List<Unit>();
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SalesDelivery.Code),
                    Label = "å‡ºè²¨å–®è™Ÿ",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥å‡ºè²¨å–®è™Ÿ",
                    IsRequired = true,
                    MaxLength = 30,
                    HelpText = "å‡ºè²¨å–®çš„å”¯ä¸€ç·¨è™Ÿï¼Œæ–°å¢æ™‚ç³»çµ±æœƒè‡ªå‹•ç”¢ç”Ÿï¼Œä¹Ÿå¯æ‰‹å‹•ä¿®æ”¹"
                },
                new()
                {
                    PropertyName = nameof(SalesDelivery.CustomerId),
                    Label = "å®¢æˆ¶",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡å®¢æˆ¶",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "è¼¸å…¥å®¢æˆ¶åç¨±é€²è¡Œæœå°‹ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                    ActionButtons = await GetCustomerActionButtonsAsync()
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesDelivery.SalesOrderId),
                    Label = "è¨‚å–®",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹é¸æ“‡è¨‚å–®å–®è™Ÿ",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "é¸æ“‡é—œè¯çš„è¨‚å–®å–®è™Ÿï¼ˆå¯é¸ï¼‰"
                },
                new()
                {
                    PropertyName = nameof(SalesDelivery.EmployeeId),
                    Label = "æ¥­å‹™å“¡",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹é¸æ“‡æ¥­å‹™å“¡",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "é¸æ“‡è² è²¬æ­¤å‡ºè²¨çš„æ¥­å‹™å“¡",
                    ActionButtons = await GetEmployeeActionButtonsAsync()
                },
                new()
                {
                    PropertyName = nameof(SalesDelivery.DeliveryDate),
                    Label = "å‡ºè²¨æ—¥æœŸ",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "å‡ºè²¨æ—¥æœŸ"
                },
                new()
                {
                    PropertyName = nameof(SalesDelivery.TaxCalculationMethod),
                    Label = "ç¨…åˆ¥",
                    FieldType = FormFieldType.Select,
                    IsRequired = true,
                    Options = taxCalculationMethodOptions,
                    HelpText = "é¸æ“‡è©²å‡ºè²¨å–®çš„è¨ˆç¨…æ–¹å¼ï¼ˆå¤–åŠ ç¨…/å…§å«ç¨…/ä¸å«ç¨…ï¼‰"
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesDelivery.TotalAmount),
                    Label = "é‡‘é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "ç³»çµ±æ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—ï¼ˆæŠ˜æ‰£å‰é‡‘é¡ï¼‰",
                    CssClass = "text-warning fw-bold"
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesDelivery.DiscountAmount),
                    Label = "æŠ˜æ‰£",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "ç³»çµ±æ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®— = (æ•¸é‡ Ã— å–®åƒ¹ Ã— æŠ˜æ‰£%)",
                    CssClass = "text-danger fw-bold"
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SalesDelivery.TaxAmount),
                    Label = "ç¨…é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "ç³»çµ±æ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®— = (æŠ˜æ‰£å¾Œé‡‘é¡ Ã— ç¨…ç‡%)",
                    CssClass = "text-info fw-bold"
                },
                new()
                {
                    PropertyName = nameof(SalesDelivery.TotalAmountWithTax),
                    Label = "ç¸½é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "ç³»çµ±æ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—ï¼ˆé‡‘é¡ - æŠ˜æ‰£ + ç¨…é¡ï¼‰",
                    CssClass = "text-success fw-bold"
                },
                    FormFieldConfigurationHelper.CreateRemarksField<SalesDelivery>()
            };


            formSections = FormSectionHelper<SalesDelivery>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    sd => sd.Code,
                    sd => sd.CustomerId,
                    sd => sd.SalesOrderId,
                    sd => sd.EmployeeId,
                    sd => sd.DeliveryDate,
                    sd => sd.TaxCalculationMethod)
                .AddToSection(FormSectionNames.AmountInfo,
                    sd => sd.TotalAmount,
                    sd => sd.DiscountAmount,
                    sd => sd.TaxAmount,
                    sd => sd.TotalAmountWithTax)
                .AddToSection(FormSectionNames.OtherInfo,
                    sd => sd.DeliveryAddress,
                    sd => sd.Remarks)
                .Build();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(InitializeFormFieldsAsync), GetType());
        }
    }

    // ===== è‡ªå‹•ç”¢ç”Ÿå–®è™Ÿ =====
    // ===== å¾éŠ·å”®è¨‚å–®è¼‰å…¥è³‡æ–™ =====
    private async Task LoadDataFromSalesOrder(SalesDelivery delivery, int salesOrderId)
    {
        try
        {
            var salesOrder = await SalesOrderService.GetWithDetailsAsync(salesOrderId);
            if (salesOrder == null) return;

            delivery.SalesOrderId = salesOrderId;
            delivery.CustomerId = salesOrder.CustomerId;
            delivery.EmployeeId = salesOrder.EmployeeId;

            var orderDetails = await SalesOrderDetailService.GetBySalesOrderIdAsync(salesOrderId);
            salesDeliveryDetails.Clear();

            foreach (var orderDetail in orderDetails)
            {
                var remainingQty = orderDetail.OrderQuantity - orderDetail.DeliveredQuantity;
                if (remainingQty > 0)
                {
                    salesDeliveryDetails.Add(new SalesDeliveryDetail
                    {
                        SalesOrderDetailId = orderDetail.Id,
                        ProductId = orderDetail.ProductId,
                        DeliveryQuantity = remainingQty,
                        UnitPrice = orderDetail.UnitPrice,
                        UnitId = orderDetail.UnitId
                    });
                }
            }

            await NotificationService.ShowSuccessAsync($"å·²å¾è¨‚å–® {salesOrder.Code} è¼‰å…¥è³‡æ–™");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDataFromSalesOrder), GetType());
            await NotificationService.ShowErrorAsync("è¼‰å…¥è¨‚å–®è³‡æ–™å¤±æ•—");
        }
    }

    
    // ===== è¼‰å…¥æ˜ç´° =====
    
    /// <summary>
    /// è™•ç†å¯¦é«”è¼‰å…¥å®Œæˆäº‹ä»¶ï¼ˆç”± GenericEditModalComponent çš„å°èˆªè§¸ç™¼ï¼‰
    /// ç•¶ä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼Œé‡æ–°è¼‰å…¥å°æ‡‰çš„æ˜ç´°è³‡æ–™
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            // 1. é‡æ–°è¼‰å…¥æ˜ç´°è³‡æ–™
            await LoadSalesDeliveryDetailsInternal(loadedEntityId);
            
            // ğŸ”‘ é—œéµä¿®æ­£ï¼šç«‹å³è§¸ç™¼ UI æ›´æ–°ï¼Œç¢ºä¿ Table å…ƒä»¶æ”¶åˆ°æ–°çš„ ExistingDetails åƒæ•¸
            // é€™æ¨£ RefreshDetailsAsync() æ‰èƒ½è®€å–åˆ°æ­£ç¢ºçš„æ˜ç´°è³‡æ–™ï¼ˆèˆ‡ QuotationEditModalComponent ä¿æŒä¸€è‡´ï¼‰
            StateHasChanged();
            
            // 2. è§¸ç™¼ Table å…ƒä»¶åˆ·æ–°ï¼ˆæ­¤æ™‚ ExistingDetails å·²ç¶“æ˜¯æ–°çš„è³‡æ–™ï¼‰
            if (salesDeliveryDetailManager != null)
            {
                await salesDeliveryDetailManager.RefreshDetailsAsync();
            }
            
            // 3. æœ€å¾Œå†æ¬¡æ›´æ–° UIï¼ˆç¢ºä¿æ‰€æœ‰è®Šæ›´éƒ½åæ˜ åœ¨ç•«é¢ä¸Šï¼‰
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleEntityLoaded), GetType(), 
                additionalData: $"è™•ç†å¯¦é«”è¼‰å…¥äº‹ä»¶å¤±æ•— - EntityId: {loadedEntityId}");
            await NotificationService.ShowErrorAsync("è¼‰å…¥æ˜ç´°è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    private async Task LoadSalesDeliveryDetailsInternal(int salesDeliveryId)
    {
        try
        {
            // ğŸ”‘ é—œéµä¿®æ­£ï¼šä½¿ç”¨ GetWithDetailsAsync é‡æ–°è¼‰å…¥å®Œæ•´å¯¦é«”ï¼ˆåŒ…å«é—œè¯è³‡æ–™ï¼‰
            // é€™ç¢ºä¿ Product ç­‰é—œè¯ç‰©ä»¶éƒ½å·²è¼‰å…¥ï¼Œèˆ‡ QuotationEditModalComponent ä¿æŒä¸€è‡´
            var salesDelivery = await SalesDeliveryService.GetByIdAsync(salesDeliveryId);
            salesDeliveryDetails = await SalesDeliveryDetailService.GetByDeliveryIdAsync(salesDeliveryId);
            
            // ğŸ”‘ é—œéµï¼šè¼‰å…¥é€€è²¨æ•¸é‡è³‡æ–™ï¼Œç”¨æ–¼åˆ¤æ–·æ˜¯å¦å¯åˆªé™¤æ˜ç´°
            await LoadDetailRelatedDataAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSalesDeliveryDetailsInternal), GetType());
            salesDeliveryDetails = new List<SalesDeliveryDetail>();
        }
    }

    /// <summary>
    /// è¼‰å…¥æ˜ç´°ç›¸é—œè³‡æ–™ï¼ˆé€€è²¨æ•¸é‡ç­‰ï¼‰
    /// é€™å€‹æ–¹æ³•åœ¨ä¸»æª”è¼‰å…¥æ™‚å°±åŒæ­¥åŸ·è¡Œï¼Œç¢ºä¿ hasUndeletableDetails ç‹€æ…‹åœ¨æ¸²æŸ“å‰å°±æ­£ç¢º
    /// </summary>
    private async Task LoadDetailRelatedDataAsync()
    {
        try
        {
            if (!salesDeliveryDetails.Any())
            {
                isDetailDataReady = true;
                hasUndeletableDetails = false;
                return;
            }

            // ç‚ºæ¯å€‹æ˜ç´°è¼‰å…¥é€€è²¨æ•¸é‡ï¼ˆå­˜å…¥å­—å…¸ï¼‰
            returnedQuantities.Clear();
            foreach (var detail in salesDeliveryDetails)
            {
                var returnedQty = await SalesReturnDetailService.GetReturnedQuantityByDeliveryDetailAsync(detail.Id);
                if (returnedQty > 0)
                {
                    returnedQuantities[detail.Id] = returnedQty;
                }
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²æœ‰é€€è²¨è¨˜éŒ„ï¼‰
            bool hasUndeletable = salesDeliveryDetails.Any(detail => 
                DetailLockHelper.HasReturnRecord(detail, returnedQuantities));

            if (hasUndeletableDetails != hasUndeletable)
            {
                hasUndeletableDetails = hasUndeletable;
                UpdateFieldsReadOnlyState();
            }

            isDetailDataReady = true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDetailRelatedDataAsync), GetType());
            isDetailDataReady = true;
        }
    }

    /// <summary>
    /// è™•ç†æœ‰ä¸å¯åˆªé™¤æ˜ç´°çš„ç‹€æ…‹è®Šæ›´
    /// ç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚(å·²é€€è²¨),é–å®šä¸»æª”çš„å®¢æˆ¶å’Œè¨‚å–®æ¬„ä½
    /// </summary>
    private async Task HandleHasUndeletableDetailsChanged(bool hasUndeletable)
    {
        try
        {
            if (hasUndeletableDetails != hasUndeletable)
            {
                hasUndeletableDetails = hasUndeletable;
                UpdateFieldsReadOnlyState();
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleHasUndeletableDetailsChanged), GetType());
        }
    }

    /// <summary>
    /// æ ¹æ“š hasUndeletableDetails ç‹€æ…‹æ›´æ–°æ¬„ä½çš„å”¯è®€ç‹€æ…‹
    /// </summary>
    private void UpdateFieldsReadOnlyState()
    {
        // ä½¿ç”¨ FormFieldLockHelper æ‰¹æ¬¡é–å®š/è§£é–æ¬„ä½
        var fieldsToLock = new[]
        {
            nameof(SalesDelivery.SalesOrderId)
        };
        
        // é–å®šæˆ–è§£é–ä¸€èˆ¬æ¬„ä½ï¼ˆä¸éœ€è¦ ActionButtonsï¼‰
        FormFieldLockHelper.LockMultipleFieldsSimple(
            formFields,
            fieldsToLock,
            isLocked: hasUndeletableDetails
        );
        
        // ç‰¹æ®Šè™•ç†å®¢æˆ¶æ¬„ä½ï¼ˆéœ€è¦ ActionButtonsï¼‰
        if (hasUndeletableDetails)
        {
            FormFieldLockHelper.LockField(
                formFields,
                nameof(SalesDelivery.CustomerId),
                isLocked: true,
                actionButtonsGetter: null  // é–å®šæ™‚ç§»é™¤ ActionButtons
            );
        }
        else
        {
            FormFieldLockHelper.LockField(
                formFields,
                nameof(SalesDelivery.CustomerId),
                isLocked: false,
                actionButtonsGetter: GetCustomerActionButtonsAsync  // è§£é–æ™‚æ¢å¾© ActionButtons
            );
        }
    }

    private async Task<List<FieldActionButton>> GetCustomerActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent,
            customerModalManager,
            nameof(SalesDelivery.CustomerId));
    }

    private async Task<List<FieldActionButton>> GetEmployeeActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent,
            employeeModalManager,
            nameof(SalesDelivery.EmployeeId));
    }

    private async Task OnCustomerSavedWrapper(Customer customer)
    {
        await customerModalManager.HandleEntitySavedAsync(customer, shouldAutoSelect: true);
    }

    private async Task OnEmployeeSavedWrapper(Employee employee)
    {
        await employeeModalManager.HandleEntitySavedAsync(employee, shouldAutoSelect: true);
    }

    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(SalesDelivery.CustomerId), customerModalManager },
            { nameof(SalesDelivery.EmployeeId), employeeModalManager }
        };
    }
    
    // ===== æ¬„ä½è®Šæ›´è™•ç† =====
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // å®¢æˆ¶è®Šæ›´æ™‚ï¼Œè‡ªå‹•è¼‰å…¥åœ°å€ä¸¦æ›´æ–° ActionButtons
            if (fieldChange.PropertyName == nameof(SalesDelivery.CustomerId))
            {
                if (fieldChange.Value != null)
                {
                    await HandleCustomerChanged((int)fieldChange.Value);
                }
                
                // æ›´æ–°å®¢æˆ¶æ¬„ä½çš„æ“ä½œæŒ‰éˆ•
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    customerModalManager, 
                    formFields, 
                    nameof(SalesDelivery.CustomerId), 
                    fieldChange.Value
                );
                
                // âœ… åªåœ¨å®¢æˆ¶è®Šæ›´æ™‚æ‰è§¸ç™¼é‡æ–°æ¸²æŸ“
                StateHasChanged();
                return; // âœ… é‡è¦ï¼šè™•ç†å®Œå°±è¿”å›ï¼Œé¿å…ç¹¼çºŒåŸ·è¡Œ
            }
            
            // æ¥­å‹™å“¡è®Šæ›´æ™‚ï¼Œæ›´æ–° ActionButtons
            if (fieldChange.PropertyName == nameof(SalesDelivery.EmployeeId))
            {
                // æ›´æ–°æ¥­å‹™å“¡æ¬„ä½çš„æ“ä½œæŒ‰éˆ•
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    employeeModalManager, 
                    formFields, 
                    nameof(SalesDelivery.EmployeeId), 
                    fieldChange.Value
                );
                
                // âœ… åªåœ¨æ¥­å‹™å“¡è®Šæ›´æ™‚æ‰è§¸ç™¼é‡æ–°æ¸²æŸ“
                StateHasChanged();
                return; // âœ… é‡è¦ï¼šè™•ç†å®Œå°±è¿”å›ï¼Œé¿å…ç¹¼çºŒåŸ·è¡Œ
            }
            
            // ç¨…åˆ¥è®Šæ›´æ™‚ï¼Œé‡æ–°è¨ˆç®—é‡‘é¡å’Œç¨…é¡
            if (fieldChange.PropertyName == nameof(SalesDelivery.TaxCalculationMethod))
            {
                // è§¸ç™¼æ˜ç´°é‡æ–°è¨ˆç®—
                await HandleDeliveryDetailsChanged(salesDeliveryDetails);
                StateHasChanged();
                return;
            }
            
            // âœ… å…¶ä»–æ¬„ä½è®Šæ›´ä¸éœ€è¦ StateHasChanged
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(OnFieldValueChanged), GetType());
        }
    }

    private async Task HandleCustomerChanged(int customerId)
    {
        try
        {
            var customer = availableCustomers.FirstOrDefault(c => c.Id == customerId);
            if (customer != null && editModalComponent?.Entity != null)
            {
                editModalComponent.Entity.DeliveryAddress = customer.ShippingAddress ?? customer.ContactAddress;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCustomerChanged), GetType());
        }
    }

    // ===== å‡ºè²¨æ˜ç´°ç®¡ç†æ–¹æ³• =====
    
    /// <summary>
    /// è¼‰å…¥å‡ºè²¨æ˜ç´°
    /// </summary>
    private async Task LoadSalesDeliveryDetails(int salesDeliveryId)
    {
        try
        {
            salesDeliveryDetails = await SalesDeliveryDetailService.GetByDeliveryIdAsync(salesDeliveryId);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSalesDeliveryDetails), GetType());
            salesDeliveryDetails = new List<SalesDeliveryDetail>();
        }
    }

    /// <summary>
    /// è™•ç†å‡ºè²¨æ˜ç´°è®Šæ›´ - æ ¹æ“šç¨…åˆ¥è‡ªå‹•è¨ˆç®—é‡‘é¡æ¬„ä½ï¼ˆèˆ‡ Quotation è¨ˆç®—é‚è¼¯ä¸€è‡´ï¼‰
    /// </summary>
    private Task HandleDeliveryDetailsChanged(List<SalesDeliveryDetail> details)
    {
        salesDeliveryDetails = details;
        
        if (editModalComponent?.Entity != null)
        {
            var taxMethod = editModalComponent.Entity.TaxCalculationMethod;
            
            switch (taxMethod)
            {
                case TaxCalculationMethod.TaxExclusive:
                    // å¤–åŠ ç¨…ï¼šTotalAmount = é‡‘é¡ - æŠ˜æ‰£ï¼ŒTotalAmountWithTax = TotalAmount + TaxAmountï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰
                    {
                        // æŠ˜æ‰£å‰é‡‘é¡
                        var subtotalBeforeDiscount = Math.Round(
                            details.Sum(d => d.DeliveryQuantity * d.UnitPrice), 0, MidpointRounding.AwayFromZero);
                        
                        // æŠ˜æ‰£
                        editModalComponent.Entity.DiscountAmount = Math.Round(
                            details.Sum(d => d.DeliveryQuantity * d.UnitPrice * (d.DiscountPercentage / 100)), 0, MidpointRounding.AwayFromZero);
                        
                        // ç¨…é¡ = Î£(æŠ˜æ‰£å¾Œé‡‘é¡ Ã— ç¨…ç‡%)
                        editModalComponent.Entity.TaxAmount = Math.Round(
                            details.Sum(d => {
                                var amountAfterDiscount = d.DeliveryQuantity * d.UnitPrice * (1 - d.DiscountPercentage / 100);
                                var taxRate = d.TaxRate ?? 0;
                                return amountAfterDiscount * (taxRate / 100);
                            }), 0, MidpointRounding.AwayFromZero);
                        
                        // TotalAmount = æŠ˜æ‰£å¾Œæœªç¨…é‡‘é¡ = é‡‘é¡ - æŠ˜æ‰£
                        editModalComponent.Entity.TotalAmount = subtotalBeforeDiscount - editModalComponent.Entity.DiscountAmount;
                        
                        // TotalAmountWithTax æœƒè‡ªå‹•è¨ˆç®— = TotalAmount + TaxAmount
                    }
                    break;
                
                case TaxCalculationMethod.TaxInclusive:
                    // å…§å«ç¨…ï¼šTotalAmount ç‚ºæŠ˜æ‰£å¾Œæœªç¨…é‡‘é¡ï¼ŒTotalAmountWithTax = TotalAmount + TaxAmount
                    {
                        // ç¨…é¡ = Î£(å°è¨ˆ / (1 + ç¨…ç‡%) Ã— ç¨…ç‡%)
                        editModalComponent.Entity.TaxAmount = Math.Round(
                            details.Sum(d => {
                                var amountWithTax = d.DeliveryQuantity * d.UnitPrice * (1 - d.DiscountPercentage / 100);
                                var taxRate = d.TaxRate ?? 0;
                                return amountWithTax / (1 + taxRate / 100) * (taxRate / 100);
                            }), 0, MidpointRounding.AwayFromZero);
                        
                        // æŠ˜æ‰£
                        editModalComponent.Entity.DiscountAmount = Math.Round(
                            details.Sum(d => d.DeliveryQuantity * d.UnitPrice * (d.DiscountPercentage / 100)), 0, MidpointRounding.AwayFromZero);
                        
                        // TotalAmount = æŠ˜æ‰£å¾Œæœªç¨…é‡‘é¡ = Î£(æŠ˜æ‰£å¾Œå«ç¨…é‡‘é¡) - ç¨…é¡
                        var totalWithTax = Math.Round(
                            details.Sum(d => d.DeliveryQuantity * d.UnitPrice * (1 - d.DiscountPercentage / 100)), 0, MidpointRounding.AwayFromZero);
                        editModalComponent.Entity.TotalAmount = totalWithTax - editModalComponent.Entity.TaxAmount;
                        
                        // TotalAmountWithTax æœƒè‡ªå‹•è¨ˆç®— = TotalAmount + TaxAmount
                    }
                    break;
                
                case TaxCalculationMethod.NoTax:
                    // å…ç¨…ï¼šTotalAmount = é‡‘é¡ - æŠ˜æ‰£ï¼ŒTaxAmount = 0
                    {
                        // æŠ˜æ‰£å‰é‡‘é¡
                        var subtotalBeforeDiscount = Math.Round(
                            details.Sum(d => d.DeliveryQuantity * d.UnitPrice), 0, MidpointRounding.AwayFromZero);
                        
                        // æŠ˜æ‰£
                        editModalComponent.Entity.DiscountAmount = Math.Round(
                            details.Sum(d => d.DeliveryQuantity * d.UnitPrice * (d.DiscountPercentage / 100)), 0, MidpointRounding.AwayFromZero);
                        
                        // ç¨…é¡ = 0ï¼ˆå…ç¨…ï¼‰
                        editModalComponent.Entity.TaxAmount = 0;
                        
                        // TotalAmount = æŠ˜æ‰£å¾Œé‡‘é¡ = é‡‘é¡ - æŠ˜æ‰£
                        editModalComponent.Entity.TotalAmount = subtotalBeforeDiscount - editModalComponent.Entity.DiscountAmount;
                        
                        // TotalAmountWithTax æœƒè‡ªå‹•è¨ˆç®— = TotalAmount + 0
                    }
                    break;
            }
            
            StateHasChanged();
        }
        
        return Task.CompletedTask;
    }

    /// <summary>
    /// è™•ç†å·²åˆªé™¤çš„å‡ºè²¨æ˜ç´°ID
    /// </summary>
    private async Task HandleDeletedDetailsChanged(List<int> deletedDetailIds)
    {
        try
        {
            foreach (var detailId in deletedDetailIds)
            {
                var detailToDelete = await SalesDeliveryDetailService.GetByIdAsync(detailId);
                if (detailToDelete != null)
                {
                    await SalesDeliveryDetailService.DeleteAsync(detailId);
                }
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDeletedDetailsChanged), GetType());
        }
    }

    /// <summary>
    /// é©—è­‰å‡ºè²¨æ˜ç´° - åœ¨å„²å­˜ä¸»æª”ä¹‹å‰åŸ·è¡Œ
    /// </summary>
    private async Task<bool> ValidateSalesDeliveryDetailsAsync(SalesDelivery salesDelivery)
    {
        if (salesDeliveryDetailManager == null)
            return true;

        return await salesDeliveryDetailManager.ValidateAsync();
    }

    /// <summary>
    /// AfterSave å›èª¿æ–¹æ³• - åœ¨ä¸»æª”å„²å­˜å¾Œè™•ç†æ˜ç´°
    /// </summary>
    private async Task SaveSalesDeliveryDetailsAsync(SalesDelivery salesDelivery)
    {
        try
        {
            // åªæœ‰åœ¨å‡ºè²¨å–®IDå­˜åœ¨æ™‚æ‰è™•ç†æ˜ç´°ï¼ˆæ–°å¢å‡ºè²¨å–®æ™‚å¯èƒ½IDé‚„æ˜¯0ï¼‰
            if (salesDelivery.Id <= 0)
            {
                return; // æ–°å¢çš„å‡ºè²¨å–®ï¼ŒIDå¯èƒ½é‚„æ²’è¨­å®šï¼Œè·³éæ˜ç´°å„²å­˜
            }

            // å„²å­˜æœ‰æ•ˆçš„æ˜ç´°è³‡æ–™ï¼ˆæœ‰é¸æ“‡å•†å“çš„è¨˜éŒ„ï¼‰
            var validDetails = salesDeliveryDetails
                .Where(d => d.ProductId > 0 && d.DeliveryQuantity > 0)
                .ToList();

            if (validDetails.Any())
            {
                foreach (var detail in validDetails)
                {
                    detail.SalesDeliveryId = salesDelivery.Id;
                    
                    if (detail.Id == 0)
                    {
                        await SalesDeliveryDetailService.CreateAsync(detail);
                    }
                    else
                    {
                        await SalesDeliveryDetailService.UpdateAsync(detail);
                    }
                }

                // ğŸ”‘ é—œéµï¼šé‡æ–°è¼‰å…¥æ˜ç´°è³‡æ–™ä»¥æ›´æ–°UIé¡¯ç¤º
                salesDeliveryDetails = await SalesDeliveryDetailService.GetByDeliveryIdAsync(salesDelivery.Id);
            }

            // ğŸ”¥ é—œéµï¼šæ›´æ–°ç›¸é—œéŠ·è²¨è¨‚å–®æ˜ç´°çš„å·²å‡ºè²¨é‡ï¼ˆåƒ…è™•ç†æœ‰è¨‚å–®çš„æ˜ç´°ï¼‰
            if (validDetails.Any())
            {
                var uniqueSalesOrderDetailIds = validDetails
                    .Where(d => d.SalesOrderDetailId.HasValue && d.SalesOrderDetailId.Value > 0)
                    .Select(d => d.SalesOrderDetailId!.Value)
                    .Distinct();

                foreach (var salesOrderDetailId in uniqueSalesOrderDetailIds)
                {
                    var recalculateResult = await SalesOrderDetailService.RecalculateDeliveredQuantityAsync(salesOrderDetailId);
                    
                    if (!recalculateResult.IsSuccess)
                    {
                        await NotificationService.ShowWarningAsync($"éŠ·è²¨è¨‚å–®æ˜ç´°å·²å‡ºè²¨é‡æ›´æ–°å¤±æ•—ï¼š{recalculateResult.ErrorMessage}");
                    }
                }
            }

            // æ›´æ–°ä¸»æª”ç¸½é‡‘é¡
            var totalAmount = salesDeliveryDetails.Sum(d => d.SubtotalAmount);
            if (salesDelivery.TotalAmount != totalAmount)
            {
                salesDelivery.TotalAmount = totalAmount;
                await SalesDeliveryService.UpdateAsync(salesDelivery);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SaveSalesDeliveryDetailsAsync), GetType());
            throw;
        }
    }

    /// <summary>
    /// é…ç½®è‡ªè¨‚æ¨¡çµ„
    /// </summary>
    private List<GenericEditModalComponent<SalesDelivery, ISalesDeliveryService>.CustomModule> GetCustomModules()
    {
        return new List<GenericEditModalComponent<SalesDelivery, ISalesDeliveryService>.CustomModule>
        {
            new GenericEditModalComponent<SalesDelivery, ISalesDeliveryService>.CustomModule
            {
                Title = "",
                Order = 1,
                Content = CreateDeliveryDetailManagerContent()
            }
        };
    }

    /// <summary>
    /// å‰µå»ºå‡ºè²¨æ˜ç´°ç®¡ç†å™¨å…§å®¹çš„ RenderFragment
    /// </summary>
    private RenderFragment CreateDeliveryDetailManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null)
            {
                // åªæœ‰é¸æ“‡å®¢æˆ¶å¾Œæ‰é¡¯ç¤ºæ˜ç´°ç®¡ç†å™¨
                @if (editModalComponent.Entity.CustomerId > 0)
                {
                    try
                    {
                        <SalesDeliveryTable @ref="salesDeliveryDetailManager"
                                           TMainEntity="SalesDelivery"
                                           TDetailEntity="SalesDeliveryDetail"
                                           MainEntity="@editModalComponent.Entity"
                                           ExistingDetails="@salesDeliveryDetails"
                                           OnDetailsChanged="@HandleDeliveryDetailsChanged"
                                           OnDeletedDetailsChanged="@HandleDeletedDetailsChanged"
                                           OnHasUndeletableDetailsChanged="@HandleHasUndeletableDetailsChanged"
                                           ReturnedQuantities="@returnedQuantities"
                                           Products="@availableProducts"
                                           Warehouses="@warehouses"
                                           WarehouseLocations="@warehouseLocations"
                                           SelectedCustomerId="@editModalComponent.Entity.CustomerId"
                                           SelectedSalesOrderId="@editModalComponent.Entity.SalesOrderId"
                                           TaxCalculationMethod="@editModalComponent.Entity.TaxCalculationMethod"
                                           MainEntityIdPropertyName="@nameof(SalesDeliveryDetail.SalesDeliveryId)"
                                           QuantityPropertyName="@nameof(SalesDeliveryDetail.DeliveryQuantity)"
                                           UnitPricePropertyName="@nameof(SalesDeliveryDetail.UnitPrice)"
                                           RemarksPropertyName="@nameof(SalesDeliveryDetail.Remarks)"
                                           WarehouseIdPropertyName="@nameof(SalesDeliveryDetail.WarehouseId)"
                                           WarehouseLocationIdPropertyName="@nameof(SalesDeliveryDetail.WarehouseLocationId)"
                                           ShowWarehouse="true"
                                           ShowWarehouseLocation="false"
                                           IsReadOnly="false" />
                    }
                    catch
                    {
                        <div class="alert alert-warning" role="alert">
                            è¼‰å…¥æ˜ç´°ç®¡ç†å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-info text-center" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        è«‹å…ˆé¸æ“‡å®¢æˆ¶å¾Œå†é€²è¡Œå‡ºè²¨æ˜ç´°ç®¡ç†
                    </div>
                }
            }
            else
            {
                <div class="text-center py-3">
                    <span class="text-muted">è«‹å…ˆé¸æ“‡å®¢æˆ¶å¾Œå†ç®¡ç†å‡ºè²¨æ˜ç´°</span>
                </div>
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                è¼‰å…¥æ˜ç´°ç®¡ç†å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚
            </div>
        }
    };
    
    /// <summary>
    /// å–å¾—è‡ªè¨‚æ“ä½œæŒ‰éˆ•ï¼ˆé¡¯ç¤ºåœ¨ Modal é ‚éƒ¨å·¦å´ï¼‰- ä½œç‚ºå±¬æ€§ä»¥ç¢ºä¿æ­£ç¢ºçš„æ¸²æŸ“æ™‚æ©Ÿ
    /// </summary>
    private RenderFragment? CustomActionButtons
    {
        get
        {
            return __builder =>
            {
                @* è½‰é€€è²¨æŒ‰éˆ• - æ–°å¢æ¨¡å¼éœ€å…ˆå„²å­˜ï¼Œç·¨è¼¯æ¨¡å¼ç›´æ¥å¯ç”¨ *@
                @if (canCreateReturn)
                {
                    <GenericButtonComponent Text="è½‰é€€è²¨" 
                                          Variant="ButtonVariant.Red" 
                                          Size="ButtonSize.Small"
                                          CssClass="me-2"
                                          OnClick="HandleCreateReturnFromDelivery" />
                }
            };
        }
    }
    
    /// <summary>
    /// å¾å‡ºè²¨å–®è½‰é€€è²¨å–® - ç°¡åŒ–ç‰ˆæœ¬ï¼Œæ‰€æœ‰æ¥­å‹™é©—è­‰äº¤çµ¦é€€è²¨å–® Modal è™•ç†
    /// </summary>
    private async Task HandleCreateReturnFromDelivery()
    {
        try
        {
            // å”¯ä¸€æª¢æŸ¥ï¼šç¢ºèªæ˜¯å¦å·²å„²å­˜ï¼ˆæ–°å¢æ¨¡å¼éœ€å…ˆå„²å­˜ï¼Œç·¨è¼¯æ¨¡å¼ç›´æ¥é€šéï¼‰
            if (!canCreateReturn)
            {
                await NotificationService.ShowWarningAsync("è«‹å…ˆå„²å­˜å‡ºè²¨å–®å¾Œï¼Œæ‰èƒ½è½‰é€€è²¨");
                return;
            }
            
            // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ Entity å·²è¼‰å…¥ï¼ˆcanCreateReturn = true æ™‚ç†è«–ä¸Šä¸€å®šæœ‰å€¼ï¼‰
            if (editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("å‡ºè²¨å–®è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å®¢æˆ¶è³‡æ–™
            if (editModalComponent.Entity.CustomerId <= 0)
            {
                await NotificationService.ShowWarningAsync("å‡ºè²¨å–®ç¼ºå°‘å®¢æˆ¶è³‡è¨Šï¼Œç„¡æ³•è½‰é€€è²¨");
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ˜ç´°è³‡æ–™
            if (!salesDeliveryDetails.Any())
            {
                await NotificationService.ShowWarningAsync("å‡ºè²¨å–®æ²’æœ‰æ˜ç´°è³‡æ–™ï¼Œç„¡æ³•è½‰é€€è²¨");
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰æ˜ç´°éƒ½å·²å®Œæˆé€€è²¨ï¼ˆå·²é€€è²¨æ•¸é‡ >= å‡ºè²¨æ•¸é‡ï¼‰
            bool hasIncompleteDetails = false;
            foreach (var detail in salesDeliveryDetails)
            {
                var returnedQty = await SalesReturnDetailService.GetReturnedQuantityByDeliveryDetailAsync(detail.Id);
                if (detail.DeliveryQuantity > returnedQty)
                {
                    hasIncompleteDetails = true;
                    break;
                }
            }
            
            if (!hasIncompleteDetails)
            {
                await NotificationService.ShowWarningAsync("å‡ºè²¨å–®æ‰€æœ‰æ˜ç´°çš†å·²å®Œæˆé€€è²¨ï¼Œç„¡éœ€å†è½‰å–®");
                return;
            }
            
            // ç›´æ¥é–‹å•Ÿé€€è²¨å–® Modalï¼Œä½¿ç”¨ Entity.Id ä½œç‚ºå‡ºè²¨å–® IDï¼ˆæœ€å¯é çš„ä¾†æºï¼‰
            await salesReturnEditModal!.ShowAddModalWithPrefilledDelivery(
                editModalComponent.Entity.CustomerId,
                editModalComponent.Entity.Id  // ä½¿ç”¨ Entity.Id è€Œé SalesDeliveryId åƒæ•¸
            );
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCreateReturnFromDelivery), GetType(), 
                additionalData: $"è½‰é€€è²¨å–®å¤±æ•— - DeliveryId: {editModalComponent?.Entity?.Id}");
            await NotificationService.ShowErrorAsync($"è½‰é€€è²¨æ™‚ç™¼ç”ŸéŒ¯èª¤: {ex.Message}");
        }
    }
    
    /// <summary>
    /// è™•ç†é€€è²¨å–®å„²å­˜å¾Œçš„äº‹ä»¶ï¼ˆå‡ºè²¨å–®è½‰å–®ï¼‰
    /// ä½¿ç”¨ ChildDocumentRefreshHelper çµ±ä¸€è™•ç†åˆ·æ–°é‚è¼¯
    /// </summary>
    private async Task HandleSalesReturnSaved(SalesReturn savedSalesReturn)
    {
        try
        {
            // ä½¿ç”¨çµ±ä¸€ Helper è™•ç†å­å–®æ“šå„²å­˜å¾Œçš„åˆ·æ–°é‚è¼¯
            await ChildDocumentRefreshHelper.HandleChildDocumentSavedAsync(
                closeModal: () =>
                {
                    showSalesReturnModal = false;
                    selectedSalesReturnId = null;
                },
                reloadDetails: async () =>
                {
                    // ğŸ”‘ é—œéµä¿®å¾©ï¼šå¾è³‡æ–™åº«é‡æ–°è¼‰å…¥æ˜ç´°è³‡æ–™
                    // é€™ç¢ºä¿ ReturnedQuantity ç­‰æ¬„ä½éƒ½æ˜¯æœ€æ–°çš„è³‡æ–™
                    if (editModalComponent?.Entity?.Id > 0)
                    {
                        await LoadSalesDeliveryDetailsInternal(editModalComponent.Entity.Id);
                    }
                },
                detailManager: salesDeliveryDetailManager,
                notificationMessage: $"é€€è²¨å–® {savedSalesReturn.Code} å·²æ›´æ–°ï¼Œå‡ºè²¨æ˜ç´°å·²åˆ·æ–°",
                stateHasChanged: StateHasChanged,
                invokeAsync: InvokeAsync,
                additionalActions: async () =>
                {
                    // ğŸ”‘ é—œéµä¿®å¾©ï¼šå…ˆç¢ºä¿ UI æ›´æ–°ï¼ˆåƒæ•¸å‚³éï¼‰ï¼Œå†åˆ·æ–° Table çµ„ä»¶
                    // é€™æ¨£å¯ä»¥ç¢ºä¿ SalesDeliveryTable çš„ ExistingDetails åƒæ•¸å·²æ”¶åˆ°æœ€æ–°çš„ salesDeliveryDetails
                    await InvokeAsync(StateHasChanged);
                    
                    // å»¶é²ä¸€å°æ®µæ™‚é–“ï¼Œç¢ºä¿ Blazor å®Œæˆåƒæ•¸ç¶å®š
                    await Task.Delay(50);
                    
                    // å‘¼å« Table çµ„ä»¶çš„å…¬é–‹åˆ·æ–°æ–¹æ³•ä¾†æ›´æ–° UI é¡¯ç¤º
                    if (salesDeliveryDetailManager != null)
                    {
                        await salesDeliveryDetailManager.RefreshDetailsAsync();
                    }
                }
            );
            
            await NotificationService.ShowSuccessAsync($"å·²æˆåŠŸå¾å‡ºè²¨å–®è½‰ç‚ºé€€è²¨å–®ï¼ˆé€€è²¨å–®ç·¨è™Ÿï¼š{savedSalesReturn.Code}ï¼‰");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSalesReturnSaved), GetType());
        }
    }
    
    // ===== ActionButton ç”¢ç”Ÿæ–¹æ³• =====
}