@* å ±åƒ¹å–®æ˜ç´°ç®¡ç†çµ„ä»¶ - ä½¿ç”¨ InteractiveTableComponent çµ±ä¸€UI *@

@using ERPCore2.Helpers.InteractiveTableComponentHelper
@using ERPCore2.Helpers
@using ERPCore2.Models.Enums
@inject IProductService ProductService
@inject IProductCompositionService ProductCompositionService
@inject IQuotationDetailService QuotationDetailService
@inject IQuotationCompositionDetailService QuotationCompositionDetailService
@inject INotificationService NotificationService
@inject ISystemParameterService SystemParameterService
@inject RelatedDocumentsHelper RelatedDocumentsHelper
@inject IJSRuntime JSRuntime

@typeparam TMainEntity where TMainEntity : BaseEntity
@typeparam TDetailEntity where TDetailEntity : BaseEntity, new()

@if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
{
    <div class="alert alert-info text-center" role="alert">
        <i class="fas fa-info-circle me-2"></i>
        è«‹å…ˆé¸æ“‡å®¢æˆ¶å¾Œå†é€²è¡Œå ±åƒ¹æ˜ç´°ç®¡ç†
    </div>
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="QuotationItem" 
                                      Items="@QuotationItems"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"                                      
                                      EmptyMessage="@EmptyMessage"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="false"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"
                                      ActionsColumnWidth = "120px"
                                      EnableAutoEmptyRow="true"
                                      AllowAddNewRow="@(!_hasUndeletableDetails && !IsReadOnly)"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@CreateEmptyItem" />
        </div>

        <div class="card-footer">
            <div class="table-action-bar">
                <div class="btn-group-left">
                    <GenericButtonComponent Text="æ™ºèƒ½ä¸‹å–®"
                                          Variant="ButtonVariant.DarkBlue"
                                          OnClick="SmartQuotation"
                                          IsDisabled="@(!CanUseSmartQuotation || IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetSmartQuotationTooltip()" />
                </div>
                <div class="btn-group-right">
                    <GenericButtonComponent Text="æ¸…é™¤æ˜ç´°"
                                          Variant="ButtonVariant.Red"
                                          OnClick="ClearAllDetails"
                                          IsDisabled="@(IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetClearAllDetailsTooltip()" />
                </div>
            </div>
        </div>
    </div>
}

<!-- ç›¸é—œå–®æ“šæŸ¥çœ‹ Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

<!-- é…æ–¹é¸æ“‡ Modal -->
<CompositionSelectorModal IsVisible="@showCompositionSelectorModal"
                         IsVisibleChanged="@((bool visible) => showCompositionSelectorModal = visible)"
                         ProductName="@selectedCompositionProductName"
                         Compositions="@availableCompositions"
                         CurrentCustomerId="@SelectedCustomerId"
                         OnSelected="@HandleCompositionSelected" />

<!-- BOM çµ„åˆç·¨è¼¯ Modal -->
<QuotationCompositionEditModal TCompositionDetail="QuotationCompositionDetail"
                              IsVisible="@showCompositionModal"
                              IsVisibleChanged="@((bool visible) => { showCompositionModal = visible; })"
                              DetailId="@GetSelectedQuotationDetailId()"
                              ProductName="@selectedCompositionProductName"
                              ProductId="@selectedCompositionProductId"
                              SelectedCompositionId="@selectedCompositionId"
                              IsCustomMode="@isCustomCompositionMode"
                              IsReselecting="@isReselectingComposition"
                              IsReadOnly="@GetCompositionModalReadOnlyState()"
                              GetCompositionsByDetailId="@QuotationCompositionDetailService.GetByQuotationDetailIdAsync"
                              CopyFromComposition="@QuotationCompositionDetailService.CopyFromCompositionAsync"
                              OnSave="@HandleCompositionSave"
                              OnCancel="@HandleCompositionCancel"
                              OnRequestCachedData="@GetCachedCompositionData"
                              OnReselect="@HandleCompositionReselect" />

@code {
    // ===== InteractiveTableComponent åƒè€ƒ =====
    private InteractiveTableComponent<QuotationItem>? tableComponent;
    
    // ===== QuotationItem å…§éƒ¨é¡åˆ¥å®šç¾©ï¼ˆå¿…é ˆåœ¨æœ€å‰é¢ï¼‰=====
    public class QuotationItem
    {
        public ERPCore2.Data.Entities.Product? SelectedProduct { get; set; }
        public ERPCore2.Data.Entities.Unit? SelectedUnit { get; set; }
        public decimal Quantity { get; set; } = 0;
        public decimal UnitPrice { get; set; } = 0;
        public decimal DiscountPercentage { get; set; } = 0;
        public decimal? TaxRate { get; set; } = null;
        public decimal ConvertedQuantity { get; set; } = 0;
        public string Specification { get; set; } = string.Empty;
        public string Remarks { get; set; } = string.Empty;
        public TDetailEntity? ExistingDetailEntity { get; set; }
        
        /// <summary>
        /// è‡ªè¨‚çš„ BOM çµ„åˆæ˜ç´°ï¼ˆç”¨æ–¼æš«å­˜ç·¨è¼¯çµæœï¼‰
        /// </summary>
        public List<QuotationCompositionDetail>? CustomCompositionDetails { get; set; }
        
        /// <summary>
        /// é¸æ“‡çš„é…æ–¹ IDï¼ˆnull è¡¨ç¤ºè‡ªå®šç¾©æ¨¡å¼ï¼‰
        /// </summary>
        public int? SelectedCompositionId { get; set; }
        
        /// <summary>
        /// æ˜¯å¦ç‚ºè‡ªå®šç¾©çµ„åˆæ¨¡å¼
        /// </summary>
        public bool IsCustomComposition { get; set; }
        
        /// <summary>
        /// è¨ˆç®—å±¬æ€§ï¼šæ˜¯å¦å·²æœ‰ BOM çµ„åˆè³‡æ–™
        /// </summary>
        public bool HasCompositionData => CustomCompositionDetails?.Any() == true;
        
        // SearchableSelect æ”¯æ´å±¬æ€§
        public string ProductSearchValue { get; set; } = string.Empty;
        public List<ERPCore2.Data.Entities.Product> FilteredProducts { get; set; } = new();
        public bool ShowProductDropdown { get; set; } = false;
        public int ProductSelectedIndex { get; set; } = -1;
        
        /// <summary>
        /// è¨ˆç®—å±¬æ€§ï¼šå°è¨ˆé‡‘é¡ï¼ˆæ•¸é‡ Ã— å–®åƒ¹ Ã— æŠ˜æ‰£ï¼‰
        /// </summary>
        public decimal SubtotalAmount => Quantity * UnitPrice * (1 - DiscountPercentage / 100);
        
        /// <summary>
        /// è¨ˆç®—å±¬æ€§ï¼šæœªè½‰å–®æ•¸é‡
        /// </summary>
        public decimal RemainingQuantity => Quantity - ConvertedQuantity;
        
        /// <summary>
        /// è¨ˆç®—å±¬æ€§ï¼šæ˜¯å¦å·²å®Œå…¨è½‰å–®
        /// </summary>
        public bool IsFullyConverted => ConvertedQuantity >= Quantity;
        
        /// <summary>
        /// è¨ˆç®—å±¬æ€§ï¼šé¡¯ç¤ºåç¨±ï¼ˆç”¨æ–¼å”¯è®€æ¨¡å¼ï¼‰
        /// </summary>
        public string DisplayName
        {
            get
            {
                if (SelectedProduct == null) return string.Empty;
                
                var parts = new List<string>();
                
                if (!string.IsNullOrEmpty(SelectedProduct.Code))
                    parts.Add($"[{SelectedProduct.Code}]");
                
                if (!string.IsNullOrEmpty(SelectedProduct.Name))
                    parts.Add(SelectedProduct.Name);
                
                return string.Join(" ", parts);
            }
        }
    }
    
    // ===== ç§æœ‰æ¬„ä½ =====
    private bool _dataLoadCompleted = true;  // è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜
    private bool _hasUndeletableDetails = false;  // æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²è½‰è¨‚å–®ï¼‰
    private bool _hasLastQuotationRecord = false;  // æ˜¯å¦æœ‰æ­·å²å ±åƒ¹è¨˜éŒ„ï¼ˆå¿«å–ï¼‰
    
    // ===== åŸºæœ¬åƒæ•¸ =====
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public List<Unit> Units { get; set; } = new List<Unit>();
    [Parameter] public EventCallback<List<QuotationItem>> OnQuotationItemsChanged { get; set; }
    
    // ===== å®¢æˆ¶éæ¿¾åƒæ•¸ =====
    [Parameter] public int? SelectedCustomerId { get; set; }
    
    // ===== æ³›å‹åƒæ•¸ =====
    [Parameter] public TMainEntity? MainEntity { get; set; }
    [Parameter] public List<TDetailEntity> ExistingDetails { get; set; } = new List<TDetailEntity>();
    [Parameter] public EventCallback<List<TDetailEntity>> OnDetailsChanged { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    [Parameter] public EventCallback<QuotationItem> OnItemRemoved { get; set; }
    
    // ===== æ¬„ä½æ˜ å°„åƒæ•¸ =====
    [Parameter] public string MainEntityIdPropertyName { get; set; } = string.Empty;
    [Parameter] public string QuantityPropertyName { get; set; } = "Quantity";
    [Parameter] public string UnitPricePropertyName { get; set; } = "UnitPrice";
    [Parameter] public string DiscountPercentagePropertyName { get; set; } = "DiscountPercentage";
    [Parameter] public string RemarksPropertyName { get; set; } = "Remarks";
    [Parameter] public string? UnitIdPropertyName { get; set; }
    
    // ===== é¡¯ç¤ºè¨­å®š =====
    [Parameter] public string Title { get; set; } = "å ±åƒ¹æ˜ç´°";
    [Parameter] public string EmptyMessage { get; set; } = "å°šæœªæ–°å¢å ±åƒ¹å•†å“";
    
    // ===== å”¯è®€æ¨¡å¼åƒæ•¸ =====
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== ç›¸é—œå–®æ“šé–‹å•Ÿäº‹ä»¶ =====
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }
    
    // ===== ç¨…åˆ¥åƒæ•¸ï¼ˆæ–°å¢ï¼‰=====
    [Parameter] public TaxCalculationMethod TaxCalculationMethod { get; set; } = TaxCalculationMethod.TaxExclusive;
    
    // æ–¹æ¡ˆ D æ”¹è‰¯ç‰ˆï¼šè³‡æ–™ç‰ˆæœ¬è¿½è¹¤
    [Parameter] public int DataVersion { get; set; } = 0;
    
    // ä¿®æ­£ï¼šçˆ¶å…ƒä»¶è¼‰å…¥ä¸­æ¨™è¨˜
    [Parameter] public bool IsParentLoading { get; set; } = false;
    
    // ===== è¼”åŠ©è¨ˆç®—å±¬æ€§ =====
    private bool IsTaxCalculationMethodNoTax => TaxCalculationMethod == TaxCalculationMethod.NoTax;

    private List<QuotationItem> QuotationItems { get; set; } = new List<QuotationItem>();
    private int? _previousSelectedCustomerId = null;
    private List<int> _deletedDetailIds { get; set; } = new List<int>();
    
    // æ–¹æ¡ˆ D æ”¹è‰¯ç‰ˆï¼šè³‡æ–™ç‰ˆæœ¬è¿½è¹¤
    private int _previousDataVersion = 0;
    private bool _isLoadingDetails = false;
    
    // ===== ç›¸é—œå–®æ“šæŸ¥çœ‹ =====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;
    
    // ===== BOM çµ„åˆç·¨è¼¯ç›¸é—œ =====
    private bool showCompositionModal = false;
    private bool showCompositionSelectorModal = false;
    private int? selectedQuotationItemIndex = null;
    private string selectedCompositionProductName = string.Empty;
    private int? selectedCompositionProductId = null;
    private int? selectedCompositionId = null;
    private bool isCustomCompositionMode = false;
    private bool isReselectingComposition = false;  // æ¨™è¨˜æ˜¯å¦ç‚ºé‡æ–°é¸æ“‡é…æ–¹
    private List<ProductComposition> availableCompositions = new();
    private Dictionary<int, List<QuotationCompositionDetail>> compositionDetailsCache = new();
    private HashSet<int> productsWithComposition = new();  // å¿«å–æœ‰ BOM çš„å•†å“ ID

    protected override async Task OnInitializedAsync()
    {
        // ä¿®æ­£ï¼šçˆ¶å…ƒä»¶è¼‰å…¥ä¸­æ™‚ä¸åŸ·è¡Œåˆå§‹åŒ–
        // ğŸ”¥ é‡è¦ï¼šæ­¤æ™‚ä¸è¨­å®š _previousDataVersionï¼Œè®“ OnParametersSetAsync èƒ½å¤ åµæ¸¬åˆ°è®ŠåŒ–
        if (IsParentLoading) { return; }
        
        // åªæœ‰åœ¨æˆåŠŸè¼‰å…¥å¾Œæ‰è¨­å®š _previousDataVersion
        _previousDataVersion = DataVersion;
        
        // åˆå§‹åŒ–è¿½è¹¤è®Šæ•¸
        _previousSelectedCustomerId = SelectedCustomerId;
        
        await LoadExistingDetailsAsync();
        
        // æª¢æŸ¥æ˜¯å¦æœ‰æ­·å²å ±åƒ¹è¨˜éŒ„
        await CheckLastQuotationRecordAsync();
        
        // è¼‰å…¥æœ‰ BOM çµ„æˆçš„å•†å“åˆ—è¡¨
        await LoadProductCompositionsAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        // é˜²æ­¢é‡å…¥
        if (_isLoadingDetails) { return; }
        
        // æ–¹æ¡ˆ D æ”¹è‰¯ç‰ˆï¼šå„ªå…ˆæª¢æŸ¥ DataVersion
        bool versionChanged = DataVersion != _previousDataVersion;
        
        if (versionChanged)
        {
            // åŒæ™‚æ›´æ–°æ‰€æœ‰è¿½è¹¤è®Šæ•¸
            _previousDataVersion = DataVersion;
            _previousSelectedCustomerId = SelectedCustomerId;
            
            _isLoadingDetails = true;
            try
            {
                // é‡æ–°è¼‰å…¥è³‡æ–™
                await LoadExistingDetailsAsync();
                tableComponent?.RefreshEmptyRow();
            }
            finally
            {
                _isLoadingDetails = false;
            }
            return;
        }
        
        base.OnParametersSet();
        
        // æª¢æŸ¥å®¢æˆ¶æ˜¯å¦è®Šæ›´
        bool customerChanged = _previousSelectedCustomerId != SelectedCustomerId;
        
        if (customerChanged)
        {
            _previousSelectedCustomerId = SelectedCustomerId;
            
            // å¦‚æœæ›´æ›å®¢æˆ¶ï¼Œéœ€è¦æ¸…ç©ºç¾æœ‰é¸é …ä¸¦é‡æ–°è¼‰å…¥
            QuotationItems.Clear();
            await LoadExistingDetailsAsync();
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ­·å²å ±åƒ¹è¨˜éŒ„
            await CheckLastQuotationRecordAsync();
        }
    }
    
    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦æœ‰æ­·å²å ±åƒ¹è¨˜éŒ„
    /// </summary>
    private async Task CheckLastQuotationRecordAsync()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
        {
            _hasLastQuotationRecord = false;
            return;
        }
        
        try
        {
            var lastQuotationDetails = await QuotationDetailService.GetLastCompleteQuotationAsync(SelectedCustomerId.Value);
            _hasLastQuotationRecord = lastQuotationDetails?.Any() == true;
        }
        catch
        {
            _hasLastQuotationRecord = false;
        }
    }
    
    /// <summary>
    /// è¼‰å…¥æœ‰ BOM çµ„æˆçš„å•†å“åˆ—è¡¨ï¼ˆç”¨æ–¼å¿«å–æª¢æŸ¥ï¼‰
    /// </summary>
    private async Task LoadProductCompositionsAsync()
    {
        try
        {
            // å¾ Products åƒæ•¸ä¸­å–å¾—æ‰€æœ‰å•†å“ ID
            var productIds = Products.Where(p => p.Id > 0).Select(p => p.Id).ToList();
            
            // æª¢æŸ¥æ¯å€‹å•†å“æ˜¯å¦æœ‰ ProductComposition
            foreach (var productId in productIds)
            {
                var compositions = await ProductCompositionService.GetCompositionsByProductIdAsync(productId);
                if (compositions?.Any() == true)
                {
                    productsWithComposition.Add(productId);
                }
            }
        }
        catch (Exception ex)
        {
            // è¼‰å…¥å¤±æ•—ä¸å½±éŸ¿ä¸»è¦åŠŸèƒ½ï¼Œåªæ˜¯ BOM æŒ‰éˆ•å¯èƒ½ä¸é¡¯ç¤º
            Console.WriteLine($"è¼‰å…¥å•†å“çµ„æˆè³‡æ–™å¤±æ•—ï¼š{ex.Message}");
            productsWithComposition.Clear();
        }
    }

    // ===== å»ºç«‹ç©ºé …ç›®æ–¹æ³• =====
    
    private QuotationItem CreateEmptyItem()
    {
        return new QuotationItem();
    }

    // ===== InteractiveTableComponent æ–¹æ³• =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // å•†å“é¸æ“‡æ¬„ä½ - è§¸ç™¼æ¬„ä½ï¼ˆç¬¬ä¸€å€‹æ¬„ä½é è¨­ç‚ºè§¸ç™¼æ¬„ä½ï¼‰
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å•†å“ç·¨è™Ÿ/åç¨±", 
            PropertyName = "ProductSearchValue",
            EmptyCheckPropertyName = "SelectedProduct",  // æª¢æŸ¥ SelectedProduct ç‰©ä»¶
            TriggerEmptyRowOnFilled = true,  // é¸æ“‡å•†å“å¾Œè‡ªå‹•æ–°å¢ç©ºè¡Œ
            ColumnType = InteractiveColumnType.SearchableSelect,
            Width = "300px",
            Tooltip = "æœå°‹ä¸¦é¸æ“‡å•†å“ï¼ˆè¼¸å…¥ç·¨è™Ÿæˆ–åç¨±ï¼‰ã€‚å·²è½‰éŠ·è²¨çš„å•†å“å°‡ç„¡æ³•è®Šæ›´",
            Placeholder = "è«‹è¼¸å…¥å•†å“ç·¨è™Ÿæˆ–åç¨±",
            SearchValuePropertyName = nameof(QuotationItem.ProductSearchValue),
            FilteredItemsPropertyName = nameof(QuotationItem.FilteredProducts),
            ShowDropdownPropertyName = nameof(QuotationItem.ShowProductDropdown),
            SelectedIndexPropertyName = nameof(QuotationItem.ProductSelectedIndex),
            ItemDisplayFormatter = (item) =>
            {
                var product = (Product)item;
                return $"[{product.Code}] {product.Name}";
            },
            IsDisabledFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                return IsReadOnly || !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true);
            },
            TooltipFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                return !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) 
                    ? "æ­¤å•†å“å·²è½‰éŠ·è²¨ï¼Œç„¡æ³•ä¿®æ”¹å•†å“é¸æ“‡" : null;
            },
            OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, (tuple) =>
            {
                var (item, searchValue) = tuple;
                OnProductSearchChanged((QuotationItem)item, searchValue);
            }),
            OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
            {
                var (item, selectedItem) = tuple;
                await OnProductSelected((QuotationItem)item, (Product?)selectedItem);
            }),
            OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnProductFocus((QuotationItem)item);
            }),
            OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnProductBlur((QuotationItem)item);
            }),
            EnableKeyboardNavigation = true,
            GetDropdownItems = (item) => ((QuotationItem)item).FilteredProducts,
            GetSelectedIndex = (item) => ((QuotationItem)item).ProductSelectedIndex,
            SetSelectedIndex = (item, index) => ((QuotationItem)item).ProductSelectedIndex = index,
            GetShowDropdown = (item) => ((QuotationItem)item).ShowProductDropdown,
            SetShowDropdown = (item, show) => ((QuotationItem)item).ShowProductDropdown = show,
            MaxDisplayItems = 20
        });

        
        // è£½ç¨‹å–®ä½æ¬„ä½ - å”¯è®€é¡¯ç¤º
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å–®ä½", 
            Tooltip = "å•†å“çš„è£½ç¨‹å–®ä½ï¼ˆç”±å•†å“è¨­å®šæ±ºå®šï¼‰",
            PropertyName = "ProductionUnitName",
            ColumnType = InteractiveColumnType.Display,
            Width = "80px",
            DisplayFormatter = (item) => GetProductionUnitName((QuotationItem)item!),
            ExcludeFromEmptyCheck = true  // å”¯è®€æ¬„ä½ä¸åƒèˆ‡ç©ºè¡Œæª¢æŸ¥
        });

        // æ•¸é‡æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "æ•¸é‡", 
            PropertyName = "Quantity",
            ColumnType = InteractiveColumnType.Number,
            Width = "80px",
            Tooltip = "è¼¸å…¥æ•¸é‡",
            CellCssClass = "text-end",
            MinValue = 0,
            IsDisabledFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                return !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow;
            },
            TooltipFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                if (!DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow)
                    return "æ­¤å•†å“å·²è½‰éŠ·è²¨ï¼Œç„¡æ³•ä¿®æ”¹æ•¸é‡";
                return "è¼¸å…¥æ•¸é‡";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var quotationItem = (QuotationItem)args.Item1;
                await OnQuantityInput(quotationItem, args.Item2);
            })
        });

        // å–®åƒ¹æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å–®åƒ¹", 
            PropertyName = "UnitPrice",
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            Tooltip = "è¼¸å…¥å ±åƒ¹å–®åƒ¹",
            CellCssClass = "text-end",
            MinValue = 0,
            IsDisabledFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                return !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow;
            },
            TooltipFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                if (!DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow)
                    return "æ­¤å•†å“å·²è½‰éŠ·è²¨ï¼Œç„¡æ³•ä¿®æ”¹å–®åƒ¹";
                return "è¼¸å…¥å ±åƒ¹å–®åƒ¹";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var quotationItem = (QuotationItem)args.Item1;
                await OnUnitPriceInput(quotationItem, args.Item2);
            })
        });

        // æŠ˜æ‰£æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "æŠ˜æ‰£(%)", 
            PropertyName = "DiscountPercentage",
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            Tooltip = "è¼¸å…¥æŠ˜æ‰£ç™¾åˆ†æ¯”",
            CellCssClass = "text-end",
            MinValue = 0,
            MaxValue = 100,
            IsDisabledFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                return !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow;
            },
            TooltipFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                if (!DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow)
                    return "æ­¤å•†å“å·²è½‰éŠ·è²¨ï¼Œç„¡æ³•ä¿®æ”¹æŠ˜æ‰£";
                return "è¼¸å…¥æŠ˜æ‰£ç™¾åˆ†æ¯”";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var quotationItem = (QuotationItem)args.Item1;
                await OnDiscountPercentageInput(quotationItem, args.Item2);
            })
        });

        // ç¨…ç‡æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "ç¨…ç‡(%)",
            PropertyName = "TaxRate",
            ColumnType = InteractiveColumnType.Number,
            Width = "80px",
            Tooltip = "è¼¸å…¥ç¨…ç‡ç™¾åˆ†æ¯”ï¼ˆä¾‹å¦‚ï¼š5 ä»£è¡¨ 5%ï¼‰",
            CellCssClass = "text-end",
            MinValue = 0,
            MaxValue = 100,
            IsDisabledFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                return IsReadOnly || IsTaxCalculationMethodNoTax || 
                       !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true);
            },
            TooltipFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                if (IsTaxCalculationMethodNoTax) return "ä¸»æª”å·²é¸æ“‡å…ç¨…ï¼Œæ­¤æ¬„ä½å·²åœç”¨";
                if (!DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true))
                    return "æ­¤å•†å“å·²è½‰éŠ·è²¨ï¼Œç„¡æ³•ä¿®æ”¹ç¨…ç‡";
                return "è¼¸å…¥ç¨…ç‡ç™¾åˆ†æ¯”ï¼ˆä¾‹å¦‚ï¼š5 ä»£è¡¨ 5%ï¼‰";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var quotationItem = (QuotationItem)args.Item1;
                await OnTaxRateInput(quotationItem, args.Item2);
            })
        });

        // å°è¨ˆæ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "å°è¨ˆ",
            Tooltip = GetSubtotalTooltip(),
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item =>
            {
                var quotationItem = (QuotationItem)item;
                var subtotal = CalculateItemSubtotal(quotationItem);
                var displayValue = NumberFormatHelper.FormatSmartZeroAsEmpty(subtotal);
                return @<div class="text-end fw-bold text-success">@displayValue</div>;
            }
        });

        // è¦æ ¼èªªæ˜æ¬„ä½
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "è¦æ ¼èªªæ˜", 
            PropertyName = "Specification",
            ColumnType = InteractiveColumnType.Input,
            Width = "200px",
            Placeholder = "è¦æ ¼èªªæ˜",
            Tooltip = "å•†å“çš„è¦æ ¼èªªæ˜ï¼Œå¯è‡ªè¡Œä¿®æ”¹",
            IsDisabledFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                return IsReadOnly || !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true);
            },
            TooltipFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                if (!DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true))
                    return "æ­¤å•†å“å·²è½‰éŠ·è²¨ï¼Œç„¡æ³•ä¿®æ”¹è¦æ ¼èªªæ˜";
                return "å•†å“çš„è¦æ ¼èªªæ˜ï¼Œå¯è‡ªè¡Œä¿®æ”¹";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var quotationItem = (QuotationItem)args.Item1;
                await OnSpecificationInput(quotationItem, args.Item2);
            })
        });


        // å‚™è¨»æ¬„ä½ - å³ä½¿å·²è½‰éŠ·è²¨ä¹Ÿå¯ç·¨è¼¯ï¼ˆç”¨æ–¼è¨˜éŒ„åŸ·è¡Œç‹€æ³ï¼‰
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "å‚™è¨»", 
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "150px",
            HideOnMobile = true,
            Tooltip = "é¸å¡«ã€‚å¯è¨˜éŒ„å ±åƒ¹ç›¸é—œçš„å‚™è¨»è³‡è¨Š",
            CustomTemplate = item => 
            {
                var quotationItem = (QuotationItem)item;
                
                // å¦‚æœæ˜¯å”¯è®€ç‹€æ…‹ï¼Œç›´æ¥é¡¯ç¤º span
                if (IsReadOnly)
                {
                    var displayText = string.IsNullOrEmpty(quotationItem.Remarks) ? "ç„¡å‚™è¨»" : quotationItem.Remarks;
                    return @<div class="d-flex align-items-center" style="min-height: 31px;">
                        <span class="text-muted">@displayText</span>
                    </div>;
                }
                
                // å¯ç·¨è¼¯ç‹€æ…‹ï¼Œé¡¯ç¤ºè¼¸å…¥æ¡†
                return @<input type="text" class="form-control " 
                               value="@quotationItem.Remarks"
                               @oninput="(e) => OnRemarksInput(quotationItem, e.Value?.ToString())"
                               placeholder="" />;
            }
        });

        return columns;
    }

    private RenderFragment<QuotationItem> GetCustomActionsTemplate => item => __builder =>
    {
        var quotationItem = (QuotationItem)item;
        var isEmptyRow = quotationItem.SelectedProduct == null;
        var canDelete = DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true);
        var hasComposition = quotationItem.SelectedProduct != null && HasProductComposition(quotationItem.SelectedProduct.Id);
        var isLastEmptyRow = tableComponent?.IsLastEmptyRow(item) ?? false;
        
        <div class="d-flex gap-1">
            @* BOM ç·¨è¼¯æŒ‰éˆ•ï¼ˆå¦‚æœå•†å“æœ‰ BOM çµ„æˆï¼‰ *@
            @if (hasComposition && !isEmptyRow)
            {
                <GenericButtonComponent Variant="ButtonVariant.Blue"
                                       IconClass="bi bi-diagram-3 text-white"
                                       Size="ButtonSize.Large"
                                       Title="ç·¨è¼¯ BOM çµ„æˆ"
                                       OnClick="() => ShowCompositionEditor(quotationItem)"
                                       StopPropagation="true"
                                       CssClass="btn-square" />
            }
            
            @* åŸæœ‰çš„æ“ä½œæŒ‰éˆ• *@
            @if (IsReadOnly)
            {
                // å”¯è®€æ¨¡å¼ï¼šæ‰€æœ‰é …ç›®éƒ½é¡¯ç¤ºæª¢è¦–æŒ‰éˆ•
                <GenericButtonComponent Variant="ButtonVariant.Blue"
                                       IconClass="bi bi-eye text-white"
                                       Size="ButtonSize.Large"
                                       Title="æŸ¥çœ‹ç›¸é—œå–®æ“š"
                                       OnClick="async () => await ShowRelatedDocuments(quotationItem)"
                                       StopPropagation="true"
                                       CssClass="btn-square" />
            }
            else if (isLastEmptyRow)
            {
                // æœ€å¾Œä¸€å€‹ç©ºè¡Œï¼šé¡¯ç¤ºç¦ç”¨çš„åˆªé™¤æŒ‰éˆ•
                <GenericButtonComponent Variant="ButtonVariant.Red"
                                       IconClass="bi bi-trash text-white"
                                       Size="ButtonSize.Large"
                                       IsDisabled="true"
                                       Title="è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹ç©ºè¡Œ"
                                       StopPropagation="true"
                                       CssClass="btn-square" />
            }
            else if (canDelete || isEmptyRow)
            {
                // å¯ç·¨è¼¯æ¨¡å¼ä¸”æœªè½‰éŠ·è²¨ï¼ˆæˆ–æ˜¯ç©ºè¡Œï¼‰ï¼šé¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
                <GenericButtonComponent Variant="ButtonVariant.Red"
                                       IconClass="bi bi-trash text-white"
                                       Size="ButtonSize.Large"
                                       Title="åˆªé™¤"
                                       OnClick="async () => await HandleItemDelete(quotationItem)"
                                       StopPropagation="true"
                                       CssClass="btn-square" />
            }
            else
            {
                // å·²è½‰éŠ·è²¨ä¸”éç©ºè¡Œï¼šé¡¯ç¤ºæŸ¥çœ‹ç›¸é—œå–®æ“šæŒ‰éˆ•
                <GenericButtonComponent Variant="ButtonVariant.Blue"
                                       IconClass="bi bi-eye text-white"
                                       Size="ButtonSize.Large"
                                       Title="æŸ¥çœ‹ç›¸é—œå–®æ“š"
                                       OnClick="async () => await ShowRelatedDocuments(quotationItem)"
                                       StopPropagation="true"
                                       CssClass="btn-square" />
            }
        </div>
    };

    private async Task HandleItemDelete(QuotationItem item)
    {
        var index = QuotationItems.IndexOf(item);
        await RemoveItemAsync(index);
    }

    /// <summary>
    /// é¡¯ç¤ºç›¸é—œå–®æ“šï¼ˆéŠ·è²¨è¨‚å–®ï¼‰
    /// </summary>
    private async Task ShowRelatedDocuments(QuotationItem item)
    {
        if (item.ExistingDetailEntity is not QuotationDetail detail || detail.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("æ­¤æ˜ç´°å°šæœªå„²å­˜ï¼Œç„¡æ³•æŸ¥çœ‹ç›¸é—œå–®æ“š", "æç¤º");
            return;
        }

        selectedProductName = item.SelectedProduct?.Name ?? "æœªçŸ¥å•†å“";
        
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsByQuotationDetailAsync(detail.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ç›¸é—œå–®æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}", "éŒ¯èª¤");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// è™•ç†é»æ“Šç›¸é—œå–®æ“šçš„äº‹ä»¶
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // è§¸ç™¼äº‹ä»¶ï¼Œè®“çˆ¶çµ„ä»¶ï¼ˆEditModalï¼‰è™•ç†é–‹å•Ÿç›¸é—œå–®æ“š
        // æ³¨æ„ï¼šä¸é—œé–‰ RelatedDocumentsModalï¼Œè®“ä½¿ç”¨è€…å¯ä»¥ç¹¼çºŒæŸ¥çœ‹åˆ—è¡¨
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            // å¦‚æœçˆ¶çµ„ä»¶æ²’æœ‰è™•ç†æ­¤äº‹ä»¶ï¼Œå‰‡é¡¯ç¤ºæç¤ºè¨Šæ¯
            await NotificationService.ShowInfoAsync(
                $"è«‹åœ¨çˆ¶çµ„ä»¶ä¸­å¯¦ä½œ OnOpenRelatedDocument äº‹ä»¶è™•ç†å™¨ä»¥é–‹å•Ÿ {document.TypeDisplayName}",
                "æç¤º"
            );
        }
    }

    // ===== BOM çµ„åˆç·¨è¼¯ç›¸é—œæ–¹æ³• =====
    
    /// <summary>
    /// æª¢æŸ¥å•†å“æ˜¯å¦æœ‰ BOM çµ„æˆ
    /// </summary>
    private bool HasProductComposition(int productId)
    {
        // å¾å¿«å–ä¸­æª¢æŸ¥è©²å•†å“æ˜¯å¦æœ‰ ProductComposition
        return productsWithComposition.Contains(productId);
    }
    
    /// <summary>
    /// é¡¯ç¤º BOM çµ„åˆç·¨è¼¯å™¨ - æ™ºèƒ½åˆ¤æ–·æ˜¯å¦éœ€è¦é¸æ“‡é…æ–¹
    /// </summary>
    private async Task ShowCompositionEditor(QuotationItem item)
    {
        if (item.SelectedProduct == null) return;
        
        selectedQuotationItemIndex = QuotationItems.IndexOf(item);
        selectedCompositionProductName = item.SelectedProduct.Name;
        selectedCompositionProductId = item.SelectedProduct.Id;
        
        // æª¢æŸ¥æ˜¯å¦å·²æœ‰çµ„åˆè³‡æ–™
        if (item.HasCompositionData)
        {
            // å·²æœ‰è³‡æ–™ï¼Œç›´æ¥é–‹å•Ÿç·¨è¼¯å™¨
            selectedCompositionId = item.SelectedCompositionId;
            isCustomCompositionMode = item.IsCustomComposition;
            showCompositionModal = true;
        }
        else
        {
            // å°šæœªé¸æ“‡é…æ–¹ï¼Œé¡¯ç¤ºé¸æ“‡å™¨
            availableCompositions = await ProductCompositionService
                .GetCompositionsByProductIdAsync(item.SelectedProduct.Id);
            showCompositionSelectorModal = true;
        }
        
        StateHasChanged();
    }
    
    /// <summary>
    /// è™•ç†é…æ–¹é¸æ“‡
    /// </summary>
    private void HandleCompositionSelected((int? compositionId, bool isCustomMode) selection)
    {
        showCompositionSelectorModal = false;
        
        selectedCompositionId = selection.compositionId;
        isCustomCompositionMode = selection.isCustomMode;
        
        // è¨˜éŒ„é¸æ“‡è³‡è¨Šåˆ° QuotationItem
        if (selectedQuotationItemIndex.HasValue)
        {
            var item = QuotationItems.ElementAtOrDefault(selectedQuotationItemIndex.Value);
            if (item != null)
            {
                item.SelectedCompositionId = selection.compositionId;
                item.IsCustomComposition = selection.isCustomMode;
                
                // å¦‚æœæ˜¯é‡æ–°é¸æ“‡ï¼Œæ¸…é™¤èˆŠçš„å¿«å–è³‡æ–™
                if (isReselectingComposition)
                {
                    item.CustomCompositionDetails = null;
                    if (item.SelectedProduct != null && compositionDetailsCache.ContainsKey(item.SelectedProduct.Id))
                    {
                        compositionDetailsCache.Remove(item.SelectedProduct.Id);
                    }
                }
            }
        }
        
        // é–‹å•Ÿ BOM ç·¨è¼¯å™¨
        showCompositionModal = true;
        StateHasChanged();
    }
    
    /// <summary>
    /// å–å¾— BOM ç·¨è¼¯ Modal çš„å”¯è®€ç‹€æ…‹
    /// å¦‚æœå…¨åŸŸå”¯è®€æˆ–ç•¶å‰é¸ä¸­çš„æ˜ç´°å·²è½‰å–®ï¼Œå‰‡ Modal æ‡‰è©²ç‚ºå”¯è®€
    /// </summary>
    private bool GetCompositionModalReadOnlyState()
    {
        if (IsReadOnly) return true;
        
        if (!selectedQuotationItemIndex.HasValue || selectedQuotationItemIndex.Value < 0)
            return false;
            
        var item = QuotationItems.ElementAtOrDefault(selectedQuotationItemIndex.Value);
        if (item == null) return false;
        
        // æª¢æŸ¥æ˜¯å¦å·²è½‰å–®ï¼ˆConvertedQuantity > 0ï¼‰
        return item.ConvertedQuantity > 0;
    }
    
    /// <summary>
    /// å–å¾—é¸ä¸­çš„å ±åƒ¹å–®æ˜ç´° IDï¼ˆç”¨æ–¼ Modalï¼‰
    /// </summary>
    private int? GetSelectedQuotationDetailId()
    {
        if (!selectedQuotationItemIndex.HasValue || selectedQuotationItemIndex.Value < 0)
            return null;
            
        var item = QuotationItems.ElementAtOrDefault(selectedQuotationItemIndex.Value);
        if (item?.ExistingDetailEntity is QuotationDetail detail && detail.Id > 0)
            return detail.Id;
            
        // å¦‚æœæ˜¯æ–°çš„é …ç›®ï¼Œæš«æ™‚è¿”å›ä¸€å€‹è‡¨æ™‚ IDï¼ˆè² æ•¸è¡¨ç¤ºå°šæœªå„²å­˜ï¼‰
        return -(selectedQuotationItemIndex.Value + 1);
    }
    
    /// <summary>
    /// è™•ç† BOM çµ„åˆå„²å­˜
    /// </summary>
    private async Task HandleCompositionSave(List<QuotationCompositionDetail> compositionDetails)
    {
        if (!selectedQuotationItemIndex.HasValue || !selectedCompositionProductId.HasValue)
            return;
            
        try
        {
            // æš«å­˜åˆ°å¿«å–ï¼ˆå¯¦éš›å„²å­˜æœƒåœ¨å ±åƒ¹å–®å„²å­˜æ™‚ä¸€ä½µè™•ç†ï¼‰
            compositionDetailsCache[selectedCompositionProductId.Value] = compositionDetails;
            
            // åŒæ™‚æ›´æ–° QuotationItem çš„ CustomCompositionDetailsï¼ˆç¢ºä¿è³‡æ–™åŒæ­¥ï¼‰
            var item = QuotationItems.ElementAtOrDefault(selectedQuotationItemIndex.Value);
            if (item != null)
            {
                item.CustomCompositionDetails = compositionDetails;
                
                // ç¢ºä¿é¸æ“‡è³‡è¨Šå·²è¨˜éŒ„ï¼ˆå¦‚æœé‚„æ²’è¨˜éŒ„çš„è©±ï¼‰
                if (!item.SelectedCompositionId.HasValue && !item.IsCustomComposition)
                {
                    item.SelectedCompositionId = selectedCompositionId;
                    item.IsCustomComposition = isCustomCompositionMode;
                }
            }
            
            await NotificationService.ShowSuccessAsync("BOM çµ„æˆå·²æ›´æ–°ï¼Œè«‹è¨˜å¾—å„²å­˜å ±åƒ¹å–®ä»¥ä¿å­˜è®Šæ›´");
            showCompositionModal = false;
            isReselectingComposition = false;  // å„²å­˜å®Œæˆå¾Œé‡ç½®
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å„²å­˜ BOM çµ„æˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }
    
    /// <summary>
    /// è™•ç† BOM çµ„åˆå–æ¶ˆ
    /// </summary>
    private void HandleCompositionCancel()
    {
        showCompositionModal = false;
        isReselectingComposition = false;
    }
    
    /// <summary>
    /// å–å¾—å¿«å–çš„çµ„åˆæ˜ç´°è³‡æ–™ï¼ˆä¾› Modal ä½¿ç”¨ï¼‰
    /// </summary>
    private List<QuotationCompositionDetail>? GetCachedCompositionData()
    {
        if (!selectedQuotationItemIndex.HasValue)
            return null;
            
        var item = QuotationItems.ElementAtOrDefault(selectedQuotationItemIndex.Value);
        if (item == null)
            return null;
        
        // å„ªå…ˆè¿”å› CustomCompositionDetails
        if (item.CustomCompositionDetails?.Any() == true)
            return item.CustomCompositionDetails;
            
        // å…¶æ¬¡å¾å¿«å–ä¸­å–å¾—
        if (item.SelectedProduct != null && compositionDetailsCache.ContainsKey(item.SelectedProduct.Id))
            return compositionDetailsCache[item.SelectedProduct.Id];
        
        return null;
    }
    
    /// <summary>
    /// è™•ç†é‡æ–°é¸æ“‡é…æ–¹
    /// </summary>
    private async Task HandleCompositionReselect()
    {
        // å…ˆæ¨™è¨˜ç‚ºé‡æ–°é¸æ“‡æ¨¡å¼ï¼ˆåœ¨é—œé–‰ Modal ä¹‹å‰ï¼‰
        isReselectingComposition = true;
        
        // é—œé–‰ç•¶å‰çš„ BOM ç·¨è¼¯ Modal
        showCompositionModal = false;
        
        // æ¸…é™¤ç•¶å‰é¸æ“‡çš„é…æ–¹è³‡è¨Š
        if (selectedQuotationItemIndex.HasValue)
        {
            var item = QuotationItems.ElementAtOrDefault(selectedQuotationItemIndex.Value);
            if (item?.SelectedProduct != null)
            {
                // é‡æ–°è¼‰å…¥é…æ–¹æ¸…å–®
                availableCompositions = await ProductCompositionService
                    .GetCompositionsByProductIdAsync(item.SelectedProduct.Id);
                
                // é¡¯ç¤ºé…æ–¹é¸æ“‡å™¨
                showCompositionSelectorModal = true;
                StateHasChanged();
            }
        }
    }

    // ===== å…§éƒ¨æ–¹æ³• =====
    /// <summary>
    /// å…¬é–‹æ–¹æ³•ï¼šåˆ·æ–°æ˜ç´°è³‡æ–™ï¼ˆä¾›çˆ¶çµ„ä»¶å‘¼å«ï¼‰
    /// ç”¨æ–¼éŠ·è²¨è¨‚å–®å„²å­˜å¾Œï¼Œé‡æ–°è¼‰å…¥æ˜ç´°ä»¥æ›´æ–°è½‰å–®æ•¸é‡
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        // é‡æ–°è¼‰å…¥ç¾æœ‰æ˜ç´°ï¼ˆæœƒå¾ ExistingDetails åƒæ•¸é‡æ–°è¼‰å…¥ï¼‰
        await LoadExistingDetailsAsync();
        
        // å¼·åˆ¶ UI æ›´æ–°
        StateHasChanged();
    }
    
    /// <summary>
    /// å¾ç¾æœ‰æ˜ç´°è³‡æ–™è¼‰å…¥åˆ° QuotationItems
    /// </summary>
    private async Task LoadExistingDetailsAsync()
    {
        if (ExistingDetails?.Any() != true) 
        {
            return;
        }

        // ğŸ”§ ä¿®æ­£ï¼šè¨­å®šè¼‰å…¥é–‹å§‹æ¨™è¨˜
        _dataLoadCompleted = false;

        // ç²å–ç³»çµ±é è¨­ç¨…ç‡
        var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();

        QuotationItems.Clear();
        
            foreach (var detail in ExistingDetails)
            {
                // è½‰æ›ç‚ºæ­£ç¢ºçš„å¯¦é«”é¡å‹
                if (detail is QuotationDetail quotationDetail)
                {
                    var item = new QuotationItem
                    {
                        // ç›´æ¥ä½¿ç”¨ Navigation Properties
                        SelectedProduct = quotationDetail.Product,
                        SelectedUnit = quotationDetail.Unit,
                    
                        // è¨­å®šæœå°‹é¡¯ç¤ºå€¼ï¼ˆä¿®æ­£ç·¨è¼¯æ¨¡å¼é¡¯ç¤ºå•é¡Œï¼‰
                        ProductSearchValue = quotationDetail.Product != null ? 
                            $"[{quotationDetail.Product.Code}] {quotationDetail.Product.Name}" : string.Empty,
                    
                        // ç›´æ¥ä½¿ç”¨å±¬æ€§å€¼
                        Quantity = quotationDetail.Quantity,
                        UnitPrice = quotationDetail.UnitPrice,
                        DiscountPercentage = quotationDetail.DiscountPercentage,
                        ConvertedQuantity = quotationDetail.ConvertedQuantity,
                        TaxRate = quotationDetail.TaxRate ?? quotationDetail.Product?.TaxRate ?? defaultTaxRate,
                        Specification = quotationDetail.Specification ?? quotationDetail.Product?.Specification ?? string.Empty,
                        Remarks = quotationDetail.Remarks ?? string.Empty,
                        ExistingDetailEntity = detail
                    };
                
                    // è¼‰å…¥è©²æ˜ç´°çš„çµ„åˆæ˜ç´°è³‡æ–™ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                    if (quotationDetail.Id > 0)
                    {
                        var compositionDetails = await QuotationCompositionDetailService
                            .GetByQuotationDetailIdAsync(quotationDetail.Id);
                    
                        if (compositionDetails.Any())
                        {
                            item.CustomCompositionDetails = compositionDetails;
                            // æ³¨æ„ï¼šç„¡æ³•å¾—çŸ¥åŸå§‹é¸æ“‡çš„é…æ–¹IDï¼Œè¦–ç‚ºå·²è‡ªå®šç¾©
                            item.IsCustomComposition = true;
                        }
                    }
                
                    QuotationItems.Add(item);
                }
                else
                {
                    // å°æ–¼é QuotationDetail é¡å‹ï¼Œä¿ç•™åŸæœ‰çš„æ³›å‹é‚è¼¯ä½œç‚ºå¾Œå‚™
                    var productId = GetPropertyValue<int>(detail, "ProductId");
                    var product = Products.FirstOrDefault(p => p.Id == productId);
                
                    if (product != null)
                    {
                        var item = new QuotationItem
                        {
                            SelectedProduct = product,
                            ProductSearchValue = $"[{product.Code}] {product.Name}",  // è¨­å®šæœå°‹é¡¯ç¤ºå€¼
                            Quantity = Convert.ToDecimal(GetPropertyValue<object>(detail, QuantityPropertyName) ?? 0m),
                            UnitPrice = Convert.ToDecimal(GetPropertyValue<object>(detail, UnitPricePropertyName) ?? 0m),
                            DiscountPercentage = Convert.ToDecimal(GetPropertyValue<object>(detail, DiscountPercentagePropertyName) ?? 0m),
                            ConvertedQuantity = Convert.ToDecimal(GetPropertyValue<object>(detail, "ConvertedQuantity") ?? 0m),
                            TaxRate = product.TaxRate ?? defaultTaxRate,
                            Remarks = GetPropertyValue<string>(detail, RemarksPropertyName) ?? string.Empty,
                            ExistingDetailEntity = detail
                        };
                    
                        // è¼‰å…¥å–®ä½è³‡è¨Š
                        if (!string.IsNullOrEmpty(UnitIdPropertyName))
                        {
                            var unitId = GetPropertyValue<int?>(detail, UnitIdPropertyName);
                            if (unitId.HasValue)
                            {
                                item.SelectedUnit = Units.FirstOrDefault(u => u.Id == unitId.Value);
                            }
                        }
                    
                        QuotationItems.Add(item);
                    }
                }
            }
        
            // æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²è½‰è¨‚å–®ï¼‰
            bool hasUndeletableDetails = QuotationItems.Any(item => 
                item.SelectedProduct != null && !DetailLockHelper.CanDeleteItem(item, out _, checkConversion: true));
            if (_hasUndeletableDetails != hasUndeletableDetails)
            {
                _hasUndeletableDetails = hasUndeletableDetails;
            }
        
        // ğŸ”§ ä¿®æ­£ï¼šè¨­å®šè¼‰å…¥å®Œæˆæ¨™è¨˜ä¸¦è§¸ç™¼ UI æ›´æ–°
        _dataLoadCompleted = true;
        StateHasChanged();
    }

    private List<TDetailEntity> ConvertToDetailEntities()
    {
        var details = new List<TDetailEntity>();
        
        // åªè™•ç†éç©ºè¡Œã€æœ‰é¸æ“‡å•†å“çš„é …ç›®ï¼ˆæ•¸é‡å’Œå–®åƒ¹å¯ä»¥ç‚º 0ï¼‰
        foreach (var item in QuotationItems.Where(x => x.SelectedProduct != null))
        {
            TDetailEntity detail;
            
            if (item.ExistingDetailEntity != null)
            {
                detail = item.ExistingDetailEntity;
                
                // å¦‚æœæ˜¯ QuotationDetail é¡å‹ï¼Œç›´æ¥è¨­ç½®å±¬æ€§
                if (detail is QuotationDetail quotationDetail)
                {
                    quotationDetail.Quantity = item.Quantity;
                    quotationDetail.UnitPrice = item.UnitPrice;
                    quotationDetail.DiscountPercentage = item.DiscountPercentage;
                    quotationDetail.TaxRate = item.TaxRate;
                    quotationDetail.Specification = item.Specification;
                    quotationDetail.Remarks = item.Remarks;
                    // ConvertedQuantity ä¸æ‡‰åœ¨æ­¤æ›´æ–°ï¼Œå®ƒç”±è½‰å–®æµç¨‹æ§åˆ¶
                    
                    if (item.SelectedUnit != null)
                        quotationDetail.UnitId = item.SelectedUnit.Id;
                    
                    if (item.SelectedProduct != null)
                        quotationDetail.ProductId = item.SelectedProduct.Id;
                }
                else
                {
                    // å°æ–¼å…¶ä»–é¡å‹ï¼Œä½¿ç”¨åå°„
                    SetPropertyValue(detail, QuantityPropertyName, item.Quantity);
                    SetPropertyValue(detail, UnitPricePropertyName, item.UnitPrice);
                    SetPropertyValue(detail, DiscountPercentagePropertyName, item.DiscountPercentage);
                    SetPropertyValue(detail, RemarksPropertyName, item.Remarks);
                    
                    if (!string.IsNullOrEmpty(UnitIdPropertyName) && item.SelectedUnit != null)
                    {
                        SetPropertyValue(detail, UnitIdPropertyName, item.SelectedUnit.Id);
                    }
                }
            }
            else
            {
                detail = new TDetailEntity();
                
                if (MainEntity != null && !string.IsNullOrEmpty(MainEntityIdPropertyName))
                {
                    SetPropertyValue(detail, MainEntityIdPropertyName, MainEntity.Id);
                }
                
                // è¨­å®šå•†å“ID
                if (item.SelectedProduct != null)
                {
                    SetPropertyValue(detail, "ProductId", item.SelectedProduct.Id);
                }
                
                SetPropertyValue(detail, QuantityPropertyName, item.Quantity);
                SetPropertyValue(detail, UnitPricePropertyName, item.UnitPrice);
                SetPropertyValue(detail, DiscountPercentagePropertyName, item.DiscountPercentage);
                SetPropertyValue(detail, RemarksPropertyName, item.Remarks);
                
                if (!string.IsNullOrEmpty(UnitIdPropertyName) && item.SelectedUnit != null)
                {
                    SetPropertyValue(detail, UnitIdPropertyName, item.SelectedUnit.Id);
                }
                
                // æ–°å¢çš„æ˜ç´°ï¼ŒConvertedQuantity é è¨­ç‚º 0ï¼Œä¸¦è¨­å®šç¨…ç‡å’Œè¦æ ¼èªªæ˜
                if (detail is QuotationDetail newQuotationDetail)
                {
                    newQuotationDetail.ConvertedQuantity = 0;
                    newQuotationDetail.TaxRate = item.TaxRate;
                    newQuotationDetail.Specification = item.Specification;
                }
            }
            
            details.Add(detail);
        }
        
        return details;
    }

    private async Task NotifyDetailsChanged()
    {
        var details = ConvertToDetailEntities();
        await DetailSyncHelper.SyncToParentAsync(details, OnDetailsChanged);
        
        // é€šçŸ¥å·²åˆªé™¤çš„æ˜ç´° ID
        if (OnDeletedDetailsChanged.HasDelegate && _deletedDetailIds.Any())
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds.ToList());
            _deletedDetailIds.Clear();
        }
        
        // æª¢æŸ¥ä¸¦æ›´æ–°ä¸å¯åˆªé™¤æ˜ç´°çš„ç‹€æ…‹
        bool hasUndeletableDetails = QuotationItems.Any(item => 
            item.SelectedProduct != null && !DetailLockHelper.CanDeleteItem(item, out _, checkConversion: true));
        if (_hasUndeletableDetails != hasUndeletableDetails)
        {
            _hasUndeletableDetails = hasUndeletableDetails;
        }
        
        // ğŸ”§ ä¿®æ­£ï¼šç„¡æ¢ä»¶åˆ·æ–°ç©ºè¡Œå’Œè§¸ç™¼ UI æ›´æ–°ï¼Œç¢ºä¿é¸æ“‡å•†å“å¾Œç«‹å³é¡¯ç¤º
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }

    private T? GetPropertyValue<T>(object obj, string propertyName)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property == null) return default(T);
        
        var value = property.GetValue(obj);
        if (value == null) return default(T);
        
        if (typeof(T) == typeof(object)) return (T)value;
        
        return (T)Convert.ChangeType(value, typeof(T));
    }

    private void SetPropertyValue(object obj, string propertyName, object? value)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property != null && property.CanWrite)
        {
            if (value != null && property.PropertyType != value.GetType())
            {
                if (property.PropertyType.IsGenericType && property.PropertyType.GetGenericTypeDefinition() == typeof(Nullable<>))
                {
                    var underlyingType = Nullable.GetUnderlyingType(property.PropertyType);
                    value = Convert.ChangeType(value, underlyingType!);
                }
                else
                {
                    value = Convert.ChangeType(value, property.PropertyType);
                }
            }
            property.SetValue(obj, value);
        }
    }

    // ===== äº‹ä»¶è™•ç†æ–¹æ³• =====

    // ===== å•†å“ SearchableSelect äº‹ä»¶è™•ç† =====
    
    /// <summary>
    /// å•†å“è¼¸å…¥æ¡†ç²å¾—ç„¦é»
    /// </summary>
    private void OnProductFocus(QuotationItem item)
    {
        var availableProducts = GetAvailableProducts();
        
        item.FilteredProducts = availableProducts.Take(20).ToList();
        item.ShowProductDropdown = true;
        item.ProductSelectedIndex = -1;
        StateHasChanged();
    }
    
    /// <summary>
    /// å•†å“è¼¸å…¥æ¡†å¤±å»ç„¦é»
    /// </summary>
    private void OnProductBlur(QuotationItem item)
    {
        Task.Delay(200).ContinueWith(_ =>
        {
            item.ShowProductDropdown = false;
            InvokeAsync(StateHasChanged);
        });
    }
    
    /// <summary>
    /// å•†å“æœå°‹è¼¸å…¥è®Šæ›´äº‹ä»¶ï¼ˆSearchableSelectï¼‰
    /// </summary>
    private void OnProductSearchChanged(QuotationItem item, string? searchValue)
    {
        item.ProductSearchValue = searchValue ?? string.Empty;
        
        var availableProducts = GetAvailableProducts();
        
        if (string.IsNullOrWhiteSpace(searchValue))
        {
            // ç©ºç™½æœå°‹ï¼šé¡¯ç¤ºå‰20ç­†
            item.FilteredProducts = availableProducts.Take(20).ToList();
        }
        else
        {
            // ç¯©é¸ç¬¦åˆçš„å•†å“ï¼ˆç·¨è™Ÿæˆ–åç¨±åŒ…å«æœå°‹å­—ä¸²ï¼‰
            item.FilteredProducts = availableProducts
                .Where(p => (p.Code?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                           (p.Name?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false))
                .Take(20)
                .ToList();
        }
        
        item.ShowProductDropdown = true;
        item.ProductSelectedIndex = -1;
        StateHasChanged();
    }
    
    /// <summary>
    /// å•†å“é¸æ“‡äº‹ä»¶ï¼ˆSearchableSelectï¼‰
    /// </summary>
    private async Task OnProductSelected(QuotationItem item, Product? selectedProduct)
    {
        if (selectedProduct != null)
        {
            item.SelectedProduct = selectedProduct;
            item.ProductSearchValue = $"[{selectedProduct.Code}] {selectedProduct.Name}";
            
            // è‡ªå‹•è¨­å®šé è¨­å–®ä½ï¼ˆå¦‚æœå•†å“æœ‰é è¨­å–®ä½ï¼‰
            if (selectedProduct.Unit != null)
            {
                item.SelectedUnit = selectedProduct.Unit;
            }
            
            // è‡ªå‹•å¸¶å…¥è¦æ ¼èªªæ˜
            item.Specification = selectedProduct.Specification ?? string.Empty;
            
            // è‡ªå‹•å¸¶å…¥ç¨…ç‡ï¼ˆå•†å“ç¨…ç‡ > ç³»çµ±é è¨­å€¼ï¼‰
            if (selectedProduct.TaxRate.HasValue)
            {
                item.TaxRate = selectedProduct.TaxRate.Value;
            }
            else
            {
                var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();
                item.TaxRate = defaultTaxRate;
            }
        }
        else
        {
            item.SelectedProduct = null;
            item.ProductSearchValue = string.Empty;
            item.SelectedUnit = null;
            item.Specification = string.Empty;
            item.TaxRate = null;
        }
        
        item.ShowProductDropdown = false;
        item.ProductSelectedIndex = -1;
        
        await NotifyDetailsChanged();
    }

    private async Task OnQuantityInput(QuotationItem item, string? value)
    {
        // æª¢æŸ¥å…¨åŸŸå”¯è®€æˆ–å€‹åˆ¥æ˜ç´°å·²è½‰éŠ·è²¨
        var hasConverted = item.ConvertedQuantity > 0;
        var isEmptyRow = item.SelectedProduct == null;
        if (IsReadOnly || (hasConverted && !isEmptyRow)) return;
        
        item.Quantity = InputEventHelper.HandleQuantityInput(value, 0);
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnUnitPriceInput(QuotationItem item, string? value)
    {
        // æª¢æŸ¥å…¨åŸŸå”¯è®€æˆ–å€‹åˆ¥æ˜ç´°å·²è½‰éŠ·è²¨
        var hasConverted = item.ConvertedQuantity > 0;
        var isEmptyRow = item.SelectedProduct == null;
        if (IsReadOnly || (hasConverted && !isEmptyRow)) return;
        
        if (string.IsNullOrEmpty(value))
        {
            item.UnitPrice = 0;
        }
        else if (decimal.TryParse(value, out var unitPrice))
        {
            item.UnitPrice = unitPrice;
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnDiscountPercentageInput(QuotationItem item, string? value)
    {
        // æª¢æŸ¥å…¨åŸŸå”¯è®€æˆ–å€‹åˆ¥æ˜ç´°å·²è½‰éŠ·è²¨
        var hasConverted = item.ConvertedQuantity > 0;
        var isEmptyRow = item.SelectedProduct == null;
        if (IsReadOnly || (hasConverted && !isEmptyRow)) return;
        
        if (string.IsNullOrEmpty(value))
        {
            item.DiscountPercentage = 0;
        }
        else if (decimal.TryParse(value, out var discount))
        {
            // é™åˆ¶æŠ˜æ‰£ç™¾åˆ†æ¯”åœ¨ 0-100 ä¹‹é–“
            // å¦‚æœè¼¸å…¥å€¼è¶…é100ï¼Œç›´æ¥è¨­ç‚º100ä¸¦å¼·åˆ¶æ›´æ–°UI
            var limitedDiscount = Math.Max(0, Math.Min(100, discount));
            item.DiscountPercentage = limitedDiscount;
            
            // å¦‚æœå€¼è¢«é™åˆ¶äº†ï¼Œå¼·åˆ¶åˆ·æ–°UIä»¥é¡¯ç¤ºä¿®æ­£å¾Œçš„å€¼
            if (limitedDiscount != discount)
            {
                StateHasChanged();
            }
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    private async Task OnRemarksInput(QuotationItem item, string? value)
    {
        item.Remarks = value ?? string.Empty;
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    /// <summary>
    /// è™•ç†è¦æ ¼èªªæ˜è¼¸å…¥
    /// </summary>
    private async Task OnSpecificationInput(QuotationItem item, string? value)
    {
        // æª¢æŸ¥å…¨åŸŸå”¯è®€æˆ–å€‹åˆ¥æ˜ç´°å·²è½‰éŠ·è²¨
        var hasConverted = item.ConvertedQuantity > 0;
        var isEmptyRow = item.SelectedProduct == null;
        if (IsReadOnly || (hasConverted && !isEmptyRow)) return;
        
        item.Specification = value ?? string.Empty;
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    /// <summary>
    /// è™•ç†ç¨…ç‡è¼¸å…¥
    /// </summary>
    private async Task OnTaxRateInput(QuotationItem item, string? valueString)
    {
        if (string.IsNullOrWhiteSpace(valueString))
        {
            item.TaxRate = null;
        }
        else
        {
            var taxRate = InputEventHelper.HandlePercentageInput(valueString, 0, 100, 0);
            item.TaxRate = taxRate;
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    /// <summary>
    /// è¨ˆç®—æ˜ç´°é …ç›®çš„å°è¨ˆï¼ˆæ ¹æ“šç¨…åˆ¥ï¼Œå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
    /// </summary>
    private decimal CalculateItemSubtotal(QuotationItem item)
    {
        if (item.SelectedProduct == null || item.Quantity <= 0 || item.UnitPrice <= 0)
        {
            return 0;
        }

        var subtotal = CalculationHelper.CalculateSubtotal(
            item.Quantity,
            item.UnitPrice,
            item.DiscountPercentage,
            item.TaxRate ?? 0,
            TaxCalculationMethod
        );
        
        // å››æ¨äº”å…¥åˆ°æ•´æ•¸
        return CalculationHelper.Round(subtotal, 0);
    }

    /// <summary>
    /// å–å¾—å°è¨ˆæ¬„ä½çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetSubtotalTooltip()
    {
        return TaxCalculationMethod switch
        {
            TaxCalculationMethod.TaxExclusive => "å°è¨ˆ = æ•¸é‡ Ã— å–®åƒ¹ Ã— (1 - æŠ˜æ‰£%) Ã— (1 + ç¨…ç‡%)ï¼Œå››æ¨äº”å…¥åˆ°æ•´æ•¸",
            TaxCalculationMethod.TaxInclusive => "å°è¨ˆ = æ•¸é‡ Ã— å–®åƒ¹ Ã— (1 - æŠ˜æ‰£%)ï¼Œå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼ˆå–®åƒ¹å·²å«ç¨…ï¼‰",
            TaxCalculationMethod.NoTax => "å°è¨ˆ = æ•¸é‡ Ã— å–®åƒ¹ Ã— (1 - æŠ˜æ‰£%)ï¼Œå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼ˆå…ç¨…ï¼‰",
            _ => "å°è¨ˆé‡‘é¡ï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰"
        };
    }
    
    /// <summary>
    /// å–å¾—å•†å“çš„è£½ç¨‹å–®ä½åç¨±
    /// </summary>
    private string GetProductionUnitName(QuotationItem item)
    {
        // å¦‚æœæ²’æœ‰é¸æ“‡å•†å“ï¼Œå›å‚³ç©ºå­—ä¸²
        if (item.SelectedProduct == null)
        {
            return string.Empty;
        }
        
        // å„ªå…ˆä½¿ç”¨è£½ç¨‹å–®ä½ï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨å•†å“å–®ä½
        var productionUnitId = item.SelectedProduct.ProductionUnitId ?? item.SelectedProduct.UnitId;
        
        if (productionUnitId <= 0)
        {
            return string.Empty;
        }
        
        // å¾å¯ç”¨å–®ä½æ¸…å–®ä¸­æŸ¥æ‰¾å–®ä½åç¨±
        var unit = Units.FirstOrDefault(u => u.Id == productionUnitId);
        return unit?.Name ?? string.Empty;
    }

    public async Task RemoveItemAsync(int index)
    {
        if (IsReadOnly || index < 0 || index >= QuotationItems.Count) return;
        
        var removedItem = QuotationItems[index];
        
        // æª¢æŸ¥æ˜¯å¦å·²è½‰éŠ·è²¨ï¼Œå·²è½‰éŠ·è²¨çš„é …ç›®ä¸å…è¨±åˆªé™¤
        if (removedItem.ConvertedQuantity > 0)
        {
            await NotificationService.ShowWarningAsync("æ­¤æ˜ç´°å·²è½‰éŠ·è²¨ï¼Œç„¡æ³•åˆªé™¤", "æ“ä½œå¤±æ•—");
            return;
        }
        
        // è¨˜éŒ„è¦åˆªé™¤çš„è³‡æ–™åº«å¯¦é«”ID
        if (removedItem.ExistingDetailEntity != null)
        {
            var entityId = GetExistingDetailId(removedItem.ExistingDetailEntity);
            if (entityId > 0)
            {
                _deletedDetailIds.Add(entityId);
            }
        }
        
        // é€šçŸ¥çˆ¶çµ„ä»¶é …ç›®å³å°‡è¢«ç§»é™¤
        if (OnItemRemoved.HasDelegate)
        {
            await OnItemRemoved.InvokeAsync(removedItem);
        }
        
        QuotationItems.Remove(removedItem);
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }

    /// <summary>
    /// å–å¾—ç¾æœ‰æ˜ç´°å¯¦é«”çš„ID
    /// </summary>
    private int GetExistingDetailId(TDetailEntity entity)
    {
        if (entity == null) return 0;
        
        var idProperty = entity.GetType().GetProperty("Id");
        if (idProperty != null && idProperty.PropertyType == typeof(int))
        {
            var value = idProperty.GetValue(entity);
            return value != null ? (int)value : 0;
        }
        
        return 0;
    }

    /// <summary>
    /// æ¸…é™¤æ˜ç´°
    /// </summary>
    private async Task ClearAllDetails()
    {
        // åªæ¸…é™¤æœªè½‰éŠ·è²¨çš„é …ç›®
        var nonEmptyItems = QuotationItems.Where(item => item.SelectedProduct != null).ToList();
        var itemsToRemove = nonEmptyItems.Where(item => item.ConvertedQuantity == 0).ToList();
        var convertedItems = nonEmptyItems.Where(item => item.ConvertedQuantity > 0).ToList();
        
        if (!itemsToRemove.Any())
        {
            if (convertedItems.Any())
            {
                await NotificationService.ShowWarningAsync("æ‰€æœ‰æ˜ç´°é …ç›®éƒ½å·²è½‰éŠ·è²¨ï¼Œç„¡æ³•æ¸…é™¤", "æç¤º");
            }
            else
            {
                await NotificationService.ShowWarningAsync("æ²’æœ‰å¯æ¸…é™¤çš„æ˜ç´°é …ç›®", "æç¤º");
            }
            return;
        }
        
        // é€šçŸ¥çˆ¶çµ„ä»¶é …ç›®å³å°‡è¢«ç§»é™¤
        if (OnItemRemoved.HasDelegate)
        {
            foreach (var item in itemsToRemove)
            {
                await OnItemRemoved.InvokeAsync(item);
            }
        }
        
        // è¨˜éŒ„æ‰€æœ‰è¦åˆªé™¤çš„ç¾æœ‰æ˜ç´° ID
        foreach (var item in itemsToRemove.Where(item => item.ExistingDetailEntity != null))
        {
            var entityId = GetExistingDetailId(item.ExistingDetailEntity!);
            if (entityId > 0)
            {
                _deletedDetailIds.Add(entityId);
            }
        }
        
        // å¾åˆ—è¡¨ä¸­ç§»é™¤æ‰€æœ‰å¯åˆªé™¤çš„é …ç›®
        foreach (var item in itemsToRemove)
        {
            QuotationItems.Remove(item);
        }
        
        await NotifyDetailsChanged();
        
        var message = $"å·²æ¸…é™¤ {itemsToRemove.Count} é …æ˜ç´°";
        if (convertedItems.Any())
        {
            message += $"ï¼Œä¿ç•™ {convertedItems.Count} é …å·²è½‰éŠ·è²¨çš„æ˜ç´°";
        }
        await NotificationService.ShowSuccessAsync(message);
    }

    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        var nonEmptyItems = QuotationItems
            .Where(item => item.SelectedProduct != null)
            .ToList();
        
        if (nonEmptyItems.Count == 0)
        {
            errors.Add("è‡³å°‘éœ€è¦ä¸€å€‹å ±åƒ¹å•†å“");
        }
        else
        {
            // æª¢æŸ¥æ˜¯å¦æœ‰é¸æ“‡å•†å“
            var itemsWithoutProduct = nonEmptyItems.Where(item => item.SelectedProduct == null).ToList();
            if (itemsWithoutProduct.Any())
            {
                errors.Add("æ‰€æœ‰æ˜ç´°éƒ½å¿…é ˆé¸æ“‡å•†å“");
            }
            
            // æ•¸é‡å’Œå–®åƒ¹å¯ä»¥ç‚º 0ï¼Œä¸éœ€è¦é©—è­‰
        }
          
        if (errors.Any())
        {
            var errorMessage = string.Join("\n\n", errors);
            await NotificationService.ShowErrorAsync(errorMessage);
            return false;
        }
        
        return true;
    }

    /// <summary>
    /// å–å¾—æ‰€æœ‰å ±åƒ¹å–®çµ„åˆæ˜ç´°è³‡æ–™ï¼ˆä¾›çˆ¶çµ„ä»¶å„²å­˜ä½¿ç”¨ï¼‰
    /// å°æ–¼æ–°å¢çš„æ˜ç´°ï¼ˆID=0ï¼‰ï¼Œä½¿ç”¨è‡¨æ™‚ç´¢å¼•ï¼ˆ-1, -2, -3...ï¼‰ä¾†æ¨™è­˜
    /// </summary>
    public Dictionary<int, List<QuotationCompositionDetail>> GetCompositionDetails()
    {
        var result = new Dictionary<int, List<QuotationCompositionDetail>>();
        int tempIndex = -1; // ç”¨æ–¼æ–°å¢æ˜ç´°çš„è‡¨æ™‚ç´¢å¼•
        
        for (int i = 0; i < QuotationItems.Count; i++)
        {
            var item = QuotationItems[i];
            if (item.SelectedProduct == null) continue;
            
            var detailId = item.ExistingDetailEntity?.Id ?? 0;
            
            // å¦‚æœæœ‰è‡ªè¨‚çš„çµ„åˆæ˜ç´°
            if (item.CustomCompositionDetails?.Any() == true)
            {
                if (detailId > 0)
                {
                    // å·²å­˜åœ¨çš„æ˜ç´°ï¼Œä½¿ç”¨å¯¦éš› ID
                    result[detailId] = item.CustomCompositionDetails;
                }
                else
                {
                    // æ–°å¢çš„æ˜ç´°ï¼Œä½¿ç”¨è‡¨æ™‚ç´¢å¼•ï¼ˆå°æ‡‰æ˜ç´°åœ¨é™£åˆ—ä¸­çš„é †åºï¼‰
                    foreach (var detail in item.CustomCompositionDetails)
                    {
                        detail.QuotationDetailId = tempIndex; // æš«å­˜è‡¨æ™‚ç´¢å¼•
                    }
                    result[tempIndex] = item.CustomCompositionDetails;
                    tempIndex--; // ä¸‹ä¸€å€‹æ–°å¢æ˜ç´°ä½¿ç”¨ -2, -3...
                }
            }
            // æˆ–å¾å¿«å–ä¸­å–å¾—
            else if (item.SelectedProduct != null && compositionDetailsCache.ContainsKey(item.SelectedProduct.Id))
            {
                var cachedDetails = compositionDetailsCache[item.SelectedProduct.Id];
                if (detailId > 0)
                {
                    result[detailId] = cachedDetails;
                }
                else
                {
                    foreach (var detail in cachedDetails)
                    {
                        detail.QuotationDetailId = tempIndex;
                    }
                    result[tempIndex] = cachedDetails;
                    tempIndex--;
                }
            }
        }
        
        return result;
    }

    // ===== æ™ºèƒ½ä¸‹å–®åŠŸèƒ½ =====
    
    /// <summary>
    /// è¨ˆç®—å±¬æ€§ï¼šæ˜¯å¦å¯ä»¥ä½¿ç”¨æ™ºèƒ½ä¸‹å–®
    /// </summary>
    private bool CanUseSmartQuotation => 
        SelectedCustomerId.HasValue && 
        SelectedCustomerId.Value > 0 &&
        !HasQuotationItems &&
        _hasLastQuotationRecord;
    
    /// <summary>
    /// è¨ˆç®—å±¬æ€§ï¼šæ˜¯å¦æœ‰å ±åƒ¹æ˜ç´°é …ç›®
    /// </summary>
    private bool HasQuotationItems =>
        QuotationItems.Any(item => item.SelectedProduct != null);
    
    /// <summary>
    /// å–å¾—æ™ºèƒ½ä¸‹å–®æŒ‰éˆ•çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetSmartQuotationTooltip()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
            return "è«‹å…ˆé¸æ“‡å®¢æˆ¶";
        
        if (HasQuotationItems)
            return "ç›®å‰å·²æœ‰æ˜ç´°è³‡æ–™ï¼Œç„¡æ³•ä½¿ç”¨æ™ºèƒ½ä¸‹å–®";
        
        if (!_hasLastQuotationRecord)
            return "æ­¤å®¢æˆ¶æ²’æœ‰æ­·å²å ±åƒ¹è¨˜éŒ„";
        
        if (_hasUndeletableDetails)
            return "éƒ¨åˆ†æ˜ç´°å·²è½‰å–®ï¼Œç„¡æ³•ä½¿ç”¨æ™ºèƒ½ä¸‹å–®";
        
        return "è¼‰å…¥è©²å®¢æˆ¶ä¸Šæ¬¡å ±åƒ¹çš„å•†å“æ˜ç´°";
    }
    
    /// <summary>
    /// å–å¾—æ¸…é™¤æ˜ç´°æŒ‰éˆ•çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetClearAllDetailsTooltip()
    {
        if (IsReadOnly)
            return "å”¯è®€æ¨¡å¼ç„¡æ³•ä½¿ç”¨";
        
        if (_hasUndeletableDetails)
            return "éƒ¨åˆ†æ˜ç´°å·²è½‰å–®ï¼Œç„¡æ³•æ¸…é™¤æ˜ç´°";
        
        return "æ¸…ç©ºæ‰€æœ‰å ±åƒ¹æ˜ç´°";
    }

    /// <summary>
    /// æ™ºèƒ½ä¸‹å–®ä¸»è¦æ–¹æ³•
    /// </summary>
    private async Task SmartQuotation()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
        {
            await NotificationService.ShowWarningAsync("è«‹å…ˆé¸æ“‡å®¢æˆ¶å¾Œå†ä½¿ç”¨æ™ºèƒ½ä¸‹å–®");
            return;
        }

        try
        {
            // ç²å–è©²å®¢æˆ¶æœ€è¿‘ä¸€æ¬¡çš„å ±åƒ¹è¨˜éŒ„
            var lastQuotationDetails = await QuotationDetailService.GetLastCompleteQuotationAsync(SelectedCustomerId.Value);
            
            if (!lastQuotationDetails.Any())
            {
                await NotificationService.ShowInfoAsync("è©²å®¢æˆ¶æ²’æœ‰æ­·å²å ±åƒ¹è¨˜éŒ„ï¼Œç„¡æ³•ä½¿ç”¨æ™ºèƒ½ä¸‹å–®");
                return;
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰è³‡æ–™
            var hasExistingData = QuotationItems.Any(item => item.SelectedProduct != null);
            
            if (hasExistingData)
            {
                // æœ‰ç¾æœ‰è³‡æ–™æ™‚ä¸æ‡‰åŸ·è¡Œï¼ˆæŒ‰éˆ•æ‡‰è©²è¢«ç¦ç”¨ï¼‰
                await NotificationService.ShowWarningAsync("ç›®å‰å·²æœ‰æ˜ç´°è³‡æ–™ï¼Œç„¡æ³•ä½¿ç”¨æ™ºèƒ½ä¸‹å–®");
                return;
            }

            await LoadLastQuotationDetailsInternal(lastQuotationDetails);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æ™ºèƒ½ä¸‹å–®å¤±æ•—ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// é¡¯ç¤ºç¢ºèªå°è©±æ¡†
    /// </summary>
    private async Task<bool> ShowConfirmationAsync(string title, string message)
    {
        // æš«æ™‚ä½¿ç”¨ç°¡å–®çš„é€šçŸ¥ï¼Œç­‰å¾…ç¢ºèªå¾ŒåŸ·è¡Œ
        // åœ¨å¯¦éš›å°ˆæ¡ˆä¸­å¯èƒ½æœƒä½¿ç”¨æ›´ç²¾ç¾çš„å°è©±æ¡†çµ„ä»¶
        try 
        {
            // å…ˆé¡¯ç¤ºè­¦å‘Šè¨Šæ¯ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“å°‡è¦é€²è¡Œçš„æ“ä½œ
            await NotificationService.ShowWarningAsync($"{title}: {message}");
            return true; // æš«æ™‚ç›´æ¥è¿”å› trueï¼Œå¯¦éš›æ‡‰è©²å¯¦ä½œç¢ºèªå°è©±æ¡†
        }
        catch
        {
            return false;
        }
    }

    /// <summary>
    /// å–å¾—å¯ç”¨å•†å“åˆ—è¡¨ï¼ˆåªé¡¯ç¤ºå¯è²©å”®ä¸”ç‚ºè‡ªè£½é¡å‹çš„å•†å“ï¼‰
    /// </summary>
    private List<Product> GetAvailableProducts()
    {
        // å ±åƒ¹å–®ä¸éœ€è¦æª¢æŸ¥å®¢æˆ¶ï¼Œåªè¦å•†å“å¯è²©å”®å³å¯
        var filtered = Products
            .Where(p => p.ProductCategory != null &&
                       p.ProductCategory.IsSaleable)
            .ToList();
        
        return filtered;
    }
    
    /// <summary>
    /// å…§éƒ¨æ–¹æ³•ï¼šè¼‰å…¥ä¸Šæ¬¡å ±åƒ¹æ˜ç´°
    /// </summary>
    private async Task LoadLastQuotationDetailsInternal(List<QuotationDetail> lastQuotationDetails)
    {
        try
        {
            // é–‹å§‹è¼‰å…¥è³‡æ–™ - è¨­å®šç‚ºæœªå®Œæˆ
            _dataLoadCompleted = false;
            
            // æ¸…ç©ºç¾æœ‰é …ç›®
            QuotationItems.Clear();

            // è¼‰å…¥ä¸Šæ¬¡å ±åƒ¹çš„æ‰€æœ‰å•†å“æ˜ç´°
            foreach (var detail in lastQuotationDetails)
            {
                // ç²å–ç³»çµ±é è¨­ç¨…ç‡
                var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();
                
                var item = new QuotationItem
                {
                    SelectedProduct = detail.Product,
                    SelectedUnit = detail.Unit,
                    ProductSearchValue = detail.Product != null ? 
                        $"[{detail.Product.Code}] {detail.Product.Name}" : string.Empty,
                    Quantity = detail.Quantity,
                    UnitPrice = detail.UnitPrice,
                    DiscountPercentage = detail.DiscountPercentage,
                    TaxRate = detail.TaxRate ?? detail.Product?.TaxRate ?? defaultTaxRate,
                    ConvertedQuantity = 0,  // æ–°å ±åƒ¹å–®ï¼Œè½‰å–®æ•¸é‡ç‚º0
                    Remarks = string.Empty,
                    ExistingDetailEntity = null  // æ–°é …ç›®ï¼Œæ²’æœ‰ç¾æœ‰å¯¦é«”
                };
                
                QuotationItems.Add(item);
            }

            // é€šçŸ¥çˆ¶çµ„ä»¶æ˜ç´°å·²è®Šæ›´
            await NotifyDetailsChanged();
            
            // è³‡æ–™è¼‰å…¥å®Œæˆ - è§¸ç™¼ç©ºè¡Œæª¢æŸ¥
            _dataLoadCompleted = true;
            StateHasChanged();
            
            await NotificationService.ShowSuccessAsync(
                $"å·²æˆåŠŸè¼‰å…¥ä¸Šæ¬¡å ±åƒ¹çš„ {lastQuotationDetails.Count} é …å•†å“æ˜ç´°"
            );
        }
        catch (Exception ex)
        {
            // ç™¼ç”ŸéŒ¯èª¤ä¹Ÿè¦æ¢å¾©è¼‰å…¥å®Œæˆç‹€æ…‹
            _dataLoadCompleted = true;
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ä¸Šæ¬¡å ±åƒ¹æ˜ç´°å¤±æ•—ï¼š{ex.Message}");
        }
    }
}
