@* 報價單明細管理組件 - 使用 InteractiveTableComponent 統一UI *@

@using ERPCore2.Helpers.InteractiveTableComponentHelper
@using ERPCore2.Helpers
@using ERPCore2.Models.Enums
@inject IStringLocalizer<SharedResource> L
@inject IProductService ProductService
@inject IProductCompositionService ProductCompositionService
@inject IQuotationDetailService QuotationDetailService
@inject IQuotationCompositionDetailService QuotationCompositionDetailService
@inject INotificationService NotificationService
@inject ISystemParameterService SystemParameterService
@inject RelatedDocumentsHelper RelatedDocumentsHelper
@inject IJSRuntime JSRuntime

@inherits BaseDetailTableComponent<Quotation, QuotationDetail, QuotationTable.QuotationItem>

@if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
{
    <div class="alert alert-info text-center" role="alert">
        <i class="fas fa-info-circle me-2"></i>
        請先選擇客戶後再進行報價明細管理
    </div>
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="QuotationItem"
                                      OnDataChanged="@NotifyDetailsChangedAsync"
                                      Items="@Items"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"                                      
                                      EmptyMessage="@EmptyMessage"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="false"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"
                                      ActionsColumnWidth = "120px"
                                      EnableAutoEmptyRow="true"
                                      AllowAddNewRow="@(!_hasUndeletableDetails && !IsReadOnly)"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@CreateEmptyItem" />
        </div>

        <div class="card-footer">
            <div class="table-action-bar">
                <div class="btn-group-left">
                    <GenericButtonComponent Text="智能下單"
                                          Variant="ButtonVariant.DarkBlue"
                                          OnClick="SmartQuotation"
                                          IsDisabled="@(!CanUseSmartQuotation || IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetSmartQuotationTooltip()" />
                </div>
                <div class="btn-group-right">
                    <GenericButtonComponent Text="清除明細"
                                          Variant="ButtonVariant.Red"
                                          OnClick="ClearAllDetails"
                                          IsDisabled="@(IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetClearAllDetailsTooltip()" />
                </div>
            </div>
        </div>
    </div>
}

<!-- 相關單據查看 Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

<!-- 配方選擇 Modal -->
<CompositionSelectorModal IsVisible="@showCompositionSelectorModal"
                         IsVisibleChanged="@((bool visible) => showCompositionSelectorModal = visible)"
                         ProductName="@selectedCompositionProductName"
                         Compositions="@availableCompositions"
                         CurrentCustomerId="@SelectedCustomerId"
                         OnSelected="@HandleCompositionSelected" />

<!-- BOM 組合編輯 Modal -->
<QuotationCompositionEditModal TCompositionDetail="QuotationCompositionDetail"
                              IsVisible="@showCompositionModal"
                              IsVisibleChanged="@((bool visible) => { showCompositionModal = visible; })"
                              DetailId="@GetSelectedQuotationDetailId()"
                              ProductName="@selectedCompositionProductName"
                              ProductId="@selectedCompositionProductId"
                              SelectedCompositionId="@selectedCompositionId"
                              IsCustomMode="@isCustomCompositionMode"
                              IsReselecting="@isReselectingComposition"
                              IsReadOnly="@GetCompositionModalReadOnlyState()"
                              GetCompositionsByDetailId="@QuotationCompositionDetailService.GetByQuotationDetailIdAsync"
                              CopyFromComposition="@QuotationCompositionDetailService.CopyFromCompositionAsync"
                              OnSave="@HandleCompositionSave"
                              OnCancel="@HandleCompositionCancel"
                              OnRequestCachedData="@GetCachedCompositionData"
                              OnReselect="@HandleCompositionReselect" />

@code {
    // ===== QuotationItem 內部類別定義（必須在最前面）=====
    public class QuotationItem
    {
        public ERPCore2.Data.Entities.Product? SelectedProduct { get; set; }
        public ERPCore2.Data.Entities.Unit? SelectedUnit { get; set; }
        public decimal Quantity { get; set; } = 0;
        public decimal UnitPrice { get; set; } = 0;
        public decimal DiscountPercentage { get; set; } = 0;
        public decimal? TaxRate { get; set; } = null;
        public decimal ConvertedQuantity { get; set; } = 0;
        public string Specification { get; set; } = string.Empty;
        public string Remarks { get; set; } = string.Empty;
        public QuotationDetail? ExistingDetailEntity { get; set; }
        
        /// <summary>
        /// 自訂的 BOM 組合明細（用於暫存編輯結果）
        /// </summary>
        public List<QuotationCompositionDetail>? CustomCompositionDetails { get; set; }
        
        /// <summary>
        /// 選擇的配方 ID（null 表示自定義模式）
        /// </summary>
        public int? SelectedCompositionId { get; set; }
        
        /// <summary>
        /// 是否為自定義組合模式
        /// </summary>
        public bool IsCustomComposition { get; set; }
        
        /// <summary>
        /// 計算屬性：是否已有 BOM 組合資料
        /// </summary>
        public bool HasCompositionData => CustomCompositionDetails?.Any() == true;
        
        // SearchableSelect 支援屬性
        public string ProductSearchValue { get; set; } = string.Empty;
        public List<ERPCore2.Data.Entities.Product> FilteredProducts { get; set; } = new();
        public bool ShowProductDropdown { get; set; } = false;
        public int ProductSelectedIndex { get; set; } = -1;
        
        /// <summary>
        /// 計算屬性：小計金額（數量 × 單價 × 折扣）
        /// </summary>
        public decimal SubtotalAmount => Quantity * UnitPrice * (1 - DiscountPercentage / 100);
        
        /// <summary>
        /// 計算屬性：未轉單數量
        /// </summary>
        public decimal RemainingQuantity => Quantity - ConvertedQuantity;
        
        /// <summary>
        /// 計算屬性：是否已完全轉單
        /// </summary>
        public bool IsFullyConverted => ConvertedQuantity >= Quantity;
        
        /// <summary>
        /// 計算屬性：顯示名稱（用於唯讀模式）
        /// </summary>
        public string DisplayName
        {
            get
            {
                if (SelectedProduct == null) return string.Empty;
                
                var parts = new List<string>();
                
                if (!string.IsNullOrEmpty(SelectedProduct.Code))
                    parts.Add($"[{SelectedProduct.Code}]");
                
                if (!string.IsNullOrEmpty(SelectedProduct.Name))
                    parts.Add(SelectedProduct.Name);
                
                return string.Join(" ", parts);
            }
        }
    }
    
    // ===== 私有欄位 =====
    private bool _hasLastQuotationRecord = false;  // 是否有歷史報價記錄（快取）

    // ===== 基本參數 =====
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public List<Unit> Units { get; set; } = new List<Unit>();
    [Parameter] public EventCallback<List<QuotationItem>> OnQuotationItemsChanged { get; set; }

    // ===== 客戶過濾參數 =====
    [Parameter] public int? SelectedCustomerId { get; set; }

    // ===== 追加事件 =====
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    [Parameter] public EventCallback<QuotationItem> OnItemRemoved { get; set; }

    // ===== 顯示設定 =====
    [Parameter] public string Title { get; set; } = "報價明細";
    [Parameter] public string EmptyMessage { get; set; } = "尚未新增報價商品";

    // ===== 相關單據開啟事件 =====
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }

    // ===== 稅別參數（新增）=====
    [Parameter] public TaxCalculationMethod TaxCalculationMethod { get; set; } = TaxCalculationMethod.TaxExclusive;

    // ===== 輔助計算屬性 =====
    private bool IsTaxCalculationMethodNoTax => TaxCalculationMethod == TaxCalculationMethod.NoTax;

    private List<int> _deletedDetailIds { get; set; } = new List<int>();
    
    // ===== 相關單據查看 =====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;
    
    // ===== BOM 組合編輯相關 =====
    private bool showCompositionModal = false;
    private bool showCompositionSelectorModal = false;
    private int? selectedQuotationItemIndex = null;
    private string selectedCompositionProductName = string.Empty;
    private int? selectedCompositionProductId = null;
    private int? selectedCompositionId = null;
    private bool isCustomCompositionMode = false;
    private bool isReselectingComposition = false;  // 標記是否為重新選擇配方
    private List<ProductComposition> availableCompositions = new();
    private Dictionary<int, List<QuotationCompositionDetail>> compositionDetailsCache = new();
    private HashSet<int> productsWithComposition = new();  // 快取有 BOM 的商品 ID

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadProductCompositionsAsync();
    }

    protected override Task OnCounterpartyChangedAsync()
    {
        // SelectedSupplierId (= SelectedCustomerId) is the same param for QuotationTable
        // No additional action needed since Products are passed as parameters
        return Task.CompletedTask;
    }

    protected override async Task OnAfterLoadAsync()
    {
        await CheckLastQuotationRecordAsync();
    }

    protected override async Task LoadItemsFromDetailsAsync()
    {
        foreach (var detail in ExistingDetails.OfType<QuotationDetail>())
        {
            var item = new QuotationItem
            {
                SelectedProduct = detail.Product,
                SelectedUnit = detail.Unit,
                ProductSearchValue = detail.Product != null ? $"[{detail.Product.Code}] {detail.Product.Name}" : string.Empty,
                Quantity = detail.Quantity,
                UnitPrice = detail.UnitPrice,
                DiscountPercentage = detail.DiscountPercentage,
                TaxRate = detail.TaxRate ?? detail.Product?.TaxRate ?? await SystemParameterService.GetTaxRateAsync(),
                ConvertedQuantity = detail.ConvertedQuantity,
                Specification = detail.Specification ?? detail.Product?.Specification ?? string.Empty,
                Remarks = detail.Remarks ?? string.Empty,
                ExistingDetailEntity = detail
            };

            // 載入該明細的組合明細資料（如果有的話）
            if (detail.Id > 0)
            {
                var compositionDetails = await QuotationCompositionDetailService
                    .GetByQuotationDetailIdAsync(detail.Id);

                if (compositionDetails.Any())
                {
                    item.CustomCompositionDetails = compositionDetails;
                    item.IsCustomComposition = true;
                }
            }

            Items.Add(item);
        }
    }

    protected override bool ComputeHasUndeletableDetails()
        => Items.Any(p => !DetailLockHelper.CanDeleteItem(p, out _, checkConversion: true));

    protected override List<QuotationDetail> ConvertItemsToDetails()
    {
        var entities = new List<QuotationDetail>();
        foreach (var item in Items.Where(x => x.SelectedProduct != null))
        {
            QuotationDetail entity = item.ExistingDetailEntity ?? new QuotationDetail();
            if (item.ExistingDetailEntity == null && MainEntity != null)
                entity.QuotationId = MainEntity.Id;

            entity.ProductId = item.SelectedProduct!.Id;
            entity.Quantity = item.Quantity;
            entity.UnitPrice = item.UnitPrice;
            entity.DiscountPercentage = item.DiscountPercentage;
            entity.TaxRate = item.TaxRate;
            entity.Specification = item.Specification;
            entity.Remarks = item.Remarks;
            if (item.SelectedUnit != null)
                entity.UnitId = item.SelectedUnit.Id;
            entities.Add(entity);
        }
        return entities;
    }
    
    /// <summary>
    /// 檢查是否有歷史報價記錄
    /// </summary>
    private async Task CheckLastQuotationRecordAsync()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
        {
            _hasLastQuotationRecord = false;
            return;
        }
        
        try
        {
            var lastQuotationDetails = await QuotationDetailService.GetLastCompleteQuotationAsync(SelectedCustomerId.Value);
            _hasLastQuotationRecord = lastQuotationDetails?.Any() == true;
        }
        catch
        {
            _hasLastQuotationRecord = false;
        }
    }
    
    /// <summary>
    /// 載入有 BOM 組成的商品列表（用於快取檢查）
    /// </summary>
    private async Task LoadProductCompositionsAsync()
    {
        try
        {
            // 從 Products 參數中取得所有商品 ID
            var productIds = Products.Where(p => p.Id > 0).Select(p => p.Id).ToList();
            
            // 檢查每個商品是否有 ProductComposition
            foreach (var productId in productIds)
            {
                var compositions = await ProductCompositionService.GetCompositionsByProductIdAsync(productId);
                if (compositions?.Any() == true)
                {
                    productsWithComposition.Add(productId);
                }
            }
        }
        catch (Exception ex)
        {
            // 載入失敗不影響主要功能，只是 BOM 按鈕可能不顯示
            Console.WriteLine($"載入商品組成資料失敗：{ex.Message}");
            productsWithComposition.Clear();
        }
    }

    // ===== 建立空項目方法 =====
    
    private QuotationItem CreateEmptyItem()
    {
        return new QuotationItem();
    }

    // ===== InteractiveTableComponent 方法 =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // 商品選擇欄位 - 觸發欄位（第一個欄位預設為觸發欄位）
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = L["Column.ProductCodeName"],
            PropertyName = "ProductSearchValue",
            EmptyCheckPropertyName = "SelectedProduct",  // 檢查 SelectedProduct 物件
            TriggerEmptyRowOnFilled = true,  // 選擇商品後自動新增空行
            ColumnType = InteractiveColumnType.SearchableSelect,
            Width = "300px",
            Tooltip = "搜尋並選擇商品（輸入編號或名稱）。已轉銷貨的商品將無法變更",
            Placeholder = "請輸入商品編號或名稱",
            SearchValuePropertyName = nameof(QuotationItem.ProductSearchValue),
            FilteredItemsPropertyName = nameof(QuotationItem.FilteredProducts),
            ShowDropdownPropertyName = nameof(QuotationItem.ShowProductDropdown),
            SelectedIndexPropertyName = nameof(QuotationItem.ProductSelectedIndex),
            ItemDisplayFormatter = (item) =>
            {
                var product = (Product)item;
                return $"[{product.Code}] {product.Name}";
            },
            IsDisabledFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                return IsReadOnly || !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true);
            },
            TooltipFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                return !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) 
                    ? "此商品已轉銷貨，無法修改商品選擇" : null;
            },
            OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, (tuple) =>
            {
                var (item, searchValue) = tuple;
                OnProductSearchChanged((QuotationItem)item, searchValue);
            }),
            OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
            {
                var (item, selectedItem) = tuple;
                await OnProductSelected((QuotationItem)item, (Product?)selectedItem);
            }),
            OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnProductFocus((QuotationItem)item);
            }),
            OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnProductBlur((QuotationItem)item);
            }),
            EnableKeyboardNavigation = true,
            GetDropdownItems = (item) => ((QuotationItem)item).FilteredProducts,
            GetSelectedIndex = (item) => ((QuotationItem)item).ProductSelectedIndex,
            SetSelectedIndex = (item, index) => ((QuotationItem)item).ProductSelectedIndex = index,
            GetShowDropdown = (item) => ((QuotationItem)item).ShowProductDropdown,
            SetShowDropdown = (item, show) => ((QuotationItem)item).ShowProductDropdown = show,
            MaxDisplayItems = 20
        });

        
        // 製程單位欄位 - 唯讀顯示
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = L["Entity.Unit"],
            Tooltip = "商品的製程單位（由商品設定決定）",
            PropertyName = "ProductionUnitName",
            ColumnType = InteractiveColumnType.Display,
            Width = "80px",
            DisplayFormatter = (item) => GetProductionUnitName((QuotationItem)item!),
            ExcludeFromEmptyCheck = true  // 唯讀欄位不參與空行檢查
        });

        // 數量欄位
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = L["Column.Quantity"],
            PropertyName = "Quantity",
            ColumnType = InteractiveColumnType.Number,
            Width = "80px",
            Tooltip = "輸入數量",
            CellCssClass = "text-end",
            MinValue = 0,
            IsDisabledFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                return !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow;
            },
            TooltipFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                if (!DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow)
                    return "此商品已轉銷貨，無法修改數量";
                return "輸入數量";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var quotationItem = (QuotationItem)args.Item1;
                await OnQuantityInput(quotationItem, args.Item2);
            })
        });

        // 單價欄位
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = L["Column.UnitPrice"],
            PropertyName = "UnitPrice",
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            Tooltip = "輸入報價單價",
            CellCssClass = "text-end",
            MinValue = 0,
            IsDisabledFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                return !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow;
            },
            TooltipFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                if (!DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow)
                    return "此商品已轉銷貨，無法修改單價";
                return "輸入報價單價";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var quotationItem = (QuotationItem)args.Item1;
                await OnUnitPriceInput(quotationItem, args.Item2);
            })
        });

        // 折扣欄位
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = L["Column.DiscountPercent"],
            PropertyName = "DiscountPercentage",
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            Tooltip = "輸入折扣百分比",
            CellCssClass = "text-end",
            MinValue = 0,
            MaxValue = 100,
            IsDisabledFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                return !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow;
            },
            TooltipFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                var isEmptyRow = quotationItem.SelectedProduct == null;
                if (!DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true) && !isEmptyRow)
                    return "此商品已轉銷貨，無法修改折扣";
                return "輸入折扣百分比";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var quotationItem = (QuotationItem)args.Item1;
                await OnDiscountPercentageInput(quotationItem, args.Item2);
            })
        });

        // 稅率欄位
        columns.Add(new InteractiveColumnDefinition
        {
            Title = L["Field.TaxRate"],
            PropertyName = "TaxRate",
            ColumnType = InteractiveColumnType.Number,
            Width = "80px",
            Tooltip = "輸入稅率百分比（例如：5 代表 5%）",
            CellCssClass = "text-end",
            MinValue = 0,
            MaxValue = 100,
            IsDisabledFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                return IsReadOnly || IsTaxCalculationMethodNoTax || 
                       !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true);
            },
            TooltipFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                if (IsTaxCalculationMethodNoTax) return "主檔已選擇免稅，此欄位已停用";
                if (!DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true))
                    return "此商品已轉銷貨，無法修改稅率";
                return "輸入稅率百分比（例如：5 代表 5%）";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var quotationItem = (QuotationItem)args.Item1;
                await OnTaxRateInput(quotationItem, args.Item2);
            })
        });

        // 小計欄位
        columns.Add(new InteractiveColumnDefinition
        {
            Title = L["Column.Subtotal"],
            Tooltip = GetSubtotalTooltip(),
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item =>
            {
                var quotationItem = (QuotationItem)item;
                var subtotal = CalculateItemSubtotal(quotationItem);
                var displayValue = NumberFormatHelper.FormatSmartZeroAsEmpty(subtotal);
                return @<div class="text-end fw-bold text-success">@displayValue</div>;
            }
        });

        // 規格說明欄位
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = L["Column.Specification"],
            PropertyName = "Specification",
            ColumnType = InteractiveColumnType.Input,
            Width = "200px",
            Placeholder = "規格說明",
            Tooltip = "商品的規格說明，可自行修改",
            IsDisabledFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                return IsReadOnly || !DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true);
            },
            TooltipFunc = item =>
            {
                var quotationItem = (QuotationItem)item;
                if (!DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true))
                    return "此商品已轉銷貨，無法修改規格說明";
                return "商品的規格說明，可自行修改";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var quotationItem = (QuotationItem)args.Item1;
                await OnSpecificationInput(quotationItem, args.Item2);
            })
        });


        // 備註欄位 - 即使已轉銷貨也可編輯（用於記錄執行狀況）
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = L["Label.Remarks"],
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "150px",
            HideOnMobile = true,
            Tooltip = "選填。可記錄報價相關的備註資訊",
            CustomTemplate = item => 
            {
                var quotationItem = (QuotationItem)item;
                
                // 如果是唯讀狀態，直接顯示 span
                if (IsReadOnly)
                {
                    var displayText = string.IsNullOrEmpty(quotationItem.Remarks) ? "無備註" : quotationItem.Remarks;
                    return @<div class="d-flex align-items-center" style="min-height: 31px;">
                        <span class="text-muted">@displayText</span>
                    </div>;
                }
                
                // 可編輯狀態，顯示輸入框
                return @<input type="text" class="form-control " 
                               value="@quotationItem.Remarks"
                               @oninput="(e) => OnRemarksInput(quotationItem, e.Value?.ToString())"
                               placeholder="" />;
            }
        });

        return columns;
    }

    private RenderFragment<QuotationItem> GetCustomActionsTemplate => item => __builder =>
    {
        var quotationItem = (QuotationItem)item;
        var isEmptyRow = quotationItem.SelectedProduct == null;
        var canDelete = DetailLockHelper.CanDeleteItem(quotationItem, out _, checkConversion: true);
        var hasComposition = quotationItem.SelectedProduct != null && HasProductComposition(quotationItem.SelectedProduct.Id);
        var isLastEmptyRow = tableComponent?.IsLastEmptyRow(item) ?? false;
        
        <div class="d-flex gap-1">
            @* BOM 編輯按鈕（如果商品有 BOM 組成） *@
            @if (hasComposition && !isEmptyRow)
            {
                <GenericButtonComponent Variant="ButtonVariant.Blue"
                                       IconClass="bi bi-diagram-3 text-white"
                                       Size="ButtonSize.Large"
                                       Title="編輯 BOM 組成"
                                       OnClick="() => ShowCompositionEditor(quotationItem)"
                                       StopPropagation="true"
                                       CssClass="btn-square" />
            }
            
            @* 原有的操作按鈕 *@
            @if (IsReadOnly)
            {
                // 唯讀模式：所有項目都顯示檢視按鈕
                <GenericButtonComponent Variant="ButtonVariant.Blue"
                                       IconClass="bi bi-eye text-white"
                                       Size="ButtonSize.Large"
                                       Title="查看相關單據"
                                       OnClick="async () => await ShowRelatedDocuments(quotationItem)"
                                       StopPropagation="true"
                                       CssClass="btn-square" />
            }
            else if (isLastEmptyRow)
            {
                // 最後一個空行：顯示禁用的刪除按鈕
                <GenericButtonComponent Variant="ButtonVariant.Red"
                                       IconClass="bi bi-trash text-white"
                                       Size="ButtonSize.Large"
                                       IsDisabled="true"
                                       Title="至少需要保留一個空行"
                                       StopPropagation="true"
                                       CssClass="btn-square" />
            }
            else if (canDelete || isEmptyRow)
            {
                // 可編輯模式且未轉銷貨（或是空行）：顯示刪除按鈕
                <GenericButtonComponent Variant="ButtonVariant.Red"
                                       IconClass="bi bi-trash text-white"
                                       Size="ButtonSize.Large"
                                       Title="刪除"
                                       OnClick="async () => await HandleItemDelete(quotationItem)"
                                       StopPropagation="true"
                                       CssClass="btn-square" />
            }
            else
            {
                // 已轉銷貨且非空行：顯示查看相關單據按鈕
                <GenericButtonComponent Variant="ButtonVariant.Blue"
                                       IconClass="bi bi-eye text-white"
                                       Size="ButtonSize.Large"
                                       Title="查看相關單據"
                                       OnClick="async () => await ShowRelatedDocuments(quotationItem)"
                                       StopPropagation="true"
                                       CssClass="btn-square" />
            }
        </div>
    };

    private async Task HandleItemDelete(QuotationItem item)
    {
        var index = Items.IndexOf(item);
        await RemoveItemAsync(index);
    }

    /// <summary>
    /// 顯示相關單據（銷貨訂單）
    /// </summary>
    private async Task ShowRelatedDocuments(QuotationItem item)
    {
        if (item.ExistingDetailEntity is not QuotationDetail detail || detail.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("此明細尚未儲存，無法查看相關單據", "提示");
            return;
        }

        selectedProductName = item.SelectedProduct?.Name ?? "未知商品";
        
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsByQuotationDetailAsync(detail.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入相關單據時發生錯誤：{ex.Message}", "錯誤");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// 處理點擊相關單據的事件
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // 觸發事件，讓父組件（EditModal）處理開啟相關單據
        // 注意：不關閉 RelatedDocumentsModal，讓使用者可以繼續查看列表
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            // 如果父組件沒有處理此事件，則顯示提示訊息
            await NotificationService.ShowInfoAsync(
                $"請在父組件中實作 OnOpenRelatedDocument 事件處理器以開啟 {document.TypeDisplayName}",
                "提示"
            );
        }
    }

    // ===== BOM 組合編輯相關方法 =====
    
    /// <summary>
    /// 檢查商品是否有 BOM 組成
    /// </summary>
    private bool HasProductComposition(int productId)
    {
        // 從快取中檢查該商品是否有 ProductComposition
        return productsWithComposition.Contains(productId);
    }
    
    /// <summary>
    /// 顯示 BOM 組合編輯器 - 智能判斷是否需要選擇配方
    /// </summary>
    private async Task ShowCompositionEditor(QuotationItem item)
    {
        if (item.SelectedProduct == null) return;
        
        selectedQuotationItemIndex = Items.IndexOf(item);
        selectedCompositionProductName = item.SelectedProduct.Name;
        selectedCompositionProductId = item.SelectedProduct.Id;
        
        // 檢查是否已有組合資料
        if (item.HasCompositionData)
        {
            // 已有資料，直接開啟編輯器
            selectedCompositionId = item.SelectedCompositionId;
            isCustomCompositionMode = item.IsCustomComposition;
            showCompositionModal = true;
        }
        else
        {
            // 尚未選擇配方，顯示選擇器
            availableCompositions = await ProductCompositionService
                .GetCompositionsByProductIdAsync(item.SelectedProduct.Id);
            showCompositionSelectorModal = true;
        }
        
        StateHasChanged();
    }
    
    /// <summary>
    /// 處理配方選擇
    /// </summary>
    private void HandleCompositionSelected((int? compositionId, bool isCustomMode) selection)
    {
        showCompositionSelectorModal = false;
        
        selectedCompositionId = selection.compositionId;
        isCustomCompositionMode = selection.isCustomMode;
        
        // 記錄選擇資訊到 QuotationItem
        if (selectedQuotationItemIndex.HasValue)
        {
            var item = Items.ElementAtOrDefault(selectedQuotationItemIndex.Value);
            if (item != null)
            {
                item.SelectedCompositionId = selection.compositionId;
                item.IsCustomComposition = selection.isCustomMode;
                
                // 如果是重新選擇，清除舊的快取資料
                if (isReselectingComposition)
                {
                    item.CustomCompositionDetails = null;
                    if (item.SelectedProduct != null && compositionDetailsCache.ContainsKey(item.SelectedProduct.Id))
                    {
                        compositionDetailsCache.Remove(item.SelectedProduct.Id);
                    }
                }
            }
        }
        
        // 開啟 BOM 編輯器
        showCompositionModal = true;
        StateHasChanged();
    }
    
    /// <summary>
    /// 取得 BOM 編輯 Modal 的唯讀狀態
    /// 如果全域唯讀或當前選中的明細已轉單，則 Modal 應該為唯讀
    /// </summary>
    private bool GetCompositionModalReadOnlyState()
    {
        if (IsReadOnly) return true;
        
        if (!selectedQuotationItemIndex.HasValue || selectedQuotationItemIndex.Value < 0)
            return false;
            
        var item = Items.ElementAtOrDefault(selectedQuotationItemIndex.Value);
        if (item == null) return false;
        
        // 檢查是否已轉單（ConvertedQuantity > 0）
        return item.ConvertedQuantity > 0;
    }
    
    /// <summary>
    /// 取得選中的報價單明細 ID（用於 Modal）
    /// </summary>
    private int? GetSelectedQuotationDetailId()
    {
        if (!selectedQuotationItemIndex.HasValue || selectedQuotationItemIndex.Value < 0)
            return null;
            
        var item = Items.ElementAtOrDefault(selectedQuotationItemIndex.Value);
        if (item?.ExistingDetailEntity is QuotationDetail detail && detail.Id > 0)
            return detail.Id;
            
        // 如果是新的項目，暫時返回一個臨時 ID（負數表示尚未儲存）
        return -(selectedQuotationItemIndex.Value + 1);
    }
    
    /// <summary>
    /// 處理 BOM 組合儲存
    /// </summary>
    private async Task HandleCompositionSave(List<QuotationCompositionDetail> compositionDetails)
    {
        if (!selectedQuotationItemIndex.HasValue || !selectedCompositionProductId.HasValue)
            return;
            
        try
        {
            // 暫存到快取（實際儲存會在報價單儲存時一併處理）
            compositionDetailsCache[selectedCompositionProductId.Value] = compositionDetails;
            
            // 同時更新 QuotationItem 的 CustomCompositionDetails（確保資料同步）
            var item = Items.ElementAtOrDefault(selectedQuotationItemIndex.Value);
            if (item != null)
            {
                item.CustomCompositionDetails = compositionDetails;
                
                // 確保選擇資訊已記錄（如果還沒記錄的話）
                if (!item.SelectedCompositionId.HasValue && !item.IsCustomComposition)
                {
                    item.SelectedCompositionId = selectedCompositionId;
                    item.IsCustomComposition = isCustomCompositionMode;
                }
            }
            
            await NotificationService.ShowSuccessAsync("BOM 組成已更新，請記得儲存報價單以保存變更");
            showCompositionModal = false;
            isReselectingComposition = false;  // 儲存完成後重置
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"儲存 BOM 組成時發生錯誤：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 處理 BOM 組合取消
    /// </summary>
    private void HandleCompositionCancel()
    {
        showCompositionModal = false;
        isReselectingComposition = false;
    }
    
    /// <summary>
    /// 取得快取的組合明細資料（供 Modal 使用）
    /// </summary>
    private List<QuotationCompositionDetail>? GetCachedCompositionData()
    {
        if (!selectedQuotationItemIndex.HasValue)
            return null;
            
        var item = Items.ElementAtOrDefault(selectedQuotationItemIndex.Value);
        if (item == null)
            return null;
        
        // 優先返回 CustomCompositionDetails
        if (item.CustomCompositionDetails?.Any() == true)
            return item.CustomCompositionDetails;
            
        // 其次從快取中取得
        if (item.SelectedProduct != null && compositionDetailsCache.ContainsKey(item.SelectedProduct.Id))
            return compositionDetailsCache[item.SelectedProduct.Id];
        
        return null;
    }
    
    /// <summary>
    /// 處理重新選擇配方
    /// </summary>
    private async Task HandleCompositionReselect()
    {
        // 先標記為重新選擇模式（在關閉 Modal 之前）
        isReselectingComposition = true;
        
        // 關閉當前的 BOM 編輯 Modal
        showCompositionModal = false;
        
        // 清除當前選擇的配方資訊
        if (selectedQuotationItemIndex.HasValue)
        {
            var item = Items.ElementAtOrDefault(selectedQuotationItemIndex.Value);
            if (item?.SelectedProduct != null)
            {
                // 重新載入配方清單
                availableCompositions = await ProductCompositionService
                    .GetCompositionsByProductIdAsync(item.SelectedProduct.Id);
                
                // 顯示配方選擇器
                showCompositionSelectorModal = true;
                StateHasChanged();
            }
        }
    }

    // ===== 事件處理方法 =====

    // ===== 商品 SearchableSelect 事件處理 =====
    
    /// <summary>
    /// 商品輸入框獲得焦點
    /// </summary>
    private void OnProductFocus(QuotationItem item)
    {
        var availableProducts = GetAvailableProducts();
        
        item.FilteredProducts = availableProducts.Take(20).ToList();
        item.ShowProductDropdown = true;
        item.ProductSelectedIndex = -1;
        StateHasChanged();
    }
    
    /// <summary>
    /// 商品輸入框失去焦點
    /// </summary>
    private void OnProductBlur(QuotationItem item)
    {
        Task.Delay(200).ContinueWith(_ =>
        {
            item.ShowProductDropdown = false;
            InvokeAsync(StateHasChanged);
        });
    }
    
    /// <summary>
    /// 商品搜尋輸入變更事件（SearchableSelect）
    /// </summary>
    private void OnProductSearchChanged(QuotationItem item, string? searchValue)
    {
        item.ProductSearchValue = searchValue ?? string.Empty;
        
        var availableProducts = GetAvailableProducts();
        
        if (string.IsNullOrWhiteSpace(searchValue))
        {
            // 空白搜尋：顯示前20筆
            item.FilteredProducts = availableProducts.Take(20).ToList();
        }
        else
        {
            // 篩選符合的商品（編號或名稱包含搜尋字串）
            item.FilteredProducts = availableProducts
                .Where(p => (p.Code?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                           (p.Name?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false))
                .Take(20)
                .ToList();
        }
        
        item.ShowProductDropdown = true;
        item.ProductSelectedIndex = -1;
        StateHasChanged();
    }
    
    /// <summary>
    /// 商品選擇事件（SearchableSelect）
    /// </summary>
    private async Task OnProductSelected(QuotationItem item, Product? selectedProduct)
    {
        if (selectedProduct != null)
        {
            item.SelectedProduct = selectedProduct;
            item.ProductSearchValue = $"[{selectedProduct.Code}] {selectedProduct.Name}";
            
            // 自動設定預設單位（如果商品有預設單位）
            if (selectedProduct.Unit != null)
            {
                item.SelectedUnit = selectedProduct.Unit;
            }
            
            // 自動帶入規格說明
            item.Specification = selectedProduct.Specification ?? string.Empty;
            
            // 自動帶入稅率（商品稅率 > 系統預設值）
            if (selectedProduct.TaxRate.HasValue)
            {
                item.TaxRate = selectedProduct.TaxRate.Value;
            }
            else
            {
                var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();
                item.TaxRate = defaultTaxRate;
            }
        }
        else
        {
            item.SelectedProduct = null;
            item.ProductSearchValue = string.Empty;
            item.SelectedUnit = null;
            item.Specification = string.Empty;
            item.TaxRate = null;
        }
        
        item.ShowProductDropdown = false;
        item.ProductSelectedIndex = -1;
        
        await NotifyDetailsChangedAsync();
    }

    private async Task OnQuantityInput(QuotationItem item, string? value)
    {
        // 檢查全域唯讀或個別明細已轉銷貨
        var hasConverted = item.ConvertedQuantity > 0;
        var isEmptyRow = item.SelectedProduct == null;
        if (IsReadOnly || (hasConverted && !isEmptyRow)) return;
        
        item.Quantity = InputEventHelper.HandleQuantityInput(value, 0);
        
        await NotifyDetailsChangedAsync();
        StateHasChanged();
    }

    private async Task OnUnitPriceInput(QuotationItem item, string? value)
    {
        // 檢查全域唯讀或個別明細已轉銷貨
        var hasConverted = item.ConvertedQuantity > 0;
        var isEmptyRow = item.SelectedProduct == null;
        if (IsReadOnly || (hasConverted && !isEmptyRow)) return;
        
        if (string.IsNullOrEmpty(value))
        {
            item.UnitPrice = 0;
        }
        else if (decimal.TryParse(value, out var unitPrice))
        {
            item.UnitPrice = unitPrice;
        }
        
        await NotifyDetailsChangedAsync();
        StateHasChanged();
    }

    private async Task OnDiscountPercentageInput(QuotationItem item, string? value)
    {
        // 檢查全域唯讀或個別明細已轉銷貨
        var hasConverted = item.ConvertedQuantity > 0;
        var isEmptyRow = item.SelectedProduct == null;
        if (IsReadOnly || (hasConverted && !isEmptyRow)) return;
        
        if (string.IsNullOrEmpty(value))
        {
            item.DiscountPercentage = 0;
        }
        else if (decimal.TryParse(value, out var discount))
        {
            // 限制折扣百分比在 0-100 之間
            // 如果輸入值超過100，直接設為100並強制更新UI
            var limitedDiscount = Math.Max(0, Math.Min(100, discount));
            item.DiscountPercentage = limitedDiscount;
            
            // 如果值被限制了，強制刷新UI以顯示修正後的值
            if (limitedDiscount != discount)
            {
                StateHasChanged();
            }
        }
        
        await NotifyDetailsChangedAsync();
        StateHasChanged();
    }

    private async Task OnRemarksInput(QuotationItem item, string? value)
    {
        item.Remarks = value ?? string.Empty;
        
        await NotifyDetailsChangedAsync();
        StateHasChanged();
    }

    /// <summary>
    /// 處理規格說明輸入
    /// </summary>
    private async Task OnSpecificationInput(QuotationItem item, string? value)
    {
        // 檢查全域唯讀或個別明細已轉銷貨
        var hasConverted = item.ConvertedQuantity > 0;
        var isEmptyRow = item.SelectedProduct == null;
        if (IsReadOnly || (hasConverted && !isEmptyRow)) return;
        
        item.Specification = value ?? string.Empty;
        
        await NotifyDetailsChangedAsync();
        StateHasChanged();
    }

    /// <summary>
    /// 處理稅率輸入
    /// </summary>
    private async Task OnTaxRateInput(QuotationItem item, string? valueString)
    {
        if (string.IsNullOrWhiteSpace(valueString))
        {
            item.TaxRate = null;
        }
        else
        {
            var taxRate = InputEventHelper.HandlePercentageInput(valueString, 0, 100, 0);
            item.TaxRate = taxRate;
        }
        
        await NotifyDetailsChangedAsync();
        StateHasChanged();
    }

    /// <summary>
    /// 計算明細項目的小計（根據稅別，四捨五入到整數）
    /// </summary>
    private decimal CalculateItemSubtotal(QuotationItem item)
    {
        if (item.SelectedProduct == null || item.Quantity <= 0 || item.UnitPrice <= 0)
        {
            return 0;
        }

        var subtotal = CalculationHelper.CalculateSubtotal(
            item.Quantity,
            item.UnitPrice,
            item.DiscountPercentage,
            item.TaxRate ?? 0,
            TaxCalculationMethod
        );
        
        // 四捨五入到整數
        return CalculationHelper.Round(subtotal, 0);
    }

    /// <summary>
    /// 取得小計欄位的提示文字
    /// </summary>
    private string GetSubtotalTooltip()
    {
        return TaxCalculationMethod switch
        {
            TaxCalculationMethod.TaxExclusive => "小計 = 數量 × 單價 × (1 - 折扣%) × (1 + 稅率%)，四捨五入到整數",
            TaxCalculationMethod.TaxInclusive => "小計 = 數量 × 單價 × (1 - 折扣%)，四捨五入到整數（單價已含稅）",
            TaxCalculationMethod.NoTax => "小計 = 數量 × 單價 × (1 - 折扣%)，四捨五入到整數（免稅）",
            _ => "小計金額（四捨五入到整數）"
        };
    }
    
    /// <summary>
    /// 取得商品的製程單位名稱
    /// </summary>
    private string GetProductionUnitName(QuotationItem item)
    {
        // 如果沒有選擇商品，回傳空字串
        if (item.SelectedProduct == null)
        {
            return string.Empty;
        }
        
        // 優先使用製程單位，若無則使用商品單位
        var productionUnitId = item.SelectedProduct.ProductionUnitId ?? item.SelectedProduct.UnitId;
        
        if (productionUnitId <= 0)
        {
            return string.Empty;
        }
        
        // 從可用單位清單中查找單位名稱
        var unit = Units.FirstOrDefault(u => u.Id == productionUnitId);
        return unit?.Name ?? string.Empty;
    }

    public async Task RemoveItemAsync(int index)
    {
        if (IsReadOnly || index < 0 || index >= Items.Count) return;

        var removedItem = Items[index];
        
        // 檢查是否已轉銷貨，已轉銷貨的項目不允許刪除
        if (removedItem.ConvertedQuantity > 0)
        {
            await NotificationService.ShowWarningAsync("此明細已轉銷貨，無法刪除", "操作失敗");
            return;
        }
        
        // 記錄要刪除的資料庫實體ID
        if (removedItem.ExistingDetailEntity != null)
        {
            var entityId = GetExistingDetailId(removedItem.ExistingDetailEntity);
            if (entityId > 0)
            {
                _deletedDetailIds.Add(entityId);
            }
        }
        
        // 通知父組件項目即將被移除
        if (OnItemRemoved.HasDelegate)
        {
            await OnItemRemoved.InvokeAsync(removedItem);
        }
        
        Items.Remove(removedItem);

        await NotifyDetailsChangedAsync();

        // 通知已刪除的明細 ID
        if (OnDeletedDetailsChanged.HasDelegate && _deletedDetailIds.Any())
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds.ToList());
            _deletedDetailIds.Clear();
        }

        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }

    /// <summary>
    /// 取得現有明細實體的ID
    /// </summary>
    private int GetExistingDetailId(QuotationDetail entity)
    {
        if (entity == null) return 0;
        return entity.Id;
    }

    /// <summary>
    /// 清除明細
    /// </summary>
    private async Task ClearAllDetails()
    {
        // 只清除未轉銷貨的項目
        var nonEmptyItems = Items.Where(item => item.SelectedProduct != null).ToList();
        var itemsToRemove = nonEmptyItems.Where(item => item.ConvertedQuantity == 0).ToList();
        var convertedItems = nonEmptyItems.Where(item => item.ConvertedQuantity > 0).ToList();
        
        if (!itemsToRemove.Any())
        {
            if (convertedItems.Any())
            {
                await NotificationService.ShowWarningAsync("所有明細項目都已轉銷貨，無法清除", "提示");
            }
            else
            {
                await NotificationService.ShowWarningAsync("沒有可清除的明細項目", "提示");
            }
            return;
        }
        
        // 通知父組件項目即將被移除
        if (OnItemRemoved.HasDelegate)
        {
            foreach (var item in itemsToRemove)
            {
                await OnItemRemoved.InvokeAsync(item);
            }
        }
        
        // 記錄所有要刪除的現有明細 ID
        foreach (var item in itemsToRemove.Where(item => item.ExistingDetailEntity != null))
        {
            var entityId = GetExistingDetailId(item.ExistingDetailEntity!);
            if (entityId > 0)
            {
                _deletedDetailIds.Add(entityId);
            }
        }
        
        // 從列表中移除所有可刪除的項目
        foreach (var item in itemsToRemove)
        {
            Items.Remove(item);
        }

        await NotifyDetailsChangedAsync();

        // 通知已刪除的明細 ID
        if (OnDeletedDetailsChanged.HasDelegate && _deletedDetailIds.Any())
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds.ToList());
            _deletedDetailIds.Clear();
        }
        
        var message = $"已清除 {itemsToRemove.Count} 項明細";
        if (convertedItems.Any())
        {
            message += $"，保留 {convertedItems.Count} 項已轉銷貨的明細";
        }
        await NotificationService.ShowSuccessAsync(message);
    }

    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        var nonEmptyItems = Items
            .Where(item => item.SelectedProduct != null)
            .ToList();
        
        if (nonEmptyItems.Count == 0)
        {
            errors.Add("至少需要一個報價商品");
        }
        else
        {
            // 檢查是否有選擇商品
            var itemsWithoutProduct = nonEmptyItems.Where(item => item.SelectedProduct == null).ToList();
            if (itemsWithoutProduct.Any())
            {
                errors.Add("所有明細都必須選擇商品");
            }
            
            // 數量和單價可以為 0，不需要驗證
        }
          
        if (errors.Any())
        {
            var errorMessage = string.Join("\n\n", errors);
            await NotificationService.ShowErrorAsync(errorMessage);
            return false;
        }
        
        return true;
    }

    /// <summary>
    /// 取得所有報價單組合明細資料（供父組件儲存使用）
    /// 對於新增的明細（ID=0），使用臨時索引（-1, -2, -3...）來標識
    /// </summary>
    public Dictionary<int, List<QuotationCompositionDetail>> GetCompositionDetails()
    {
        var result = new Dictionary<int, List<QuotationCompositionDetail>>();
        int tempIndex = -1; // 用於新增明細的臨時索引
        
        for (int i = 0; i < Items.Count; i++)
        {
            var item = Items[i];
            if (item.SelectedProduct == null) continue;
            
            var detailId = item.ExistingDetailEntity?.Id ?? 0;
            
            // 如果有自訂的組合明細
            if (item.CustomCompositionDetails?.Any() == true)
            {
                if (detailId > 0)
                {
                    // 已存在的明細，使用實際 ID
                    result[detailId] = item.CustomCompositionDetails;
                }
                else
                {
                    // 新增的明細，使用臨時索引（對應明細在陣列中的順序）
                    foreach (var detail in item.CustomCompositionDetails)
                    {
                        detail.QuotationDetailId = tempIndex; // 暫存臨時索引
                    }
                    result[tempIndex] = item.CustomCompositionDetails;
                    tempIndex--; // 下一個新增明細使用 -2, -3...
                }
            }
            // 或從快取中取得
            else if (item.SelectedProduct != null && compositionDetailsCache.ContainsKey(item.SelectedProduct.Id))
            {
                var cachedDetails = compositionDetailsCache[item.SelectedProduct.Id];
                if (detailId > 0)
                {
                    result[detailId] = cachedDetails;
                }
                else
                {
                    foreach (var detail in cachedDetails)
                    {
                        detail.QuotationDetailId = tempIndex;
                    }
                    result[tempIndex] = cachedDetails;
                    tempIndex--;
                }
            }
        }
        
        return result;
    }

    // ===== 智能下單功能 =====
    
    /// <summary>
    /// 計算屬性：是否可以使用智能下單
    /// </summary>
    private bool CanUseSmartQuotation => 
        SelectedCustomerId.HasValue && 
        SelectedCustomerId.Value > 0 &&
        !HasQuotationItems &&
        _hasLastQuotationRecord;
    
    /// <summary>
    /// 計算屬性：是否有報價明細項目
    /// </summary>
    private bool HasQuotationItems =>
        Items.Any(item => item.SelectedProduct != null);
    
    /// <summary>
    /// 取得智能下單按鈕的提示文字
    /// </summary>
    private string GetSmartQuotationTooltip()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
            return "請先選擇客戶";
        
        if (HasQuotationItems)
            return "目前已有明細資料，無法使用智能下單";
        
        if (!_hasLastQuotationRecord)
            return "此客戶沒有歷史報價記錄";
        
        if (_hasUndeletableDetails)
            return "部分明細已轉單，無法使用智能下單";
        
        return "載入該客戶上次報價的商品明細";
    }
    
    /// <summary>
    /// 取得清除明細按鈕的提示文字
    /// </summary>
    private string GetClearAllDetailsTooltip()
    {
        if (IsReadOnly)
            return "唯讀模式無法使用";
        
        if (_hasUndeletableDetails)
            return "部分明細已轉單，無法清除明細";
        
        return "清空所有報價明細";
    }

    /// <summary>
    /// 智能下單主要方法
    /// </summary>
    private async Task SmartQuotation()
    {
        if (!SelectedCustomerId.HasValue || SelectedCustomerId.Value <= 0)
        {
            await NotificationService.ShowWarningAsync("請先選擇客戶後再使用智能下單");
            return;
        }

        try
        {
            // 獲取該客戶最近一次的報價記錄
            var lastQuotationDetails = await QuotationDetailService.GetLastCompleteQuotationAsync(SelectedCustomerId.Value);
            
            if (!lastQuotationDetails.Any())
            {
                await NotificationService.ShowInfoAsync("該客戶沒有歷史報價記錄，無法使用智能下單");
                return;
            }

            // 檢查是否有現有資料
            var hasExistingData = Items.Any(item => item.SelectedProduct != null);
            
            if (hasExistingData)
            {
                // 有現有資料時不應執行（按鈕應該被禁用）
                await NotificationService.ShowWarningAsync("目前已有明細資料，無法使用智能下單");
                return;
            }

            await LoadLastQuotationDetailsInternal(lastQuotationDetails);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"智能下單失敗：{ex.Message}");
        }
    }

    /// <summary>
    /// 顯示確認對話框
    /// </summary>
    private async Task<bool> ShowConfirmationAsync(string title, string message)
    {
        // 暫時使用簡單的通知，等待確認後執行
        // 在實際專案中可能會使用更精美的對話框組件
        try 
        {
            // 先顯示警告訊息，讓使用者知道將要進行的操作
            await NotificationService.ShowWarningAsync($"{title}: {message}");
            return true; // 暫時直接返回 true，實際應該實作確認對話框
        }
        catch
        {
            return false;
        }
    }

    /// <summary>
    /// 取得可用商品列表（只顯示可販售且為自製類型的商品）
    /// </summary>
    private List<Product> GetAvailableProducts()
    {
        // 報價單不需要檢查客戶，只要商品可販售即可
        var filtered = Products
            .Where(p => p.ProductCategory != null &&
                       p.ProductCategory.IsSaleable)
            .ToList();
        
        return filtered;
    }
    
    /// <summary>
    /// 內部方法：載入上次報價明細
    /// </summary>
    private async Task LoadLastQuotationDetailsInternal(List<QuotationDetail> lastQuotationDetails)
    {
        try
        {
            // 開始載入資料 - 設定為未完成
            _dataLoadCompleted = false;
            
            // 清空現有項目
            Items.Clear();

            // 獲取系統預設稅率（在迴圈外取得，避免重複呼叫）
            var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();

            // 載入上次報價的所有商品明細
            foreach (var detail in lastQuotationDetails)
            {
                var item = new QuotationItem
                {
                    SelectedProduct = detail.Product,
                    SelectedUnit = detail.Unit,
                    ProductSearchValue = detail.Product != null ?
                        $"[{detail.Product.Code}] {detail.Product.Name}" : string.Empty,
                    Quantity = detail.Quantity,
                    UnitPrice = detail.UnitPrice,
                    DiscountPercentage = detail.DiscountPercentage,
                    TaxRate = detail.TaxRate ?? detail.Product?.TaxRate ?? defaultTaxRate,
                    ConvertedQuantity = 0,  // 新報價單，轉單數量為0
                    Remarks = string.Empty,
                    ExistingDetailEntity = null  // 新項目，沒有現有實體
                };

                Items.Add(item);
            }

            // 通知父組件明細已變更
            await NotifyDetailsChangedAsync();

            // 資料載入完成 - 觸發空行檢查
            _dataLoadCompleted = true;
            StateHasChanged();
            
            await NotificationService.ShowSuccessAsync(
                $"已成功載入上次報價的 {lastQuotationDetails.Count} 項商品明細"
            );
        }
        catch (Exception ex)
        {
            // 發生錯誤也要恢復載入完成狀態
            _dataLoadCompleted = true;
            await NotificationService.ShowErrorAsync($"載入上次報價明細失敗：{ex.Message}");
        }
    }
}
