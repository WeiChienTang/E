@*
    通用報表集
    用途：顯示指定分類的報表清單
    使用方式：透過 Category 參數指定要顯示的報表分類
*@

@using ERPCore2.Data
@using ERPCore2.Models.Reports
@inject IStringLocalizer<SharedResource> L

<GenericReportIndexModalComponent IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          Title="@L[$"ReportCategory.{Category}"].ToString()"
                          Icon="@categoryConfig.Icon"
                          Reports="@reports"
                          OnReportSelected="@HandleReportSelected" />

@code {
    // ===== 參數定義 =====
    
    /// <summary>
    /// Modal 是否顯示（由外部控制）
    /// </summary>
    [Parameter]
    public bool IsVisible { get; set; }
    
    /// <summary>
    /// Modal 顯示狀態變更事件
    /// </summary>
    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }
    
    /// <summary>
    /// 報表分類（使用 ReportCategory 常數）
    /// </summary>
    [Parameter]
    public string Category { get; set; } = string.Empty;
    
    /// <summary>
    /// 報表選擇事件（傳遞 ActionId 給 MainLayout 處理）
    /// </summary>
    [Parameter]
    public EventCallback<string> OnReportSelected { get; set; }
    
    // ===== 私有欄位 =====
    
    private List<ReportDefinition> reports = new();
    private ReportCategoryConfig categoryConfig = new();
    
    // ===== 生命週期方法 =====
    
    protected override void OnInitialized()
    {
        LoadReports();
    }
    
    protected override void OnParametersSet()
    {
        // 當 Category 參數變更時重新載入
        LoadReports();
    }
    
    // ===== 私有方法 =====
    
    private void LoadReports()
    {
        if (!string.IsNullOrEmpty(Category))
        {
            categoryConfig = ReportCategoryConfig.GetConfig(Category);
            reports = ReportRegistry.GetReportsByCategory(Category);
        }
    }
    
    // ===== 事件處理方法 =====
    
    private async Task HandleReportSelected(string actionId)
    {
        // 將 ActionId 傳遞給父組件（MainLayout）處理
        if (OnReportSelected.HasDelegate)
        {
            await OnReportSelected.InvokeAsync(actionId);
        }
    }
}
