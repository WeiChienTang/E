@* æ‡‰æ”¶å¸³æ¬¾å ±è¡¨ Modal çµ„ä»¶ - ä¸ä½¿ç”¨è·¯ç”±ï¼Œç´” Modal å½ˆçª— *@
@using ERPCore2.Models
@inject ICustomerService CustomerService
@inject INotificationService NotificationService
@inject IJSRuntime JSRuntime

@* æ‰¹æ¬¡åˆ—å°ç¯©é¸ Modal - å—æ§æ–¼å¤–éƒ¨çš„ IsVisible åƒæ•¸ *@
<BatchPrintFilterModalComponent IsVisible="@IsVisible"
                               IsVisibleChanged="@HandleModalVisibilityChanged"
                               Title="æ‡‰æ”¶å¸³æ¬¾å ±è¡¨åˆ—å°æ¢ä»¶"
                               OnConfirm="@HandlePrintConfirmAsync"
                               OnCancel="@HandlePrintCancelAsync">
    
    @* å€å¡Š 1: å®¢æˆ¶å¤šé¸ç¯©é¸ *@
    <FilterSectionComponent>
        <MultiSelectFilterComponent TItem="Customer"
                                   Items="@customers"
                                   @bind-SelectedItems="@selectedCustomers"
                                   DisplayProperty="CompanyName"
                                   ValueProperty="Id"
                                   Placeholder="è«‹è¼¸å…¥å®¢æˆ¶åç¨±æœå°‹..."
                                   EmptyMessage="å°šæœªé¸æ“‡å®¢æˆ¶ï¼Œç•™ç©ºè¡¨ç¤ºåˆ—å°æ‰€æœ‰å®¢æˆ¶çš„æ‡‰æ”¶å¸³æ¬¾"
                                   ShowCard="false" />
    </FilterSectionComponent>
    
    @* å€å¡Š 2: æ—¥æœŸç¯„åœç¯©é¸ *@
    <FilterSectionComponent Title="çµ±è¨ˆæ—¥æœŸ" 
                           IconClass="bi bi-calendar-range">
        <DateRangeFilterComponent @bind-StartDate="@startDate"
                                 @bind-EndDate="@endDate"
                                 StartDateLabel="èµ·å§‹æ—¥æœŸ"
                                 EndDateLabel="çµæŸæ—¥æœŸ"
                                 ShowQuickSelectors="true"
                                 AutoValidate="true"
                                 ShowValidationMessage="true" />
    </FilterSectionComponent>
    
    @* å€å¡Š 3: å¸³æ¬¾ç‹€æ…‹ç¯©é¸ï¼ˆå¯é¸ï¼‰ *@
    <FilterSectionComponent Title="å¸³æ¬¾ç‹€æ…‹" 
                           IconClass="bi bi-filter">
        <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="includeSettled" @bind="includeSettled">
            <label class="form-check-label" for="includeSettled">
                åŒ…å«å·²çµæ¸…å¸³æ¬¾
            </label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="includeOverdue" @bind="includeOverdue">
            <label class="form-check-label" for="includeOverdue">
                åƒ…é¡¯ç¤ºé€¾æœŸå¸³æ¬¾
            </label>
        </div>
    </FilterSectionComponent>
    
</BatchPrintFilterModalComponent>

@code {
    // ===== åƒæ•¸ =====
    
    /// <summary>
    /// Modal æ˜¯å¦é¡¯ç¤ºï¼ˆç”±å¤–éƒ¨æ§åˆ¶ï¼‰
    /// </summary>
    [Parameter]
    public bool IsVisible { get; set; }
    
    /// <summary>
    /// Modal é¡¯ç¤ºç‹€æ…‹è®Šæ›´äº‹ä»¶
    /// </summary>
    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }
    
    // ===== å…§éƒ¨ç‹€æ…‹ =====
    
    // ç¯©é¸æ¢ä»¶
    private List<Customer> customers = new();
    private List<Customer> selectedCustomers = new();
    private DateTime? startDate = null;
    private DateTime? endDate = null;
    private bool includeSettled = false;
    private bool includeOverdue = false;

    // ===== ç”Ÿå‘½é€±æœŸ =====
    
    protected override async Task OnParametersSetAsync()
    {
        // ç•¶ Modal è¢«é–‹å•Ÿæ™‚ï¼Œåˆå§‹åŒ–è³‡æ–™
        if (IsVisible && !customers.Any())
        {
            await LoadDataAsync();
        }
    }
    
    private async Task LoadDataAsync()
    {
        try
        {
            // è¼‰å…¥å®¢æˆ¶æ¸…å–®
            await LoadCustomersAsync();
            
            // è¨­å®šé è¨­æ—¥æœŸç¯„åœï¼ˆæœ¬æœˆï¼‰
            startDate = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
            endDate = DateTime.Now;
            
            // é‡ç½®ç¯©é¸æ¢ä»¶
            selectedCustomers = new();
            includeSettled = false;
            includeOverdue = false;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDataAsync), GetType(), 
                additionalData: "åˆå§‹åŒ–æ‡‰æ”¶å¸³æ¬¾å ±è¡¨è³‡æ–™å¤±æ•—");
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–æ‡‰æ”¶å¸³æ¬¾å ±è¡¨è³‡æ–™å¤±æ•—");
        }
    }

    private async Task LoadCustomersAsync()
    {
        try
        {
            customers = await CustomerService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadCustomersAsync), GetType(), 
                additionalData: "è¼‰å…¥å®¢æˆ¶è³‡æ–™å¤±æ•—");
            await NotificationService.ShowErrorAsync("è¼‰å…¥å®¢æˆ¶è³‡æ–™å¤±æ•—");
            customers = new List<Customer>();
        }
    }

    /// <summary>
    /// è™•ç† Modal é¡¯ç¤ºç‹€æ…‹è®Šæ›´ï¼ˆç•¶ä½¿ç”¨è€…é—œé–‰ Modal æ™‚ï¼‰
    /// </summary>
    private async Task HandleModalVisibilityChanged(bool visible)
    {
        // é€šçŸ¥çˆ¶çµ„ä»¶ç‹€æ…‹è®Šæ›´
        await IsVisibleChanged.InvokeAsync(visible);
    }

    /// <summary>
    /// è™•ç†åˆ—å°ç¢ºèª
    /// </summary>
    private async Task HandlePrintConfirmAsync()
    {
        try
        {
            // é¡¯ç¤ºæ¸¬è©¦è¨Šæ¯
            var customerNames = selectedCustomers.Any() 
                ? string.Join(", ", selectedCustomers.Select(c => c.CompanyName).Take(3))
                : "å…¨éƒ¨å®¢æˆ¶";
            
            var dateRange = $"{startDate:yyyy-MM-dd} ~ {endDate:yyyy-MM-dd}";
            
            var extraCount = selectedCustomers.Count > 3 ? $" ç­‰ {selectedCustomers.Count} å®¶" : "";
            var settledStatus = includeSettled ? "æ˜¯" : "å¦";
            var overdueStatus = includeOverdue ? "æ˜¯" : "å¦";
            
            var message = $"ğŸ“Š æ‡‰æ”¶å¸³æ¬¾å ±è¡¨æ¢ä»¶ï¼š\n" +
                         $"â€¢ å®¢æˆ¶ï¼š{customerNames}{extraCount}\n" +
                         $"â€¢ æ—¥æœŸç¯„åœï¼š{dateRange}\n" +
                         $"â€¢ åŒ…å«å·²çµæ¸…ï¼š{settledStatus}\n" +
                         $"â€¢ åƒ…é€¾æœŸå¸³æ¬¾ï¼š{overdueStatus}\n\n" +
                         $"(æ¸¬è©¦éšæ®µ - å°šæœªå¯¦ä½œå¯¦éš›åˆ—å°åŠŸèƒ½)";
            
            await NotificationService.ShowInfoAsync(message);
            
            // TODO: å¯¦ä½œå¯¦éš›çš„å ±è¡¨ç”¢ç”Ÿå’Œåˆ—å°é‚è¼¯
            // å»ºç«‹ç¯©é¸æ¢ä»¶ç‰©ä»¶
            // var criteria = new AccountsReceivableCriteria { ... };
            // èª¿ç”¨å ±è¡¨æœå‹™
            // var report = await ReportService.GenerateAsync(criteria);
            // é–‹å•Ÿåˆ—å°è¦–çª—
            // await JSRuntime.InvokeVoidAsync("window.open", reportUrl);
            
            // é—œé–‰ Modal
            await IsVisibleChanged.InvokeAsync(false);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePrintConfirmAsync), GetType(), 
                additionalData: new {
                    SelectedCustomersCount = selectedCustomers.Count,
                    StartDate = startDate,
                    EndDate = endDate
                });
            await NotificationService.ShowErrorAsync("ç”¢ç”Ÿå ±è¡¨å¤±æ•—");
        }
    }

    /// <summary>
    /// è™•ç†å–æ¶ˆ
    /// </summary>
    private async Task HandlePrintCancelAsync()
    {
        // é—œé–‰ Modal
        await IsVisibleChanged.InvokeAsync(false);
    }
}
