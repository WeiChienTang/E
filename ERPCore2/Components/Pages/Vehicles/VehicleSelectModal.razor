@*
    車輛選擇 Modal 組件
    用於從現有車輛中選擇配給（點擊列即可選取）
*@
@using ERPCore2.Data.Entities
@using ERPCore2.Models.Enums
@using ERPCore2.Helpers
@inject IVehicleService VehicleService
@inject INotificationService NotificationService

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="選擇配給車輛"
                   Icon="bi-search"
                   Size="BaseModalComponent.ModalSize.Desktop"
                   HeaderColor="BaseModalComponent.HeaderVariant.ProjectPrimary"
                   UseWhiteCloseButton="true"
                   IsLoading="@isLoading"
                   LoadingMessage="正在載入車輛資訊..."
                   BodyCssClass="p-4"
                   OnClose="@HandleClose">
    
    <BodyContent>
        @* 搜尋列 *@
        <SearchInputComponent Value="@searchText"
                             ValueChanged="@HandleSearchChanged"
                             Placeholder="搜尋車牌號碼、車輛名稱、廠牌、車型..."
                             CssClass="mb-3" />

        @* 車輛列表 *@
        @if (!filteredVehicles.Any() && !isLoading)
        {
            <GenericLockedFieldMessage IsVisible="true"
                                       Message="@GetEmptyMessage()"
                                       Type="GenericLockedFieldMessage.MessageType.Secondary"
                                       IconClass="bi bi-inbox" />
        }
        else
        {
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <InteractiveTableComponent TItem="Vehicle"
                                             Items="@filteredVehicles"
                                             ColumnDefinitions="@GetColumnDefinitions()"
                                             ShowHeader="true"
                                             ShowActions="false"
                                             ShowRowNumbers="true"
                                             IsStriped="true"
                                             IsHoverable="true"
                                             IsBordered="true"
                                             IsReadOnly="true"
                                             EnableRowClick="true"
                                             OnRowClick="@HandleRowClick"
                                             EmptyMessage="目前沒有可配給的車輛"
                                             CssClass="mb-0" />
                </div>
            </div>
            <div class="text-muted small mt-2">
                共 @filteredVehicles.Count 筆車輛，點擊列即可選取
            </div>
        }
    </BodyContent>
    
</BaseModalComponent>

@code {
    // ===== 參數定義 =====

    /// <summary>是否顯示 Modal</summary>
    [Parameter] public bool IsVisible { get; set; }

    /// <summary>顯示狀態變更回調</summary>
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }

    /// <summary>要排除的車輛 ID 清單（已在當前列表中的車輛）</summary>
    [Parameter] public List<int> ExcludeVehicleIds { get; set; } = new();

    /// <summary>選擇車輛後的回調</summary>
    [Parameter] public EventCallback<Vehicle> OnVehicleSelected { get; set; }

    // ===== 私有欄位 =====
    private List<Vehicle> allVehicles = new();
    private List<Vehicle> filteredVehicles = new();
    private string _searchText = string.Empty;
    private bool isLoading = false;
    private bool _lastIsVisible = false;

    /// <summary>搜尋文字（變更時自動過濾）</summary>
    private string searchText
    {
        get => _searchText;
        set
        {
            _searchText = value;
            ApplyFilter();
        }
    }

    // ===== 生命週期方法 =====

    protected override async Task OnParametersSetAsync()
    {
        // 偵測開啟：每次 IsVisible 從 false→true 都重新載入，確保資料最新
        if (IsVisible && !_lastIsVisible)
        {
            _lastIsVisible = true;
            await LoadVehiclesAsync();
        }
        else if (!IsVisible && _lastIsVisible)
        {
            _lastIsVisible = false;
            allVehicles.Clear();
            filteredVehicles.Clear();
            _searchText = string.Empty;
        }
    }

    // ===== 資料載入方法 =====

    /// <summary>載入車輛資料</summary>
    private async Task LoadVehiclesAsync()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            allVehicles = (await VehicleService.GetAllAsync())
                .Where(v => v.Status == EntityStatus.Active)
                .ToList();

            ApplyFilter();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入車輛列表失敗：{ex.Message}");
            allVehicles = new();
            filteredVehicles = new();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // ===== 搜尋過濾方法（參考 SearchableSelectHelper 模式）=====

    /// <summary>套用搜尋過濾</summary>
    private void ApplyFilter()
    {
        var query = allVehicles.Where(v => !ExcludeVehicleIds.Contains(v.Id));

        if (!string.IsNullOrWhiteSpace(_searchText))
        {
            query = query.Where(v =>
                (v.LicensePlate?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (v.VehicleName?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (v.Brand?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (v.VehicleType?.Name?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false));
        }

        filteredVehicles = query.ToList();
    }

    /// <summary>搜尋文字變更處理（由 SearchInputComponent 觸發）</summary>
    private void HandleSearchChanged(string value)
    {
        searchText = value;
    }

    /// <summary>取得空列表訊息</summary>
    private string GetEmptyMessage()
    {
        return string.IsNullOrWhiteSpace(searchText)
            ? "目前沒有可配給的車輛"
            : $"找不到符合「{searchText}」的車輛";
    }

    // ===== 表格欄位定義 =====

    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = "車牌號碼",
                PropertyName = nameof(Vehicle.LicensePlate),
                ColumnType = InteractiveColumnType.Display,
                Width = "120px"
            },
            new()
            {
                Title = "車輛名稱",
                PropertyName = nameof(Vehicle.VehicleName),
                ColumnType = InteractiveColumnType.Display,
                Width = "150px"
            },
            new()
            {
                Title = "車型",
                PropertyName = nameof(Vehicle.VehicleTypeId),
                ColumnType = InteractiveColumnType.Display,
                Width = "100px",
                DisplayFormatter = item =>
                {
                    if (item is Vehicle v && v.VehicleType != null)
                        return v.VehicleType.Name;
                    return "-";
                }
            },
            new()
            {
                Title = "廠牌",
                PropertyName = nameof(Vehicle.Brand),
                ColumnType = InteractiveColumnType.Display,
                Width = "100px",
                NullDisplayText = "-"
            },
            new()
            {
                Title = "目前配給",
                PropertyName = nameof(Vehicle.CustomerId),
                ColumnType = InteractiveColumnType.Display,
                Width = "150px",
                DisplayFormatter = item =>
                {
                    if (item is Vehicle v)
                    {
                        if (v.CustomerId.HasValue)
                            return $"<span class=\"text-warning\"><i class=\"bi bi-exclamation-triangle me-1\"></i>客戶：{v.Customer?.CompanyName ?? "未知"}</span>";
                        if (v.SupplierId.HasValue)
                            return $"<span class=\"text-warning\"><i class=\"bi bi-exclamation-triangle me-1\"></i>廠商：{v.Supplier?.CompanyName ?? "未知"}</span>";
                    }
                    return "<span class=\"text-muted\">未配給</span>";
                }
            }
        };
    }

    // ===== 事件處理方法 =====

    /// <summary>處理列點擊（選擇車輛）</summary>
    private async Task HandleRowClick(Vehicle vehicle)
    {
        await OnVehicleSelected.InvokeAsync(vehicle);
        await IsVisibleChanged.InvokeAsync(false);
    }

    /// <summary>處理關閉 Modal</summary>
    private void HandleClose()
    {
        allVehicles.Clear();
        filteredVehicles.Clear();
        _searchText = string.Empty;
    }
}
