@inject IErrorLogService ErrorLogService
@inject INotificationService NotificationService
@inject IStringLocalizer<SharedResource> L

<BaseModalComponent 
    IsVisible="@IsVisible"
    IsVisibleChanged="@IsVisibleChanged"
    Title="@L["ErrorLog.DetailTitle"]"
    Icon="fas fa-exclamation-triangle text-danger"
    Size="BaseModalComponent.ModalSize.ExtraLarge"
    HeaderColor="BaseModalComponent.HeaderVariant.Danger"
    IsLoading="@isLoading"
    LoadingMessage="@L["ErrorLog.LoadingDetail"]"
    ShowFooter="true"
    BodyCssClass="p-3"
    OnClose="@OnClose">
    
    <BodyContent>
        @if (errorLog != null)
        {
            <div class="row">
                            <!-- 基本資訊 -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">
                                            <i class="fas fa-info-circle"></i>
                                            @L["ErrorLog.BasicInfo"]
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>@L["Label.ErrorId"]</strong></div>
                                            <div class="col-8">
                                                <code>@errorLog.ErrorId</code>
                                                <GenericButtonComponent
                                                    Text="@L["Button.Copy"]"
                                                    Variant="ButtonVariant.DarkBlue"
                                                    Size="ButtonSize.Small"
                                                    CssClass="ms-2"
                                                    Title="@(L["Button.Copy"] + " " + L["Label.ErrorId"])"
                                                    OnClick="() => CopyToClipboard(errorLog.ErrorId)" />
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>@L["Label.ErrorLevel"]</strong></div>
                                            <div class="col-8">
                                                <span class="badge" style="@ErrorLogFieldConfiguration.GetLevelBadgeStyle(errorLog.Level)">
                                                    @ErrorLogFieldConfiguration.GetLevelDisplayText(errorLog.Level)
                                                </span>
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>@L["Label.ErrorSource"]</strong></div>
                                            <div class="col-8">
                                                <span class="badge bg-secondary">
                                                    @ErrorLogFieldConfiguration.GetSourceDisplayText(errorLog.Source)
                                                </span>
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>@L["Label.ErrorCategory"]</strong></div>
                                            <div class="col-8">@errorLog.Category</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>@L["Label.OccurredAt"]</strong></div>
                                            <div class="col-8">@errorLog.OccurredAt.ToString("yyyy/MM/dd HH:mm:ss")</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>@L["Label.ErrorStatus"]</strong></div>
                                            <div class="col-8">
                                                @if (errorLog.IsResolved)
                                                {
                                                    <span class="badge bg-success">@L["ErrorLog.Resolved"]</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning text-dark">@L["ErrorLog.Unresolved"]</span>
                                                }
                                            </div>
                                        </div>
                                        @if (!string.IsNullOrEmpty(errorLog.Module))
                                        {
                                            <div class="row mb-2">
                                                <div class="col-4"><strong>@L["Label.BelongsToModule"]</strong></div>
                                                <div class="col-8">@errorLog.Module</div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 技術資訊 -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">
                                            <i class="fas fa-cog"></i>
                                            @L["ErrorLog.TechInfo"]
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        @if (!string.IsNullOrEmpty(errorLog.ExceptionType))
                                        {
                                            <div class="row mb-2">
                                                <div class="col-4"><strong>@L["Label.ExceptionType"]</strong></div>
                                                <div class="col-8"><code>@errorLog.ExceptionType</code></div>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(errorLog.UserId))
                                        {
                                            <div class="row mb-2">
                                                <div class="col-4"><strong>@L["Label.UserIdLabel"]</strong></div>
                                                <div class="col-8">@errorLog.UserId</div>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(errorLog.RequestPath))
                                        {
                                            <div class="row mb-2">
                                                <div class="col-4"><strong>@L["Label.RequestPath"]</strong></div>
                                                <div class="col-8"><code>@errorLog.RequestPath</code></div>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(errorLog.UserAgent))
                                        {
                                            <div class="row mb-2">
                                                <div class="col-4"><strong>@L["Label.UserAgent"]</strong></div>
                                                <div class="col-8">
                                                    <small class="text-muted">@errorLog.UserAgent</small>
                                                </div>
                                            </div>
                                        }
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>@L["Label.CreatedAtLabel"]</strong></div>
                                            <div class="col-8">@errorLog.CreatedAt.ToString("yyyy/MM/dd HH:mm:ss")</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4"><strong>@L["Label.UpdatedAt"]</strong></div>
                                            <div class="col-8">@errorLog.UpdatedAt?.ToString("yyyy/MM/dd HH:mm:ss")</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 錯誤訊息 -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="card-title mb-0">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            @L["ErrorLog.ErrorMessage"]
                                        </h5>
                                        <GenericButtonComponent
                                            Text="@L["Button.Copy"]"
                                            Variant="ButtonVariant.DarkBlue"
                                            Size="ButtonSize.Small"
                                            Title="@(L["Button.Copy"] + " " + L["ErrorLog.ErrorMessage"])"
                                            OnClick="() => CopyToClipboard(errorLog.Message)" />
                                    </div>
                                    <div class="card-body">
                                        <pre class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">@errorLog.Message</pre>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 堆疊追蹤 -->
                        @if (!string.IsNullOrEmpty(errorLog.StackTrace))
                        {
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="card-title mb-0">
                                                <i class="fas fa-list"></i>
                                                @L["ErrorLog.StackTrace"]
                                            </h5>
                                            <GenericButtonComponent
                                                Text="@L["Button.Copy"]"
                                                Variant="ButtonVariant.DarkBlue"
                                                Size="ButtonSize.Small"
                                                Title="@(L["Button.Copy"] + " " + L["ErrorLog.StackTrace"])"
                                                OnClick="() => CopyToClipboard(errorLog.StackTrace)" />
                                        </div>
                                        <div class="card-body">
                                            <pre class="bg-dark text-light p-3 rounded" style="max-height: 300px; overflow-y: auto; font-size: 12px;">@errorLog.StackTrace</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- 內部例外 -->
                        @if (!string.IsNullOrEmpty(errorLog.InnerException))
                        {
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="card-title mb-0">
                                                <i class="fas fa-link"></i>
                                                @L["ErrorLog.InnerException"]
                                            </h5>
                                            <GenericButtonComponent
                                                Text="@L["Button.Copy"]"
                                                Variant="ButtonVariant.DarkBlue"
                                                Size="ButtonSize.Small"
                                                Title="@(L["Button.Copy"] + " " + L["ErrorLog.InnerException"])"
                                                OnClick="() => CopyToClipboard(errorLog.InnerException)" />
                                        </div>
                                        <div class="card-body">
                                            <pre class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto; font-size: 12px;">@errorLog.InnerException</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- 額外資料 -->
                        @if (!string.IsNullOrEmpty(errorLog.AdditionalData))
                        {
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="card-title mb-0">
                                                <i class="fas fa-database"></i>
                                                @L["ErrorLog.AdditionalData"]
                                            </h5>
                                            <GenericButtonComponent
                                                Text="@L["Button.Copy"]"
                                                Variant="ButtonVariant.DarkBlue"
                                                Size="ButtonSize.Small"
                                                Title="@(L["Button.Copy"] + " " + L["ErrorLog.AdditionalData"])"
                                                OnClick="() => CopyToClipboard(errorLog.AdditionalData)" />
                                        </div>
                                        <div class="card-body">
                                            <pre class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto; font-size: 12px;">@FormatJson(errorLog.AdditionalData)</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- 解決資訊 -->
                        @if (errorLog.IsResolved)
                        {
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card border-success">
                                        <div class="card-header bg-success text-white">
                                            <h5 class="card-title mb-0">
                                                <i class="fas fa-check-circle"></i>
                                                @L["ErrorLog.ResolutionInfo"]
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-2">
                                                <div class="col-3"><strong>@L["ErrorLog.ResolvedBy"]</strong></div>
                                                <div class="col-9">@(errorLog.ResolvedBy ?? L["Label.Unknown"].ToString())</div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-3"><strong>@L["ErrorLog.ResolvedAt"]</strong></div>
                                                <div class="col-9">@(errorLog.ResolvedAt?.ToString("yyyy/MM/dd HH:mm:ss") ?? L["Label.Unknown"].ToString())</div>
                                            </div>
                                            @if (!string.IsNullOrEmpty(errorLog.Resolution))
                                            {
                                                <div class="row">
                                                    <div class="col-3"><strong>@L["ErrorLog.ResolutionNote"]</strong></div>
                                                    <div class="col-9">
                                                        <div class="bg-light p-2 rounded">@errorLog.Resolution</div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
        }
        else if (!isLoading)
        {
            <div class="alert alert-warning" role="alert">
                <i class="fas fa-exclamation-triangle"></i>
                @L["ErrorLog.NotFound"]
            </div>
        }
    </BodyContent>
</BaseModalComponent>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? ErrorLogId { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private bool isLoading = false;
    private ErrorLog? errorLog = null;

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            if (IsVisible && ErrorLogId.HasValue && (errorLog == null || errorLog.Id != ErrorLogId.Value))
            {
                await LoadErrorLogAsync();
            }
            else if (!IsVisible)
            {
                // 重置狀態
                errorLog = null;
                isLoading = false;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(OnParametersSetAsync), GetType(), additionalData: "載入錯誤記錄詳細資訊失敗");
            await NotificationService.ShowErrorAsync(L["ErrorLog.LoadingDetail"].ToString());
        }
    }

    private async Task LoadErrorLogAsync()
    {
        try
        {
            if (!ErrorLogId.HasValue) return;

            isLoading = true;
            await InvokeAsync(StateHasChanged);

            errorLog = await ErrorLogService.GetByIdAsync(ErrorLogId.Value);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadErrorLogAsync), GetType(), additionalData: "載入錯誤記錄資料失敗");
            await NotificationService.ShowErrorAsync(L["ErrorLog.LoadingDetail"].ToString());
            errorLog = null;
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task HandleClose()
    {
        try
        {
            await IsVisibleChanged.InvokeAsync(false);
            await OnClose.InvokeAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleClose), GetType(), additionalData: "關閉錯誤記錄詳細檢視失敗");
        }
    }

    private async Task CopyToClipboard(string? text)
    {
        try
        {
            if (string.IsNullOrEmpty(text)) return;

            // 在實際應用中，您需要使用 IJSRuntime 來複製到剪貼簿
            // 這裡只是顯示複製成功的提示
            await NotificationService.ShowSuccessAsync(L["Message.CopiedToClipboard"].ToString());
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(CopyToClipboard), GetType(), additionalData: "複製到剪貼簿失敗");
            await NotificationService.ShowErrorAsync(L["Message.ClipboardFailed"].ToString());
        }
    }

    private string FormatJson(string json)
    {
        try
        {
            if (string.IsNullOrEmpty(json)) return string.Empty;

            // 簡單的 JSON 格式化（實際應用中可使用更完善的 JSON 格式化工具）
            var formatted = System.Text.Json.JsonSerializer.Serialize(
                System.Text.Json.JsonSerializer.Deserialize<object>(json),
                new System.Text.Json.JsonSerializerOptions { WriteIndented = true }
            );
            return formatted;
        }
        catch
        {
            // 如果解析失敗，返回原始 JSON
            return json;
        }
    }
}
