@* 系統參數設定 Modal - 使用統一 Tab 佈局 *@
@using ERPCore2.Data.Entities
@using ERPCore2.Data.Navigation
@using ERPCore2.Components.Shared.UI.Form
@using ERPCore2.Helpers.EditModal
@using System.ComponentModel.DataAnnotations

@inject ISystemParameterService SystemParameterService
@inject ISubAccountService SubAccountService
@inject ICompanyModuleService CompanyModuleService
@inject INavigationPermissionService NavigationPermissionService
@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthStateProvider

<BaseModalComponent IsVisible="@IsVisible"
                    IsVisibleChanged="@IsVisibleChanged"
                    Title="系統參數設定"
                    Icon="bi-gear-fill"
                    Size="BaseModalComponent.ModalSize.Desktop"
                    HeaderColor="BaseModalComponent.HeaderVariant.ProjectPrimary"
                    UseWhiteCloseButton="true"
                    CloseOnEscape="true"
                    CloseOnBackdropClick="false"
                    IsLoading="@isLoading"
                    ErrorMessage="@errorMessage"
                    OnClose="@HandleClose">
    <HeaderButtons>
        <GenericButtonComponent Variant="ButtonVariant.DarkBlue"
                               Text="確定"
                               OnClick="HandleSaveAsync"
                               IsDisabled="@(isSaving || isLoading)"
                               IsLoading="@isSaving"
                               Title="儲存系統參數設定" />
        <GenericButtonComponent Variant="ButtonVariant.Green"
                               Text="重整"
                               OnClick="ReloadData"
                               IsDisabled="@(isSaving || isLoading)"
                               Title="重整資料" />
        <GenericButtonComponent Variant="ButtonVariant.Orange"
                               Text="恢復預設"
                               OnClick="HandleResetToDefault"
                               IsDisabled="@(isSaving || isLoading)"
                               Title="將所有參數恢復為出廠預設值" />
        <GenericButtonComponent Variant="ButtonVariant.Red"
                               Text="取消"
                               OnClick="HandleClose"
                               Title="關閉" />
    </HeaderButtons>
    <BodyContent>
        <GenericFormComponent TModel="SystemParameter"
                              Model="@systemParameter"
                              FieldDefinitions="@allFields"
                              FieldSections="@fieldSections"
                              TabDefinitions="@tabDefinitions" />

        @* ===== 底部審計資訊 ===== *@
        @if (systemParameter.Id > 0)
        {
            <div class="mt-4 pt-3 border-top">
                <div class="text-muted small d-flex flex-wrap gap-3">
                    <span><strong>建立時間：</strong>@systemParameter.CreatedAt.ToString("yyyy/MM/dd HH:mm:ss")</span>
                    <span><strong>創建者：</strong>@(systemParameter.CreatedBy ?? "系統")</span>
                    @if (systemParameter.UpdatedAt.HasValue)
                    {
                        <span><strong>最後更新：</strong>@systemParameter.UpdatedAt.Value.ToString("yyyy/MM/dd HH:mm:ss")</span>
                        <span><strong>最後修改者：</strong>@(systemParameter.UpdatedBy ?? "系統")</span>
                    }
                </div>
            </div>
        }
    </BodyContent>
</BaseModalComponent>

@* 恢復預設確認對話框 *@
<GenericConfirmModalComponent IsVisible="@isResetConfirmVisible"
                              IsVisibleChanged="@((value) => isResetConfirmVisible = value)"
                              Title="恢復預設確認"
                              Icon="bi-arrow-counterclockwise"
                              Message="確定要將系統參數重置為預設配置嗎？現有的自訂配置將被清除。"
                              ConfirmButtonText="確定恢復"
                              ConfirmButtonVariant="ButtonVariant.Orange"
                              HeaderColor="BaseModalComponent.HeaderVariant.Warning"
                              OnConfirm="ConfirmResetToDefault" />

@code {
    // ===== 參數 =====

    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }

    // ===== 狀態變數 =====

    private bool isLoading = false;
    private bool isSaving = false;
    private string errorMessage = string.Empty;
    private SystemParameter systemParameter = new();
    private bool isResetConfirmVisible = false;

    // 批次補建子科目
    private bool isBatchCreating = false;
    private string batchTarget = string.Empty;
    private string batchResultMessage = string.Empty;
    private string batchResultCssClass = "alert-info";
    private string batchResultIcon = "bi-info-circle";
    private bool IsBatchCreatingCustomer => isBatchCreating && batchTarget == "customer";
    private bool IsBatchCreatingSupplier => isBatchCreating && batchTarget == "supplier";
    private bool IsBatchCreatingProduct  => isBatchCreating && batchTarget == "product";

    // 模組管理
    private bool isSuperAdmin = false;
    private List<CompanyModule> companyModules = new();
    private bool isModuleSaving = false;

    // ===== 表單欄位與 Tab 定義 =====

    private readonly List<FormFieldDefinition> allFields = new()
    {
        new FormFieldDefinition
        {
            PropertyName = "TaxRate",
            Label = "稅率 (%)",
            FieldType = FormFieldType.Number,
            IsRequired = true,
            Min = 0,
            Max = 100,
            Step = 0.01m,
            DecimalPlaces = 2,
            Placeholder = "請輸入稅率"
        },
        new FormFieldDefinition
        {
            PropertyName = "Remarks",
            Label = "備註",
            FieldType = FormFieldType.TextArea,
            Placeholder = "請輸入備註",
            Rows = 3,
            MaxLength = 500
        },
        // ===== 子科目自動產生開關 =====
        new FormFieldDefinition { PropertyName = "AutoCreateCustomerSubAccount", Label = "客戶子科目", FieldType = FormFieldType.Checkbox },
        new FormFieldDefinition { PropertyName = "AutoCreateSupplierSubAccount", Label = "廠商子科目", FieldType = FormFieldType.Checkbox },
        new FormFieldDefinition { PropertyName = "AutoCreateProductSubAccount",  Label = "商品子科目", FieldType = FormFieldType.Checkbox },
        new FormFieldDefinition
        {
            PropertyName = "SubAccountCodeFormat",
            Label = "代碼格式",
            FieldType = FormFieldType.Select,
            Options = new List<SelectOption>
            {
                new() { Value = "0", Text = "流水號（001, 002...）" },
                new() { Value = "1", Text = "實體編碼（使用客戶/廠商/商品代碼）" }
            },
            LabelHelpItems = new List<LabelHelpItem>
            {
                new() { Title = "流水號", Description = "依序產生三位流水號，例：1191.001、1191.002。簡潔整齊，適合大量客戶/廠商。" },
                new() { Title = "實體編碼", Description = "使用客戶/廠商/商品的代碼作為後綴，例：1191.C0001。一眼可辨認對應實體，適合代碼有意義的場景。" }
            }
        },
        // ===== 統制科目代碼 =====
        new FormFieldDefinition { PropertyName = "CustomerSubAccountParentCode", Label = "應收帳款", FieldType = FormFieldType.Text, Placeholder = "預設：1191", MaxLength = 20 },
        new FormFieldDefinition { PropertyName = "SupplierSubAccountParentCode", Label = "應付帳款", FieldType = FormFieldType.Text, Placeholder = "預設：2171", MaxLength = 20 },
        new FormFieldDefinition { PropertyName = "ProductSubAccountParentCode",  Label = "商品存貨", FieldType = FormFieldType.Text, Placeholder = "預設：1231", MaxLength = 20 }
    };

    private readonly Dictionary<string, string> fieldSections = new()
    {
        { "TaxRate", "稅務設定" },
        { "Remarks", "稅務設定" },
        // 子科目自動產生
        { "AutoCreateCustomerSubAccount", "自動產生設定" },
        { "AutoCreateSupplierSubAccount", "自動產生設定" },
        { "AutoCreateProductSubAccount",  "自動產生設定" },
        { "SubAccountCodeFormat",         "自動產生設定" },
        { "CustomerSubAccountParentCode", "統制科目代碼" },
        { "SupplierSubAccountParentCode", "統制科目代碼" },
        { "ProductSubAccountParentCode",  "統制科目代碼" }
    };

    private List<FormTabDefinition> tabDefinitions = new();

    // ===== 生命週期方法 =====

    protected override void OnInitialized()
    {
        tabDefinitions = new List<FormTabDefinition>
        {
            new() { Label = "稅務設定", Icon = "bi bi-cash-stack", SectionNames = new() { "稅務設定" } },
            new()
            {
                Label = "子科目設定",
                Icon = "bi bi-diagram-3",
                SectionNames = new() { "自動產生設定", "統制科目代碼" },
                ExtraContent = CreateSubAccountBatchContent()
            }
        };
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        // 使用現有權限服務檢查是否為 SuperAdmin
        try
        {
            isSuperAdmin = await NavigationPermissionService.CanAccessAsync("System.Admin");
        }
        catch { }

        // SuperAdmin 才加入模組管理 Tab（載入後動態加入）
        if (isSuperAdmin)
        {
            companyModules = await CompanyModuleService.GetAllAsync();
            tabDefinitions.Add(new FormTabDefinition
            {
                Label = "模組管理",
                Icon = "bi bi-toggles",
                SectionNames = new(),
                ExtraContent = CreateModuleManagementContent()
            });
        }
    }

    private RenderFragment CreateSubAccountBatchContent() => __builder =>
    {
        <div class="mt-4 pt-3 border-top">
            <h6 class="mb-3"><i class="bi bi-diagram-3 me-2"></i>批次補建子科目</h6>
            <p class="text-muted mb-3">為現有客戶、廠商、商品補建子科目（已有子科目者略過）。執行前請先確認上方統制科目代碼設定正確並已儲存。</p>
            <div class="d-flex flex-wrap gap-2 mb-3">
                <GenericButtonComponent Variant="ButtonVariant.DarkBlue"
                                       Text="補建客戶"
                                       OnClick="HandleBatchCreateCustomerAsync"
                                       IsDisabled="@(isBatchCreating || isLoading || isSaving)"
                                       IsLoading="@IsBatchCreatingCustomer"
                                       Title="為所有現有客戶補建子科目" />
                <GenericButtonComponent Variant="ButtonVariant.DarkBlue"
                                       Text="補建廠商"
                                       OnClick="HandleBatchCreateSupplierAsync"
                                       IsDisabled="@(isBatchCreating || isLoading || isSaving)"
                                       IsLoading="@IsBatchCreatingSupplier"
                                       Title="為所有現有廠商補建子科目" />
                <GenericButtonComponent Variant="ButtonVariant.DarkBlue"
                                       Text="補建商品"
                                       OnClick="HandleBatchCreateProductAsync"
                                       IsDisabled="@(isBatchCreating || isLoading || isSaving)"
                                       IsLoading="@IsBatchCreatingProduct"
                                       Title="為所有現有商品補建子科目" />
            </div>
            @if (!string.IsNullOrEmpty(batchResultMessage))
            {
                <div class="alert @batchResultCssClass py-2 mb-0 small">
                    <i class="bi @batchResultIcon me-1"></i>@batchResultMessage
                </div>
            }
        </div>
    };

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && systemParameter.Id == 0 && !isLoading)
        {
            await LoadSystemParameterAsync();
        }
    }

    // ===== 資料載入 =====

    private async Task LoadSystemParameterAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = string.Empty;
            StateHasChanged();

            var existingParameter = await SystemParameterService.GetSystemParameterAsync();

            if (existingParameter != null)
            {
                systemParameter = existingParameter;
            }
            else
            {
                systemParameter = new SystemParameter();
                SystemParameterDefaults.ApplyDefaults(systemParameter);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"載入系統參數時發生錯誤：{ex.Message}";
            await NotificationService.ShowErrorAsync("載入系統參數失敗");

            systemParameter = new SystemParameter();
            SystemParameterDefaults.ApplyDefaults(systemParameter);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // ===== 儲存 =====

    private async Task HandleSaveAsync()
    {
        if (isSaving) return;

        try
        {
            isSaving = true;
            StateHasChanged();

            // 程式化驗證
            var validationContext = new ValidationContext(systemParameter);
            var validationResults = new List<ValidationResult>();
            if (!Validator.TryValidateObject(systemParameter, validationContext, validationResults, true))
            {
                var errors = string.Join("、", validationResults.Select(r => r.ErrorMessage));
                await NotificationService.ShowErrorAsync($"驗證失敗：{errors}");
                return;
            }

            ServiceResult<SystemParameter> result;

            if (systemParameter.Id > 0)
            {
                result = await SystemParameterService.UpdateAsync(systemParameter);
            }
            else
            {
                result = await SystemParameterService.CreateAsync(systemParameter);
            }

            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync("系統參數已成功儲存！");
                if (result.Data != null)
                {
                    systemParameter = result.Data;
                }
            }
            else
            {
                var errorMsg = !string.IsNullOrEmpty(result.ErrorMessage)
                    ? result.ErrorMessage
                    : "儲存失敗";
                await NotificationService.ShowErrorAsync($"儲存系統參數失敗：{errorMsg}");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"儲存系統參數時發生錯誤：{ex.Message}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    // ===== 重整 =====

    private async Task ReloadData()
    {
        await LoadSystemParameterAsync();
        await NotificationService.ShowSuccessAsync("資料已重新載入");
    }

    // ===== 關閉 =====

    private async Task HandleClose()
    {
        batchResultMessage = string.Empty;
        batchResultCssClass = "alert-info";
        batchResultIcon = "bi-info-circle";

        if (IsVisibleChanged.HasDelegate)
        {
            await IsVisibleChanged.InvokeAsync(false);
        }
    }

    // ===== 恢復預設 =====

    private void HandleResetToDefault()
    {
        isResetConfirmVisible = true;
    }

    private async Task ConfirmResetToDefault()
    {
        try
        {
            isSaving = true;
            StateHasChanged();

            var result = await SystemParameterService.ResetToDefaultAsync();

            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync("已重置為預設配置");
                await LoadSystemParameterAsync();
            }
            else
            {
                var errorMsg = !string.IsNullOrEmpty(result.ErrorMessage)
                    ? result.ErrorMessage
                    : "重置失敗";
                await NotificationService.ShowErrorAsync($"恢復預設失敗：{errorMsg}");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"恢復預設時發生錯誤：{ex.Message}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    // ===== 模組管理 =====

    private RenderFragment CreateModuleManagementContent() => __builder =>
    {
        <div class="mt-2">
            <p class="text-muted mb-3">控制此系統可使用的功能模組。停用的模組將對所有使用者隱藏（SuperAdmin 除外）。</p>
            <div class="list-group mb-3">
                @foreach (var module in companyModules)
                {
                    <div class="list-group-item d-flex align-items-center gap-3">
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input"
                                   type="checkbox"
                                   role="switch"
                                   id="module_@module.Id"
                                   checked="@module.IsEnabled"
                                   disabled="@(isModuleSaving || isSaving || isLoading)"
                                   @onchange="@((e) => module.IsEnabled = (bool)(e.Value ?? true))" />
                        </div>
                        <label class="mb-0 flex-grow-1" for="module_@module.Id">
                            <strong>@module.DisplayName</strong>
                            @if (!string.IsNullOrEmpty(module.Description))
                            {
                                <small class="text-muted d-block">@module.Description</small>
                            }
                        </label>
                        <span class="badge @(module.IsEnabled ? "bg-success" : "bg-secondary")">
                            @(module.IsEnabled ? "啟用" : "停用")
                        </span>
                    </div>
                }
            </div>
            <GenericButtonComponent Variant="ButtonVariant.DarkBlue"
                                   Text="儲存模組設定"
                                   OnClick="HandleSaveModulesAsync"
                                   IsDisabled="@(isModuleSaving || isSaving || isLoading)"
                                   IsLoading="@isModuleSaving"
                                   Title="儲存功能模組啟用狀態" />
        </div>
    };

    private async Task HandleSaveModulesAsync()
    {
        if (isModuleSaving) return;

        try
        {
            isModuleSaving = true;
            StateHasChanged();

            var createdBy = await GetCurrentUserAsync();
            var result = await CompanyModuleService.UpdateModulesAsync(companyModules, createdBy);

            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync("模組設定已儲存");
            }
            else
            {
                await NotificationService.ShowErrorAsync($"儲存失敗：{result.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"儲存模組設定時發生錯誤：{ex.Message}");
        }
        finally
        {
            isModuleSaving = false;
            StateHasChanged();
        }
    }

    // ===== 批次補建子科目 =====

    private async Task<string> GetCurrentUserAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            return authState.User.Identity?.Name ?? "system";
        }
        catch
        {
            return "system";
        }
    }

    private async Task HandleBatchCreateCustomerAsync()
    {
        await ExecuteBatchCreateAsync("customer", async (createdBy) =>
            await SubAccountService.BatchCreateForAllCustomersAsync(createdBy), "客戶");
    }

    private async Task HandleBatchCreateSupplierAsync()
    {
        await ExecuteBatchCreateAsync("supplier", async (createdBy) =>
            await SubAccountService.BatchCreateForAllSuppliersAsync(createdBy), "廠商");
    }

    private async Task HandleBatchCreateProductAsync()
    {
        await ExecuteBatchCreateAsync("product", async (createdBy) =>
            await SubAccountService.BatchCreateForAllProductsAsync(createdBy), "商品");
    }

    private async Task ExecuteBatchCreateAsync(
        string target,
        Func<string, Task<(int Created, int Skipped, List<string> Errors)>> batchFunc,
        string entityLabel)
    {
        try
        {
            isBatchCreating = true;
            batchTarget = target;
            batchResultMessage = string.Empty;
            StateHasChanged();

            var createdBy = await GetCurrentUserAsync();
            var (created, skipped, errors) = await batchFunc(createdBy);

            if (errors.Count == 0)
            {
                batchResultMessage = $"{entityLabel}子科目補建完成：建立 {created} 筆，略過 {skipped} 筆";
                batchResultCssClass = "alert-success";
                batchResultIcon = "bi-check-circle";
            }
            else
            {
                batchResultMessage = $"{entityLabel}子科目補建完成：建立 {created} 筆，略過 {skipped} 筆，錯誤 {errors.Count} 筆（{string.Join("；", errors.Take(3))}{(errors.Count > 3 ? "…" : "")}）";
                batchResultCssClass = "alert-warning";
                batchResultIcon = "bi-exclamation-triangle";
            }
        }
        catch (Exception ex)
        {
            batchResultMessage = $"批次補建{entityLabel}子科目時發生錯誤：{ex.Message}";
            batchResultCssClass = "alert-danger";
            batchResultIcon = "bi-x-circle";
            await NotificationService.ShowErrorAsync($"批次補建{entityLabel}子科目失敗");
        }
        finally
        {
            isBatchCreating = false;
            batchTarget = string.Empty;
            StateHasChanged();
        }
    }
}
