@* 子科目設定 Tab *@

@inject ISubAccountService SubAccountService
@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthStateProvider

<GenericFormComponent TModel="SystemParameter"
                      Model="@Model"
                      FieldDefinitions="@allFields"
                      FieldSections="@fieldSections" />

@* 批次補建子科目 *@
<div class="mt-4 pt-3 border-top">
    <h6 class="mb-3"><i class="bi bi-diagram-3 me-2"></i>批次補建子科目</h6>
    <p class="text-muted mb-3">為現有客戶、廠商、商品補建子科目（已有子科目者略過）。執行前請先確認上方統制科目代碼設定正確並已儲存。</p>
    <div class="d-flex flex-wrap gap-2 mb-3">
        <GenericButtonComponent Variant="ButtonVariant.DarkBlue"
                               Text="補建客戶"
                               OnClick="HandleBatchCreateCustomerAsync"
                               IsDisabled="@(isBatchCreating || IsDisabled)"
                               IsLoading="@IsBatchCreatingCustomer"
                               Title="為所有現有客戶補建子科目" />
        <GenericButtonComponent Variant="ButtonVariant.DarkBlue"
                               Text="補建廠商"
                               OnClick="HandleBatchCreateSupplierAsync"
                               IsDisabled="@(isBatchCreating || IsDisabled)"
                               IsLoading="@IsBatchCreatingSupplier"
                               Title="為所有現有廠商補建子科目" />
        <GenericButtonComponent Variant="ButtonVariant.DarkBlue"
                               Text="補建商品"
                               OnClick="HandleBatchCreateProductAsync"
                               IsDisabled="@(isBatchCreating || IsDisabled)"
                               IsLoading="@IsBatchCreatingProduct"
                               Title="為所有現有商品補建子科目" />
    </div>
    @if (!string.IsNullOrEmpty(batchResultMessage))
    {
        <div class="alert @batchResultCssClass py-2 mb-0 small">
            <i class="bi @batchResultIcon me-1"></i>@batchResultMessage
        </div>
    }
</div>

@code {
    [Parameter]
    public SystemParameter Model { get; set; } = new();

    [Parameter]
    public bool IsDisabled { get; set; }

    // 批次補建子科目
    private bool isBatchCreating = false;
    private string batchTarget = string.Empty;
    private string batchResultMessage = string.Empty;
    private string batchResultCssClass = "alert-info";
    private string batchResultIcon = "bi-info-circle";
    private bool IsBatchCreatingCustomer => isBatchCreating && batchTarget == "customer";
    private bool IsBatchCreatingSupplier => isBatchCreating && batchTarget == "supplier";
    private bool IsBatchCreatingProduct  => isBatchCreating && batchTarget == "product";

    private readonly List<FormFieldDefinition> allFields = new()
    {
        // ===== 子科目自動產生開關 =====
        new FormFieldDefinition { PropertyName = "AutoCreateCustomerSubAccount", Label = "客戶子科目", FieldType = FormFieldType.Checkbox },
        new FormFieldDefinition { PropertyName = "AutoCreateSupplierSubAccount", Label = "廠商子科目", FieldType = FormFieldType.Checkbox },
        new FormFieldDefinition { PropertyName = "AutoCreateProductSubAccount",  Label = "商品子科目", FieldType = FormFieldType.Checkbox },
        new FormFieldDefinition
        {
            PropertyName = "SubAccountCodeFormat",
            Label = "代碼格式",
            FieldType = FormFieldType.Select,
            Options = new List<SelectOption>
            {
                new() { Value = "0", Text = "流水號（001, 002...）" },
                new() { Value = "1", Text = "實體編碼（使用客戶/廠商/商品代碼）" }
            },
            LabelHelpItems = new List<LabelHelpItem>
            {
                new() { Title = "流水號", Description = "依序產生三位流水號，例：1191.001、1191.002。簡潔整齊，適合大量客戶/廠商。" },
                new() { Title = "實體編碼", Description = "使用客戶/廠商/商品的代碼作為後綴，例：1191.C0001。一眼可辨認對應實體，適合代碼有意義的場景。" }
            }
        },
        // ===== 統制科目代碼 =====
        new FormFieldDefinition { PropertyName = "CustomerSubAccountParentCode", Label = "應收帳款", FieldType = FormFieldType.Text, Placeholder = "預設：1191", MaxLength = 20 },
        new FormFieldDefinition { PropertyName = "SupplierSubAccountParentCode", Label = "應付帳款", FieldType = FormFieldType.Text, Placeholder = "預設：2171", MaxLength = 20 },
        new FormFieldDefinition { PropertyName = "ProductSubAccountParentCode",  Label = "商品存貨", FieldType = FormFieldType.Text, Placeholder = "預設：1231", MaxLength = 20 }
    };

    private readonly Dictionary<string, string> fieldSections = new()
    {
        { "AutoCreateCustomerSubAccount", "自動產生設定" },
        { "AutoCreateSupplierSubAccount", "自動產生設定" },
        { "AutoCreateProductSubAccount",  "自動產生設定" },
        { "SubAccountCodeFormat",         "自動產生設定" },
        { "CustomerSubAccountParentCode", "統制科目代碼" },
        { "SupplierSubAccountParentCode", "統制科目代碼" },
        { "ProductSubAccountParentCode",  "統制科目代碼" }
    };

    // ===== 批次補建子科目 =====

    private async Task<string> GetCurrentUserAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            return authState.User.Identity?.Name ?? "system";
        }
        catch
        {
            return "system";
        }
    }

    private async Task HandleBatchCreateCustomerAsync()
    {
        await ExecuteBatchCreateAsync("customer", async (createdBy) =>
            await SubAccountService.BatchCreateForAllCustomersAsync(createdBy), "客戶");
    }

    private async Task HandleBatchCreateSupplierAsync()
    {
        await ExecuteBatchCreateAsync("supplier", async (createdBy) =>
            await SubAccountService.BatchCreateForAllSuppliersAsync(createdBy), "廠商");
    }

    private async Task HandleBatchCreateProductAsync()
    {
        await ExecuteBatchCreateAsync("product", async (createdBy) =>
            await SubAccountService.BatchCreateForAllProductsAsync(createdBy), "商品");
    }

    private async Task ExecuteBatchCreateAsync(
        string target,
        Func<string, Task<(int Created, int Skipped, List<string> Errors)>> batchFunc,
        string entityLabel)
    {
        try
        {
            isBatchCreating = true;
            batchTarget = target;
            batchResultMessage = string.Empty;
            StateHasChanged();

            var createdBy = await GetCurrentUserAsync();
            var (created, skipped, errors) = await batchFunc(createdBy);

            if (errors.Count == 0)
            {
                batchResultMessage = $"{entityLabel}子科目補建完成：建立 {created} 筆，略過 {skipped} 筆";
                batchResultCssClass = "alert-success";
                batchResultIcon = "bi-check-circle";
            }
            else
            {
                batchResultMessage = $"{entityLabel}子科目補建完成：建立 {created} 筆，略過 {skipped} 筆，錯誤 {errors.Count} 筆（{string.Join("；", errors.Take(3))}{(errors.Count > 3 ? "…" : "")}）";
                batchResultCssClass = "alert-warning";
                batchResultIcon = "bi-exclamation-triangle";
            }
        }
        catch (Exception ex)
        {
            batchResultMessage = $"批次補建{entityLabel}子科目時發生錯誤：{ex.Message}";
            batchResultCssClass = "alert-danger";
            batchResultIcon = "bi-x-circle";
            await NotificationService.ShowErrorAsync($"批次補建{entityLabel}子科目失敗");
        }
        finally
        {
            isBatchCreating = false;
            batchTarget = string.Empty;
            StateHasChanged();
        }
    }

    /// <summary>
    /// 清除批次結果訊息（主檔關閉時呼叫）
    /// </summary>
    public void ClearBatchResult()
    {
        batchResultMessage = string.Empty;
        batchResultCssClass = "alert-info";
        batchResultIcon = "bi-info-circle";
    }
}
