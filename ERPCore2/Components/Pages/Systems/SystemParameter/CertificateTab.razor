@* 安全憑證 Tab（目前停用，預留未來啟用） *@

@inject ICertificateService CertificateService
@inject IWebHostEnvironment WebHostEnvironment
@inject NavigationManager NavigationManager
@inject IConfiguration Configuration
@inject IStringLocalizer<SharedResource> L

<div class="mt-2">
    <p class="text-muted mb-3">
        @L["System.CertDesc"]
    </p>

    @* ── 產生憑證區塊（永遠顯示） ── *@
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-shield-plus me-2"></i>@L["System.CertManage"]</h6>
        </div>
        <div class="card-body">
            @if (certFileExists)
            {
                <p class="text-muted small mb-3">@L["System.CertExistsNote"]</p>
            }
            else
            {
                <p class="text-muted small mb-3">@L["System.NoCertNote"]</p>
            }
            <div class="mb-3">
                <label class="form-label small fw-bold">
                    <i class="bi bi-globe me-1"></i>@L["System.ExternalSAN"]
                </label>
                <input type="text" class="form-control form-control-sm"
                       placeholder="@L["System.ExternalSANPlaceholder"]"
                       value="@certExtraSans"
                       @oninput="@(e => certExtraSans = e.Value?.ToString() ?? string.Empty)"
                       disabled="@isGeneratingCert" />
                <div class="form-text">
                    @L["System.ExternalSANHint"]
                </div>
            </div>
            <GenericButtonComponent Variant="@(certFileExists ? ButtonVariant.Orange : ButtonVariant.DarkBlue)"
                                   Text="@(certFileExists ? L["System.ReGenCert"].ToString() : L["System.GenCert"].ToString())"
                                   OnClick="HandleGenerateCertAsync"
                                   IsDisabled="@isGeneratingCert"
                                   IsLoading="@isGeneratingCert"
                                   Title="@L["System.GenCertTitle"]" />

            @if (!string.IsNullOrEmpty(certGenerateMessage))
            {
                <div class="alert @certGenerateCssClass mt-3 mb-0 small">
                    <i class="bi @certGenerateIcon me-1"></i>@certGenerateMessage
                </div>
            }
        </div>
    </div>

    @* ── 憑證下載區塊（憑證存在才顯示） ── *@
    @if (certFileExists)
    {
        <div class="list-group mb-4">
            <div class="list-group-item">
                <div class="d-flex align-items-center gap-3">
                    <i class="bi bi-file-earmark-arrow-down fs-4 text-primary"></i>
                    <div class="flex-grow-1">
                        <strong>@L["System.InstallerTitle"]</strong>
                        <small class="text-muted d-block">@L["System.InstallerDesc"]</small>
                        <small class="text-muted font-monospace">@certInstallerUrl</small>
                    </div>
                    <a href="@certInstallerUrl" class="btn btn-primary" target="_blank">
                        <i class="bi bi-download me-1"></i>@L["System.Download"]
                    </a>
                </div>
            </div>
            <div class="list-group-item">
                <div class="d-flex align-items-center gap-3">
                    <i class="bi bi-file-earmark-binary fs-4 text-secondary"></i>
                    <div class="flex-grow-1">
                        <strong>@L["System.CerPublicKey"]</strong>
                        <small class="text-muted d-block">@L["System.CerPublicDesc"]</small>
                        <small class="text-muted font-monospace">@certDownloadUrl</small>
                    </div>
                    <a href="@certDownloadUrl" class="btn btn-outline-secondary" target="_blank">
                        <i class="bi bi-download me-1"></i>@L["System.Download"]
                    </a>
                </div>
            </div>
        </div>

        <div class="card border-0 bg-light">
            <div class="card-body">
                <h6 class="card-title"><i class="bi bi-info-circle me-2"></i>@L["System.InstallStepsTitle"]</h6>
                <ol class="mb-0 small">
                    <li class="mb-1">@L["System.InstallStep1"]</li>
                    <li class="mb-1">@L["System.InstallStep2"]</li>
                    <li class="mb-1">@L["System.InstallStep3"]</li>
                    <li class="mb-1">@L["System.InstallStep4"]</li>
                    <li>@L["System.InstallStep5"]</li>
                </ol>
            </div>
        </div>
    }
</div>

@code {
    // 安全憑證
    private bool certFileExists = false;
    private string certInstallerUrl = string.Empty;
    private string certDownloadUrl = string.Empty;
    private bool isGeneratingCert = false;
    private string certGenerateMessage = string.Empty;
    private string certGenerateCssClass = string.Empty;
    private string certGenerateIcon = string.Empty;
    private string certExtraSans = string.Empty;

    protected override void OnInitialized()
    {
        // 檢查憑證檔案是否存在
        var certPath = Path.Combine(WebHostEnvironment.ContentRootPath, "Resources", "erpcore2.cer");
        certFileExists = File.Exists(certPath);

        // 建立憑證相關 URL：根據當前連線協定動態選擇，避免 HTTPS 頁面中 HTTP 連結被瀏覽器 Mixed Content 封鎖
        var baseUri = new Uri(NavigationManager.BaseUri);
        var httpsSection = Configuration.GetSection("HttpsConfig");
        string downloadBase;
        if (baseUri.Scheme == "https")
        {
            var httpsPort = httpsSection.GetValue<int>("HttpsPort", 6012);
            downloadBase = $"https://{baseUri.Host}:{httpsPort}";
        }
        else
        {
            var httpPort = httpsSection.GetValue<int>("HttpPort", 6011);
            downloadBase = $"http://{baseUri.Host}:{httpPort}";
        }
        certInstallerUrl = $"{downloadBase}/api/certificate/installer";
        certDownloadUrl = $"{downloadBase}/api/certificate/cer";
    }

    private async Task HandleGenerateCertAsync()
    {
        if (isGeneratingCert) return;

        try
        {
            isGeneratingCert = true;
            certGenerateMessage = string.Empty;
            StateHasChanged();

            var extraSansArray = certExtraSans
                .Split(new[] { ',', ';', '\n' }, StringSplitOptions.RemoveEmptyEntries)
                .Select(s => s.Trim())
                .Where(s => !string.IsNullOrEmpty(s))
                .ToArray();

            var (success, message) = await CertificateService.GenerateSelfSignedCertificateAsync(
                extraSansArray.Length > 0 ? extraSansArray : null);

            if (success)
            {
                certGenerateMessage = message;
                certGenerateCssClass = "alert-success";
                certGenerateIcon = "bi-check-circle";

                // 更新憑證狀態
                certFileExists = CertificateService.CertificateExists();
            }
            else
            {
                certGenerateMessage = message;
                certGenerateCssClass = "alert-danger";
                certGenerateIcon = "bi-x-circle";
            }
        }
        catch (Exception ex)
        {
            certGenerateMessage = $"產生憑證時發生錯誤：{ex.Message}";
            certGenerateCssClass = "alert-danger";
            certGenerateIcon = "bi-x-circle";
        }
        finally
        {
            isGeneratingCert = false;
            StateHasChanged();
        }
    }
}
