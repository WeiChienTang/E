@* 可重用的報表列印配置編輯組件 - 可在任何頁面中嵌入 *@
@using ERPCore2.Helpers
@using ERPCore2.Data
@using ERPCore2.Models
@inject IReportPrintConfigurationService ReportPrintConfigurationService
@inject IPrinterConfigurationService PrinterConfigurationService
@inject IPaperSettingService PaperSettingService
@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IEmployeeService EmployeeService

<GenericEditModalComponent TEntity="ReportPrintConfiguration" 
                          TService="IReportPrintConfigurationService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@ReportPrintConfigurationId"
                          Service="@ReportPrintConfigurationService"
                          EntityName="報表列印配置"
                          EntityNamePlural="報表列印配置"
                          ModalTitle="@(ReportPrintConfigurationId.HasValue ? "編輯報表列印配置" : "新增報表列印配置")"
                          Size="GenericEditModalComponent<ReportPrintConfiguration, IReportPrintConfigurationService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@autoCompleteConfig?.Prefillers"
                          AutoCompleteCollections="@autoCompleteConfig?.Collections"
                          AutoCompleteDisplayProperties="@autoCompleteConfig?.DisplayProperties"
                          AutoCompleteValueProperties="@autoCompleteConfig?.ValueProperties"
                          DataLoader="@LoadReportPrintConfigurationData"
                          AdditionalDataLoader="@LoadAdditionalDataAsync"
                          UseGenericSave="true"
                          SaveSuccessMessage="@(ReportPrintConfigurationId.HasValue ? "報表列印配置更新成功" : "報表列印配置新增成功")"
                          SaveFailureMessage="報表列印配置儲存失敗"
                          RequiredPermission="ReportPrintConfiguration.Read"
                          OnEntitySaved="@OnReportPrintConfigurationSaved"
                          OnCancel="@OnCancel"
                          OnEntityLoaded="@HandleEntityLoaded" />

@code {
    // ===== 參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? ReportPrintConfigurationId { get; set; }
    [Parameter] public EventCallback<ReportPrintConfiguration> OnReportPrintConfigurationSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public Dictionary<string, object?>? PrefilledValues { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<ReportPrintConfiguration, IReportPrintConfigurationService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();

    // AutoComplete 配置
    private AutoCompleteConfig? autoCompleteConfig;

    // 原始資料集合（用於 AutoComplete）
    private List<PrinterConfiguration> availablePrinters = new();
    private List<PaperSetting> availablePaperSettings = new();
    private List<ReportDefinition> availableReports = new();

    // 下拉選單選項（向下相容）
    private List<SelectOption> printerConfigurationOptions = new();
    private List<SelectOption> paperSettingOptions = new();
    private List<SelectOption> reportOptions = new();
    
    // 資料載入狀態標記
    private bool isDataLoaded = false;

    // 管理員權限
    private bool isCurrentUserSuperAdmin = false;

    // ===== 生命週期 =====
    
    /// <summary>
    /// 處理實體載入完成事件（由 GenericEditModalComponent 的導航觸發）
    /// 當上下筆切換時觸發 UI 更新，確保表單欄位正確渲染
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            // 對於沒有明細的純主檔組件，只需要觸發 UI 更新即可
            StateHasChanged();
            await Task.CompletedTask;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入資料時發生錯誤：{ex.Message}");
        }
    }
    // ===== 資料載入 =====
    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // 載入報表定義選項（從 ReportRegistry 靜態取得）
            availableReports = ReportRegistry.GetAllReports();
            reportOptions = availableReports
                .Select(r => new SelectOption { Text = $"{r.Id} - {r.Name}", Value = r.Id })
                .OrderBy(r => r.Value)
                .ToList();

            // 載入印表機設定選項
            var printerConfigurations = await PrinterConfigurationService.GetAllAsync();
            availablePrinters = printerConfigurations.Where(p => p.Status == EntityStatus.Active).ToList();
            printerConfigurationOptions = availablePrinters
                .Select(p => new SelectOption { Text = p.Name, Value = p.Id.ToString() })
                .OrderBy(p => p.Text)
                .ToList();

            // 載入紙張設定選項
            var paperSettings = await PaperSettingService.GetAllAsync();
            availablePaperSettings = paperSettings.Where(p => p.Status == EntityStatus.Active).ToList();
            paperSettingOptions = availablePaperSettings
                .Select(p => new SelectOption { Text = p.Name, Value = p.Id.ToString() })
                .OrderBy(p => p.Text)
                .ToList();
            
            // 使用 AutoCompleteConfigBuilder 建立配置
            autoCompleteConfig = new AutoCompleteConfigBuilder<ReportPrintConfiguration>()
                .AddField(nameof(ReportPrintConfiguration.PrinterConfigurationId), "Name", availablePrinters)
                .AddField(nameof(ReportPrintConfiguration.PaperSettingId), "Name", availablePaperSettings)
                .Build();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入下拉選單選項時發生錯誤：{ex.Message}");
            availableReports = new List<ReportDefinition>();
            availablePrinters = new List<PrinterConfiguration>();
            availablePaperSettings = new List<PaperSetting>();
            reportOptions = new List<SelectOption>();
            printerConfigurationOptions = new List<SelectOption>();
            paperSettingOptions = new List<SelectOption>();
        }
    }

    private async Task<ReportPrintConfiguration?> LoadReportPrintConfigurationData()
    {
        try
        {
            if (!ReportPrintConfigurationId.HasValue) 
            {
                // 新增模式：建立新的報表列印配置實體並生成編號
                var newReportPrintConfiguration = new ReportPrintConfiguration
                {
                    ReportName = string.Empty,
                    Code = GenerateReportPrintConfigurationCode(),
                    Status = EntityStatus.Active
                };
                
                // 應用預填值
                PrefilledValueHelper.ApplyPrefilledValues(newReportPrintConfiguration, PrefilledValues);
                
                return newReportPrintConfiguration;
            }

            var reportPrintConfiguration = await ReportPrintConfigurationService.GetByIdAsync(ReportPrintConfigurationId.Value);            
            
            if (reportPrintConfiguration == null)
            {
                // 如果找不到報表列印配置，建立新的預設配置
                return new ReportPrintConfiguration
                {
                    Status = EntityStatus.Active
                };
            }
            return reportPrintConfiguration;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入報表列印配置資料時發生錯誤：{ex.Message}");
            return null;
        }
    }
    /// <summary>
    /// 檢查當前使用者是否為管理員
    /// </summary>
    private async Task CheckCurrentUserSuperAdminAsync()
    {
        try
        {
            var currentEmployeeId = await CurrentUserHelper.GetCurrentEmployeeIdAsync(AuthenticationStateProvider);
            if (currentEmployeeId.HasValue)
            {
                var currentEmployee = await EmployeeService.GetByIdAsync(currentEmployeeId.Value);
                isCurrentUserSuperAdmin = currentEmployee?.IsSuperAdmin == true;
            }
        }
        catch
        {
            isCurrentUserSuperAdmin = false;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            await CheckCurrentUserSuperAdminAsync();
            await LoadAdditionalDataAsync();
            InitializeFormFields();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
        }

        await base.OnParametersSetAsync();
    }

    // ===== 表單初始化 =====
    private void InitializeFormFields()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                // 基本資訊區段
                new()
                {
                    PropertyName = nameof(ReportPrintConfiguration.Code),
                    Label = "編號",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入編號",
                    IsRequired = true,
                    HelpText = "報表列印配置的唯一識別編號,新增時系統會自動產生,也可手動修改"
                },
                new()
                {
                    PropertyName = nameof(ReportPrintConfiguration.ReportId),
                    Label = "報表",
                    FieldType = FormFieldType.Select,
                    IsRequired = true,
                    Placeholder = "請選擇報表",
                    HelpText = "選擇要設定列印配置的報表",
                    Options = reportOptions,
                    IsReadOnly = true  // Seed 時已建立，不允許修改
                },
                new()
                {
                    PropertyName = nameof(ReportPrintConfiguration.ReportName),
                    Label = "報表名稱",
                    FieldType = FormFieldType.Text,
                    IsRequired = true,
                    IsReadOnly = true,
                    Placeholder = "選擇報表後自動填入",
                    HelpText = "報表的顯示名稱（由系統自動填入）"
                },
                // 列印設定區段
                new()
                {
                    PropertyName = nameof(ReportPrintConfiguration.PrinterConfigurationId),
                    Label = "印表機",
                    FieldType = FormFieldType.AutoComplete,
                    IsRequired = true,
                    Placeholder = "請輸入或選擇印表機設定",
                    MinSearchLength = 0,
                    HelpText = "輸入印表機名稱進行搜尋，或直接選擇"
                },
                new()
                {
                    PropertyName = nameof(ReportPrintConfiguration.PaperSettingId),
                    Label = "紙張",
                    FieldType = FormFieldType.AutoComplete,
                    IsRequired = true,
                    Placeholder = "請輸入或選擇紙張設定",
                    MinSearchLength = 0,
                    HelpText = "輸入紙張名稱進行搜尋，或直接選擇"
                },
                // 額外資料區段
                new()
                {
                    PropertyName = nameof(ReportPrintConfiguration.Remarks),
                    Label = "備註",
                    FieldType = FormFieldType.TextArea,
                    IsRequired = false,
                    Placeholder = "請輸入備註（可選）",
                    HelpText = "選填的備註說明",
                    Rows = 2,
                    ContainerCssClass = "col-12"
                }
            };

            // 狀態欄位（僅管理員可見）
            if (isCurrentUserSuperAdmin)
            {
                formFields.Add(new()
                {
                    PropertyName = nameof(ReportPrintConfiguration.Status),
                    Label = "狀態",
                    FieldType = FormFieldType.Select,
                    IsRequired = true,
                    Options = EntityStatusHelper.GetEntityStatusOptions(),
                    HelpText = "控制此報表列印配置是否啟用（僅管理員可修改）"
                });
            }

            var sectionBuilder = FormSectionHelper<ReportPrintConfiguration>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    rpc => rpc.Code,
                    rpc => rpc.ReportId,
                    rpc => rpc.ReportName);

            if (isCurrentUserSuperAdmin)
            {
                sectionBuilder = sectionBuilder.AddToSection("列印設定",
                    rpc => rpc.PrinterConfigurationId,
                    rpc => rpc.PaperSettingId,
                    rpc => rpc.Status);
            }
            else
            {
                sectionBuilder = sectionBuilder.AddToSection("列印設定",
                    rpc => rpc.PrinterConfigurationId,
                    rpc => rpc.PaperSettingId);
            }

            formSections = sectionBuilder
                .AddToSection(FormSectionNames.AdditionalData,
                    rpc => rpc.Remarks)
                .Build();
        }
        catch (Exception)
        {
            NotificationService.ShowErrorAsync("初始化表單欄位時發生錯誤");
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }

    // ===== 事件處理方法 =====
    // ===== 輔助方法 =====
    private string GenerateReportPrintConfigurationCode()
    {
        // 使用簡化的編號生成方法
        return CodeGenerationHelper.GenerateSimpleEntityCode("RPC", usePreciseTimestamp: true);
    }

    // ===== 公開方法 (供父組件調用) =====

    /// <summary>
    /// 開啟新增報表列印配置 Modal
    /// </summary>
    public async Task ShowAddModal()
    {
        ReportPrintConfigurationId = null;
        if (IsVisibleChanged.HasDelegate)
        {
            await IsVisibleChanged.InvokeAsync(true);
        }
    }

    /// <summary>
    /// 開啟編輯報表列印配置 Modal
    /// </summary>
    public async Task ShowEditModal(int reportPrintConfigurationId)
    {
        ReportPrintConfigurationId = reportPrintConfigurationId;
        if (IsVisibleChanged.HasDelegate)
        {
            await IsVisibleChanged.InvokeAsync(true);
        }
    }

    /// <summary>
    /// 取得目前的實體資料
    /// </summary>
    public ReportPrintConfiguration? GetCurrentEntity()
    {
        return editModalComponent?.Entity;
    }
}
