@page "/journal-entry-batch"
@attribute [Authorize]
@inject IJournalEntryAutoGenerationService AutoGenerationService
@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ICompanyModuleService CompanyModuleService
@inject INavigationPermissionService NavigationPermissionService
@inject IStringLocalizer<SharedResource> L
@rendermode InteractiveServer

<PageTitle>@L["Journal.BatchTransfer"]</PageTitle>

@if (!_isModuleEnabled)
{
    <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 60vh;">
        <i class="bi bi-lock-fill text-secondary" style="font-size: 4rem;"></i>
        <h4 class="mt-3 text-secondary">@L["Module.NotAvailable"]</h4>
        <p class="text-muted">@L["Module.DisabledMessage"]</p>
    </div>
}
else
{

<div class="container-fluid">
    @* 日期範圍篩選器 *@
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-auto">
                    <label class="form-label">@L["Label.DateFrom"]</label>
                    <input type="date" class="form-control" @bind="filterFrom" />
                </div>
                <div class="col-auto">
                    <label class="form-label">@L["Label.DateTo"]</label>
                    <input type="date" class="form-control" @bind="filterTo" />
                </div>
                <div class="col-auto">
                    <button class="btn btn-primary" @onclick="LoadAllAsync" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                        }
                        @L["Button.Query"]
                    </button>
                    <button class="btn btn-outline-secondary ms-2" @onclick="ClearFilter">@L["Button.ClearFilter"]</button>
                </div>
                <div class="col-auto ms-auto">
                    <button class="btn btn-success" @onclick="JournalizeAllAsync"
                            disabled="@(isProcessing || TotalPendingCount == 0)">
                        @if (isProcessing)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            <span>@L["Label.Processing"]</span>
                        }
                        else
                        {
                            <span>@string.Format(L["Journal.TransferAll"], TotalPendingCount)</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>

    @* 進貨入庫 Section *@
    <div class="card mb-3">
        <div class="card-header d-flex align-items-center" style="cursor:pointer" @onclick="@(() => showPurchaseReceiving = !showPurchaseReceiving)">
            <span class="me-2">@(showPurchaseReceiving ? "▼" : "▶")</span>
            <strong>@L["Journal.PurchaseReceiving"]</strong>
            <span class="badge bg-secondary ms-2">@string.Format(L["Journal.PendingCount"], purchaseReceivings.Count)</span>
        </div>
        @if (showPurchaseReceiving)
        {
            <div class="card-body p-0">
                @if (purchaseReceivings.Count == 0)
                {
                    <p class="text-muted p-3 mb-0">@L["Journal.NoPendingPurchaseReceiving"]</p>
                }
                else
                {
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>@L["Field.Code"]</th>
                                <th>@L["Journal.ReceiptDate"]</th>
                                <th>@L["Field.Supplier"]</th>
                                <th class="text-end">@L["Journal.PreTaxAmount"]</th>
                                <th class="text-end">@L["Journal.TaxAmount"]</th>
                                <th class="text-end">@L["Journal.TotalWithTax"]</th>
                                <th class="text-center">@L["Label.Actions"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var doc in purchaseReceivings)
                            {
                                <tr>
                                    <td><code>@doc.Code</code></td>
                                    <td>@doc.ReceiptDate.ToString("yyyy/MM/dd")</td>
                                    <td>@doc.Supplier?.CompanyName</td>
                                    <td class="text-end">@doc.TotalAmount.ToString("N2")</td>
                                    <td class="text-end">@doc.PurchaseReceivingTaxAmount.ToString("N2")</td>
                                    <td class="text-end">@doc.PurchaseReceivingTotalAmountIncludingTax.ToString("N2")</td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary"
                                                @onclick="@(() => JournalizeSingleAsync("PurchaseReceiving", doc.Id, doc.Code ?? ""))"
                                                disabled="@isProcessing">
                                            @L["Journal.Transfer"]
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        }
    </div>

    @* 進貨退回 Section *@
    <div class="card mb-3">
        <div class="card-header d-flex align-items-center" style="cursor:pointer" @onclick="@(() => showPurchaseReturn = !showPurchaseReturn)">
            <span class="me-2">@(showPurchaseReturn ? "▼" : "▶")</span>
            <strong>@L["Journal.PurchaseReturn"]</strong>
            <span class="badge bg-secondary ms-2">@string.Format(L["Journal.PendingCount"], purchaseReturns.Count)</span>
        </div>
        @if (showPurchaseReturn)
        {
            <div class="card-body p-0">
                @if (purchaseReturns.Count == 0)
                {
                    <p class="text-muted p-3 mb-0">@L["Journal.NoPendingPurchaseReturn"]</p>
                }
                else
                {
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>@L["Field.Code"]</th>
                                <th>@L["Journal.ReturnDate"]</th>
                                <th>@L["Field.Supplier"]</th>
                                <th class="text-end">@L["Journal.PreTaxAmount"]</th>
                                <th class="text-end">@L["Journal.TaxAmount"]</th>
                                <th class="text-end">@L["Journal.TotalWithTax"]</th>
                                <th class="text-center">@L["Label.Actions"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var doc in purchaseReturns)
                            {
                                <tr>
                                    <td><code>@doc.Code</code></td>
                                    <td>@doc.ReturnDate.ToString("yyyy/MM/dd")</td>
                                    <td>@doc.Supplier?.CompanyName</td>
                                    <td class="text-end">@doc.TotalReturnAmount.ToString("N2")</td>
                                    <td class="text-end">@doc.ReturnTaxAmount.ToString("N2")</td>
                                    <td class="text-end">@doc.TotalReturnAmountWithTax.ToString("N2")</td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary"
                                                @onclick="@(() => JournalizeSingleAsync("PurchaseReturn", doc.Id, doc.Code ?? ""))"
                                                disabled="@isProcessing">
                                            @L["Journal.Transfer"]
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        }
    </div>

    @* 銷貨出貨 Section *@
    <div class="card mb-3">
        <div class="card-header d-flex align-items-center" style="cursor:pointer" @onclick="@(() => showSalesDelivery = !showSalesDelivery)">
            <span class="me-2">@(showSalesDelivery ? "▼" : "▶")</span>
            <strong>@L["Journal.SalesDelivery"]</strong>
            <span class="badge bg-secondary ms-2">@string.Format(L["Journal.PendingCount"], salesDeliveries.Count)</span>
        </div>
        @if (showSalesDelivery)
        {
            <div class="card-body p-0">
                @if (salesDeliveries.Count == 0)
                {
                    <p class="text-muted p-3 mb-0">@L["Journal.NoPendingSalesDelivery"]</p>
                }
                else
                {
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>@L["Field.Code"]</th>
                                <th>@L["Journal.DeliveryDate"]</th>
                                <th>@L["Field.Customer"]</th>
                                <th class="text-end">@L["Journal.PreTaxAmount"]</th>
                                <th class="text-end">@L["Journal.TaxAmount"]</th>
                                <th class="text-end">@L["Journal.TotalWithTax"]</th>
                                <th class="text-center">@L["Label.Actions"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var doc in salesDeliveries)
                            {
                                <tr>
                                    <td><code>@doc.Code</code></td>
                                    <td>@doc.DeliveryDate.ToString("yyyy/MM/dd")</td>
                                    <td>@doc.Customer?.CompanyName</td>
                                    <td class="text-end">@doc.TotalAmount.ToString("N2")</td>
                                    <td class="text-end">@doc.TaxAmount.ToString("N2")</td>
                                    <td class="text-end">@doc.TotalAmountWithTax.ToString("N2")</td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary"
                                                @onclick="@(() => JournalizeSingleAsync("SalesDelivery", doc.Id, doc.Code ?? ""))"
                                                disabled="@isProcessing">
                                            @L["Journal.Transfer"]
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        }
    </div>

    @* 沖款單 Section *@
    <div class="card mb-3">
        <div class="card-header d-flex align-items-center" style="cursor:pointer" @onclick="@(() => showSetoffDocument = !showSetoffDocument)">
            <span class="me-2">@(showSetoffDocument ? "▼" : "▶")</span>
            <strong>@L["Journal.SetoffDocument"]</strong>
            <span class="badge bg-secondary ms-2">@string.Format(L["Journal.PendingCount"], setoffDocuments.Count)</span>
        </div>
        @if (showSetoffDocument)
        {
            <div class="card-body p-0">
                @if (setoffDocuments.Count == 0)
                {
                    <p class="text-muted p-3 mb-0">@L["Journal.NoPendingSetoff"]</p>
                }
                else
                {
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>@L["Field.Code"]</th>
                                <th>@L["Journal.SetoffDate"]</th>
                                <th>@L["Column.Type"]</th>
                                <th class="text-end">@L["Journal.WriteoffAmount"]</th>
                                <th class="text-end">@L["Journal.CollectionPayment"]</th>
                                <th class="text-end">@L["Journal.Allowance"]</th>
                                <th class="text-center">@L["Label.Actions"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var doc in setoffDocuments)
                            {
                                <tr>
                                    <td><code>@doc.Code</code></td>
                                    <td>@doc.SetoffDate.ToString("yyyy/MM/dd")</td>
                                    <td>
                                        @if (doc.IsAccountsReceivable)
                                        {
                                            <span class="badge bg-info text-dark">@L["Journal.AccountsReceivable"]</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark">@L["Journal.AccountsPayable"]</span>
                                        }
                                    </td>
                                    <td class="text-end">@doc.CurrentSetoffAmount.ToString("N2")</td>
                                    <td class="text-end">@doc.TotalCollectionAmount.ToString("N2")</td>
                                    <td class="text-end">@doc.TotalAllowanceAmount.ToString("N2")</td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary"
                                                @onclick="@(() => JournalizeSingleAsync("SetoffDocument", doc.Id, doc.Code ?? ""))"
                                                disabled="@isProcessing">
                                            @L["Journal.Transfer"]
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        }
    </div>

    @* 銷貨退回 Section *@
    <div class="card mb-3">
        <div class="card-header d-flex align-items-center" style="cursor:pointer" @onclick="@(() => showSalesReturn = !showSalesReturn)">
            <span class="me-2">@(showSalesReturn ? "▼" : "▶")</span>
            <strong>@L["Journal.SalesReturn"]</strong>
            <span class="badge bg-secondary ms-2">@string.Format(L["Journal.PendingCount"], salesReturns.Count)</span>
        </div>
        @if (showSalesReturn)
        {
            <div class="card-body p-0">
                @if (salesReturns.Count == 0)
                {
                    <p class="text-muted p-3 mb-0">@L["Journal.NoPendingSalesReturn"]</p>
                }
                else
                {
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>@L["Field.Code"]</th>
                                <th>@L["Journal.ReturnDate"]</th>
                                <th>@L["Field.Customer"]</th>
                                <th class="text-end">@L["Journal.PreTaxAmount"]</th>
                                <th class="text-end">@L["Journal.TaxAmount"]</th>
                                <th class="text-end">@L["Journal.TotalWithTax"]</th>
                                <th class="text-center">@L["Label.Actions"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var doc in salesReturns)
                            {
                                <tr>
                                    <td><code>@doc.Code</code></td>
                                    <td>@doc.ReturnDate.ToString("yyyy/MM/dd")</td>
                                    <td>@doc.Customer?.CompanyName</td>
                                    <td class="text-end">@doc.TotalReturnAmount.ToString("N2")</td>
                                    <td class="text-end">@doc.ReturnTaxAmount.ToString("N2")</td>
                                    <td class="text-end">@doc.TotalReturnAmountWithTax.ToString("N2")</td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary"
                                                @onclick="@(() => JournalizeSingleAsync("SalesReturn", doc.Id, doc.Code ?? ""))"
                                                disabled="@isProcessing">
                                            @L["Journal.Transfer"]
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        }
    </div>
</div>

} @* end else (module enabled) *@

@code {
    // 模組狀態
    private bool _isModuleEnabled = true;

    // 資料
    private List<PurchaseReceiving> purchaseReceivings = new();
    private List<PurchaseReturn> purchaseReturns = new();
    private List<SalesDelivery> salesDeliveries = new();
    private List<SalesReturn> salesReturns = new();
    private List<SetoffDocument> setoffDocuments = new();

    // 篩選條件
    private DateTime? filterFrom;
    private DateTime? filterTo;

    // UI 狀態
    private bool isLoading = false;
    private bool isProcessing = false;
    private bool showPurchaseReceiving = true;
    private bool showPurchaseReturn = true;
    private bool showSalesDelivery = true;
    private bool showSalesReturn = true;
    private bool showSetoffDocument = true;

    // 目前使用者
    private string currentUser = "System";

    private int TotalPendingCount =>
        purchaseReceivings.Count + purchaseReturns.Count + salesDeliveries.Count + salesReturns.Count + setoffDocuments.Count;

    protected override async Task OnInitializedAsync()
    {
        // 公司層級模組檢查（只有 IsSuperAdmin 可繞過）
        var isEnabled = await CompanyModuleService.IsModuleEnabledAsync("Accounting");
        if (!isEnabled)
        {
            _isModuleEnabled = await NavigationPermissionService.IsCurrentEmployeeSuperAdminAsync();
        }

        if (!_isModuleEnabled) return;

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUser = authState.User.Identity?.Name ?? "System";
        await LoadAllAsync();
    }

    private async Task LoadAllAsync()
    {
        isLoading = true;
        StateHasChanged();
        try
        {
            var t1 = AutoGenerationService.GetPendingPurchaseReceivingsAsync(filterFrom, filterTo);
            var t2 = AutoGenerationService.GetPendingPurchaseReturnsAsync(filterFrom, filterTo);
            var t3 = AutoGenerationService.GetPendingSalesDeliveriesAsync(filterFrom, filterTo);
            var t4 = AutoGenerationService.GetPendingSalesReturnsAsync(filterFrom, filterTo);
            var t5 = AutoGenerationService.GetPendingSetoffDocumentsAsync(filterFrom, filterTo);
            await Task.WhenAll(t1, t2, t3, t4, t5);
            purchaseReceivings = t1.Result;
            purchaseReturns    = t2.Result;
            salesDeliveries    = t3.Result;
            salesReturns       = t4.Result;
            setoffDocuments    = t5.Result;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ClearFilter()
    {
        filterFrom = null;
        filterTo = null;
        await LoadAllAsync();
    }

    private async Task JournalizeSingleAsync(string docType, int id, string code)
    {
        isProcessing = true;
        StateHasChanged();
        try
        {
            var (success, error) = docType switch
            {
                "PurchaseReceiving" => await AutoGenerationService.JournalizePurchaseReceivingAsync(id, currentUser),
                "PurchaseReturn"    => await AutoGenerationService.JournalizePurchaseReturnAsync(id, currentUser),
                "SalesDelivery"     => await AutoGenerationService.JournalizeSalesDeliveryAsync(id, currentUser),
                "SalesReturn"       => await AutoGenerationService.JournalizeSalesReturnAsync(id, currentUser),
                "SetoffDocument"    => await AutoGenerationService.JournalizeSetoffDocumentAsync(id, currentUser),
                _ => (false, L["Journal.UnknownDocType"].ToString())
            };

            if (success)
                await NotificationService.ShowSuccessAsync(string.Format(L["Journal.TransferSuccess"], code));
            else
                await NotificationService.ShowErrorAsync(string.Format(L["Journal.TransferFailed"], code, error));
        }
        finally
        {
            isProcessing = false;
        }
        await LoadAllAsync();
    }

    private async Task JournalizeAllAsync()
    {
        isProcessing = true;
        StateHasChanged();
        int successCount = 0;
        int failCount = 0;
        try
        {
            // 依序轉傳票（避免同時多筆 DB 操作衝突）
            foreach (var doc in purchaseReceivings.ToList())
            {
                var (ok, _) = await AutoGenerationService.JournalizePurchaseReceivingAsync(doc.Id, currentUser);
                if (ok) successCount++; else failCount++;
            }
            foreach (var doc in purchaseReturns.ToList())
            {
                var (ok, _) = await AutoGenerationService.JournalizePurchaseReturnAsync(doc.Id, currentUser);
                if (ok) successCount++; else failCount++;
            }
            foreach (var doc in salesDeliveries.ToList())
            {
                var (ok, _) = await AutoGenerationService.JournalizeSalesDeliveryAsync(doc.Id, currentUser);
                if (ok) successCount++; else failCount++;
            }
            foreach (var doc in salesReturns.ToList())
            {
                var (ok, _) = await AutoGenerationService.JournalizeSalesReturnAsync(doc.Id, currentUser);
                if (ok) successCount++; else failCount++;
            }
            foreach (var doc in setoffDocuments.ToList())
            {
                var (ok, _) = await AutoGenerationService.JournalizeSetoffDocumentAsync(doc.Id, currentUser);
                if (ok) successCount++; else failCount++;
            }

            if (failCount == 0)
                await NotificationService.ShowSuccessAsync(string.Format(L["Journal.BatchSuccess"], successCount));
            else
                await NotificationService.ShowWarningAsync(string.Format(L["Journal.BatchPartialSuccess"], successCount, failCount));
        }
        finally
        {
            isProcessing = false;
        }
        await LoadAllAsync();
    }
}
