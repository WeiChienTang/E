@page "/test/setoff-prepayment-render"
@using ERPCore2.Data.Enums
@using ERPCore2.Models
@using System.Text.Json

<div class="container-fluid mt-4">
    <h3>æ¸¬è©¦é æ”¶é ä»˜æ¬¾æ¬„ä½å³æ™‚æ¸²æŸ“</h3>
    <p class="text-muted">æ¸¬è©¦ç›®æ¨™ï¼šç•¶è¼¸å…¥ã€Œæœ¬æ¬¡é‡‘é¡ã€æ™‚ï¼Œã€ŒåŸå§‹é‡‘é¡ã€æ‡‰è©²ç«‹å³æ›´æ–°ï¼Œä¸éœ€è¦é»æ“Šå…¶ä»–æ¬„ä½</p>
    
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">æ¸¬è©¦èªªæ˜</h5>
        </div>
        <div class="card-body">
            <ol>
                <li>åœ¨ã€Œæœ¬æ¬¡é‡‘é¡ã€æ¬„ä½è¼¸å…¥æ•¸å­—ï¼ˆä¾‹å¦‚ï¼š600ï¼‰</li>
                <li>è§€å¯Ÿã€ŒåŸå§‹é‡‘é¡ã€æ¬„ä½æ˜¯å¦<strong>ç«‹å³</strong>é¡¯ç¤ºç›¸åŒçš„æ•¸å­—ï¼ˆ600ï¼‰</li>
                <li>å¦‚æœéœ€è¦é»æ“Šå…¶ä»–æ¬„ä½æ‰èƒ½çœ‹åˆ°æ­£ç¢ºæ•¸å­—ï¼Œè¡¨ç¤ºæ¸²æŸ“æœ‰å•é¡Œ</li>
                <li>æ¸¬è©¦è² æ•¸è¼¸å…¥ï¼ˆä¾‹å¦‚ï¼š-500 æˆ– (500)ï¼‰</li>
            </ol>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">æ¸¬è©¦è¡¨æ ¼</h5>
        </div>
        <div class="card-body">
            <table class="table table-bordered table-striped">
                <thead class="table-light">
                    <tr>
                        <th>é¡åˆ¥</th>
                        <th>ä¾†æºå–®è™Ÿ</th>
                        <th>æ¬¾é …æ—¥æœŸ</th>
                        <th class="text-end">åŸå§‹é‡‘é¡</th>
                        <th class="text-end">å·²ç”¨é‡‘é¡</th>
                        <th class="text-end">å¯ç”¨é‡‘é¡</th>
                        <th class="text-end">æœ¬æ¬¡é‡‘é¡</th>
                        <th>å‚™è¨»</th>
                        <th>æ¸²æŸ“æ¬¡æ•¸</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var (item, index) in TestItems.Select((item, index) => (item, index)))
                    {
                        <tr>
                            <td>
                                <select class="form-select form-select-sm" 
                                        value="@((int)item.PrepaymentType)"
                                        @onchange="@(e => HandleTypeChange(item, e.Value?.ToString()))">
                                    <option value="1">é æ”¶</option>
                                    <option value="2">é ä»˜</option>
                                </select>
                            </td>
                            <td>
                                <span>@item.Code</span>
                            </td>
                            <td>
                                <span>@item.PaymentDate.ToString("yyyy-MM-dd")</span>
                            </td>
                            <td class="text-end">
                                <span class="text-muted fw-bold" style="font-size: 1.1em; color: @(item.Amount > 0 ? "green" : "red") !important;">
                                    @item.Amount.ToString("N2")
                                    <small class="text-primary">(R:@RenderCount[index])</small>
                                </span>
                            </td>
                            <td class="text-end">
                                <span class="text-muted">@item.UsedAmount.ToString("N2")</span>
                            </td>
                            <td class="text-end">
                                <span class="text-primary fw-bold">@item.AvailableAmount.ToString("N2")</span>
                            </td>
                            <td class="text-end">
                                <input type="text"
                                       class="form-control form-control-sm text-end"
                                       value="@(item.ThisTimeAddAmount > 0 ? item.ThisTimeAddAmount.ToString("N0") : "")"
                                       @oninput="@(e => HandleAmountInput(item, index, e.Value?.ToString()))"
                                       placeholder="è¼¸å…¥é‡‘é¡" />
                            </td>
                            <td>
                                <input type="text"
                                       class="form-control form-control-sm"
                                       value="@item.Remarks"
                                       @oninput="@(e => HandleRemarkInput(item, e.Value?.ToString()))"
                                       placeholder="å‚™è¨»" />
                            </td>
                            <td class="text-center">
                                <span class="badge bg-info">@RenderCount[index]</span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            
            <div class="alert alert-info mt-3">
                <h6>æ¸¬è©¦çµæœèªªæ˜ï¼š</h6>
                <ul class="mb-0">
                    <li><strong>æ¸²æŸ“æ¬¡æ•¸ï¼š</strong>æ¯æ¬¡è©²è¡Œé‡æ–°æ¸²æŸ“æ™‚æœƒå¢åŠ è¨ˆæ•¸</li>
                    <li><strong>åŸå§‹é‡‘é¡é¡è‰²ï¼š</strong>ç¶ è‰²è¡¨ç¤ºæœ‰å€¼ï¼Œç´…è‰²è¡¨ç¤ºè² å€¼</li>
                    <li><strong>R:Xï¼š</strong>é¡¯ç¤ºè©²æ¬„ä½çš„æ¸²æŸ“æ¬¡æ•¸ï¼Œç”¨æ–¼é©—è­‰æ˜¯å¦å¯¦æ™‚æ›´æ–°</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">æ¸¬è©¦æ•¸æ“šç‹€æ…‹</h5>
        </div>
        <div class="card-body">
            <pre class="bg-light p-3">@GetTestDataJson()</pre>
        </div>
    </div>
</div>

@code {
    private List<PrepaymentDto> TestItems { get; set; } = new();
    private Dictionary<int, int> RenderCount { get; set; } = new();
    private int globalRenderCount = 0;

    protected override void OnInitialized()
    {
        // åˆå§‹åŒ–æ¸¬è©¦æ•¸æ“š
        TestItems = new List<PrepaymentDto>
        {
            new PrepaymentDto
            {
                Id = 1,
                PrepaymentType = PrepaymentType.Prepayment,
                Code = "TEST-001",
                PaymentDate = DateTime.Today,
                Amount = 0,
                UsedAmount = 0,
                ThisTimeAddAmount = 0,
                Remarks = ""
            },
            new PrepaymentDto
            {
                Id = 2,
                PrepaymentType = PrepaymentType.Prepaid,
                Code = "TEST-002",
                PaymentDate = DateTime.Today.AddDays(-1),
                Amount = 0,
                UsedAmount = 0,
                ThisTimeAddAmount = 0,
                Remarks = ""
            }
        };

        // åˆå§‹åŒ–æ¸²æŸ“è¨ˆæ•¸
        for (int i = 0; i < TestItems.Count; i++)
        {
            RenderCount[i] = 0;
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (!firstRender)
        {
            // æ¯æ¬¡æ¸²æŸ“å¾Œå¢åŠ è¨ˆæ•¸
            for (int i = 0; i < TestItems.Count; i++)
            {
                RenderCount[i]++;
            }
            globalRenderCount++;
        }
    }

    private void HandleAmountInput(PrepaymentDto item, int index, string? value)
    {
        Console.WriteLine($"[HandleAmountInput] Index: {index}, Input: {value}");
        
        if (decimal.TryParse(value, out decimal amount))
        {
            item.ThisTimeAddAmount = amount;
            
            // ğŸ”¥ é—œéµï¼šæ›´æ–°åŸå§‹é‡‘é¡
            item.Amount = amount;
            
            Console.WriteLine($"[HandleAmountInput] Updated - ThisTimeAddAmount: {item.ThisTimeAddAmount}, Amount: {item.Amount}");
        }
        else
        {
            item.ThisTimeAddAmount = 0;
            item.Amount = 0;
        }

        // ğŸ”¥ æ¸¬è©¦1ï¼šä¸èª¿ç”¨ StateHasChanged()
        // é æœŸï¼šåŸå§‹é‡‘é¡ä¸æœƒæ›´æ–°
        
        // ğŸ”¥ æ¸¬è©¦2ï¼šèª¿ç”¨ StateHasChanged()
        // é æœŸï¼šåŸå§‹é‡‘é¡æœƒç«‹å³æ›´æ–°
        StateHasChanged();
        
        Console.WriteLine($"[HandleAmountInput] StateHasChanged called. Current Amount: {item.Amount}");
    }

    private void HandleRemarkInput(PrepaymentDto item, string? value)
    {
        item.Remarks = value ?? "";
        StateHasChanged();
    }

    private void HandleTypeChange(PrepaymentDto item, string? value)
    {
        if (int.TryParse(value, out int typeValue))
        {
            item.PrepaymentType = (PrepaymentType)typeValue;
            StateHasChanged();
        }
    }

    private string GetTestDataJson()
    {
        return JsonSerializer.Serialize(
            TestItems.Select(item => new
            {
                item.Code,
                item.Amount,
                item.UsedAmount,
                item.AvailableAmount,
                item.ThisTimeAddAmount,
                item.Remarks
            }),
            new JsonSerializerOptions { WriteIndented = true }
        );
    }
}
