@page "/demo/tables/generic"
@using ERPCore2.Components.Shared.Tables
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web

<PageTitle>GenericTableComponent 示範</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-table me-2"></i>
                    GenericTableComponent 示範
                </h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="/">首頁</a></li>
                        <li class="breadcrumb-item"><a href="/demo">組件示範</a></li>
                        <li class="breadcrumb-item active">表格組件</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <!-- 基本表格示範 -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table me-2"></i>
                        基本表格功能
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">展示基本的資料顯示、格式化和操作功能</p>
                    
                    <ERPCore2.Components.Shared.Tables.GenericTableComponent TItem="EmployeeDemo"
                        Items="@currentEmployeePageItems"
                        ColumnDefinitions="@employeeColumns"
                        ShowActions="true"
                        EnableRowClick="true"
                        EnableSorting="true"
                        EnablePagination="true"
                        CurrentPage="@currentEmployeePage"
                        PageSize="@employeePageSize"
                        TotalItems="@employees.Count"
                        OnPageChanged="@HandleEmployeePageChanged"
                        OnPageSizeChanged="@HandleEmployeePageSizeChanged"
                        OnRowClick="@HandleEmployeeClick"
                        OnSort="@HandleSort"
                        IsStriped="true"
                        IsHoverable="true">
                        <ActionsTemplate Context="employee">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary" 
                                        @onclick="() => EditEmployee(employee)">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-outline-info"
                                        @onclick="() => ViewEmployee(employee)">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger"
                                        @onclick="() => DeleteEmployee(employee)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </ActionsTemplate>
                    </ERPCore2.Components.Shared.Tables.GenericTableComponent>
                </div>
            </div>
        </div>
    </div>

    <!-- 產品表格示範 -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-box me-2"></i>
                        產品管理表格
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">展示貨幣格式化、狀態徽章和自定義範本</p>                    <ERPCore2.Components.Shared.Tables.GenericTableComponent TItem="ProductDemo"
                        Items="@currentProductPageItems"
                        ColumnDefinitions="@productColumns"
                        ShowActions="true"
                        EnablePagination="true"
                        CurrentPage="@currentProductPage"
                        PageSize="@productPageSize"
                        TotalItems="@products.Count"
                        OnPageChanged="@HandleProductPageChanged"
                        OnPageSizeChanged="@HandleProductPageSizeChanged"
                        Size="TableSize.Small"
                        IsBordered="true">
                        <ActionsTemplate Context="product">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                        type="button" data-bs-toggle="dropdown">
                                    操作
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" @onclick="() => EditProduct(product)">
                                        <i class="fas fa-edit me-1"></i>編輯
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" @onclick="() => CopyProduct(product)">
                                        <i class="fas fa-copy me-1"></i>複製
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" @onclick="() => DeleteProduct(product)">
                                        <i class="fas fa-trash me-1"></i>刪除
                                    </a></li>
                                </ul>
                            </div>
                        </ActionsTemplate>
                    </ERPCore2.Components.Shared.Tables.GenericTableComponent>
                </div>
            </div>
        </div>
    </div>

    <!-- 空資料表格示範 -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-inbox me-2"></i>
                        空資料狀態
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">展示沒有資料時的顯示效果</p>
                    
                    <ERPCore2.Components.Shared.Tables.GenericTableComponent TItem="EmployeeDemo"
                        Items="@emptyList"
                        ColumnDefinitions="@employeeColumns"
                        EmptyMessage="目前沒有員工資料">
                        <EmptyTemplate>
                            <div class="text-center py-5">
                                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">沒有找到員工資料</h5>
                                <p class="text-muted">請先新增員工資料或檢查篩選條件</p>
                                <button class="btn btn-primary">
                                    <i class="fas fa-plus me-1"></i>新增員工
                                </button>
                            </div>
                        </EmptyTemplate>
                    </ERPCore2.Components.Shared.Tables.GenericTableComponent>
                </div>
            </div>
        </div>
    </div>

    <!-- 操作日誌 -->
    @if (actionLogs.Any())
    {
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-history me-2"></i>
                            操作日誌
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <ul class="mb-0">
                                @foreach (var log in actionLogs.TakeLast(5))
                                {
                                    <li>@log</li>
                                }
                            </ul>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" @onclick="ClearLogs">
                            清除日誌
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- 分頁功能示範 -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>
                        分頁功能示範
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">展示內建分頁功能，支援頁面導航和每頁筆數調整</p>
                    
                    <!-- 分頁控制說明 -->
                    <div class="alert alert-info mb-3">
                        <h6><i class="fas fa-info-circle me-1"></i> 分頁功能說明：</h6>
                        <ul class="mb-0">
                            <li><strong>自動分頁：</strong>當資料超過每頁設定筆數時自動顯示分頁控制</li>
                            <li><strong>頁面導航：</strong>支援第一頁、上一頁、頁碼選擇、下一頁、最後一頁</li>
                            <li><strong>筆數調整：</strong>可動態調整每頁顯示筆數</li>
                            <li><strong>資料統計：</strong>顯示目前頁面資料範圍和總筆數</li>
                        </ul>
                    </div>

                    <!-- 分頁設定 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6>員工表格分頁設定</h6>
                                    <p class="mb-2">目前第 <strong>@currentEmployeePage</strong> 頁，每頁 <strong>@employeePageSize</strong> 筆</p>
                                    <p class="mb-0 text-muted">總共 @employees.Count 筆資料，共 @((int)Math.Ceiling((double)employees.Count / employeePageSize)) 頁</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6>產品表格分頁設定</h6>
                                    <p class="mb-2">目前第 <strong>@currentProductPage</strong> 頁，每頁 <strong>@productPageSize</strong> 筆</p>
                                    <p class="mb-0 text-muted">總共 @products.Count 筆資料，共 @((int)Math.Ceiling((double)products.Count / productPageSize)) 頁</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 員工分頁表格 -->
                    <h6 class="mt-4">員工資料表 (分頁示範)</h6>
                    <ERPCore2.Components.Shared.Tables.GenericTableComponent TItem="EmployeeDemo"
                        Items="@currentEmployeePageItems"
                        ColumnDefinitions="@employeeColumns"
                        ShowActions="true"
                        EnablePagination="true"
                        CurrentPage="@currentEmployeePage"
                        PageSize="@employeePageSize"
                        TotalItems="@employees.Count"
                        ShowPageSizeSelector="true"
                        PageSizeOptions="@(new List<int> { 2, 3, 5, 10 })"
                        MaxDisplayedPages="3"
                        OnPageChanged="@HandleEmployeePageChanged"
                        OnPageSizeChanged="@HandleEmployeePageSizeChanged"
                        OnRowClick="@HandleEmployeeClick"
                        IsStriped="true"
                        IsHoverable="true">
                        <ActionsTemplate Context="employee">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" 
                                        @onclick="() => EditEmployee(employee)"
                                        title="編輯">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm"
                                        @onclick="() => ViewEmployee(employee)"
                                        title="檢視">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </ActionsTemplate>
                    </ERPCore2.Components.Shared.Tables.GenericTableComponent>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // 示範資料模型
    public class EmployeeDemo
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Department { get; set; } = string.Empty;
        public decimal Salary { get; set; }
        public DateTime HireDate { get; set; }
        public bool IsActive { get; set; }
        public string Status { get; set; } = string.Empty;
    }

    public class ProductDemo
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Category { get; set; } = string.Empty;
        public decimal Price { get; set; }
        public int Stock { get; set; }
        public DateTime CreatedDate { get; set; }
        public string Status { get; set; } = string.Empty;
        public bool IsDiscounted { get; set; }
    }

    // 資料集合
    private List<EmployeeDemo> employees = new();
    private List<ProductDemo> products = new();
    private List<EmployeeDemo> emptyList = new();
    private List<string> actionLogs = new();

    // 分頁相關變數
    private int currentEmployeePage = 1;
    private int employeePageSize = 3; // 設定較小的頁面大小以便展示分頁效果
    private int currentProductPage = 1;
    private int productPageSize = 2; // 設定較小的頁面大小以便展示分頁效果

    // 當前頁面的資料
    private List<EmployeeDemo> currentEmployeePageItems => employees
        .Skip((currentEmployeePage - 1) * employeePageSize)
        .Take(employeePageSize)
        .ToList();

    private List<ProductDemo> currentProductPageItems => products
        .Skip((currentProductPage - 1) * productPageSize)
        .Take(productPageSize)
        .ToList();    // 欄位定義
    private List<TableColumnDefinition> employeeColumns = new();
    private List<TableColumnDefinition> productColumns = new();

    protected override void OnInitialized()
    {
        InitializeData();
        SetupColumns();
    }

    private void InitializeData()
    {
        // 初始化員工資料 - 擴展更多資料以展示分頁效果
        employees = new List<EmployeeDemo>
        {
            new() { Id = 1, Name = "張小明", Email = "ming@company.com", Department = "資訊部", 
                   Salary = 65000, HireDate = new DateTime(2022, 3, 15), IsActive = true, Status = "在職" },
            new() { Id = 2, Name = "李美華", Email = "meihua@company.com", Department = "行銷部", 
                   Salary = 58000, HireDate = new DateTime(2021, 8, 20), IsActive = true, Status = "在職" },
            new() { Id = 3, Name = "王大偉", Email = "david@company.com", Department = "業務部", 
                   Salary = 72000, HireDate = new DateTime(2020, 11, 5), IsActive = false, Status = "留職停薪" },
            new() { Id = 4, Name = "陳淑芬", Email = "sufen@company.com", Department = "人事部", 
                   Salary = 60000, HireDate = new DateTime(2023, 1, 10), IsActive = true, Status = "在職" },
            new() { Id = 5, Name = "林志豪", Email = "zhihao@company.com", Department = "財務部", 
                   Salary = 68000, HireDate = new DateTime(2022, 7, 25), IsActive = true, Status = "在職" },
            new() { Id = 6, Name = "黃雅婷", Email = "yating@company.com", Department = "資訊部", 
                   Salary = 62000, HireDate = new DateTime(2023, 4, 1), IsActive = true, Status = "在職" },
            new() { Id = 7, Name = "劉建國", Email = "jianguo@company.com", Department = "業務部", 
                   Salary = 70000, HireDate = new DateTime(2021, 12, 15), IsActive = true, Status = "在職" },
            new() { Id = 8, Name = "吳佩珊", Email = "peishan@company.com", Department = "行銷部", 
                   Salary = 55000, HireDate = new DateTime(2023, 6, 10), IsActive = true, Status = "在職" },
            new() { Id = 9, Name = "蔡明宏", Email = "minghong@company.com", Department = "財務部", 
                   Salary = 66000, HireDate = new DateTime(2022, 9, 20), IsActive = false, Status = "留職停薪" },
            new() { Id = 10, Name = "鄭雅雯", Email = "yawen@company.com", Department = "人事部", 
                   Salary = 59000, HireDate = new DateTime(2023, 2, 28), IsActive = true, Status = "在職" }
        };

        // 初始化產品資料 - 擴展更多資料
        products = new List<ProductDemo>
        {
            new() { Id = 1, Name = "筆記型電腦", Category = "電腦設備", Price = 35000, Stock = 15, 
                   CreatedDate = new DateTime(2024, 1, 1), Status = "上架", IsDiscounted = false },
            new() { Id = 2, Name = "無線滑鼠", Category = "週邊設備", Price = 890, Stock = 50, 
                   CreatedDate = new DateTime(2024, 2, 15), Status = "上架", IsDiscounted = true },
            new() { Id = 3, Name = "機械鍵盤", Category = "週邊設備", Price = 2500, Stock = 0, 
                   CreatedDate = new DateTime(2024, 3, 1), Status = "缺貨", IsDiscounted = false },
            new() { Id = 4, Name = "顯示器", Category = "電腦設備", Price = 8900, Stock = 8, 
                   CreatedDate = new DateTime(2024, 2, 20), Status = "上架", IsDiscounted = true },
            new() { Id = 5, Name = "印表機", Category = "辦公設備", Price = 4500, Stock = 3, 
                   CreatedDate = new DateTime(2024, 1, 10), Status = "下架", IsDiscounted = false },
            new() { Id = 6, Name = "平板電腦", Category = "電腦設備", Price = 18000, Stock = 12, 
                   CreatedDate = new DateTime(2024, 3, 15), Status = "上架", IsDiscounted = false },
            new() { Id = 7, Name = "藍牙耳機", Category = "週邊設備", Price = 1200, Stock = 25, 
                   CreatedDate = new DateTime(2024, 4, 1), Status = "上架", IsDiscounted = true },
            new() { Id = 8, Name = "網路攝影機", Category = "週邊設備", Price = 800, Stock = 18, 
                   CreatedDate = new DateTime(2024, 3, 20), Status = "上架", IsDiscounted = false }
        };
    }

    private void SetupColumns()
    {
        // 員工表格欄位定義
        employeeColumns = new List<TableColumnDefinition>
        {
            TableColumnDefinition.Text("編號", "Id", "text-center"),
            new TableColumnDefinition 
            { 
                Title = "姓名", 
                PropertyName = "Name", 
                IconClass = "fas fa-user",
                IsSortable = true
            },
            TableColumnDefinition.Text("電子郵件", "Email"),
            new TableColumnDefinition 
            { 
                Title = "部門", 
                PropertyName = "Department",
                IconClass = "fas fa-building",
                IsSortable = true
            },
            TableColumnDefinition.Currency("薪資", "Salary", "NT$", "N0", "text-end"),
            TableColumnDefinition.Date("到職日期", "HireDate", "yyyy/MM/dd"),
            TableColumnDefinition.Boolean("狀態", "IsActive", "啟用", "停用"),
            TableColumnDefinition.Status("工作狀態", "Status", new Dictionary<object, string>
            {
                { "在職", "bg-success" },
                { "留職停薪", "bg-warning" },
                { "離職", "bg-danger" }
            })
        };

        // 產品表格欄位定義
        productColumns = new List<TableColumnDefinition>
        {
            TableColumnDefinition.Text("產品編號", "Id", "text-center"),
            new TableColumnDefinition 
            { 
                Title = "產品名稱", 
                PropertyName = "Name",
                IconClass = "fas fa-box"
            },
            TableColumnDefinition.Text("分類", "Category"),
            TableColumnDefinition.Currency("價格", "Price", "NT$", "N0", "text-end"),            new TableColumnDefinition
            {
                Title = "庫存",
                PropertyName = "Stock",
                CellCssClass = "text-center",
                CustomTemplate = item => 
                {
                    if (item is ProductDemo product)
                    {
                        var badgeClass = product.Stock > 10 ? "bg-success" : 
                                       product.Stock > 0 ? "bg-warning" : "bg-danger";
                        return @<span class="badge @badgeClass">@product.Stock</span>;
                    }
                    return @<span>-</span>;
                }
            },
            TableColumnDefinition.Date("建立日期", "CreatedDate"),
            TableColumnDefinition.Status("狀態", "Status", new Dictionary<object, string>
            {
                { "上架", "bg-success" },
                { "下架", "bg-secondary" },
                { "缺貨", "bg-danger" }
            }),            new TableColumnDefinition
            {
                Title = "折扣",
                PropertyName = "IsDiscounted",
                CellCssClass = "text-center",
                CustomTemplate = item => 
                {
                    if (item is ProductDemo product)
                    {
                        return @<span>
                            @if (product.IsDiscounted)
                            {
                                <i class="fas fa-tag text-danger" title="有折扣"></i>
                            }
                            else
                            {
                                <i class="fas fa-minus text-muted" title="無折扣"></i>
                            }
                        </span>;
                    }
                    return @<span>-</span>;
                }
            }
        };
    }

    // 事件處理
    private void HandleEmployeeClick(EmployeeDemo employee)
    {
        actionLogs.Add($"[{DateTime.Now:HH:mm:ss}] 點擊員工: {employee.Name}");
        StateHasChanged();
    }

    private void HandleSort(string propertyName)
    {
        actionLogs.Add($"[{DateTime.Now:HH:mm:ss}] 排序欄位: {propertyName}");
        StateHasChanged();
    }

    private void EditEmployee(EmployeeDemo employee)
    {
        actionLogs.Add($"[{DateTime.Now:HH:mm:ss}] 編輯員工: {employee.Name}");
        StateHasChanged();
    }

    private void ViewEmployee(EmployeeDemo employee)
    {
        actionLogs.Add($"[{DateTime.Now:HH:mm:ss}] 查看員工: {employee.Name}");
        StateHasChanged();
    }

    private void DeleteEmployee(EmployeeDemo employee)
    {
        actionLogs.Add($"[{DateTime.Now:HH:mm:ss}] 刪除員工: {employee.Name}");
        StateHasChanged();
    }

    private void EditProduct(ProductDemo product)
    {
        actionLogs.Add($"[{DateTime.Now:HH:mm:ss}] 編輯產品: {product.Name}");
        StateHasChanged();
    }

    private void CopyProduct(ProductDemo product)
    {
        actionLogs.Add($"[{DateTime.Now:HH:mm:ss}] 複製產品: {product.Name}");
        StateHasChanged();
    }

    private void DeleteProduct(ProductDemo product)
    {
        actionLogs.Add($"[{DateTime.Now:HH:mm:ss}] 刪除產品: {product.Name}");
        StateHasChanged();
    }

    private void ClearLogs()
    {
        actionLogs.Clear();
        StateHasChanged();
    }

    // 分頁事件處理
    private async Task HandleEmployeePageChanged(int newPage)
    {
        currentEmployeePage = newPage;
        actionLogs.Add($"[{DateTime.Now:HH:mm:ss}] 員工表格切換到第 {newPage} 頁");
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task HandleEmployeePageSizeChanged(int newPageSize)
    {
        employeePageSize = newPageSize;
        currentEmployeePage = 1; // 重置到第一頁
        actionLogs.Add($"[{DateTime.Now:HH:mm:ss}] 員工表格每頁顯示筆數改為 {newPageSize} 筆");
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task HandleProductPageChanged(int newPage)
    {
        currentProductPage = newPage;
        actionLogs.Add($"[{DateTime.Now:HH:mm:ss}] 產品表格切換到第 {newPage} 頁");
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task HandleProductPageSizeChanged(int newPageSize)
    {
        productPageSize = newPageSize;
        currentProductPage = 1; // 重置到第一頁
        actionLogs.Add($"[{DateTime.Now:HH:mm:ss}] 產品表格每頁顯示筆數改為 {newPageSize} 筆");
        StateHasChanged();
        await Task.CompletedTask;
    }
}
