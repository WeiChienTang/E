@* 排程項目表格 - 右側顯示已選擇的排程項目 *@
@using ERPCore2.Components.Shared.UI.Button
@using ERPCore2.Helpers.InteractiveTableComponentHelper
@using ERPCore2.Models
@using ERPCore2.Helpers
@using ERPCore2.Models.Enums
@inject IStringLocalizer<SharedResource> L

<div class="card h-100">
    <div class="card-header bg-warning text-white py-2">
        <div class="d-flex justify-content-between align-items-center">
            <span class="fw-bold"><i class="bi bi-calendar-check me-2"></i>@L["Production.ScheduleItems"]</span>
        </div>
    </div>
    
    <div class="card-body p-2">
        @* 篩選區域 *@
        <div class="mb-2">
            <SearchInputComponent @bind-Value="searchKeyword"
                                  Placeholder="@L["Placeholder.SearchCodeNameStatus"]"
                                  ButtonSize="btn-sm" />
        </div>
        
        <div style="max-height: 350px; overflow: auto;">
            <InteractiveTableComponent TItem="ScheduleItemDto"
                                       Items="@FilteredItemsList"
                                       ColumnDefinitions="@GetColumnDefinitions()"
                                       ShowHeader="true"
                                       ShowBuiltInActions="true"
                                       ShowBuiltInDeleteButton="@(!IsReadOnly)"
                                       OnItemDelete="@HandleItemDelete"
                                       IsDeleteDisabled="@(item => !item.CanDelete)"
                                       IsStriped="true"
                                       IsHoverable="true"
                                       IsBordered="true"
                                       GetRowCssClass="@GetRowCssClass"
                                       EmptyMessage="@L["Message.DragOrderToSchedule"]"
                                       ActionsColumnWidth="60px"
                                       ActionsHeader="@L["Label.Actions"]"
                                       EnableDrag="@(!IsReadOnly)"
                                       EnableDrop="true"
                                       DragDropGroup="production-schedule"
                                       TableId="item-table"
                                       OnItemDropped="HandleItemDropped"
                                       OnRowReordered="HandleRowReordered"
                                       CssClass="mb-0 table-sm">
                <DropZoneEmptyTemplate>
                    <div class="text-center py-4">
                        <i class="bi bi-box-arrow-in-down fa-2x mb-2 text-primary"></i>
                        <br />
                        <span class="text-primary fw-bold">@L["Label.DropToSchedule"]</span>
                    </div>
                </DropZoneEmptyTemplate>
            </InteractiveTableComponent>
        </div>
    </div>
</div>

@code {
    // ===== 參數 =====
    
    /// <summary>
    /// 排程項目列表
    /// </summary>
    [Parameter] public List<ScheduleItemDto> Items { get; set; } = new();
    
    /// <summary>
    /// 是否唯讀模式
    /// </summary>
    [Parameter] public bool IsReadOnly { get; set; }
    
    /// <summary>
    /// 當項目被移除時觸發
    /// </summary>
    [Parameter] public EventCallback<ScheduleItemDto> OnItemRemoved { get; set; }
    
    /// <summary>
    /// 當數量變更時觸發
    /// </summary>
    [Parameter] public EventCallback<(ScheduleItemDto Item, decimal NewQuantity)> OnQuantityChanged { get; set; }
    
    /// <summary>
    /// 當有項目被拖放到此表格時觸發（接收明細）
    /// </summary>
    [Parameter] public EventCallback<PendingScheduleDetailDto> OnDetailDropped { get; set; }
    
    /// <summary>
    /// 當排程項目順序變更時觸發
    /// </summary>
    [Parameter] public EventCallback<(int OldIndex, int NewIndex)> OnOrderChanged { get; set; }
    
    /// <summary>
    /// 當結案狀態變更時觸發
    /// </summary>
    [Parameter] public EventCallback<(ScheduleItemDto Item, bool IsClosed)> OnIsClosedChanged { get; set; }
    
    // ===== 內部狀態 =====
    private string searchKeyword = string.Empty;
    
    /// <summary>
    /// 篩選後的項目列表
    /// </summary>
    private List<ScheduleItemDto> FilteredItemsList
    {
        get
        {
            var result = Items.AsEnumerable();
            
            // 關鍵字搜尋（編號、產品名、狀態）
            if (!string.IsNullOrWhiteSpace(searchKeyword))
            {
                var keyword = searchKeyword.Trim().ToLower();
                result = result.Where(d => 
                    d.ProductCode.ToLower().Contains(keyword) ||
                    d.ProductName.ToLower().Contains(keyword) ||
                    GetStatusText(d).ToLower().Contains(keyword));
            }
            
            return result.ToList();
        }
    }
    
    /// <summary>
    /// 取得狀態的文字表示（用於搜尋）
    /// </summary>
    private string GetStatusText(ScheduleItemDto item)
    {
        // 判斷是否為「已停產」：已結案 且 已完成 < 排程量
        var isDiscontinued = item.IsClosed && item.CompletedQuantity < item.ScheduleQuantity;

        if (isDiscontinued)
            return L["Label.Discontinued"].ToString();

        return item.Status switch
        {
            ProductionItemStatus.InProgress => L["Label.InProgress"].ToString(),
            ProductionItemStatus.Completed => L["Label.Completed"].ToString(),
            ProductionItemStatus.Discontinued => L["Label.Discontinued"].ToString(),
            _ => L["Label.InProgress"].ToString()
        };
    }
    
    // ===== 表格欄位定義 =====
    
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = L["Column.ProductCode"],
                PropertyName = nameof(ScheduleItemDto.ProductCode),
                ColumnType = InteractiveColumnType.Display,
                Width = "14%",
                CellCssClass = "text-primary fw-bold span"
            },
            new()
            {
                Title = L["Column.ProductName"],
                PropertyName = nameof(ScheduleItemDto.ProductName),
                ColumnType = InteractiveColumnType.Custom,
                Width = "18%",
                CustomTemplate = item =>
                {
                    var scheduleItem = (ScheduleItemDto)item;
                    return @<span class="text-truncate d-block" style="max-width: 120px;" title="@scheduleItem.ProductName">@scheduleItem.ProductName</span>;
                }
            },
            new()
            {
                Title = L["Column.OrderQty"],
                PropertyName = nameof(ScheduleItemDto.OrderQuantity),
                ColumnType = InteractiveColumnType.Custom,
                Width = "50px",
                TextAlign = "right",
                CustomTemplate = item =>
                {
                    var scheduleItem = (ScheduleItemDto)item;
                    return @<span class="text-muted">@NumberFormatHelper.FormatSmart(scheduleItem.OrderQuantity)</span>;
                }
            },
            new()
            {
                Title = L["Column.ScheduleQty"],
                PropertyName = nameof(ScheduleItemDto.ScheduleQuantity),
                ColumnType = InteractiveColumnType.Custom,
                Width = "50px",
                TextAlign = "right",
                CustomTemplate = item =>
                {
                    var scheduleItem = (ScheduleItemDto)item;
                    return GetQuantityCell(scheduleItem);
                }
            },
            new()
            {
                Title = L["Column.CompletedQty"],
                PropertyName = nameof(ScheduleItemDto.CompletedQuantity),
                ColumnType = InteractiveColumnType.Custom,
                Width = "50px",
                TextAlign = "right",
                CustomTemplate = item =>
                {
                    var scheduleItem = (ScheduleItemDto)item;
                    if (scheduleItem.CompletedQuantity > 0)
                    {
                        return @<span class="text-success fw-bold">@NumberFormatHelper.FormatSmart(scheduleItem.CompletedQuantity)</span>;
                    }
                    return @<span class="text-muted">0</span>;
                }
            },
            new()
            {
                Title = L["Column.Closing"],
                PropertyName = nameof(ScheduleItemDto.IsClosed),
                ColumnType = InteractiveColumnType.Custom,
                Width = "30px",
                TextAlign = "center",
                CustomTemplate = item =>
                {
                    var scheduleItem = (ScheduleItemDto)item;
                    return GetIsClosedCell(scheduleItem);
                }
            },
            new()
            {
                Title = L["Column.Status"],
                PropertyName = nameof(ScheduleItemDto.Status),
                ColumnType = InteractiveColumnType.Custom,
                Width = "10%",
                TextAlign = "center",
                CustomTemplate = item =>
                {
                    var scheduleItem = (ScheduleItemDto)item;
                    return GetStatusBadge(scheduleItem);
                }
            }
        };
    }
    
    // ===== 事件處理 =====
    
    private async Task HandleItemDelete(ScheduleItemDto item)
    {
        if (OnItemRemoved.HasDelegate)
        {
            await OnItemRemoved.InvokeAsync(item);
        }
    }
    
    // ===== 輔助方法 =====
    
    private string GetRowCssClass(ScheduleItemDto item, int index)
    {
        // 不使用特殊背景色
        return "";
    }
    
    /// <summary>
    /// 取得數量欄位的渲染內容
    /// </summary>
    private RenderFragment GetQuantityCell(ScheduleItemDto item) => __builder =>
    {
        if (IsReadOnly || !item.CanDelete)
        {
            <span class="fw-bold">@NumberFormatHelper.FormatSmart(item.ScheduleQuantity)</span>
        }
        else
        {
            // 排程數量不能大於訂單量
            var maxQuantity = item.OrderQuantity;
            <input type="number" 
                   class="form-control form-control-sm text-end" 
                   style="width: 100%;"
                   value="@NumberFormatHelper.FormatForInput(item.ScheduleQuantity)"
                   min="0.001"
                   max="@maxQuantity"
                   step="0.001"
                   @onchange="e => HandleQuantityInputChange(item, e)" />
        }
    };
    
    private async Task HandleQuantityInputChange(ScheduleItemDto item, ChangeEventArgs e)
    {
        if (decimal.TryParse(e.Value?.ToString(), out var newQuantity))
        {
            // 排程數量不能大於訂單量
            var maxQuantity = item.OrderQuantity;
            if (newQuantity > 0 && newQuantity <= maxQuantity)
            {
                if (OnQuantityChanged.HasDelegate)
                {
                    await OnQuantityChanged.InvokeAsync((item, newQuantity));
                }
            }
        }
    }
    
    /// <summary>
    /// 取得結案欄位的渲染內容
    /// </summary>
    private RenderFragment GetIsClosedCell(ScheduleItemDto item) => __builder =>
    {
        if (IsReadOnly)
        {
            // 唯讀模式：顯示圖示
            if (item.IsClosed)
            {
                <i class="bi bi-check-circle-fill text-secondary" title="@L["Label.Closed"]"></i>
            }
            else
            {
                <i class="bi bi-circle text-muted" title="@L["Label.NotClosed"]"></i>
            }
        }
        else
        {
            // 編輯模式：顯示 checkbox
            <input type="checkbox" 
                   class="form-check-input"
                   checked="@item.IsClosed"
                   @onchange="e => HandleIsClosedChange(item, e)"
                   title="@(item.IsClosed ? L["Label.NotClosed"].ToString() : L["Label.Closed"].ToString())" />
        }
    };
    
    /// <summary>
    /// 處理結案狀態變更
    /// </summary>
    private async Task HandleIsClosedChange(ScheduleItemDto item, ChangeEventArgs e)
    {
        var newValue = (bool)(e.Value ?? false);
        item.IsClosed = newValue;
        
        // 通知父元件結案狀態已變更
        if (OnIsClosedChanged.HasDelegate)
        {
            await OnIsClosedChanged.InvokeAsync((item, newValue));
        }
        
        StateHasChanged();
    }
    
    private RenderFragment GetStatusBadge(ScheduleItemDto item) => __builder =>
    {
        // 判斷是否為「已停產」：已結案 且 已完成 < 排程量
        var isDiscontinued = item.IsClosed && item.CompletedQuantity < item.ScheduleQuantity;
        
        var (cssClass, text) = isDiscontinued
            ? ("bg-secondary", L["Label.Discontinued"].ToString())
            : item.Status switch
            {
                ProductionItemStatus.InProgress => ("bg-warning text-dark", L["Label.InProgress"].ToString()),
                ProductionItemStatus.Completed => ("bg-success", L["Label.Completed"].ToString()),
                ProductionItemStatus.Discontinued => ("bg-secondary", L["Label.Discontinued"].ToString()),
                _ => ("bg-warning text-dark", L["Label.InProgress"].ToString())
            };
        
        <span class="badge @cssClass">@text</span>
    };
    
    // ===== 公開方法 =====
    
    /// <summary>
    /// 刷新表格顯示
    /// </summary>
    public void Refresh()
    {
        StateHasChanged();
    }
    
    /// <summary>
    /// 清除搜尋
    /// </summary>
    private void ClearSearch()
    {
        searchKeyword = string.Empty;
        StateHasChanged();
    }
    
    /// <summary>
    /// 清除篩選條件
    /// </summary>
    public void ClearFilters()
    {
        searchKeyword = string.Empty;
        StateHasChanged();
    }
    
    // ===== 拖放事件處理 =====
    
    /// <summary>
    /// 處理項目被拖放到此表格（接收明細 Detail）
    /// </summary>
    private async Task HandleItemDropped(DragDropEventArgs<ScheduleItemDto> args)
    {
        // 嘗試取得拖放的明細
        var droppedDetail = args.DroppedItem as PendingScheduleDetailDto;
        
        if (droppedDetail != null && OnDetailDropped.HasDelegate)
        {
            await OnDetailDropped.InvokeAsync(droppedDetail);
        }
    }
    
    /// <summary>
    /// 處理同表格內的拖曳排序
    /// </summary>
    private async Task HandleRowReordered((int oldIndex, int newIndex) args)
    {
        // 如果位置相同則不處理
        if (args.oldIndex == args.newIndex) return;
        
        // 執行本地列表的重新排序
        if (Items != null && args.oldIndex >= 0 && args.oldIndex < Items.Count 
            && args.newIndex >= 0 && args.newIndex < Items.Count)
        {
            var item = Items[args.oldIndex];
            Items.RemoveAt(args.oldIndex);
            Items.Insert(args.newIndex, item);
            
            // 通知父組件順序已變更
            if (OnOrderChanged.HasDelegate)
            {
                await OnOrderChanged.InvokeAsync((args.oldIndex, args.newIndex));
            }
            
            StateHasChanged();
        }
    }
}
