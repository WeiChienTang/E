@* 商品廠商管理組件 - 管理商品的多個廠商資訊 - 使用 InteractiveTableComponent 統一UI *@

@inject INotificationService NotificationService
@inject IStringLocalizer<SharedResource> L
@typeparam TProductSupplierEntity where TProductSupplierEntity : BaseEntity, new()
@typeparam TProductEntity where TProductEntity : BaseEntity
@typeparam TSupplierEntity where TSupplierEntity : BaseEntity

<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <InteractiveTableComponent TItem="TProductSupplierEntity" 
                                  Items="@Items"
                                  ColumnDefinitions="@GetColumnDefinitions()"
                                  IsReadOnly="@IsReadOnly"
                                  ShowRowNumbers="false"
                                  EmptyMessage="@EmptyMessage"
                                  ShowBuiltInActions="true"
                                  ShowBuiltInDeleteButton="true"
                                  OnItemDelete="@HandleItemDelete"
                                  EnableAutoEmptyRow="true"
                                  AllowAddNewRow="@(!IsReadOnly)"
                                  DataLoadCompleted="@_dataLoadCompleted"
                                  CreateEmptyItem="@CreateEmptyItem" />
    </div>
</div>

@code {
    // ===== 私有欄位 =====
    private bool _dataLoadCompleted = true;  // 資料載入完成標記
    
    // ===== 基本參數 =====
    [Parameter] public List<TProductSupplierEntity> Items { get; set; } = new();
    [Parameter] public List<TSupplierEntity> Options { get; set; } = new(); // 廠商選項
    [Parameter] public List<Unit> UnitOptions { get; set; } = new(); // 單位選項
    [Parameter] public int ParentEntityId { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== 顯示設定 =====
    [Parameter] public string Title { get; set; } = "廠商資訊";
    [Parameter] public string Subtitle { get; set; } = "";
    [Parameter] public string Icon { get; set; } = "building";
    [Parameter] public string ItemDisplayName { get; set; } = "廠商";
    [Parameter] public string EmptyIcon { get; set; } = "building-x";
    [Parameter] public string EmptyMessage { get; set; } = "尚未新增廠商";
    
    // ===== 委派參數 - Getter =====
    [Parameter] public Func<TProductSupplierEntity, int?> GetSupplierId { get; set; } = item => null;
    [Parameter] public Func<TProductSupplierEntity, string?> GetSupplierProductCode { get; set; } = item => null;
    [Parameter] public Func<TProductSupplierEntity, decimal?> GetSupplierPrice { get; set; } = item => null;
    [Parameter] public Func<TProductSupplierEntity, int?> GetLeadTime { get; set; } = item => null;
    [Parameter] public Func<TProductSupplierEntity, int?> GetMinOrderQuantity { get; set; } = item => null;
    [Parameter] public Func<TProductSupplierEntity, int?> GetUnitId { get; set; } = item => null;
    [Parameter] public Func<TSupplierEntity, int> GetOptionId { get; set; } = option => option.Id;
    [Parameter] public Func<TSupplierEntity, string> GetOptionDisplayText { get; set; } = option => 
    {
        // 檢查是否有 CompanyName 屬性並取得其值
        var companyNameProperty = option.GetType().GetProperty("CompanyName");
        if (companyNameProperty != null)
        {
            var companyName = companyNameProperty.GetValue(option) as string;
            return companyName ?? option.ToString() ?? "";
        }
        return option.ToString() ?? "";
    };
    [Parameter] public Func<Unit, int> GetUnitOptionId { get; set; } = unit => unit.Id;
    [Parameter] public Func<Unit, string> GetUnitOptionDisplayText { get; set; } = unit => unit.Name;
    
    // ===== 委派參數 - Setter =====
    [Parameter] public Action<TProductSupplierEntity, int?> SetSupplierId { get; set; } = (item, supplierId) => { };
    [Parameter] public Action<TProductSupplierEntity, string?> SetSupplierProductCode { get; set; } = (item, value) => { };
    [Parameter] public Action<TProductSupplierEntity, decimal?> SetSupplierPrice { get; set; } = (item, value) => { };
    [Parameter] public Action<TProductSupplierEntity, int?> SetLeadTime { get; set; } = (item, value) => { };
    [Parameter] public Action<TProductSupplierEntity, int?> SetMinOrderQuantity { get; set; } = (item, value) => { };
    [Parameter] public Action<TProductSupplierEntity, int?> SetUnitId { get; set; } = (item, value) => { };
    [Parameter] public Action<TProductSupplierEntity, int> SetParentId { get; set; } = (item, parentId) => { };
    
    // ===== 事件參數 =====
    [Parameter] public EventCallback<List<TProductSupplierEntity>> ItemsChanged { get; set; }
    [Parameter] public EventCallback<TProductSupplierEntity> ItemAdded { get; set; }
    [Parameter] public EventCallback<TProductSupplierEntity> ItemRemoved { get; set; }
    [Parameter] public EventCallback<TProductSupplierEntity> PrimaryChanged { get; set; }
    
    protected override void OnParametersSet()
    {
        base.OnParametersSet();
    }

    // ===== 建立空項目方法 =====
    
    /// <summary>
    /// 創建空的商品廠商項目
    /// </summary>
    private TProductSupplierEntity CreateEmptyItem()
    {
        var newItem = new TProductSupplierEntity();
        SetParentId(newItem, ParentEntityId);
        return newItem;
    }

    // ===== InteractiveTableComponent 方法 =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            // 廠商選擇欄位
            new()
            {
                Title = L["Column.Supplier"],
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "25%",
                Tooltip = "選擇供應此商品的廠商",
                CustomTemplate = item => 
                {
                    var productSupplier = (TProductSupplierEntity)item;
                    var supplierId = GetSupplierId(productSupplier);
                    var selectedValue = supplierId?.ToString() ?? "";
                    
                    return @<select class="form-select" 
                                    value="@selectedValue"
                                    disabled="@IsReadOnly"
                                    title="選擇供應此商品的廠商"
                                    @onchange="@(async (e) => await OnSupplierChanged((productSupplier, e.Value)))">
                        <option value="">@L["Placeholder.SelectSupplier"]</option>
                        @foreach (var option in Options)
                        {
                            <option value="@GetOptionId(option)">@GetOptionDisplayText(option)</option>
                        }
                    </select>;
                }
            },
            
            // 廠商商品編號 - 文字輸入
            new()
            {
                Title = L["Column.SupplierItemCode"],
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "20%",
                Tooltip = "輸入廠商對此商品的商品編號或料號",
                CustomTemplate = item => 
                {
                    var productSupplier = (TProductSupplierEntity)item;
                    var value = GetSupplierProductCode(productSupplier) ?? "";
                    
                    return @<input type="text" 
                                   class="form-control" 
                                   value="@value"
                                   placeholder="@L["Placeholder.EnterCode"]"
                                   title="輸入廠商對此商品的商品編號或料號"
                                   disabled="@IsReadOnly"
                                   @oninput="@(async (e) => await OnSupplierProductCodeChanged((productSupplier, e.Value?.ToString())))" />;
                }
            },
            
            // 報價 - 數字輸入
            new()
            {
                Title = L["Column.Price"],
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "15%",
                Tooltip = "輸入廠商對此商品的報價金額",
                CustomTemplate = item => 
                {
                    var productSupplier = (TProductSupplierEntity)item;
                    var value = GetSupplierPrice(productSupplier)?.ToString("F0") ?? "";
                    
                    return @<input type="number" 
                                   class="form-control" 
                                   value="@value"
                                   min="0"
                                   step="1"
                                   title="輸入廠商對此商品的報價金額"
                                   disabled="@IsReadOnly"
                                   @oninput="@(async (e) => await OnSupplierPriceChanged((productSupplier, e.Value?.ToString())))" />;
                }
            },
            
            // 交期 - 數字輸入
            new()
            {
                Title = L["Column.LeadTimeDays"],
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "15%",
                Tooltip = "輸入廠商的交貨時間（以天為單位）",
                CustomTemplate = item => 
                {
                    var productSupplier = (TProductSupplierEntity)item;
                    var value = GetLeadTime(productSupplier)?.ToString() ?? "";
                    
                    return @<input type="number" 
                                   class="form-control" 
                                   value="@value"
                                   min="0"
                                   title="輸入廠商的交貨時間（以天為單位）"
                                   disabled="@IsReadOnly"
                                   @oninput="@(async (e) => await OnLeadTimeChanged((productSupplier, e.Value?.ToString())))" />;
                }
            },
            
            // 最小訂購量 - 數字輸入
            new()
            {
                Title = L["Column.MinOrderQty"],
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "15%",
                Tooltip = "輸入廠商要求的最小訂購數量",
                CustomTemplate = item => 
                {
                    var productSupplier = (TProductSupplierEntity)item;
                    var value = GetMinOrderQuantity(productSupplier)?.ToString() ?? "";
                    
                    return @<input type="number" 
                                   class="form-control" 
                                   value="@value"
                                   min="0"
                                   title="輸入廠商要求的最小訂購數量"
                                   disabled="@IsReadOnly"
                                   @oninput="@(async (e) => await OnMinOrderQuantityChanged((productSupplier, e.Value?.ToString())))" />;
                }
            },
            
            // 單位選擇欄位
            new()
            {
                Title = L["Column.Unit"],
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "15%",
                Tooltip = "選擇廠商供應此商品的計量單位",
                CustomTemplate = item => 
                {
                    var productSupplier = (TProductSupplierEntity)item;
                    var unitId = GetUnitId(productSupplier);
                    var selectedValue = unitId?.ToString() ?? "";
                    
                    return @<select class="form-select" 
                                    value="@selectedValue"
                                    disabled="@IsReadOnly"
                                    title="選擇廠商供應此商品的計量單位"
                                    @onchange="@(async (e) => await OnUnitChanged((productSupplier, e.Value)))">
                        <option value="">@L["Placeholder.SelectUnit"]</option>
                        @foreach (var unit in UnitOptions)
                        {
                            <option value="@GetUnitOptionId(unit)">@GetUnitOptionDisplayText(unit)</option>
                        }
                    </select>;
                }
            }
        };
    }

    private async Task HandleItemDelete(TProductSupplierEntity item)
    {
        var index = Items.IndexOf(item);
        await RemoveItemAsync(index);
    }

    private Task OnValidationFailed((TProductSupplierEntity item, string propertyName, string? errorMessage) args)
    {
        // 不再需要此方法，因為驗證已移至自訂模板中
        return Task.CompletedTask;
    }

    private Task HandleRowClick(TProductSupplierEntity item)
    {
        // 不再需要此方法，因為直接在表格上編輯
        return Task.CompletedTask;
    }
    
    // ===== 內部方法 =====

    private string GetSupplierDisplayText(TProductSupplierEntity item)
    {
        var supplierId = GetSupplierId(item);
        if (supplierId.HasValue)
        {
            var supplier = Options.FirstOrDefault(o => GetOptionId(o) == supplierId.Value);
            if (supplier != null)
            {
                return GetOptionDisplayText(supplier);
            }
        }
        return "未知廠商";
    }

    private string GetUnitDisplayText(TProductSupplierEntity item)
    {
        var unitId = GetUnitId(item);
        if (unitId.HasValue)
        {
            var unit = UnitOptions.FirstOrDefault(u => GetUnitOptionId(u) == unitId.Value);
            if (unit != null)
            {
                return GetUnitOptionDisplayText(unit);
            }
        }
        return "-";
    }

    // ===== InteractiveTableComponent 事件處理 =====
    private async Task OnSupplierChanged((object item, object? value) args)
    {
        var productSupplier = (TProductSupplierEntity)args.item;
    
        if (args.value != null && !string.IsNullOrEmpty(args.value.ToString()) && int.TryParse(args.value.ToString(), out var supplierId) && supplierId > 0)
        {
            // 檢查是否已存在相同廠商
            var existingSupplierIds = Items.Where(i => i != productSupplier).Select(item => GetSupplierId(item)).Where(id => id.HasValue && id.Value > 0);
            if (existingSupplierIds.Any(id => id!.Value == supplierId))
            {
                await NotificationService.ShowErrorAsync(L["Message.SupplierAlreadyExists"]);
                SetSupplierId(productSupplier, null);
            }
            else
            {
                SetSupplierId(productSupplier, supplierId);
                await ItemsChanged.InvokeAsync(Items);
            }
        }
        else
        {
            SetSupplierId(productSupplier, null);
            await ItemsChanged.InvokeAsync(Items);
        }
        StateHasChanged();
    }

    private async Task OnSupplierProductCodeChanged((object item, string? value) args)
    {
        var productSupplier = (TProductSupplierEntity)args.item;
        
        SetSupplierProductCode(productSupplier, args.value);
        
        await ItemsChanged.InvokeAsync(Items);
        StateHasChanged();
    }

    private async Task OnSupplierPriceChanged((object item, string? value) args)
    {
        var productSupplier = (TProductSupplierEntity)args.item;
        
        if (string.IsNullOrEmpty(args.value))
        {
            SetSupplierPrice(productSupplier, null);
        }
        else
        {
            var price = InputEventHelper.HandleIntegerInput(args.value);
            SetSupplierPrice(productSupplier, (decimal)price);
        }
        
        await DetailSyncHelper.SyncToParentAsync(Items, ItemsChanged);
        StateHasChanged();
    }

    private async Task OnLeadTimeChanged((object item, string? value) args)
    {
        var productSupplier = (TProductSupplierEntity)args.item;
        var leadTime = string.IsNullOrEmpty(args.value) ? (int?)null : InputEventHelper.HandleIntegerInput(args.value);
        SetLeadTime(productSupplier, leadTime);
        
        await DetailSyncHelper.SyncToParentAsync(Items, ItemsChanged);
        StateHasChanged();
    }

    private async Task OnMinOrderQuantityChanged((object item, string? value) args)
    {
        var productSupplier = (TProductSupplierEntity)args.item;
        var minOrderQty = string.IsNullOrEmpty(args.value) ? (int?)null : InputEventHelper.HandleIntegerInput(args.value);
        SetMinOrderQuantity(productSupplier, minOrderQty);
        
        await DetailSyncHelper.SyncToParentAsync(Items, ItemsChanged);
        StateHasChanged();
    }

    private async Task OnUnitChanged((object item, object? value) args)
    {
        var productSupplier = (TProductSupplierEntity)args.item;
        
        if (args.value != null && !string.IsNullOrEmpty(args.value.ToString()) && int.TryParse(args.value.ToString(), out var unitId))
        {
            SetUnitId(productSupplier, unitId);
        }
        else
        {
            SetUnitId(productSupplier, null);
        }
        
        await DetailSyncHelper.SyncToParentAsync(Items, ItemsChanged);
        StateHasChanged();
    }
    
    public async Task RemoveItemAsync(int index)
    {
        if (IsReadOnly || index < 0 || index >= Items.Count) return;
        
        var removedItem = Items[index];
        
        Items.Remove(removedItem);
        
        await ItemRemoved.InvokeAsync(removedItem);
        await ItemsChanged.InvokeAsync(Items);
        StateHasChanged();
    }
    
    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        // 取得非空的項目
        var nonEmptyItems = Items.Where(item => {
            var supplierId = GetSupplierId(item);
            return supplierId.HasValue && supplierId.Value > 0;
        }).ToList();
        
        if (!nonEmptyItems.Any())
        {
            errors.Add(L["Message.NeedAtLeastOneSupplier"]);
        }
        else
        {
            // 檢查重複廠商
            var supplierIds = nonEmptyItems.Select(item => GetSupplierId(item)).Where(id => id.HasValue).ToList();
            if (supplierIds.Count != supplierIds.Distinct().Count())
            {
                errors.Add(L["Message.DuplicateSupplier"]);
            }
        }
          
        if (errors.Any())
        {
            var errorMessage = string.Join("\n", errors);
            await NotificationService.ShowErrorAsync(errorMessage);
            return false;
        }
        
        return true;
    }
}
