@* 商品會計資訊 Tab — 顯示存貨子科目，並可立即建立 *@
@inject ISubAccountService SubAccountService
@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthStateProvider
@inject IStringLocalizer<SharedResource> L

@if (_productId <= 0)
{
    <div class="text-muted py-3 px-2">
        <i class="bi bi-info-circle me-2"></i>@L["Accounting.SaveFirst"]
    </div>
}
else if (_isLoading)
{
    <div class="text-muted py-3 px-2">
        <i class="bi bi-hourglass-split me-2"></i>@L["Label.Loading"]
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-sm table-hover mb-3">
            <thead class="table-light">
                <tr>
                    <th style="width:160px">@L["Accounting.SubAccountType"]</th>
                    <th style="width:140px">@L["Accounting.AccountCode"]</th>
                    <th>@L["Accounting.AccountName"]</th>
                    <th style="width:90px">@L["Column.Status"]</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>@L["Accounting.Inventory"]</td>
                    <td class="font-monospace small">@(_subAccount?.Code ?? "—")</td>
                    <td class="small">@(_subAccount?.Name ?? "—")</td>
                    <td>
                        @if (_subAccount != null)
                        {
                            <span class="text-success small"><i class="bi bi-check-circle me-1"></i>@L["Accounting.Created"]</span>
                        }
                        else
                        {
                            <span class="text-warning small"><i class="bi bi-exclamation-circle me-1"></i>@L["Accounting.NotCreated"]</span>
                        }
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    @if (_subAccount == null)
    {
        <GenericButtonComponent Variant="ButtonVariant.DarkBlue"
                               Text="@L["Accounting.CreateSubAccount"]"
                               OnClick="HandleCreateAsync"
                               IsLoading="@_isCreating"
                               IsDisabled="@_isCreating"
                               Title="@L["Accounting.CreateProductSubAccountTitle"]" />
    }
}

@code {
    private int _productId;
    private bool _isLoading;
    private bool _isCreating;
    private AccountItem? _subAccount;

    public async Task LoadAsync(int productId)
    {
        _productId = productId;
        await RefreshAsync();
        StateHasChanged();
    }

    public void Clear()
    {
        _productId = 0;
        _subAccount = null;
        StateHasChanged();
    }

    private async Task RefreshAsync()
    {
        if (_productId <= 0) return;

        _isLoading = true;
        StateHasChanged();

        _subAccount = await SubAccountService.GetSubAccountForProductAsync(_productId);

        _isLoading = false;
    }

    private async Task HandleCreateAsync()
    {
        try
        {
            _isCreating = true;
            StateHasChanged();

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var createdBy = authState.User.Identity?.Name ?? "system";

            await SubAccountService.GetOrCreateProductSubAccountAsync(_productId, createdBy);
            await RefreshAsync();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync(L["Accounting.CreateError"]);
        }
        finally
        {
            _isCreating = false;
            StateHasChanged();
        }
    }
}
