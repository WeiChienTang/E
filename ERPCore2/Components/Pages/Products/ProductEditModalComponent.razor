@* å¯é‡ç”¨çš„å•†å“ç·¨è¼¯çµ„ä»¶ - å¯åœ¨ä»»ä½•é é¢ä¸­åµŒå…¥ *@
@using ERPCore2.Helpers
@using ERPCore2.Models
@using ERPCore2.Services.Reports.Interfaces
@using ERPCore2.Models.Reports
@inject IProductService ProductService
@inject ISizeService SizeService
@inject IProductCategoryService ProductCategoryService
@inject IUnitService UnitService
@inject ISupplierService SupplierService
@inject IInventoryStockService InventoryStockService
@inject ISystemParameterService SystemParameterService
@inject IProductCompositionService ProductCompositionService
@inject INotificationService NotificationService
@inject IProductListReportService ProductListReportService
@inject ActionButtonHelper ActionButtonHelper
@inject RelatedDocumentsHelper RelatedDocumentsHelper

<GenericEditModalComponent TEntity="Product" 
                          TService="IProductService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@ProductId"
                          Service="@ProductService"
                          EntityName="å•†å“"
                          EntityNamePlural="å•†å“"
                          ModalTitle="@(ProductId.HasValue ? "ç·¨è¼¯å•†å“" : "æ–°å¢å•†å“")"
                          Size="GenericEditModalComponent<Product, IProductService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@(autoCompleteConfig?.Prefillers)"
                          AutoCompleteCollections="@(autoCompleteConfig?.Collections)"
                          AutoCompleteDisplayProperties="@(autoCompleteConfig?.DisplayProperties)"
                          AutoCompleteValueProperties="@(autoCompleteConfig?.ValueProperties)"
                          ModalManagers="@modalManagers?.AsDictionary()"
                          DataLoader="@LoadProductData"
                          UseGenericSave="true"
                          SaveSuccessMessage="@(ProductId.HasValue ? "ç·¨è¼¯å•†å“æˆåŠŸ" : "æ–°å¢å•†å“æˆåŠŸ")"
                          SaveFailureMessage="å•†å“å„²å­˜å¤±æ•—"
                          RequiredPermission="Product.Read"
                          OnEntitySaved="@OnProductSaved"
                          OnCancel="@OnCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          OnEntityLoaded="@HandleEntityLoaded"
                          ShowPrintButton="true"
                          PrintButtonText="åˆ—å°"
                          ReportService="@ProductListReportService"
                          ReportId="@ReportIds.ProductList"
                          ReportPreviewTitle="å•†å“è³‡æ–™é è¦½"
                          GetReportDocumentName="@(e => $"å•†å“-{e.Code}")"
                          CustomActionButtons="@CustomActionButtons" />

@* å•†å“åˆ†é¡ç·¨è¼¯ Modal *@
<ProductCategoryEditModalComponent @ref="productCategoryEditModal"
                                  IsVisible="@productCategoryModalManager.IsModalVisible"
                                  IsVisibleChanged="@productCategoryModalManager.HandleModalVisibilityChangedAsync"
                                  ProductCategoryId="@productCategoryModalManager.SelectedEntityId"
                                  PrefilledValues="@productCategoryModalManager.PrefilledValues"
                                  OnProductCategorySaved="@productCategoryModalManager.OnSavedAsync"
                                  OnCancel="@productCategoryModalManager.HandleModalCancelAsync" />

@* å–®ä½ç·¨è¼¯ Modal *@
<UnitEditModalComponent @ref="unitEditModal"
                       IsVisible="@unitModalManager.IsModalVisible"
                       IsVisibleChanged="@unitModalManager.HandleModalVisibilityChangedAsync"
                       UnitId="@unitModalManager.SelectedEntityId"
                       PrefilledValues="@unitModalManager.PrefilledValues"
                       OnUnitSaved="@unitModalManager.OnSavedAsync"
                       OnCancel="@unitModalManager.HandleModalCancelAsync" />

@* å°ºå¯¸ç·¨è¼¯ Modal *@
<SizeEditModalComponent @ref="sizeEditModal"
                       IsVisible="@sizeModalManager.IsModalVisible"
                       IsVisibleChanged="@sizeModalManager.HandleModalVisibilityChangedAsync"
                       SizeId="@sizeModalManager.SelectedEntityId"
                       PrefilledValues="@sizeModalManager.PrefilledValues"
                       OnSizeSaved="@sizeModalManager.OnSavedAsync"
                       OnCancel="@sizeModalManager.HandleModalCancelAsync" />

@* å•†å“ç‰©æ–™æ¸…å–®ç·¨è¼¯ Modal *@
<ProductCompositionEditModalComponent @ref="productCompositionEditModal"
                                     IsVisible="@productCompositionModalManager.IsModalVisible"
                                     IsVisibleChanged="@productCompositionModalManager.HandleModalVisibilityChangedAsync"
                                     CompositionId="@productCompositionModalManager.SelectedEntityId"
                                     PrefilledValues="@productCompositionModalManager.PrefilledValues"
                                     OnCompositionSaved="@OnProductCompositionSavedWrapper"
                                     OnCancel="@productCompositionModalManager.HandleModalCancelAsync" />

<!-- ç›¸é—œå–®æ“šæŸ¥çœ‹ Modalï¼ˆç‰©æ–™æ¸…å–®æ¸…å–®ï¼‰-->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick"
                               OnAddNew="@HandleAddNewComposition" />

@code {
    // ===== å¿…è¦åƒæ•¸ =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? ProductId { get; set; }
    [Parameter] public EventCallback<Product> OnProductSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== å…§éƒ¨ç‹€æ…‹ =====
    private GenericEditModalComponent<Product, IProductService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // æ¨™èªŒè®Šæ•¸ï¼Œç”¨æ–¼è¿½è¹¤æ˜¯å¦éœ€è¦åœ¨å¯¦é«”è¼‰å…¥å¾Œåˆ·æ–°æ¬„ä½
    private bool _entityLoadedButFieldsNotRefreshed = false;
    private bool _hasCheckedEntityLoad = false;
    
    // ActionButtons å¿«å–æ©Ÿåˆ¶å·²ç§»é™¤ï¼Œæ”¹ç”± GenericEditModalComponent.UpdateAllActionButtons() çµ±ä¸€ç®¡ç†
    
    // åŸå§‹è³‡æ–™é›†åˆï¼ˆç”¨æ–¼ AutoCompleteï¼‰
    private List<ProductCategory> availableProductCategories = new();
    private List<Supplier> availableSuppliers = new();
    private List<Unit> availableUnits = new();
    private List<Size> availableSizes = new();
    
    // AutoComplete é…ç½®
    private AutoCompleteConfig? autoCompleteConfig;
    
    // Modal ç®¡ç†å™¨
    private ProductCategoryEditModalComponent? productCategoryEditModal;
    private RelatedEntityModalManager<ProductCategory> productCategoryModalManager = default!;
    
    private UnitEditModalComponent? unitEditModal;
    private RelatedEntityModalManager<Unit> unitModalManager = default!;
    
    private SizeEditModalComponent? sizeEditModal;
    private RelatedEntityModalManager<Size> sizeModalManager = default!;
    
    private ProductCompositionEditModalComponent? productCompositionEditModal;
    private RelatedEntityModalManager<ProductComposition> productCompositionModalManager = default!;
    
    private ModalManagerCollection modalManagers = default!;
    
    // é¸é …æ¸…å–®ï¼ˆå‘ä¸‹ç›¸å®¹ï¼‰
    private List<SelectOption> productCategoryOptions = new();
    private List<SelectOption> supplierOptions = new();
    private List<SelectOption> unitOptions = new();
    private List<SelectOption> sizeOptions = new();
    
    // è³‡æ–™è¼‰å…¥ç‹€æ…‹æ¨™è¨˜
    private bool isDataLoaded = false;
    
    // ===== ç›¸é—œå–®æ“šæŸ¥çœ‹ï¼ˆç‰©æ–™æ¸…å–®æ¸…å–®ï¼‰=====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;

    // ===== å¿…è¦æ–¹æ³• =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // ä½¿ç”¨ ModalManagerInitHelper åˆå§‹åŒ– Modal ç®¡ç†å™¨
            modalManagers = ModalManagerInitHelper.CreateBuilder<Product, IProductService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<ProductCategory>(nameof(Product.ProductCategoryId), "å•†å“é¡åˆ¥")
                .AddManager<Unit>(nameof(Product.UnitId), "å–®ä½")
                .AddManager<Size>(nameof(Product.SizeId), "å°ºå¯¸")
                .Build();
            productCategoryModalManager = modalManagers.Get<ProductCategory>(nameof(Product.ProductCategoryId));
            unitModalManager = modalManagers.Get<Unit>(nameof(Product.UnitId));
            sizeModalManager = modalManagers.Get<Size>(nameof(Product.SizeId));
            
            // åˆå§‹åŒ–å•†å“ç‰©æ–™æ¸…å–® Modal ç®¡ç†å™¨ï¼ˆç¨ç«‹åˆå§‹åŒ–ï¼‰
            productCompositionModalManager = new RelatedEntityModalManager<ProductComposition>
            {
                NotificationService = NotificationService,
                EntityDisplayName = "å•†å“ç‰©æ–™æ¸…å–®",
                StateHasChangedCallback = StateHasChanged
            };
            
            // ç§»é™¤è‡ªå‹•è¼‰å…¥è³‡æ–™ï¼Œæ”¹ç‚ºåœ¨ OnParametersSetAsync ä¸­æ ¹æ“š IsVisible è¼‰å…¥
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–å•†å“ç·¨è¼¯çµ„ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            // é‡ç½®æ¨™èªŒï¼Œç¢ºä¿æ¯æ¬¡æ‰“é–‹Modalæ™‚éƒ½æœƒæª¢æŸ¥
            _entityLoadedButFieldsNotRefreshed = false;
            _hasCheckedEntityLoad = false;
            
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
        }
    }
    
    /// <summary>
    /// è™•ç†å¯¦é«”è¼‰å…¥å®Œæˆäº‹ä»¶ï¼ˆç”± GenericEditModalComponent çš„å°èˆªè§¸ç™¼ï¼‰
    /// ç•¶ä¸Šä¸‹ç­†åˆ‡æ›æ™‚è§¸ç™¼ UI æ›´æ–°ï¼Œç¢ºä¿è¡¨å–®æ¬„ä½æ­£ç¢ºæ¸²æŸ“
    /// ActionButtons å·²ç”± GenericEditModalComponent.UpdateAllActionButtons() çµ±ä¸€æ›´æ–°
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            // å°æ–¼æ²’æœ‰æ˜ç´°çš„ç´”ä¸»æª”çµ„ä»¶ï¼Œåªéœ€è¦è§¸ç™¼ UI æ›´æ–°å³å¯
            // ActionButtons æ›´æ–°å·²ç”± GenericEditModalComponent çš„ LoadAllData çµ±ä¸€è™•ç†
            StateHasChanged();
            await Task.CompletedTask;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// åœ¨çµ„ä»¶æ¸²æŸ“å¾Œæª¢æŸ¥å¯¦é«”æ˜¯å¦å·²è¼‰å…¥ï¼Œå¦‚æœæ˜¯å‰‡åˆ·æ–°å€‰åº«ä½ç½®
    /// </summary>
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // åªåœ¨ç·¨è¼¯æ¨¡å¼ä¸‹ä¸”å¯¦é«”å·²è¼‰å…¥ä½†é‚„æ²’æª¢æŸ¥éæ™‚åŸ·è¡Œ
        if (IsVisible && ProductId.HasValue && !_hasCheckedEntityLoad && 
            editModalComponent?.Entity != null && editModalComponent.Entity.Id > 0)
        {
            _hasCheckedEntityLoad = true;
            await RefreshFormFieldsAfterEntityLoadAsync();
        }
    }

    /// <summary>
    /// åœ¨å¯¦é«”è¼‰å…¥å¾Œé‡æ–°åˆå§‹åŒ–è¡¨å–®æ¬„ä½
    /// </summary>
    public async Task RefreshFormFieldsAfterEntityLoadAsync()
    {
        // é‡æ–°åˆå§‹åŒ–è¡¨å–®æ¬„ä½
        await InitializeFormFieldsAsync();
        
        StateHasChanged();
    }
    private async Task<Product?> LoadProductData()
    {
        try
        {
            if (!ProductId.HasValue)
            {
                // æ–°å¢æ¨¡å¼ - å¾ç³»çµ±åƒæ•¸è¼‰å…¥é è¨­ç¨…ç‡
                var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();
                
                return new Product
                {
                    Status = EntityStatus.Active,
                    TaxRate = defaultTaxRate
                };
            }
            
            // ç·¨è¼¯æ¨¡å¼
            var product = await ProductService.GetByIdAsync(ProductId.Value);
            return product;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å•†å“è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return null;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // è¼‰å…¥å•†å“åˆ†é¡
            var productCategories = await ProductService.GetProductCategoriesAsync();
            availableProductCategories = productCategories;
            productCategoryOptions = productCategories.Select(pc => new SelectOption
            {
                Text = pc.Name,
                Value = pc.Id.ToString()
            }).ToList();

            // è¼‰å…¥ä¾›æ‡‰å•†
            var suppliers = await ProductService.GetSuppliersAsync();
            availableSuppliers = suppliers;
            supplierOptions = suppliers.Select(s => new SelectOption
            {
                Text = s.CompanyName,
                Value = s.Id.ToString()
            }).ToList();

            // è¼‰å…¥å–®ä½
            var units = await ProductService.GetUnitsAsync();
            availableUnits = units;
            unitOptions = units.Select(u => new SelectOption
            {
                Text = u.Name,
                Value = u.Id.ToString()
            }).ToList();

            // è¼‰å…¥å°ºå¯¸
            var sizes = await SizeService.GetActiveSizesAsync();
            availableSizes = sizes;
            sizeOptions = sizes.Select(s => new SelectOption
            {
                Text = s.Name,
                Value = s.Id.ToString()
            }).ToList();
            
            // é…ç½® AutoComplete
            autoCompleteConfig = new AutoCompleteConfigBuilder<Product>()
                .AddField(nameof(Product.ProductCategoryId), "Name", availableProductCategories)
                .AddField(nameof(Product.UnitId), "Name", availableUnits)
                .AddField(nameof(Product.ProductionUnitId), "Name", availableUnits)
                .AddField(nameof(Product.SizeId), "Name", availableSizes)
                .Build();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥é¡å¤–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        formFields = new List<FormFieldDefinition>
        {
            new()
            {
                PropertyName = nameof(Product.Code),
                Label = "å•†å“ç·¨è™Ÿ",
                FieldType = FormFieldType.Text,
                Placeholder = "è«‹è¼¸å…¥å•†å“ç·¨è™Ÿ",
                IsRequired = true,
                MaxLength = 50,
                HelpText = "å•†å“çš„å”¯ä¸€è­˜åˆ¥ç¢¼"
            },
            new()
            {
                PropertyName = nameof(Product.Name),
                Label = "å•†å“åç¨±",
                FieldType = FormFieldType.Text,
                Placeholder = "è«‹è¼¸å…¥å•†å“åç¨±",
                IsRequired = true,
                MaxLength = 100,
                HelpText = "å•†å“çš„å®Œæ•´åç¨±"
            },
            new FormFieldDefinition()
            {
                PropertyName = nameof(Product.Barcode),
                Label = "æ¢ç¢¼ç·¨è™Ÿ",
                FieldType = FormFieldType.Text,
                Placeholder = "è«‹è¼¸å…¥æ¢ç¢¼ç·¨è™Ÿ",
                IsRequired = true,
                MaxLength = 50,
                HelpText = "å•†å“çš„æ¢ç¢¼ç·¨è™Ÿ",
                ActionButtons = await GetBarcodeActionButtonsAsync()
            },
            new FormFieldDefinition()
            {
                PropertyName = nameof(Product.ShowBomOnPrint),
                Label = "å ±åƒ¹æ˜ç´°",
                FieldType = FormFieldType.Checkbox,
                Placeholder = "è«‹è¼¸å…¥æ˜¯å¦åœ¨å ±åƒ¹å–®åˆ—å°æ™‚é¡¯ç¤ºè©²å•†å“åœ¨BOMè¡¨è£¡çš„çµ„æˆ",
                IsRequired = true,
                HelpText = "æŒ‡ç¤ºæ˜¯å¦åœ¨å ±åƒ¹å–®åˆ—å°æ™‚é¡¯ç¤ºè©²å•†å“åœ¨ç‰©æ–™æ¸…å–®ä¸­çš„çµ„æˆçµ¦å®¢æˆ¶åƒè€ƒ",
            },
            new()
            {
                PropertyName = nameof(Product.ProductCategoryId),
                Label = "å•†å“åˆ†é¡",
                FieldType = FormFieldType.AutoComplete,
                Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡å•†å“åˆ†é¡",
                IsRequired = true,
                MinSearchLength = 0,
                HelpText = "è¼¸å…¥åˆ†é¡åç¨±é€²è¡Œæœå°‹ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                ActionButtons = await GetProductCategoryActionButtonsAsync()
            },
            new()
            {
                PropertyName = nameof(Product.SizeId),
                Label = "å°ºå¯¸",
                FieldType = FormFieldType.AutoComplete,
                Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡å°ºå¯¸",
                IsRequired = false,
                MinSearchLength = 0,
                HelpText = "è¼¸å…¥å°ºå¯¸åç¨±é€²è¡Œæœå°‹ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                ActionButtons = await GetSizeActionButtonsAsync()
            },
            new()
            {
                PropertyName = nameof(Product.UnitId),
                Label = "æ¡è³¼å–®ä½",
                FieldType = FormFieldType.AutoComplete,
                Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡æ¡è³¼è¨ˆé‡å–®ä½",
                IsRequired = true,
                MinSearchLength = 0,
                HelpText = "å•†å“çš„æ¡è³¼è¨ˆé‡å–®ä½ï¼ˆåº«å­˜å–®ä½ï¼‰",
                ActionButtons = await GetUnitActionButtonsAsync()
            },
            new()
            {
                PropertyName = nameof(Product.ProductionUnitId),
                Label = "è£½ç¨‹å–®ä½",
                FieldType = FormFieldType.AutoComplete,
                Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡è£½ç¨‹/åº«å­˜å–®ä½",
                IsRequired = false,
                MinSearchLength = 0,
                HelpText = "ç”Ÿç”¢è£½é€ æˆ–åº«å­˜ä½¿ç”¨çš„å–®ä½ï¼ˆè‹¥èˆ‡å•†å“å–®ä½ç›¸åŒå‰‡ç„¡éœ€å¡«å¯«ï¼Œç³»çµ±é è¨­ç‚ºå•†å“å–®ä½ï¼‰",
                ActionButtons = await GetProductionUnitActionButtonsAsync()
            },
            new FormFieldDefinition()
            {
                PropertyName = nameof(Product.ProductionUnitConversionRate),
                Label = GetProductionUnitConversionLabel(),
                FieldType = FormFieldType.Number,
                Placeholder = "è«‹è¼¸å…¥æ›ç®—ä¿‚æ•¸",
                IsRequired = false,
                IsVisible = ShouldShowProductionUnitConversion(),
                HelpText = "1 å•†å“å–®ä½ = N è£½ç¨‹å–®ä½ï¼ˆä¾‹å¦‚ï¼š1 åŒ… = 30 å…¬æ–¤ï¼Œå‰‡è¼¸å…¥ 30ï¼‰",
            },
            new FormFieldDefinition()
            {
                PropertyName = nameof(Product.TaxRate),
                Label = "ç¨…ç‡%",
                FieldType = FormFieldType.Number,
                Placeholder = "è«‹è¼¸å…¥ç¨…ç‡",
                IsRequired = true,
                HelpText = "å•†å“çš„ç¨…ç‡ï¼Œä»‹æ–¼0åˆ°100ä¹‹é–“ï¼Œé è¨­å€¼ä¾†è‡ªç³»çµ±åƒæ•¸",
                Min = 0,
                Max = 100
            },
            new FormFieldDefinition()
            {
                PropertyName = nameof(Product.ProcurementType),  
                Label = "æ¡è³¼é¡å‹",
                FieldType = FormFieldType.Select,
                IsRequired = true,
                HelpText = "æŒ‡ç¤ºå•†å“çš„å–å¾—æ–¹å¼(å¤–è³¼/è‡ªè£½/å§”å¤–)",
                Options = Enum.GetValues(typeof(ProcurementType))
                    .Cast<ProcurementType>()
                    .Select(e => new SelectOption
                    {
                        Text = GetProcurementTypeDisplayName(e),
                        Value = ((int)e).ToString()
                    })
                    .ToList()
            },
            new()
            {
                PropertyName = nameof(Product.Specification),
                Label = "è¦æ ¼èªªæ˜",
                FieldType = FormFieldType.TextArea,
                Placeholder = "è«‹è¼¸å…¥è¦æ ¼èªªæ˜",
                IsRequired = false,
                MaxLength = 100,
                HelpText = "å•†å“çš„è¦æ ¼èªªæ˜è³‡è¨Š"
            },

            FormFieldConfigurationHelper.CreateRemarksField<Product>()
        };

        formSections = FormSectionHelper<Product>.Create()
            .AddToSection(FormSectionNames.BasicInfo,
                p => p.Code,
                p => p.Name,
                p => p.Barcode,
                p => p.TaxRate,
                p => p.ProcurementType,
                p => p.ShowBomOnPrint)            
            .AddToSection(FormSectionNames.CategoryAndSpecification,
                p => p.ProductCategoryId,
                p => p.SizeId,
                p => p.Specification)            
            .AddToSection(FormSectionNames.UnitSettings,
                p => p.UnitId,
                p => p.ProductionUnitId,
                p => p.ProductionUnitConversionRate)
            .AddToSection(FormSectionNames.AdditionalInfo,                
                p => p.Remarks)
            .Build();
    }




    // ===== ActionButton ç”¢ç”Ÿæ–¹æ³• =====
    
    /// <summary>
    /// ç”¢ç”Ÿå•†å“åˆ†é¡æ“ä½œæŒ‰éˆ• - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetProductCategoryActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            productCategoryModalManager, 
            nameof(Product.ProductCategoryId)
        );
    }

    /// <summary>
    /// ç”¢ç”ŸåŸºæœ¬å–®ä½æ“ä½œæŒ‰éˆ• - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetUnitActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            unitModalManager, 
            nameof(Product.UnitId)
        );
    }

    /// <summary>
    /// ç”¢ç”Ÿæ¡è³¼å–®ä½æ“ä½œæŒ‰éˆ• - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetPurchaseUnitActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            unitModalManager, 
            nameof(Product.PurchaseUnitId)
        );
    }

    /// <summary>
    /// ç”¢ç”Ÿè£½ç¨‹å–®ä½æ“ä½œæŒ‰éˆ• - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetProductionUnitActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            unitModalManager, 
            nameof(Product.ProductionUnitId)
        );
    }

    /// <summary>
    /// ç”¢ç”Ÿå°ºå¯¸æ“ä½œæŒ‰éˆ• - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetSizeActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            sizeModalManager, 
            nameof(Product.SizeId)
        );
    }

    /// <summary>
    /// ç”¢ç”Ÿæ¢ç¢¼ç·¨è™Ÿæ“ä½œæŒ‰éˆ• - åŒå•†å“ç·¨è™Ÿ
    /// </summary>
    private Task<List<FieldActionButton>> GetBarcodeActionButtonsAsync()
    {
        var buttons = new List<FieldActionButton>
        {
            new FieldActionButton
            {
                Text = "è¤‡è£½",
                Variant = "OutlinePrimary",
                Size = "Small",
                Title = "å°‡å•†å“ç·¨è™Ÿè¤‡è£½åˆ°æ¢ç¢¼ç·¨è™Ÿ",
                OnClick = async () => await CopyCodeToBarcode(),
                IsDisabled = false
            }
        };
        
        return Task.FromResult(buttons);
    }

    /// <summary>
    /// å°‡å•†å“ç·¨è™Ÿè¤‡è£½åˆ°æ¢ç¢¼ç·¨è™Ÿæ¬„ä½
    /// </summary>
    private async Task CopyCodeToBarcode()
    {
        try
        {
            if (editModalComponent?.Entity != null)
            {
                // è¤‡è£½å•†å“ç·¨è™Ÿåˆ°æ¢ç¢¼ç·¨è™Ÿ
                editModalComponent.Entity.Barcode = editModalComponent.Entity.Code;
                
                // é€šçŸ¥ UI æ›´æ–°
                StateHasChanged();
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                await NotificationService.ShowSuccessAsync("å·²å°‡å•†å“ç·¨è™Ÿè¤‡è£½åˆ°æ¢ç¢¼ç·¨è™Ÿ");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¤‡è£½å•†å“ç·¨è™Ÿæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    // ===== Modal äº‹ä»¶åŒ…è£å™¨æ–¹æ³• =====
    
    /// <summary>
    /// åŒ…è£å•†å“ç‰©æ–™æ¸…å–®å„²å­˜äº‹ä»¶
    /// </summary>
    private async Task OnProductCompositionSavedWrapper(ProductComposition savedComposition)
    {
        // ç‰©æ–™æ¸…å–®å„²å­˜å¾Œï¼Œä¸éœ€è¦è‡ªå‹•é¸æ“‡ï¼Œåªéœ€é‡æ–°è¼‰å…¥æ¸…å–®
        await NotificationService.ShowSuccessAsync("å•†å“ç‰©æ–™æ¸…å–®å·²å„²å­˜");
        
        // ğŸ“ æ”¹é€²ï¼šç„¡è«–æ¸…å–®æ˜¯å¦é–‹å•Ÿï¼Œéƒ½æ›´æ–°å¿«å–è³‡æ–™
        // é€™æ¨£ä¸‹æ¬¡é–‹å•Ÿæ¸…å–®æ™‚æœƒçœ‹åˆ°æœ€æ–°è³‡æ–™
        if (editModalComponent?.Entity != null)
        {
            // é‡æ–°è¼‰å…¥ç‰©æ–™æ¸…å–®æ¸…å–®è³‡æ–™ï¼ˆæ›´æ–°å¿«å–ï¼‰
            await LoadProductCompositions();
            
            // å¦‚æœæ¸…å–® Modal æ­£åœ¨é¡¯ç¤ºï¼Œè§¸ç™¼ UI æ›´æ–°
            if (showRelatedDocumentsModal)
            {
                StateHasChanged();
            }
        }
    }

    /// <summary>
    /// è™•ç†æ¬„ä½å€¼è®Šæ›´äº‹ä»¶ - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // åœ¨ç¬¬ä¸€æ¬¡æ¬„ä½è®Šæ›´æ™‚æª¢æŸ¥å¯¦é«”æ˜¯å¦å·²è¼‰å…¥ï¼Œå¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ä¸”å€‰åº«ä½ç½®æ¬„ä½éœ€è¦åˆ·æ–°ï¼Œå‰‡åˆ·æ–°
            if (!_entityLoadedButFieldsNotRefreshed && ProductId.HasValue && editModalComponent?.Entity != null)
            {
                _entityLoadedButFieldsNotRefreshed = true;
                await RefreshFormFieldsAfterEntityLoadAsync();
            }
            
            // ä½¿ç”¨çµ±ä¸€ Helper è™•ç†å•†å“åˆ†é¡æ¬„ä½è®Šæ›´
            if (fieldChange.PropertyName == nameof(Product.ProductCategoryId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    productCategoryModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
            }
            // ä½¿ç”¨çµ±ä¸€ Helper è™•ç†åŸºæœ¬å–®ä½æ¬„ä½è®Šæ›´
            else if (fieldChange.PropertyName == nameof(Product.UnitId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    unitModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                
                // åŸºæœ¬å–®ä½è®Šæ›´æ™‚ä¹Ÿéœ€è¦æ›´æ–°è£½ç¨‹å–®ä½æ›ç®—æ¬„ä½
                await UpdateProductionUnitConversionFieldAsync();
            }
            // ä½¿ç”¨çµ±ä¸€ Helper è™•ç†è£½ç¨‹å–®ä½æ¬„ä½è®Šæ›´
            else if (fieldChange.PropertyName == nameof(Product.ProductionUnitId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    unitModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                
                // å‹•æ…‹æ›´æ–°è£½ç¨‹å–®ä½æ›ç®—æ¬„ä½çš„é¡¯ç¤ºç‹€æ…‹å’Œæ¨™ç±¤
                await UpdateProductionUnitConversionFieldAsync();
            }
            // ä½¿ç”¨çµ±ä¸€ Helper è™•ç†å°ºå¯¸æ¬„ä½è®Šæ›´
            else if (fieldChange.PropertyName == nameof(Product.SizeId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    sizeModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
            }
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("æ¬„ä½è®Šæ›´è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    // ===== ç‰©æ–™æ¸…å–®ç›¸é—œæ–¹æ³• =====
    
    /// <summary>
    /// å–å¾—è‡ªè¨‚æ“ä½œæŒ‰éˆ•ï¼ˆé¡¯ç¤ºåœ¨ Modal é ‚éƒ¨å·¦å´ï¼‰- ä½œç‚ºå±¬æ€§ä»¥ç¢ºä¿æ­£ç¢ºçš„æ¸²æŸ“æ™‚æ©Ÿ
    /// </summary>
    private RenderFragment? CustomActionButtons => __builder =>
    {
        @* ç‰©æ–™æ¸…å–®æ“ä½œæŒ‰éˆ•çµ„ *@
        <div class="d-flex gap-2">
            @* æŸ¥çœ‹ç‰©æ–™æ¸…å–®æ¸…å–® *@
            <GenericButtonComponent
                Text="æŸ¥çœ‹æ¸…å–®"
                OnClick="@ShowProductCompositions"
                Title="æŸ¥çœ‹å•†å“ç‰©æ–™æ¸…å–®æ¸…å–®"
                Variant="ButtonVariant.Blue"
                Size="ButtonSize.Small">
            </GenericButtonComponent>

            @* æ–°å¢ç‰©æ–™æ¸…å–® *@
            <GenericButtonComponent
                Text="æ–°å¢æ¸…å–®"
                OnClick="@HandleAddNewCompositionDirect"
                Title="ç›´æ¥æ–°å¢å•†å“ç‰©æ–™æ¸…å–®"
                Variant="ButtonVariant.DarkBlue"
                Size="ButtonSize.Small">
            </GenericButtonComponent>
        </div>
    };
    
    /// <summary>
    /// é¡¯ç¤ºå•†å“ç‰©æ–™æ¸…å–®æ¸…å–®
    /// </summary>
    private async Task ShowProductCompositions()
    {
        //  é—œéµæª¢æŸ¥ï¼šå•†å“å¿…é ˆå…ˆå„²å­˜
        if (editModalComponent?.Entity == null || editModalComponent.Entity.Id <= 0)
        {
            await NotificationService.ShowWarningAsync(
                "è«‹å…ˆå„²å­˜å•†å“å¾Œå†å»ºç«‹ç‰©æ–™æ¸…å–®", 
                "æç¤º");
            return;
        }
        
        selectedProductName = editModalComponent.Entity.Name ?? "æœªçŸ¥å•†å“";
        
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            await LoadProductCompositions();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ç‰©æ–™æ¸…å–®æ¸…å–®å¤±æ•—ï¼š{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// è¼‰å…¥å•†å“ç‰©æ–™æ¸…å–®æ¸…å–®
    /// </summary>
    private async Task LoadProductCompositions()
    {
        if (editModalComponent?.Entity == null || editModalComponent.Entity.Id <= 0)
        {
            relatedDocuments = new List<RelatedDocument>();
            return;
        }
        
        relatedDocuments = await RelatedDocumentsHelper.GetProductCompositionsAsync(
            editModalComponent.Entity.Id);
    }
    
    /// <summary>
    /// è™•ç†é»æ“Šç‰©æ–™æ¸…å–®é …ç›®ï¼ˆé–‹å•Ÿç·¨è¼¯ Modalï¼‰
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        if (document.DocumentType == RelatedDocumentType.ProductComposition)
        {
            // é–‹å•Ÿç·¨è¼¯ Modal
            await productCompositionModalManager.OpenModalAsync(document.DocumentId);
        }
    }
    
    /// <summary>
    /// è™•ç†æ–°å¢ç‰©æ–™æ¸…å–®æŒ‰éˆ•ï¼ˆå¾æ¸…å–® Modal çš„ Footer è§¸ç™¼ï¼‰
    /// </summary>
    private async Task HandleAddNewComposition()
    {
        if (editModalComponent?.Entity == null || editModalComponent.Entity.Id <= 0)
        {
            await NotificationService.ShowWarningAsync(
                "è«‹å…ˆå„²å­˜å•†å“å¾Œå†å»ºç«‹ç‰©æ–™æ¸…å–®", 
                "æç¤º");
            return;
        }
        
        // è¨­å®šé å¡«å€¼ï¼ˆä¸åŒ…å« Codeï¼Œè®“å­çµ„ä»¶è‡ªå‹•ç”¢ç”Ÿä»¥ç¢ºä¿å”¯ä¸€æ€§ï¼‰
        var prefilledValues = new Dictionary<string, object?>
        {
            { nameof(ProductComposition.ParentProductId), editModalComponent.Entity.Id }
        };
        
        // ä½¿ç”¨ OpenModalWithPrefilledValuesAsync é–‹å•Ÿæ–°å¢ Modal
        await productCompositionModalManager.OpenModalWithPrefilledValuesAsync(null, prefilledValues);
    }
    
    /// <summary>
    /// ç›´æ¥é–‹å•Ÿæ–°å¢ç‰©æ–™æ¸…å–® Modalï¼ˆä¸ç¶“éæ¸…å–®ï¼Œç›´æ¥å¸¶å…¥å•†å“ï¼‰
    /// </summary>
    private async Task HandleAddNewCompositionDirect()
    {
        try
        {
            //  é—œéµæª¢æŸ¥ï¼šå•†å“å¿…é ˆå…ˆå„²å­˜
            if (editModalComponent?.Entity == null || editModalComponent.Entity.Id <= 0)
            {
                await NotificationService.ShowWarningAsync(
                    "è«‹å…ˆå„²å­˜å•†å“å¾Œå†å»ºç«‹ç‰©æ–™æ¸…å–®", 
                    "æç¤º");
                return;
            }
            
            //  ä½¿ç”¨çµ±ä¸€çš„ EntityCodeGenerationHelper ç”¢ç”Ÿç‰©æ–™æ¸…å–®ç·¨è™Ÿ
            var newCode = await EntityCodeGenerationHelper.GenerateForEntity<ProductComposition, IProductCompositionService>(
                ProductCompositionService, "BOM");
            
            //  æ ¸å¿ƒï¼šè¨­å®šé å¡«å€¼ï¼Œè‡ªå‹•å¸¶å…¥å•†å“
            var prefilledValues = new Dictionary<string, object?>
            {
                { nameof(ProductComposition.ParentProductId), editModalComponent.Entity.Id },
                { nameof(ProductComposition.Code), newCode }
            };
            
            // ä½¿ç”¨ ModalManager é–‹å•Ÿæ–°å¢ Modal
            await productCompositionModalManager.OpenModalWithPrefilledValuesAsync(
                entityId: null,  // null = æ–°å¢æ¨¡å¼
                prefilledValues: prefilledValues
            );
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é–‹å•Ÿæ–°å¢ç‰©æ–™æ¸…å–®è¦–çª—å¤±æ•—ï¼š{ex.Message}");
        }
    }
    
    /// <summary>
    /// å–å¾—æ¡è³¼é¡å‹çš„é¡¯ç¤ºåç¨±
    /// </summary>
    private static string GetProcurementTypeDisplayName(ProcurementType procurementType)
    {
        return procurementType switch
        {
            ProcurementType.Purchased => "å¤–è³¼",
            ProcurementType.Manufactured => "è‡ªè£½",
            ProcurementType.Outsourced => "å§”å¤–",
            _ => procurementType.ToString()
        };
    }
    
    // ===== å–®ä½æ›ç®—ç›¸é—œæ–¹æ³• =====
    
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦æ‡‰é¡¯ç¤ºè£½ç¨‹å–®ä½æ›ç®—æ¬„ä½
    /// æ¢ä»¶ï¼šè£½ç¨‹å–®ä½å·²é¸æ“‡ï¼Œä¸”èˆ‡åŸºæœ¬å–®ä½ä¸åŒ
    /// </summary>
    private bool ShouldShowProductionUnitConversion()
    {
        var entity = editModalComponent?.Entity;
        if (entity == null) return false;
        
        // å¿…é ˆæœ‰é¸æ“‡è£½ç¨‹å–®ä½
        if (!entity.ProductionUnitId.HasValue) return false;
        
        // å¦‚æœæ²’æœ‰åŸºæœ¬å–®ä½ï¼ˆå°šæœªé¸æ“‡ï¼‰ï¼Œä¹Ÿé¡¯ç¤ºï¼ˆè®“ä½¿ç”¨è€…è¼¸å…¥æ›ç®—ç‡ï¼‰
        if (entity.UnitId <= 0) return true;
        
        // è£½ç¨‹å–®ä½èˆ‡åŸºæœ¬å–®ä½ä¸åŒæ™‚æ‰é¡¯ç¤º
        return entity.ProductionUnitId.Value != entity.UnitId;
    }
    
    /// <summary>
    /// ç”¢ç”Ÿè£½ç¨‹å–®ä½æ›ç®—æ¬„ä½çš„å‹•æ…‹æ¨™ç±¤
    /// æ ¼å¼ï¼šã€Œ1 [å•†å“å–®ä½åç¨±] = [æ›ç®—ç‡] [è£½ç¨‹å–®ä½åç¨±]ã€
    /// å¦‚æœæœ‰è¨­å®šæ›ç®—ç‡å‰‡é¡¯ç¤ºå¯¦éš›æ•¸å€¼ï¼Œå¦å‰‡é¡¯ç¤ºå•è™Ÿ
    /// </summary>
    private string GetProductionUnitConversionLabel()
    {
        var entity = editModalComponent?.Entity;
        if (entity == null) return "è£½ç¨‹å–®ä½æ›ç®—ç‡";
        
        var baseUnitName = GetUnitName(entity.UnitId);
        var productionUnitName = GetUnitName(entity.ProductionUnitId);
        
        // å–å¾—æ›ç®—ç‡ï¼Œå¦‚æœæœ‰å€¼å‰‡é¡¯ç¤ºæ•¸å€¼ï¼Œå¦å‰‡é¡¯ç¤ºå•è™Ÿ
        // ä½¿ç”¨ NumberFormatHelper.FormatSmart æ™ºèƒ½æ ¼å¼åŒ–ï¼Œæ•´æ•¸ä¸é¡¯ç¤ºå°æ•¸é»
        var conversionRateDisplay = entity.ProductionUnitConversionRate.HasValue && entity.ProductionUnitConversionRate.Value > 0
            ? NumberFormatHelper.FormatSmart(entity.ProductionUnitConversionRate.Value, useThousandsSeparator: false)
            : "?";
        
        if (string.IsNullOrEmpty(baseUnitName))
            return "è£½ç¨‹å–®ä½æ›ç®—ç‡";
            
        if (string.IsNullOrEmpty(productionUnitName))
            return $"1 {baseUnitName} = {conversionRateDisplay}";
            
        return $"1 {baseUnitName} = {conversionRateDisplay} {productionUnitName}";
    }
    
    /// <summary>
    /// æ ¹æ“šå–®ä½ ID å–å¾—å–®ä½åç¨±
    /// </summary>
    private string GetUnitName(int? unitId)
    {
        if (!unitId.HasValue) return string.Empty;
        return availableUnits.FirstOrDefault(u => u.Id == unitId.Value)?.Name ?? string.Empty;
    }
    
    /// <summary>
    /// å‹•æ…‹æ›´æ–°è£½ç¨‹å–®ä½æ›ç®—æ¬„ä½çš„é¡¯ç¤ºç‹€æ…‹å’Œæ¨™ç±¤
    /// </summary>
    private async Task UpdateProductionUnitConversionFieldAsync()
    {
        var conversionField = formFields.FirstOrDefault(f => 
            f.PropertyName == nameof(Product.ProductionUnitConversionRate));
            
        if (conversionField != null)
        {
            conversionField.IsVisible = ShouldShowProductionUnitConversion();
            conversionField.Label = GetProductionUnitConversionLabel();
            
            // å¦‚æœè£½ç¨‹å–®ä½èˆ‡åŸºæœ¬å–®ä½ç›¸åŒï¼Œè‡ªå‹•å°‡æ›ç®—ç‡è¨­ç‚º 1
            var entity = editModalComponent?.Entity;
            if (entity != null && entity.ProductionUnitId.HasValue && entity.UnitId > 0 
                && entity.ProductionUnitId.Value == entity.UnitId)
            {
                entity.ProductionUnitConversionRate = 1;
            }
        }
        
        StateHasChanged();
        await Task.CompletedTask;
    }
}

