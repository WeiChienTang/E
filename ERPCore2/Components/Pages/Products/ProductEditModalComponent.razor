@* 可重用的商品編輯組件 - 可在任何頁面中嵌入 *@
@using ERPCore2.Helpers
@using ERPCore2.Models
@using ERPCore2.Services.Reports.Interfaces
@using ERPCore2.Models.Reports
@inject IProductService ProductService
@inject ISizeService SizeService
@inject IProductCategoryService ProductCategoryService
@inject IUnitService UnitService
@inject ISupplierService SupplierService
@inject IInventoryStockService InventoryStockService
@inject ISystemParameterService SystemParameterService
@inject IProductCompositionService ProductCompositionService
@inject INotificationService NotificationService
@inject IProductListReportService ProductListReportService
@inject IProductDetailReportService ProductDetailReportService
@inject ActionButtonHelper ActionButtonHelper
@inject RelatedDocumentsHelper RelatedDocumentsHelper
@inject ICompanyModuleService CompanyModuleService
@inject INavigationPermissionService NavigationPermissionService
@inject IStringLocalizer<SharedResource> L

<GenericEditModalComponent TEntity="Product" 
                          TService="IProductService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@ProductId"
                          Service="@ProductService"
                          EntityName="@L["Entity.Product"]"
                          EntityNamePlural="@L["Entity.Product"]"
                          ModalTitle="@(ProductId.HasValue ? L["Message.EditTitle", L["Entity.Product"]].ToString() : L["Message.CreateTitle", L["Entity.Product"]].ToString())"
                          Size="GenericEditModalComponent<Product, IProductService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          TabDefinitions="@tabDefinitions"
                          AutoCompletePrefillers="@(autoCompleteConfig?.Prefillers)"
                          AutoCompleteCollections="@(autoCompleteConfig?.Collections)"
                          AutoCompleteDisplayProperties="@(autoCompleteConfig?.DisplayProperties)"
                          AutoCompleteValueProperties="@(autoCompleteConfig?.ValueProperties)"
                          ModalManagers="@modalManagers?.AsDictionary()"
                          DataLoader="@LoadProductData"
                          UseGenericSave="true"
                          SaveSuccessMessage="@(ProductId.HasValue ? L["Message.UpdateSuccess", L["Entity.Product"]].ToString() : L["Message.CreateSuccess", L["Entity.Product"]].ToString())"
                          SaveFailureMessage="@L["Message.SaveFailure", L["Entity.Product"]]"
                          RequiredPermission="@PermissionRegistry.Product.Read"
                          OnEntitySaved="@OnProductSaved"
                          OnCancel="@OnCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          OnEntityLoaded="@HandleEntityLoaded"
                          ShowPrintButton="true"
                          PrintButtonText="@L["Button.Print"]"
                          ReportService="@ProductDetailReportService"
                          ReportId="@ReportIds.ProductDetail"
                          ReportPreviewTitle="@L["Label.DocumentPreview", L["Entity.Product"]]"
                          GetReportDocumentName="@(e => $"商品-{e.Code}")"
                          CustomActionButtons="@CustomActionButtons" />

@* 商品類型編輯 Modal *@
<ProductCategoryEditModalComponent @ref="productCategoryEditModal"
                                  IsVisible="@productCategoryModalManager.IsModalVisible"
                                  IsVisibleChanged="@productCategoryModalManager.HandleModalVisibilityChangedAsync"
                                  ProductCategoryId="@productCategoryModalManager.SelectedEntityId"
                                  PrefilledValues="@productCategoryModalManager.PrefilledValues"
                                  OnProductCategorySaved="@productCategoryModalManager.OnSavedAsync"
                                  OnCancel="@productCategoryModalManager.HandleModalCancelAsync" />

@* 單位編輯 Modal *@
<UnitEditModalComponent @ref="unitEditModal"
                       IsVisible="@unitModalManager.IsModalVisible"
                       IsVisibleChanged="@unitModalManager.HandleModalVisibilityChangedAsync"
                       UnitId="@unitModalManager.SelectedEntityId"
                       PrefilledValues="@unitModalManager.PrefilledValues"
                       OnUnitSaved="@unitModalManager.OnSavedAsync"
                       OnCancel="@unitModalManager.HandleModalCancelAsync" />

@* 尺寸編輯 Modal *@
<SizeEditModalComponent @ref="sizeEditModal"
                       IsVisible="@sizeModalManager.IsModalVisible"
                       IsVisibleChanged="@sizeModalManager.HandleModalVisibilityChangedAsync"
                       SizeId="@sizeModalManager.SelectedEntityId"
                       PrefilledValues="@sizeModalManager.PrefilledValues"
                       OnSizeSaved="@sizeModalManager.OnSavedAsync"
                       OnCancel="@sizeModalManager.HandleModalCancelAsync" />

@* 商品物料清單編輯 Modal *@
<ProductCompositionEditModalComponent @ref="productCompositionEditModal"
                                     IsVisible="@productCompositionModalManager.IsModalVisible"
                                     IsVisibleChanged="@productCompositionModalManager.HandleModalVisibilityChangedAsync"
                                     CompositionId="@productCompositionModalManager.SelectedEntityId"
                                     PrefilledValues="@productCompositionModalManager.PrefilledValues"
                                     OnCompositionSaved="@OnProductCompositionSavedWrapper"
                                     OnCancel="@productCompositionModalManager.HandleModalCancelAsync" />

<!-- 相關單據查看 Modal（物料清單清單）-->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick"
                               OnAddNew="@HandleAddNewComposition" />

@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? ProductId { get; set; }
    [Parameter] public EventCallback<Product> OnProductSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<Product, IProductService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    private List<FormTabDefinition>? tabDefinitions;

    // Tab 元件參考
    private ProductAccountingTab? accountingTab;

    private RenderFragment CreateAccountingTabContent() => __builder =>
    {
        <ProductAccountingTab @ref="accountingTab" />
    };
    
    // 標誌變數，用於追蹤是否需要在實體載入後刷新欄位
    private bool _entityLoadedButFieldsNotRefreshed = false;
    private bool _hasCheckedEntityLoad = false;
    
    // ActionButtons 快取機制已移除，改由 GenericEditModalComponent.UpdateAllActionButtons() 統一管理
    
    // 原始資料集合（用於 AutoComplete）
    private List<ProductCategory> availableProductCategories = new();
    private List<Supplier> availableSuppliers = new();
    private List<Unit> availableUnits = new();
    private List<Size> availableSizes = new();
    
    // AutoComplete 配置
    private AutoCompleteConfig? autoCompleteConfig;
    
    // Modal 管理器
    private ProductCategoryEditModalComponent? productCategoryEditModal;
    private RelatedEntityModalManager<ProductCategory> productCategoryModalManager = default!;
    
    private UnitEditModalComponent? unitEditModal;
    private RelatedEntityModalManager<Unit> unitModalManager = default!;
    
    private SizeEditModalComponent? sizeEditModal;
    private RelatedEntityModalManager<Size> sizeModalManager = default!;
    
    private ProductCompositionEditModalComponent? productCompositionEditModal;
    private RelatedEntityModalManager<ProductComposition> productCompositionModalManager = default!;
    
    private ModalManagerCollection modalManagers = default!;
    
    // 選項清單（向下相容）
    private List<SelectOption> productCategoryOptions = new();
    private List<SelectOption> supplierOptions = new();
    private List<SelectOption> unitOptions = new();
    private List<SelectOption> sizeOptions = new();
    
    // 資料載入狀態標記
    private bool isDataLoaded = false;
    
    // ===== 相關單據查看（物料清單清單）=====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;

    // ===== 必要方法 =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 使用 ModalManagerInitHelper 初始化 Modal 管理器
            modalManagers = ModalManagerInitHelper.CreateBuilder<Product, IProductService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<ProductCategory>(nameof(Product.ProductCategoryId), "商品類別")
                .AddManager<Unit>(nameof(Product.UnitId), "單位")
                .AddManager<Size>(nameof(Product.SizeId), "尺寸")
                .Build();
            productCategoryModalManager = modalManagers.Get<ProductCategory>(nameof(Product.ProductCategoryId));
            unitModalManager = modalManagers.Get<Unit>(nameof(Product.UnitId));
            sizeModalManager = modalManagers.Get<Size>(nameof(Product.SizeId));
            
            // 初始化商品物料清單 Modal 管理器（獨立初始化）
            productCompositionModalManager = new RelatedEntityModalManager<ProductComposition>
            {
                NotificationService = NotificationService,
                EntityDisplayName = "商品物料清單",
                StateHasChangedCallback = StateHasChanged
            };
            
            // 移除自動載入資料，改為在 OnParametersSetAsync 中根據 IsVisible 載入
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化商品編輯組件時發生錯誤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            // 重置標誌，確保每次打開Modal時都會檢查
            _entityLoadedButFieldsNotRefreshed = false;
            _hasCheckedEntityLoad = false;
            
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
        }
    }
    
    /// <summary>
    /// 處理實體載入完成事件（由 GenericEditModalComponent 的導航觸發）
    /// 重建表單欄位以確保 IsVisible / Label 等依賴 Entity 狀態的屬性正確更新
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            _hasCheckedEntityLoad = true;
            await RefreshFormFieldsAfterEntityLoadAsync();

            if (loadedEntityId > 0)
                if (accountingTab != null) await accountingTab.LoadAsync(loadedEntityId);
            else
                accountingTab?.Clear();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入資料時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 在組件渲染後檢查實體是否已載入，如果是則刷新倉庫位置
    /// </summary>
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // 只在編輯模式下且實體已載入但還沒檢查過時執行
        if (IsVisible && ProductId.HasValue && !_hasCheckedEntityLoad && 
            editModalComponent?.Entity != null && editModalComponent.Entity.Id > 0)
        {
            _hasCheckedEntityLoad = true;
            await RefreshFormFieldsAfterEntityLoadAsync();
        }
    }

    /// <summary>
    /// 在實體載入後重新初始化表單欄位
    /// </summary>
    public async Task RefreshFormFieldsAfterEntityLoadAsync()
    {
        // 重新初始化表單欄位
        await InitializeFormFieldsAsync();

        // 根據實體狀態正確設定換算欄位的顯示狀態（導航時實體已載入）
        await UpdateProductionUnitConversionFieldAsync();
    }
    private async Task<Product?> LoadProductData()
    {
        try
        {
            if (!ProductId.HasValue)
            {
                // 新增模式 - 從系統參數載入預設稅率
                var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();
                
                return new Product
                {
                    Status = EntityStatus.Active,
                    TaxRate = defaultTaxRate
                };
            }
            
            // 編輯模式
            var product = await ProductService.GetByIdAsync(ProductId.Value);
            return product;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入商品資料時發生錯誤：{ex.Message}");
            return null;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // 載入商品類型
            var productCategories = await ProductService.GetProductCategoriesAsync();
            availableProductCategories = productCategories;
            productCategoryOptions = productCategories.Select(pc => new SelectOption
            {
                Text = pc.Name,
                Value = pc.Id.ToString()
            }).ToList();

            // 載入供應商
            var suppliers = await ProductService.GetSuppliersAsync();
            availableSuppliers = suppliers;
            supplierOptions = suppliers.Select(s => new SelectOption
            {
                Text = s.CompanyName,
                Value = s.Id.ToString()
            }).ToList();

            // 載入單位
            var units = await ProductService.GetUnitsAsync();
            availableUnits = units;
            unitOptions = units.Select(u => new SelectOption
            {
                Text = u.Name,
                Value = u.Id.ToString()
            }).ToList();

            // 載入尺寸
            var sizes = await SizeService.GetActiveSizesAsync();
            availableSizes = sizes;
            sizeOptions = sizes.Select(s => new SelectOption
            {
                Text = s.Name,
                Value = s.Id.ToString()
            }).ToList();
            
            // 配置 AutoComplete
            autoCompleteConfig = new AutoCompleteConfigBuilder<Product>()
                .AddField(nameof(Product.ProductCategoryId), "Name", availableProductCategories)
                .AddField(nameof(Product.UnitId), "Name", availableUnits)
                .AddField(nameof(Product.ProductionUnitId), "Name", availableUnits)
                .AddField(nameof(Product.SizeId), "Name", availableSizes)
                .Build();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入額外資料時發生錯誤：{ex.Message}");
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        formFields = new List<FormFieldDefinition>
        {
            new()
            {
                PropertyName = nameof(Product.Code),
                Label = L["Field.ProductCode"],
                FieldType = FormFieldType.Text,
                Placeholder = L["Placeholder.PleaseInput", L["Field.ProductCode"]],
                IsRequired = true,
                MaxLength = 50,
                HelpText = "商品的唯一識別碼"
            },
            new FormFieldDefinition()
            {
                PropertyName = nameof(Product.Barcode),
                Label = L["Field.Barcode"],
                FieldType = FormFieldType.Text,
                Placeholder = L["Placeholder.PleaseInput", L["Field.Barcode"]],
                IsRequired = true,
                MaxLength = 50,
                HelpText = "商品的條碼編號",
                ActionButtons = await GetBarcodeActionButtonsAsync()
            },
            new()
            {
                PropertyName = nameof(Product.Name),
                Label = L["Field.ProductName"],
                FieldType = FormFieldType.Text,
                Placeholder = L["Placeholder.PleaseInput", L["Field.ProductName"]],
                IsRequired = true,
                MaxLength = 100,
                HelpText = "商品的完整名稱"
            },

            new()
            {
                PropertyName = nameof(Product.ProductCategoryId),
                Label = L["Field.Type"],
                FieldType = FormFieldType.AutoComplete,
                Placeholder = L["Placeholder.PleaseInputOrSelect", L["Field.Type"]],
                IsRequired = true,
                MinSearchLength = 0,
                HelpText = "輸入類型名稱進行搜尋，或直接選擇",
                ActionButtons = await GetProductCategoryActionButtonsAsync()
            },
            new()
            {
                PropertyName = nameof(Product.SizeId),
                Label = L["Entity.Size"],
                FieldType = FormFieldType.AutoComplete,
                Placeholder = L["Placeholder.PleaseInputOrSelect", L["Entity.Size"]],
                IsRequired = false,
                MinSearchLength = 0,
                HelpText = "輸入尺寸名稱進行搜尋，或直接選擇",
                ActionButtons = await GetSizeActionButtonsAsync()
            },
            new()
            {
                PropertyName = nameof(Product.UnitId),
                Label = L["Field.PurchaseUnit"],
                FieldType = FormFieldType.AutoComplete,
                Placeholder = L["Placeholder.PleaseInputOrSelect", L["Field.PurchaseUnit"]],
                IsRequired = true,
                MinSearchLength = 0,
                HelpText = "商品的採購計量單位（例如：包、箱、公斤）",
                ActionButtons = await GetUnitActionButtonsAsync()
            },
            new()
            {
                PropertyName = nameof(Product.ProductionUnitId),
                Label = L["Field.ProductionUnit"],
                FieldType = FormFieldType.AutoComplete,
                Placeholder = L["Placeholder.PleaseInputOrSelect", L["Field.ProductionUnit"]],
                IsRequired = false,
                MinSearchLength = 0,
                HelpText = "生產製造或庫存使用的單位（若與商品單位相同則無需填寫，系統預設為商品單位）",
                ActionButtons = await GetProductionUnitActionButtonsAsync()
            },
            new FormFieldDefinition()
            {
                PropertyName = nameof(Product.ProductionUnitConversionRate),
                Label = GetProductionUnitConversionLabel(),
                LabelFactory = () => GetProductionUnitConversionLabel(),
                FieldType = FormFieldType.Number,
                Placeholder = "請輸入換算係數",
                IsRequired = false,
                IsVisible = true,
                HelpText = "1 採購單位 = N 製程單位（例如：1 包 = 30 公斤，則輸入 30）",
                UseThousandsSeparator = false,
                BindOnInput = true,
            },
            new FormFieldDefinition()
            {
                PropertyName = nameof(Product.TaxRate),
                Label = L["Field.TaxRate"],
                FieldType = FormFieldType.Number,
                Placeholder = L["Placeholder.PleaseInput", L["Field.TaxRate"]],
                IsRequired = true,
                HelpText = "商品的稅率，介於0到100之間，預設值來自系統參數",
                Min = 0,
                Max = 100
            },
            // 暫時不讓使用者輸入，因為成本計算還尚未完善
            /*new FormFieldDefinition()
            {
                PropertyName = nameof(Product.StandardCost),
                Label = "成本",
                FieldType = FormFieldType.Number,
                Placeholder = "請輸入成本",
                IsRequired = false,
                HelpText = "商品的成本（財務/成本核算用）",
                Min = 0
            },*/
            new()
            {
                PropertyName = nameof(Product.Specification),
                Label = L["Field.Specification"],
                FieldType = FormFieldType.TextArea,
                Placeholder = L["Placeholder.PleaseInput", L["Field.Specification"]],
                IsRequired = false,
                MaxLength = 100,
                HelpText = "商品的規格說明資訊"
            },

            FormFieldConfigurationHelper.CreateRemarksField<Product>()
        };

        // 模組狀態（停用時隱藏對應 Tab）
        var isAccountingEnabled = await CompanyModuleService.IsModuleEnabledAsync("Accounting");
        if (!isAccountingEnabled)
            isAccountingEnabled = await NavigationPermissionService.IsCurrentEmployeeSuperAdminAsync();

        var builder = FormSectionHelper<Product>.Create()
            .AddToSection(FormSectionNames.BasicInfo,
                p => p.Code,
                p => p.Barcode,
                p => p.Name,
                p => p.TaxRate,
                p => p.StandardCost)
            .AddToSection(FormSectionNames.CategoryAndSpecification,
                p => p.UnitId,
                p => p.ProductionUnitId,
                p => p.ProductionUnitConversionRate,
                p => p.ProductCategoryId,
                p => p.SizeId,
                p => p.Specification)
            .AddToSection(FormSectionNames.AdditionalInfo,
                p => p.Remarks)
            .GroupIntoTab(L["Tab.ProductData"].ToString(), "bi-box-seam", FormSectionNames.BasicInfo, FormSectionNames.CategoryAndSpecification, FormSectionNames.AdditionalInfo);

        if (isAccountingEnabled)
            builder = builder.GroupIntoCustomTab(L["Tab.AccountingInfo"].ToString(), "bi-calculator", CreateAccountingTabContent());

        var layout = builder.BuildAll();
        formSections = layout.FieldSections;
        tabDefinitions = layout.TabDefinitions;
    }




    // ===== ActionButton 產生方法 =====
    
    /// <summary>
    /// 產生商品類型操作按鈕 - 使用統一 Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetProductCategoryActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            productCategoryModalManager, 
            nameof(Product.ProductCategoryId)
        );
    }

    /// <summary>
    /// 產生基本單位操作按鈕 - 使用統一 Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetUnitActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            unitModalManager, 
            nameof(Product.UnitId)
        );
    }

    /// <summary>
    /// 產生製程單位操作按鈕 - 使用統一 Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetProductionUnitActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            unitModalManager, 
            nameof(Product.ProductionUnitId)
        );
    }

    /// <summary>
    /// 產生尺寸操作按鈕 - 使用統一 Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetSizeActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            sizeModalManager, 
            nameof(Product.SizeId)
        );
    }

    /// <summary>
    /// 產生條碼編號操作按鈕 - 同商品編號
    /// </summary>
    private Task<List<FieldActionButton>> GetBarcodeActionButtonsAsync()
    {
        var buttons = new List<FieldActionButton>
        {
            new FieldActionButton
            {
                Text = "複製",
                Variant = "OutlinePrimary",
                Size = "Small",
                Title = "將商品編號複製到條碼編號",
                OnClick = async () => await CopyCodeToBarcode(),
                IsDisabled = false
            }
        };
        
        return Task.FromResult(buttons);
    }

    /// <summary>
    /// 將商品編號複製到條碼編號欄位
    /// </summary>
    private async Task CopyCodeToBarcode()
    {
        try
        {
            if (editModalComponent?.Entity != null)
            {
                // 複製商品編號到條碼編號
                editModalComponent.Entity.Barcode = editModalComponent.Entity.Code;
                
                // 通知 UI 更新
                StateHasChanged();
                
                // 顯示成功訊息
                await NotificationService.ShowSuccessAsync("已將商品編號複製到條碼編號");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"複製商品編號時發生錯誤：{ex.Message}");
        }
    }

    // ===== Modal 事件包裝器方法 =====
    
    /// <summary>
    /// 包裝商品物料清單儲存事件
    /// </summary>
    private async Task OnProductCompositionSavedWrapper(ProductComposition savedComposition)
    {
        // 物料清單儲存後，不需要自動選擇，只需重新載入清單
        await NotificationService.ShowSuccessAsync("商品物料清單已儲存");
        
        // 📝 改進：無論清單是否開啟，都更新快取資料
        // 這樣下次開啟清單時會看到最新資料
        if (editModalComponent?.Entity != null)
        {
            // 重新載入物料清單清單資料（更新快取）
            await LoadProductCompositions();
            
            // 如果清單 Modal 正在顯示，觸發 UI 更新
            if (showRelatedDocumentsModal)
            {
                StateHasChanged();
            }
        }
    }

    /// <summary>
    /// 處理欄位值變更事件 - 使用統一 Helper
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // 在第一次欄位變更時檢查實體是否已載入，如果是編輯模式且倉庫位置欄位需要刷新，則刷新
            if (!_entityLoadedButFieldsNotRefreshed && ProductId.HasValue && editModalComponent?.Entity != null)
            {
                _entityLoadedButFieldsNotRefreshed = true;
                await RefreshFormFieldsAfterEntityLoadAsync();
            }
            
            // 使用統一 Helper 處理商品類型欄位變更
            if (fieldChange.PropertyName == nameof(Product.ProductCategoryId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    productCategoryModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
            }
            // 使用統一 Helper 處理基本單位欄位變更
            else if (fieldChange.PropertyName == nameof(Product.UnitId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    unitModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                
                // 基本單位變更時也需要更新製程單位換算欄位
                await UpdateProductionUnitConversionFieldAsync();
            }
            // 使用統一 Helper 處理製程單位欄位變更
            else if (fieldChange.PropertyName == nameof(Product.ProductionUnitId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    unitModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                
                // 動態更新製程單位換算欄位的顯示狀態和標籤
                await UpdateProductionUnitConversionFieldAsync();
            }
            // 使用統一 Helper 處理尺寸欄位變更
            else if (fieldChange.PropertyName == nameof(Product.SizeId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    sizeModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
            }
            // 換算率數值變更時即時更新欄位標籤
            else if (fieldChange.PropertyName == nameof(Product.ProductionUnitConversionRate))
            {
                var conversionField = formFields.FirstOrDefault(f =>
                    f.PropertyName == nameof(Product.ProductionUnitConversionRate));
                if (conversionField != null)
                {
                    conversionField.Label = GetProductionUnitConversionLabel();
                }
                StateHasChanged();
            }
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("欄位變更處理時發生錯誤");
        }
    }
    
    // ===== 物料清單相關方法 =====
    
    /// <summary>
    /// 取得自訂操作按鈕（顯示在 Modal 頂部左側）- 作為屬性以確保正確的渲染時機
    /// </summary>
    private RenderFragment? CustomActionButtons => __builder =>
    {
        @* 物料清單操作按鈕組 *@
        <div class="d-flex gap-2">
            @* 查看物料清單清單 *@
            <GenericButtonComponent
                Text="查看清單"
                OnClick="@ShowProductCompositions"
                Title="查看商品物料清單清單"
                Variant="ButtonVariant.Blue"
                Size="ButtonSize.Small">
            </GenericButtonComponent>

            @* 新增物料清單 *@
            <GenericButtonComponent
                Text="新增清單"
                OnClick="@HandleAddNewCompositionDirect"
                Title="直接新增商品物料清單"
                Variant="ButtonVariant.DarkBlue"
                Size="ButtonSize.Small">
            </GenericButtonComponent>
        </div>
    };
    
    /// <summary>
    /// 顯示商品物料清單清單
    /// </summary>
    private async Task ShowProductCompositions()
    {
        //  關鍵檢查：商品必須先儲存
        if (editModalComponent?.Entity == null || editModalComponent.Entity.Id <= 0)
        {
            await NotificationService.ShowWarningAsync(
                "請先儲存商品後再建立物料清單", 
                "提示");
            return;
        }
        
        selectedProductName = editModalComponent.Entity.Name ?? "未知商品";
        
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            await LoadProductCompositions();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入物料清單清單失敗：{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// 載入商品物料清單清單
    /// </summary>
    private async Task LoadProductCompositions()
    {
        if (editModalComponent?.Entity == null || editModalComponent.Entity.Id <= 0)
        {
            relatedDocuments = new List<RelatedDocument>();
            return;
        }
        
        relatedDocuments = await RelatedDocumentsHelper.GetProductCompositionsAsync(
            editModalComponent.Entity.Id);
    }
    
    /// <summary>
    /// 處理點擊物料清單項目（開啟編輯 Modal）
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        if (document.DocumentType == RelatedDocumentType.ProductComposition)
        {
            // 開啟編輯 Modal
            await productCompositionModalManager.OpenModalAsync(document.DocumentId);
        }
    }
    
    /// <summary>
    /// 處理新增物料清單按鈕（從清單 Modal 的 Footer 觸發）
    /// </summary>
    private async Task HandleAddNewComposition()
    {
        if (editModalComponent?.Entity == null || editModalComponent.Entity.Id <= 0)
        {
            await NotificationService.ShowWarningAsync(
                "請先儲存商品後再建立物料清單", 
                "提示");
            return;
        }
        
        // 設定預填值（不包含 Code，讓子組件自動產生以確保唯一性）
        var prefilledValues = new Dictionary<string, object?>
        {
            { nameof(ProductComposition.ParentProductId), editModalComponent.Entity.Id }
        };
        
        // 使用 OpenModalWithPrefilledValuesAsync 開啟新增 Modal
        await productCompositionModalManager.OpenModalWithPrefilledValuesAsync(null, prefilledValues);
    }
    
    /// <summary>
    /// 直接開啟新增物料清單 Modal（不經過清單，直接帶入商品）
    /// </summary>
    private async Task HandleAddNewCompositionDirect()
    {
        try
        {
            //  關鍵檢查：商品必須先儲存
            if (editModalComponent?.Entity == null || editModalComponent.Entity.Id <= 0)
            {
                await NotificationService.ShowWarningAsync(
                    "請先儲存商品後再建立物料清單", 
                    "提示");
                return;
            }
            
            //  使用統一的 EntityCodeGenerationHelper 產生物料清單編號
            var newCode = await EntityCodeGenerationHelper.GenerateForEntity<ProductComposition, IProductCompositionService>(
                ProductCompositionService, "BOM");
            
            //  核心：設定預填值，自動帶入商品
            var prefilledValues = new Dictionary<string, object?>
            {
                { nameof(ProductComposition.ParentProductId), editModalComponent.Entity.Id },
                { nameof(ProductComposition.Code), newCode }
            };
            
            // 使用 ModalManager 開啟新增 Modal
            await productCompositionModalManager.OpenModalWithPrefilledValuesAsync(
                entityId: null,  // null = 新增模式
                prefilledValues: prefilledValues
            );
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"開啟新增物料清單視窗失敗：{ex.Message}");
        }
    }
    
    // ===== 單位換算相關方法 =====
    
    /// <summary>
    /// 判斷是否應顯示製程單位換算欄位
    /// 條件：製程單位已選擇，且與基本單位不同
    /// </summary>
    private bool ShouldShowProductionUnitConversion()
    {
        var entity = editModalComponent?.Entity;
        if (entity == null) return false;
        
        // 必須有選擇製程單位
        if (!entity.ProductionUnitId.HasValue) return false;
        
        // 如果沒有基本單位（尚未選擇），也顯示（讓使用者輸入換算率）
        if (entity.UnitId <= 0) return true;
        
        // 製程單位與基本單位不同時才顯示
        return entity.ProductionUnitId.Value != entity.UnitId;
    }
    
    /// <summary>
    /// 產生製程單位換算欄位的動態標籤
    /// 格式：「1 [採購單位名稱] = [換算率] [製程單位名稱]」
    /// 如果有設定換算率則顯示實際數值，否則顯示問號
    /// </summary>
    private string GetProductionUnitConversionLabel()
    {
        var entity = editModalComponent?.Entity;
        if (entity == null) return "單位換算率";
        
        var baseUnitName = GetUnitName(entity.UnitId);
        var productionUnitName = GetUnitName(entity.ProductionUnitId);
        
        // 取得換算率，如果有值則顯示數值，否則顯示問號
        // 使用 NumberFormatHelper.FormatSmart 智能格式化，整數不顯示小數點
        var conversionRateDisplay = entity.ProductionUnitConversionRate.HasValue && entity.ProductionUnitConversionRate.Value > 0
            ? NumberFormatHelper.FormatSmart(entity.ProductionUnitConversionRate.Value, useThousandsSeparator: false)
            : "?";
        
        if (string.IsNullOrEmpty(baseUnitName))
            return "單位換算率";
            
        if (string.IsNullOrEmpty(productionUnitName))
            return $"1 {baseUnitName} = {conversionRateDisplay}";
            
        return $"1 {baseUnitName} = {conversionRateDisplay} {productionUnitName}";
    }
    
    /// <summary>
    /// 根據單位 ID 取得單位名稱
    /// </summary>
    private string GetUnitName(int? unitId)
    {
        if (!unitId.HasValue) return string.Empty;
        return availableUnits.FirstOrDefault(u => u.Id == unitId.Value)?.Name ?? string.Empty;
    }
    
    /// <summary>
    /// 動態更新製程單位換算欄位的顯示狀態和標籤
    /// </summary>
    private async Task UpdateProductionUnitConversionFieldAsync()
    {
        var conversionField = formFields.FirstOrDefault(f => 
            f.PropertyName == nameof(Product.ProductionUnitConversionRate));
            
        if (conversionField != null)
        {
            conversionField.Label = GetProductionUnitConversionLabel();
            
            // 如果製程單位與基本單位相同，自動將換算率設為 1
            var entity = editModalComponent?.Entity;
            if (entity != null && entity.ProductionUnitId.HasValue && entity.UnitId > 0 
                && entity.ProductionUnitId.Value == entity.UnitId)
            {
                entity.ProductionUnitConversionRate = 1;
            }
        }
        
        StateHasChanged();
        await Task.CompletedTask;
    }
}

