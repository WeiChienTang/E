@* å¯é‡ç”¨çš„å•†å“ç·¨è¼¯çµ„ä»¶ - å¯åœ¨ä»»ä½•é é¢ä¸­åµŒå…¥ *@
@using ERPCore2.Helpers
@using ERPCore2.Models
@inject IProductService ProductService
@inject ISizeService SizeService
@inject IProductCategoryService ProductCategoryService
@inject IUnitService UnitService
@inject ISupplierService SupplierService
@inject IInventoryStockService InventoryStockService
@inject ISystemParameterService SystemParameterService
@inject IProductCompositionService ProductCompositionService
@inject INotificationService NotificationService
@inject ActionButtonHelper ActionButtonHelper
@inject RelatedDocumentsHelper RelatedDocumentsHelper

<GenericEditModalComponent TEntity="Product" 
                          TService="IProductService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@ProductId"
                          Service="@ProductService"
                          EntityName="å•†å“"
                          EntityNamePlural="å•†å“"
                          ModalTitle="@(ProductId.HasValue ? "ç·¨è¼¯å•†å“" : "æ–°å¢å•†å“")"
                          Size="GenericEditModalComponent<Product, IProductService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@(autoCompleteConfig?.Prefillers)"
                          AutoCompleteCollections="@(autoCompleteConfig?.Collections)"
                          AutoCompleteDisplayProperties="@(autoCompleteConfig?.DisplayProperties)"
                          AutoCompleteValueProperties="@(autoCompleteConfig?.ValueProperties)"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadProductData"
                          UseGenericSave="true"
                          SaveSuccessMessage="@(ProductId.HasValue ? "ç·¨è¼¯å•†å“æˆåŠŸ" : "æ–°å¢å•†å“æˆåŠŸ")"
                          SaveFailureMessage="å•†å“å„²å­˜å¤±æ•—"
                          RequiredPermission="Product.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          OnEntityLoaded="@HandleEntityLoaded"
                          CustomActionButtons="@CustomActionButtons" />

@* å•†å“åˆ†é¡ç·¨è¼¯ Modal *@
<ProductCategoryEditModalComponent @ref="productCategoryEditModal"
                                  IsVisible="@productCategoryModalManager.IsModalVisible"
                                  IsVisibleChanged="@productCategoryModalManager.HandleModalVisibilityChangedAsync"
                                  ProductCategoryId="@productCategoryModalManager.SelectedEntityId"
                                  PrefilledValues="@productCategoryModalManager.PrefilledValues"
                                  OnProductCategorySaved="@OnProductCategorySavedWrapper"
                                  OnCancel="@productCategoryModalManager.HandleModalCancelAsync" />

@* å–®ä½ç·¨è¼¯ Modal *@
<UnitEditModalComponent @ref="unitEditModal"
                       IsVisible="@unitModalManager.IsModalVisible"
                       IsVisibleChanged="@unitModalManager.HandleModalVisibilityChangedAsync"
                       UnitId="@unitModalManager.SelectedEntityId"
                       PrefilledValues="@unitModalManager.PrefilledValues"
                       OnUnitSaved="@OnUnitSavedWrapper"
                       OnCancel="@unitModalManager.HandleModalCancelAsync" />

@* å°ºå¯¸ç·¨è¼¯ Modal *@
<SizeEditModalComponent @ref="sizeEditModal"
                       IsVisible="@sizeModalManager.IsModalVisible"
                       IsVisibleChanged="@sizeModalManager.HandleModalVisibilityChangedAsync"
                       SizeId="@sizeModalManager.SelectedEntityId"
                       PrefilledValues="@sizeModalManager.PrefilledValues"
                       OnSizeSaved="@OnSizeSavedWrapper"
                       OnCancel="@sizeModalManager.HandleModalCancelAsync" />

@* å•†å“åˆæˆè¡¨ç·¨è¼¯ Modal *@
<ProductCompositionEditModalComponent @ref="productCompositionEditModal"
                                     IsVisible="@productCompositionModalManager.IsModalVisible"
                                     IsVisibleChanged="@productCompositionModalManager.HandleModalVisibilityChangedAsync"
                                     CompositionId="@productCompositionModalManager.SelectedEntityId"
                                     PrefilledValues="@productCompositionModalManager.PrefilledValues"
                                     OnCompositionSaved="@OnProductCompositionSavedWrapper"
                                     OnCancel="@productCompositionModalManager.HandleModalCancelAsync" />

<!-- ç›¸é—œå–®æ“šæŸ¥çœ‹ Modalï¼ˆåˆæˆè¡¨æ¸…å–®ï¼‰-->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick"
                               OnAddNew="@HandleAddNewComposition" />

@code {
    // ===== å¿…è¦åƒæ•¸ =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? ProductId { get; set; }
    [Parameter] public EventCallback<Product> OnProductSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== å…§éƒ¨ç‹€æ…‹ =====
    private GenericEditModalComponent<Product, IProductService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // æ¨™èªŒè®Šæ•¸ï¼Œç”¨æ–¼è¿½è¹¤æ˜¯å¦éœ€è¦åœ¨å¯¦é«”è¼‰å…¥å¾Œåˆ·æ–°æ¬„ä½
    private bool _entityLoadedButFieldsNotRefreshed = false;
    private bool _hasCheckedEntityLoad = false;
    
    //  å¿«å– ActionButtonsï¼Œé¿å…é‡è¤‡éåŒæ­¥è¼‰å…¥
    private List<FieldActionButton>? _cachedBarcodeActionButtons = null;
    private List<FieldActionButton>? _cachedProductCategoryActionButtons = null;
    private List<FieldActionButton>? _cachedSizeActionButtons = null;
    private List<FieldActionButton>? _cachedUnitActionButtons = null;
    
    // åŸå§‹è³‡æ–™é›†åˆï¼ˆç”¨æ–¼ AutoCompleteï¼‰
    private List<ProductCategory> availableProductCategories = new();
    private List<Supplier> availableSuppliers = new();
    private List<Unit> availableUnits = new();
    private List<Size> availableSizes = new();
    
    // AutoComplete é…ç½®
    private AutoCompleteConfig? autoCompleteConfig;
    
    // Modal ç®¡ç†å™¨
    private ProductCategoryEditModalComponent? productCategoryEditModal;
    private RelatedEntityModalManager<ProductCategory> productCategoryModalManager = default!;
    
    private UnitEditModalComponent? unitEditModal;
    private RelatedEntityModalManager<Unit> unitModalManager = default!;
    
    private SizeEditModalComponent? sizeEditModal;
    private RelatedEntityModalManager<Size> sizeModalManager = default!;
    
    private ProductCompositionEditModalComponent? productCompositionEditModal;
    private RelatedEntityModalManager<ProductComposition> productCompositionModalManager = default!;
    
    private ModalManagerCollection modalManagers = default!;
    
    // é¸é …æ¸…å–®ï¼ˆå‘ä¸‹ç›¸å®¹ï¼‰
    private List<SelectOption> productCategoryOptions = new();
    private List<SelectOption> supplierOptions = new();
    private List<SelectOption> unitOptions = new();
    private List<SelectOption> sizeOptions = new();
    
    // è³‡æ–™è¼‰å…¥ç‹€æ…‹æ¨™è¨˜
    private bool isDataLoaded = false;
    
    // ===== ç›¸é—œå–®æ“šæŸ¥çœ‹ï¼ˆåˆæˆè¡¨æ¸…å–®ï¼‰=====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;

    // ===== å¿…è¦æ–¹æ³• =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // ä½¿ç”¨ ModalManagerInitHelper åˆå§‹åŒ– Modal ç®¡ç†å™¨
            modalManagers = ModalManagerInitHelper.CreateBuilder<Product, IProductService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<ProductCategory>(nameof(Product.ProductCategoryId), "å•†å“é¡åˆ¥")
                .AddManager<Unit>(nameof(Product.UnitId), "å–®ä½")
                .AddManager<Size>(nameof(Product.SizeId), "å°ºå¯¸")
                .Build();
            productCategoryModalManager = modalManagers.Get<ProductCategory>(nameof(Product.ProductCategoryId));
            unitModalManager = modalManagers.Get<Unit>(nameof(Product.UnitId));
            sizeModalManager = modalManagers.Get<Size>(nameof(Product.SizeId));
            
            // åˆå§‹åŒ–å•†å“åˆæˆè¡¨ Modal ç®¡ç†å™¨ï¼ˆç¨ç«‹åˆå§‹åŒ–ï¼‰
            productCompositionModalManager = new RelatedEntityModalManager<ProductComposition>
            {
                NotificationService = NotificationService,
                EntityDisplayName = "å•†å“åˆæˆè¡¨",
                StateHasChangedCallback = StateHasChanged
            };
            
            // ç§»é™¤è‡ªå‹•è¼‰å…¥è³‡æ–™ï¼Œæ”¹ç‚ºåœ¨ OnParametersSetAsync ä¸­æ ¹æ“š IsVisible è¼‰å…¥
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–å•†å“ç·¨è¼¯çµ„ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            // é‡ç½®æ¨™èªŒï¼Œç¢ºä¿æ¯æ¬¡æ‰“é–‹Modalæ™‚éƒ½æœƒæª¢æŸ¥
            _entityLoadedButFieldsNotRefreshed = false;
            _hasCheckedEntityLoad = false;
            
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
        }
    }
    
    /// <summary>
    /// è™•ç†å¯¦é«”è¼‰å…¥å®Œæˆäº‹ä»¶ï¼ˆç”± GenericEditModalComponent çš„å°èˆªè§¸ç™¼ï¼‰
    /// ç•¶ä¸Šä¸‹ç­†åˆ‡æ›æ™‚è§¸ç™¼ UI æ›´æ–°ï¼Œç¢ºä¿è¡¨å–®æ¬„ä½æ­£ç¢ºæ¸²æŸ“
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            // å°æ–¼æ²’æœ‰æ˜ç´°çš„ç´”ä¸»æª”çµ„ä»¶ï¼Œåªéœ€è¦è§¸ç™¼ UI æ›´æ–°å³å¯
            StateHasChanged();
            await Task.CompletedTask;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// åœ¨çµ„ä»¶æ¸²æŸ“å¾Œæª¢æŸ¥å¯¦é«”æ˜¯å¦å·²è¼‰å…¥ï¼Œå¦‚æœæ˜¯å‰‡åˆ·æ–°å€‰åº«ä½ç½®
    /// </summary>
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // åªåœ¨ç·¨è¼¯æ¨¡å¼ä¸‹ä¸”å¯¦é«”å·²è¼‰å…¥ä½†é‚„æ²’æª¢æŸ¥éæ™‚åŸ·è¡Œ
        if (IsVisible && ProductId.HasValue && !_hasCheckedEntityLoad && 
            editModalComponent?.Entity != null && editModalComponent.Entity.Id > 0)
        {
            _hasCheckedEntityLoad = true;
            await RefreshFormFieldsAfterEntityLoadAsync();
        }
    }

    /// <summary>
    /// åœ¨å¯¦é«”è¼‰å…¥å¾Œé‡æ–°åˆå§‹åŒ–è¡¨å–®æ¬„ä½
    /// </summary>
    public async Task RefreshFormFieldsAfterEntityLoadAsync()
    {
        // é‡æ–°åˆå§‹åŒ–è¡¨å–®æ¬„ä½
        await InitializeFormFieldsAsync();
        
        StateHasChanged();
    }

    private async Task HandleSaveSuccess()
    {
        try
        {
            if (OnProductSaved.HasDelegate && editModalComponent?.Entity != null)
            {
                await OnProductSaved.InvokeAsync(editModalComponent.Entity);
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å„²å­˜æˆåŠŸå¾Œè™•ç†å¤±æ•—ï¼š{ex.Message}");
        }
    }

    private async Task HandleCancel()
    {
        try
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }
            await CloseModal();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å–æ¶ˆæ“ä½œå¤±æ•—ï¼š{ex.Message}");
        }
    }

    private async Task CloseModal()
    {
        try
        {
            if (IsVisibleChanged.HasDelegate)
            {
                await IsVisibleChanged.InvokeAsync(false);
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é—œé–‰è¦–çª—å¤±æ•—ï¼š{ex.Message}");
        }
    }

    private async Task<Product?> LoadProductData()
    {
        try
        {
            if (!ProductId.HasValue)
            {
                // æ–°å¢æ¨¡å¼ - å¾ç³»çµ±åƒæ•¸è¼‰å…¥é è¨­ç¨…ç‡
                var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();
                
                return new Product
                {
                    Status = EntityStatus.Active,
                    TaxRate = defaultTaxRate
                };
            }
            
            // ç·¨è¼¯æ¨¡å¼
            var product = await ProductService.GetByIdAsync(ProductId.Value);
            return product;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å•†å“è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return null;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // è¼‰å…¥å•†å“åˆ†é¡
            var productCategories = await ProductService.GetProductCategoriesAsync();
            availableProductCategories = productCategories;
            productCategoryOptions = productCategories.Select(pc => new SelectOption
            {
                Text = pc.Name,
                Value = pc.Id.ToString()
            }).ToList();

            // è¼‰å…¥ä¾›æ‡‰å•†
            var suppliers = await ProductService.GetSuppliersAsync();
            availableSuppliers = suppliers;
            supplierOptions = suppliers.Select(s => new SelectOption
            {
                Text = s.CompanyName,
                Value = s.Id.ToString()
            }).ToList();

            // è¼‰å…¥å–®ä½
            var units = await ProductService.GetUnitsAsync();
            availableUnits = units;
            unitOptions = units.Select(u => new SelectOption
            {
                Text = u.Name,
                Value = u.Id.ToString()
            }).ToList();

            // è¼‰å…¥å°ºå¯¸
            var sizes = await SizeService.GetActiveSizesAsync();
            availableSizes = sizes;
            sizeOptions = sizes.Select(s => new SelectOption
            {
                Text = s.Name,
                Value = s.Id.ToString()
            }).ToList();
            
            // é…ç½® AutoComplete
            autoCompleteConfig = new AutoCompleteConfigBuilder<Product>()
                .AddField(nameof(Product.ProductCategoryId), "Name", availableProductCategories)
                .AddField(nameof(Product.UnitId), "Name", availableUnits)
                .AddField(nameof(Product.SizeId), "Name", availableSizes)
                .Build();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥é¡å¤–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        //  é å…ˆè¼‰å…¥æ‰€æœ‰ ActionButtonsï¼ˆåªåœ¨å¿«å–ç‚ºç©ºæ™‚è¼‰å…¥ï¼‰
        if (_cachedBarcodeActionButtons == null)
        {
            _cachedBarcodeActionButtons = await GetBarcodeActionButtonsAsync();
        }
        if (_cachedProductCategoryActionButtons == null)
        {
            _cachedProductCategoryActionButtons = await GetProductCategoryActionButtonsAsync();
        }
        if (_cachedSizeActionButtons == null)
        {
            _cachedSizeActionButtons = await GetSizeActionButtonsAsync();
        }
        if (_cachedUnitActionButtons == null)
        {
            _cachedUnitActionButtons = await GetUnitActionButtonsAsync();
        }
        
        formFields = new List<FormFieldDefinition>
        {
            new()
            {
                PropertyName = nameof(Product.Code),
                Label = "å•†å“ä»£ç¢¼",
                FieldType = FormFieldType.Text,
                Placeholder = "è«‹è¼¸å…¥å•†å“ä»£ç¢¼",
                IsRequired = true,
                MaxLength = 50,
                HelpText = "å•†å“çš„å”¯ä¸€è­˜åˆ¥ç¢¼"
            },
            new()
            {
                PropertyName = nameof(Product.Name),
                Label = "å•†å“åç¨±",
                FieldType = FormFieldType.Text,
                Placeholder = "è«‹è¼¸å…¥å•†å“åç¨±",
                IsRequired = true,
                MaxLength = 100,
                HelpText = "å•†å“çš„å®Œæ•´åç¨±"
            },
            new FormFieldDefinition()
            {
                PropertyName = nameof(Product.Barcode),
                Label = "æ¢ç¢¼ç·¨è™Ÿ",
                FieldType = FormFieldType.Text,
                Placeholder = "è«‹è¼¸å…¥æ¢ç¢¼ç·¨è™Ÿ",
                IsRequired = true,
                MaxLength = 50,
                HelpText = "å•†å“çš„æ¢ç¢¼ç·¨è™Ÿ",
                ActionButtons = _cachedBarcodeActionButtons  //  ä½¿ç”¨å¿«å–
            },
            new()
            {
                PropertyName = nameof(Product.ProductCategoryId),
                Label = "å•†å“åˆ†é¡",
                FieldType = FormFieldType.AutoComplete,
                Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡å•†å“åˆ†é¡",
                IsRequired = true,
                MinSearchLength = 0,
                HelpText = "è¼¸å…¥åˆ†é¡åç¨±é€²è¡Œæœå°‹ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                ActionButtons = _cachedProductCategoryActionButtons  //  ä½¿ç”¨å¿«å–
            },
            new()
            {
                PropertyName = nameof(Product.SizeId),
                Label = "å°ºå¯¸",
                FieldType = FormFieldType.AutoComplete,
                Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡å°ºå¯¸",
                IsRequired = false,
                MinSearchLength = 0,
                HelpText = "è¼¸å…¥å°ºå¯¸åç¨±é€²è¡Œæœå°‹ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                ActionButtons = _cachedSizeActionButtons  //  ä½¿ç”¨å¿«å–
            },
            new()
            {
                PropertyName = nameof(Product.UnitId),
                Label = "å–®ä½",
                FieldType = FormFieldType.AutoComplete,
                Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡è¨ˆé‡å–®ä½",
                IsRequired = false,
                MinSearchLength = 0,
                HelpText = "è¼¸å…¥å–®ä½åç¨±é€²è¡Œæœå°‹ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                ActionButtons = _cachedUnitActionButtons  //  ä½¿ç”¨å¿«å–
            },
            new FormFieldDefinition()
            {
                PropertyName = nameof(Product.TaxRate),
                Label = "ç¨…ç‡%",
                FieldType = FormFieldType.Number,
                Placeholder = "è«‹è¼¸å…¥ç¨…ç‡",
                IsRequired = false,
                HelpText = "å•†å“çš„ç¨…ç‡ï¼Œä»‹æ–¼0åˆ°100ä¹‹é–“ï¼Œé è¨­å€¼ä¾†è‡ªç³»çµ±åƒæ•¸",
                Min = 0,
                Max = 100
            },
            new FormFieldDefinition()
            {
              PropertyName = nameof(Product.CanSchedule),  
                Label = "å¯æ’ç¨‹",
                FieldType = FormFieldType.Checkbox,
                IsRequired = false,
                HelpText = "æŒ‡ç¤ºå•†å“æ˜¯å¦å¯ç”¨æ–¼æ’ç¨‹"
            },
            new()
            {
                PropertyName = nameof(Product.Specification),
                Label = "è¦æ ¼èªªæ˜",
                FieldType = FormFieldType.Text,
                Placeholder = "è«‹è¼¸å…¥è¦æ ¼èªªæ˜",
                IsRequired = false,
                MaxLength = 100,
                ContainerCssClass = "col-6",
                HelpText = "å•†å“çš„è¦æ ¼èªªæ˜è³‡è¨Š"
            },

            FormFieldConfigurationHelper.CreateRemarksField<Product>(containerCssClass: "col-6")
        };

        formSections = FormSectionHelper<Product>.Create()
            .AddToSection(FormSectionNames.BasicInfo,
                p => p.Code,
                p => p.Name,
                p => p.Barcode,
                p => p.ProductCategoryId,
                p => p.SizeId,
                p => p.UnitId,
                p => p.TaxRate,
                p => p.CanSchedule)

            .AddToSection(FormSectionNames.AdditionalInfo,
                p => p.Specification,
                p => p.Remarks)
            .Build();
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }

    /// <summary>
    /// é…ç½® Modal ç®¡ç†å™¨
    /// </summary>
    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(Product.ProductCategoryId), productCategoryModalManager },
            { nameof(Product.UnitId), unitModalManager },
            { nameof(Product.SizeId), sizeModalManager }
        };
    }



    // ===== ActionButton ç”¢ç”Ÿæ–¹æ³• =====
    
    /// <summary>
    /// ç”¢ç”Ÿå•†å“åˆ†é¡æ“ä½œæŒ‰éˆ• - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetProductCategoryActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            productCategoryModalManager, 
            nameof(Product.ProductCategoryId)
        );
    }

    /// <summary>
    /// ç”¢ç”Ÿå–®ä½æ“ä½œæŒ‰éˆ• - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetUnitActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            unitModalManager, 
            nameof(Product.UnitId)
        );
    }

    /// <summary>
    /// ç”¢ç”Ÿå°ºå¯¸æ“ä½œæŒ‰éˆ• - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetSizeActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            sizeModalManager, 
            nameof(Product.SizeId)
        );
    }

    /// <summary>
    /// ç”¢ç”Ÿæ¢ç¢¼ç·¨è™Ÿæ“ä½œæŒ‰éˆ• - åŒå•†å“ç·¨è™Ÿ
    /// </summary>
    private Task<List<FieldActionButton>> GetBarcodeActionButtonsAsync()
    {
        var buttons = new List<FieldActionButton>
        {
            new FieldActionButton
            {
                Text = "è¤‡è£½",
                Variant = "OutlinePrimary",
                Size = "Small",
                Title = "å°‡å•†å“ç·¨è™Ÿè¤‡è£½åˆ°æ¢ç¢¼ç·¨è™Ÿ",
                OnClick = async () => await CopyCodeToBarcode(),
                IsDisabled = false
            }
        };
        
        return Task.FromResult(buttons);
    }

    /// <summary>
    /// å°‡å•†å“ç·¨è™Ÿè¤‡è£½åˆ°æ¢ç¢¼ç·¨è™Ÿæ¬„ä½
    /// </summary>
    private async Task CopyCodeToBarcode()
    {
        try
        {
            if (editModalComponent?.Entity != null)
            {
                // è¤‡è£½å•†å“ç·¨è™Ÿåˆ°æ¢ç¢¼ç·¨è™Ÿ
                editModalComponent.Entity.Barcode = editModalComponent.Entity.Code;
                
                // é€šçŸ¥ UI æ›´æ–°
                StateHasChanged();
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                await NotificationService.ShowSuccessAsync("å·²å°‡å•†å“ç·¨è™Ÿè¤‡è£½åˆ°æ¢ç¢¼ç·¨è™Ÿ");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¤‡è£½å•†å“ç·¨è™Ÿæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    // ===== Modal äº‹ä»¶åŒ…è£å™¨æ–¹æ³• =====
    
    /// <summary>
    /// åŒ…è£å•†å“åˆ†é¡å„²å­˜äº‹ä»¶
    /// </summary>
    private async Task OnProductCategorySavedWrapper(ProductCategory savedCategory)
    {
        await productCategoryModalManager.HandleEntitySavedAsync(savedCategory, shouldAutoSelect: true);
    }

    /// <summary>
    /// åŒ…è£å–®ä½å„²å­˜äº‹ä»¶
    /// </summary>
    private async Task OnUnitSavedWrapper(Unit savedUnit)
    {
        await unitModalManager.HandleEntitySavedAsync(savedUnit, shouldAutoSelect: true);
    }

    /// <summary>
    /// åŒ…è£å°ºå¯¸å„²å­˜äº‹ä»¶
    /// </summary>
    private async Task OnSizeSavedWrapper(Size savedSize)
    {
        await sizeModalManager.HandleEntitySavedAsync(savedSize, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// åŒ…è£å•†å“åˆæˆè¡¨å„²å­˜äº‹ä»¶
    /// </summary>
    private async Task OnProductCompositionSavedWrapper(ProductComposition savedComposition)
    {
        // åˆæˆè¡¨å„²å­˜å¾Œï¼Œä¸éœ€è¦è‡ªå‹•é¸æ“‡ï¼Œåªéœ€é‡æ–°è¼‰å…¥æ¸…å–®
        await NotificationService.ShowSuccessAsync("å•†å“åˆæˆè¡¨å·²å„²å­˜");
        
        // ğŸ“ æ”¹é€²ï¼šç„¡è«–æ¸…å–®æ˜¯å¦é–‹å•Ÿï¼Œéƒ½æ›´æ–°å¿«å–è³‡æ–™
        // é€™æ¨£ä¸‹æ¬¡é–‹å•Ÿæ¸…å–®æ™‚æœƒçœ‹åˆ°æœ€æ–°è³‡æ–™
        if (editModalComponent?.Entity != null)
        {
            // é‡æ–°è¼‰å…¥åˆæˆè¡¨æ¸…å–®è³‡æ–™ï¼ˆæ›´æ–°å¿«å–ï¼‰
            await LoadProductCompositions();
            
            // å¦‚æœæ¸…å–® Modal æ­£åœ¨é¡¯ç¤ºï¼Œè§¸ç™¼ UI æ›´æ–°
            if (showRelatedDocumentsModal)
            {
                StateHasChanged();
            }
        }
    }

    /// <summary>
    /// è™•ç†æ¬„ä½å€¼è®Šæ›´äº‹ä»¶ - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // åœ¨ç¬¬ä¸€æ¬¡æ¬„ä½è®Šæ›´æ™‚æª¢æŸ¥å¯¦é«”æ˜¯å¦å·²è¼‰å…¥ï¼Œå¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ä¸”å€‰åº«ä½ç½®æ¬„ä½éœ€è¦åˆ·æ–°ï¼Œå‰‡åˆ·æ–°
            if (!_entityLoadedButFieldsNotRefreshed && ProductId.HasValue && editModalComponent?.Entity != null)
            {
                _entityLoadedButFieldsNotRefreshed = true;
                await RefreshFormFieldsAfterEntityLoadAsync();
            }
            
            // ä½¿ç”¨çµ±ä¸€ Helper è™•ç†å•†å“åˆ†é¡æ¬„ä½è®Šæ›´
            if (fieldChange.PropertyName == nameof(Product.ProductCategoryId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    productCategoryModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
            }
            // ä½¿ç”¨çµ±ä¸€ Helper è™•ç†å–®ä½æ¬„ä½è®Šæ›´
            else if (fieldChange.PropertyName == nameof(Product.UnitId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    unitModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
            }
            // ä½¿ç”¨çµ±ä¸€ Helper è™•ç†å°ºå¯¸æ¬„ä½è®Šæ›´
            else if (fieldChange.PropertyName == nameof(Product.SizeId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    sizeModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
            }
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("æ¬„ä½è®Šæ›´è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    // ===== åˆæˆè¡¨ç›¸é—œæ–¹æ³• =====
    
    /// <summary>
    /// å–å¾—è‡ªè¨‚æ“ä½œæŒ‰éˆ•ï¼ˆé¡¯ç¤ºåœ¨ Modal é ‚éƒ¨å·¦å´ï¼‰- ä½œç‚ºå±¬æ€§ä»¥ç¢ºä¿æ­£ç¢ºçš„æ¸²æŸ“æ™‚æ©Ÿ
    /// </summary>
    private RenderFragment? CustomActionButtons => __builder =>
    {
        @* åˆæˆè¡¨æ“ä½œæŒ‰éˆ•çµ„ *@
        <div class="d-flex gap-2">
            @* æŸ¥çœ‹åˆæˆè¡¨æ¸…å–® *@
            <GenericButtonComponent
                Text="æŸ¥çœ‹åˆæˆ"
                OnClick="@ShowProductCompositions"
                Title="æŸ¥çœ‹å•†å“åˆæˆè¡¨æ¸…å–®"
                Variant="ButtonVariant.Blue"
                Size="ButtonSize.Small">
            </GenericButtonComponent>

            @* æ–°å¢åˆæˆè¡¨ *@
            <GenericButtonComponent
                Text="æ–°å¢åˆæˆ"
                OnClick="@HandleAddNewCompositionDirect"
                Title="ç›´æ¥æ–°å¢å•†å“åˆæˆè¡¨"
                Variant="ButtonVariant.DarkBlue"
                Size="ButtonSize.Small">
            </GenericButtonComponent>
        </div>
    };
    
    /// <summary>
    /// é¡¯ç¤ºå•†å“åˆæˆè¡¨æ¸…å–®
    /// </summary>
    private async Task ShowProductCompositions()
    {
        //  é—œéµæª¢æŸ¥ï¼šå•†å“å¿…é ˆå…ˆå„²å­˜
        if (editModalComponent?.Entity == null || editModalComponent.Entity.Id <= 0)
        {
            await NotificationService.ShowWarningAsync(
                "è«‹å…ˆå„²å­˜å•†å“å¾Œå†å»ºç«‹åˆæˆè¡¨", 
                "æç¤º");
            return;
        }
        
        selectedProductName = editModalComponent.Entity.Name ?? "æœªçŸ¥å•†å“";
        
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            await LoadProductCompositions();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥åˆæˆè¡¨æ¸…å–®å¤±æ•—ï¼š{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// è¼‰å…¥å•†å“åˆæˆè¡¨æ¸…å–®
    /// </summary>
    private async Task LoadProductCompositions()
    {
        if (editModalComponent?.Entity == null || editModalComponent.Entity.Id <= 0)
        {
            relatedDocuments = new List<RelatedDocument>();
            return;
        }
        
        relatedDocuments = await RelatedDocumentsHelper.GetProductCompositionsAsync(
            editModalComponent.Entity.Id);
    }
    
    /// <summary>
    /// è™•ç†é»æ“Šåˆæˆè¡¨é …ç›®ï¼ˆé–‹å•Ÿç·¨è¼¯ Modalï¼‰
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        if (document.DocumentType == RelatedDocumentType.ProductComposition)
        {
            // é–‹å•Ÿç·¨è¼¯ Modal
            await productCompositionModalManager.OpenModalAsync(document.DocumentId);
        }
    }
    
    /// <summary>
    /// è™•ç†æ–°å¢åˆæˆè¡¨æŒ‰éˆ•ï¼ˆå¾æ¸…å–® Modal çš„ Footer è§¸ç™¼ï¼‰
    /// </summary>
    private async Task HandleAddNewComposition()
    {
        if (editModalComponent?.Entity == null || editModalComponent.Entity.Id <= 0)
        {
            await NotificationService.ShowWarningAsync(
                "è«‹å…ˆå„²å­˜å•†å“å¾Œå†å»ºç«‹åˆæˆè¡¨", 
                "æç¤º");
            return;
        }
        
        // è¨­å®šé å¡«å€¼ï¼ˆä¸åŒ…å« Codeï¼Œè®“å­çµ„ä»¶è‡ªå‹•ç”¢ç”Ÿä»¥ç¢ºä¿å”¯ä¸€æ€§ï¼‰
        var prefilledValues = new Dictionary<string, object?>
        {
            { nameof(ProductComposition.ParentProductId), editModalComponent.Entity.Id }
        };
        
        // ä½¿ç”¨ OpenModalWithPrefilledValuesAsync é–‹å•Ÿæ–°å¢ Modal
        await productCompositionModalManager.OpenModalWithPrefilledValuesAsync(null, prefilledValues);
    }
    
    /// <summary>
    /// ç›´æ¥é–‹å•Ÿæ–°å¢åˆæˆè¡¨ Modalï¼ˆä¸ç¶“éæ¸…å–®ï¼Œç›´æ¥å¸¶å…¥å•†å“ï¼‰
    /// </summary>
    private async Task HandleAddNewCompositionDirect()
    {
        try
        {
            //  é—œéµæª¢æŸ¥ï¼šå•†å“å¿…é ˆå…ˆå„²å­˜
            if (editModalComponent?.Entity == null || editModalComponent.Entity.Id <= 0)
            {
                await NotificationService.ShowWarningAsync(
                    "è«‹å…ˆå„²å­˜å•†å“å¾Œå†å»ºç«‹åˆæˆè¡¨", 
                    "æç¤º");
                return;
            }
            
            //  ä½¿ç”¨çµ±ä¸€çš„ EntityCodeGenerationHelper ç”¢ç”Ÿåˆæˆè¡¨ä»£ç¢¼
            var newCode = await EntityCodeGenerationHelper.GenerateForEntity<ProductComposition, IProductCompositionService>(
                ProductCompositionService, "BOM");
            
            //  æ ¸å¿ƒï¼šè¨­å®šé å¡«å€¼ï¼Œè‡ªå‹•å¸¶å…¥å•†å“
            var prefilledValues = new Dictionary<string, object?>
            {
                { nameof(ProductComposition.ParentProductId), editModalComponent.Entity.Id },
                { nameof(ProductComposition.Code), newCode }
            };
            
            // ä½¿ç”¨ ModalManager é–‹å•Ÿæ–°å¢ Modal
            await productCompositionModalManager.OpenModalWithPrefilledValuesAsync(
                entityId: null,  // null = æ–°å¢æ¨¡å¼
                prefilledValues: prefilledValues
            );
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é–‹å•Ÿæ–°å¢åˆæˆè¡¨è¦–çª—å¤±æ•—ï¼š{ex.Message}");
        }
    }
}

