@* 待排程明細表格 - 左側顯示可選擇的訂單明細列表（以商品為核心） *@
@using ERPCore2.Components.Shared.UI.Button
@using ERPCore2.Helpers.InteractiveTableComponentHelper
@using ERPCore2.Models
@using ERPCore2.Helpers
@inject IStringLocalizer<SharedResource> L

<div class="card h-100">
    <div class="card-header bg-primary text-white py-2">
        <div class="d-flex justify-content-between align-items-center">
            <span class="fw-bold"><i class="bi bi-box-seam me-2"></i>@L["Production.PendingDetails"]</span>
            <span class="text-white-50">@FilteredDetailsList.Count @L["Label.ItemCount"]</span>
        </div>
    </div>
    
    <div class="card-body p-2">
        @* 篩選區域 *@
        <div class="mb-2">
            <SearchInputComponent @bind-Value="searchKeyword"
                                  Placeholder="@L["Placeholder.SearchProductOrderCustomer"]"
                                  ButtonSize="btn-sm" />
        </div>
        
        @* 明細列表 - 使用 InteractiveTableComponent *@
        <div style="max-height: 350px; overflow: auto;">
            <InteractiveTableComponent TItem="PendingScheduleDetailDto"
                                       Items="@FilteredDetailsList"
                                       ColumnDefinitions="@GetColumnDefinitions()"
                                       ShowHeader="true"
                                       ShowActions="false"
                                       ShowRowNumbers="false"
                                       IsStriped="true"
                                       IsHoverable="true"
                                       IsBordered="true"
                                       EmptyMessage="@GetEmptyMessage()"
                                       EnableRowClick="true"
                                       OnRowClick="HandleRowClick"
                                       RowClickCursor="pointer"
                                       EnableDrag="true"
                                       DragDropGroup="production-schedule"
                                       TableId="detail-table"
                                       OnDragStart="HandleDragStart"
                                       CssClass="mb-0 table-sm" />
        </div>
    </div>
</div>

@code {
    // ===== 參數 =====
    
    /// <summary>
    /// 待排程明細列表
    /// </summary>
    [Parameter] public List<PendingScheduleDetailDto> Details { get; set; } = new();
    
    /// <summary>
    /// 是否正在載入
    /// </summary>
    [Parameter] public bool IsLoading { get; set; }
    
    /// <summary>
    /// 當選擇明細時觸發（直接加入排程）
    /// </summary>
    [Parameter] public EventCallback<PendingScheduleDetailDto> OnDetailSelected { get; set; }
    
    /// <summary>
    /// 當需要重新載入資料時觸發
    /// </summary>
    [Parameter] public EventCallback OnRefreshRequested { get; set; }
    
    // ===== 內部狀態 =====
    private string searchKeyword = string.Empty;
    
    /// <summary>
    /// 篩選後的明細列表
    /// </summary>
    private List<PendingScheduleDetailDto> FilteredDetailsList
    {
        get
        {
            var result = Details.AsEnumerable();
            
            // 關鍵字搜尋（商品、訂單編號、客戶）
            if (!string.IsNullOrWhiteSpace(searchKeyword))
            {
                var keyword = searchKeyword.Trim().ToLower();
                result = result.Where(d => 
                    d.ProductCode.ToLower().Contains(keyword) ||
                    d.ProductName.ToLower().Contains(keyword) ||
                    d.SalesOrderCode.ToLower().Contains(keyword) ||
                    d.CustomerName.ToLower().Contains(keyword));
            }
            
            // 按商品編號排序，相同商品再按訂單日期排序
            return result
                .OrderBy(d => d.ProductCode)
                .ThenByDescending(d => d.OrderDate)
                .ToList();
        }
    }
    
    // ===== 表格欄位定義 =====
    
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = L["Column.ProductCode"],
                PropertyName = nameof(PendingScheduleDetailDto.ProductCode),
                ColumnType = InteractiveColumnType.Display,
                Width = "14%",
                CellCssClass = "text-primary fw-bold span"
            },
            new()
            {
                Title = L["Column.ProductName"],
                PropertyName = nameof(PendingScheduleDetailDto.ProductName),
                ColumnType = InteractiveColumnType.Custom,
                Width = "20%",
                CustomTemplate = item =>
                {
                    var detail = (PendingScheduleDetailDto)item;
                    return @<span class="text-truncate d-block" style="max-width: 120px;" title="@detail.ProductName">@detail.ProductName</span>;
                }
            },
            new()
            {
                Title = L["Column.OrderDay"],
                PropertyName = nameof(PendingScheduleDetailDto.OrderDate),
                ColumnType = InteractiveColumnType.Custom,
                Width = "12%",
                CustomTemplate = item =>
                {
                    var detail = (PendingScheduleDetailDto)item;
                    return @<span class="text-muted">@detail.OrderDate.ToString("MM/dd")</span>;
                }
            },
            new()
            {
                Title = L["Column.DeliveryDay"],
                PropertyName = nameof(PendingScheduleDetailDto.ExpectedDeliveryDate),
                ColumnType = InteractiveColumnType.Custom,
                Width = "12%",
                CustomTemplate = item =>
                {
                    var detail = (PendingScheduleDetailDto)item;
                    if (detail.ExpectedDeliveryDate.HasValue)
                    {
                        return @<span class="text-info">@detail.ExpectedDeliveryDate.Value.ToString("MM/dd")</span>;
                    }
                    return @<span class="text-muted">-</span>;
                }
            },
            new()
            {
                Title = L["Column.Customer"],
                PropertyName = nameof(PendingScheduleDetailDto.CustomerName),
                ColumnType = InteractiveColumnType.Custom,
                Width = "18%",
                CustomTemplate = item =>
                {
                    var detail = (PendingScheduleDetailDto)item;
                    return @<span class="text-truncate d-block" style="max-width: 100px;" title="@detail.CustomerName">@detail.CustomerName</span>;
                }
            },
            new()
            {
                Title = L["Column.OrderQty"],
                PropertyName = nameof(PendingScheduleDetailDto.OrderQuantity),
                ColumnType = InteractiveColumnType.Display,
                Width = "14%",
                TextAlign = "right",
                SmartDecimalDisplay = true,
                CellCssClass = "fw-bold span"
            }
        };
    }
    
    private string GetEmptyMessage()
    {
        return IsLoading ? L["Label.Loading"].ToString() : L["Message.NoPendingDetails"].ToString();
    }
    
    // ===== 事件處理 =====
    
    private void ClearSearch()
    {
        searchKeyword = string.Empty;
        StateHasChanged();
    }
    
    private async Task RefreshData()
    {
        if (OnRefreshRequested.HasDelegate)
        {
            await OnRefreshRequested.InvokeAsync();
        }
    }
    
    // ===== 公開方法 =====
    
    /// <summary>
    /// 清除篩選條件
    /// </summary>
    public void ClearFilters()
    {
        searchKeyword = string.Empty;
        StateHasChanged();
    }
    
    // ===== 拖放事件處理 =====
    
    private void HandleDragStart(PendingScheduleDetailDto detail)
    {
        // 拖曳開始時的處理（如需要可在此加入額外邏輯）
        // DragDropState 已由 InteractiveTableComponent 自動設定
    }
    
    // ===== 行點擊事件處理 =====
    
    /// <summary>
    /// 處理行點擊事件 - 直接觸發明細選擇
    /// </summary>
    private async Task HandleRowClick(PendingScheduleDetailDto detail)
    {
        if (OnDetailSelected.HasDelegate)
        {
            await OnDetailSelected.InvokeAsync(detail);
        }
    }
}
