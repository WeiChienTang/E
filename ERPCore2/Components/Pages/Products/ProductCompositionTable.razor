@* 商品合成明細管理組件 - 管理配方的材料清單 - 使用 InteractiveTableComponent 統一UI *@

@inject INotificationService NotificationService
@inject IProductService ProductService
@inject IUnitService UnitService
@inject IProductCategoryService ProductCategoryService
@using ERPCore2.Helpers
@using ERPCore2.Data.Entities

@if (!IsReadOnly)
{
    <div class="mb-2">
        <GenericButtonComponent Variant="ButtonVariant.DarkBlue"
                                Size="ButtonSize.Small"
                                Text="批量選擇"
                                OnClick="OpenProductPicker" />
    </div>
}

<ProductPickerModal IsVisible="@_showProductPicker"
                   AvailableProducts="@GetAvailableProducts()"
                   AvailableCategories="@AvailableCategories"
                   AvailableUnits="@AvailableUnits"
                   AlreadyAddedProductIds="@GetAlreadyAddedProductIds()"
                   OnConfirmed="@HandleProductsSelected"
                   OnCancelled="@(() => _showProductPicker = false)" />

<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <InteractiveTableComponent TItem="CompositionItem" 
                                  Items="@CompositionItems"
                                  ColumnDefinitions="@GetColumnDefinitions()"
                                  IsReadOnly="@IsReadOnly"
                                  ShowRowNumbers="true"
                                  EmptyMessage="@EmptyMessage"
                                  ShowBuiltInActions="true"
                                  ShowBuiltInDeleteButton="true"
                                  OnItemDelete="@HandleItemDelete"
                                  EnableAutoEmptyRow="true"
                                  AllowAddNewRow="@(!IsReadOnly)"
                                  DataLoadCompleted="@_dataLoadCompleted"
                                  CreateEmptyItem="@(() => new CompositionItem())" />
    </div>
</div>

@code {
    // ===== 私有欄位 =====
    private readonly HashSet<int> _deletedDetailIds = new HashSet<int>();
    private bool _dataLoadCompleted = true;  // 資料載入完成標記
    private bool _showProductPicker = false;  // 批量選擇器顯示控制
    
    // ===== 內部資料清單 =====
    private List<CompositionItem> CompositionItems { get; set; } = new();

    // ===== 基本參數 =====
    [Parameter] public List<ProductCompositionDetail> Items { get; set; } = new();
    [Parameter] public List<Product> AvailableProducts { get; set; } = new(); // 可選擇的商品清單
    [Parameter] public List<Unit> AvailableUnits { get; set; } = new(); // 可選擇的單位清單
    [Parameter] public List<ProductCategory> AvailableCategories { get; set; } = new(); // 可選擇的商品類別（批量選擇器使用）
    [Parameter] public int ParentEntityId { get; set; }
    [Parameter] public int ParentProductId { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== 現有明細（用於編輯模式） =====
    [Parameter] public List<ProductCompositionDetail>? ExistingDetails { get; set; }
    
    // ===== 顯示設定 =====
    [Parameter] public string Title { get; set; } = "材料清單";
    [Parameter] public string Subtitle { get; set; } = "";
    [Parameter] public string Icon { get; set; } = "box-seam";
    [Parameter] public string ItemDisplayName { get; set; } = "材料";
    [Parameter] public string EmptyIcon { get; set; } = "box-seam-x";
    [Parameter] public string EmptyMessage { get; set; } = "尚未新增材料";
    
    // ===== 事件參數 =====
    [Parameter] public EventCallback<List<ProductCompositionDetail>> ItemsChanged { get; set; }
    [Parameter] public EventCallback<ProductCompositionDetail> ItemAdded { get; set; }
    [Parameter] public EventCallback<ProductCompositionDetail> ItemRemoved { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    
    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        
        // 載入可用的商品和單位清單
        await LoadAvailableDataAsync();
        
        // 載入現有明細（編輯模式）
        await LoadExistingDetailsAsync();
        
        // 同步 Items 到 CompositionItems（當父組件直接設定 Items 時）
        SyncItemsToCompositionItems();
    }
    
    /// <summary>
    /// 同步 Items 到 CompositionItems
    /// </summary>
    private void SyncItemsToCompositionItems()
    {
        // 如果 Items 有資料但 CompositionItems 為空，進行同步
        if (Items.Any() && !CompositionItems.Any())
        {
            foreach (var detail in Items.Where(d => d.ComponentProduct != null))
            {
                CompositionItems.Add(new CompositionItem
                {
                    SelectedProduct = detail.ComponentProduct,
                    ProductSearchValue = GetProductDisplayText(detail.ComponentProduct!),
                    Quantity = detail.Quantity,
                    UnitId = detail.UnitId,
                    Unit = detail.Unit,
                    ExistingDetailEntity = detail
                });
            }
        }
    }

    // ===== 資料載入 =====
    private async Task LoadAvailableDataAsync()
    {
        try
        {
            if (!AvailableProducts.Any())
            {
                AvailableProducts = await ProductService.GetAllAsync();
            }

            if (!AvailableUnits.Any())
            {
                AvailableUnits = await UnitService.GetAllAsync();
            }

            if (!AvailableCategories.Any())
            {
                AvailableCategories = await ProductCategoryService.GetAllAsync();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入資料時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 載入現有明細（編輯模式）
    /// </summary>
    private Task LoadExistingDetailsAsync()
    {
        if (ExistingDetails?.Any() != true) return Task.CompletedTask;

        //  開始載入資料 - 設定為未完成
        _dataLoadCompleted = false;
        
        Items.Clear();
        CompositionItems.Clear();
        
        foreach (var detail in ExistingDetails)
        {
            Items.Add(detail);
            
            // 同步建立 CompositionItem
            if (detail.ComponentProduct != null)
            {
                CompositionItems.Add(new CompositionItem
                {
                    SelectedProduct = detail.ComponentProduct,
                    ProductSearchValue = GetProductDisplayText(detail.ComponentProduct),
                    Quantity = detail.Quantity,
                    UnitId = detail.UnitId,
                    Unit = detail.Unit,
                    ExistingDetailEntity = detail
                });
            }
        }
        
        //  資料載入完成 - 觸發空行檢查
        _dataLoadCompleted = true;
        StateHasChanged();
        
        return Task.CompletedTask;
    }

    // ===== InteractiveTableComponent 方法 =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            // 材料商品選擇欄位 - 使用 SearchableSelect
            new() 
            { 
                Title = "材料編號/名稱", 
                Tooltip = "搜尋並選擇材料（輸入編號或名稱）",
                PropertyName = nameof(CompositionItem.ProductSearchValue),
                EmptyCheckPropertyName = nameof(CompositionItem.SelectedProduct),
                TriggerEmptyRowOnFilled = true,
                ColumnType = InteractiveColumnType.SearchableSelect,
                Width = "300px",
                Placeholder = "請輸入材料編號或名稱",
                SearchValuePropertyName = nameof(CompositionItem.ProductSearchValue),
                FilteredItemsPropertyName = nameof(CompositionItem.FilteredProducts),
                ShowDropdownPropertyName = nameof(CompositionItem.ShowProductDropdown),
                SelectedIndexPropertyName = nameof(CompositionItem.ProductSelectedIndex),
                ItemDisplayFormatter = (item) =>
                {
                    var product = (Product)item;
                    return GetProductDisplayText(product);
                },
                IsDisabledFunc = item => IsReadOnly,
                OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, (tuple) =>
                {
                    var (item, searchValue) = tuple;
                    OnProductSearchChanged((CompositionItem)item, searchValue);
                }),
                OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
                {
                    var (item, selectedItem) = tuple;
                    await OnProductSelected((CompositionItem)item, (Product?)selectedItem);
                }),
                OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
                {
                    var compositionItem = (CompositionItem)item;
                    var availableProducts = GetAvailableProducts();
                    compositionItem.FilteredProducts = availableProducts.Take(20).ToList();
                    compositionItem.ShowProductDropdown = true;
                    compositionItem.ProductSelectedIndex = -1;
                    StateHasChanged();
                }),
                OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
                {
                    Task.Delay(200).ContinueWith(_ =>
                    {
                        var compositionItem = (CompositionItem)item;
                        compositionItem.ShowProductDropdown = false;
                        InvokeAsync(StateHasChanged);
                    });
                }),
                EnableKeyboardNavigation = true,
                GetDropdownItems = (item) => ((CompositionItem)item).FilteredProducts,
                GetSelectedIndex = (item) => ((CompositionItem)item).ProductSelectedIndex,
                SetSelectedIndex = (item, index) => ((CompositionItem)item).ProductSelectedIndex = index,
                GetShowDropdown = (item) => ((CompositionItem)item).ShowProductDropdown,
                SetShowDropdown = (item, show) => ((CompositionItem)item).ShowProductDropdown = show,
                MaxDisplayItems = 20
            },
            
            // 製程單位 - 唯讀顯示
            new() 
            { 
                Title = "製程單位", 
                Tooltip = "材料的製程單位（由商品設定決定）",
                PropertyName = "ProductionUnitName",
                ColumnType = InteractiveColumnType.Display,
                Width = "100px",
                DisplayFormatter = (item) => GetProductionUnitName((CompositionItem)item!),
                ExcludeFromEmptyCheck = true  // 唯讀欄位不參與空行檢查
            },
            
            // 所需數量 - 數字輸入
            new() 
            { 
                Title = "所需數量", 
                Tooltip = "輸入此材料所需的數量",
                PropertyName = nameof(CompositionItem.Quantity),
                ColumnType = InteractiveColumnType.Number,
                Width = "120px",
                CellCssClass = "text-end",
                MinValue = 0,
                OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
                {
                    var (item, value) = args;
                    await OnQuantityChanged((CompositionItem)item, value);
                })
            },
        };
    }

    private async Task HandleItemDelete(CompositionItem item)
    {
        var index = CompositionItems.IndexOf(item);
        await RemoveItemAsync(index);
    }

    // ===== 內部方法 =====

    private string GetProductDisplayText(Product product)
    {
        if (!string.IsNullOrWhiteSpace(product.Code))
        {
            return $"{product.Code} - {product.Name}";
        }
        return product.Name;
    }

    /// <summary>
    /// 取得材料的製程單位名稱
    /// </summary>
    private string GetProductionUnitName(CompositionItem item)
    {
        // 如果沒有選擇材料，回傳空字串
        if (item.SelectedProduct == null)
        {
            return string.Empty;
        }
        
        // 優先使用製程單位，若無則使用商品單位
        var productionUnitId = item.SelectedProduct.ProductionUnitId ?? item.SelectedProduct.UnitId;
        
        if (productionUnitId <= 0)
        {
            return string.Empty;
        }
        
        // 從可用單位清單中查找單位名稱
        var unit = AvailableUnits.FirstOrDefault(u => u.Id == productionUnitId);
        return unit?.Name ?? string.Empty;
    }
    
    /// <summary>
    /// 取得可用商品列表（排除主檔商品，避免循環參考）
    /// </summary>
    private List<Product> GetAvailableProducts()
    {
        return AvailableProducts
            .Where(p => p.Id != ParentProductId)
            .ToList();
    }

    // ===== 批量選擇器方法 =====

    private void OpenProductPicker() => _showProductPicker = true;

    /// <summary>
    /// 取得已加入材料清單的商品 ID 集合（供批量選擇器標記「已加入」）
    /// </summary>
    private HashSet<int> GetAlreadyAddedProductIds()
    {
        return CompositionItems
            .Where(i => i.SelectedProduct != null)
            .Select(i => i.SelectedProduct!.Id)
            .ToHashSet();
    }

    /// <summary>
    /// 批量選擇器確認後，將選中的商品批量加入材料清單
    /// </summary>
    private async Task HandleProductsSelected(List<Product> selectedProducts)
    {
        _showProductPicker = false;

        var alreadyAdded = GetAlreadyAddedProductIds();
        foreach (var product in selectedProducts.Where(p => !alreadyAdded.Contains(p.Id)))
        {
            var item = new CompositionItem
            {
                SelectedProduct = product,
                ProductSearchValue = GetProductDisplayText(product),
                Quantity = 1,
                UnitId = product.UnitId > 0 ? product.UnitId : null,
                Unit = product.UnitId > 0 ? AvailableUnits.FirstOrDefault(u => u.Id == product.UnitId) : null
            };
            CompositionItems.Add(item);
        }

        await NotifyItemsChanged();
    }

    // ===== SearchableSelect 事件處理 =====
    
    /// <summary>
    /// 商品搜尋輸入變更事件
    /// </summary>
    private void OnProductSearchChanged(CompositionItem item, string? searchValue)
    {
        item.ProductSearchValue = searchValue ?? string.Empty;
        
        var availableProducts = GetAvailableProducts();
        
        if (string.IsNullOrWhiteSpace(searchValue))
        {
            // 空白搜尋：顯示前20筆
            item.FilteredProducts = availableProducts.Take(20).ToList();
        }
        else
        {
            // 篩選符合的商品（編號或名稱包含搜尋字串）
            item.FilteredProducts = availableProducts
                .Where(p => (p.Code?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                           (p.Name?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false))
                .Take(20)
                .ToList();
        }
        
        item.ShowProductDropdown = true;
        item.ProductSelectedIndex = -1;
        StateHasChanged();
    }
    
    /// <summary>
    /// 商品選擇事件
    /// </summary>
    private async Task OnProductSelected(CompositionItem item, Product? selectedProduct)
    {
        if (selectedProduct != null)
        {
            // 檢查是否選到與成品相同的商品（避免循環參考）
            if (ParentProductId > 0 && selectedProduct.Id == ParentProductId)
            {
                await NotificationService.ShowErrorAsync("此材料不能是成品本身，請選擇其他材料");
                item.SelectedProduct = null;
                item.ProductSearchValue = string.Empty;
                StateHasChanged();
                return;
            }
            
            // 檢查是否已存在相同材料
            var existingProductIds = CompositionItems
                .Where(i => i != item && i.SelectedProduct != null)
                .Select(i => i.SelectedProduct!.Id);
            
            if (existingProductIds.Contains(selectedProduct.Id))
            {
                await NotificationService.ShowErrorAsync("此材料已存在，請選擇其他材料");
                item.SelectedProduct = null;
                item.ProductSearchValue = string.Empty;
            }
            else
            {
                item.SelectedProduct = selectedProduct;
                item.ProductSearchValue = GetProductDisplayText(selectedProduct);
                
                // 自動設定該商品的預設單位
                if (selectedProduct.UnitId > 0)
                {
                    item.UnitId = selectedProduct.UnitId;
                    item.Unit = await UnitService.GetByIdAsync(selectedProduct.UnitId);
                }
            }
        }
        else
        {
            item.SelectedProduct = null;
            item.ProductSearchValue = string.Empty;
        }
        
        item.ShowProductDropdown = false;
        item.ProductSelectedIndex = -1;
        
        await NotifyItemsChanged();
    }
    
    /// <summary>
    /// 數量變更事件
    /// </summary>
    private async Task OnQuantityChanged(CompositionItem item, string? value)
    {
        item.Quantity = InputEventHelper.HandleQuantityInput(value);
        await NotifyItemsChanged();
    }
    
    /// <summary>
    /// 通知父組件明細已變更
    /// </summary>
    private async Task NotifyItemsChanged()
    {
        // 將 CompositionItems 轉換回 ProductCompositionDetail
        var details = ConvertToDetailEntities();
        Items.Clear();
        Items.AddRange(details);
        
        await DetailSyncHelper.SyncToParentAsync(Items, ItemsChanged);
        StateHasChanged();
    }
    
    /// <summary>
    /// 轉換 CompositionItems 為明細實體列表
    /// </summary>
    private List<ProductCompositionDetail> ConvertToDetailEntities()
    {
        var details = new List<ProductCompositionDetail>();
        
        foreach (var item in CompositionItems.Where(x => x.SelectedProduct != null))
        {
            ProductCompositionDetail detail;
            
            if (item.ExistingDetailEntity != null)
            {
                detail = item.ExistingDetailEntity;
            }
            else
            {
                detail = new ProductCompositionDetail
                {
                    ProductCompositionId = ParentEntityId
                };
            }
            
            detail.ComponentProductId = item.SelectedProduct!.Id;
            detail.ComponentProduct = item.SelectedProduct;
            detail.Quantity = item.Quantity;
            detail.UnitId = item.UnitId;
            detail.Unit = item.Unit;
            
            details.Add(detail);
        }
        
        return details;
    }
    
    public async Task RemoveItemAsync(int index)
    {
        if (IsReadOnly || index < 0 || index >= CompositionItems.Count) return;
        
        var removedItem = CompositionItems[index];
        if (removedItem == null) return;
        
        // 記錄要刪除的資料庫實體ID
        if (removedItem.ExistingDetailEntity?.Id > 0)
        {
            _deletedDetailIds.Add(removedItem.ExistingDetailEntity.Id);
        }
        
        CompositionItems.Remove(removedItem);
        
        // 同步更新 Items
        await NotifyItemsChanged();
        
        if (removedItem.ExistingDetailEntity != null)
        {
            await ItemRemoved.InvokeAsync(removedItem.ExistingDetailEntity);
        }
        
        // 通知已刪除的明細ID
        await NotifyDeletedDetailsChanged();
        
        StateHasChanged();
    }
    
    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        //  取得非空的項目（檢查 SelectedProduct）
        var nonEmptyItems = CompositionItems.Where(item => item.SelectedProduct != null).ToList();
        
        if (!nonEmptyItems.Any())
        {
            errors.Add("至少需要一個材料");
        }
        else
        {
            // 檢查重複材料
            var productIds = nonEmptyItems.Select(item => item.SelectedProduct!.Id).ToList();
            if (productIds.Count != productIds.Distinct().Count())
            {
                errors.Add("存在重複的材料");
            }
            
            // 檢查數量是否有效
            var invalidQuantities = nonEmptyItems.Where(item => item.Quantity <= 0).ToList();
            if (invalidQuantities.Any())
            {
                errors.Add("所有材料的數量必須大於 0");
            }

            // 檢查是否包含成品本身（避免循環參考）
            if (ParentProductId > 0)
            {
                var containsParent = nonEmptyItems.Any(item => item.SelectedProduct!.Id == ParentProductId);
                if (containsParent)
                {
                    errors.Add("明細中不能包含成品本身");
                }
            }
        }
          
        if (errors.Any())
        {
            var errorMessage = string.Join("\n", errors);
            await NotificationService.ShowErrorAsync(errorMessage);
            return false;
        }
        
        return true;
    }
    
    /// <summary>
    /// 通知已刪除的明細ID
    /// </summary>
    private async Task NotifyDeletedDetailsChanged()
    {
        if (OnDeletedDetailsChanged.HasDelegate && _deletedDetailIds.Any())
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds.ToList());
            _deletedDetailIds.Clear(); // 清空已通知的刪除ID
        }
    }
    
    /// <summary>
    /// 公開的刷新方法，用於外部觸發明細刷新（例如：上下筆切換時）
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadExistingDetailsAsync();
        StateHasChanged();
    }
    
    /// <summary>
    /// 取得非空的明細項目（供父組件使用）
    /// </summary>
    public List<ProductCompositionDetail> GetNonEmptyItems()
    {
        //  檢查 SelectedProduct
        return ConvertToDetailEntities();
    }
    
    /// <summary>
    /// 取得已刪除的明細ID清單（供父組件使用）
    /// </summary>
    public List<int> GetDeletedDetailIds()
    {
        return _deletedDetailIds.ToList();
    }
    
    // ===== CompositionItem Wrapper Class =====
    
    /// <summary>
    /// 材料項目包裝類別，用於 SearchableSelect 功能
    /// </summary>
    public class CompositionItem
    {
        public Product? SelectedProduct { get; set; }
        public decimal Quantity { get; set; } = 0;
        public int? UnitId { get; set; }
        public Unit? Unit { get; set; }
        public ProductCompositionDetail? ExistingDetailEntity { get; set; }
        
        // SearchableSelect 支援屬性
        public string ProductSearchValue { get; set; } = string.Empty;
        public List<Product> FilteredProducts { get; set; } = new();
        public bool ShowProductDropdown { get; set; } = false;
        public int ProductSelectedIndex { get; set; } = -1;
    }
}
