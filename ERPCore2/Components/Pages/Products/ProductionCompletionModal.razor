@* 生產完工登錄 Modal - 登錄生產完成數量並處理入庫 *@
@using ERPCore2.Components.Shared.UI.Button
@using ERPCore2.Data.Entities
@using ERPCore2.Models.Enums
@inject IProductionScheduleItemService ProductionScheduleItemService
@inject IProductionScheduleCompletionService ProductionScheduleCompletionService
@inject IProductionScheduleDetailService ProductionScheduleDetailService
@inject IInventoryStockService InventoryStockService
@inject IWarehouseService WarehouseService
@inject IWarehouseLocationService WarehouseLocationService
@inject IEmployeeService EmployeeService
@inject INotificationService NotificationService

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@GetModalTitle()"
                   Icon="bi bi-check2-square"
                   HeaderColor="BaseModalComponent.HeaderVariant.Success"
                   ShowFooter="false"
                   CloseOnBackdropClick="false"
                   CloseOnEscape="true"
                   IsLoading="@isLoading"
                   LoadingMessage="處理中..."
                   HeaderButtons="@HeaderButtons"
                   BodyContent="@BodyContent" />

@code {
    // ===== 參數定義 =====
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    
    /// <summary>
    /// 排程項目 ID
    /// </summary>
    [Parameter] public int? ProductionScheduleItemId { get; set; }
    
    /// <summary>
    /// 完工登錄成功回調
    /// </summary>
    [Parameter] public EventCallback<ProductionScheduleCompletion> OnCompletionRecorded { get; set; }
    
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== 私有欄位 =====
    private bool isLoading = false;
    private ProductionScheduleItem? scheduleItem;
    private List<ProductionScheduleDetail> scheduleDetails = new();
    
    // 完工登錄資訊
    private decimal completionQuantity = 0;
    private int? targetWarehouseId;
    private int? targetWarehouseLocationId;
    private int? operatorEmployeeId;
    private string? remarks;
    private bool autoCreateInventory = true;
    
    // 參考資料
    private List<Warehouse> availableWarehouses = new();
    private List<WarehouseLocation> availableLocations = new();
    private List<Employee> availableEmployees = new();

    // ===== 計算屬性 =====
    private decimal RemainingQuantity => scheduleItem != null 
        ? Math.Max(0, scheduleItem.ScheduledQuantity - scheduleItem.CompletedQuantity) 
        : 0;
    
    private bool CanSubmit => completionQuantity > 0 && completionQuantity <= RemainingQuantity;

    // ===== 生命週期 =====
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && ProductionScheduleItemId.HasValue)
        {
            await LoadDataAsync();
        }
        else if (!IsVisible)
        {
            ResetForm();
        }
    }

    private void ResetForm()
    {
        completionQuantity = 0;
        targetWarehouseId = null;
        targetWarehouseLocationId = null;
        operatorEmployeeId = null;
        remarks = null;
        autoCreateInventory = true;
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // 載入參考資料
            availableWarehouses = await WarehouseService.GetAllAsync();
            // 載入員工列表（排除超級管理員）
            var allEmployees = await EmployeeService.GetAllAsync();
            availableEmployees = allEmployees.Where(e => !e.IsSuperAdmin).ToList();
            
            // 載入排程項目
            if (ProductionScheduleItemId.HasValue)
            {
                scheduleItem = await ProductionScheduleItemService.GetByIdAsync(ProductionScheduleItemId.Value);
                
                if (scheduleItem != null)
                {
                    // 預設完工數量為剩餘數量
                    completionQuantity = RemainingQuantity;
                    
                    // 預設倉庫為排程項目的目標倉庫
                    targetWarehouseId = scheduleItem.WarehouseId;
                    
                    // 載入組件明細
                    scheduleDetails = await ProductionScheduleDetailService.GetByScheduleItemIdAsync(ProductionScheduleItemId.Value);
                    
                    // 載入倉位
                    if (targetWarehouseId.HasValue)
                    {
                        await LoadLocationsAsync(targetWarehouseId.Value);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入失敗：{ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadLocationsAsync(int warehouseId)
    {
        try
        {
            var result = await WarehouseLocationService.GetByWarehouseIdAsync(warehouseId);
            availableLocations = result.IsSuccess && result.Data != null 
                ? result.Data.ToList() 
                : new();
        }
        catch
        {
            availableLocations = new();
        }
    }

    private async Task OnWarehouseChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var warehouseId))
        {
            targetWarehouseId = warehouseId;
            targetWarehouseLocationId = null;
            await LoadLocationsAsync(warehouseId);
        }
        else
        {
            targetWarehouseId = null;
            targetWarehouseLocationId = null;
            availableLocations = new();
        }
        StateHasChanged();
    }

    private string GetModalTitle()
    {
        if (scheduleItem?.Product != null)
        {
            return $"完工登錄 - {scheduleItem.Product.Name}";
        }
        return "生產完工登錄";
    }

    // ===== Header Buttons =====
    private RenderFragment HeaderButtons => __builder =>
    {
        <div class="w-100 d-flex align-items-center px-2">
            <div class="d-flex gap-2 ms-auto">
                <GenericButtonComponent Text="取消"
                                      Variant="ButtonVariant.Gray"
                                      Size="ButtonSize.Small"
                                      OnClick="@HandleCancel" />
                <GenericButtonComponent Text="確認登錄"
                                      Variant="ButtonVariant.Green"
                                      Size="ButtonSize.Small"
                                      IsDisabled="@(!CanSubmit || isLoading)"
                                      OnClick="@HandleSubmit" />
            </div>
        </div>
    };

    // ===== Body Content =====
    private RenderFragment BodyContent => __builder =>
    {
        <div class="container-fluid">
            @if (scheduleItem != null)
            {
                @* 排程項目摘要 *@
                <div class="card mb-3 bg-light">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="mb-2">
                                    <i class="bi bi-box me-2"></i>@(scheduleItem.Product?.Name ?? "-")
                                </h6>
                                <div class="small text-muted">
                                    @(scheduleItem.Product?.Code ?? "-")
                                </div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="small text-muted">計劃數量</div>
                                <div class="h5 mb-0 text-primary">@scheduleItem.ScheduledQuantity.ToString("N2")</div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="small text-muted">已完成</div>
                                <div class="h5 mb-0 text-success">@scheduleItem.CompletedQuantity.ToString("N2")</div>
                            </div>
                        </div>
                        
                        @* 進度條 *@
                        <div class="mt-3">
                            @{
                                var progress = scheduleItem.ScheduledQuantity > 0 
                                    ? (scheduleItem.CompletedQuantity / scheduleItem.ScheduledQuantity) * 100 
                                    : 0;
                                var progressClass = progress >= 100 ? "bg-success" : progress >= 50 ? "bg-info" : "bg-warning";
                            }
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar @progressClass" 
                                     role="progressbar" 
                                     style="width: @(progress)%;" 
                                     aria-valuenow="@progress" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    @progress.ToString("N1")%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                @* 完工登錄表單 *@
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-pencil-square me-2"></i>完工登錄</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">完工數量 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="number" class="form-control" 
                                           @bind="completionQuantity" 
                                           min="0" 
                                           max="@RemainingQuantity" 
                                           step="1" />
                                    <button class="btn btn-outline-secondary" type="button" 
                                            @onclick="() => completionQuantity = RemainingQuantity">
                                        全部
                                    </button>
                                </div>
                                <div class="form-text">
                                    剩餘可登錄數量：<span class="text-warning fw-bold">@RemainingQuantity.ToString("N2")</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">操作人員</label>
                                <select class="form-select" @bind="operatorEmployeeId">
                                    <option value="">-- 請選擇 --</option>
                                    @foreach (var employee in availableEmployees.Where(e => e.Status == EntityStatus.Active))
                                    {
                                        <option value="@employee.Id">@employee.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">入庫倉庫</label>
                                <select class="form-select" @onchange="OnWarehouseChanged" value="@targetWarehouseId">
                                    <option value="">-- 請選擇 --</option>
                                    @foreach (var warehouse in availableWarehouses.Where(w => w.Status == EntityStatus.Active))
                                    {
                                        <option value="@warehouse.Id">@warehouse.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">倉位</label>
                                <select class="form-select" @bind="targetWarehouseLocationId" disabled="@(!availableLocations.Any())">
                                    <option value="">-- 請選擇 --</option>
                                    @foreach (var location in availableLocations.Where(l => l.Status == EntityStatus.Active))
                                    {
                                        <option value="@location.Id">@location.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">備註</label>
                                <textarea class="form-control" rows="2" @bind="remarks" placeholder="可選填"></textarea>
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="autoCreateInventory" @bind="autoCreateInventory">
                                    <label class="form-check-label" for="autoCreateInventory">
                                        自動建立入庫記錄
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                @* BOM 組件消耗預覽 *@
                @if (scheduleDetails.Any())
                {
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-list-check me-2"></i>BOM 組件消耗預覽</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-striped mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>組件商品</th>
                                            <th class="text-end">單位用量</th>
                                            <th class="text-end">本次消耗</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var detail in scheduleDetails)
                                        {
                                            var componentProduct = detail.ComponentProduct;
                                            var unitQuantity = scheduleItem.ScheduledQuantity > 0 
                                                ? detail.RequiredQuantity / scheduleItem.ScheduledQuantity 
                                                : 0;
                                            var consumeQuantity = unitQuantity * completionQuantity;
                                            
                                            <tr>
                                                <td>
                                                    <span class="text-primary">[@(componentProduct?.Code ?? "-")]</span> 
                                                    @(componentProduct?.Name ?? "-")
                                                </td>
                                                <td class="text-end">@unitQuantity.ToString("N4")</td>
                                                <td class="text-end text-danger fw-bold">@consumeQuantity.ToString("N2")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <p class="mt-2 text-muted">無法載入排程項目資訊</p>
                </div>
            }
        </div>
    };

    // ===== 事件處理 =====
    private async Task HandleSubmit()
    {
        if (scheduleItem == null || completionQuantity <= 0) return;
        
        if (completionQuantity > RemainingQuantity)
        {
            await NotificationService.ShowWarningAsync($"完工數量不可超過剩餘數量 {RemainingQuantity:N2}");
            return;
        }

        try
        {
            isLoading = true;
            StateHasChanged();

            // 1. 建立完工登錄記錄
            var completion = new ProductionScheduleCompletion
            {
                ProductionScheduleItemId = scheduleItem.Id,
                CompletedQuantity = completionQuantity,
                CompletionDate = DateTime.Now,
                WarehouseId = targetWarehouseId,
                WarehouseLocationId = targetWarehouseLocationId,
                CompletedByEmployeeId = operatorEmployeeId,
                Status = EntityStatus.Active,
                CreatedAt = DateTime.Now
            };

            var completionResult = await ProductionScheduleCompletionService.CreateAsync(completion);
            if (!completionResult.IsSuccess)
            {
                await NotificationService.ShowErrorAsync($"建立完工記錄失敗：{completionResult.ErrorMessage}");
                return;
            }

            // 2. 更新排程項目的已完成數量
            scheduleItem.CompletedQuantity += completionQuantity;
            
            // 檢查是否全部完成
            if (scheduleItem.CompletedQuantity >= scheduleItem.ScheduledQuantity)
            {
                scheduleItem.ProductionItemStatus = ProductionItemStatus.Completed;
                scheduleItem.ActualEndDate = DateTime.Now;
            }
            
            var updateResult = await ProductionScheduleItemService.UpdateAsync(scheduleItem);
            if (!updateResult.IsSuccess)
            {
                await NotificationService.ShowWarningAsync($"更新排程項目失敗：{updateResult.ErrorMessage}");
            }

            // 3. 處理 BOM 組件消耗（建立配置記錄）
            await ProcessComponentConsumption(scheduleItem.Id, completionQuantity);

            // 4. 如果需要自動建立入庫記錄
            if (autoCreateInventory && targetWarehouseId.HasValue)
            {
                await CreateInventoryRecordAsync(completion);
            }

            await NotificationService.ShowSuccessAsync($"成功登錄完工數量：{completionQuantity:N2}");

            // 通知父組件
            if (OnCompletionRecorded.HasDelegate)
            {
                await OnCompletionRecorded.InvokeAsync(completion);
            }

            await CloseModal();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"完工登錄失敗：{ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ProcessComponentConsumption(int scheduleItemId, decimal quantity)
    {
        // TODO: 未來實作組件消耗記錄
        // 目前僅記錄完工，組件消耗需要配合領料流程
        await Task.CompletedTask;
    }

    private async Task CreateInventoryRecordAsync(ProductionScheduleCompletion completion)
    {
        if (scheduleItem == null) return;
        
        // 取得入庫倉庫 ID
        var warehouseId = completion.WarehouseId;
        if (!warehouseId.HasValue)
        {
            // 若完工記錄沒有指定倉庫，嘗試取得排程項目的預設入庫倉庫
            warehouseId = scheduleItem.WarehouseId;
        }
        
        if (!warehouseId.HasValue)
        {
            // 仍無倉庫資訊，嘗試取得預設倉庫
            var allWarehouses = await WarehouseService.GetAllAsync();
            var defaultWarehouse = allWarehouses?.FirstOrDefault(w => w.Status == EntityStatus.Active);
            if (defaultWarehouse != null)
            {
                warehouseId = defaultWarehouse.Id;
            }
        }
        
        if (!warehouseId.HasValue)
        {
            await NotificationService.ShowWarningAsync("無法確定入庫倉庫，庫存未更新");
            return;
        }
        
        try
        {
            // 產生交易單號：PC{yyyyMMddHHmmss}
            var transactionNumber = $"PC{DateTime.Now:yyyyMMddHHmmss}";
            
            // 將 decimal 數量轉換為 int（四捨五入）
            var intQuantity = (int)Math.Round(completion.CompletedQuantity);
            
            // 呼叫庫存服務增加庫存
            var result = await InventoryStockService.AddStockAsync(
                scheduleItem.ProductId,
                warehouseId.Value,
                intQuantity,
                InventoryTransactionTypeEnum.ProductionCompletion,
                transactionNumber,
                unitCost: null,
                locationId: completion.WarehouseLocationId,
                remarks: $"生產完工入庫 - 排程項目 #{scheduleItem.Id}"
            );
            
            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync($"庫存入庫成功：{completion.CompletedQuantity:N2}");
            }
            else
            {
                await NotificationService.ShowWarningAsync($"庫存入庫失敗：{result.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"庫存處理異常：{ex.Message}");
        }
    }

    private async Task HandleCancel()
    {
        if (OnCancel.HasDelegate)
        {
            await OnCancel.InvokeAsync();
        }
        
        await CloseModal();
    }

    private async Task CloseModal()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }
}
