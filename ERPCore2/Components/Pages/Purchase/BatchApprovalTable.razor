@*
    批次審核表格元件
    專門用於批次審核功能的表格顯示
*@
@using ERPCore2.Models
@using ERPCore2.Data.Entities
@using Microsoft.Extensions.Localization
@typeparam TEntity where TEntity : class
@inject IStringLocalizer<SharedResource> L

<div class="table-responsive">
    <InteractiveTableComponent TItem="TEntity"
                             Items="@Items"
                             ColumnDefinitions="@columnDefinitions"
                             ShowHeader="true"
                             ShowActions="true"
                             ShowRowNumbers="true"
                             IsStriped="true"
                             IsHoverable="true"
                             IsBordered="true"
                             EnableRowClick="true"
                             EnableRowSelection="true"
                             AllowMultipleSelection="true"
                             SelectedItems="@SelectedItems"
                             OnSelectionChanged="@HandleSelectionChanged"
                             GetRowCssClass="@GetRowCssClass"
                             ActionsTemplate="@GetActionsTemplate()"
                             CssClass="batch-approval-table"
                             EmptyMessage="@L["Purchase.NoPendingItems"].ToString()" />
</div>

@code {
    // ===== 參數定義 =====
    
    [Parameter] public List<TEntity> Items { get; set; } = new();
    [Parameter] public HashSet<TEntity>? SelectedItems { get; set; }
    [Parameter] public EventCallback<HashSet<TEntity>> OnSelectionChanged { get; set; }
    [Parameter] public Func<TEntity, int, string>? GetRowCssClass { get; set; }
    
    /// <summary>
    /// 查看按鈕點擊事件
    /// </summary>
    [Parameter] public EventCallback<TEntity> OnViewClick { get; set; }
    
    // ===== 內部狀態 =====
    
    private List<InteractiveColumnDefinition> columnDefinitions = new();
    
    // ===== 生命週期方法 =====
    
    protected override void OnInitialized()
    {
        BuildTableColumns();
    }
    
    // ===== 初始化方法 =====
    
    /// <summary>
    /// 建立表格欄位定義 - 針對採購單批次審核
    /// </summary>
    private void BuildTableColumns()
    {
        // 根據實體類型動態建立欄位
        if (typeof(TEntity) == typeof(PurchaseOrder))
        {
            BuildPurchaseOrderColumns();
        }
        else
        {
            // 其他實體類型可以在這裡擴展
            BuildDefaultColumns();
        }
    }
    
    /// <summary>
    /// 建立採購單的欄位定義
    /// </summary>
    private void BuildPurchaseOrderColumns()
    {
        columnDefinitions = new List<InteractiveColumnDefinition>
        {
            // 採購單號
            new InteractiveColumnDefinition
            {
                Title = L["Column.PurchaseOrderCode"].ToString(),
                PropertyName = nameof(PurchaseOrder.Code),
                ColumnType = InteractiveColumnType.Display,
                Width = "150px"
            },

            // 廠商
            new InteractiveColumnDefinition
            {
                Title = L["Column.SupplierName"].ToString(),
                PropertyName = "Supplier.CompanyName",
                ColumnType = InteractiveColumnType.Display,
                Width = "200px"
            },

            // 訂單日期
            new InteractiveColumnDefinition
            {
                Title = L["Column.OrderDate"].ToString(),
                PropertyName = nameof(PurchaseOrder.OrderDate),
                ColumnType = InteractiveColumnType.Display,
                Width = "120px",
                DisplayFormatter = item => 
                {
                    var order = item as PurchaseOrder;
                    if (order?.OrderDate != null)
                        return $"<span style='font-size: 0.875rem;'>{order.OrderDate:yyyy/MM/dd}</span>";
                    return "-";
                }
            },
            
            // 預計到貨日
            new InteractiveColumnDefinition
            {
                Title = L["Column.ExpectedDeliveryDate"].ToString(),
                PropertyName = nameof(PurchaseOrder.ExpectedDeliveryDate),
                ColumnType = InteractiveColumnType.Display,
                Width = "120px",
                DisplayFormatter = item => 
                {
                    var order = item as PurchaseOrder;
                    if (order?.ExpectedDeliveryDate != null)
                        return $"<span style='font-size: 0.875rem;'>{order.ExpectedDeliveryDate:yyyy/MM/dd}</span>";
                    return "<span style='font-size: 0.875rem;'>-</span>";
                }
            },
            
            // 總金額
            new InteractiveColumnDefinition
            {
                Title = L["Column.TotalAmount"].ToString(),
                PropertyName = nameof(PurchaseOrder.TotalAmount),
                ColumnType = InteractiveColumnType.Display,
                Width = "120px",
                CellCssClass = "text-end",
                DisplayFormatter = item => 
                {
                    var order = item as PurchaseOrder;
                    return $"<span style='font-size: 0.875rem;' class='fw-bold'>{order?.TotalAmount ?? 0:N0}</span>";
                }
            },
            
            // 建立日期
            new InteractiveColumnDefinition
            {
                Title = L["Label.CreatedAt"].ToString(),
                PropertyName = nameof(PurchaseOrder.CreatedAt),
                ColumnType = InteractiveColumnType.Display,
                Width = "150px",
                DisplayFormatter = item => 
                {
                    var order = item as PurchaseOrder;
                    if (order?.CreatedAt != null)
                        return $"<span style='font-size: 0.875rem;'>{order.CreatedAt:yyyy/MM/dd HH:mm}</span>";
                    return "-";
                }
            }
        };
    }
    
    /// <summary>
    /// 建立預設欄位定義（用於其他實體類型）
    /// </summary>
    private void BuildDefaultColumns()
    {
        columnDefinitions = new List<InteractiveColumnDefinition>
        {
            new InteractiveColumnDefinition
            {
                Title = "ID",
                PropertyName = "Id",
                ColumnType = InteractiveColumnType.Display,
                Width = "100px"
            }
        };
    }
    
    // ===== 事件處理方法 =====
    
    /// <summary>
    /// 處理選取狀態變更事件
    /// </summary>
    private async Task HandleSelectionChanged(HashSet<TEntity> selectedItems)
    {
        if (OnSelectionChanged.HasDelegate)
        {
            await OnSelectionChanged.InvokeAsync(selectedItems);
        }
    }
    
    /// <summary>
    /// 操作按鈕範本
    /// </summary>
    private RenderFragment<TEntity> GetActionsTemplate()
    {
        return entity => __builder =>
        {
            @* 查看按鈕 *@
            <GenericButtonComponent Variant="ButtonVariant.Blue"
                                  IconClass="bi bi-eye text-white"
                                  Size="ButtonSize.Large"
                                  Title="@L["Purchase.ViewDetail"].ToString()"
                                  OnClick="@(async () => await HandleViewClick(entity))"
                                  StopPropagation="true"
                                  CssClass="btn-square" />
        };
    }
    
    /// <summary>
    /// 處理查看按鈕點擊
    /// </summary>
    private async Task HandleViewClick(TEntity entity)
    {
        if (OnViewClick.HasDelegate)
        {
            await OnViewClick.InvokeAsync(entity);
        }
    }
}
