@* 進貨退出原因編輯組件 *@
@inject IPurchaseReturnReasonService PurchaseReturnReasonService
@inject INotificationService NotificationService
@inject IStringLocalizer<SharedResource> L

<GenericEditModalComponent TEntity="PurchaseReturnReason"
                          TService="IPurchaseReturnReasonService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@PurchaseReturnReasonId"
                          Service="@PurchaseReturnReasonService"
                          EntityName="@L["Entity.PurchaseReturnReason"]"
                          EntityNamePlural="@L["Entity.PurchaseReturnReason"]"
                          ModalTitle="@(PurchaseReturnReasonId.HasValue ? L["Message.EditTitle", L["Entity.PurchaseReturnReason"]].ToString() : L["Message.CreateTitle", L["Entity.PurchaseReturnReason"]].ToString())"
                          Size="GenericEditModalComponent<PurchaseReturnReason, IPurchaseReturnReasonService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          DataLoader="@LoadPurchaseReturnReasonData"
                          UseGenericSave="true"
                          SaveSuccessMessage="@(PurchaseReturnReasonId.HasValue ? L["Message.UpdateSuccess", L["Entity.PurchaseReturnReason"]].ToString() : L["Message.CreateSuccess", L["Entity.PurchaseReturnReason"]].ToString())"
                          SaveFailureMessage="@L["Message.SaveFailure", L["Entity.PurchaseReturnReason"]]"
                          RequiredPermission="@PermissionRegistry.PurchaseReturnReason.Read"
                          OnEntitySaved="@OnPurchaseReturnReasonSaved"
                          OnCancel="@OnCancel"
                          OnEntityLoaded="@HandleEntityLoaded" />

@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? PurchaseReturnReasonId { get; set; }
    [Parameter] public EventCallback<PurchaseReturnReason> OnPurchaseReturnReasonSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public Dictionary<string, object?>? PrefilledValues { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<PurchaseReturnReason, IPurchaseReturnReasonService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();

    // ===== 必要方法 =====

    /// <summary>
    /// 處理實體載入完成事件（由 GenericEditModalComponent 的導航觸發）
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入資料時發生錯誤：{ex.Message}");
        }
    }

    private async Task<PurchaseReturnReason?> LoadPurchaseReturnReasonData()
    {
        try
        {
            if (!PurchaseReturnReasonId.HasValue)
            {
                // 新增模式 - 返回預設值
                var newReason = new PurchaseReturnReason
                {
                    Name = string.Empty,
                    Code = await EntityCodeGenerationHelper.GenerateForEntity<PurchaseReturnReason, IPurchaseReturnReasonService>(PurchaseReturnReasonService, "PRR"),
                    Status = EntityStatus.Active
                };

                // 應用預填值
                PrefilledValueHelper.ApplyPrefilledValues(newReason, PrefilledValues);

                return newReason;
            }
            else
            {
                // 編輯模式 - 載入現有資料
                return await PurchaseReturnReasonService.GetByIdAsync(PurchaseReturnReasonId.Value);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadPurchaseReturnReasonData), GetType(), additionalData: "載入退出原因資料失敗");
            await NotificationService.ShowErrorAsync("載入退出原因資料失敗");
            return null;
        }
    }

    protected override void OnParametersSet()
    {
        if (IsVisible)
        {
            InitializeFormFields();
        }
    }

    private void InitializeFormFields()
    {
        formFields = new List<FormFieldDefinition>
        {
            new()
            {
                PropertyName = nameof(PurchaseReturnReason.Code),
                Label = L["Field.ReasonCode"],
                FieldType = FormFieldType.Text,
                Placeholder = L["Placeholder.AutoGenerated"],
                IsRequired = true,
                IsReadOnly = true,
                MaxLength = 20,
                HelpText = "退出原因的唯一識別編號，系統自動生成"
            },
            new()
            {
                PropertyName = nameof(PurchaseReturnReason.Name),
                Label = L["Field.ReasonName"],
                FieldType = FormFieldType.Text,
                Placeholder = L["Placeholder.PleaseInput", L["Field.ReasonName"]],
                IsRequired = true,
                MaxLength = 50,
                HelpText = "退出原因的顯示名稱"
            },
            FormFieldConfigurationHelper.CreateRemarksField<PurchaseReturnReason>(),
        };

        formSections = FormSectionHelper<PurchaseReturnReason>.Create()
            .AddToSection(FormSectionNames.BasicInfo,
                prr => prr.Code,
                prr => prr.Name)
            .AddToSection(FormSectionNames.AdditionalData,
                prr => prr.Remarks)
            .Build();
    }
}
