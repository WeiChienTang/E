@* å¯é‡ç”¨çš„æ¡è³¼å–®ç·¨è¼¯çµ„ä»¶ - å¯åœ¨ä»»ä½•é é¢ä¸­åµŒå…¥ *@

@using ERPCore2.Helpers
@inject IPurchaseOrderService PurchaseOrderService
@inject ISupplierService SupplierService
@inject ICompanyService CompanyService
@inject IProductService ProductService
@inject INotificationService NotificationService
@inject IReportPrintConfigurationService ReportPrintConfigurationService
@inject ISystemParameterService SystemParameterService
@inject NavigationManager NavigationManager
@inject ActionButtonHelper ActionButtonHelper
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ERPCore2.Data.Context.AppDbContext DbContext

<GenericEditModalComponent TEntity="PurchaseOrder" 
                          TService="IPurchaseOrderService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@PurchaseOrderId"
                          Service="@PurchaseOrderService"
                          EntityName="æ¡è³¼å–®"
                          EntityNamePlural="æ¡è³¼å–®"
                          ModalTitle="@(PurchaseOrderId.HasValue ? "ç·¨è¼¯æ¡è³¼å–®" : "æ–°å¢æ¡è³¼å–®")"
                          Size="GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@autoCompleteConfig?.Prefillers"
                          AutoCompleteCollections="@autoCompleteConfig?.Collections"
                          AutoCompleteDisplayProperties="@autoCompleteConfig?.DisplayProperties"
                          AutoCompleteValueProperties="@autoCompleteConfig?.ValueProperties"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadPurchaseOrderData"
                          SaveHandler="@SavePurchaseOrderWrapper"
                          SaveSuccessMessage="@(PurchaseOrderId.HasValue ? "æ¡è³¼å–®æ›´æ–°æˆåŠŸ" : "æ¡è³¼å–®æ–°å¢æˆåŠŸ")"
                          SaveFailureMessage="æ¡è³¼å–®å„²å­˜å¤±æ•—"
                          RequiredPermission="PurchaseOrder.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          CustomValidator="@ValidatePurchaseOrderDetailsAsync"
                          CustomModules="@GetCustomModules()"
                          ShowPrintButton = "true"
                          OnPrint="@HandlePrint"
                          ShowApprovalSection="@ShouldShowApprovalSection()"
                          ApprovalPermission="PurchaseOrder.Approve"
                          OnApprove="@HandlePurchaseOrderApprove"
                          OnRejectWithReason="@HandlePurchaseOrderRejectWithReason"
                          FormHeaderContent="@WarningMessage"
                          CustomActionButtons="@CustomActionButtons"
                          OnEntityLoaded="@HandleEntityLoaded">
</GenericEditModalComponent>

@* å» å•†ç·¨è¼¯ Modal *@
@if (supplierModalManager != null)
{
    <SupplierEditModalComponent @ref="supplierEditModal"
                               IsVisible="@supplierModalManager.IsModalVisible"
                               IsVisibleChanged="@supplierModalManager.HandleModalVisibilityChangedAsync"
                               SupplierId="@supplierModalManager.SelectedEntityId"
                               PrefilledValues="@supplierModalManager.PrefilledValues"
                               OnSupplierSaved="@OnSupplierSavedWrapper"
                               OnCancel="@supplierModalManager.HandleModalCancelAsync" />
}

@* é€²è²¨å–®ç·¨è¼¯ Modal *@
<PurchaseReceivingEditModalComponent @ref="purchaseReceivingEditModal"
                                     IsVisible="@showPurchaseReceivingModal"
                                     IsVisibleChanged="@((bool visible) => showPurchaseReceivingModal = visible)"
                                     PurchaseReceivingId="@selectedPurchaseReceivingId"
                                     OnPurchaseReceivingSaved="@HandlePurchaseReceivingSaved"
                                     OnCancel="@(() => showPurchaseReceivingModal = false)" />

@code {
    // ===== å¿…è¦åƒæ•¸ =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? PurchaseOrderId { get; set; }
    [Parameter] public EventCallback<PurchaseOrder> OnPurchaseOrderSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== å…§éƒ¨ç‹€æ…‹ =====
    private GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // AutoComplete é…ç½®
    private AutoCompleteConfig? autoCompleteConfig;
    
    // åŸå§‹è³‡æ–™é›†åˆï¼ˆç”¨æ–¼ AutoCompleteï¼‰
    private List<Supplier> availableSuppliers = new();
    private List<Company> availableCompanies = new();
    private List<Product> availableProducts = new();
    private List<Product> filteredProductsBySupplier = new(); // æ ¹æ“šå» å•†éæ¿¾çš„å•†å“
    
    // æ¡è³¼è¨‚å–®æ˜ç´°
    private List<PurchaseOrderDetail> purchaseOrderDetails = new();
    private PurchaseOrderTable<PurchaseOrder, PurchaseOrderDetail>? purchaseOrderDetailManager;
    
    // Modal ç®¡ç†å™¨
    private SupplierEditModalComponent? supplierEditModal;
    private RelatedEntityModalManager<Supplier> supplierModalManager = default!;
    private ModalManagerCollection modalManagers = default!;
    
    // ===== ç›¸é—œå–®æ“š Modal =====
    private PurchaseReceivingEditModalComponent? purchaseReceivingEditModal;
    private bool showPurchaseReceivingModal = false;
    private int? selectedPurchaseReceivingId = null;
    
    // ä¸‹æ‹‰é¸å–®é¸é …ï¼ˆå‘ä¸‹ç›¸å®¹ï¼‰
    private List<Supplier> suppliers = new();
    private List<Company> companies = new();
    private List<SelectOption> supplierOptions = new();
    private List<SelectOption> companyOptions = new();
    private List<SelectOption> statusOptions = new();
    private List<SelectOption> taxCalculationMethodOptions = new();
    
    // ç³»çµ±åƒæ•¸ - ç¨…ç‡å¿«å–ï¼ˆé¿å…é‡è¤‡æŸ¥è©¢è³‡æ–™åº«ï¼‰
    private decimal currentTaxRate = 5.0m; // é è¨­ 5%ï¼Œå¯¦éš›å€¼æœƒåœ¨åˆå§‹åŒ–æ™‚å¾è³‡æ–™åº«è¼‰å…¥
    
    // ===== å¯©æ ¸é–‹é—œç‹€æ…‹ =====
    private bool isApprovalEnabled = true; // æ˜¯å¦å•Ÿç”¨å¯©æ ¸åŠŸèƒ½ï¼ˆå¾ç³»çµ±åƒæ•¸è¼‰å…¥ï¼‰
    
    // ===== é–å®šç‹€æ…‹ =====
    private bool hasUndeletableDetails = false; // æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²æœ‰é€²è²¨è¨˜éŒ„ï¼‰
    
    // ===== è½‰å–®ç‹€æ…‹ =====
    private bool canCreateReceiving = false; // æ˜¯å¦å¯ä»¥è½‰é€²è²¨å–®ï¼ˆæ–°å¢æ¨¡å¼éœ€å…ˆå„²å­˜ï¼Œç·¨è¼¯æ¨¡å¼ç›´æ¥ç‚º trueï¼‰
    
    // ===== é å¡«è³‡æ–™ï¼ˆå¾ä½åº«å­˜è­¦æˆ’é–‹å•Ÿæ¡è³¼å–®æ™‚ä½¿ç”¨ï¼‰ =====
    private int? prefilledSupplierId = null;
    private int? prefilledProductId = null;
    private decimal? prefilledUnitPrice = null;
    
    // ===== åˆ—å°ç‹€æ…‹ =====
    private bool canPrint = false; // æ˜¯å¦å¯ä»¥åˆ—å°ï¼ˆæ–°å¢æ¨¡å¼éœ€å…ˆå„²å­˜ï¼Œç·¨è¼¯æ¨¡å¼ç›´æ¥ç‚º trueï¼‰

    // ===== å»ºæ§‹å‡½æ•¸ =====
    public PurchaseOrderEditModalComponent()
    {
        // ç§»é™¤åŸæœ‰çš„å»ºæ§‹å‡½æ•¸åˆå§‹åŒ–
        // ç¾åœ¨ä½¿ç”¨ ModalManagerInitHelper åœ¨ OnInitializedAsync ä¸­çµ±ä¸€åˆå§‹åŒ–
    }
    
    // è³‡æ–™è¼‰å…¥ç‹€æ…‹æ¨™è¨˜
    private bool isDataLoaded = false;

    // ===== å¿…è¦æ–¹æ³• =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // è¼‰å…¥å¯©æ ¸é–‹é—œè¨­å®šï¼ˆå„ªå…ˆåŸ·è¡Œ,å½±éŸ¿å¾ŒçºŒé‚è¼¯ï¼‰
            isApprovalEnabled = await SystemParameterService.IsPurchaseOrderApprovalEnabledAsync();
            
            // ä½¿ç”¨ ModalManagerInitHelper åˆå§‹åŒ– Modal ç®¡ç†å™¨
            modalManagers = ModalManagerInitHelper.CreateBuilder<PurchaseOrder, IPurchaseOrderService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Supplier>(nameof(PurchaseOrder.SupplierId), "å» å•†")
                .Build();
            supplierModalManager = modalManagers.Get<Supplier>(nameof(PurchaseOrder.SupplierId));
            
            // ç§»é™¤è‡ªå‹•è¼‰å…¥è³‡æ–™ï¼Œæ”¹ç‚ºåœ¨ OnParametersSetAsync ä¸­æ ¹æ“š IsVisible è¼‰å…¥
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–æ¡è³¼å–®ç·¨è¼¯çµ„ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            // æ‰“é–‹æ™‚,å¦‚æœæ˜¯æ–°å¢æ¨¡å¼,é‡ç½®é–å®šç‹€æ…‹
            if (!PurchaseOrderId.HasValue)
            {
                hasUndeletableDetails = false;
            }
            
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
        }

        await base.OnParametersSetAsync();
    }

    private async Task HandleSaveSuccess()
    {
        try
        {
            if (OnPurchaseOrderSaved.HasDelegate && editModalComponent?.Entity != null)
            {
                await OnPurchaseOrderSaved.InvokeAsync(editModalComponent.Entity);
            }

            // CloseModal å·²ç”± GenericEditModalComponent çµ±ä¸€æ§åˆ¶
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSaveSuccess), GetType(), 
                additionalData: "æ¡è³¼å–®ç·¨è¼¯Modalå„²å­˜æˆåŠŸè™•ç†å¤±æ•—");
        }
    }

    private async Task HandleCancel()
    {
        try
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }
            // ä¸è¦ç›´æ¥èª¿ç”¨ CloseModalï¼Œè®“ GenericEditModalComponent è™•ç†
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCancel), GetType(), 
                additionalData: "æ¡è³¼å–®ç·¨è¼¯Modalå–æ¶ˆè™•ç†å¤±æ•—");
        }
    }

    /// <summary>
    /// è™•ç†åˆ—å° - ç°¡åŒ–ç‰ˆæœ¬ï¼Œå¥—ç”¨ã€ŒAå–®è½‰Bå–®ç°¡åŒ–ä¿®æ”¹ã€çš„è¨­è¨ˆæ¨¡å¼
    /// </summary>
    private async Task HandlePrint()
    {
        try
        {
            // ç¬¬ä¸€æ­¥ï¼šç¢ºèªæ˜¯å¦å·²å„²å­˜ï¼ˆæ–°å¢æ¨¡å¼éœ€å…ˆå„²å­˜ï¼Œç·¨è¼¯æ¨¡å¼ç›´æ¥é€šéï¼‰
            if (!canPrint)
            {
                await NotificationService.ShowWarningAsync("è«‹å…ˆå„²å­˜æ¡è³¼å–®å¾Œå†é€²è¡Œåˆ—å°");
                return;
            }
            
            // ç¬¬äºŒæ­¥ï¼šå®‰å…¨æª¢æŸ¥ - ç¢ºä¿ Entity å·²è¼‰å…¥
            if (editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("æ¡è³¼å–®è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
                return;
            }
            
            // ç¬¬ä¸‰æ­¥ï¼šæ ¹æ“šç³»çµ±åƒæ•¸æª¢æŸ¥æ˜¯å¦éœ€è¦å¯©æ ¸æ‰èƒ½åˆ—å°
            if (isApprovalEnabled && !editModalComponent.Entity.IsApproved)
            {
                await NotificationService.ShowWarningAsync("æ¡è³¼å–®éœ€å¯©æ ¸é€šéå¾Œæ‰èƒ½åˆ—å°");
                return;
            }
            
            // ç›´æ¥åŸ·è¡Œåˆ—å°ï¼Œä½¿ç”¨ Entity.Idï¼ˆæœ€å¯é çš„ä¾†æºï¼‰
            await HandleDirectPrint(null);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePrint), GetType(), 
                additionalData: $"æ¡è³¼å–®åˆ—å°è™•ç†å¤±æ•— - ID: {editModalComponent?.Entity?.Id}");
            await NotificationService.ShowErrorAsync("åˆ—å°è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    /// <summary>
    /// ç›´æ¥åŸ·è¡Œåˆ—å° - å¯ä»¥ä½¿ç”¨æŒ‡å®šçš„åˆ—å°é…ç½®æˆ–é è¨­é…ç½®
    /// </summary>
    private async Task HandleDirectPrint(ReportPrintConfiguration? printConfig)
    {
        try
        {
            // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ Entity å·²è¼‰å…¥
            if (editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("ç„¡æ³•åˆ—å°ï¼šæ¡è³¼å–®è³‡æ–™ä¸å­˜åœ¨");
                return;
            }

            // é©—è­‰åˆ—å°é…ç½®
            var (isValid, errorMessage) = ReportPrintHelper.ValidateConfiguration(printConfig);
            if (!isValid)
            {
                await NotificationService.ShowWarningAsync($"åˆ—å°é…ç½®ç„¡æ•ˆï¼š{errorMessage}");
                return;
            }

            // ä½¿ç”¨é€šç”¨ Helper å»ºç«‹åˆ—å° URLï¼ˆæ–°ç‰ˆè·¯ç”±ï¼‰
            // ä½¿ç”¨ Entity.Id è€Œé PurchaseOrderId åƒæ•¸ï¼ˆæœ€å¯é çš„ä¾†æºï¼‰
            var printUrl = ReportPrintHelper.BuildPrintUrl(
                baseUrl: NavigationManager.BaseUri,
                reportType: "purchase-report/order",
                documentId: editModalComponent.Entity.Id,
                configuration: printConfig,
                autoprint: true
            );

            // ä½¿ç”¨é€šç”¨ Helper åŸ·è¡Œåˆ—å°ï¼ˆéš±è— iframe æ–¹å¼ï¼‰
            var success = await ReportPrintHelper.ExecutePrintWithHiddenIframeAsync(
                printUrl: printUrl,
                jsRuntime: JSRuntime,
                iframeId: "printFrame"
            );
            
            if (success)
            {
                var configName = ReportPrintHelper.GetDisplayName(printConfig);
                await NotificationService.ShowSuccessAsync($"å·²ä½¿ç”¨ {configName} é€å‡ºåˆ—å°");
            }
            else
            {
                await NotificationService.ShowErrorAsync("åˆ—å°åŸ·è¡Œå¤±æ•—");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDirectPrint), GetType(), 
                additionalData: $"æ¡è³¼å–®ç›´æ¥åˆ—å°å¤±æ•— - ID: {editModalComponent?.Entity?.Id}, Config: {printConfig?.ReportName}");
            await NotificationService.ShowErrorAsync("åˆ—å°åŸ·è¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    private async Task CloseModal()
    {
        try
        {
            if (IsVisibleChanged.HasDelegate)
            {
                await IsVisibleChanged.InvokeAsync(false);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(CloseModal), GetType(), 
                additionalData: "æ¡è³¼å–®ç·¨è¼¯Modalé—œé–‰å¤±æ•—");
        }
    }

    private async Task<PurchaseOrder?> LoadPurchaseOrderData()
    {
        try
        {
            if (!PurchaseOrderId.HasValue)
            {
                // æ–°å¢æ¨¡å¼ - ä½¿ç”¨çµ±ä¸€çš„ EntityCodeGenerationHelper ç”¢ç”Ÿæ¡è³¼å–®è™Ÿï¼ˆæ”¯æ´ Attribute é…ç½®ï¼‰
                var generatedCode = await EntityCodeGenerationHelper.GenerateForEntity<PurchaseOrder, IPurchaseOrderService>(
                    PurchaseOrderService,
                    DbContext
                );
                
                // å–å¾—é è¨­å…¬å¸
                var primaryCompany = await CompanyService.GetPrimaryCompanyAsync();
                
                var newOrder = new PurchaseOrder
                {
                    OrderDate = DateTime.Today,
                    ExpectedDeliveryDate = DateTime.Today.AddDays(7),
                    Status = EntityStatus.Active,
                    TotalAmount = 0,
                    Code = generatedCode,
                    CompanyId = primaryCompany?.Id ?? 1 // è¨­å®šé è¨­å…¬å¸ï¼Œå¦‚æœæ²’æœ‰ä¸»è¦å…¬å¸å‰‡ç‚º1
                };
                
                // æ¸…ç©ºæ˜ç´°
                purchaseOrderDetails.Clear();
                
                // å¦‚æœæœ‰é å¡«çš„ä¾›æ‡‰å•† IDï¼Œåªè¨­å®š SupplierIdï¼ˆä¸è¨­å®š Supplier å°èˆªå±¬æ€§ï¼Œé¿å… EF Core è¿½è¹¤éŒ¯èª¤ï¼‰
                if (prefilledSupplierId.HasValue && prefilledSupplierId.Value > 0)
                {
                    newOrder.SupplierId = prefilledSupplierId.Value;
                }
                
                // å¦‚æœæœ‰é å¡«çš„å•†å“ IDï¼Œç›´æ¥æ·»åŠ æ˜ç´°ï¼ˆåœ¨ LoadPurchaseOrderData ä¸­è™•ç†ï¼Œç¢ºä¿ UI æ¸²æŸ“æ™‚å°±æœ‰è³‡æ–™ï¼‰
                if (prefilledProductId.HasValue && prefilledProductId.Value > 0)
                {
                    var product = availableProducts.FirstOrDefault(p => p.Id == prefilledProductId.Value);
                    if (product != null)
                    {
                        // åªè¨­å®š ProductIdï¼Œä¸è¨­å®š Product å°èˆªå±¬æ€§ï¼Œé¿å… EF Core è¿½è¹¤éŒ¯èª¤
                        var newDetail = new PurchaseOrderDetail
                        {
                            ProductId = product.Id,
                            OrderQuantity = 1,
                            UnitPrice = prefilledUnitPrice ?? 0,
                            ReceivedQuantity = 0,
                            Remarks = "å¾ä½åº«å­˜è­¦æˆ’å»ºç«‹"
                        };
                        
                        purchaseOrderDetails.Add(newDetail);
                        
                        // ç›´æ¥è¨ˆç®— newOrder çš„é‡‘é¡ï¼ˆæ­¤æ™‚ editModalComponent.Entity é‚„ä¸å­˜åœ¨ï¼‰
                        // ä½¿ç”¨é è¨­çš„å¤–åŠ ç¨…è¨ˆç®—æ–¹å¼
                        newOrder.TotalAmount = Math.Round(purchaseOrderDetails.Sum(d => d.SubtotalAmount), 0, MidpointRounding.AwayFromZero);
                        newOrder.PurchaseTaxAmount = purchaseOrderDetails.Sum(d => 
                        {
                            var detailTaxRate = d.TaxRate ?? currentTaxRate;
                            var detailTaxAmount = d.SubtotalAmount * (detailTaxRate / 100m);
                            return Math.Round(detailTaxAmount, 0, MidpointRounding.AwayFromZero);
                        });
                    }
                }
                
                //  æ–°å¢æ¨¡å¼æ™‚,é‡ç½®é–å®šç‹€æ…‹ç‚º false
                hasUndeletableDetails = false;
                
                // æ–°å¢æ¨¡å¼ï¼šå¿…é ˆå…ˆå„²å­˜æ‰èƒ½è½‰å–®å’Œåˆ—å°
                canCreateReceiving = false;
                canPrint = false;
                
                return newOrder;
            }

            // ç·¨è¼¯æ¨¡å¼ - è¼‰å…¥æ¡è³¼å–®å’Œæ˜ç´°
            canCreateReceiving = true; // ç·¨è¼¯æ¨¡å¼ï¼šå¯ä»¥ç›´æ¥è½‰å–®
            canPrint = true; // ç·¨è¼¯æ¨¡å¼ï¼šå¯ä»¥ç›´æ¥åˆ—å°
            
            var purchaseOrder = await PurchaseOrderService.GetByIdAsync(PurchaseOrderId.Value);
            
            if (purchaseOrder != null)
            {
                // è¼‰å…¥æ¡è³¼å–®æ˜ç´°
                await LoadPurchaseOrderDetails(PurchaseOrderId.Value);
                
                // åœ¨å¯¦é«”è¼‰å…¥å¾Œé‡æ–°åˆå§‹åŒ–è¡¨å–®æ¬„ä½ä»¥åæ˜ æ­£ç¢ºçš„å”¯è®€ç‹€æ…‹
                await Task.Delay(10); // çŸ­æš«å»¶é²ç¢ºä¿å¯¦é«”å·²è¨­å®š
                _ = Task.Run(async () =>
                {
                    await InvokeAsync(async () =>
                    {
                        await InitializeFormFieldsAsync();
                        StateHasChanged();
                    });
                });
                
                // è§¸ç™¼é‡æ–°æ¸²æŸ“ä»¥æ›´æ–° ProductManagerComponent
                StateHasChanged();
            }
            
            return purchaseOrder;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadPurchaseOrderData), GetType(), 
                additionalData: $"è¼‰å…¥æ¡è³¼å–®è³‡æ–™å¤±æ•— - ID: {PurchaseOrderId}");
            await NotificationService.ShowErrorAsync($"è¼‰å…¥æ¡è³¼å–®è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return null;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // è¼‰å…¥å» å•†é¸é …
            suppliers = await SupplierService.GetAllAsync();
            availableSuppliers = suppliers; // ç”¨æ–¼ AutoComplete
            supplierOptions = suppliers.Where(s => s.Status == EntityStatus.Active)
                .Select(s => new SelectOption
                {
                    Text = s.CompanyName,
                    Value = s.Id.ToString()
                }).ToList();

            // è¼‰å…¥å…¬å¸é¸é …
            companies = await CompanyService.GetAllAsync();
            availableCompanies = companies; // ç”¨æ–¼ AutoComplete
            companyOptions = companies.Where(c => c.Status == EntityStatus.Active)
                .Select(c => new SelectOption
                {
                    Text = c.CompanyName,
                    Value = c.Id.ToString()
                }).ToList();

            // è¼‰å…¥å•†å“è³‡æ–™
            availableProducts = await ProductService.GetAllAsync();
            
            //  ä¸€æ¬¡æ€§è¼‰å…¥ç³»çµ±ç¨…ç‡ï¼ˆé¿å…æ¯æ¬¡è¨ˆç®—éƒ½æŸ¥è©¢è³‡æ–™åº«ï¼‰
            currentTaxRate = await TaxCalculationHelper.LoadTaxRateAsync(SystemParameterService);
            
            // ä½¿ç”¨ AutoCompleteConfigHelper å»ºç«‹é…ç½®
            autoCompleteConfig = new AutoCompleteConfigBuilder<PurchaseOrder>()
                .AddField(nameof(PurchaseOrder.SupplierId), "CompanyName", availableSuppliers)
                .AddField(nameof(PurchaseOrder.CompanyId), "CompanyName", availableCompanies)
                .Build();

            // åˆå§‹åŒ–ç‹€æ…‹é¸é …
            statusOptions = new List<SelectOption>
            {
                new SelectOption { Text = "å•Ÿç”¨", Value = "Active" },
                new SelectOption { Text = "åœç”¨", Value = "Inactive" }
            };
            
            // åˆå§‹åŒ–ç¨…ç‡ç®—æ³•é¸é …
            taxCalculationMethodOptions = new List<SelectOption>
            {
                new SelectOption { Text = "å¤–åŠ ç¨…", Value = ((int)TaxCalculationMethod.TaxExclusive).ToString() },
                new SelectOption { Text = "å…§å«ç¨…", Value = ((int)TaxCalculationMethod.TaxInclusive).ToString() },
                new SelectOption { Text = "ä¸å«ç¨…", Value = ((int)TaxCalculationMethod.NoTax).ToString() }
            };
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadAdditionalDataAsync), GetType(), 
                additionalData: "æ¡è³¼å–®ç·¨è¼¯Modalè¼‰å…¥é¡å¤–è³‡æ–™å¤±æ•—");
            
            // è¨­å®šå®‰å…¨çš„é è¨­å€¼
            supplierOptions = new List<SelectOption>();
            companyOptions = new List<SelectOption>();
            statusOptions = new List<SelectOption>();
            taxCalculationMethodOptions = new List<SelectOption>();
            availableProducts = new List<Product>();
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            // ä½¿ç”¨ ApprovalConfigHelper çµ±ä¸€åˆ¤æ–·æ˜¯å¦é–å®šæ¬„ä½
            var shouldLock = ApprovalConfigHelper.ShouldLockFieldByApproval(
                isApprovalEnabled,
                editModalComponent?.Entity?.IsApproved ?? false,
                hasUndeletableDetails
            );
            
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(PurchaseOrder.Code),
                    Label = "æ¡è³¼å–®è™Ÿ",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥æ¡è³¼å–®è™Ÿ",
                    IsRequired = true,
                    MaxLength = 30,
                    HelpText = "æ¡è³¼å–®çš„å”¯ä¸€ç·¨è™Ÿï¼Œæ–°å¢æ™‚ç³»çµ±æœƒè‡ªå‹•ç”¢ç”Ÿï¼Œä¹Ÿå¯æ‰‹å‹•ä¿®æ”¹",
                    IsReadOnly = shouldLock
                },
                new()
                {

                    PropertyName = nameof(PurchaseOrder.SupplierId),
                    Label = "å» å•†",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡å» å•†",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "è¼¸å…¥å» å•†åç¨±é€²è¡Œæœå°‹ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                    ActionButtons = await GetSupplierActionButtonsAsync(),
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(PurchaseOrder.CompanyId),
                    Label = "æ¡è³¼å…¬å¸",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹é¸æ“‡æ¡è³¼å…¬å¸",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "é¸æ“‡é€²è¡Œæ­¤æ¬¡æ¡è³¼çš„å…¬å¸",
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(PurchaseOrder.OrderDate),
                    Label = "æ¡è³¼æ—¥",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "æ¡è³¼å–®å»ºç«‹æ—¥æœŸ",
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(PurchaseOrder.ExpectedDeliveryDate),
                    Label = "äº¤è²¨æ—¥",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "é è¨ˆå» å•†äº¤è²¨çš„æ—¥æœŸ(é è¨­ç‚ºæ¡è³¼æ—¥å¾Œ7å¤©)",
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(PurchaseOrder.TaxCalculationMethod),
                    Label = "ç¨…åˆ¥",
                    FieldType = FormFieldType.Select,
                    IsRequired = true,
                    Options = taxCalculationMethodOptions,
                    HelpText = "é¸æ“‡ç¨…é¡è¨ˆç®—æ–¹å¼ï¼šå¤–åŠ ç¨…ï¼ˆç¨…é¡å¦è¨ˆï¼‰ã€å…§å«ç¨…ï¼ˆç¸½é¡å·²å«ç¨…ï¼‰ã€ä¸å«ç¨…ï¼ˆå…ç¨…ï¼‰",
                    IsReadOnly = shouldLock
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseOrder.TotalAmount),
                    Label = "é‡‘é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "æ¡è³¼å–®çš„ç¸½é‡‘é¡ï¼Œæ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—",
                    IsReadOnly = true, // ç¸½é‡‘é¡æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                    CssClass = "text-warning fw-bold" // ä½¿ç”¨é»ƒè‰²ç²—é«”é¡¯ç¤º
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseOrder.PurchaseTaxAmount),
                    Label = "ç¨…é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "æ¡è³¼å–®çš„ç¨…é¡ï¼Œæ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—",
                    IsReadOnly = true, // ç¨…é¡æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                    CssClass = "text-info fw-bold" // ä½¿ç”¨è—è‰²ç²—é«”é¡¯ç¤º
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseOrder.PurchaseTotalAmountIncludingTax),
                    Label = "ç¸½é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "æ¡è³¼å–®çš„å«ç¨…ç¸½é‡‘é¡ï¼Œæ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—",
                    IsReadOnly = true, // å«ç¨…ç¸½é‡‘é¡æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                    CssClass = "text-success fw-bold" // ä½¿ç”¨ç¶ è‰²ç²—é«”é¡¯ç¤º
                },

                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseOrder.RejectReason),
                    Label = "é§å›åŸå› ",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥é§å›åŸå› ",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "å…¶ä»–éœ€è¦è¨˜éŒ„çš„é§å›åŸå› ",
                    ContainerCssClass = "col-6",
                    IsReadOnly = true
                },

                FormFieldConfigurationHelper.CreateRemarksField<PurchaseOrder>(
                    containerCssClass: "col-6",
                    readOnly: shouldLock // æ ¹æ“šå¯©æ ¸ç‹€æ…‹å’Œæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                ),
            };

            formSections = FormSectionHelper<PurchaseOrder>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    po => po.Code,
                    po => po.SupplierId,
                    po => po.CompanyId,
                    po => po.OrderDate,
                    po => po.ExpectedDeliveryDate,
                    po => po.TaxCalculationMethod)
                .AddToSection(FormSectionNames.AmountInfoAutoCalculated,
                    po => po.TotalAmount,
                    po => po.PurchaseTaxAmount,
                    po => po.PurchaseTotalAmountIncludingTax)
                .AddToSection(FormSectionNames.AdditionalInfo,
                    po => po.RejectReason,
                    po => po.Remarks)
                .Build();
        }
        catch (Exception ex)
        {
            _ = ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(InitializeFormFieldsAsync), GetType(), 
                additionalData: "æ¡è³¼å–®ç·¨è¼¯Modalè¡¨å–®æ¬„ä½åˆå§‹åŒ–å¤±æ•—");
            
            // è¨­å®šå®‰å…¨çš„é è¨­å€¼
            formFields = new List<FormFieldDefinition>();
            formSections = new Dictionary<string, string>();
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }
    
    // ===== AutoComplete é…ç½®æ–¹æ³• =====
    
    /// <summary>
    /// é…ç½® Modal ç®¡ç†å™¨
    /// </summary>
    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(PurchaseOrder.SupplierId), supplierModalManager }
        };
    }
    
    /// <summary>
    /// é…ç½®è‡ªè¨‚æ¨¡çµ„
    /// </summary>
    private List<GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>.CustomModule> GetCustomModules()
    {
        // ç¢ºä¿åªåœ¨éœ€è¦æ™‚æ‰è¿”å›æ¨¡çµ„ï¼Œä¸¦ä¸”æª¢æŸ¥æ‰€æœ‰å¿…è¦çš„æ¢ä»¶
        if (editModalComponent == null)
        {
            return new List<GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>.CustomModule>();
        }

        return new List<GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>.CustomModule>
        {
            new GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>.CustomModule
            {
                // Title = "æ¡è³¼æ˜ç´°",
                Order = 1,
                // CssClass = "mt-4",
                IsVisible = true,
                Content = CreateProductManagerContent()
            }
        };
    }

    /// <summary>
    /// å‰µå»ºå•†å“ç®¡ç†å™¨å…§å®¹çš„ RenderFragment
    /// </summary>
    private RenderFragment CreateProductManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null)
            {
                // æª¢æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„å•†å“è³‡æ–™
                @if (availableProducts != null && availableProducts.Any())
                {
                    // æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡å» å•†
                    @if (editModalComponent.Entity.SupplierId > 0)
                    {
                        <PurchaseOrderTable @ref="purchaseOrderDetailManager"
                                                   TMainEntity="PurchaseOrder" 
                                                   TDetailEntity="PurchaseOrderDetail"
                                                   Products="@availableProducts"
                                                   SelectedSupplierId="@editModalComponent.Entity.SupplierId"
                                                   MainEntity="@editModalComponent.Entity"
                                                   ExistingDetails="@purchaseOrderDetails"
                                                   OnDetailsChanged="@HandleDetailsChanged"
                                                   MainEntityIdPropertyName="PurchaseOrderId"
                                                   QuantityPropertyName="OrderQuantity"
                                                   ReceivedQuantityPropertyName="ReceivedQuantity"
                                                   UnitPricePropertyName="UnitPrice"
                                                   RemarksPropertyName="Remarks"
                                                   IsReceivingCompletedPropertyName="IsReceivingCompleted"
                                                   IsReadOnly="false"
                                                   IsApproved="@(editModalComponent.Entity.IsApproved)"
                                                   TaxCalculationMethod="@editModalComponent.Entity.TaxCalculationMethod"
                                                   OnHasUndeletableDetailsChanged="@(async (hasUndeletable) => await HandleHasUndeletableDetailsChanged(hasUndeletable))"
                                                   OnOpenRelatedDocument="@(async (doc) => await HandleOpenRelatedDocument(doc))" />
                    }
                    else
                    {
                        <div class="alert alert-info text-center" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            è«‹å…ˆé¸æ“‡å» å•†å¾Œå†é€²è¡Œæ¡è³¼æ˜ç´°ç®¡ç†
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-warning text-center" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ç„¡å¯ç”¨çš„å•†å“è³‡æ–™ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡
                    </div>
                }
            }
            else
            {
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                è¼‰å…¥æ˜ç´°ç®¡ç†å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚
            </div>
        }
    };
    
    // ===== ActionButton ç”¢ç”Ÿæ–¹æ³• =====
    
    /// <summary>
    /// ç”¢ç”Ÿå» å•†æ“ä½œæŒ‰éˆ• - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetSupplierActionButtonsAsync()
    {
        // ä½¿ç”¨ ApprovalConfigHelper çµ±ä¸€åˆ¤æ–·æ˜¯å¦é–å®š
        var shouldLock = ApprovalConfigHelper.ShouldLockFieldByApproval(
            isApprovalEnabled,
            editModalComponent?.Entity?.IsApproved ?? false,
            hasUndeletableDetails
        );
        
        if (shouldLock)
        {
            return new List<FieldActionButton>();
        }
        
        var buttons = await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            supplierModalManager, 
            nameof(PurchaseOrder.SupplierId)
        );
        
        return buttons;
    }
    
    /// <summary>
    /// æ›´æ–°æ¬„ä½çš„å”¯è®€ç‹€æ…‹ - æ ¹æ“šæ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
    /// ä½¿ç”¨ FormFieldLockHelper çµ±ä¸€è™•ç†æ¬„ä½é–å®šé‚è¼¯
    /// </summary>
    private async void UpdateFieldsReadOnlyState()
    {
        // ä½¿ç”¨ FormFieldLockHelper æ‰¹æ¬¡é–å®š/è§£é–æ¬„ä½
        var fieldsToLock = new[]
        {
            nameof(PurchaseOrder.CompanyId),
            nameof(PurchaseOrder.Code),
            nameof(PurchaseOrder.OrderDate),
            nameof(PurchaseOrder.ExpectedDeliveryDate),
            nameof(PurchaseOrder.Remarks),
            nameof(PurchaseOrder.RejectReason)
        };
        
        // é–å®šæˆ–è§£é–ä¸€èˆ¬æ¬„ä½ï¼ˆä¸éœ€è¦ ActionButtonsï¼‰
        FormFieldLockHelper.LockMultipleFieldsSimple(
            formFields, 
            fieldsToLock, 
            isLocked: hasUndeletableDetails
        );
        
        // ç‰¹æ®Šè™•ç†å» å•†æ¬„ä½ï¼ˆéœ€è¦ ActionButtonsï¼‰
        if (hasUndeletableDetails)
        {
            // é–å®šï¼šç§»é™¤ ActionButtons
            FormFieldLockHelper.LockField(
                formFields,
                nameof(PurchaseOrder.SupplierId),
                isLocked: true
            );
        }
        else
        {
            // è§£é–ï¼šæ¢å¾© ActionButtons
            FormFieldLockHelper.LockField(
                formFields,
                nameof(PurchaseOrder.SupplierId),
                isLocked: false,
                actionButtonsGetter: GetSupplierActionButtonsAsync
            );
        }
        
        // é‡æ–°åˆå§‹åŒ–è¡¨å–®æ¬„ä½ä»¥å¼·åˆ¶æ›´æ–° UI
        await InvokeAsync(async () =>
        {
            await InitializeFormFieldsAsync();
            StateHasChanged();
        });
    }
    
    // ===== Modal äº‹ä»¶åŒ…è£å™¨æ–¹æ³• =====
    
    /// <summary>
    /// åŒ…è£å» å•†å„²å­˜äº‹ä»¶
    /// </summary>
    private async Task OnSupplierSavedWrapper(Supplier savedSupplier)
    {
        await supplierModalManager.HandleEntitySavedAsync(savedSupplier, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// è™•ç†æ¬„ä½å€¼è®Šæ›´äº‹ä»¶ - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // ä½¿ç”¨çµ±ä¸€ Helper è™•ç†å» å•†æ¬„ä½è®Šæ›´
            if (fieldChange.PropertyName == nameof(PurchaseOrder.SupplierId))
            {
                // æª¢æŸ¥æ˜¯å¦æ‡‰è©²é–å®šæ¬„ä½ï¼ˆé¿å…åœ¨é–å®šç‹€æ…‹ä¸‹é‡æ–°åŠ å…¥ ActionButtonsï¼‰
                var shouldLock = ApprovalConfigHelper.ShouldLockFieldByApproval(
                    isApprovalEnabled,
                    editModalComponent?.Entity?.IsApproved ?? false,
                    hasUndeletableDetails
                );
                
                // åªæœ‰åœ¨éé–å®šç‹€æ…‹ä¸‹æ‰æ›´æ–° ActionButtons
                if (!shouldLock)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        supplierModalManager, 
                        formFields, 
                        nameof(PurchaseOrder.SupplierId), 
                        fieldChange.Value
                    );
                }
                else
                {
                    // å¦‚æœæ˜¯é–å®šç‹€æ…‹ï¼Œç¢ºä¿ç§»é™¤ ActionButtons
                    var supplierField = formFields.FirstOrDefault(f => f.PropertyName == nameof(PurchaseOrder.SupplierId));
                    if (supplierField != null)
                    {
                        supplierField.ActionButtons = new List<FieldActionButton>();
                    }
                }
                
                // å» å•†è®Šæ›´æ™‚ï¼Œè§¸ç™¼å•†å“ç®¡ç†å™¨é‡æ–°æ¸²æŸ“
                StateHasChanged();
            }
            // è™•ç†ç¨…ç‡ç®—æ³•è®Šæ›´
            else if (fieldChange.PropertyName == nameof(PurchaseOrder.TaxCalculationMethod))
            {
                // ç¨…ç‡ç®—æ³•è®Šæ›´æ™‚ï¼Œé‡æ–°è¨ˆç®—ä¸»æª”é‡‘é¡
                if (editModalComponent?.Entity != null)
                {
                    // æ‰‹å‹•è§¸ç™¼æ˜ç´°è®Šæ›´äº‹ä»¶ï¼Œè®“é‡‘é¡é‡æ–°è¨ˆç®—
                    await HandleDetailsChanged(purchaseOrderDetails);
                    
                    // è§¸ç™¼ Table çµ„ä»¶é‡æ–°æ¸²æŸ“ï¼ˆå› ç‚ºç¨…ç‡ç®—æ³•å½±éŸ¿å°è¨ˆé¡¯ç¤ºï¼‰
                    StateHasChanged();
                }
            }
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("æ¬„ä½è®Šæ›´è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    // ===== æ¡è³¼æ˜ç´°ç®¡ç†æ–¹æ³• =====
    
    /// <summary>
    /// è™•ç†å¯¦é«”è¼‰å…¥å®Œæˆäº‹ä»¶ï¼ˆç”± GenericEditModalComponent çš„å°èˆªè§¸ç™¼ï¼‰
    /// ç•¶ä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼Œé‡æ–°è¼‰å…¥å°æ‡‰çš„æ˜ç´°è³‡æ–™
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            // ğŸ”‘ é—œéµä¿®å¾©ï¼šå°èˆªåˆ°å·²å­˜åœ¨çš„è¨˜éŒ„æ™‚ï¼Œå…è¨±è½‰å–®å’Œåˆ—å°
            // å› ç‚º NavigateToRecordAsync ä¸æœƒå‘¼å« LoadPurchaseOrderDataï¼Œ
            // æ‰€ä»¥éœ€è¦åœ¨é€™è£¡æ‰‹å‹•è¨­ç½®ç‹€æ…‹
            canCreateReceiving = true;
            canPrint = true;
            
            // é‡æ–°è¼‰å…¥æ˜ç´°è³‡æ–™
            await LoadPurchaseOrderDetails(loadedEntityId);
            
            // è§¸ç™¼ Table å…ƒä»¶åˆ·æ–°
            if (purchaseOrderDetailManager != null)
            {
                await purchaseOrderDetailManager.RefreshDetailsAsync();
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleEntityLoaded), GetType(), 
                additionalData: $"è™•ç†å¯¦é«”è¼‰å…¥äº‹ä»¶å¤±æ•— - EntityId: {loadedEntityId}");
            await NotificationService.ShowErrorAsync("è¼‰å…¥æ˜ç´°è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    /// <summary>
    /// è™•ç†æœ‰ä¸å¯åˆªé™¤æ˜ç´°çš„ç‹€æ…‹è®Šæ›´
    /// ç•¶æ˜ç´°å‹•æ…‹è®ŠåŒ–æ™‚ï¼ˆæ–°å¢é€²è²¨ã€åˆªé™¤é€²è²¨è¨˜éŒ„ç­‰ï¼‰ï¼Œé€™å€‹æ–¹æ³•æœƒè¢«èª¿ç”¨
    /// </summary>
    private async Task HandleHasUndeletableDetailsChanged(bool hasUndeletable)
    {
        try
        {
            hasUndeletableDetails = hasUndeletable;
            
            // æ›´æ–°æ¬„ä½çš„å”¯è®€ç‹€æ…‹
            UpdateFieldsReadOnlyState();
            
            // âŒ ç§»é™¤ StateHasChanged() - é¿å…é‡è¤‡æ¸²æŸ“
            // StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†æ˜ç´°é–å®šç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }
    
    /// <summary>
    /// è¼‰å…¥æ¡è³¼å–®æ˜ç´°
    /// </summary>
    private async Task LoadPurchaseOrderDetails(int purchaseOrderId)
    {
        try
        {
            // å¾æœå‹™è¼‰å…¥æ¡è³¼å–®æ˜ç´°
            purchaseOrderDetails = await PurchaseOrderService.GetOrderDetailsAsync(purchaseOrderId);
            
            // ç¢ºä¿ä¸æ˜¯ null
            if (purchaseOrderDetails == null)
            {
                purchaseOrderDetails = new List<PurchaseOrderDetail>();
            }
            
            //  è¼‰å…¥æ˜ç´°å¾Œ,æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°(æœ‰é€²è²¨è¨˜éŒ„)
            var hasReceiving = purchaseOrderDetails.Any(d => d.ReceivedQuantity > 0);
            await HandleHasUndeletableDetailsChanged(hasReceiving);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadPurchaseOrderDetails), GetType(), 
                additionalData: $"è¼‰å…¥æ¡è³¼å–®æ˜ç´°å¤±æ•— - OrderId: {purchaseOrderId}");
            purchaseOrderDetails = new List<PurchaseOrderDetail>();
        }
    }

    /// <summary>
    /// è™•ç†æ¡è³¼æ˜ç´°è®Šæ›´
    /// </summary>
    private async Task HandleDetailsChanged(List<PurchaseOrderDetail> details)
    {
        try
        {
            purchaseOrderDetails = details ?? new List<PurchaseOrderDetail>();            
            
            // æ›´æ–°ä¸»æª”çš„ç¸½é‡‘é¡ã€ç¨…é¡ã€å«ç¨…ç¸½é¡
            if (editModalComponent?.Entity != null)
            {
                var taxMethod = editModalComponent.Entity.TaxCalculationMethod;
                
                switch (taxMethod)
                {
                    case TaxCalculationMethod.TaxExclusive:
                        // å¤–åŠ ç¨…ï¼šé‡‘é¡ = æ˜ç´°å°è¨ˆï¼Œç¨…é¡ = é‡‘é¡ Ã— ç¨…ç‡%ï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
                        editModalComponent.Entity.TotalAmount = Math.Round(purchaseOrderDetails.Sum(d => d.SubtotalAmount), 0, MidpointRounding.AwayFromZero);
                        editModalComponent.Entity.PurchaseTaxAmount = purchaseOrderDetails.Sum(d => 
                        {
                            var detailTaxRate = d.TaxRate ?? currentTaxRate;
                            var detailTaxAmount = d.SubtotalAmount * (detailTaxRate / 100m);
                            return Math.Round(detailTaxAmount, 0, MidpointRounding.AwayFromZero);
                        });
                        break;
                        
                    case TaxCalculationMethod.TaxInclusive:
                        // å…§å«ç¨…ï¼šç¸½é¡ = æ˜ç´°å°è¨ˆï¼Œé‡‘é¡ = ç¸½é¡ / (1 + ç¨…ç‡%)ï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰ï¼Œç¨…é¡ = ç¸½é¡ - é‡‘é¡
                        var totalWithTax = purchaseOrderDetails.Sum(d => d.SubtotalAmount);
                        var totalTax = purchaseOrderDetails.Sum(d =>
                        {
                            var detailTaxRate = d.TaxRate ?? currentTaxRate;
                            // åæ¨ç¨…é¡ = å«ç¨…ç¸½é¡ / (1 + ç¨…ç‡%) Ã— ç¨…ç‡%ï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
                            var detailTaxAmount = d.SubtotalAmount / (1 + detailTaxRate / 100m) * (detailTaxRate / 100m);
                            return Math.Round(detailTaxAmount, 0, MidpointRounding.AwayFromZero);
                        });
                        editModalComponent.Entity.TotalAmount = Math.Round(totalWithTax - totalTax, 0, MidpointRounding.AwayFromZero);
                        editModalComponent.Entity.PurchaseTaxAmount = totalTax;
                        break;
                        
                    case TaxCalculationMethod.NoTax:
                        // å…ç¨…ï¼šé‡‘é¡ = æ˜ç´°å°è¨ˆï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰ï¼Œç¨…é¡ = 0
                        editModalComponent.Entity.TotalAmount = Math.Round(purchaseOrderDetails.Sum(d => d.SubtotalAmount), 0, MidpointRounding.AwayFromZero);
                        editModalComponent.Entity.PurchaseTaxAmount = 0;
                        break;
                        
                    default:
                        // é è¨­ä½¿ç”¨å¤–åŠ ç¨…ï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
                        editModalComponent.Entity.TotalAmount = Math.Round(purchaseOrderDetails.Sum(d => d.SubtotalAmount), 0, MidpointRounding.AwayFromZero);
                        editModalComponent.Entity.PurchaseTaxAmount = purchaseOrderDetails.Sum(d => 
                        {
                            var detailTaxRate = d.TaxRate ?? currentTaxRate;
                            var detailTaxAmount = d.SubtotalAmount * (detailTaxRate / 100m);
                            return Math.Round(detailTaxAmount, 0, MidpointRounding.AwayFromZero);
                        });
                        break;
                }
                
                // 3. å«ç¨…ç¸½é‡‘é¡æœƒè‡ªå‹•è¨ˆç®—ï¼ˆPurchaseTotalAmountIncludingTax æ˜¯è¨ˆç®—å±¬æ€§ï¼‰
                //    = TotalAmount + PurchaseTaxAmount
                
                // âŒ ç§»é™¤ StateHasChanged() - è®“å‘¼å«è€…çµ±ä¸€è™•ç†æ¸²æŸ“
                // StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDetailsChanged), GetType(), 
                additionalData: "è™•ç†æ¡è³¼æ˜ç´°è®Šæ›´å¤±æ•—");
        }
    }

    /// <summary>
    /// é©—è­‰æ¡è³¼å–®æ˜ç´° - ç¢ºä¿è‡³å°‘æœ‰ä¸€ç­†æ˜ç´°
    /// </summary>
    private async Task<bool> ValidatePurchaseOrderDetailsAsync(PurchaseOrder purchaseOrder)
    {
        try
        {
            // å¦‚æœæ˜ç´°ç®¡ç†çµ„ä»¶å­˜åœ¨ï¼ŒåŸ·è¡Œé©—è­‰
            if (purchaseOrderDetailManager != null)
            {
                @* return await purchaseOrderDetailManager.ValidateAsync(); *@
            }
            
            // å¦‚æœçµ„ä»¶ä¸å­˜åœ¨ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„æ˜ç´°ï¼ˆè‡³å°‘é¸æ“‡äº†å•†å“ï¼‰
            var validDetails = purchaseOrderDetails.Where(d => d.ProductId > 0).ToList();
            
            if (!validDetails.Any())
            {
                await NotificationService.ShowErrorAsync("æ¡è³¼å–®å¿…é ˆè‡³å°‘åŒ…å«ä¸€ç­†æ˜ç´°è³‡æ–™");
                return false;
            }
            
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é©—è­‰æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// åŒ…è£æ–¹æ³• - æä¾›çµ¦ GenericEditModalComponent ä½¿ç”¨çš„å„²å­˜è™•ç†å™¨
    /// </summary>
    private async Task<bool> SavePurchaseOrderWrapper(PurchaseOrder purchaseOrder)
    {
        // å…ˆåŸ·è¡Œè‡ªè¨‚é©—è­‰
        if (!await ValidatePurchaseOrderDetailsAsync(purchaseOrder))
        {
            return false;
        }
        
        var result = await SavePurchaseOrderWithDetails(purchaseOrder, isPreApprovalSave: false);
        
        // å„²å­˜æˆåŠŸå¾Œå…è¨±è½‰é€²è²¨å’Œåˆ—å°
        if (result)
        {
            canCreateReceiving = true;
            canPrint = true;
        }
        
        return result;
    }

    /// <summary>
    /// è‡ªè¨‚å„²å­˜é‚è¼¯ - åŒæ™‚å„²å­˜ä¸»æª”å’Œæ˜ç´°
    /// ç‰¹æ®Šè™•ç†ï¼šå¯©æ ¸é€šéå¾Œä»å…è¨±å„²å­˜ï¼Œç”¨æ–¼æ›´æ–°æ˜ç´°çš„ã€Œå®Œæˆé€²è²¨ã€ç­‰åŸ·è¡Œç‹€æ…‹
    /// </summary>
    private async Task<bool> SavePurchaseOrderWithDetails(PurchaseOrder purchaseOrder, bool isPreApprovalSave = false)
    {
        try
        {
            if (purchaseOrder == null)
            {
                await NotificationService.ShowErrorAsync("æ²’æœ‰è¦å„²å­˜çš„æ¡è³¼å–®è³‡æ–™");
                return false;
            }

            //  ä¿®æ”¹ï¼šå¯©æ ¸é€šéå¾Œä»å…è¨±å„²å­˜ï¼ˆç”¨æ–¼æ›´æ–°ã€Œå®Œæˆé€²è²¨ã€ç­‰åŸ·è¡Œç‹€æ…‹ï¼‰
            // ä¸ä½¿ç”¨ ApprovalConfigHelper.CanSaveWhenApproved çš„é™åˆ¶
            // å› ç‚ºæ˜ç´°ä¸­çš„ã€Œå®Œæˆé€²è²¨ã€æ¬„ä½éœ€è¦åœ¨å¯©æ ¸å¾Œä»å¯ä¿®æ”¹
            
            // æ›´æ–°ç¸½é‡‘é¡å’Œç¨…é¡ï¼ˆä½¿ç”¨èˆ‡ HandleDetailsChanged ç›¸åŒçš„é‚è¼¯ï¼‰
            var taxMethod = purchaseOrder.TaxCalculationMethod;
            
            switch (taxMethod)
            {
                case TaxCalculationMethod.TaxExclusive:
                    // å¤–åŠ ç¨…ï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
                    purchaseOrder.TotalAmount = Math.Round(purchaseOrderDetails.Sum(d => d.SubtotalAmount), 0, MidpointRounding.AwayFromZero);
                    purchaseOrder.PurchaseTaxAmount = purchaseOrderDetails.Sum(d => 
                    {
                        var detailTaxRate = d.TaxRate ?? currentTaxRate;
                        var detailTaxAmount = d.SubtotalAmount * (detailTaxRate / 100m);
                        return Math.Round(detailTaxAmount, 0, MidpointRounding.AwayFromZero);
                    });
                    break;
                    
                case TaxCalculationMethod.TaxInclusive:
                    // å…§å«ç¨…ï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
                    var totalWithTax = purchaseOrderDetails.Sum(d => d.SubtotalAmount);
                    var totalTax = purchaseOrderDetails.Sum(d =>
                    {
                        var detailTaxRate = d.TaxRate ?? currentTaxRate;
                        var detailTaxAmount = d.SubtotalAmount / (1 + detailTaxRate / 100m) * (detailTaxRate / 100m);
                        return Math.Round(detailTaxAmount, 0, MidpointRounding.AwayFromZero);
                    });
                    purchaseOrder.TotalAmount = Math.Round(totalWithTax - totalTax, 0, MidpointRounding.AwayFromZero);
                    purchaseOrder.PurchaseTaxAmount = totalTax;
                    break;
                    
                case TaxCalculationMethod.NoTax:
                    // å…ç¨…ï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
                    purchaseOrder.TotalAmount = Math.Round(purchaseOrderDetails.Sum(d => d.SubtotalAmount), 0, MidpointRounding.AwayFromZero);
                    purchaseOrder.PurchaseTaxAmount = 0;
                    break;
                    
                default:
                    // é è¨­ä½¿ç”¨å¤–åŠ ç¨…ï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
                    purchaseOrder.TotalAmount = Math.Round(purchaseOrderDetails.Sum(d => d.SubtotalAmount), 0, MidpointRounding.AwayFromZero);
                    purchaseOrder.PurchaseTaxAmount = purchaseOrderDetails.Sum(d => 
                    {
                        var detailTaxRate = d.TaxRate ?? currentTaxRate;
                        var detailTaxAmount = d.SubtotalAmount * (detailTaxRate / 100m);
                        return Math.Round(detailTaxAmount, 0, MidpointRounding.AwayFromZero);
                    });
                    break;
            }

            // å„²å­˜ä¸»æª”
            ServiceResult<PurchaseOrder> result;
            bool isNewRecord = !PurchaseOrderId.HasValue;
            
            if (PurchaseOrderId.HasValue)
            {
                result = await PurchaseOrderService.UpdateAsync(purchaseOrder);
            }
            else
            {
                // ğŸ”‘ ç¢ºä¿æ–°å¢æ¨¡å¼ä¸‹ Id ç‚º 0ï¼ˆé¿å… IDENTITY_INSERT éŒ¯èª¤ï¼‰
                purchaseOrder.Id = 0;
                result = await PurchaseOrderService.CreateAsync(purchaseOrder);
            }

            if (!result.IsSuccess || result.Data == null)
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "å„²å­˜æ¡è³¼å–®å¤±æ•—");
                return false;
            }

            // é—œéµä¿®å¾©ï¼šå¦‚æœæ˜¯æ–°å¢æ¨¡å¼ï¼Œæ›´æ–°å¯¦é«”çš„ ID å’Œåƒæ•¸
            // ç¢ºä¿ GenericEditModalComponent èƒ½æ­£ç¢ºåµæ¸¬åˆ°å¾æ–°å¢è½‰ç‚ºç·¨è¼¯æ¨¡å¼
            if (isNewRecord && result.Data.Id > 0)
            {
                // ğŸ”‘ ä¿®å¾©1ï¼šæ›´æ–°å‚³å…¥çš„å¯¦é«”ç‰©ä»¶ IDï¼ˆè®“ GenericEditModalComponent èƒ½åµæ¸¬åˆ°ï¼‰
                purchaseOrder.Id = result.Data.Id;
                
                // ğŸ”‘ ä¿®å¾©2ï¼šæ›´æ–°çµ„ä»¶åƒæ•¸ï¼ˆç”¨æ–¼å¾ŒçºŒåˆ¤æ–·æ¨¡å¼ï¼‰
                PurchaseOrderId = result.Data.Id;
            }

            // å„²å­˜æ˜ç´°
            await SavePurchaseOrderDetails(result.Data.Id);

            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SavePurchaseOrderWithDetails), GetType(), 
                additionalData: "å„²å­˜æ¡è³¼å–®å’Œæ˜ç´°å¤±æ•—");
            await NotificationService.ShowErrorAsync($"å„²å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// å„²å­˜æ¡è³¼å–®æ˜ç´°
    /// </summary>
    private async Task SavePurchaseOrderDetails(int purchaseOrderId)
    {
        try
        {
            // è¨­å®šä¸»æª”ID
            foreach (var detail in purchaseOrderDetails)
            {
                detail.PurchaseOrderId = purchaseOrderId;
                if (detail.Id == 0)
                {
                    detail.Status = EntityStatus.Active;
                    detail.CreatedAt = DateTime.Now;
                }
                else
                {
                    detail.UpdatedAt = DateTime.Now;
                }
            }

            // å…ˆç²å–ç¾æœ‰çš„æ˜ç´°
            var existingDetails = await PurchaseOrderService.GetOrderDetailsAsync(purchaseOrderId);
            
            // è™•ç†æ–°å¢å’Œæ›´æ–°çš„æ˜ç´°
            foreach (var detail in purchaseOrderDetails.Where(d => d.ProductId > 0))
            {
                if (detail.Id == 0)
                {
                    // æ–°å¢æ˜ç´°
                    await PurchaseOrderService.AddOrderDetailAsync(detail);
                }
                else
                {
                    // æ›´æ–°æ˜ç´°
                    await PurchaseOrderService.UpdateOrderDetailAsync(detail);
                }
            }

            // è™•ç†åˆªé™¤çš„æ˜ç´°ï¼ˆç¾æœ‰çš„ä½†ä¸åœ¨ç•¶å‰åˆ—è¡¨ä¸­çš„ï¼‰
            var currentDetailIds = purchaseOrderDetails.Where(d => d.Id > 0).Select(d => d.Id).ToList();
            var detailsToDelete = existingDetails.Where(e => !currentDetailIds.Contains(e.Id)).ToList();
            
            foreach (var detailToDelete in detailsToDelete)
            {
                await PurchaseOrderService.DeleteOrderDetailAsync(detailToDelete.Id);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SavePurchaseOrderDetails), GetType(), 
                additionalData: $"å„²å­˜æ¡è³¼å–®æ˜ç´°å¤±æ•— - OrderId: {purchaseOrderId}");
            throw; // é‡æ–°æ‹‹å‡ºä¾‹å¤–ï¼Œè®“ä¸Šå±¤è™•ç†
        }
    }
    
    // ===== å¯©æ ¸ç›¸é—œæ–¹æ³• =====
    
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦æ‡‰è©²é¡¯ç¤ºå¯©æ ¸å€åŸŸ
    /// </summary>
    private bool ShouldShowApprovalSection()
    {
        // æ–°é‚è¼¯ï¼šåªæœ‰åœ¨å•Ÿç”¨å¯©æ ¸ + ç·¨è¼¯ç¾æœ‰å–®æ“šæ™‚æ‰é¡¯ç¤º
        return isApprovalEnabled && 
               PurchaseOrderId.HasValue && 
               PurchaseOrderId.Value > 0;
    }
    
    /// <summary>
    /// è™•ç†æ¡è³¼å–®å¯©æ ¸é€šé
    /// </summary>
    private async Task<bool> HandlePurchaseOrderApprove()
    {
        try
        {
            if (!PurchaseOrderId.HasValue)
            {
                await NotificationService.ShowErrorAsync("ç„¡æ³•å¯©æ ¸ï¼šæ¡è³¼å–®IDä¸å­˜åœ¨");
                return false;
            }
            
            // ç¢ºèªå°è©±æ¡†
            var confirmed = await NotificationService.ShowConfirmAsync(
                "ç¢ºå®šè¦å¯©æ ¸é€šéæ­¤æ¡è³¼å–®å—ï¼Ÿç³»çµ±å°‡å…ˆå„²å­˜ç•¶å‰è³‡æ–™ï¼Œç„¶å¾Œé€²è¡Œå¯©æ ¸ã€‚å¯©æ ¸é€šéå¾Œå°‡ç„¡æ³•å†ä¿®æ”¹ã€‚", 
                "å¯©æ ¸ç¢ºèª");
            
            if (!confirmed)
                return false;
            
            // **æ–¹æ¡ˆä¸€å¯¦æ–½ï¼šå¯©æ ¸å‰å…ˆè‡ªå‹•å„²å­˜**
            if (editModalComponent?.Entity != null)
            {
                // æš«æ™‚å…è¨±å„²å­˜ï¼ˆå³ä½¿å·²æ ¸å‡†ç‹€æ…‹ä¹Ÿè¦èƒ½å„²å­˜ï¼Œå› ç‚ºå¯èƒ½æœ‰æœªå„²å­˜çš„è®Šæ›´ï¼‰
                var saveResult = await SavePurchaseOrderWithDetails(editModalComponent.Entity, isPreApprovalSave: true);
                if (!saveResult)
                {
                    await NotificationService.ShowErrorAsync("å„²å­˜å¤±æ•—ï¼Œç„¡æ³•é€²è¡Œå¯©æ ¸");
                    return false;
                }                
            }
            
            // å‘¼å«æœå‹™é€²è¡Œå¯©æ ¸
            var currentUserId = await GetCurrentUserIdAsync();
            if (!currentUserId.HasValue)
            {
                await NotificationService.ShowErrorAsync("ç„¡æ³•å–å¾—ç•¶å‰ä½¿ç”¨è€…è³‡è¨Š");
                return false;
            }
            
            var result = await PurchaseOrderService.ApproveOrderAsync(PurchaseOrderId.Value, currentUserId.Value);
            
            if (result.IsSuccess)
            {
                return true;
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "å¯©æ ¸é€šéå¤±æ•—");
                return false;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePurchaseOrderApprove), GetType(), 
                additionalData: $"æ¡è³¼å–®å¯©æ ¸é€šéå¤±æ•— - OrderId: {PurchaseOrderId}");
            await NotificationService.ShowErrorAsync($"å¯©æ ¸é€šéæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }
    
    /// <summary>
    /// è™•ç†æ¡è³¼å–®å¯©æ ¸é§å›ï¼ˆå¸¶é§å›åŸå› ï¼‰
    /// </summary>
    private async Task<bool> HandlePurchaseOrderRejectWithReason(string rejectReason)
    {
        try
        {
            if (!PurchaseOrderId.HasValue)
            {
                await NotificationService.ShowErrorAsync("ç„¡æ³•å¯©æ ¸ï¼šæ¡è³¼å–®IDä¸å­˜åœ¨");
                return false;
            }
            
            // é§å›åŸå› å·²å¾ Modal ä¸­ç²å¾—ï¼Œä¸éœ€è¦å†æ¬¡ç¢ºèª
            
            // å–å¾—ç•¶å‰ä½¿ç”¨è€…ID
            var currentUserId = await GetCurrentUserIdAsync();
            if (!currentUserId.HasValue)
            {
                await NotificationService.ShowErrorAsync("ç„¡æ³•å–å¾—ç•¶å‰ä½¿ç”¨è€…è³‡è¨Š");
                return false;
            }
            
            // å‘¼å«æœå‹™é€²è¡Œé§å›
            var result = await PurchaseOrderService.RejectOrderAsync(PurchaseOrderId.Value, currentUserId.Value, rejectReason);
            
            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync("æ¡è³¼å–®å·²é§å›");
                // é‡æ–°è¼‰å…¥è³‡æ–™ä»¥æ›´æ–°ç•Œé¢
                if (editModalComponent != null)
                {
                    await editModalComponent.RefreshEntityAsync();
                }
                return true;
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "é§å›å¤±æ•—");
                return false;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePurchaseOrderRejectWithReason), GetType(), 
                additionalData: $"æ¡è³¼å–®å¯©æ ¸é§å›å¤±æ•— - OrderId: {PurchaseOrderId}");
            await NotificationService.ShowErrorAsync($"å¯©æ ¸é§å›æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }
    
    /// <summary>
    /// è™•ç†æ¡è³¼å–®å¯©æ ¸é§å›ï¼ˆèˆŠç‰ˆæœ¬ï¼Œä¿ç•™å‘ä¸‹ç›¸å®¹ï¼‰
    /// </summary>
    private async Task<bool> HandlePurchaseOrderReject()
    {
        try
        {
            if (!PurchaseOrderId.HasValue)
            {
                await NotificationService.ShowErrorAsync("ç„¡æ³•å¯©æ ¸ï¼šæ¡è³¼å–®IDä¸å­˜åœ¨");
                return false;
            }
            
            // ä½¿ç”¨ JavaScript prompt ä¾†å–å¾—é§å›åŸå› 
            var rejectReason = await JSRuntime.InvokeAsync<string>("prompt", "è«‹è¼¸å…¥é§å›åŸå› ï¼š", "");
            
            if (string.IsNullOrWhiteSpace(rejectReason))
            {
                await NotificationService.ShowWarningAsync("é§å›åŸå› ä¸èƒ½ç‚ºç©º");
                return false;
            }
            
            // ç¢ºèªå°è©±æ¡†
            var confirmed = await NotificationService.ShowConfirmAsync(
                $"ç¢ºå®šè¦é§å›æ­¤æ¡è³¼å–®å—ï¼Ÿ\né§å›åŸå› ï¼š{rejectReason}\n\né§å›å¾Œæ¡è³¼å–®å°‡é€€å›ä¿®æ”¹ã€‚", 
                "å¯©æ ¸ç¢ºèª");
            
            if (!confirmed)
                return false;
            
            // å–å¾—ç•¶å‰ä½¿ç”¨è€…ID
            var currentUserId = await GetCurrentUserIdAsync();
            if (!currentUserId.HasValue)
            {
                await NotificationService.ShowErrorAsync("ç„¡æ³•å–å¾—ç•¶å‰ä½¿ç”¨è€…è³‡è¨Š");
                return false;
            }
            
            // å‘¼å«æœå‹™é€²è¡Œé§å›
            var result = await PurchaseOrderService.RejectOrderAsync(PurchaseOrderId.Value, currentUserId.Value, rejectReason);
            
            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync("æ¡è³¼å–®å·²é§å›");
                // é‡æ–°è¼‰å…¥è³‡æ–™ä»¥æ›´æ–°ç•Œé¢
                if (editModalComponent != null)
                {
                    await editModalComponent.RefreshEntityAsync();
                }
                return true;
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "é§å›å¤±æ•—");
                return false;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePurchaseOrderReject), GetType(), 
                additionalData: $"æ¡è³¼å–®å¯©æ ¸é§å›å¤±æ•— - OrderId: {PurchaseOrderId}");
            await NotificationService.ShowErrorAsync($"å¯©æ ¸é§å›æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }
    
    /// <summary>
    /// å–å¾—è­¦å‘Šè¨Šæ¯ï¼ˆé¡¯ç¤ºåœ¨è¡¨å–®æ¬„ä½ä¸Šæ–¹ï¼‰- ä½œç‚ºå±¬æ€§ä»¥ç¢ºä¿æ­£ç¢ºçš„æ¸²æŸ“æ™‚æ©Ÿ
    /// ç•¶æ¡è³¼å–®å·²å¯©æ ¸é€šéæˆ–æ˜ç´°æœ‰é€²è²¨è¨˜éŒ„æ™‚ï¼Œé¡¯ç¤ºé–å®šè­¦å‘Šè¨Šæ¯
    /// </summary>
    private RenderFragment? WarningMessage => __builder =>
    {
        @* å¯©æ ¸é€šéçš„è¨Šæ¯ *@
        <GenericLockedFieldMessage IsVisible="@(isApprovalEnabled && editModalComponent?.Entity?.IsApproved == true)"
                                  Message="æ¡è³¼å–®å·²å¯©æ ¸é€šéï¼Œä¸»æª”æ¬„ä½å·²é–å®šã€‚æ‚¨ä»å¯ä¿®æ”¹æ˜ç´°çš„ã€Œå®Œæˆé€²è²¨ã€ç‹€æ…‹ä¸¦å„²å­˜ã€‚" />
        
        @* æ˜ç´°æœ‰å…¶ä»–å‹•ä½œçš„è¨Šæ¯ *@
        <GenericLockedFieldMessage IsVisible="@hasUndeletableDetails"
                                  Message="å› éƒ¨åˆ†æ˜ç´°æœ‰å…¶ä»–å‹•ä½œï¼Œç‚ºä¿è­·è³‡æ–™å®Œæ•´æ€§ä¸»æª”æ¬„ä½å·²è¨­å”¯è®€ã€‚" />
    };
    
    /// <summary>
    /// å–å¾—è‡ªè¨‚æ“ä½œæŒ‰éˆ•ï¼ˆé¡¯ç¤ºåœ¨ Modal é ‚éƒ¨å·¦å´ï¼‰- ä½œç‚ºå±¬æ€§ä»¥ç¢ºä¿æ­£ç¢ºçš„æ¸²æŸ“æ™‚æ©Ÿ
    /// </summary>
    private RenderFragment? CustomActionButtons => __builder =>
    {
        @* è½‰é€²è²¨å–®æŒ‰éˆ• - æ–°å¢æ¨¡å¼éœ€å…ˆå„²å­˜ï¼Œç·¨è¼¯æ¨¡å¼ç›´æ¥å¯ç”¨ *@
            <GenericButtonComponent Text="è½‰é€²è²¨" 
                                  Variant="ButtonVariant.Green" 
                                  OnClick="HandleCreateReceivingFromOrder" />        
    };
    
    /// <summary>
    /// å–å¾—ç•¶å‰ä½¿ç”¨è€…ID
    /// </summary>
    private async Task<int?> GetCurrentUserIdAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (!user.Identity?.IsAuthenticated ?? true)
                return null;

            // å¾Claimsä¸­å–å¾—ä½¿ç”¨è€…ID (é€šå¸¸å­˜åœ¨NameIdentifierä¸­)
            var employeeIdClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (int.TryParse(employeeIdClaim, out int employeeId))
                return employeeId;

            return null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetCurrentUserIdAsync), GetType(), 
                additionalData: "å–å¾—ç•¶å‰ä½¿ç”¨è€…IDå¤±æ•—");
            return null;
        }
    }
    
    // ===== ç›¸é—œå–®æ“šé–‹å•Ÿè™•ç†æ–¹æ³• =====
    
    /// <summary>
    /// è™•ç†é–‹å•Ÿç›¸é—œå–®æ“šçš„äº‹ä»¶
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            switch (args.type)
            {
                case RelatedDocumentType.ReceivingDocument:
                    // é–‹å•Ÿé€²è²¨å–® Modal
                    selectedPurchaseReceivingId = args.id;
                    showPurchaseReceivingModal = true;
                    StateHasChanged();
                    break;
                    
                default:
                    await NotificationService.ShowWarningAsync($"ä¸æ”¯æ´çš„å–®æ“šé¡å‹ï¼š{args.type}");
                    break;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleOpenRelatedDocument), GetType(), 
                additionalData: $"é–‹å•Ÿç›¸é—œå–®æ“šå¤±æ•— - Type: {args.type}, Id: {args.id}");
            await NotificationService.ShowErrorAsync("é–‹å•Ÿå–®æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    /// <summary>
    /// è™•ç†é€²è²¨å–®å„²å­˜å¾Œçš„äº‹ä»¶
    /// ä½¿ç”¨ ChildDocumentRefreshHelper çµ±ä¸€è™•ç†åˆ·æ–°é‚è¼¯
    /// </summary>
    private async Task HandlePurchaseReceivingSaved(PurchaseReceiving savedReceiving)
    {
        try
        {
            await ChildDocumentRefreshHelper.HandleChildDocumentSavedAsync(
                closeModal: () =>
                {
                    showPurchaseReceivingModal = false;
                    selectedPurchaseReceivingId = null;
                },
                reloadDetails: async () =>
                {
                    if (PurchaseOrderId.HasValue)
                    {
                        await LoadPurchaseOrderDetails(PurchaseOrderId.Value);
                    }
                },
                detailManager: purchaseOrderDetailManager,
                notificationMessage: null, // ç¨å¾Œæ‰‹å‹•é¡¯ç¤ºé€šçŸ¥
                stateHasChanged: StateHasChanged,
                invokeAsync: InvokeAsync,
                additionalActions: () =>
                {
                    // é—œéµä¿®å¾©ï¼šå‘¼å« Table çµ„ä»¶çš„å…¬é–‹åˆ·æ–°æ–¹æ³•
                    // å› ç‚ºçˆ¶ Modal æ²’æœ‰é—œé–‰ï¼ŒTable çµ„ä»¶ä¸æœƒè‡ªå‹•é‡æ–°è¼‰å…¥
                    // éœ€è¦ä¸»å‹•å‘¼å«åˆ·æ–°æ–¹æ³•ä¾†æ›´æ–° UI é¡¯ç¤º
                    @* if (purchaseOrderDetailManager != null)
                    {
                        await purchaseOrderDetailManager.RefreshDetailsAsync();
                    } *@
                    return Task.CompletedTask;
                }
            );
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            await NotificationService.ShowSuccessAsync($"é€²è²¨å–® {savedReceiving.Code} å·²æ›´æ–°ï¼Œæ¡è³¼æ˜ç´°å·²åˆ·æ–°");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePurchaseReceivingSaved), GetType(), 
                additionalData: $"è™•ç†é€²è²¨å–®å„²å­˜äº‹ä»¶å¤±æ•— - ReceivingId: {savedReceiving?.Id}");
        }
    }
    
    /// <summary>
    /// å¾æ¡è³¼å–®è½‰é€²è²¨å–® - ç°¡åŒ–ç‰ˆæœ¬ï¼Œæ‰€æœ‰æ¥­å‹™é©—è­‰äº¤çµ¦é€²è²¨å–® Modal è™•ç†
    /// </summary>
    private async Task HandleCreateReceivingFromOrder()
    {
        try
        {
            // å”¯ä¸€æª¢æŸ¥ï¼šç¢ºèªæ˜¯å¦å·²å„²å­˜ï¼ˆæ–°å¢æ¨¡å¼éœ€å…ˆå„²å­˜ï¼Œç·¨è¼¯æ¨¡å¼ç›´æ¥é€šéï¼‰
            if (!canCreateReceiving)
            {
                await NotificationService.ShowWarningAsync("è«‹å…ˆå„²å­˜æ¡è³¼å–®å¾Œï¼Œæ‰èƒ½è½‰é€²è²¨å–®");
                return;
            }
            
            // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ Entity å·²è¼‰å…¥ï¼ˆcanCreateReceiving = true æ™‚ç†è«–ä¸Šä¸€å®šæœ‰å€¼ï¼‰
            if (editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("æ¡è³¼å–®è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å» å•†è³‡æ–™
            if (editModalComponent.Entity.SupplierId <= 0)
            {
                await NotificationService.ShowWarningAsync("æ¡è³¼å–®ç¼ºå°‘å» å•†è³‡è¨Šï¼Œç„¡æ³•è½‰é€²è²¨å–®");
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ˜ç´°è³‡æ–™
            if (!purchaseOrderDetails.Any())
            {
                await NotificationService.ShowWarningAsync("æ¡è³¼å–®æ²’æœ‰æ˜ç´°è³‡æ–™ï¼Œç„¡æ³•è½‰é€²è²¨å–®");
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰æ˜ç´°éƒ½å·²å®Œæˆé€²è²¨ï¼ˆå·²é€²æ•¸é‡ >= æ¡è³¼æ•¸é‡ï¼‰
            var hasIncompleteDetails = purchaseOrderDetails.Any(detail => 
                detail.ReceivedQuantity < detail.OrderQuantity
            );
            
            if (!hasIncompleteDetails)
            {
                await NotificationService.ShowWarningAsync("æ¡è³¼å–®æ‰€æœ‰æ˜ç´°çš†å·²å®Œæˆé€²è²¨ï¼Œç„¡éœ€å†è½‰å–®");
                return;
            }
            
            // ç›´æ¥é–‹å•Ÿé€²è²¨å–® Modalï¼Œä½¿ç”¨ Entity.Id ä½œç‚ºæ¡è³¼å–® IDï¼ˆæœ€å¯é çš„ä¾†æºï¼‰
            await purchaseReceivingEditModal!.ShowAddModalWithPrefilledOrder(
                editModalComponent.Entity.SupplierId,
                editModalComponent.Entity.Id  // ä½¿ç”¨ Entity.Id è€Œé PurchaseOrderId åƒæ•¸
            );
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCreateReceivingFromOrder), GetType(), 
                additionalData: $"è½‰é€²è²¨å–®å¤±æ•— - OrderId: {editModalComponent?.Entity?.Id}");
            await NotificationService.ShowErrorAsync($"è½‰é€²è²¨å–®æ™‚ç™¼ç”ŸéŒ¯èª¤: {ex.Message}");
        }
    }
    
    // ===== å…¬é–‹æ–¹æ³•ï¼ˆä¾›å¤–éƒ¨èª¿ç”¨ï¼‰ =====
    
    /// <summary>
    /// é–‹å•Ÿæ–°å¢æ¡è³¼å–® Modal ä¸¦é å¡«ä¾›æ‡‰å•†å’Œå•†å“è³‡è¨Š
    /// æ¡ç”¨èˆ‡ã€Œè½‰å–®ã€ç›¸åŒçš„è¨­è¨ˆæ¨¡å¼ï¼šåœ¨ LoadPurchaseOrderData ä¸­å°±è¨­å®šå¥½è³‡æ–™
    /// </summary>
    public async Task ShowAddModalWithPrefilledData(int supplierId, int productId, decimal? suggestedUnitPrice = null)
    {
        try
        {
            // é‡ç½®ç‚ºæ–°å¢æ¨¡å¼
            PurchaseOrderId = null;
            
            // è¨­å®šé å¡«è³‡è¨Šï¼ˆLoadPurchaseOrderData æœƒè®€å–é€™äº›å€¼ï¼‰
            prefilledSupplierId = supplierId;
            prefilledProductId = productId;
            prefilledUnitPrice = suggestedUnitPrice;
            
            // é–‹å•Ÿ Modalï¼ˆæœƒè‡ªå‹•è§¸ç™¼ LoadPurchaseOrderDataï¼Œä¸¦åœ¨å…¶ä¸­è¨­å®šä¾›æ‡‰å•†ï¼‰
            if (IsVisibleChanged.HasDelegate)
            {
                await IsVisibleChanged.InvokeAsync(true);
            }
            
            // ç­‰å¾… Modal å®Œå…¨æ¸²æŸ“ï¼ˆä¾›æ‡‰å•†å’Œæ˜ç´°å·²åœ¨ LoadPurchaseOrderData ä¸­è¨­å®šï¼‰
            await Task.Delay(100);
            
            // æª¢æŸ¥çµæœ
            if (editModalComponent?.Entity != null && purchaseOrderDetails.Any())
            {
                var product = purchaseOrderDetails.First().Product;
            }
            
            // æ¸…é™¤é å¡«è³‡è¨Šï¼ˆé¿å…å½±éŸ¿ä¸‹æ¬¡é–‹å•Ÿï¼‰
            prefilledSupplierId = null;
            prefilledProductId = null;
            prefilledUnitPrice = null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledData), GetType(),
                additionalData: $"é–‹å•Ÿé å¡«æ¡è³¼å–®Modalå¤±æ•— - SupplierId: {supplierId}, ProductId: {productId}");
            await NotificationService.ShowErrorAsync("é–‹å•Ÿæ¡è³¼å–®æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
}
