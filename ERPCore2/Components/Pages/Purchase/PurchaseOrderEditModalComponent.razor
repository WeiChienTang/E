@* 可重用的採購單編輯組件 - 可在任何頁面中嵌入 *@
@inject IPurchaseOrderService PurchaseOrderService
@inject ISupplierService SupplierService
@inject ICompanyService CompanyService
@inject IProductService ProductService
@inject INotificationService NotificationService
@inject IReportPrintConfigurationService ReportPrintConfigurationService
@inject ISystemParameterService SystemParameterService
@inject NavigationManager NavigationManager
@inject ActionButtonHelper ActionButtonHelper
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ERPCore2.Data.Context.AppDbContext DbContext

<GenericEditModalComponent TEntity="PurchaseOrder" 
                          TService="IPurchaseOrderService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          Id="@PurchaseOrderId"
                          Service="@PurchaseOrderService"
                          EntityName="採購單"
                          EntityNamePlural="採購單"
                          ModalTitle="@(PurchaseOrderId.HasValue ? "編輯採購單" : "新增採購單")"
                          Size="GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@autoCompleteConfig?.Prefillers"
                          AutoCompleteCollections="@autoCompleteConfig?.Collections"
                          AutoCompleteDisplayProperties="@autoCompleteConfig?.DisplayProperties"
                          AutoCompleteValueProperties="@autoCompleteConfig?.ValueProperties"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadPurchaseOrderData"
                          AdditionalDataLoader="@LoadAdditionalDataAsync"
                          SaveHandler="@SavePurchaseOrderWrapper"
                          SaveSuccessMessage="@(PurchaseOrderId.HasValue ? "採購單更新成功" : "採購單新增成功")"
                          SaveFailureMessage="採購單儲存失敗"
                          RequiredPermission="PurchaseOrder.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          CustomValidator="@ValidatePurchaseOrderDetailsAsync"
                          CustomModules="@GetCustomModules()"
                          ShowPrintButton = "true"
                          OnPrint="@HandlePrint"
                          ShowApprovalSection="@ShouldShowApprovalSection()"
                          ApprovalPermission="PurchaseOrder.Approve"
                          OnApprove="@HandlePurchaseOrderApprove"
                          OnRejectWithReason="@HandlePurchaseOrderRejectWithReason"
                          FormHeaderContent="@WarningMessage"
                          CustomActionButtons="@CustomActionButtons">
</GenericEditModalComponent>

@* 廠商編輯 Modal *@
@if (supplierModalManager != null)
{
    <SupplierEditModalComponent @ref="supplierEditModal"
                               IsVisible="@supplierModalManager.IsModalVisible"
                               IsVisibleChanged="@supplierModalManager.HandleModalVisibilityChangedAsync"
                               SupplierId="@supplierModalManager.SelectedEntityId"
                               PrefilledValues="@supplierModalManager.PrefilledValues"
                               OnSupplierSaved="@OnSupplierSavedWrapper"
                               OnCancel="@supplierModalManager.HandleModalCancelAsync" />
}

@* 進貨單編輯 Modal *@
<PurchaseReceivingEditModalComponent @ref="purchaseReceivingEditModal"
                                     IsVisible="@showPurchaseReceivingModal"
                                     IsVisibleChanged="@((bool visible) => showPurchaseReceivingModal = visible)"
                                     PurchaseReceivingId="@selectedPurchaseReceivingId"
                                     OnPurchaseReceivingSaved="@HandlePurchaseReceivingSaved"
                                     OnCancel="@(() => showPurchaseReceivingModal = false)" />

@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? PurchaseOrderId { get; set; }
    [Parameter] public EventCallback<PurchaseOrder> OnPurchaseOrderSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // AutoComplete 配置
    private AutoCompleteConfig? autoCompleteConfig;
    
    // 原始資料集合（用於 AutoComplete）
    private List<Supplier> availableSuppliers = new();
    private List<Company> availableCompanies = new();
    private List<Product> availableProducts = new();
    private List<Product> filteredProductsBySupplier = new(); // 根據廠商過濾的商品
    
    // 採購訂單明細
    private List<PurchaseOrderDetail> purchaseOrderDetails = new();
    private PurchaseOrderTable<PurchaseOrder, PurchaseOrderDetail>? purchaseOrderDetailManager;
    
    // Modal 管理器
    private SupplierEditModalComponent? supplierEditModal;
    private RelatedEntityModalManager<Supplier> supplierModalManager = default!;
    private ModalManagerCollection modalManagers = default!;
    
    // ===== 相關單據 Modal =====
    private PurchaseReceivingEditModalComponent? purchaseReceivingEditModal;
    private bool showPurchaseReceivingModal = false;
    private int? selectedPurchaseReceivingId = null;
    
    // 下拉選單選項（向下相容）
    private List<Supplier> suppliers = new();
    private List<Company> companies = new();
    private List<SelectOption> supplierOptions = new();
    private List<SelectOption> companyOptions = new();
    private List<SelectOption> statusOptions = new();
    
    // 系統參數 - 稅率快取（避免重複查詢資料庫）
    private decimal currentTaxRate = 5.0m; // 預設 5%，實際值會在初始化時從資料庫載入
    
    // ===== 審核開關狀態 =====
    private bool isApprovalEnabled = true; // 是否啟用審核功能（從系統參數載入）
    
    // ===== 鎖定狀態 =====
    private bool hasUndeletableDetails = false; // 是否有不可刪除的明細（已有進貨記錄）

    // ===== 建構函數 =====
    public PurchaseOrderEditModalComponent()
    {
        // 移除原有的建構函數初始化
        // 現在使用 ModalManagerInitHelper 在 OnInitializedAsync 中統一初始化
    }

    // ===== 必要方法 =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 載入審核開關設定（優先執行,影響後續邏輯）
            isApprovalEnabled = await SystemParameterService.IsPurchaseOrderApprovalEnabledAsync();
            
            // 使用 ModalManagerInitHelper 初始化 Modal 管理器
            modalManagers = ModalManagerInitHelper.CreateBuilder<PurchaseOrder, IPurchaseOrderService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Supplier>(nameof(PurchaseOrder.SupplierId), "廠商")
                .Build();
            supplierModalManager = modalManagers.Get<Supplier>(nameof(PurchaseOrder.SupplierId));
            
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化採購單編輯組件時發生錯誤");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible)
        {
            // 打開時,如果是新增模式,重置鎖定狀態
            if (!PurchaseOrderId.HasValue)
            {
                hasUndeletableDetails = false;
            }
            
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
        }
    }

    private async Task HandleSaveSuccess()
    {
        try
        {
            if (OnPurchaseOrderSaved.HasDelegate && editModalComponent?.Entity != null)
            {
                await OnPurchaseOrderSaved.InvokeAsync(editModalComponent.Entity);
            }

            await CloseModal();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSaveSuccess), GetType(), 
                additionalData: "採購單編輯Modal儲存成功處理失敗");
        }
    }

    private async Task HandleCancel()
    {
        try
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }
            // 不要直接調用 CloseModal，讓 GenericEditModalComponent 處理
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCancel), GetType(), 
                additionalData: "採購單編輯Modal取消處理失敗");
        }
    }

    private async Task HandlePrint()
    {
        try
        {
            // 使用通用 Helper 進行完整驗證（實體、ID、核准狀態）
            // 根據系統參數決定是否需要審核才能列印
            var (isValid, errorMessage) = ReportPrintHelper.ValidateForPrint(
                entity: editModalComponent?.Entity,
                entityId: PurchaseOrderId,
                isApproved: editModalComponent?.Entity?.IsApproved ?? false,
                entityName: "採購單",
                requireApproval: isApprovalEnabled  // 使用系統參數而非固定值
            );
            
            if (!isValid)
            {
                await NotificationService.ShowWarningAsync(errorMessage);
                return;
            }
            
            // 直接執行列印，使用預設設定
            await HandleDirectPrint(null);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePrint), GetType(), 
                additionalData: $"採購單列印處理失敗 - ID: {PurchaseOrderId}");
            await NotificationService.ShowErrorAsync("列印處理時發生錯誤");
        }
    }

    /// <summary>
    /// 直接執行列印 - 可以使用指定的列印配置或預設配置
    /// </summary>
    private async Task HandleDirectPrint(ReportPrintConfiguration? printConfig)
    {
        try
        {
            if (!PurchaseOrderId.HasValue)
            {
                await NotificationService.ShowWarningAsync("無法列印：採購單ID不存在");
                return;
            }

            // 驗證列印配置
            var (isValid, errorMessage) = ReportPrintHelper.ValidateConfiguration(printConfig);
            if (!isValid)
            {
                await NotificationService.ShowWarningAsync($"列印配置無效：{errorMessage}");
                return;
            }

            // 使用通用 Helper 建立列印 URL（新版路由）
            var printUrl = ReportPrintHelper.BuildPrintUrl(
                baseUrl: NavigationManager.BaseUri,
                reportType: "purchase-report/order",
                documentId: PurchaseOrderId.Value,
                configuration: printConfig,
                autoprint: true
            );

            // 使用通用 Helper 執行列印（隱藏 iframe 方式）
            var success = await ReportPrintHelper.ExecutePrintWithHiddenIframeAsync(
                printUrl: printUrl,
                jsRuntime: JSRuntime,
                iframeId: "printFrame"
            );
            
            if (success)
            {
                var configName = ReportPrintHelper.GetDisplayName(printConfig);
                await NotificationService.ShowSuccessAsync($"已使用 {configName} 送出列印");
            }
            else
            {
                await NotificationService.ShowErrorAsync("列印執行失敗");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDirectPrint), GetType(), 
                additionalData: $"採購單直接列印失敗 - ID: {PurchaseOrderId}, Config: {printConfig?.ReportName}");
            await NotificationService.ShowErrorAsync("列印執行時發生錯誤");
        }
    }

    private async Task CloseModal()
    {
        try
        {
            if (IsVisibleChanged.HasDelegate)
            {
                await IsVisibleChanged.InvokeAsync(false);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(CloseModal), GetType(), 
                additionalData: "採購單編輯Modal關閉失敗");
        }
    }

    private async Task<PurchaseOrder?> LoadPurchaseOrderData()
    {
        try
        {
            if (!PurchaseOrderId.HasValue)
            {
                // 新增模式 - 使用統一的 EntityCodeGenerationHelper 產生採購單號（支援 Attribute 配置）
                var generatedCode = await EntityCodeGenerationHelper.GenerateForEntity<PurchaseOrder, IPurchaseOrderService>(
                    PurchaseOrderService,
                    DbContext
                );
                
                // 取得預設公司
                var primaryCompany = await CompanyService.GetPrimaryCompanyAsync();
                
                var newOrder = new PurchaseOrder
                {
                    OrderDate = DateTime.Today,
                    ExpectedDeliveryDate = DateTime.Today.AddDays(7),
                    Status = EntityStatus.Active,
                    TotalAmount = 0,
                    Code = generatedCode,
                    CompanyId = primaryCompany?.Id ?? 1 // 設定預設公司，如果沒有主要公司則為1
                };
                
                // 清空明細
                purchaseOrderDetails.Clear();
                
                //  新增模式時,重置鎖定狀態為 false
                hasUndeletableDetails = false;
                
                return newOrder;
            }

            // 編輯模式 - 載入採購單和明細
            var purchaseOrder = await PurchaseOrderService.GetByIdAsync(PurchaseOrderId.Value);
            
            if (purchaseOrder != null)
            {
                // 載入採購單明細
                await LoadPurchaseOrderDetails(PurchaseOrderId.Value);
                
                // 在實體載入後重新初始化表單欄位以反映正確的唯讀狀態
                await Task.Delay(10); // 短暫延遲確保實體已設定
                _ = Task.Run(async () =>
                {
                    await InvokeAsync(async () =>
                    {
                        await InitializeFormFieldsAsync();
                        StateHasChanged();
                    });
                });
                
                // 觸發重新渲染以更新 ProductManagerComponent
                StateHasChanged();
            }
            
            return purchaseOrder;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadPurchaseOrderData), GetType(), 
                additionalData: $"載入採購單資料失敗 - ID: {PurchaseOrderId}");
            await NotificationService.ShowErrorAsync($"載入採購單資料時發生錯誤：{ex.Message}");
            return null;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // 載入廠商選項
            suppliers = await SupplierService.GetAllAsync();
            availableSuppliers = suppliers; // 用於 AutoComplete
            supplierOptions = suppliers.Where(s => s.Status == EntityStatus.Active)
                .Select(s => new SelectOption
                {
                    Text = s.CompanyName,
                    Value = s.Id.ToString()
                }).ToList();

            // 載入公司選項
            companies = await CompanyService.GetAllAsync();
            availableCompanies = companies; // 用於 AutoComplete
            companyOptions = companies.Where(c => c.Status == EntityStatus.Active)
                .Select(c => new SelectOption
                {
                    Text = c.CompanyName,
                    Value = c.Id.ToString()
                }).ToList();

            // 載入商品資料
            availableProducts = await ProductService.GetAllAsync();
            
            //  一次性載入系統稅率（避免每次計算都查詢資料庫）
            currentTaxRate = await TaxCalculationHelper.LoadTaxRateAsync(SystemParameterService);
            
            // 使用 AutoCompleteConfigHelper 建立配置
            autoCompleteConfig = new AutoCompleteConfigBuilder<PurchaseOrder>()
                .AddField(nameof(PurchaseOrder.SupplierId), "CompanyName", availableSuppliers)
                .Build();

            // 初始化狀態選項
            statusOptions = new List<SelectOption>
            {
                new SelectOption { Text = "啟用", Value = "Active" },
                new SelectOption { Text = "停用", Value = "Inactive" }
            };
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadAdditionalDataAsync), GetType(), 
                additionalData: "採購單編輯Modal載入額外資料失敗");
            
            // 設定安全的預設值
            supplierOptions = new List<SelectOption>();
            companyOptions = new List<SelectOption>();
            statusOptions = new List<SelectOption>();
            availableProducts = new List<Product>();
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            // 使用 ApprovalConfigHelper 統一判斷是否鎖定欄位
            var shouldLock = ApprovalConfigHelper.ShouldLockFieldByApproval(
                isApprovalEnabled,
                editModalComponent?.Entity?.IsApproved ?? false,
                hasUndeletableDetails
            );
            
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(PurchaseOrder.Code),
                    Label = "採購單號",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入採購單號",
                    IsRequired = true,
                    MaxLength = 30,
                    HelpText = "採購單的唯一編號，新增時系統會自動產生，也可手動修改",
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(PurchaseOrder.SupplierId),
                    Label = "篩選廠商",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇廠商",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "輸入廠商名稱進行搜尋，或直接選擇",
                    ActionButtons = await GetSupplierActionButtonsAsync(),
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(PurchaseOrder.CompanyId),
                    Label = "採購公司",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請選擇採購公司",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "選擇進行此次採購的公司",
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(PurchaseOrder.OrderDate),
                    Label = "採購日",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "採購單建立日期",
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(PurchaseOrder.ExpectedDeliveryDate),
                    Label = "交貨日",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "預計廠商交貨的日期",
                    IsReadOnly = shouldLock
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseOrder.TotalAmount),
                    Label = "採購總金額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "採購單的總金額，根據明細自動計算",
                    IsReadOnly = true // 總金額欄位始終為唯讀
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseOrder.PurchaseTaxAmount),
                    Label = TaxCalculationHelper.GenerateTaxAmountLabel("採購稅額", currentTaxRate),
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = TaxCalculationHelper.GenerateTaxAmountHelpText("採購單", currentTaxRate),
                    IsReadOnly = true // 稅額欄位始終為唯讀
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseOrder.PurchaseTotalAmountIncludingTax),
                    Label = "含稅總金額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "採購單的含稅總金額，根據明細自動計算",
                    IsReadOnly = true // 含稅總金額欄位始終為唯讀
                },

                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseOrder.RejectReason),
                    Label = "駁回原因",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入駁回原因",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "其他需要記錄的駁回原因",
                    ContainerCssClass = "col-6",
                    IsReadOnly = true
                },

                FormFieldConfigurationHelper.CreateRemarksField<PurchaseOrder>(
                    containerCssClass: "col-6",
                    readOnly: shouldLock // 根據審核狀態和明細狀態決定是否鎖定
                ),
            };

            formSections = FormSectionHelper<PurchaseOrder>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    po => po.Code,
                    po => po.SupplierId,
                    po => po.CompanyId,
                    po => po.OrderDate,
                    po => po.ExpectedDeliveryDate)
                .AddToSection(FormSectionNames.AmountInfoAutoCalculated,
                    po => po.TotalAmount,
                    po => po.PurchaseTaxAmount,
                    po => po.PurchaseTotalAmountIncludingTax)
                .AddToSection(FormSectionNames.AdditionalInfo,
                    po => po.RejectReason,
                    po => po.Remarks)
                .Build();
        }
        catch (Exception ex)
        {
            _ = ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(InitializeFormFieldsAsync), GetType(), 
                additionalData: "採購單編輯Modal表單欄位初始化失敗");
            
            // 設定安全的預設值
            formFields = new List<FormFieldDefinition>();
            formSections = new Dictionary<string, string>();
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }
    
    // ===== AutoComplete 配置方法 =====
    
    /// <summary>
    /// 配置 Modal 管理器
    /// </summary>
    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(PurchaseOrder.SupplierId), supplierModalManager }
        };
    }
    
    /// <summary>
    /// 配置自訂模組
    /// </summary>
    private List<GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>.CustomModule> GetCustomModules()
    {
        // 確保只在需要時才返回模組，並且檢查所有必要的條件
        if (editModalComponent == null)
        {
            return new List<GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>.CustomModule>();
        }

        return new List<GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>.CustomModule>
        {
            new GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>.CustomModule
            {
                // Title = "採購明細",
                Order = 1,
                // CssClass = "mt-4",
                IsVisible = true,
                Content = CreateProductManagerContent()
            }
        };
    }

    /// <summary>
    /// 創建商品管理器內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateProductManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null)
            {
                // 檢查是否有可用的商品資料
                @if (availableProducts != null && availableProducts.Any())
                {
                    // 檢查是否已選擇廠商
                    @if (editModalComponent.Entity.SupplierId > 0)
                    {
                        <PurchaseOrderTable @ref="purchaseOrderDetailManager"
                                                   TMainEntity="PurchaseOrder" 
                                                   TDetailEntity="PurchaseOrderDetail"
                                                   Products="@availableProducts"
                                                   SelectedSupplierId="@editModalComponent.Entity.SupplierId"
                                                   MainEntity="@editModalComponent.Entity"
                                                   ExistingDetails="@purchaseOrderDetails"
                                                   OnDetailsChanged="@HandleDetailsChanged"
                                                   MainEntityIdPropertyName="PurchaseOrderId"
                                                   QuantityPropertyName="OrderQuantity"
                                                   ReceivedQuantityPropertyName="ReceivedQuantity"
                                                   UnitPricePropertyName="UnitPrice"
                                                   RemarksPropertyName="Remarks"
                                                   IsReceivingCompletedPropertyName="IsReceivingCompleted"
                                                   IsReadOnly="false"
                                                   IsApproved="@(editModalComponent.Entity.IsApproved)"
                                                   OnHasUndeletableDetailsChanged="@(async (hasUndeletable) => await HandleHasUndeletableDetailsChanged(hasUndeletable))"
                                                   OnOpenRelatedDocument="@(async (doc) => await HandleOpenRelatedDocument(doc))" />
                    }
                    else
                    {
                        <div class="alert alert-info text-center" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            請先選擇廠商後再進行採購明細管理
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-warning text-center" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        無可用的商品資料，請聯繫系統管理員
                    </div>
                }
            }
            else
            {
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">載入中...</span>
                    </div>
                </div>
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                載入明細管理器時發生錯誤，請重新整理頁面。
            </div>
        }
    };
    
    // ===== ActionButton 產生方法 =====
    
    /// <summary>
    /// 產生廠商操作按鈕 - 使用統一 Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetSupplierActionButtonsAsync()
    {
        // 使用 ApprovalConfigHelper 統一判斷是否鎖定
        var shouldLock = ApprovalConfigHelper.ShouldLockFieldByApproval(
            isApprovalEnabled,
            editModalComponent?.Entity?.IsApproved ?? false,
            hasUndeletableDetails
        );
        
        if (shouldLock)
        {
            return new List<FieldActionButton>();
        }
        
        var buttons = await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            supplierModalManager, 
            nameof(PurchaseOrder.SupplierId)
        );
        
        return buttons;
    }
    
    /// <summary>
    /// 更新欄位的唯讀狀態 - 根據是否有不可刪除的明細
    /// 使用 FormFieldLockHelper 統一處理欄位鎖定邏輯
    /// </summary>
    private async void UpdateFieldsReadOnlyState()
    {
        // 使用 FormFieldLockHelper 批次鎖定/解鎖欄位
        var fieldsToLock = new[]
        {
            nameof(PurchaseOrder.CompanyId),
            nameof(PurchaseOrder.Code),
            nameof(PurchaseOrder.OrderDate),
            nameof(PurchaseOrder.ExpectedDeliveryDate),
            nameof(PurchaseOrder.Remarks),
            nameof(PurchaseOrder.RejectReason)
        };
        
        // 鎖定或解鎖一般欄位（不需要 ActionButtons）
        FormFieldLockHelper.LockMultipleFieldsSimple(
            formFields, 
            fieldsToLock, 
            isLocked: hasUndeletableDetails
        );
        
        // 特殊處理廠商欄位（需要 ActionButtons）
        if (hasUndeletableDetails)
        {
            // 鎖定：移除 ActionButtons
            FormFieldLockHelper.LockField(
                formFields,
                nameof(PurchaseOrder.SupplierId),
                isLocked: true
            );
        }
        else
        {
            // 解鎖：恢復 ActionButtons
            FormFieldLockHelper.LockField(
                formFields,
                nameof(PurchaseOrder.SupplierId),
                isLocked: false,
                actionButtonsGetter: GetSupplierActionButtonsAsync
            );
        }
        
        // 重新初始化表單欄位以強制更新 UI
        await InvokeAsync(async () =>
        {
            await InitializeFormFieldsAsync();
            StateHasChanged();
        });
    }
    
    // ===== Modal 事件包裝器方法 =====
    
    /// <summary>
    /// 包裝廠商儲存事件
    /// </summary>
    private async Task OnSupplierSavedWrapper(Supplier savedSupplier)
    {
        await supplierModalManager.HandleEntitySavedAsync(savedSupplier, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// 處理欄位值變更事件 - 使用統一 Helper
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // 使用統一 Helper 處理廠商欄位變更
            if (fieldChange.PropertyName == nameof(PurchaseOrder.SupplierId))
            {
                // 檢查是否應該鎖定欄位（避免在鎖定狀態下重新加入 ActionButtons）
                var shouldLock = ApprovalConfigHelper.ShouldLockFieldByApproval(
                    isApprovalEnabled,
                    editModalComponent?.Entity?.IsApproved ?? false,
                    hasUndeletableDetails
                );
                
                // 只有在非鎖定狀態下才更新 ActionButtons
                if (!shouldLock)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        supplierModalManager, 
                        formFields, 
                        nameof(PurchaseOrder.SupplierId), 
                        fieldChange.Value
                    );
                }
                else
                {
                    // 如果是鎖定狀態，確保移除 ActionButtons
                    var supplierField = formFields.FirstOrDefault(f => f.PropertyName == nameof(PurchaseOrder.SupplierId));
                    if (supplierField != null)
                    {
                        supplierField.ActionButtons = new List<FieldActionButton>();
                    }
                }
                
                // 廠商變更時，觸發商品管理器重新渲染
                StateHasChanged();
            }
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("欄位變更處理時發生錯誤");
        }
    }

    // ===== 採購明細管理方法 =====
    
    /// <summary>
    /// 處理有不可刪除明細的狀態變更
    /// 當明細動態變化時（新增進貨、刪除進貨記錄等），這個方法會被調用
    /// </summary>
    private async Task HandleHasUndeletableDetailsChanged(bool hasUndeletable)
    {
        try
        {
            hasUndeletableDetails = hasUndeletable;
            
            // 更新欄位的唯讀狀態
            UpdateFieldsReadOnlyState();
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理明細鎖定狀態時發生錯誤：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 載入採購單明細
    /// </summary>
    private async Task LoadPurchaseOrderDetails(int purchaseOrderId)
    {
        try
        {
            // 從服務載入採購單明細
            purchaseOrderDetails = await PurchaseOrderService.GetOrderDetailsAsync(purchaseOrderId);
            
            // 確保不是 null
            if (purchaseOrderDetails == null)
            {
                purchaseOrderDetails = new List<PurchaseOrderDetail>();
            }
            
            //  載入明細後,檢查是否有不可刪除的明細(有進貨記錄)
            var hasReceiving = purchaseOrderDetails.Any(d => d.ReceivedQuantity > 0);
            await HandleHasUndeletableDetailsChanged(hasReceiving);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadPurchaseOrderDetails), GetType(), 
                additionalData: $"載入採購單明細失敗 - OrderId: {purchaseOrderId}");
            purchaseOrderDetails = new List<PurchaseOrderDetail>();
        }
    }

    /// <summary>
    /// 處理採購明細變更
    /// </summary>
    private async Task HandleDetailsChanged(List<PurchaseOrderDetail> details)
    {
        try
        {
            purchaseOrderDetails = details ?? new List<PurchaseOrderDetail>();            
            
            // 更新主檔的總金額、稅額、含稅總額
            if (editModalComponent?.Entity != null)
            {
                // 1. 計算總金額（未稅）
                editModalComponent.Entity.TotalAmount = purchaseOrderDetails.Sum(d => d.SubtotalAmount);
                
                // 2. 計算稅額（使用 TaxCalculationHelper 統一處理）
                editModalComponent.Entity.PurchaseTaxAmount = TaxCalculationHelper.CalculateTax(
                    editModalComponent.Entity.TotalAmount, 
                    currentTaxRate
                );            
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDetailsChanged), GetType(), 
                additionalData: "處理採購明細變更失敗");
        }
    }

    /// <summary>
    /// 驗證採購單明細 - 確保至少有一筆明細
    /// </summary>
    private async Task<bool> ValidatePurchaseOrderDetailsAsync(PurchaseOrder purchaseOrder)
    {
        try
        {
            // 如果明細管理組件存在，執行驗證
            if (purchaseOrderDetailManager != null)
            {
                @* return await purchaseOrderDetailManager.ValidateAsync(); *@
            }
            
            // 如果組件不存在，檢查是否有有效的明細（至少選擇了商品）
            var validDetails = purchaseOrderDetails.Where(d => d.ProductId > 0).ToList();
            
            if (!validDetails.Any())
            {
                await NotificationService.ShowErrorAsync("採購單必須至少包含一筆明細資料");
                return false;
            }
            
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"驗證明細時發生錯誤：{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// 包裝方法 - 提供給 GenericEditModalComponent 使用的儲存處理器
    /// </summary>
    private async Task<bool> SavePurchaseOrderWrapper(PurchaseOrder purchaseOrder)
    {
        // 先執行自訂驗證
        if (!await ValidatePurchaseOrderDetailsAsync(purchaseOrder))
        {
            return false;
        }
        
        return await SavePurchaseOrderWithDetails(purchaseOrder, isPreApprovalSave: false);
    }

    /// <summary>
    /// 自訂儲存邏輯 - 同時儲存主檔和明細
    /// 特殊處理：審核通過後仍允許儲存，用於更新明細的「完成進貨」等執行狀態
    /// </summary>
    private async Task<bool> SavePurchaseOrderWithDetails(PurchaseOrder purchaseOrder, bool isPreApprovalSave = false)
    {
        try
        {
            if (purchaseOrder == null)
            {
                await NotificationService.ShowErrorAsync("沒有要儲存的採購單資料");
                return false;
            }

            //  修改：審核通過後仍允許儲存（用於更新「完成進貨」等執行狀態）
            // 不使用 ApprovalConfigHelper.CanSaveWhenApproved 的限制
            // 因為明細中的「完成進貨」欄位需要在審核後仍可修改
            
            // 更新總金額和稅額（使用 TaxCalculationHelper 統一處理）
            purchaseOrder.TotalAmount = purchaseOrderDetails.Sum(d => d.SubtotalAmount);
            purchaseOrder.PurchaseTaxAmount = TaxCalculationHelper.CalculateTax(
                purchaseOrder.TotalAmount, 
                currentTaxRate
            );

            // 儲存主檔
            ServiceResult<PurchaseOrder> result;
            if (PurchaseOrderId.HasValue)
            {
                result = await PurchaseOrderService.UpdateAsync(purchaseOrder);
            }
            else
            {
                result = await PurchaseOrderService.CreateAsync(purchaseOrder);
            }

            if (!result.IsSuccess || result.Data == null)
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "儲存採購單失敗");
                return false;
            }

            // 儲存明細
            await SavePurchaseOrderDetails(result.Data.Id);

            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SavePurchaseOrderWithDetails), GetType(), 
                additionalData: "儲存採購單和明細失敗");
            await NotificationService.ShowErrorAsync($"儲存時發生錯誤：{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// 儲存採購單明細
    /// </summary>
    private async Task SavePurchaseOrderDetails(int purchaseOrderId)
    {
        try
        {
            // 設定主檔ID
            foreach (var detail in purchaseOrderDetails)
            {
                detail.PurchaseOrderId = purchaseOrderId;
                if (detail.Id == 0)
                {
                    detail.Status = EntityStatus.Active;
                    detail.CreatedAt = DateTime.Now;
                }
                else
                {
                    detail.UpdatedAt = DateTime.Now;
                }
            }

            // 先獲取現有的明細
            var existingDetails = await PurchaseOrderService.GetOrderDetailsAsync(purchaseOrderId);
            
            // 處理新增和更新的明細
            foreach (var detail in purchaseOrderDetails.Where(d => d.ProductId > 0))
            {
                if (detail.Id == 0)
                {
                    // 新增明細
                    await PurchaseOrderService.AddOrderDetailAsync(detail);
                }
                else
                {
                    // 更新明細
                    await PurchaseOrderService.UpdateOrderDetailAsync(detail);
                }
            }

            // 處理刪除的明細（現有的但不在當前列表中的）
            var currentDetailIds = purchaseOrderDetails.Where(d => d.Id > 0).Select(d => d.Id).ToList();
            var detailsToDelete = existingDetails.Where(e => !currentDetailIds.Contains(e.Id)).ToList();
            
            foreach (var detailToDelete in detailsToDelete)
            {
                await PurchaseOrderService.DeleteOrderDetailAsync(detailToDelete.Id);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SavePurchaseOrderDetails), GetType(), 
                additionalData: $"儲存採購單明細失敗 - OrderId: {purchaseOrderId}");
            throw; // 重新拋出例外，讓上層處理
        }
    }
    
    // ===== 審核相關方法 =====
    
    /// <summary>
    /// 判斷是否應該顯示審核區域
    /// </summary>
    private bool ShouldShowApprovalSection()
    {
        // 新邏輯：只有在啟用審核 + 編輯現有單據時才顯示
        return isApprovalEnabled && 
               PurchaseOrderId.HasValue && 
               PurchaseOrderId.Value > 0;
    }
    
    /// <summary>
    /// 處理採購單審核通過
    /// </summary>
    private async Task<bool> HandlePurchaseOrderApprove()
    {
        try
        {
            if (!PurchaseOrderId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法審核：採購單ID不存在");
                return false;
            }
            
            // 確認對話框
            var confirmed = await NotificationService.ShowConfirmAsync(
                "確定要審核通過此採購單嗎？系統將先儲存當前資料，然後進行審核。審核通過後將無法再修改。", 
                "審核確認");
            
            if (!confirmed)
                return false;
            
            // **方案一實施：審核前先自動儲存**
            if (editModalComponent?.Entity != null)
            {
                // 暫時允許儲存（即使已核准狀態也要能儲存，因為可能有未儲存的變更）
                var saveResult = await SavePurchaseOrderWithDetails(editModalComponent.Entity, isPreApprovalSave: true);
                if (!saveResult)
                {
                    await NotificationService.ShowErrorAsync("儲存失敗，無法進行審核");
                    return false;
                }                
            }
            
            // 呼叫服務進行審核
            var currentUserId = await GetCurrentUserIdAsync();
            if (!currentUserId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法取得當前使用者資訊");
                return false;
            }
            
            var result = await PurchaseOrderService.ApproveOrderAsync(PurchaseOrderId.Value, currentUserId.Value);
            
            if (result.IsSuccess)
            {
                return true;
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "審核通過失敗");
                return false;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePurchaseOrderApprove), GetType(), 
                additionalData: $"採購單審核通過失敗 - OrderId: {PurchaseOrderId}");
            await NotificationService.ShowErrorAsync($"審核通過時發生錯誤：{ex.Message}");
            return false;
        }
    }
    
    /// <summary>
    /// 處理採購單審核駁回（帶駁回原因）
    /// </summary>
    private async Task<bool> HandlePurchaseOrderRejectWithReason(string rejectReason)
    {
        try
        {
            if (!PurchaseOrderId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法審核：採購單ID不存在");
                return false;
            }
            
            // 駁回原因已從 Modal 中獲得，不需要再次確認
            
            // 取得當前使用者ID
            var currentUserId = await GetCurrentUserIdAsync();
            if (!currentUserId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法取得當前使用者資訊");
                return false;
            }
            
            // 呼叫服務進行駁回
            var result = await PurchaseOrderService.RejectOrderAsync(PurchaseOrderId.Value, currentUserId.Value, rejectReason);
            
            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync("採購單已駁回");
                // 重新載入資料以更新界面
                if (editModalComponent != null)
                {
                    await editModalComponent.RefreshEntityAsync();
                }
                return true;
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "駁回失敗");
                return false;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePurchaseOrderRejectWithReason), GetType(), 
                additionalData: $"採購單審核駁回失敗 - OrderId: {PurchaseOrderId}");
            await NotificationService.ShowErrorAsync($"審核駁回時發生錯誤：{ex.Message}");
            return false;
        }
    }
    
    /// <summary>
    /// 處理採購單審核駁回（舊版本，保留向下相容）
    /// </summary>
    private async Task<bool> HandlePurchaseOrderReject()
    {
        try
        {
            if (!PurchaseOrderId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法審核：採購單ID不存在");
                return false;
            }
            
            // 使用 JavaScript prompt 來取得駁回原因
            var rejectReason = await JSRuntime.InvokeAsync<string>("prompt", "請輸入駁回原因：", "");
            
            if (string.IsNullOrWhiteSpace(rejectReason))
            {
                await NotificationService.ShowWarningAsync("駁回原因不能為空");
                return false;
            }
            
            // 確認對話框
            var confirmed = await NotificationService.ShowConfirmAsync(
                $"確定要駁回此採購單嗎？\n駁回原因：{rejectReason}\n\n駁回後採購單將退回修改。", 
                "審核確認");
            
            if (!confirmed)
                return false;
            
            // 取得當前使用者ID
            var currentUserId = await GetCurrentUserIdAsync();
            if (!currentUserId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法取得當前使用者資訊");
                return false;
            }
            
            // 呼叫服務進行駁回
            var result = await PurchaseOrderService.RejectOrderAsync(PurchaseOrderId.Value, currentUserId.Value, rejectReason);
            
            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync("採購單已駁回");
                // 重新載入資料以更新界面
                if (editModalComponent != null)
                {
                    await editModalComponent.RefreshEntityAsync();
                }
                return true;
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "駁回失敗");
                return false;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePurchaseOrderReject), GetType(), 
                additionalData: $"採購單審核駁回失敗 - OrderId: {PurchaseOrderId}");
            await NotificationService.ShowErrorAsync($"審核駁回時發生錯誤：{ex.Message}");
            return false;
        }
    }
    
    /// <summary>
    /// 取得警告訊息（顯示在表單欄位上方）- 作為屬性以確保正確的渲染時機
    /// 當採購單已審核通過或明細有進貨記錄時，顯示鎖定警告訊息
    /// </summary>
    private RenderFragment? WarningMessage => __builder =>
    {
        @* 審核通過的訊息 *@
        <GenericLockedFieldMessage IsVisible="@(isApprovalEnabled && editModalComponent?.Entity?.IsApproved == true)"
                                  Message="採購單已審核通過，主檔欄位已鎖定。您仍可修改明細的「完成進貨」狀態並儲存。" />
    };
    
    /// <summary>
    /// 取得自訂操作按鈕（顯示在 Modal 頂部左側）- 作為屬性以確保正確的渲染時機
    /// </summary>
    private RenderFragment? CustomActionButtons
    {
        get
        {
            // 修改邏輯：轉進貨按鈕永遠顯示（只要採購單已儲存）
            // 審核控制改為在載入明細時進行過濾
            bool shouldShowButton = false;
            
            try
            {
                if (editModalComponent?.Entity != null && 
                    PurchaseOrderId.HasValue && 
                    PurchaseOrderId.Value > 0)
                {
                    shouldShowButton = true;
                }
            }
            catch
            {
                shouldShowButton = false;
            }
            
            return __builder =>
            {
                @* 轉進貨單按鈕 - 採購單已儲存即可顯示 *@
                @if (shouldShowButton)
                {
                    <GenericButtonComponent Text="轉進貨" 
                                          Variant="ButtonVariant.Success" 
                                          OnClick="HandleCreateReceivingFromOrder" />
                }
            };
        }
    }
    
    /// <summary>
    /// 取得當前使用者ID
    /// </summary>
    private async Task<int?> GetCurrentUserIdAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (!user.Identity?.IsAuthenticated ?? true)
                return null;

            // 從Claims中取得使用者ID (通常存在NameIdentifier中)
            var employeeIdClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (int.TryParse(employeeIdClaim, out int employeeId))
                return employeeId;

            return null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetCurrentUserIdAsync), GetType(), 
                additionalData: "取得當前使用者ID失敗");
            return null;
        }
    }
    
    // ===== 相關單據開啟處理方法 =====
    
    /// <summary>
    /// 處理開啟相關單據的事件
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            switch (args.type)
            {
                case RelatedDocumentType.ReceivingDocument:
                    // 開啟進貨單 Modal
                    selectedPurchaseReceivingId = args.id;
                    showPurchaseReceivingModal = true;
                    StateHasChanged();
                    break;
                    
                default:
                    await NotificationService.ShowWarningAsync($"不支援的單據類型：{args.type}");
                    break;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleOpenRelatedDocument), GetType(), 
                additionalData: $"開啟相關單據失敗 - Type: {args.type}, Id: {args.id}");
            await NotificationService.ShowErrorAsync("開啟單據時發生錯誤");
        }
    }
    
    /// <summary>
    /// 處理進貨單儲存後的事件
    /// 使用 ChildDocumentRefreshHelper 統一處理刷新邏輯
    /// </summary>
    private async Task HandlePurchaseReceivingSaved(PurchaseReceiving savedReceiving)
    {
        try
        {
            await ChildDocumentRefreshHelper.HandleChildDocumentSavedAsync(
                closeModal: () =>
                {
                    showPurchaseReceivingModal = false;
                    selectedPurchaseReceivingId = null;
                },
                reloadDetails: async () =>
                {
                    if (PurchaseOrderId.HasValue)
                    {
                        await LoadPurchaseOrderDetails(PurchaseOrderId.Value);
                    }
                },
                detailManager: purchaseOrderDetailManager,
                notificationMessage: null, // 稍後手動顯示通知
                stateHasChanged: StateHasChanged,
                invokeAsync: InvokeAsync,
                additionalActions: () =>
                {
                    // 關鍵修復：呼叫 Table 組件的公開刷新方法
                    // 因為父 Modal 沒有關閉，Table 組件不會自動重新載入
                    // 需要主動呼叫刷新方法來更新 UI 顯示
                    @* if (purchaseOrderDetailManager != null)
                    {
                        await purchaseOrderDetailManager.RefreshDetailsAsync();
                    } *@
                    return Task.CompletedTask;
                }
            );
            
            // 顯示成功訊息
            await NotificationService.ShowSuccessAsync($"進貨單 {savedReceiving.Code} 已更新，採購明細已刷新");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePurchaseReceivingSaved), GetType(), 
                additionalData: $"處理進貨單儲存事件失敗 - ReceivingId: {savedReceiving?.Id}");
        }
    }
    
    /// <summary>
    /// 從採購單轉進貨單
    /// </summary>
    private async Task HandleCreateReceivingFromOrder()
    {
        try
        {
            if (!PurchaseOrderId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("無法轉進貨單：採購單資料不存在");
                return;
            }
            
            // 移除審核檢查：改為在載入明細時根據審核開關過濾
            // 如果啟用審核，只會載入已審核的採購單明細
            // 如果未啟用審核，載入所有採購單明細
            
            // 檢查是否有廠商資料
            if (editModalComponent.Entity.SupplierId <= 0)
            {
                await NotificationService.ShowWarningAsync("採購單缺少廠商資訊，無法轉進貨單");
                return;
            }

            // 檢查是否還有未完成的明細（還需要入庫的商品）
            if (!purchaseOrderDetails.Any())
            {
                await NotificationService.ShowWarningAsync("採購單沒有明細資料，無法轉進貨單");
                return;
            }
            
            // 檢查是否所有明細都已完成進貨
            var hasIncompleteDetails = purchaseOrderDetails.Any(detail => 
                detail.ReceivedQuantity < detail.OrderQuantity
            );
            
            if (!hasIncompleteDetails)
            {
                await NotificationService.ShowWarningAsync("採購單所有明細皆已完成進貨，無需再轉進貨單");
                return;
            }
            
            // 使用公開方法開啟進貨單 Modal（新增模式，但預填廠商和採購單資訊）
            if (purchaseReceivingEditModal != null)
            {
                await purchaseReceivingEditModal.ShowAddModalWithPrefilledOrder(
                    editModalComponent.Entity.SupplierId,
                    PurchaseOrderId.Value
                );
            }
            else
            {
                await NotificationService.ShowWarningAsync("進貨單組件未初始化，請重新整理頁面");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCreateReceivingFromOrder), GetType(), 
                additionalData: $"轉進貨單失敗 - OrderId: {PurchaseOrderId}");
            await NotificationService.ShowErrorAsync("轉進貨單時發生錯誤");
        }
    }
}
