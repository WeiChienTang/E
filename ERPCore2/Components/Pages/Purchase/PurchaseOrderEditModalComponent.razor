@* 可重用的採購單編輯組件 - 可在任何頁面中嵌入 *@
@inject IPurchaseOrderService PurchaseOrderService
@inject ISupplierService SupplierService
@inject ICompanyService CompanyService
@inject IProductService ProductService
@inject INotificationService NotificationService
@inject IReportPrintConfigurationService ReportPrintConfigurationService
@inject NavigationManager NavigationManager
@inject ActionButtonHelper ActionButtonHelper
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider

<GenericEditModalComponent TEntity="PurchaseOrder" 
                          TService="IPurchaseOrderService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          Id="@PurchaseOrderId"
                          Service="@PurchaseOrderService"
                          EntityName="採購單"
                          EntityNamePlural="採購單"
                          ModalTitle="@(PurchaseOrderId.HasValue ? "編輯採購單" : "新增採購單")"
                          Size="GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@GetAutoCompletePrefillers()"
                          AutoCompleteCollections="@GetAutoCompleteCollections()"
                          AutoCompleteDisplayProperties="@GetAutoCompleteDisplayProperties()"
                          AutoCompleteValueProperties="@GetAutoCompleteValueProperties()"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadPurchaseOrderData"
                          AdditionalDataLoader="@LoadAdditionalDataAsync"
                          SaveHandler="@SavePurchaseOrderWrapper"
                          SaveSuccessMessage="@(PurchaseOrderId.HasValue ? "採購單更新成功" : "採購單新增成功")"
                          SaveFailureMessage="採購單儲存失敗"
                          RequiredPermission="PurchaseOrder.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          CustomModules="@GetCustomModules()"
                          ShowPrintButton = "false"
                          OnPrint="@HandlePrint"
                          ShowApprovalSection="@ShouldShowApprovalSection()"
                          ApprovalPermission="PurchaseOrder.Approve"
                          OnApprove="@HandlePurchaseOrderApprove"
                          OnReject="@HandlePurchaseOrderReject"
                          GetApprovalStatus="@GetPurchaseOrderApprovalStatus"
                          >

</GenericEditModalComponent>

@* 供應商編輯 Modal *@
<SupplierEditModalComponent @ref="supplierEditModal"
                           IsVisible="@supplierModalManager.IsModalVisible"
                           IsVisibleChanged="@supplierModalManager.HandleModalVisibilityChangedAsync"
                           SupplierId="@supplierModalManager.SelectedEntityId"
                           PrefilledValues="@supplierModalManager.PrefilledValues"
                           OnSupplierSaved="@OnSupplierSavedWrapper"
                           OnCancel="@supplierModalManager.HandleModalCancelAsync" />



@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? PurchaseOrderId { get; set; }
    [Parameter] public EventCallback<PurchaseOrder> OnPurchaseOrderSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // 原始資料集合（用於 AutoComplete）
    private List<Supplier> availableSuppliers = new();
    private List<Company> availableCompanies = new();
    private List<Product> availableProducts = new();
    private List<Product> filteredProductsBySupplier = new(); // 根據供應商過濾的商品
    
    // 採購訂單明細
    private List<PurchaseOrderDetail> purchaseOrderDetails = new();
    
    // Modal 管理器
    private SupplierEditModalComponent? supplierEditModal;
    private RelatedEntityModalManager<Supplier> supplierModalManager = default!;
    
    // 下拉選單選項（向下相容）
    private List<Supplier> suppliers = new();
    private List<Company> companies = new();
    private List<SelectOption> supplierOptions = new();
    private List<SelectOption> companyOptions = new();
    private List<SelectOption> statusOptions = new();

    // ===== 必要方法 =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 初始化 Modal 管理器
            InitializeSupplierModalManager();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化採購單編輯組件時發生錯誤");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible)
        {
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
        }
    }

    private async Task HandleSaveSuccess()
    {
        try
        {
            Console.WriteLine($"[PurchaseOrderEditModalComponent] HandleSaveSuccess 被調用");
            if (OnPurchaseOrderSaved.HasDelegate && editModalComponent?.Entity != null)
            {
                Console.WriteLine($"[PurchaseOrderEditModalComponent] 準備調用 OnPurchaseOrderSaved 事件");
                await OnPurchaseOrderSaved.InvokeAsync(editModalComponent.Entity);
                Console.WriteLine($"[PurchaseOrderEditModalComponent] OnPurchaseOrderSaved 事件調用完成");
            }
            else
            {
                Console.WriteLine($"[PurchaseOrderEditModalComponent] OnPurchaseOrderSaved 事件沒有委派或實體為空");
            }
            await CloseModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[PurchaseOrderEditModalComponent] HandleSaveSuccess 發生錯誤: {ex.Message}");
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSaveSuccess), GetType(), 
                additionalData: "採購單編輯Modal儲存成功處理失敗");
        }
    }

    private async Task HandleCancel()
    {
        try
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }
            // 不要直接調用 CloseModal，讓 GenericEditModalComponent 處理
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCancel), GetType(), 
                additionalData: "採購單編輯Modal取消處理失敗");
        }
    }

    private async Task HandlePrint()
    {
        try
        {
            if (editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("請先儲存採購單資料後再進行列印");
                return;
            }
            
            if (!PurchaseOrderId.HasValue || PurchaseOrderId <= 0)
            {
                await NotificationService.ShowWarningAsync("請先儲存採購單後再進行列印");
                return;
            }
            
            // 檢查採購單是否已核准
            if (!editModalComponent.Entity.IsApproved)
            {
                await NotificationService.ShowWarningAsync("請先核准採購單後再進行列印");
                return;
            }
            
            // 直接執行列印，使用預設設定
            await HandleDirectPrint(null);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePrint), GetType(), 
                additionalData: $"採購單列印處理失敗 - ID: {PurchaseOrderId}");
            await NotificationService.ShowErrorAsync("列印處理時發生錯誤");
        }
    }

    /// <summary>
    /// 直接執行列印 - 可以使用指定的列印配置或預設配置
    /// </summary>
    private async Task HandleDirectPrint(ReportPrintConfiguration? printConfig)
    {
        try
        {
            if (!PurchaseOrderId.HasValue)
            {
                await NotificationService.ShowWarningAsync("無法列印：採購單ID不存在");
                return;
            }

            // 驗證列印配置
            var (isValid, errorMessage) = ReportPrintHelper.ValidateConfiguration(printConfig);
            if (!isValid)
            {
                await NotificationService.ShowWarningAsync($"列印配置無效：{errorMessage}");
                return;
            }

            // 建立列印 URL
            var printUrl = ReportPrintHelper.BuildReportUrl(
                NavigationManager.BaseUri.TrimEnd('/'), 
                PurchaseOrderId.Value, 
                printConfig, 
                "html");
            printUrl += "/print";

            // 執行列印
            var printSuccess = await ReportPrintHelper.ExecutePrintAsync(printUrl, JSRuntime);
            
            if (printSuccess)
            {
                var configName = ReportPrintHelper.GetDisplayName(printConfig);
                await NotificationService.ShowSuccessAsync($"已使用 {configName} 送出列印");
            }
            else
            {
                await NotificationService.ShowWarningAsync("列印執行可能失敗，請檢查印表機設定");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDirectPrint), GetType(), 
                additionalData: $"採購單直接列印失敗 - ID: {PurchaseOrderId}, Config: {printConfig?.ReportName}");
            await NotificationService.ShowErrorAsync("列印執行時發生錯誤");
        }
    }

    private async Task CloseModal()
    {
        try
        {
            if (IsVisibleChanged.HasDelegate)
            {
                await IsVisibleChanged.InvokeAsync(false);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(CloseModal), GetType(), 
                additionalData: "採購單編輯Modal關閉失敗");
        }
    }

    private async Task<PurchaseOrder?> LoadPurchaseOrderData()
    {
        try
        {
            if (!PurchaseOrderId.HasValue)
            {
                // 新增模式 - 自動產生採購單號並設定預設公司
                var generatedCode = await GeneratePurchaseOrderNumberAsync();
                
                // 取得預設公司
                var primaryCompany = await CompanyService.GetPrimaryCompanyAsync();
                
                var newOrder = new PurchaseOrder
                {
                    OrderDate = DateTime.Today,
                    ExpectedDeliveryDate = DateTime.Today.AddDays(7),
                    Status = EntityStatus.Active,
                    TotalAmount = 0,
                    PurchaseOrderNumber = generatedCode,
                    CompanyId = primaryCompany?.Id ?? 1 // 設定預設公司，如果沒有主要公司則為1
                };
                
                // 清空明細
                purchaseOrderDetails.Clear();
                
                return newOrder;
            }

            // 編輯模式 - 載入採購單和明細
            var purchaseOrder = await PurchaseOrderService.GetByIdAsync(PurchaseOrderId.Value);
            
            if (purchaseOrder != null)
            {
                // 載入採購單明細
                await LoadPurchaseOrderDetails(PurchaseOrderId.Value);
                
                // 在實體載入後重新初始化表單欄位以反映正確的唯讀狀態
                await Task.Delay(10); // 短暫延遲確保實體已設定
                _ = Task.Run(async () =>
                {
                    await InvokeAsync(async () =>
                    {
                        await InitializeFormFieldsAsync();
                        StateHasChanged();
                    });
                });
                
                // 觸發重新渲染以更新 ProductManagerComponent
                StateHasChanged();
            }
            
            return purchaseOrder;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadPurchaseOrderData), GetType(), 
                additionalData: $"載入採購單資料失敗 - ID: {PurchaseOrderId}");
            await NotificationService.ShowErrorAsync($"載入採購單資料時發生錯誤：{ex.Message}");
            return null;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // 載入供應商選項
            suppliers = await SupplierService.GetAllAsync();
            availableSuppliers = suppliers; // 用於 AutoComplete
            supplierOptions = suppliers.Where(s => s.Status == EntityStatus.Active)
                .Select(s => new SelectOption
                {
                    Text = s.CompanyName,
                    Value = s.Id.ToString()
                }).ToList();

            // 載入公司選項
            companies = await CompanyService.GetAllAsync();
            availableCompanies = companies; // 用於 AutoComplete
            companyOptions = companies.Where(c => c.Status == EntityStatus.Active)
                .Select(c => new SelectOption
                {
                    Text = c.CompanyName,
                    Value = c.Id.ToString()
                }).ToList();

            // 載入商品資料
            availableProducts = await ProductService.GetAllAsync();

            // 初始化狀態選項
            statusOptions = new List<SelectOption>
            {
                new SelectOption { Text = "啟用", Value = "Active" },
                new SelectOption { Text = "停用", Value = "Inactive" }
            };
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadAdditionalDataAsync), GetType(), 
                additionalData: "採購單編輯Modal載入額外資料失敗");
            
            // 設定安全的預設值
            supplierOptions = new List<SelectOption>();
            companyOptions = new List<SelectOption>();
            statusOptions = new List<SelectOption>();
            availableProducts = new List<Product>();
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            // 檢查採購單是否已核准，如果已核准則設為唯讀
            bool isApproved = editModalComponent?.Entity?.IsApproved ?? false;
            
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(PurchaseOrder.PurchaseOrderNumber),
                    Label = "採購單號",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入採購單號",
                    IsRequired = true,
                    MaxLength = 30,
                    HelpText = "採購單的唯一編號，新增時系統會自動產生，也可手動修改",
                    IsReadOnly = isApproved
                },
                new()
                {
                    PropertyName = nameof(PurchaseOrder.CompanyId),
                    Label = "採購公司",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請選擇採購公司",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "選擇進行此次採購的公司",
                    IsReadOnly = isApproved
                },
                new()
                {
                    PropertyName = nameof(PurchaseOrder.SupplierId),
                    Label = "供應商",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇供應商",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "輸入供應商名稱進行搜尋，或直接選擇",
                    ActionButtons = await GetSupplierActionButtonsAsync(),
                    IsReadOnly = isApproved
                },
                new()
                {
                    PropertyName = nameof(PurchaseOrder.OrderDate),
                    Label = "採購日期",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "採購單建立日期",
                    IsReadOnly = isApproved
                },
                new()
                {
                    PropertyName = nameof(PurchaseOrder.ExpectedDeliveryDate),
                    Label = "預定交貨日期",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "預計供應商交貨的日期",
                    IsReadOnly = isApproved
                },

                new()
                {
                    PropertyName = nameof(PurchaseOrder.Remarks),
                    Label = "備註",
                    FieldType = FormFieldType.TextArea,
                    Placeholder = "請輸入備註",
                    IsRequired = false,
                    MaxLength = 500,
                    Rows = 2,
                    HelpText = "採購單的額外說明或注意事項",
                    ContainerCssClass = "col-12",
                    IsReadOnly = isApproved
                }
            };

            formSections = new Dictionary<string, string>
            {
                { nameof(PurchaseOrder.PurchaseOrderNumber), "基本資訊" },
                { nameof(PurchaseOrder.CompanyId), "基本資訊" },
                { nameof(PurchaseOrder.SupplierId), "基本資訊" },
                { nameof(PurchaseOrder.OrderDate), "基本資訊" },
                { nameof(PurchaseOrder.ExpectedDeliveryDate), "基本資訊" },
                { nameof(PurchaseOrder.Remarks), "額外資訊" }
            };
        }
        catch (Exception ex)
        {
            _ = ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(InitializeFormFieldsAsync), GetType(), 
                additionalData: "採購單編輯Modal表單欄位初始化失敗");
            
            // 設定安全的預設值
            formFields = new List<FormFieldDefinition>();
            formSections = new Dictionary<string, string>();
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }

    /// <summary>
    /// 生成採購單號
    /// </summary>
    private async Task<string> GeneratePurchaseOrderNumberAsync()
    {
        try
        {
            return await PurchaseOrderService.GenerateOrderNumberAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GeneratePurchaseOrderNumberAsync), GetType(), 
                additionalData: "生成採購單號失敗");
            
            // 如果服務方法失敗，使用 CodeGenerationHelper 作為後備
            return CodeGenerationHelper.GenerateSimpleEntityCode("PO", usePreciseTimestamp: true);
        }
    }
    
    // ===== AutoComplete 配置方法 =====
    
    /// <summary>
    /// 配置 AutoComplete 預填器
    /// </summary>
    private Dictionary<string, Func<string, Dictionary<string, object?>>> GetAutoCompletePrefillers()
    {
        return new Dictionary<string, Func<string, Dictionary<string, object?>>>
        {
            {
                nameof(PurchaseOrder.CompanyId), searchTerm => new Dictionary<string, object?>
                {
                    { "CompanyName", searchTerm }
                }
            },
            {
                nameof(PurchaseOrder.SupplierId), searchTerm => new Dictionary<string, object?>
                {
                    { "CompanyName", searchTerm }
                }
            }
        };
    }
    
    /// <summary>
    /// 配置 AutoComplete 資料集合
    /// </summary>
    private Dictionary<string, IEnumerable<object>> GetAutoCompleteCollections()
    {
        return new Dictionary<string, IEnumerable<object>>
        {
            { nameof(PurchaseOrder.CompanyId), availableCompanies.Cast<object>() },
            { nameof(PurchaseOrder.SupplierId), availableSuppliers.Cast<object>() }
        };
    }

    /// <summary>
    /// 配置 AutoComplete 顯示屬性
    /// </summary>
    private Dictionary<string, string> GetAutoCompleteDisplayProperties()
    {
        return new Dictionary<string, string>
        {
            { nameof(PurchaseOrder.CompanyId), "CompanyName" },
            { nameof(PurchaseOrder.SupplierId), "CompanyName" }
        };
    }

    /// <summary>
    /// 配置 AutoComplete 值屬性
    /// </summary>
    private Dictionary<string, string> GetAutoCompleteValueProperties()
    {
        return new Dictionary<string, string>
        {
            { nameof(PurchaseOrder.CompanyId), "Id" },
            { nameof(PurchaseOrder.SupplierId), "Id" }
        };
    }
    
    /// <summary>
    /// 配置 Modal 管理器
    /// </summary>
    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(PurchaseOrder.SupplierId), supplierModalManager }
        };
    }
    
    /// <summary>
    /// 配置自訂模組
    /// </summary>
    private List<GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>.CustomModule> GetCustomModules()
    {
        // 確保只在需要時才返回模組，並且檢查所有必要的條件
        if (editModalComponent == null)
        {
            return new List<GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>.CustomModule>();
        }

        return new List<GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>.CustomModule>
        {
            new GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>.CustomModule
            {
                @* Title = "採購明細", *@
                Order = 1,
                @* CssClass = "mt-4", *@
                IsVisible = true,
                Content = CreateProductManagerContent()
            }
        };
    }

    /// <summary>
    /// 創建商品管理器內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateProductManagerContent() => __builder =>
    {
        try
        {
                    @if (editModalComponent?.Entity != null && availableProducts != null)
                    {
                        <PurchaseOrderProductManagerComponent TMainEntity="PurchaseOrder" 
                                               TDetailEntity="PurchaseOrderDetail"
                                               Products="@availableProducts"
                                               SelectedSupplierId="@editModalComponent.Entity.SupplierId"
                                               MainEntity="@editModalComponent.Entity"
                                               ExistingDetails="@purchaseOrderDetails"
                                               OnDetailsChanged="@HandleDetailsChanged"
                                               MainEntityIdPropertyName="PurchaseOrderId"
                                               QuantityPropertyName="OrderQuantity"
                                               ReceivedQuantityPropertyName="ReceivedQuantity"
                                               UnitPricePropertyName="UnitPrice"
                                               RemarksPropertyName="DetailRemarks"
                                               QuantityLabel="採購數量"
                                               ReceivedQuantityLabel="已進貨數量"
                                               PriceLabel="採購單價"
                                               RemarksLabel="採購備註"
                                               IsReadOnly="@(editModalComponent.Entity.IsApproved)" />
                    }
                    else
                    {
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">載入中...</span>
                            </div>
                        </div>
                    }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                載入明細管理器時發生錯誤，請重新整理頁面。
            </div>
        }
    };
    
    // ===== Modal 管理器初始化方法 =====
    
    /// <summary>
    /// 初始化供應商 Modal 管理器
    /// </summary>
    private void InitializeSupplierModalManager()
    {
        supplierModalManager = new RelatedEntityManagerBuilder<Supplier>(NotificationService, "供應商")
            .WithPropertyName(nameof(PurchaseOrder.SupplierId))
            .WithReloadCallback(LoadAdditionalDataAsync)
            .WithStateChangedCallback(StateHasChanged)
            .WithAutoSelectCallback(supplierId => 
            {
                if (editModalComponent?.Entity != null)
                {
                    editModalComponent.Entity.SupplierId = supplierId;
                }
            })
            .WithCustomPostProcess(async supplier => 
            {
                await InitializeFormFieldsAsync();
            })
            .Build();
    }
    
    // ===== ActionButton 產生方法 =====
    
    /// <summary>
    /// 產生供應商操作按鈕 - 使用統一 Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetSupplierActionButtonsAsync()
    {
        var buttons = await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            supplierModalManager, 
            nameof(PurchaseOrder.SupplierId)
        );
        
        // 如果採購單已核准，禁用所有按鈕
        bool isApproved = editModalComponent?.Entity?.IsApproved ?? false;
        if (isApproved)
        {
            foreach (var button in buttons)
            {
                button.IsDisabled = true;
            }
        }
        
        return buttons;
    }
    
    // ===== Modal 事件包裝器方法 =====
    
    /// <summary>
    /// 包裝供應商儲存事件
    /// </summary>
    private async Task OnSupplierSavedWrapper(Supplier savedSupplier)
    {
        await supplierModalManager.HandleEntitySavedAsync(savedSupplier, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// 處理欄位值變更事件 - 使用統一 Helper
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // 使用統一 Helper 處理供應商欄位變更
            if (fieldChange.PropertyName == nameof(PurchaseOrder.SupplierId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    supplierModalManager, 
                    formFields, 
                    nameof(PurchaseOrder.SupplierId), 
                    fieldChange.Value
                );
                
                // 供應商變更時，觸發商品管理器重新渲染
                StateHasChanged();
            }
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("欄位變更處理時發生錯誤");
        }
    }

    // ===== 採購明細管理方法 =====
    
    /// <summary>
    /// 載入採購單明細
    /// </summary>
    private async Task LoadPurchaseOrderDetails(int purchaseOrderId)
    {
        try
        {
            // 從服務載入採購單明細
            purchaseOrderDetails = await PurchaseOrderService.GetOrderDetailsAsync(purchaseOrderId);
            
            // 確保不是 null
            if (purchaseOrderDetails == null)
            {
                purchaseOrderDetails = new List<PurchaseOrderDetail>();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadPurchaseOrderDetails), GetType(), 
                additionalData: $"載入採購單明細失敗 - OrderId: {purchaseOrderId}");
            purchaseOrderDetails = new List<PurchaseOrderDetail>();
        }
    }

    /// <summary>
    /// 處理採購明細變更
    /// </summary>
    private async Task HandleDetailsChanged(List<PurchaseOrderDetail> details)
    {
        try
        {
            purchaseOrderDetails = details ?? new List<PurchaseOrderDetail>();
            
            // 除錯：檢查明細資料
            Console.WriteLine($"HandleDetailsChanged: 收到 {purchaseOrderDetails.Count} 筆明細");
            foreach (var detail in purchaseOrderDetails)
            {
                Console.WriteLine($"明細 - ProductId: {detail.ProductId}, OrderQuantity: {detail.OrderQuantity}, UnitPrice: {detail.UnitPrice}, SubtotalAmount: {detail.SubtotalAmount}");
            }
            
            // 更新主檔的總金額
            if (editModalComponent?.Entity != null)
            {
                editModalComponent.Entity.TotalAmount = purchaseOrderDetails.Sum(d => d.SubtotalAmount);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDetailsChanged), GetType(), 
                additionalData: "處理採購明細變更失敗");
        }
    }

    /// <summary>
    /// 包裝方法 - 提供給 GenericEditModalComponent 使用的儲存處理器
    /// </summary>
    private async Task<bool> SavePurchaseOrderWrapper(PurchaseOrder purchaseOrder)
    {
        return await SavePurchaseOrderWithDetails(purchaseOrder, isPreApprovalSave: false);
    }

    /// <summary>
    /// 自訂儲存邏輯 - 同時儲存主檔和明細
    /// </summary>
    private async Task<bool> SavePurchaseOrderWithDetails(PurchaseOrder purchaseOrder, bool isPreApprovalSave = false)
    {
        try
        {
            if (purchaseOrder == null)
            {
                await NotificationService.ShowErrorAsync("沒有要儲存的採購單資料");
                return false;
            }

            // 檢查採購單是否已核准，已核准則不能修改（除非是審核前儲存）
            if (purchaseOrder.IsApproved && !isPreApprovalSave)
            {
                await NotificationService.ShowWarningAsync("採購單已核准，無法修改");
                return false;
            }

            // 更新總金額
            purchaseOrder.TotalAmount = purchaseOrderDetails.Sum(d => d.SubtotalAmount);

            // 儲存主檔
            ServiceResult<PurchaseOrder> result;
            if (PurchaseOrderId.HasValue)
            {
                result = await PurchaseOrderService.UpdateAsync(purchaseOrder);
            }
            else
            {
                result = await PurchaseOrderService.CreateAsync(purchaseOrder);
            }

            if (!result.IsSuccess || result.Data == null)
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "儲存採購單失敗");
                return false;
            }

            // 儲存明細
            await SavePurchaseOrderDetails(result.Data.Id);

            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SavePurchaseOrderWithDetails), GetType(), 
                additionalData: "儲存採購單和明細失敗");
            await NotificationService.ShowErrorAsync($"儲存時發生錯誤：{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// 儲存採購單明細
    /// </summary>
    private async Task SavePurchaseOrderDetails(int purchaseOrderId)
    {
        try
        {
            Console.WriteLine($"SavePurchaseOrderDetails: 準備儲存 {purchaseOrderDetails.Count} 筆明細");
            
            // 設定主檔ID
            foreach (var detail in purchaseOrderDetails)
            {
                detail.PurchaseOrderId = purchaseOrderId;
                if (detail.Id == 0)
                {
                    detail.Status = EntityStatus.Active;
                    detail.CreatedAt = DateTime.Now;
                }
                else
                {
                    detail.UpdatedAt = DateTime.Now;
                }
                
                Console.WriteLine($"儲存前明細 - Id: {detail.Id}, ProductId: {detail.ProductId}, OrderQuantity: {detail.OrderQuantity}, UnitPrice: {detail.UnitPrice}");
            }

            // 先獲取現有的明細
            var existingDetails = await PurchaseOrderService.GetOrderDetailsAsync(purchaseOrderId);
            
            // 處理新增和更新的明細
            foreach (var detail in purchaseOrderDetails.Where(d => d.ProductId > 0))
            {
                if (detail.Id == 0)
                {
                    // 新增明細
                    await PurchaseOrderService.AddOrderDetailAsync(detail);
                }
                else
                {
                    // 更新明細
                    await PurchaseOrderService.UpdateOrderDetailAsync(detail);
                }
            }

            // 處理刪除的明細（現有的但不在當前列表中的）
            var currentDetailIds = purchaseOrderDetails.Where(d => d.Id > 0).Select(d => d.Id).ToList();
            var detailsToDelete = existingDetails.Where(e => !currentDetailIds.Contains(e.Id)).ToList();
            
            foreach (var detailToDelete in detailsToDelete)
            {
                await PurchaseOrderService.DeleteOrderDetailAsync(detailToDelete.Id);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SavePurchaseOrderDetails), GetType(), 
                additionalData: $"儲存採購單明細失敗 - OrderId: {purchaseOrderId}");
            throw; // 重新拋出例外，讓上層處理
        }
    }
    
    // ===== 審核相關方法 =====
    
    /// <summary>
    /// 判斷是否應該顯示審核區域
    /// </summary>
    private bool ShouldShowApprovalSection()
    {
        // 只有編輯現有採購單時才顯示審核區域
        return PurchaseOrderId.HasValue && PurchaseOrderId.Value > 0;
    }
    
    /// <summary>
    /// 處理採購單審核通過
    /// </summary>
    private async Task<bool> HandlePurchaseOrderApprove()
    {
        try
        {
            if (!PurchaseOrderId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法審核：採購單ID不存在");
                return false;
            }
            
            // 確認對話框
            var confirmed = await NotificationService.ShowConfirmAsync(
                "確定要審核通過此採購單嗎？系統將先儲存當前資料，然後進行審核。審核通過後將無法再修改。", 
                "審核確認");
            
            if (!confirmed)
                return false;
            
            // **方案一實施：審核前先自動儲存**
            if (editModalComponent?.Entity != null)
            {
                // 暫時允許儲存（即使已核准狀態也要能儲存，因為可能有未儲存的變更）
                var saveResult = await SavePurchaseOrderWithDetails(editModalComponent.Entity, isPreApprovalSave: true);
                if (!saveResult)
                {
                    await NotificationService.ShowErrorAsync("儲存失敗，無法進行審核");
                    return false;
                }
                
                await NotificationService.ShowInfoAsync("資料已儲存，正在進行審核...");
            }
            
            // 呼叫服務進行審核
            var currentUserId = await GetCurrentUserIdAsync();
            if (!currentUserId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法取得當前使用者資訊");
                return false;
            }
            
            var result = await PurchaseOrderService.ApproveOrderAsync(PurchaseOrderId.Value, currentUserId.Value);
            
            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync("採購單審核通過");
                return true;
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "審核通過失敗");
                return false;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePurchaseOrderApprove), GetType(), 
                additionalData: $"採購單審核通過失敗 - OrderId: {PurchaseOrderId}");
            await NotificationService.ShowErrorAsync($"審核通過時發生錯誤：{ex.Message}");
            return false;
        }
    }
    
    /// <summary>
    /// 處理採購單審核駁回
    /// </summary>
    private async Task<bool> HandlePurchaseOrderReject()
    {
        try
        {
            if (!PurchaseOrderId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法審核：採購單ID不存在");
                return false;
            }
            
            // 使用 JavaScript prompt 來取得駁回原因
            var rejectReason = await JSRuntime.InvokeAsync<string>("prompt", "請輸入駁回原因：", "");
            
            if (string.IsNullOrWhiteSpace(rejectReason))
            {
                await NotificationService.ShowWarningAsync("駁回原因不能為空");
                return false;
            }
            
            // 確認對話框
            var confirmed = await NotificationService.ShowConfirmAsync(
                $"確定要駁回此採購單嗎？\n駁回原因：{rejectReason}\n\n駁回後採購單將退回修改。", 
                "審核確認");
            
            if (!confirmed)
                return false;
            
            // 取得當前使用者ID
            var currentUserId = await GetCurrentUserIdAsync();
            if (!currentUserId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法取得當前使用者資訊");
                return false;
            }
            
            // 呼叫服務進行駁回
            var result = await PurchaseOrderService.RejectOrderAsync(PurchaseOrderId.Value, currentUserId.Value, rejectReason);
            
            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync("採購單已駁回");
                // 重新載入資料以更新界面
                if (editModalComponent != null)
                {
                    await editModalComponent.RefreshEntityAsync();
                }
                return true;
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "駁回失敗");
                return false;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePurchaseOrderReject), GetType(), 
                additionalData: $"採購單審核駁回失敗 - OrderId: {PurchaseOrderId}");
            await NotificationService.ShowErrorAsync($"審核駁回時發生錯誤：{ex.Message}");
            return false;
        }
    }
    
    /// <summary>
    /// 取得採購單審核狀態
    /// </summary>
    private async Task<string?> GetPurchaseOrderApprovalStatus()
    {
        try
        {
            if (editModalComponent?.Entity == null)
                return null;
            
            var purchaseOrder = editModalComponent.Entity;
            
            if (purchaseOrder.IsApproved && purchaseOrder.ApprovedAt.HasValue)
            {
                var approverName = purchaseOrder.ApprovedByUser?.Name ?? "審核人員";
                return $"已於 {purchaseOrder.ApprovedAt.Value:yyyy/MM/dd HH:mm} 由 {approverName} 審核通過";
            }
            else if (!string.IsNullOrWhiteSpace(purchaseOrder.RejectReason))
            {
                return $"已駁回";
            }
            else
            {
                return "待審核";
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetPurchaseOrderApprovalStatus), GetType(), 
                additionalData: $"取得採購單審核狀態失敗 - OrderId: {PurchaseOrderId}");
            return "無法取得審核狀態";
        }
    }
    
    /// <summary>
    /// 取得採購單審核歷史
    /// </summary>
    private async Task<List<string>> GetPurchaseOrderApprovalHistory()
    {
        try
        {
            if (editModalComponent?.Entity == null)
                return new List<string>();
            
            var purchaseOrder = editModalComponent.Entity;
            var history = new List<string>();
            
            // 建立記錄
            if (purchaseOrder.CreatedAt != default)
            {
                history.Add($"{purchaseOrder.CreatedAt:yyyy/MM/dd HH:mm} - {purchaseOrder.CreatedBy ?? "系統"} 建立採購單");
            }
            
            // 最後修改記錄
            if (purchaseOrder.UpdatedAt.HasValue)
            {
                history.Add($"{purchaseOrder.UpdatedAt.Value:yyyy/MM/dd HH:mm} - {purchaseOrder.UpdatedBy ?? "系統"} 修改採購單");
            }
            
            // 審核記錄
            if (purchaseOrder.ApprovedAt.HasValue)
            {
                // 如果有審核人員資訊，則顯示審核人員姓名，否則顯示預設文字
                var approverName = purchaseOrder.ApprovedByUser?.Name ?? "審核人員";
                history.Add($"{purchaseOrder.ApprovedAt.Value:yyyy/MM/dd HH:mm} - {approverName} 審核通過");
            }
            else if (!string.IsNullOrWhiteSpace(purchaseOrder.RejectReason))
            {
                // 駁回記錄 - 使用 UpdatedAt 作為駁回時間
                var rejectTime = purchaseOrder.UpdatedAt ?? DateTime.Now;
                // 駁回人員通常記錄在 UpdatedBy 中，或可以從審核人員取得
                var rejectorName = purchaseOrder.UpdatedBy ?? purchaseOrder.ApprovedByUser?.Name ?? "審核人員";
                history.Add($"{rejectTime:yyyy/MM/dd HH:mm} - {rejectorName} 駁回採購單：{purchaseOrder.RejectReason}");
            }
            
            return history;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetPurchaseOrderApprovalHistory), GetType(), 
                additionalData: $"取得採購單審核歷史失敗 - OrderId: {PurchaseOrderId}");
            return new List<string> { "無法取得審核歷史" };
        }
    }
    
    /// <summary>
    /// 取得當前使用者ID
    /// </summary>
    private async Task<int?> GetCurrentUserIdAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (!user.Identity?.IsAuthenticated ?? true)
                return null;

            // 從Claims中取得使用者ID (通常存在NameIdentifier中)
            var employeeIdClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (int.TryParse(employeeIdClaim, out int employeeId))
                return employeeId;

            return null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetCurrentUserIdAsync), GetType(), 
                additionalData: "取得當前使用者ID失敗");
            return null;
        }
    }
}
