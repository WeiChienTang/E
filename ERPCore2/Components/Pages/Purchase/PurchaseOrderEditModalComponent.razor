@* 可重用的採購單編輯組件 - 可在任何頁面中嵌入 *@

@using ERPCore2.Helpers
@using ERPCore2.Services.Reports
@using ERPCore2.Services.Reports.Interfaces
@using ERPCore2.Models.Reports
@inject IPurchaseOrderService PurchaseOrderService
@inject ISupplierService SupplierService
@inject ICompanyService CompanyService
@inject IProductService ProductService
@inject INotificationService NotificationService
@inject IReportPrintConfigurationService ReportPrintConfigurationService
@inject ISystemParameterService SystemParameterService
@inject ITextMessageTemplateService TextMessageTemplateService
@inject IPurchaseOrderReportService PurchaseOrderReportService
@inject IPrinterConfigurationService PrinterConfigurationService
@inject NavigationManager NavigationManager
@inject ActionButtonHelper ActionButtonHelper
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ERPCore2.Data.Context.AppDbContext DbContext

<GenericEditModalComponent TEntity="PurchaseOrder" 
                          TService="IPurchaseOrderService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@PurchaseOrderId"
                          Service="@PurchaseOrderService"
                          EntityName="採購單"
                          EntityNamePlural="採購單"
                          ModalTitle="@(PurchaseOrderId.HasValue ? "編輯採購單" : "新增採購單")"
                          Size="GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@autoCompleteConfig?.Prefillers"
                          AutoCompleteCollections="@autoCompleteConfig?.Collections"
                          AutoCompleteDisplayProperties="@autoCompleteConfig?.DisplayProperties"
                          AutoCompleteValueProperties="@autoCompleteConfig?.ValueProperties"
                          ModalManagers="@modalManagers?.AsDictionary()"
                          DataLoader="@LoadPurchaseOrderData"
                          SaveHandler="@SavePurchaseOrderWrapper"
                          SaveSuccessMessage="@(PurchaseOrderId.HasValue ? "採購單更新成功" : "採購單新增成功")"
                          SaveFailureMessage="採購單儲存失敗"
                          RequiredPermission="PurchaseOrder.Read"
                          OnEntitySaved="@OnPurchaseOrderSaved"
                          OnCancel="@OnCancel"
                          OnTaxMethodChanged="@(() => HandleDetailsChanged(purchaseOrderDetails))"
                          CustomValidator="@ValidatePurchaseOrderDetailsAsync"
                          CustomModules="@GetCustomModules()"
                          ShowPrintButton = "true"
                          PrintButtonText="列印"
                          ReportService="@PurchaseOrderReportService"
                          ReportId="@ReportIds.PurchaseOrder"
                          ReportPreviewTitle="採購單預覽"
                          GetReportDocumentName="@(e => $"採購單-{e.Code}")"
                          ShowApprovalSection="@ShouldShowApprovalSection()"
                          ApprovalPermission="PurchaseOrder.Approve"
                          OnApprove="@HandlePurchaseOrderApprove"
                          OnRejectWithReason="@HandlePurchaseOrderRejectWithReason"
                          FormHeaderContent="@GetWarningMessage()"
                          CustomActionButtons="@GetCustomActionButtons()"
                          OnEntityLoaded="@HandleEntityLoaded">
</GenericEditModalComponent>

@* 廠商編輯 Modal *@
@if (supplierModalManager != null)
{
    <SupplierEditModalComponent @ref="supplierEditModal"
                               IsVisible="@supplierModalManager.IsModalVisible"
                               IsVisibleChanged="@supplierModalManager.HandleModalVisibilityChangedAsync"
                               SupplierId="@supplierModalManager.SelectedEntityId"
                               PrefilledValues="@supplierModalManager.PrefilledValues"
                               OnSupplierSaved="@OnSupplierSavedWrapper"
                               OnCancel="@supplierModalManager.HandleModalCancelAsync" />
}

@* 進貨單編輯 Modal *@
<PurchaseReceivingEditModalComponent @ref="purchaseReceivingEditModal"
                                     IsVisible="@showPurchaseReceivingModal"
                                     IsVisibleChanged="@((bool visible) => showPurchaseReceivingModal = visible)"
                                     PurchaseReceivingId="@selectedPurchaseReceivingId"
                                     OnPurchaseReceivingSaved="@HandlePurchaseReceivingSaved"
                                     OnCancel="@(() => showPurchaseReceivingModal = false)" />

@* 訊息範本設定 Modal *@
<TextMessageTemplateEditModalComponent IsVisible="@showTemplateSettingModal"
                                       IsVisibleChanged="@((bool visible) => showTemplateSettingModal = visible)"
                                       TextMessageTemplateId="@currentTemplateId"
                                       OnTemplateSaved="@HandleTemplateSaved"
                                       OnCancel="@(() => showTemplateSettingModal = false)" />

@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? PurchaseOrderId { get; set; }
    [Parameter] public EventCallback<PurchaseOrder> OnPurchaseOrderSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // AutoComplete 配置
    private AutoCompleteConfig? autoCompleteConfig;
    
    // 原始資料集合（用於 AutoComplete）
    private List<Supplier> availableSuppliers = new();
    private List<Company> availableCompanies = new();
    private List<Product> availableProducts = new();
    
    // 採購訂單明細
    private List<PurchaseOrderDetail> purchaseOrderDetails = new();
    private PurchaseOrderTable<PurchaseOrder, PurchaseOrderDetail>? purchaseOrderDetailManager;
    
    // 方案 D 改良版：資料版本計數器，每次載入新資料時遞增
    private int _detailsDataVersion = 0;
    
    // Modal 管理器
    private SupplierEditModalComponent? supplierEditModal;
    private RelatedEntityModalManager<Supplier> supplierModalManager = default!;
    private ModalManagerCollection modalManagers = default!;
    
    // ===== 相關單據 Modal =====
    private PurchaseReceivingEditModalComponent? purchaseReceivingEditModal;
    private bool showPurchaseReceivingModal = false;
    private int? selectedPurchaseReceivingId = null;
    
    // 下拉選單選項
    private List<SelectOption> taxCalculationMethodOptions = new();
    
    // 系統參數 - 稅率快取（避免重複查詢資料庫）
    private decimal currentTaxRate = 5.0m; // 預設 5%，實際值會在初始化時從資料庫載入
    
    // ===== 審核開關狀態 =====
    private bool isApprovalEnabled = true; // 是否啟用審核功能（從系統參數載入）
    
    // ===== 鎖定狀態 =====
    private bool hasUndeletableDetails = false; // 是否有不可刪除的明細（已有進貨記錄）
    
    // ===== 轉單狀態 =====
    private bool canCreateReceiving = false; // 是否可以轉進貨單（新增模式需先儲存，編輯模式直接為 true）
    
    // ===== 預填資料（從低庫存警戒開啟採購單時使用） =====
    private int? prefilledSupplierId = null;
    private int? prefilledProductId = null;
    private decimal? prefilledUnitPrice = null;
    
    // ===== 複製訊息狀態 =====
    private bool canCopyMessage = false; // 是否可以複製訊息（新增模式需先儲存，編輯模式直接為 true）
    private bool showTemplateSettingModal = false; // 是否顯示訊息範本設定 Modal
    private int? currentTemplateId = null; // 當前範本 ID（用於設定 Modal）

    // 資料載入狀態標記
    private bool isDataLoaded = false;

    // ===== 必要方法 =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 載入審核開關設定（優先執行,影響後續邏輯）
            isApprovalEnabled = await SystemParameterService.IsPurchaseOrderApprovalEnabledAsync();
            
            // 使用 ModalManagerInitHelper 初始化 Modal 管理器
            modalManagers = ModalManagerInitHelper.CreateBuilder<PurchaseOrder, IPurchaseOrderService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Supplier>(nameof(PurchaseOrder.SupplierId), "廠商")
                .Build();
            supplierModalManager = modalManagers.Get<Supplier>(nameof(PurchaseOrder.SupplierId));
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化採購單編輯組件時發生錯誤");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            // 打開時,如果是新增模式,重置鎖定狀態
            if (!PurchaseOrderId.HasValue)
            {
                hasUndeletableDetails = false;
            }
            
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
        }

        await base.OnParametersSetAsync();
    }
    private async Task<PurchaseOrder?> LoadPurchaseOrderData()
    {
        try
        {
            if (!PurchaseOrderId.HasValue)
            {
                // 新增模式 - 使用統一的 EntityCodeGenerationHelper 產生採購單號（支援 Attribute 配置）
                var generatedCode = await EntityCodeGenerationHelper.GenerateForEntity<PurchaseOrder, IPurchaseOrderService>(
                    PurchaseOrderService,
                    DbContext
                );
                
                // 取得預設公司
                var primaryCompany = await CompanyService.GetPrimaryCompanyAsync();
                
                var newOrder = new PurchaseOrder
                {
                    OrderDate = DateTime.Today,
                    ExpectedDeliveryDate = DateTime.Today.AddDays(7),
                    Status = EntityStatus.Active,
                    TotalAmount = 0,
                    Code = generatedCode,
                    CompanyId = primaryCompany?.Id ?? 1 // 設定預設公司，如果沒有主要公司則為1
                };
                
                // 清空明細
                purchaseOrderDetails.Clear();
                
                // 如果有預填的供應商 ID，只設定 SupplierId（不設定 Supplier 導航屬性，避免 EF Core 追蹤錯誤）
                if (prefilledSupplierId.HasValue && prefilledSupplierId.Value > 0)
                {
                    newOrder.SupplierId = prefilledSupplierId.Value;
                }
                
                // 如果有預填的商品 ID，直接添加明細（在 LoadPurchaseOrderData 中處理，確保 UI 渲染時就有資料）
                if (prefilledProductId.HasValue && prefilledProductId.Value > 0)
                {
                    var product = availableProducts.FirstOrDefault(p => p.Id == prefilledProductId.Value);
                    if (product != null)
                    {
                        // 只設定 ProductId，不設定 Product 導航屬性，避免 EF Core 追蹤錯誤
                        var newDetail = new PurchaseOrderDetail
                        {
                            ProductId = product.Id,
                            OrderQuantity = 1,
                            UnitPrice = prefilledUnitPrice ?? 0,
                            ReceivedQuantity = 0,
                            Remarks = "從低庫存警戒建立"
                        };
                        
                        purchaseOrderDetails.Add(newDetail);
                        
                        // 直接計算 newOrder 的金額（此時 editModalComponent.Entity 還不存在）
                        var (total, tax) = TaxCalculationHelper.CalculateFromDetails(
                            purchaseOrderDetails,
                            newOrder.TaxCalculationMethod,
                            currentTaxRate,
                            d => d.SubtotalAmount,
                            d => d.TaxRate);
                        newOrder.TotalAmount = total;
                        newOrder.PurchaseTaxAmount = tax;
                    }
                }
                
                //  新增模式時,重置鎖定狀態為 false
                hasUndeletableDetails = false;
                
                // 新增模式：必須先儲存才能轉單和列印
                canCreateReceiving = false;
                canCopyMessage = false;
                
                return newOrder;
            }

            // 編輯模式 - 載入採購單和明細
            canCreateReceiving = true; // 編輯模式：可以直接轉單
            canCopyMessage = true; // 編輯模式：可以直接複製訊息
            
            var purchaseOrder = await PurchaseOrderService.GetByIdAsync(PurchaseOrderId.Value);
            
            if (purchaseOrder != null)
            {
                // 載入採購單明細
                await LoadPurchaseOrderDetails(PurchaseOrderId.Value);
                
                // 修正 2：直接初始化表單欄位，移除 Task.Run + Task.Delay 延遲模式
                // NavigateToRecordAsync 會在 DataLoader 返回後呼叫 StateHasChanged()，不需要在這裡額外呼叫
                await InitializeFormFieldsAsync();
            }
            
            return purchaseOrder;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadPurchaseOrderData), GetType(), 
                additionalData: $"載入採購單資料失敗 - ID: {PurchaseOrderId}");
            await NotificationService.ShowErrorAsync($"載入採購單資料時發生錯誤：{ex.Message}");
            return null;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // 載入廠商、公司、商品資料（用於 AutoComplete）
            availableSuppliers = await SupplierService.GetAllAsync();
            availableCompanies = await CompanyService.GetAllAsync();
            availableProducts = await ProductService.GetAllAsync();
            
            //  一次性載入系統稅率（避免每次計算都查詢資料庫）
            currentTaxRate = await TaxCalculationHelper.LoadTaxRateAsync(SystemParameterService);
            
            // 使用 AutoCompleteConfigHelper 建立配置
            autoCompleteConfig = new AutoCompleteConfigBuilder<PurchaseOrder>()
                .AddField(nameof(PurchaseOrder.SupplierId), "CompanyName", availableSuppliers)
                .AddField(nameof(PurchaseOrder.CompanyId), "CompanyName", availableCompanies)
                .Build();

            taxCalculationMethodOptions = TaxCalculationHelper.GetTaxMethodOptions();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadAdditionalDataAsync), GetType(), 
                additionalData: "採購單編輯Modal載入額外資料失敗");
            
            // 設定安全的預設值
            taxCalculationMethodOptions = new List<SelectOption>();
            availableProducts = new List<Product>();
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            // 使用 ApprovalConfigHelper 統一判斷是否鎖定欄位
            var shouldLock = ApprovalConfigHelper.ShouldLockFieldByApproval(
                isApprovalEnabled,
                editModalComponent?.Entity?.IsApproved ?? false,
                hasUndeletableDetails
            );
            
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(PurchaseOrder.Code),
                    Label = "採購單號",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入採購單號",
                    IsRequired = true,
                    MaxLength = 30,
                    HelpText = "採購單的唯一編號，新增時系統會自動產生，也可手動修改",
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(PurchaseOrder.SupplierId),
                    Label = "廠商",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇廠商",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "輸入廠商名稱進行搜尋，或直接選擇",
                    ActionButtons = await GetSupplierActionButtonsAsync(),
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(PurchaseOrder.CompanyId),
                    Label = "採購公司",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請選擇採購公司",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "選擇進行此次採購的公司",
                    IsReadOnly = shouldLock
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseOrder.PurchasePersonnel),
                    Label = "採購員",
                    FieldType = FormFieldType.Text,
                    IsRequired = true,
                    HelpText = "負責此次採購的員工姓名",                    
                },
                new()
                {
                    PropertyName = nameof(PurchaseOrder.OrderDate),
                    Label = "採購日",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "採購單建立日期",
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(PurchaseOrder.ExpectedDeliveryDate),
                    Label = "交貨日",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "預計廠商交貨的日期(預設為採購日後7天)",
                    IsReadOnly = shouldLock
                },
                new()
                {
                    PropertyName = nameof(PurchaseOrder.TaxCalculationMethod),
                    Label = "稅別",
                    FieldType = FormFieldType.Select,
                    IsRequired = true,
                    Options = taxCalculationMethodOptions,
                    HelpText = "選擇稅額計算方式：外加稅（稅額另計）、內含稅（總額已含稅）、不含稅（免稅）",
                    IsReadOnly = shouldLock
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseOrder.TotalAmount),
                    Label = "金額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "採購單的總金額，根據明細自動計算",
                    IsReadOnly = true, // 總金額欄位始終為唯讀
                    CssClass = "text-warning fw-bold" // 使用黃色粗體顯示
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseOrder.PurchaseTaxAmount),
                    Label = "稅額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "採購單的稅額，根據明細自動計算",
                    IsReadOnly = true, // 稅額欄位始終為唯讀
                    CssClass = "text-info fw-bold" // 使用藍色粗體顯示
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseOrder.PurchaseTotalAmountIncludingTax),
                    Label = "總額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "採購單的含稅總金額，根據明細自動計算",
                    IsReadOnly = true, // 含稅總金額欄位始終為唯讀
                    CssClass = "text-success fw-bold" // 使用綠色粗體顯示
                },

                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseOrder.RejectReason),
                    Label = "駁回原因",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入駁回原因",
                    IsRequired = false,
                    MaxLength = 50,
                    HelpText = "其他需要記錄的駁回原因",
                    ContainerCssClass = "col-6",
                    IsReadOnly = true
                },

                FormFieldConfigurationHelper.CreateRemarksField<PurchaseOrder>(
                    containerCssClass: "col-6",
                    readOnly: shouldLock // 根據審核狀態和明細狀態決定是否鎖定
                ),
            };

            formSections = FormSectionHelper<PurchaseOrder>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    po => po.Code,
                    po => po.SupplierId,
                    po => po.CompanyId,
                    po => po.OrderDate,
                    po => po.ExpectedDeliveryDate)                    
                .AddToSection(FormSectionNames.AmountInfo,
                    po => po.TaxCalculationMethod,
                    po => po.TotalAmount,
                    po => po.PurchaseTaxAmount,
                    po => po.PurchaseTotalAmountIncludingTax)
                .AddToSection(FormSectionNames.AdditionalInfo,
                    po => po.Remarks)
                .Build();
        }
        catch (Exception ex)
        {
            _ = ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(InitializeFormFieldsAsync), GetType(), 
                additionalData: "採購單編輯Modal表單欄位初始化失敗");
            
            // 設定安全的預設值
            formFields = new List<FormFieldDefinition>();
            formSections = new Dictionary<string, string>();
        }
    }

    // ===== AutoComplete 配置方法 =====
    
    /// <summary>
    /// 配置自訂模組
    /// </summary>
    private List<GenericEditModalComponent<PurchaseOrder, IPurchaseOrderService>.CustomModule> GetCustomModules()
    {
        return CustomModuleHelper.CreateSingle(editModalComponent, CreateProductManagerContent());
    }

    /// <summary>
    /// 創建商品管理器內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateProductManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null)
            {
                // 檢查是否有可用的商品資料
                @if (availableProducts != null && availableProducts.Any())
                {
                    // 修正：使用 CSS 隱藏而非條件卸載，避免元件重建
                    // 當 SupplierId <= 0 時隱藏 Table，但不卸載元件
                    @if (editModalComponent.Entity.SupplierId <= 0)
                    {
                        <div class="alert alert-info text-center" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            請先選擇廠商後再進行採購明細管理
                        </div>
                    }
                    
                    <div style="@(editModalComponent.Entity.SupplierId > 0 ? "" : "display:none")">
                        <PurchaseOrderTable @ref="purchaseOrderDetailManager"
                                                   TMainEntity="PurchaseOrder" 
                                                   TDetailEntity="PurchaseOrderDetail"
                                                   Products="@availableProducts"
                                                   SelectedSupplierId="@editModalComponent.Entity.SupplierId"
                                                   MainEntity="@editModalComponent.Entity"
                                                   ExistingDetails="@purchaseOrderDetails"
                                                   DataVersion="@_detailsDataVersion"
                                                   IsParentLoading="@(editModalComponent?.IsLoading ?? false)"
                                                   OnDetailsChanged="@HandleDetailsChanged"
                                                   MainEntityIdPropertyName="PurchaseOrderId"
                                                   QuantityPropertyName="OrderQuantity"
                                                   ReceivedQuantityPropertyName="ReceivedQuantity"
                                                   UnitPricePropertyName="UnitPrice"
                                                   RemarksPropertyName="Remarks"
                                                   IsReceivingCompletedPropertyName="IsReceivingCompleted"
                                                   IsReadOnly="false"
                                                   IsApproved="@(editModalComponent?.Entity?.IsApproved ?? false)"
                                                   TaxCalculationMethod="@(editModalComponent?.Entity?.TaxCalculationMethod ?? TaxCalculationMethod.TaxExclusive)"
                                                   OnHasUndeletableDetailsChanged="@(async (hasUndeletable) => await HandleHasUndeletableDetailsChanged(hasUndeletable))"
                                                   OnOpenRelatedDocument="@(async (doc) => await HandleOpenRelatedDocument(doc))" />
                    </div>
                }
                else
                {
                    <div class="alert alert-warning text-center" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        無可用的商品資料，請聯繫系統管理員
                    </div>
                }
            }
            else
            {
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">載入中...</span>
                    </div>
                </div>
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                載入明細管理器時發生錯誤，請重新整理頁面。
            </div>
        }
    };
    
    // ===== ActionButton 產生方法 =====
    
    /// <summary>
    /// 產生廠商操作按鈕 - 使用統一 Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetSupplierActionButtonsAsync()
    {
        // 使用 ApprovalConfigHelper 統一判斷是否鎖定
        var shouldLock = ApprovalConfigHelper.ShouldLockFieldByApproval(
            isApprovalEnabled,
            editModalComponent?.Entity?.IsApproved ?? false,
            hasUndeletableDetails
        );
        
        if (shouldLock)
        {
            return new List<FieldActionButton>();
        }
        
        var buttons = await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            supplierModalManager, 
            nameof(PurchaseOrder.SupplierId)
        );
        
        return buttons;
    }
    
    /// <summary>
    /// 更新欄位的唯讀狀態 - 根據是否有不可刪除的明細
    /// 使用 FormFieldLockHelper 統一處理欄位鎖定邏輯
    /// </summary>
    private async void UpdateFieldsReadOnlyState()
    {
        // 統一鎖定/解鎖所有受影響欄位（含 ActionButtons 處理）
        FormFieldLockHelper.LockMultipleFields(
            formFields,
            new[]
            {
                nameof(PurchaseOrder.CompanyId),
                nameof(PurchaseOrder.Code),
                nameof(PurchaseOrder.OrderDate),
                nameof(PurchaseOrder.ExpectedDeliveryDate),
                nameof(PurchaseOrder.Remarks),
                nameof(PurchaseOrder.RejectReason),
                nameof(PurchaseOrder.SupplierId)
            },
            isLocked: hasUndeletableDetails,
            actionButtonsMap: new Dictionary<string, Func<Task<List<FieldActionButton>>>>
            {
                { nameof(PurchaseOrder.SupplierId), GetSupplierActionButtonsAsync }
            }
        );

        // 重新初始化表單欄位以強制更新 UI
        await InvokeAsync(async () =>
        {
            await InitializeFormFieldsAsync();
            StateHasChanged();
        });
    }
    
    // ===== Modal 事件包裝器方法 =====
    
    /// <summary>
    /// 包裝廠商儲存事件
    /// </summary>
    private async Task OnSupplierSavedWrapper(Supplier savedSupplier)
    {
        await supplierModalManager.HandleEntitySavedAsync(savedSupplier, shouldAutoSelect: true);
    }
    

    // ===== 採購明細管理方法 =====
    
    /// <summary>
    /// 處理實體載入完成事件（由 GenericEditModalComponent 的導航觸發）
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            canCreateReceiving = true;
            canCopyMessage = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleEntityLoaded), GetType(), 
                additionalData: $"處理實體載入事件失敗 - EntityId: {loadedEntityId}");
            await NotificationService.ShowErrorAsync("載入明細資料時發生錯誤");
        }
    }
    
    /// <summary>
    /// 處理有不可刪除明細的狀態變更
    /// 當明細動態變化時（新增進貨、刪除進貨記錄等），這個方法會被調用
    /// </summary>
    private async Task HandleHasUndeletableDetailsChanged(bool hasUndeletable)
    {
        try
        {
            hasUndeletableDetails = hasUndeletable;
            UpdateFieldsReadOnlyState();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理明細鎖定狀態時發生錯誤：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 載入採購單明細
    /// </summary>
    private async Task LoadPurchaseOrderDetails(int purchaseOrderId)
    {
        try
        {
            // 從服務載入採購單明細
            purchaseOrderDetails = await PurchaseOrderService.GetOrderDetailsAsync(purchaseOrderId);
            
            // 確保不是 null
            if (purchaseOrderDetails == null)
            {
                purchaseOrderDetails = new List<PurchaseOrderDetail>();
            }
            
            // 方案 D 改良版：遞增版本號，通知 Table 重新載入
            _detailsDataVersion++;
            
            //  載入明細後,檢查是否有不可刪除的明細(有進貨記錄)
            var hasReceiving = purchaseOrderDetails.Any(d => d.ReceivedQuantity > 0);
            await HandleHasUndeletableDetailsChanged(hasReceiving);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadPurchaseOrderDetails), GetType(), 
                additionalData: $"載入採購單明細失敗 - OrderId: {purchaseOrderId}");
            purchaseOrderDetails = new List<PurchaseOrderDetail>();
        }
    }

    /// <summary>
    /// 處理採購明細變更
    /// </summary>
    private async Task HandleDetailsChanged(List<PurchaseOrderDetail> details)
    {
        try
        {
            purchaseOrderDetails = details ?? new List<PurchaseOrderDetail>();            
            
            // 更新主檔的總金額、稅額、含稅總額
            if (editModalComponent?.Entity != null)
            {
                var (total, tax) = TaxCalculationHelper.CalculateFromDetails(
                    purchaseOrderDetails,
                    editModalComponent.Entity.TaxCalculationMethod,
                    currentTaxRate,
                    d => d.SubtotalAmount,
                    d => d.TaxRate);
                editModalComponent.Entity.TotalAmount = total;
                editModalComponent.Entity.PurchaseTaxAmount = tax;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDetailsChanged), GetType(), 
                additionalData: "處理採購明細變更失敗");
        }
    }

    /// <summary>
    /// 驗證採購單明細 - 確保至少有一筆明細
    /// </summary>
    private async Task<bool> ValidatePurchaseOrderDetailsAsync(PurchaseOrder purchaseOrder)
    {
        try
        {
            // 檢查是否有有效的明細（至少選擇了商品）
            var validDetails = purchaseOrderDetails.Where(d => d.ProductId > 0).ToList();
            
            if (!validDetails.Any())
            {
                await NotificationService.ShowErrorAsync("採購單必須至少包含一筆明細資料");
                return false;
            }
            
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"驗證明細時發生錯誤：{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// 包裝方法 - 提供給 GenericEditModalComponent 使用的儲存處理器
    /// </summary>
    private async Task<bool> SavePurchaseOrderWrapper(PurchaseOrder purchaseOrder)
    {
        // 先執行自訂驗證
        if (!await ValidatePurchaseOrderDetailsAsync(purchaseOrder))
        {
            return false;
        }
        
        var result = await SavePurchaseOrderWithDetails(purchaseOrder, isPreApprovalSave: false);
        
        // 儲存成功後允許轉進貨
        if (result)
        {
            canCreateReceiving = true;
            canCopyMessage = true;
        }
        
        return result;
    }

    /// <summary>
    /// 自訂儲存邏輯 - 同時儲存主檔和明細
    /// 特殊處理：審核通過後仍允許儲存，用於更新明細的「完成進貨」等執行狀態
    /// </summary>
    private async Task<bool> SavePurchaseOrderWithDetails(PurchaseOrder purchaseOrder, bool isPreApprovalSave = false)
    {
        try
        {
            if (purchaseOrder == null)
            {
                await NotificationService.ShowErrorAsync("沒有要儲存的採購單資料");
                return false;
            }

            // 不需要重新計算稅額：HandleDetailsChanged 已根據每筆明細的實際稅率
            // 正確計算了 TotalAmount、PurchaseTaxAmount、PurchaseTotalAmountIncludingTax

            // 儲存主檔
            ServiceResult<PurchaseOrder> result;
            bool isNewRecord = !PurchaseOrderId.HasValue;
            
            if (PurchaseOrderId.HasValue)
            {
                result = await PurchaseOrderService.UpdateAsync(purchaseOrder);
            }
            else
            {
                //  確保新增模式下 Id 為 0（避免 IDENTITY_INSERT 錯誤）
                purchaseOrder.Id = 0;
                result = await PurchaseOrderService.CreateAsync(purchaseOrder);
            }

            if (!result.IsSuccess || result.Data == null)
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "儲存採購單失敗");
                return false;
            }

            // 關鍵修復：如果是新增模式，更新實體的 ID 和參數
            // 確保 GenericEditModalComponent 能正確偵測到從新增轉為編輯模式
            if (isNewRecord && result.Data.Id > 0)
            {
                //  修復1：更新傳入的實體物件 ID（讓 GenericEditModalComponent 能偵測到）
                purchaseOrder.Id = result.Data.Id;
                
                //  修復2：更新組件參數（用於後續判斷模式）
                PurchaseOrderId = result.Data.Id;
            }

            // 儲存明細
            await SavePurchaseOrderDetails(result.Data.Id);

            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SavePurchaseOrderWithDetails), GetType(), 
                additionalData: "儲存採購單和明細失敗");
            await NotificationService.ShowErrorAsync($"儲存時發生錯誤：{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// 儲存採購單明細
    /// </summary>
    private async Task SavePurchaseOrderDetails(int purchaseOrderId)
    {
        try
        {
            // 設定主檔ID
            foreach (var detail in purchaseOrderDetails)
            {
                detail.PurchaseOrderId = purchaseOrderId;
                if (detail.Id == 0)
                {
                    detail.Status = EntityStatus.Active;
                    detail.CreatedAt = DateTime.Now;
                }
                else
                {
                    detail.UpdatedAt = DateTime.Now;
                }
            }

            // 先獲取現有的明細
            var existingDetails = await PurchaseOrderService.GetOrderDetailsAsync(purchaseOrderId);
            
            // 處理新增和更新的明細
            foreach (var detail in purchaseOrderDetails.Where(d => d.ProductId > 0))
            {
                if (detail.Id == 0)
                {
                    // 新增明細
                    await PurchaseOrderService.AddOrderDetailAsync(detail);
                }
                else
                {
                    // 更新明細
                    await PurchaseOrderService.UpdateOrderDetailAsync(detail);
                }
            }

            // 處理刪除的明細（現有的但不在當前列表中的）
            var currentDetailIds = purchaseOrderDetails.Where(d => d.Id > 0).Select(d => d.Id).ToList();
            var detailsToDelete = existingDetails.Where(e => !currentDetailIds.Contains(e.Id)).ToList();
            
            foreach (var detailToDelete in detailsToDelete)
            {
                await PurchaseOrderService.DeleteOrderDetailAsync(detailToDelete.Id);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(SavePurchaseOrderDetails), GetType(), 
                additionalData: $"儲存採購單明細失敗 - OrderId: {purchaseOrderId}");
            throw; // 重新拋出例外，讓上層處理
        }
    }
    
    // ===== 審核相關方法 =====
    
    /// <summary>
    /// 判斷是否應該顯示審核區域
    /// </summary>
    private bool ShouldShowApprovalSection()
    {
        // 新邏輯：只有在啟用審核 + 編輯現有單據時才顯示
        return isApprovalEnabled && 
               PurchaseOrderId.HasValue && 
               PurchaseOrderId.Value > 0;
    }
    
    /// <summary>
    /// 處理採購單審核通過
    /// </summary>
    private async Task<bool> HandlePurchaseOrderApprove()
    {
        try
        {
            if (!PurchaseOrderId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法審核：採購單ID不存在");
                return false;
            }
            
            // 確認對話框
            var confirmed = await NotificationService.ShowConfirmAsync(
                "確定要審核通過此採購單嗎？系統將先儲存當前資料，然後進行審核。審核通過後將無法再修改。", 
                "審核確認");
            
            if (!confirmed)
                return false;
            
            // **方案一實施：審核前先自動儲存**
            if (editModalComponent?.Entity != null)
            {
                // 暫時允許儲存（即使已核准狀態也要能儲存，因為可能有未儲存的變更）
                var saveResult = await SavePurchaseOrderWithDetails(editModalComponent.Entity, isPreApprovalSave: true);
                if (!saveResult)
                {
                    await NotificationService.ShowErrorAsync("儲存失敗，無法進行審核");
                    return false;
                }                
            }
            
            // 呼叫服務進行審核
            var currentUserId = await CurrentUserHelper.GetCurrentEmployeeIdAsync(AuthenticationStateProvider);
            if (!currentUserId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法取得當前使用者資訊");
                return false;
            }
            
            var result = await PurchaseOrderService.ApproveOrderAsync(PurchaseOrderId.Value, currentUserId.Value);
            
            if (result.IsSuccess)
            {
                return true;
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "審核通過失敗");
                return false;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePurchaseOrderApprove), GetType(), 
                additionalData: $"採購單審核通過失敗 - OrderId: {PurchaseOrderId}");
            await NotificationService.ShowErrorAsync($"審核通過時發生錯誤：{ex.Message}");
            return false;
        }
    }
    
    /// <summary>
    /// 處理採購單審核駁回（帶駁回原因）
    /// </summary>
    private async Task<bool> HandlePurchaseOrderRejectWithReason(string rejectReason)
    {
        try
        {
            if (!PurchaseOrderId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法審核：採購單ID不存在");
                return false;
            }
            
            // 駁回原因已從 Modal 中獲得，不需要再次確認
            
            // 取得當前使用者ID
            var currentUserId = await CurrentUserHelper.GetCurrentEmployeeIdAsync(AuthenticationStateProvider);
            if (!currentUserId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法取得當前使用者資訊");
                return false;
            }
            
            // 呼叫服務進行駁回
            var result = await PurchaseOrderService.RejectOrderAsync(PurchaseOrderId.Value, currentUserId.Value, rejectReason);
            
            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync("採購單已駁回");
                // 重新載入資料以更新界面
                if (editModalComponent != null)
                {
                    await editModalComponent.RefreshEntityAsync();
                }
                return true;
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage ?? "駁回失敗");
                return false;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePurchaseOrderRejectWithReason), GetType(), 
                additionalData: $"採購單審核駁回失敗 - OrderId: {PurchaseOrderId}");
            await NotificationService.ShowErrorAsync($"審核駁回時發生錯誤：{ex.Message}");
            return false;
        }
    }
    
    /// <summary>
    /// 取得警告訊息（顯示在表單欄位上方）- 作為屬性以確保正確的渲染時機
    /// 當採購單已審核通過或明細有進貨記錄時，顯示鎖定警告訊息
    /// </summary>
    private RenderFragment? GetWarningMessage() => __builder =>
    {
        @* 審核通過的訊息 *@
        <GenericLockedFieldMessage IsVisible="@(isApprovalEnabled && editModalComponent?.Entity?.IsApproved == true)"
                                  Message="@EditModalMessages.PurchaseOrderApprovedWarning" />

        @* 明細有其他動作的訊息 *@
        <GenericLockedFieldMessage IsVisible="@hasUndeletableDetails"
                                  Message="@EditModalMessages.UndeletableDetailsWarning" />
    };
    
    /// <summary>
    /// 取得自訂操作按鈕（顯示在 Modal 頂部左側）
    /// </summary>
    private RenderFragment? GetCustomActionButtons() => __builder =>
    {
        @* 轉進貨單按鈕 - 新增模式需先儲存，編輯模式直接可用 *@
        <GenericButtonComponent Text="轉進貨" 
                              Variant="ButtonVariant.Green" 
                              OnClick="HandleCreateReceivingFromOrder" />
        
        @* 複製訊息按鈕 - 使用按鈕群組包含設定圖示 *@
        <div class="btn-group me-2" role="group">
            <GenericButtonComponent Text="複製訊息" 
                                  Variant="ButtonVariant.Blue" 
                                  IsDisabled="@(!canCopyMessage)"
                                  OnClick="HandleCopyMessage" />
            <button type="button" 
                    class="btn btn-outline-secondary btn-sm" 
                    title="訊息範本設定"
                    @onclick="HandleOpenTemplateSettings">
                <i class="bi bi-gear"></i>
            </button>
        </div>
    };
    
    // ===== 相關單據開啟處理方法 =====
    
    /// <summary>
    /// 處理開啟相關單據的事件
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            switch (args.type)
            {
                case RelatedDocumentType.ReceivingDocument:
                    // 開啟進貨單 Modal
                    selectedPurchaseReceivingId = args.id;
                    showPurchaseReceivingModal = true;
                    StateHasChanged();
                    break;
                    
                default:
                    await NotificationService.ShowWarningAsync($"不支援的單據類型：{args.type}");
                    break;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleOpenRelatedDocument), GetType(), 
                additionalData: $"開啟相關單據失敗 - Type: {args.type}, Id: {args.id}");
            await NotificationService.ShowErrorAsync("開啟單據時發生錯誤");
        }
    }
    
    /// <summary>
    /// 處理進貨單儲存後的事件
    /// 使用 ChildDocumentRefreshHelper 統一處理刷新邏輯
    /// </summary>
    private async Task HandlePurchaseReceivingSaved(PurchaseReceiving savedReceiving)
    {
        try
        {
            await ChildDocumentRefreshHelper.HandleChildDocumentSavedAsync(
                closeModal: () =>
                {
                    showPurchaseReceivingModal = false;
                    selectedPurchaseReceivingId = null;
                },
                reloadDetails: async () =>
                {
                    if (PurchaseOrderId.HasValue)
                    {
                        await LoadPurchaseOrderDetails(PurchaseOrderId.Value);
                    }
                },
                detailManager: purchaseOrderDetailManager,
                notificationMessage: null, // 稍後手動顯示通知
                stateHasChanged: StateHasChanged,
                invokeAsync: InvokeAsync,
                additionalActions: () => Task.CompletedTask
            );
            
            // 顯示成功訊息
            await NotificationService.ShowSuccessAsync($"進貨單 {savedReceiving.Code} 已更新，採購明細已刷新");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePurchaseReceivingSaved), GetType(), 
                additionalData: $"處理進貨單儲存事件失敗 - ReceivingId: {savedReceiving?.Id}");
        }
    }
    
    /// <summary>
    /// 從採購單轉進貨單 - 簡化版本，所有業務驗證交給進貨單 Modal 處理
    /// </summary>
    private async Task HandleCreateReceivingFromOrder()
    {
        try
        {
            // 唯一檢查：確認是否已儲存（新增模式需先儲存，編輯模式直接通過）
            if (!canCreateReceiving)
            {
                await NotificationService.ShowWarningAsync("請先儲存採購單後，才能轉進貨單");
                return;
            }
            
            // 安全檢查：確保 Entity 已載入（canCreateReceiving = true 時理論上一定有值）
            if (editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("採購單資料載入失敗，請重新整理頁面");
                return;
            }
            
            // 檢查是否有廠商資料
            if (editModalComponent.Entity.SupplierId <= 0)
            {
                await NotificationService.ShowWarningAsync("採購單缺少廠商資訊，無法轉進貨單");
                return;
            }
            
            // 檢查是否有明細資料
            if (!purchaseOrderDetails.Any())
            {
                await NotificationService.ShowWarningAsync("採購單沒有明細資料，無法轉進貨單");
                return;
            }
            
            // 檢查是否所有明細都已完成進貨（已進數量 >= 採購數量）
            var hasIncompleteDetails = purchaseOrderDetails.Any(detail => 
                detail.ReceivedQuantity < detail.OrderQuantity
            );
            
            if (!hasIncompleteDetails)
            {
                await NotificationService.ShowWarningAsync("採購單所有明細皆已完成進貨，無需再轉單");
                return;
            }
            
            // 直接開啟進貨單 Modal，使用 Entity.Id 作為採購單 ID（最可靠的來源）
            await purchaseReceivingEditModal!.ShowAddModalWithPrefilledOrder(
                editModalComponent.Entity.SupplierId,
                editModalComponent.Entity.Id  // 使用 Entity.Id 而非 PurchaseOrderId 參數
            );
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCreateReceivingFromOrder), GetType(), 
                additionalData: $"轉進貨單失敗 - OrderId: {editModalComponent?.Entity?.Id}");
            await NotificationService.ShowErrorAsync($"轉進貨單時發生錯誤: {ex.Message}");
        }
    }
    
    // ===== 公開方法（供外部調用） =====
    
    /// <summary>
    /// 開啟新增採購單 Modal 並預填供應商和商品資訊
    /// 採用與「轉單」相同的設計模式：在 LoadPurchaseOrderData 中就設定好資料
    /// </summary>
    public async Task ShowAddModalWithPrefilledData(int supplierId, int productId, decimal? suggestedUnitPrice = null)
    {
        try
        {
            // 重置為新增模式
            PurchaseOrderId = null;
            
            // 設定預填資訊（LoadPurchaseOrderData 會讀取這些值）
            prefilledSupplierId = supplierId;
            prefilledProductId = productId;
            prefilledUnitPrice = suggestedUnitPrice;
            
            // 開啟 Modal（會自動觸發 LoadPurchaseOrderData，並在其中設定供應商和明細）
            if (IsVisibleChanged.HasDelegate)
            {
                await IsVisibleChanged.InvokeAsync(true);
            }

            // 清除預填資訊（避免影響下次開啟）
            prefilledSupplierId = null;
            prefilledProductId = null;
            prefilledUnitPrice = null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledData), GetType(),
                additionalData: $"開啟預填採購單Modal失敗 - SupplierId: {supplierId}, ProductId: {productId}");
            await NotificationService.ShowErrorAsync("開啟採購單時發生錯誤");
        }
    }
    
    // ===== 複製訊息相關方法 =====
    
    /// <summary>
    /// 處理複製訊息按鈕點擊
    /// </summary>
    private async Task HandleCopyMessage()
    {
        try
        {
            if (!canCopyMessage)
            {
                await NotificationService.ShowWarningAsync("請先儲存採購單後，才能複製訊息");
                return;
            }
            
            var entity = editModalComponent?.Entity;
            if (entity == null)
            {
                await NotificationService.ShowWarningAsync("無法取得採購單資料");
                return;
            }
            
            // 取得範本設定
            var template = await TextMessageTemplateService.GetByTemplateCodeAsync("PurchaseOrder");
            if (template == null)
            {
                await NotificationService.ShowWarningAsync("尚未設定採購單訊息範本，請點擊齒輪圖示進行設定");
                return;
            }
            
            // 解析明細格式設定
            DetailFormatConfig formatConfig;
            try
            {
                formatConfig = System.Text.Json.JsonSerializer.Deserialize<DetailFormatConfig>(template.DetailFormatJson) 
                    ?? new DetailFormatConfig();
            }
            catch
            {
                formatConfig = new DetailFormatConfig();
            }
            
            // 取得供應商名稱
            var supplierName = availableSuppliers.FirstOrDefault(s => s.Id == entity.SupplierId)?.CompanyName ?? "";
            
            // 取得公司名稱
            var companyName = availableCompanies.FirstOrDefault(c => c.Id == entity.CompanyId)?.CompanyName ?? "";
            
            // 建立變數字典
            var variables = TextTemplateHelper.CreateVariables(
                supplierName: supplierName,
                customerName: null,
                orderCode: entity.Code,
                orderDate: entity.OrderDate,
                companyName: companyName
            );
            
            // 替換問候語中的變數
            var header = TextTemplateHelper.ReplaceVariables(template.HeaderText, variables);
            
            // 格式化明細
            var details = TextTemplateHelper.FormatDetailLines(
                purchaseOrderDetails,
                formatConfig,
                (detail, index, config) => TextTemplateHelper.FormatDetailLine(
                    detail.Product?.Code,
                    detail.Product?.Name,
                    detail.OrderQuantity,
                    detail.Product?.Unit?.Name,
                    detail.UnitPrice,
                    detail.SubtotalAmount,
                    null, // PurchaseOrderDetail 沒有 Remark 欄位
                    index,
                    config
                )
            );
            
            // 替換結語中的變數
            var footer = TextTemplateHelper.ReplaceVariables(template.FooterText, variables);
            
            // 組合完整訊息
            var fullMessage = TextTemplateHelper.BuildFullMessage(header, details, footer);
            
            // 複製到剪貼簿
            await NotificationService.CopyToClipboardAsync(fullMessage, showSuccessMessage: true);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCopyMessage), GetType(),
                additionalData: $"複製訊息失敗 - OrderId: {editModalComponent?.Entity?.Id}");
            await NotificationService.ShowErrorAsync($"複製訊息時發生錯誤：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 處理開啟範本設定
    /// </summary>
    private async Task HandleOpenTemplateSettings()
    {
        try
        {
            // 查詢現有的 PurchaseOrder 範本
            var template = await TextMessageTemplateService.GetByTemplateCodeAsync("PurchaseOrder");
            currentTemplateId = template?.Id;
            showTemplateSettingModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleOpenTemplateSettings), GetType(),
                additionalData: "開啟範本設定失敗");
            await NotificationService.ShowErrorAsync($"開啟設定時發生錯誤：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 處理範本儲存完成
    /// </summary>
    private async Task HandleTemplateSaved(TextMessageTemplate savedTemplate)
    {
        try
        {
            showTemplateSettingModal = false;
            await NotificationService.ShowSuccessAsync("訊息範本設定已儲存");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleTemplateSaved), GetType(),
                additionalData: "處理範本儲存事件失敗");
        }
    }
}
