@* é€²è²¨é€€å‡ºç·¨è¼¯æ¨¡æ…‹çµ„ä»¶ *@
@using Microsoft.AspNetCore.Components.Rendering
@using ERPCore2.Services.Reports
@using ERPCore2.Helpers.EditModal
@inject IPurchaseReturnService PurchaseReturnService
@inject IPurchaseReturnDetailService PurchaseReturnDetailService
@inject ISupplierService SupplierService
@inject IPurchaseReceivingService PurchaseReceivingService
@inject IProductService ProductService
@inject INotificationService NotificationService
@inject ActionButtonHelper ActionButtonHelper
@inject ISystemParameterService SystemParameterService
@inject ISetoffDocumentService SetoffDocumentService
@inject IPurchaseReturnReportService PurchaseReturnReportService
@inject IReportPrintConfigurationService ReportPrintConfigurationService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ERPCore2.Data.Context.AppDbContext DbContext

<GenericEditModalComponent TEntity="PurchaseReturn" 
                          TService="IPurchaseReturnService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@PurchaseReturnId"
                          Service="@PurchaseReturnService"
                          EntityName="é€²è²¨é€€å‡º"
                          EntityNamePlural="é€²è²¨é€€å‡º"
                          ModalTitle="@(PurchaseReturnId.HasValue ? "ç·¨è¼¯é€²è²¨é€€å‡º" : "æ–°å¢é€²è²¨é€€å‡º")"
                          Size="GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@(autoCompleteConfig?.Prefillers)"
                          AutoCompleteCollections="@(autoCompleteConfig?.Collections)"
                          AutoCompleteDisplayProperties="@(autoCompleteConfig?.DisplayProperties)"
                          AutoCompleteValueProperties="@(autoCompleteConfig?.ValueProperties)"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadPurchaseReturnData"
                          AdditionalDataLoader="@LoadAdditionalDataAsync"
                          UseGenericSave="false"
                          CustomValidator="@ValidatePurchaseReturnDetailsAsync"
                          SaveHandler="@SavePurchaseReturnWithDetails"
                          SaveSuccessMessage="@(PurchaseReturnId.HasValue ? "é€²è²¨é€€å‡ºæ›´æ–°æˆåŠŸ" : "é€²è²¨é€€å‡ºæ–°å¢æˆåŠŸ")"
                          SaveFailureMessage="é€²è²¨é€€å‡ºå„²å­˜å¤±æ•—"
                          RequiredPermission="PurchaseReturn.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          GetStatusMessage="@GetStatusMessage"
                          FormHeaderContent="@GetWarningMessage()"
                          CustomModules="@GetCustomModules()"
                          ShowPrintButton="true"
                          OnPrint="@HandlePrint"
                          OnEntityLoaded="@HandleEntityLoaded" />

@* å» å•†ç·¨è¼¯ Modal *@
<SupplierEditModalComponent @ref="supplierEditModal"
                           IsVisible="@supplierModalManager.IsModalVisible"
                           IsVisibleChanged="@supplierModalManager.HandleModalVisibilityChangedAsync"
                           SupplierId="@supplierModalManager.SelectedEntityId"
                           PrefilledValues="@supplierModalManager.PrefilledValues"
                           OnSupplierSaved="@OnSupplierSavedWrapper"
                           OnCancel="@supplierModalManager.HandleModalCancelAsync" />

@* æ²–æ¬¾å–®ç·¨è¼¯ Modal *@
<SetoffDocumentEditModalComponent @ref="setoffDocumentEditModal"
                                 IsVisible="@showSetoffDocumentModal"
                                 IsVisibleChanged="@((bool visible) => showSetoffDocumentModal = visible)"
                                 SetoffDocumentId="@selectedSetoffDocumentId"
                                 OnSetoffDocumentSaved="@HandleSetoffDocumentSaved"
                                 OnCancel="@(() => showSetoffDocumentModal = false)" />

@code {
    // åƒæ•¸
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? PurchaseReturnId { get; set; }
    [Parameter] public EventCallback<PurchaseReturn> OnPurchaseReturnSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    
    // ===== é å¡«åƒæ•¸ï¼ˆç”¨æ–¼å¾é€²è²¨å–®è½‰å–®ï¼‰ =====
    [Parameter] public int? PrefilledSupplierId { get; set; }
    [Parameter] public int? PrefilledPurchaseReceivingId { get; set; }

    // çµ„ä»¶åƒè€ƒ
    private GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>? editModalComponent;

    // è¡¨å–®æ¬„ä½å’Œå€å¡Š
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();

    // ç›¸é—œè³‡æ–™
    private List<Supplier> suppliers = new();
    private List<PurchaseReceiving> purchaseReceivings = new();
    private List<Product> products = new();
    
    // ä¸‹æ‹‰é¸å–®é¸é …
    private List<SelectOption> taxCalculationMethodOptions = new();
    
    // AutoComplete é…ç½®
    private AutoCompleteConfig? autoCompleteConfig;
    
    // ===== ç¯©é¸ç‹€æ…‹ =====
    private int? filterProductId = null;
    private int? filterPurchaseReceivingId = null;
    
    // ===== é€€è²¨æ˜ç´° =====
    private List<PurchaseReturnDetail> purchaseReturnDetails = new();
    private PurchaseReturnTable? purchaseReturnDetailManager;
    
    /// <summary>
    /// è™•ç†å¯¦é«”è¼‰å…¥å®Œæˆäº‹ä»¶ï¼ˆç”± GenericEditModalComponent çš„å°èˆªè§¸ç™¼ï¼‰
    /// ç•¶ä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼Œé‡æ–°è¼‰å…¥å°æ‡‰çš„æ˜ç´°è³‡æ–™
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            // 1. å¾ Service ç›´æ¥è¼‰å…¥å®Œæ•´å¯¦é«”ï¼ˆå«æ˜ç´°ï¼‰
            var purchaseReturn = await PurchaseReturnService.GetWithDetailsAsync(loadedEntityId);
            if (purchaseReturn?.PurchaseReturnDetails != null)
            {
                purchaseReturnDetails = purchaseReturn.PurchaseReturnDetails.ToList();
            }
            else
            {
                purchaseReturnDetails = new List<PurchaseReturnDetail>();
            }
            
            // ğŸ”‘ é—œéµä¿®æ­£ï¼šç«‹å³è§¸ç™¼ UI æ›´æ–°ï¼Œç¢ºä¿ Table å…ƒä»¶æ”¶åˆ°æ–°çš„ ExistingReturnDetails åƒæ•¸
            // é€™æ¨£ RefreshDetailsAsync() æ‰èƒ½è®€å–åˆ°æ­£ç¢ºçš„æ˜ç´°è³‡æ–™
            StateHasChanged();
            
            // 2. è¼‰å…¥æ˜ç´°ç›¸é—œè³‡æ–™ï¼ˆæ²–æ¬¾è¨˜éŒ„ï¼‰ä¸¦æª¢æŸ¥ä¸å¯åˆªé™¤ç‹€æ…‹
            await LoadDetailRelatedDataAsync();
            
            // 3. è§¸ç™¼ Table å…ƒä»¶åˆ·æ–°ï¼ˆæ­¤æ™‚ ExistingReturnDetails å·²ç¶“æ˜¯æ–°çš„è³‡æ–™ï¼‰
            if (purchaseReturnDetailManager != null)
            {
                await purchaseReturnDetailManager.RefreshDetailsAsync();
            }
            
            // 4. æœ€å¾Œå†æ¬¡æ›´æ–° UIï¼ˆç¢ºä¿æ‰€æœ‰è®Šæ›´éƒ½åæ˜ åœ¨ç•«é¢ä¸Šï¼‰
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleEntityLoaded), GetType(), 
                additionalData: $"è™•ç†å¯¦é«”è¼‰å…¥äº‹ä»¶å¤±æ•— - EntityId: {loadedEntityId}");
            await NotificationService.ShowErrorAsync("è¼‰å…¥æ˜ç´°è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    // Modal ç®¡ç†å™¨
    private SupplierEditModalComponent? supplierEditModal;
    private RelatedEntityModalManager<Supplier> supplierModalManager = default!;
    private ModalManagerCollection modalManagers = default!;
    
    // ===== ç›¸é—œå–®æ“š Modal =====
    private SetoffDocumentEditModalComponent? setoffDocumentEditModal;
    private bool showSetoffDocumentModal = false;
    private int? selectedSetoffDocumentId = null;
    
    // ===== ç³»çµ±åƒæ•¸ - ç¨…ç‡å¿«å–ï¼ˆé¿å…é‡è¤‡æŸ¥è©¢è³‡æ–™åº«ï¼‰ =====
    private decimal currentTaxRate = 5.0m; // é è¨­ 5%ï¼Œå¯¦éš›å€¼æœƒåœ¨åˆå§‹åŒ–æ™‚å¾è³‡æ–™åº«è¼‰å…¥

    // ===== é–å®šç‹€æ…‹ =====
    private bool hasUndeletableDetails = false;
    private bool isDetailDataReady = false;
    
    // ===== æ˜ç´°è¼‰å…¥ç‹€æ…‹ =====
    private bool shouldAutoLoadReturnable = false;  // æ¨™è¨˜æ˜¯å¦éœ€è¦è‡ªå‹•è¼‰å…¥å¯é€€å›ç”¢å“

    // ===== ç”Ÿå‘½é€±æœŸ =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // ä½¿ç”¨ ModalManagerInitHelper åˆå§‹åŒ– Modal ç®¡ç†å™¨
            modalManagers = ModalManagerInitHelper.CreateBuilder<PurchaseReturn, IPurchaseReturnService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Supplier>(nameof(PurchaseReturn.SupplierId), "å» å•†")
                .Build();
            supplierModalManager = modalManagers.Get<Supplier>(nameof(PurchaseReturn.SupplierId));
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"åˆå§‹åŒ–é€²è²¨é€€å‡ºç·¨è¼¯çµ„ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            if (IsVisible)
            {
                await LoadAdditionalDataAsync();
                await InitializeFormFieldsAsync();
                
                // å¦‚æœæœ‰é å¡«å» å•†ï¼Œåœ¨è¡¨å–®æ¬„ä½åˆå§‹åŒ–å¾Œå†æ¬¡æ›´æ–°é¸é …
                if (PrefilledSupplierId.HasValue && PrefilledSupplierId.Value > 0)
                {
                    await UpdateFilterProductOptions(PrefilledSupplierId.Value);
                    await UpdateFilterPurchaseReceivingOptions(PrefilledSupplierId.Value);
                    StateHasChanged(); // å¼·åˆ¶æ›´æ–° UI
                }
            }
            else
            {
                //  Modal é—œé–‰æ™‚é‡ç½®è‡ªå‹•è¼‰å…¥ç›¸é—œæ¨™è¨˜
                shouldAutoLoadReturnable = false;
            }
            
            await base.OnParametersSetAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥é€²è²¨é€€å‡ºè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    // ===== äº‹ä»¶è™•ç† =====
    private async Task HandleSaveSuccess()
    {
        try
        {
            // å¦‚æœçˆ¶çµ„ä»¶éœ€è¦çŸ¥é“é€²è²¨é€€å‡ºå·²å„²å­˜
            if (OnPurchaseReturnSaved.HasDelegate && editModalComponent?.Entity != null)
            {
                await OnPurchaseReturnSaved.InvokeAsync(editModalComponent.Entity);
            }
            // CloseModal å·²ç”± GenericEditModalComponent çµ±ä¸€æ§åˆ¶
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†å„²å­˜æˆåŠŸäº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    private async Task HandleCancel()
    {
        try
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }
            await CloseModal();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†å–æ¶ˆäº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    private async Task HandlePrint()
    {
        try
        {
            // ä½¿ç”¨é€šç”¨ Helper é€²è¡Œå®Œæ•´é©—è­‰ï¼ˆå¯¦é«”ã€IDã€å¿…è¦è³‡æ–™ï¼‰
            var (isValid, errorMessage) = ReportPrintHelper.ValidateForPrint(
                editModalComponent?.Entity,
                PurchaseReturnId,
                isApproved: false, // é€²è²¨é€€å‡ºå–®ä¸éœ€è¦æ ¸å‡†å³å¯åˆ—å°
                entityName: "é€²è²¨é€€å‡ºå–®",
                requireApproval: false
            );
            
            if (!isValid)
            {
                await NotificationService.ShowWarningAsync(errorMessage);
                return;
            }
            
            // ç›´æ¥åŸ·è¡Œåˆ—å°ï¼Œä½¿ç”¨é è¨­è¨­å®š
            await HandleDirectPrint(null);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"åˆ—å°é€²è²¨é€€å‡ºå–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// ç›´æ¥åŸ·è¡Œåˆ—å° - å¯ä»¥ä½¿ç”¨æŒ‡å®šçš„åˆ—å°é…ç½®æˆ–é è¨­é…ç½®
    /// </summary>
    private async Task HandleDirectPrint(Data.Entities.ReportPrintConfiguration? printConfig)
    {
        try
        {
            if (!PurchaseReturnId.HasValue)
            {
                await NotificationService.ShowErrorAsync("ç„¡æ³•åˆ—å°ï¼šé€²è²¨é€€å‡ºå–® ID ä¸å­˜åœ¨");
                return;
            }

            // é©—è­‰åˆ—å°é…ç½®
            var (isValid, errorMessage) = ReportPrintHelper.ValidateConfiguration(printConfig);
            if (!isValid)
            {
                await NotificationService.ShowWarningAsync(errorMessage);
                return;
            }

            // ä½¿ç”¨é€šç”¨ Helper å»ºç«‹åˆ—å° URLï¼ˆæ–°ç‰ˆè·¯ç”±ï¼‰
            var printUrl = ReportPrintHelper.BuildPrintUrl(
                baseUrl: NavigationManager.BaseUri,
                reportType: "purchase-report/return",
                documentId: PurchaseReturnId.Value,
                configuration: printConfig,
                autoprint: true
            );

            // ä½¿ç”¨é€šç”¨ Helper åŸ·è¡Œåˆ—å°ï¼ˆéš±è— iframe æ–¹å¼ï¼‰
            var success = await ReportPrintHelper.ExecutePrintWithHiddenIframeAsync(
                printUrl,
                JSRuntime
            );
            
            if (success)
            {
                await NotificationService.ShowSuccessAsync("åˆ—å°æŒ‡ä»¤å·²ç™¼é€");
            }
            else
            {
                await NotificationService.ShowErrorAsync("åˆ—å°åŸ·è¡Œå¤±æ•—");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDirectPrint), GetType(), 
                additionalData: $"é€²è²¨é€€å‡ºå–®ç›´æ¥åˆ—å°å¤±æ•— - ID: {PurchaseReturnId}, Config: {printConfig?.ReportName}");
            await NotificationService.ShowErrorAsync("åˆ—å°åŸ·è¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    private async Task CloseModal()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }

    // ===== è³‡æ–™è¼‰å…¥ =====
    private async Task<PurchaseReturn?> LoadPurchaseReturnData()
    {
        try
        {
            isDetailDataReady = false;
            hasUndeletableDetails = false;
            
            if (!PurchaseReturnId.HasValue)
            {
                purchaseReturnDetails = new List<PurchaseReturnDetail>(); // æ¸…ç©ºæ˜ç´°
                isDetailDataReady = true;
                
                // è¨­å®šç¯©é¸åƒæ•¸ï¼ˆç”¨æ–¼è‡ªå‹•è¼‰å…¥ï¼‰
                if (PrefilledPurchaseReceivingId.HasValue && PrefilledPurchaseReceivingId.Value > 0)
                {
                    filterPurchaseReceivingId = PrefilledPurchaseReceivingId.Value;
                }
                
                try
                {
                    var number = await EntityCodeGenerationHelper.GenerateForEntity<PurchaseReturn, IPurchaseReturnService>(PurchaseReturnService, DbContext);
                    
                    var newReturn = new PurchaseReturn
                    {
                        Code = number,
                        ReturnDate = DateTime.Today,
                        Status = EntityStatus.Active,
                        SupplierId = PrefilledSupplierId ?? 0,
                        PurchaseReceivingId = PrefilledPurchaseReceivingId // ç›´æ¥è¨­å®šå¯¦é«”å±¬æ€§
                    };
                    
                    // ğŸ”‘ å¦‚æœæ˜¯å¾é€²è²¨å–®è½‰å–®ï¼Œç¹¼æ‰¿é€²è²¨å–®çš„ç¨…ç‡ç®—æ³•
                    if (PrefilledPurchaseReceivingId.HasValue && PrefilledPurchaseReceivingId.Value > 0)
                    {
                        var purchaseReceiving = await PurchaseReceivingService.GetByIdAsync(PrefilledPurchaseReceivingId.Value);
                        if (purchaseReceiving != null)
                        {
                            newReturn.TaxCalculationMethod = purchaseReceiving.TaxCalculationMethod;
                        }
                    }
                    
                    return newReturn;
                }
                catch (Exception)
                {
                    throw;
                }
            }
            else
            {                
                if (PurchaseReturnService == null)
                {
                    isDetailDataReady = true;
                    return null;
                }
                
                var purchaseReturn = await PurchaseReturnService.GetWithDetailsAsync(PurchaseReturnId.Value);
                
                if (purchaseReturn != null)
                {
                    // æª¢æŸ¥æ˜ç´°
                    if (purchaseReturn.PurchaseReturnDetails == null)
                    {
                        purchaseReturnDetails = new List<PurchaseReturnDetail>();
                    }
                    else
                    {
                        // ä½¿ç”¨ç¡¬åˆªé™¤å¾Œä¸éœ€è¦ç¯©é¸ IsDeletedï¼Œå› ç‚ºå·²åˆªé™¤çš„è¨˜éŒ„ä¸æœƒå­˜åœ¨æ–¼è³‡æ–™åº«ä¸­
                        purchaseReturnDetails = purchaseReturn.PurchaseReturnDetails.ToList();
                    }
                    
                    //  é—œéµï¼šè¼‰å…¥æ˜ç´°ç›¸é—œè³‡æ–™ï¼ˆæ²–æ¬¾è¨˜éŒ„ï¼‰
                    await LoadDetailRelatedDataAsync();
                    isDetailDataReady = true;
                    StateHasChanged();

                    // æª¢æŸ¥ä¸¦è¨­å®šé è¨­å€¼
                    if (purchaseReturn.ReturnDate == default(DateTime))
                    {
                        purchaseReturn.ReturnDate = DateTime.Today;
                    }
                    
                    if (purchaseReturn.Status == default(EntityStatus))
                    {
                        purchaseReturn.Status = EntityStatus.Active;
                    }
                    
                }
                else
                {
                    purchaseReturnDetails = new List<PurchaseReturnDetail>();
                    isDetailDataReady = true;
                }
                
                return purchaseReturn;
            }
        }
        catch (Exception)
        {            
            // ç¢ºä¿å³ä½¿ç™¼ç”ŸéŒ¯èª¤ä¹Ÿè¦åˆå§‹åŒ–æ˜ç´°åˆ—è¡¨
            purchaseReturnDetails = new List<PurchaseReturnDetail>();
            isDetailDataReady = true; // éŒ¯èª¤ä¹Ÿè¦å…è¨±æ¸²æŸ“
            return null;
        }
    }

    /// <summary>
    /// è¼‰å…¥æ˜ç´°ç›¸é—œè³‡æ–™ï¼ˆæ²–æ¬¾è¨˜éŒ„ï¼‰- ç”¨æ–¼åˆ¤æ–·æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
    /// å¿…é ˆåœ¨ DataLoader ä¸­åŒæ­¥åŸ·è¡Œï¼Œç¢ºä¿ç‹€æ…‹è¨Šæ¯æ­£ç¢ºé¡¯ç¤º
    /// </summary>
    private async Task LoadDetailRelatedDataAsync()
    {
        try
        {
            if (!purchaseReturnDetails.Any())
            {
                hasUndeletableDetails = false;
                return;
            }

            bool hasUndeletable = false;
            
            foreach (var detail in purchaseReturnDetails.Where(d => d.Id > 0))
            {
                // æª¢æŸ¥æ²–æ¬¾è¨˜éŒ„
                if (detail.TotalReceivedAmount > 0)
                {
                    hasUndeletable = true;
                    break;
                }
            }
            
            hasUndeletableDetails = hasUndeletable;
            
            if (hasUndeletableDetails)
            {
                UpdateFieldsReadOnlyState();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDetailRelatedDataAsync), GetType());
            hasUndeletableDetails = false;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            
            await Task.WhenAll(
                LoadSuppliersAsync(),
                LoadPurchaseReceivingsAsync(),
                LoadProductsAsync()
            );
            
            // ä¸€æ¬¡æ€§è¼‰å…¥ç³»çµ±ç¨…ç‡ï¼ˆé¿å…æ¯æ¬¡è¨ˆç®—éƒ½æŸ¥è©¢è³‡æ–™åº«ï¼‰
            currentTaxRate = await TaxCalculationHelper.LoadTaxRateAsync(SystemParameterService);
            
            // åˆå§‹åŒ–ç¨…ç‡ç®—æ³•é¸é …
            taxCalculationMethodOptions = new List<SelectOption>
            {
                new SelectOption { Text = "å¤–åŠ ç¨…", Value = ((int)TaxCalculationMethod.TaxExclusive).ToString() },
                new SelectOption { Text = "å…§å«ç¨…", Value = ((int)TaxCalculationMethod.TaxInclusive).ToString() },
                new SelectOption { Text = "ä¸å«ç¨…", Value = ((int)TaxCalculationMethod.NoTax).ToString() }
            };
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥é™„åŠ è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            taxCalculationMethodOptions = new List<SelectOption>();
        }
    }

    private async Task LoadSuppliersAsync()
    {
        try
        {
            suppliers = await SupplierService.GetAllAsync();
        }
        catch (Exception)
        {
            suppliers = new List<Supplier>();
        }
    }

    private async Task LoadPurchaseReceivingsAsync()
    {
        try
        {
            purchaseReceivings = await PurchaseReceivingService.GetAllAsync();
        }
        catch (Exception)
        {
            purchaseReceivings = new List<PurchaseReceiving>();
        }
    }

    private async Task LoadProductsAsync()
    {
        try
        {
            products = await ProductService.GetAllAsync();
            
            // é…ç½® AutoComplete
            autoCompleteConfig = new AutoCompleteConfigBuilder<PurchaseReturn>()
                .AddField(nameof(PurchaseReturn.SupplierId), "CompanyName", suppliers)
                .AddFieldWithMultipleSearchProperties(
                    "FilterProductId", 
                    "Name",  // ä¸»è¦é¡¯ç¤ºæ¬„ä½
                    products,
                    new[] { "Code", "Name" })  // å¯æœå°‹çš„æ¬„ä½
                .AddField(nameof(PurchaseReturn.PurchaseReceivingId), "Code", purchaseReceivings)
                .Build();
        }
        catch (Exception)
        {
            products = new List<Product>();
        }
    }

    // ===== è¡¨å–®è¨­å®š =====
    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(PurchaseReturn.Code),
                    Label = "é€€å›å–®è™Ÿ",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥é€€å›å–®è™Ÿ",
                    IsRequired = true,
                    MaxLength = 30,
                    HelpText = "ç³»çµ±è‡ªå‹•ç”Ÿæˆçš„å”¯ä¸€é€€å›å–®è™Ÿï¼Œä¹Ÿå¯æ‰‹å‹•ä¿®æ”¹",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.SupplierId),
                    Label = "ç¯©é¸å» å•†",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡å» å•†",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "è¼¸å…¥å» å•†åç¨±é€²è¡Œæœå°‹ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                    ActionButtons = await GetSupplierActionButtonsAsync(),
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = "FilterProductId", // ç¯©é¸ç”¨çš„è™›æ“¬æ¬„ä½
                    Label = "ç¯©é¸ç”¢å“",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡ç”¢å“",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "é¸æ“‡ç‰¹å®šç”¢å“é€²è¡Œç¯©é¸ï¼Œæˆ–ç•™ç©ºé¡¯ç¤ºæ‰€æœ‰ç”¢å“",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.PurchaseReceivingId), // ä½¿ç”¨å¯¦é«”å±¬æ€§
                    Label = "ç¯©é¸é€²è²¨å–®",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡é€²è²¨å–®",
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "é¸æ“‡ç‰¹å®šé€²è²¨å–®é€²è¡Œç¯©é¸ï¼Œæˆ–ç•™ç©ºé¡¯ç¤ºæ‰€æœ‰é€²è²¨å–®",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.ReturnDate),
                    Label = "é€€å›æ—¥æœŸ",
                    FieldType = FormFieldType.Date,
                    HelpText = "è«‹é¸æ“‡é€€å›æ—¥æœŸ",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.TaxCalculationMethod),
                    Label = "ç¨…åˆ¥",
                    FieldType = FormFieldType.Select,
                    IsRequired = true,
                    Options = taxCalculationMethodOptions,
                    HelpText = "é¸æ“‡ç¨…é¡è¨ˆç®—æ–¹å¼ï¼šå¤–åŠ ç¨…ï¼ˆç¨…é¡å¦è¨ˆï¼‰ã€å…§å«ç¨…ï¼ˆç¸½é¡å·²å«ç¨…ï¼‰ã€ä¸å«ç¨…ï¼ˆå…ç¨…ï¼‰",
                    IsReadOnly = hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.TotalReturnAmount),
                    Label = "é‡‘é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "ç³»çµ±è‡ªå‹•è¨ˆç®—çš„é€€å›ç¸½é‡‘é¡"
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.ReturnTaxAmount),
                    Label = "ç¨…é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "ç³»çµ±è‡ªå‹•è¨ˆç®—çš„é€€å›ç¨…é¡"
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.TotalReturnAmountWithTax),
                    Label = "ç¸½é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "ç³»çµ±è‡ªå‹•è¨ˆç®—çš„é€€å›å«ç¨…ç¸½é‡‘é¡"
                },
                FormFieldConfigurationHelper.CreateRemarksField<PurchaseReturn>(
                    readOnly: hasUndeletableDetails // æ ¹æ“šæ˜ç´°ç‹€æ…‹æ±ºå®šæ˜¯å¦é–å®š
                ),
            };

            formSections = FormSectionHelper<PurchaseReturn>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    pr => pr.Code,
                    pr => pr.SupplierId)
                .AddCustomFields(FormSectionNames.BasicInfo, "FilterProductId")
                .AddToSection(FormSectionNames.BasicInfo,
                    pr => pr.PurchaseReceivingId,
                    pr => pr.ReturnDate,
                    pr => pr.TaxCalculationMethod)
                .AddToSection(FormSectionNames.AmountInfoAutoCalculated,
                    pr => pr.TotalReturnAmount,
                    pr => pr.ReturnTaxAmount,
                    pr => pr.TotalReturnAmountWithTax)
                .AddToSection(FormSectionNames.AdditionalInfo,
                    pr => pr.Remarks)
                .Build();
            
            // é—œéµï¼šå¦‚æœå¯¦é«”å·²ç¶“è¼‰å…¥ä¸”æœ‰å» å•†IDï¼Œç«‹å³æ›´æ–°ç”¢å“å’Œé€²è²¨å–®é¸é …
            if (editModalComponent?.Entity?.SupplierId > 0)
            {
                await UpdateFilterProductOptions(editModalComponent.Entity.SupplierId);
                await UpdateFilterPurchaseReceivingOptions(editModalComponent.Entity.SupplierId);
            }
            
        }
        catch (Exception)
        {            
            // ç¢ºä¿å³ä½¿ç™¼ç”ŸéŒ¯èª¤ä¹Ÿæœ‰åŸºæœ¬çš„è¡¨å–®çµæ§‹
            formFields = new List<FormFieldDefinition>();
            formSections = new Dictionary<string, string>();
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        if (formFields == null)
        {
            return new List<FormFieldDefinition>();
        }
        return formFields;
    }

    /// <summary>
    /// è™•ç†æœ‰ä¸å¯åˆªé™¤æ˜ç´°çš„ç‹€æ…‹è®Šæ›´
    /// ç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚(å·²æ²–æ¬¾),é–å®šä¸»æª”çš„æ‰€æœ‰å¯ç·¨è¼¯æ¬„ä½
    /// </summary>
    private async Task HandleHasUndeletableDetailsChanged(bool hasUndeletable)
    {
        try
        {
            hasUndeletableDetails = hasUndeletable;
            
            // æ›´æ–°æ¬„ä½çš„å”¯è®€ç‹€æ…‹
            UpdateFieldsReadOnlyState();
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†æ˜ç´°é–å®šç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// æ ¹æ“š hasUndeletableDetails ç‹€æ…‹æ›´æ–°æ¬„ä½çš„å”¯è®€ç‹€æ…‹
    /// </summary>
    private void UpdateFieldsReadOnlyState()
    {
        // ä½¿ç”¨ FormFieldLockHelper æ‰¹æ¬¡é–å®š/è§£é–æ¬„ä½
        var fieldsToLock = new[]
        {
            nameof(PurchaseReturn.Code),
            "FilterProductId",
            nameof(PurchaseReturn.PurchaseReceivingId),
            nameof(PurchaseReturn.ReturnDate),
            nameof(BaseEntity.Remarks)
        };
        
        // é–å®šæˆ–è§£é–ä¸€èˆ¬æ¬„ä½ï¼ˆä¸éœ€è¦ ActionButtonsï¼‰
        FormFieldLockHelper.LockMultipleFieldsSimple(
            formFields, 
            fieldsToLock, 
            isLocked: hasUndeletableDetails
        );
        
        // ç‰¹æ®Šè™•ç†å» å•†æ¬„ä½ï¼ˆéœ€è¦ ActionButtonsï¼‰
        if (hasUndeletableDetails)
        {
            // é–å®šï¼šç§»é™¤ ActionButtons
            FormFieldLockHelper.LockField(
                formFields,
                nameof(PurchaseReturn.SupplierId),
                isLocked: true
            );
        }
        else
        {
            // è§£é–ï¼šæ¢å¾© ActionButtons
            FormFieldLockHelper.LockField(
                formFields,
                nameof(PurchaseReturn.SupplierId),
                isLocked: false,
                actionButtonsGetter: GetSupplierActionButtonsAsync
            );
        }
    }

    /// <summary>
    /// å–å¾—ç‹€æ…‹è¨Šæ¯ï¼ˆé ‚éƒ¨å¾½ç« ï¼‰
    /// ç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚ï¼Œé¡¯ç¤ºé–å®šæç¤º
    /// </summary>
    private async Task<(string Message, GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.BadgeVariant Variant, string IconClass)?> 
        GetStatusMessage()
    {
        try
        {
            if (!isDetailDataReady || editModalComponent?.Entity == null)
                return null;
            
            if (hasUndeletableDetails)
            {
                return (
                    "æ˜ç´°æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œä¸»æª”æ¬„ä½å·²é–å®š",
                    GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.BadgeVariant.Warning,
                    "fas fa-lock"
                );
            }
            
            return null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetStatusMessage), GetType());
            return null;
        }
    }

    /// <summary>
    /// å–å¾—è­¦å‘Šè¨Šæ¯ï¼ˆè¡¨å–®é ‚éƒ¨ï¼‰
    /// ç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚ï¼Œé¡¯ç¤ºè©³ç´°èªªæ˜
    /// </summary>
    private RenderFragment? GetWarningMessage() => __builder =>
    {
        <GenericLockedFieldMessage IsVisible="@(isDetailDataReady && hasUndeletableDetails)"
                                  Message="å› éƒ¨åˆ†æ˜ç´°æœ‰æ²–æ¬¾è¨˜éŒ„ï¼Œç‚ºä¿è­·è³‡æ–™å®Œæ•´æ€§ä¸»æª”æ¬„ä½å·²è¨­å”¯è®€ã€‚"/>
    };

    /// <summary>
    /// å–å¾—ç”¢å“ç¯©é¸é¸é … - æ ¹æ“šé¸æ“‡çš„å» å•†ç¯©é¸
    /// åªé¡¯ç¤ºè©²å» å•†æœ‰å…¥åº«è¨˜éŒ„çš„ç”¢å“ï¼ˆå¾ PurchaseReceivingDetail ä¸­æå–ï¼‰
    /// </summary>
    private async Task<List<SelectOption>> GetFilterProductOptions()
    {
        try
        {
            var options = new List<SelectOption>();
            
            // å¦‚æœæ²’æœ‰é¸æ“‡å» å•†ï¼Œé¡¯ç¤ºå…¨éƒ¨ç”¢å“
            if (editModalComponent?.Entity?.SupplierId == null || editModalComponent.Entity.SupplierId <= 0)
            {
                options.AddRange(products.Select(p => new SelectOption
                {
                    Value = p.Id.ToString(),
                    Text = $"{p.Code} - {p.Name}"
                }));
            }
            else
            {
                // å¦‚æœæœ‰é¸æ“‡å» å•†ï¼Œåªé¡¯ç¤ºè©²å» å•†æœ‰å…¥åº«è¨˜éŒ„çš„ç”¢å“
                // å–å¾—è©²å» å•†çš„æ‰€æœ‰é€²è²¨å–®
                var supplierReceivings = purchaseReceivings
                    .Where(pr => pr.SupplierId == editModalComponent.Entity.SupplierId)
                    .ToList();
                
                // å¾é€²è²¨å–®æ˜ç´°ä¸­æå–å·²å…¥åº«çš„ç”¢å“IDï¼ˆå»é‡ï¼‰
                var productIds = new HashSet<int>();
                foreach (var receiving in supplierReceivings)
                {
                    if (receiving.PurchaseReceivingDetails != null)
                    {
                        foreach (var detail in receiving.PurchaseReceivingDetails)
                        {
                            productIds.Add(detail.ProductId);
                        }
                    }
                }
                
                // æ ¹æ“šç”¢å“IDå¾ products åˆ—è¡¨ä¸­æ‰¾å‡ºå°æ‡‰çš„ç”¢å“
                var supplierProducts = products
                    .Where(p => productIds.Contains(p.Id))
                    .OrderBy(p => p.Code)
                    .ToList();
                
                options.AddRange(supplierProducts.Select(p => new SelectOption
                {
                    Value = p.Id.ToString(),
                    Text = $"{p.Code} - {p.Name}"
                }));
            }
            
            return options;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ç”¢å“é¸é …æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return new List<SelectOption>();
        }
    }

    /// <summary>
    /// å–å¾—é€²è²¨å–®ç¯©é¸é¸é … - æ ¹æ“šé¸æ“‡çš„å» å•†ç¯©é¸
    /// </summary>
    private async Task<List<SelectOption>> GetFilterPurchaseReceivingOptions()
    {
        try
        {
            var options = new List<SelectOption> {};
            
            // å¦‚æœæœ‰é¸æ“‡å» å•†ï¼Œåªé¡¯ç¤ºè©²å» å•†çš„é€²è²¨å–®
            if (editModalComponent?.Entity?.SupplierId > 0)
            {
                var supplierReceivings = purchaseReceivings
                    .Where(pr => pr.SupplierId == editModalComponent.Entity.SupplierId)
                    .ToList();
                    
                options.AddRange(supplierReceivings.Select(pr => new SelectOption
                {
                    Value = pr.Id.ToString(),
                    Text = pr.Code ?? string.Empty
                }));
            }
            
            return options;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥é€²è²¨å–®é¸é …æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return new List<SelectOption> {};
        }
    }

    /// <summary>
    /// æ›´æ–°ç”¢å“ç¯©é¸çš„ AutoComplete è³‡æ–™é›†åˆ - ç•¶å» å•†è®Šæ›´æ™‚èª¿ç”¨
    /// åªé¡¯ç¤ºè©²å» å•†æœ‰å…¥åº«è¨˜éŒ„çš„ç”¢å“ï¼ˆå¾ PurchaseReceivingDetail ä¸­æå–ï¼‰
    /// </summary>
    private async Task UpdateFilterProductOptions(int? supplierId = null)
    {
        try
        {
            if (autoCompleteConfig?.Collections == null)
                return;
            
            List<Product> filteredProducts;
            
            if (supplierId.HasValue && supplierId.Value > 0)
            {
                // å–å¾—è©²å» å•†çš„æ‰€æœ‰é€²è²¨å–®
                var supplierReceivings = purchaseReceivings
                    .Where(pr => pr.SupplierId == supplierId.Value)
                    .ToList();
                
                // å¾é€²è²¨å–®æ˜ç´°ä¸­æå–å·²å…¥åº«çš„ç”¢å“IDï¼ˆå»é‡ï¼‰
                var productIds = new HashSet<int>();
                foreach (var receiving in supplierReceivings)
                {
                    if (receiving.PurchaseReceivingDetails != null)
                    {
                        foreach (var detail in receiving.PurchaseReceivingDetails)
                        {
                            productIds.Add(detail.ProductId);
                        }
                    }
                }
                
                // æ ¹æ“šç”¢å“IDå¾ products åˆ—è¡¨ä¸­æ‰¾å‡ºå°æ‡‰çš„ç”¢å“
                filteredProducts = products
                    .Where(p => productIds.Contains(p.Id))
                    .OrderBy(p => p.Code)
                    .ToList();
            }
            else
            {
                // å¦‚æœæ²’æœ‰é¸æ“‡å» å•†ï¼Œé¡¯ç¤ºå…¨éƒ¨ç”¢å“
                filteredProducts = products;
            }
            
            // æ›´æ–° AutoComplete çš„è³‡æ–™é›†åˆ
            if (autoCompleteConfig.Collections.ContainsKey("FilterProductId"))
            {
                autoCompleteConfig.Collections["FilterProductId"] = filteredProducts;
            }
            
            // æ¸…ç©ºç›®å‰çš„ç”¢å“ç¯©é¸é¸æ“‡
            filterProductId = null;
            
            await Task.CompletedTask;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æ›´æ–°ç”¢å“ç¯©é¸é¸é …æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// æ›´æ–°é€²è²¨å–®ç¯©é¸çš„ AutoComplete è³‡æ–™é›†åˆ - ç•¶å» å•†è®Šæ›´æ™‚èª¿ç”¨
    /// </summary>
    private async Task UpdateFilterPurchaseReceivingOptions(int? supplierId = null)
    {
        try
        {
            if (autoCompleteConfig?.Collections == null)
                return;
            
            List<PurchaseReceiving> filteredReceivings;
            
            if (supplierId.HasValue && supplierId.Value > 0)
            {
                // åªé¡¯ç¤ºè©²å» å•†çš„é€²è²¨å–®
                filteredReceivings = purchaseReceivings
                    .Where(pr => pr.SupplierId == supplierId.Value)
                    .OrderByDescending(pr => pr.ReceiptDate)
                    .ToList();
            }
            else
            {
                // å¦‚æœæ²’æœ‰é¸æ“‡å» å•†ï¼Œé¡¯ç¤ºå…¨éƒ¨é€²è²¨å–®
                filteredReceivings = purchaseReceivings;
            }
            
            // æ›´æ–° AutoComplete çš„è³‡æ–™é›†åˆ
            if (autoCompleteConfig.Collections.ContainsKey(nameof(PurchaseReturn.PurchaseReceivingId)))
            {
                autoCompleteConfig.Collections[nameof(PurchaseReturn.PurchaseReceivingId)] = filteredReceivings;
            }
            
            // åªåœ¨æ²’æœ‰é å¡«å€¼æ™‚æ‰æ¸…ç©ºé¸æ“‡
            if (!PrefilledPurchaseReceivingId.HasValue || PrefilledPurchaseReceivingId.Value <= 0)
            {
                filterPurchaseReceivingId = null;
            }
            
            await Task.CompletedTask;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æ›´æ–°é€²è²¨å–®ç¯©é¸é¸é …æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    // ===== Modal ç®¡ç†å™¨é…ç½®æ–¹æ³• =====
    
    /// <summary>
    /// é…ç½® Modal ç®¡ç†å™¨
    /// </summary>
    private Dictionary<string, object> GetModalManagers()
    {

        return new Dictionary<string, object>
        {
            { nameof(PurchaseReturn.SupplierId), supplierModalManager ?? new object() }
        };
    }
    
    // ===== ActionButton ç”¢ç”Ÿæ–¹æ³• =====
    
    /// <summary>
    /// ç”¢ç”Ÿå» å•†æ“ä½œæŒ‰éˆ• - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetSupplierActionButtonsAsync()
    {
        var buttons = await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            supplierModalManager, 
            nameof(PurchaseReturn.SupplierId)
        );
        
        return buttons;
    }
    
    // ===== Modal äº‹ä»¶åŒ…è£å™¨æ–¹æ³• =====
    
    /// <summary>
    /// åŒ…è£å» å•†å„²å­˜äº‹ä»¶
    /// </summary>
    private async Task OnSupplierSavedWrapper(Supplier savedSupplier)
    {
        await supplierModalManager.HandleEntitySavedAsync(savedSupplier, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// è™•ç†é–‹å•Ÿç›¸é—œå–®æ“šçš„äº‹ä»¶
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            if (args.type == RelatedDocumentType.SetoffDocument)
            {
                // é–‹å•Ÿæ²–æ¬¾å–®
                selectedSetoffDocumentId = args.id;
                showSetoffDocumentModal = true;
                StateHasChanged();
            }
            else
            {
                await NotificationService.ShowWarningAsync("ä¸æ”¯æ´çš„å–®æ“šé¡å‹", "æç¤º");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é–‹å•Ÿå–®æ“šå¤±æ•—ï¼š{ex.Message}");
        }
    }
    
    /// <summary>
    /// è™•ç†æ²–æ¬¾å–®å„²å­˜å¾Œçš„äº‹ä»¶
    /// </summary>
    private async Task HandleSetoffDocumentSaved(SetoffDocument savedDocument)
    {
        try
        {
            showSetoffDocumentModal = false;
            await NotificationService.ShowSuccessAsync("æ²–æ¬¾å–®å·²æ›´æ–°");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†æ²–æ¬¾å–®å„²å­˜äº‹ä»¶å¤±æ•—ï¼š{ex.Message}");
        }
    }
    
    /// <summary>
    /// è™•ç†æ¬„ä½å€¼è®Šæ›´äº‹ä»¶ - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // ç•¶å» å•†è®Šæ›´æ™‚ï¼Œæ›´æ–°ç¯©é¸é¸é …
            if (fieldChange.PropertyName == nameof(PurchaseReturn.SupplierId))
            {
                int? supplierId = null;
                if (fieldChange.Value != null && 
                    int.TryParse(fieldChange.Value.ToString(), out int parsedSupplierId) && 
                    parsedSupplierId > 0)
                {
                    supplierId = parsedSupplierId;
                }
                
                // æ›´æ–°ç”¢å“å’Œé€²è²¨å–®ç¯©é¸é¸é …
                await UpdateFilterProductOptions(supplierId);
                await UpdateFilterPurchaseReceivingOptions(supplierId);
                
                //  é—œéµï¼šåªæœ‰åœ¨æ²’æœ‰ä¸å¯åˆªé™¤æ˜ç´°æ™‚æ‰æ›´æ–° ActionButtons
                if (!hasUndeletableDetails)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        supplierModalManager, 
                        formFields, 
                        nameof(PurchaseReturn.SupplierId), 
                        fieldChange.Value
                    );
                }
                
                StateHasChanged();
            }
            
            // ç•¶ç¨…åˆ¥è®Šæ›´æ™‚ï¼Œé‡æ–°è¨ˆç®—ç¸½é‡‘é¡å’Œç¨…é¡
            if (fieldChange.PropertyName == nameof(PurchaseReturn.TaxCalculationMethod))
            {
                // è§¸ç™¼æ˜ç´°è®Šæ›´äº‹ä»¶ï¼Œé‡æ–°è¨ˆç®—ç¨…é¡
                await HandleReturnDetailsChanged(purchaseReturnDetails);
            }
            
            // ç•¶ç”¢å“ç¯©é¸è®Šæ›´æ™‚ï¼Œæ›´æ–°ç¯©é¸ç‹€æ…‹ä¸¦è§¸ç™¼é‡æ–°æ¸²æŸ“
            if (fieldChange.PropertyName == "FilterProductId")
            {
                if (fieldChange.Value != null && 
                    int.TryParse(fieldChange.Value.ToString(), out int productId) && 
                    productId > 0)
                {
                    filterProductId = productId;
                }
                else
                {
                    filterProductId = null;
                }
                StateHasChanged();
            }
            
            // ç•¶é€²è²¨å–®ç¯©é¸è®Šæ›´æ™‚ï¼Œæ›´æ–°ç¯©é¸ç‹€æ…‹ä¸¦è§¸ç™¼é‡æ–°æ¸²æŸ“
            if (fieldChange.PropertyName == nameof(PurchaseReturn.PurchaseReceivingId))
            {
                if (fieldChange.Value != null && 
                    int.TryParse(fieldChange.Value.ToString(), out int receivingId) && 
                    receivingId > 0)
                {
                    filterPurchaseReceivingId = receivingId;
                }
                else
                {
                    filterPurchaseReceivingId = null;
                }
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†æ¬„ä½è®Šæ›´æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    // ===== è¼”åŠ©æ–¹æ³• =====

    /// <summary>
    /// é…ç½®è‡ªè¨‚æ¨¡çµ„
    /// </summary>
    private List<GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.CustomModule> GetCustomModules()
    {
        try
        {

            if (editModalComponent == null)
            {

                return new List<GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.CustomModule>();
            }

            var content = CreateReturnDetailManagerContent();

            return new List<GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.CustomModule>
            {
                new GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.CustomModule
                {
                    Title = "",
                    Order = 1,
                    CssClass = "mt-4",
                    IsVisible = true,
                    Content = content
                }
            };
        }
        catch
        {
            // å¦‚æœå‰µå»ºæ¨¡çµ„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè¿”å›ç©ºåˆ—è¡¨
            return new List<GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.CustomModule>();
        }
    }

    /// <summary>
    /// å‰µå»ºé€€è²¨æ˜ç´°ç®¡ç†å™¨å…§å®¹çš„ RenderFragment
    /// </summary>
    private RenderFragment CreateReturnDetailManagerContent() => __builder =>
    {
        try
        {

            @if (editModalComponent?.Entity != null)
            {
                @if (!isDetailDataReady)
                {
                    <div class="d-flex justify-content-center align-items-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span class="text-muted">è¼‰å…¥æ˜ç´°è³‡æ–™ä¸­...</span>
                    </div>
                }
                else if (editModalComponent.Entity.SupplierId > 0)
                {
                    try
                    {

                        <PurchaseReturnTable @ref="purchaseReturnDetailManager"
                            SupplierId="@editModalComponent.Entity.SupplierId"
                            FilterPurchaseReceivingId="@filterPurchaseReceivingId"
                            FilterProductId="@filterProductId"
                            TaxCalculationMethod="@editModalComponent.Entity.TaxCalculationMethod"
                            IsEditMode="@(PurchaseReturnId.HasValue)"
                            ExistingReturnDetails="@(purchaseReturnDetails ?? new List<PurchaseReturnDetail>())"
                            OnReturnDetailsChanged="@HandleReturnDetailsChanged"
                            OnHasUndeletableDetailsChanged="@HandleHasUndeletableDetailsChanged"
                            OnOpenRelatedDocument="@HandleOpenRelatedDocument" />
                    }
                    catch (Exception ex)
                    {
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>è¼‰å…¥é€€è²¨æ˜ç´°ç®¡ç†å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤</strong>
                            <br/>éŒ¯èª¤é¡å‹ï¼š@ex.GetType().Name
                            <br/>éŒ¯èª¤è¨Šæ¯ï¼š@ex.Message
                            <br/>è«‹æª¢æŸ¥è³‡æ–™å®Œæ•´æ€§æˆ–è¯ç¹«ç³»çµ±ç®¡ç†å“¡
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-info text-center" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        è«‹å…ˆé¸æ“‡å» å•†å¾Œå†é€²è¡Œé€€è²¨æ˜ç´°ç®¡ç†
                    </div>
                }
            }
            else
            {
                var componentStatus = editModalComponent == null ? "null" : "not null";
                var entityStatus = editModalComponent?.Entity == null ? "null" : "not null";
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                    </div>
                    <p class="text-muted mt-2">æ­£åœ¨è¼‰å…¥é€€è²¨æ˜ç´°ç®¡ç†å™¨...</p>
                </div>
            }
        }
        catch (Exception ex)
        {
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>è¼‰å…¥é€€è²¨æ˜ç´°ç®¡ç†å™¨æ™‚ç™¼ç”Ÿåš´é‡éŒ¯èª¤</strong>
                <br/>éŒ¯èª¤é¡å‹ï¼š@ex.GetType().Name
                <br/>éŒ¯èª¤è¨Šæ¯ï¼š@ex.Message
                <br/>è«‹é‡æ–°æ•´ç†é é¢ï¼Œå¦‚å•é¡ŒæŒçºŒè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡
                <details class="mt-2">
                    <summary>æŠ€è¡“è©³æƒ…</summary>
                    <pre class="mt-1 small">@ex.StackTrace</pre>
                </details>
            </div>
        }
    };

    /// <summary>
    /// è™•ç†é€€è²¨æ˜ç´°è®Šæ›´
    /// </summary>
    private async Task HandleReturnDetailsChanged(List<PurchaseReturnDetail> returnDetails)
    {
        try
        { 
            // å„²å­˜é€€è²¨æ˜ç´°åˆ°å…§éƒ¨ç‹€æ…‹
            purchaseReturnDetails = returnDetails ?? new List<PurchaseReturnDetail>();
            
            // æ›´æ–°ä¸»æª”çš„ç¸½é‡‘é¡å’Œç¨…é¡
            if (editModalComponent?.Entity != null)
            {
                var taxMethod = editModalComponent.Entity.TaxCalculationMethod;
                
                // è¨ˆç®—æ˜ç´°å°è¨ˆï¼ˆæ ¹æ“šç¨…åˆ¥ï¼‰
                var detailSubtotals = purchaseReturnDetails.Select(d => new
                {
                    Detail = d,
                    BaseAmount = d.ReturnQuantity * d.OriginalUnitPrice,
                    TaxRate = d.TaxRate ?? currentTaxRate
                }).ToList();
                
                switch (taxMethod)
                {
                    case TaxCalculationMethod.TaxExclusive:
                        // å¤–åŠ ç¨…ï¼šé‡‘é¡ = Î£(é€€å›æ•¸é‡ Ã— å–®åƒ¹)ï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰ï¼Œç¨…é¡ = é‡‘é¡ Ã— ç¨…ç‡%ï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
                        editModalComponent.Entity.TotalReturnAmount = Math.Round(detailSubtotals.Sum(d => d.BaseAmount), 0, MidpointRounding.AwayFromZero);
                        editModalComponent.Entity.ReturnTaxAmount = detailSubtotals.Sum(d =>
                        {
                            var detailTaxAmount = d.BaseAmount * (d.TaxRate / 100m);
                            return Math.Round(detailTaxAmount, 0, MidpointRounding.AwayFromZero);
                        });
                        break;
                        
                    case TaxCalculationMethod.TaxInclusive:
                        // å…§å«ç¨…ï¼šç¸½é¡ = Î£(é€€å›æ•¸é‡ Ã— å–®åƒ¹)ï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰ï¼Œé‡‘é¡ = ç¸½é¡ - ç¨…é¡ï¼Œç¨…é¡ = ç¸½é¡ / (1 + ç¨…ç‡%) Ã— ç¨…ç‡%ï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
                        var totalWithTax = detailSubtotals.Sum(d => d.BaseAmount);
                        var totalTax = detailSubtotals.Sum(d =>
                        {
                            // åæ¨ç¨…é¡ = å«ç¨…ç¸½é¡ / (1 + ç¨…ç‡%) Ã— ç¨…ç‡%ï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
                            var detailTaxAmount = d.BaseAmount / (1 + d.TaxRate / 100m) * (d.TaxRate / 100m);
                            return Math.Round(detailTaxAmount, 0, MidpointRounding.AwayFromZero);
                        });
                        editModalComponent.Entity.TotalReturnAmount = Math.Round(totalWithTax - totalTax, 0, MidpointRounding.AwayFromZero);
                        editModalComponent.Entity.ReturnTaxAmount = totalTax;
                        break;
                        
                    case TaxCalculationMethod.NoTax:
                        // å…ç¨…ï¼šé‡‘é¡ = Î£(é€€å›æ•¸é‡ Ã— å–®åƒ¹)ï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰ï¼Œç¨…é¡ = 0
                        editModalComponent.Entity.TotalReturnAmount = Math.Round(detailSubtotals.Sum(d => d.BaseAmount), 0, MidpointRounding.AwayFromZero);
                        editModalComponent.Entity.ReturnTaxAmount = 0;
                        break;
                        
                    default:
                        // é è¨­ä½¿ç”¨å¤–åŠ ç¨…ï¼ˆå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
                        editModalComponent.Entity.TotalReturnAmount = Math.Round(detailSubtotals.Sum(d => d.BaseAmount), 0, MidpointRounding.AwayFromZero);
                        editModalComponent.Entity.ReturnTaxAmount = detailSubtotals.Sum(d =>
                        {
                            var detailTaxAmount = d.BaseAmount * (d.TaxRate / 100m);
                            return Math.Round(detailTaxAmount, 0, MidpointRounding.AwayFromZero);
                        });
                        break;
                }
                
                // å«ç¨…ç¸½é‡‘é¡æœƒè‡ªå‹•è¨ˆç®—ï¼ˆTotalReturnAmountWithTax æ˜¯è¨ˆç®—å±¬æ€§ï¼‰
                //    = TotalReturnAmount + ReturnTaxAmount
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†é€€è²¨æ˜ç´°è®Šæ›´æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }



    /// <summary>
    /// é©—è­‰é€²è²¨é€€å‡ºæ˜ç´° - åœ¨å„²å­˜ä¸»æª”ä¹‹å‰åŸ·è¡Œ
    /// </summary>
    private async Task<bool> ValidatePurchaseReturnDetailsAsync(PurchaseReturn purchaseReturn)
    {
        try
        {
            // é¦–å…ˆå‘¼å«æ˜ç´°ç®¡ç†å™¨çš„é©—è­‰æ–¹æ³•
            if (purchaseReturnDetailManager != null)
            {
                bool isValidDetails = await purchaseReturnDetailManager.ValidateAsync();
                if (!isValidDetails)
                {
                    return false;
                }
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„æ˜ç´°
            var validDetails = purchaseReturnDetails.Where(d => d.ProductId > 0 && d.ReturnQuantity > 0).ToList();
            if (!validDetails.Any())
            {
                await NotificationService.ShowErrorAsync("è‡³å°‘éœ€è¦ä¸€ç­†é€€è²¨æ˜ç´°");
                return false;
            }
            
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é©—è­‰é€€è²¨æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// è‡ªè¨‚å„²å­˜é‚è¼¯ - åŒæ™‚å„²å­˜ä¸»æª”å’Œæ˜ç´°
    /// </summary>
    private async Task<bool> SavePurchaseReturnWithDetails(PurchaseReturn purchaseReturn)
    {
        try
        {
            if (purchaseReturn == null)
            {
                return false;
            }
            
            // å…ˆåŸ·è¡Œè‡ªè¨‚é©—è­‰
            if (!await ValidatePurchaseReturnDetailsAsync(purchaseReturn))
            {
                return false;
            }
            
            if (PurchaseReturnService == null)
            {
                return false;
            }
            
            if (purchaseReturnDetails == null)
            {
                purchaseReturnDetails = new List<PurchaseReturnDetail>();
            }
                        
            // å‘¼å«æœå‹™çš„ SaveWithDetailsAsync æ–¹æ³•
            var result = await PurchaseReturnService.SaveWithDetailsAsync(purchaseReturn, purchaseReturnDetails);
            
            if (result == null)
            {
                return false;
            }
            
            if (result.IsSuccess)
            {
                return true;
            }
            else
            {
                await NotificationService.ShowErrorAsync($"å„²å­˜å¤±æ•—ï¼š{result.ErrorMessage}");
                return false;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å„²å­˜æ¡è³¼é€€è²¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }
    
    // ===== å…¬é–‹æ–¹æ³•ï¼ˆä¾›å¤–éƒ¨çµ„ä»¶èª¿ç”¨ï¼‰ =====
    
    /// <summary>
    /// é–‹å•Ÿæ–°å¢é€²è²¨é€€å‡º Modal ä¸¦é å¡«é€²è²¨å–®è³‡è¨Šï¼ˆå…¬é–‹æ–¹æ³•ä¾›å¤–éƒ¨èª¿ç”¨ï¼‰
    /// </summary>
    public async Task ShowAddModalWithPrefilledReceiving(int supplierId, int purchaseReceivingId)
    {
        try
        {
            // ä½¿ç”¨ DocumentConversionHelper çµ±ä¸€è™•ç†è½‰å–®é‚è¼¯
            var success = await DocumentConversionHelper.ShowConversionModalAsync(
                setPrefilledValues: () =>
                {
                    PurchaseReturnId = null;
                    PrefilledSupplierId = supplierId;
                    PrefilledPurchaseReceivingId = purchaseReceivingId;
                    //  ç«‹å³è¨­å®šç¯©é¸IDï¼ˆç¢ºä¿æ˜ç´°ç®¡ç†å™¨æ¸²æŸ“æ™‚å°±èƒ½ä½¿ç”¨æ­£ç¢ºçš„ç¯©é¸åƒæ•¸ï¼‰
                    filterPurchaseReceivingId = purchaseReceivingId;
                    shouldAutoLoadReturnable = true;
                },
                isVisibleChanged: IsVisibleChanged,
                autoLoadAction: async () =>
                {
                    shouldAutoLoadReturnable = false;
                    if (purchaseReturnDetailManager != null)
                    {
                        await purchaseReturnDetailManager.LoadAllReturnableItems();
                    }
                },
                detailManagerReady: () => purchaseReturnDetailManager != null,
                shouldAutoLoad: () => shouldAutoLoadReturnable,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("è½‰å–®æµç¨‹åŸ·è¡Œå¤±æ•—");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledReceiving), GetType(), 
                additionalData: $"é–‹å•Ÿé å¡«é€²è²¨é€€å‡ºModalå¤±æ•— - SupplierId: {supplierId}, ReceivingId: {purchaseReceivingId}");
            await NotificationService.ShowErrorAsync("é–‹å•Ÿé€²è²¨é€€å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
}

