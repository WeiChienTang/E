@* 進貨退出編輯模態組件 *@
@using Microsoft.AspNetCore.Components.Rendering
@inject IPurchaseReturnService PurchaseReturnService
@inject ISupplierService SupplierService
@inject IPurchaseReceivingService PurchaseReceivingService
@inject IProductService ProductService
@inject INotificationService NotificationService
@inject ActionButtonHelper ActionButtonHelper

<GenericEditModalComponent TEntity="PurchaseReturn" 
                          TService="IPurchaseReturnService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          Id="@PurchaseReturnId"
                          Service="@PurchaseReturnService"
                          EntityName="進貨退出"
                          EntityNamePlural="進貨退出"
                          ModalTitle="@(PurchaseReturnId.HasValue ? "編輯進貨退出" : "新增進貨退出")"
                          Size="GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@GetAutoCompletePrefillers()"
                          AutoCompleteCollections="@GetAutoCompleteCollections()"
                          AutoCompleteDisplayProperties="@GetAutoCompleteDisplayProperties()"
                          AutoCompleteValueProperties="@GetAutoCompleteValueProperties()"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadPurchaseReturnData"
                          AdditionalDataLoader="@LoadAdditionalDataAsync"
                          UseGenericSave="true"
                          SaveSuccessMessage="@(PurchaseReturnId.HasValue ? "進貨退出更新成功" : "進貨退出新增成功")"
                          SaveFailureMessage="進貨退出儲存失敗"
                          RequiredPermission="PurchaseReturn.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          CustomModules="@GetCustomModules()" />

@* 廠商編輯 Modal *@
<SupplierEditModalComponent @ref="supplierEditModal"
                           IsVisible="@supplierModalManager.IsModalVisible"
                           IsVisibleChanged="@supplierModalManager.HandleModalVisibilityChangedAsync"
                           SupplierId="@supplierModalManager.SelectedEntityId"
                           PrefilledValues="@supplierModalManager.PrefilledValues"
                           OnSupplierSaved="@OnSupplierSavedWrapper"
                           OnCancel="@supplierModalManager.HandleModalCancelAsync" />

@code {
    // 參數
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? PurchaseReturnId { get; set; }
    [Parameter] public EventCallback<PurchaseReturn> OnPurchaseReturnSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // 組件參考
    private GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>? editModalComponent;

    // 表單欄位和區塊
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();

    // 相關資料
    private List<Supplier> suppliers = new();
    private List<PurchaseReceiving> purchaseReceivings = new();
    private List<Product> products = new();
    
    // ===== 篩選狀態 =====
    private int? filterProductId = null;
    private int? filterPurchaseReceivingId = null;
    
    // Modal 管理器
    private SupplierEditModalComponent? supplierEditModal;
    private RelatedEntityModalManager<Supplier> supplierModalManager = default!;

    // ===== 生命週期 =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 初始化 Modal 管理器
            InitializeSupplierModalManager();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化進貨退出編輯組件時發生錯誤");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible)
        {
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
        }
    }

    // ===== 事件處理 =====
    private async Task HandleSaveSuccess()
    {
        try
        {
            // 如果父組件需要知道進貨退出已儲存
            if (OnPurchaseReturnSaved.HasDelegate && editModalComponent?.Entity != null)
            {
                await OnPurchaseReturnSaved.InvokeAsync(editModalComponent.Entity);
            }
            // 不需要手動關閉 Modal，GenericEditModalComponent 會處理
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理儲存成功事件時發生錯誤：{ex.Message}");
        }
    }

    private async Task HandleCancel()
    {
        try
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }
            await CloseModal();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理取消事件時發生錯誤：{ex.Message}");
        }
    }

    private async Task CloseModal()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }

    // ===== 資料載入 =====
    private async Task<PurchaseReturn?> LoadPurchaseReturnData()
    {
        try
        {
            if (!PurchaseReturnId.HasValue)
            {
                // 新增模式 - 返回預設值並生成退回單號
                return new PurchaseReturn
                {
                    PurchaseReturnNumber = await GeneratePurchaseReturnNumberAsync(),
                    ReturnDate = DateTime.Today,
                    Status = EntityStatus.Active
                };
            }
            else
            {
                // 編輯模式 - 載入現有資料
                return await PurchaseReturnService.GetWithDetailsAsync(PurchaseReturnId.Value);
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入進貨退出資料時發生錯誤：{ex.Message}");
            return null;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            await Task.WhenAll(
                LoadSuppliersAsync(),
                LoadPurchaseReceivingsAsync(),
                LoadProductsAsync()
            );
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入額外資料時發生錯誤：{ex.Message}");
        }
    }

    private async Task LoadSuppliersAsync()
    {
        try
        {
            suppliers = await SupplierService.GetAllAsync();
        }
        catch (Exception)
        {
            suppliers = new List<Supplier>();
        }
    }

    private async Task LoadPurchaseReceivingsAsync()
    {
        try
        {
            purchaseReceivings = await PurchaseReceivingService.GetAllAsync();
        }
        catch (Exception)
        {
            purchaseReceivings = new List<PurchaseReceiving>();
        }
    }

    private async Task LoadProductsAsync()
    {
        try
        {
            products = await ProductService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入產品資料時發生錯誤：{ex.Message}");
            products = new List<Product>();
        }
    }

    // ===== 表單設定 =====
    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(PurchaseReturn.PurchaseReturnNumber),
                    Label = "退回單號",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入退回單號",
                    IsRequired = true,
                    MaxLength = 30,
                    Order = 1,
                    HelpText = "系統自動生成的唯一退回單號，也可手動修改"
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.SupplierId),
                    Label = "廠商",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇廠商",
                    IsRequired = true,
                    MinSearchLength = 0,
                    Order = 2,
                    HelpText = "輸入廠商名稱進行搜尋，或直接選擇",
                    ActionButtons = await GetSupplierActionButtonsAsync()
                },
                new()
                {
                    PropertyName = "FilterProductId", // 篩選用的虛擬欄位
                    Label = "篩選商品",
                    FieldType = FormFieldType.Select,
                    IsRequired = false,
                    Order = 3,
                    Options = await GetFilterProductOptions(),
                    HelpText = "選擇特定商品進行篩選，或留空顯示所有商品"
                },
                new()
                {
                    PropertyName = "FilterPurchaseReceivingId", // 篩選用的虛擬欄位
                    Label = "篩選進貨單",
                    FieldType = FormFieldType.Select,
                    IsRequired = false,
                    Order = 4,
                    Options = await GetFilterPurchaseReceivingOptions(),
                    HelpText = "選擇特定進貨單進行篩選，或留空顯示所有進貨單"
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.ReturnDate),
                    Label = "退回日期",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    Order = 5,
                    HelpText = "請選擇退回日期"
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.PurchaseReceivingId),
                    Label = "原進貨單",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "選擇原進貨單",
                    IsRequired = false,
                    Order = 6,
                    HelpText = "選擇此退回單所對應的原進貨單"
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.TotalReturnAmount),
                    Label = "退回總金額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    Order = 7,
                    HelpText = "請輸入退回總金額"
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.ReturnTaxAmount),
                    Label = "退回稅額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    Order = 8,
                    HelpText = "請輸入退回稅額"
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.TotalReturnAmountWithTax),
                    Label = "退回含稅總金額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    Order = 9,
                    HelpText = "請輸入退回含稅總金額"
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.IsRefunded),
                    Label = "是否已退款",
                    FieldType = FormFieldType.Checkbox,
                    Order = 10,
                    HelpText = "標記此退回單是否已經退款"
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.RefundDate),
                    Label = "退款日期",
                    FieldType = FormFieldType.Date,
                    IsRequired = false,
                    Order = 11,
                    HelpText = "請選擇退款日期",
                    IsDisabled = !(editModalComponent?.Entity?.IsRefunded ?? false)
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.Remarks),
                    Label = "備註",
                    FieldType = FormFieldType.TextArea,
                    Placeholder = "請輸入備註",
                    IsRequired = false,
                    MaxLength = 500,
                    Order = 12,
                    HelpText = "可輸入相關備註資訊",
                    ContainerCssClass = "col-12"
                } 
            };

            formSections = new Dictionary<string, string>
            {
                { nameof(PurchaseReturn.PurchaseReturnNumber), "基本資訊" },
                { nameof(PurchaseReturn.SupplierId), "基本資訊" },
                { "FilterProductId", "基本資訊" },
                { "FilterPurchaseReceivingId", "基本資訊" },
                { nameof(PurchaseReturn.ReturnDate), "基本資訊" },
                { nameof(PurchaseReturn.PurchaseReceivingId), "基本資訊" },
                { nameof(PurchaseReturn.TotalReturnAmount), "金額資訊" },
                { nameof(PurchaseReturn.ReturnTaxAmount), "金額資訊" },
                { nameof(PurchaseReturn.TotalReturnAmountWithTax), "金額資訊" },
                { nameof(PurchaseReturn.IsRefunded), "退款資訊" },
                { nameof(PurchaseReturn.RefundDate), "退款資訊" }
            };
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("初始化表單欄位時發生錯誤");
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }

    /// <summary>
    /// 取得商品篩選選項 - 根據選擇的廠商篩選
    /// </summary>
    private async Task<List<SelectOption>> GetFilterProductOptions()
    {
        try
        {
            var options = new List<SelectOption> {};
            
            // 如果有選擇廠商，只顯示該廠商的產品
            if (editModalComponent?.Entity?.SupplierId > 0)
            {
                var supplierProducts = await ProductService.GetBySupplierAsync(editModalComponent.Entity.SupplierId);
                options.AddRange(supplierProducts.Select(p => new SelectOption
                {
                    Value = p.Id.ToString(),
                    Text = $"{p.Code} - {p.Name}"
                }));
            }
            
            return options;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入商品選項時發生錯誤：{ex.Message}");
            return new List<SelectOption> {};
        }
    }

    /// <summary>
    /// 取得進貨單篩選選項 - 根據選擇的廠商篩選
    /// </summary>
    private async Task<List<SelectOption>> GetFilterPurchaseReceivingOptions()
    {
        try
        {
            var options = new List<SelectOption> {};
            
            // 如果有選擇廠商，只顯示該廠商的進貨單
            if (editModalComponent?.Entity?.SupplierId > 0)
            {
                var supplierReceivings = purchaseReceivings
                    .Where(pr => pr.SupplierId == editModalComponent.Entity.SupplierId)
                    .ToList();
                    
                options.AddRange(supplierReceivings.Select(pr => new SelectOption
                {
                    Value = pr.Id.ToString(),
                    Text = $"{pr.ReceiptNumber} - {pr.ReceiptDate:yyyy/MM/dd}"
                }));
            }
            
            return options;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入進貨單選項時發生錯誤：{ex.Message}");
            return new List<SelectOption> {};
        }
    }

    /// <summary>
    /// 更新商品篩選選項 - 當廠商變更時調用
    /// </summary>
    private async Task UpdateFilterProductOptions(int? supplierId = null)
    {
        try
        {
            // 找到商品篩選欄位並更新其選項
            var filterProductField = formFields.FirstOrDefault(f => f.PropertyName == "FilterProductId");
            if (filterProductField != null)
            {
                var options = new List<SelectOption> {};
                
                if (supplierId.HasValue && supplierId.Value > 0)
                {
                    var supplierProducts = await ProductService.GetBySupplierAsync(supplierId.Value);
                    options.AddRange(supplierProducts.Select(p => new SelectOption
                    {
                        Value = p.Id.ToString(),
                        Text = $"{p.Code} - {p.Name}"
                    }));
                }
                
                filterProductField.Options = options;
                
                // 清空目前的商品篩選選擇
                filterProductId = null;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"更新商品篩選選項時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 更新進貨單篩選選項 - 當廠商變更時調用
    /// </summary>
    private async Task UpdateFilterPurchaseReceivingOptions(int? supplierId = null)
    {
        try
        {
            // 找到進貨單篩選欄位並更新其選項
            var filterReceivingField = formFields.FirstOrDefault(f => f.PropertyName == "FilterPurchaseReceivingId");
            if (filterReceivingField != null)
            {
                var options = new List<SelectOption> {};
                
                if (supplierId.HasValue && supplierId.Value > 0)
                {
                    var supplierReceivings = purchaseReceivings
                        .Where(pr => pr.SupplierId == supplierId.Value)
                        .ToList();
                        
                    options.AddRange(supplierReceivings.Select(pr => new SelectOption
                    {
                        Value = pr.Id.ToString(),
                        Text = $"{pr.ReceiptNumber} - {pr.ReceiptDate:yyyy/MM/dd}"
                    }));
                }
                
                filterReceivingField.Options = options;
                
                // 清空目前的進貨單篩選選擇
                filterPurchaseReceivingId = null;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"更新進貨單篩選選項時發生錯誤：{ex.Message}");
        }
    }

    // ===== AutoComplete 設定 =====
    
    /// <summary>
    /// 配置 AutoComplete 預填器
    /// </summary>
    private Dictionary<string, Func<string, Dictionary<string, object?>>> GetAutoCompletePrefillers()
    {
        return new Dictionary<string, Func<string, Dictionary<string, object?>>>
        {
            {
                nameof(PurchaseReturn.SupplierId), searchTerm => new Dictionary<string, object?>
                {
                    { "CompanyName", searchTerm }
                }
            },
            {
                nameof(PurchaseReturn.PurchaseReceivingId), searchTerm => new Dictionary<string, object?>
                {
                    { "ReceiptNumber", searchTerm }
                }
            }
        };
    }
    
    private Dictionary<string, IEnumerable<object>> GetAutoCompleteCollections()
    {
        return new Dictionary<string, IEnumerable<object>>
        {
            { nameof(PurchaseReturn.SupplierId), suppliers.Cast<object>() },
            { nameof(PurchaseReturn.PurchaseReceivingId), purchaseReceivings.Cast<object>() }
        };
    }

    private Dictionary<string, string> GetAutoCompleteDisplayProperties()
    {
        return new Dictionary<string, string>
        {
            { nameof(PurchaseReturn.SupplierId), nameof(Supplier.CompanyName) },
            { nameof(PurchaseReturn.PurchaseReceivingId), nameof(PurchaseReceiving.ReceiptNumber) }
        };
    }

    private Dictionary<string, string> GetAutoCompleteValueProperties()
    {
        return new Dictionary<string, string>
        {
            { nameof(PurchaseReturn.SupplierId), nameof(Supplier.Id) },
            { nameof(PurchaseReturn.PurchaseReceivingId), nameof(PurchaseReceiving.Id) }
        };
    }

    // ===== Modal 管理器配置方法 =====
    
    /// <summary>
    /// 配置 Modal 管理器
    /// </summary>
    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(PurchaseReturn.SupplierId), supplierModalManager }
        };
    }
    
    // ===== Modal 管理器初始化方法 =====
    
    /// <summary>
    /// 初始化廠商 Modal 管理器
    /// </summary>
    private void InitializeSupplierModalManager()
    {
        supplierModalManager = new RelatedEntityManagerBuilder<Supplier>(NotificationService, "廠商")
            .WithPropertyName(nameof(PurchaseReturn.SupplierId))
            .WithReloadCallback(LoadAdditionalDataAsync)
            .WithStateChangedCallback(StateHasChanged)
            .WithAutoSelectCallback(supplierId => 
            {
                // 自動選擇廠商時的回調邏輯
            })
            .WithCustomPostProcess(async supplier => 
            {
                await InitializeFormFieldsAsync();
            })
            .Build();
    }
    
    // ===== ActionButton 產生方法 =====
    
    /// <summary>
    /// 產生廠商操作按鈕 - 使用統一 Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetSupplierActionButtonsAsync()
    {
        var buttons = await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            supplierModalManager, 
            nameof(PurchaseReturn.SupplierId)
        );
        
        return buttons;
    }
    
    // ===== Modal 事件包裝器方法 =====
    
    /// <summary>
    /// 包裝廠商儲存事件
    /// </summary>
    private async Task OnSupplierSavedWrapper(Supplier savedSupplier)
    {
        await supplierModalManager.HandleEntitySavedAsync(savedSupplier, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// 處理欄位值變更事件 - 使用統一 Helper
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // 當廠商變更時，更新篩選選項
            if (fieldChange.PropertyName == nameof(PurchaseReturn.SupplierId))
            {
                int? supplierId = null;
                if (fieldChange.Value != null && 
                    int.TryParse(fieldChange.Value.ToString(), out int parsedSupplierId) && 
                    parsedSupplierId > 0)
                {
                    supplierId = parsedSupplierId;
                }
                
                // 更新商品和進貨單篩選選項
                await UpdateFilterProductOptions(supplierId);
                await UpdateFilterPurchaseReceivingOptions(supplierId);
                
                StateHasChanged();
            }
            
            // 當商品篩選變更時，更新篩選狀態並觸發重新渲染
            if (fieldChange.PropertyName == "FilterProductId")
            {
                if (fieldChange.Value != null && 
                    int.TryParse(fieldChange.Value.ToString(), out int productId) && 
                    productId > 0)
                {
                    filterProductId = productId;
                }
                else
                {
                    filterProductId = null;
                }
                StateHasChanged();
            }
            
            // 當進貨單篩選變更時，更新篩選狀態並觸發重新渲染
            if (fieldChange.PropertyName == "FilterPurchaseReceivingId")
            {
                if (fieldChange.Value != null && 
                    int.TryParse(fieldChange.Value.ToString(), out int receivingId) && 
                    receivingId > 0)
                {
                    filterPurchaseReceivingId = receivingId;
                }
                else
                {
                    filterPurchaseReceivingId = null;
                }
                StateHasChanged();
            }
            
            // 當「是否已退款」變更時，處理退款日期的邏輯
            if (fieldChange.PropertyName == nameof(PurchaseReturn.IsRefunded) && 
                fieldChange.Value is bool isRefunded)
            {
                if (editModalComponent?.Entity != null)
                {
                    if (isRefunded)
                    {
                        // 設為 true 時，自動設定退款日期為當日
                        editModalComponent.Entity.RefundDate = DateTime.Today;
                    }
                    else
                    {
                        // 設為 false 時，清空退款日期
                        editModalComponent.Entity.RefundDate = null;
                    }
                    
                    // 更新退款日期欄位的禁用狀態
                    var refundDateField = formFields.FirstOrDefault(f => f.PropertyName == nameof(PurchaseReturn.RefundDate));
                    if (refundDateField != null)
                    {
                        refundDateField.IsDisabled = !isRefunded;
                    }
                    
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理欄位變更時發生錯誤：{ex.Message}");
        }
    }

    // ===== 輔助方法 =====
    private async Task<string> GeneratePurchaseReturnNumberAsync()
    {
        return await CodeGenerationHelper.GenerateEntityCodeAsync(
            PurchaseReturnService,
            "PR",
            (service, code, excludeId) => service.IsPurchaseReturnNumberExistsAsync(code, excludeId)
        );
    }

    /// <summary>
    /// 配置自訂模組
    /// </summary>
    private List<GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.CustomModule> GetCustomModules()
    {
        try
        {
            if (editModalComponent == null)
            {
                return new List<GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.CustomModule>();
            }

            return new List<GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.CustomModule>
            {
                new GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.CustomModule
                {
                    Title = "退貨明細",
                    Order = 1,
                    CssClass = "mt-4",
                    IsVisible = true,
                    Content = CreateReturnDetailManagerContent()
                }
            };
        }
        catch
        {
            // 如果創建模組時發生錯誤，返回空列表
            return new List<GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.CustomModule>();
        }
    }

    /// <summary>
    /// 創建退貨明細管理器內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateReturnDetailManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null)
            {
                @if (editModalComponent.Entity.SupplierId > 0)
                {
                    try
                    {
                        <PurchaseReturnDetailManagerComponent 
                            SupplierId="@editModalComponent.Entity.SupplierId"
                            FilterPurchaseReceivingId="@filterPurchaseReceivingId"
                            FilterProductId="@filterProductId"
                            IsEditMode="@(PurchaseReturnId.HasValue)"
                            OnReturnDetailsChanged="@HandleReturnDetailsChanged" />
                    }
                    catch
                    {
                        <div class="alert alert-warning" role="alert">
                            載入退貨明細管理器時發生錯誤，請重新整理頁面。
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-info text-center" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        請先選擇廠商後再進行退貨明細管理
                    </div>
                }
            }
            else
            {
                <div class="text-center py-3">
                    <span class="text-muted">請先選擇廠商後再管理退貨明細</span>
                </div>
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                載入退貨明細管理器時發生錯誤，請重新整理頁面。
            </div>
        }
    };

    /// <summary>
    /// 處理退貨明細變更
    /// </summary>
    private async Task HandleReturnDetailsChanged(List<PurchaseReturnDetail> returnDetails)
    {
        try
        {
            // 這裡可以處理退貨明細變更的邏輯
            // 例如計算總金額等
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理退貨明細變更時發生錯誤：{ex.Message}");
        }
    }
}
