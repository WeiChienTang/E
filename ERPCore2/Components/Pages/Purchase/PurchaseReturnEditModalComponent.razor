@* 進貨退出編輯模態組件 *@
@using Microsoft.AspNetCore.Components.Rendering
@using ERPCore2.Services.Reports
@using ERPCore2.Helpers.EditModal
@inject IPurchaseReturnService PurchaseReturnService
@inject IPurchaseReturnDetailService PurchaseReturnDetailService
@inject ISupplierService SupplierService
@inject IPurchaseReceivingService PurchaseReceivingService
@inject IProductService ProductService
@inject INotificationService NotificationService
@inject ActionButtonHelper ActionButtonHelper
@inject ISystemParameterService SystemParameterService
@inject ISetoffDocumentService SetoffDocumentService
@inject IPurchaseReturnReportService PurchaseReturnReportService
@inject IReportPrintConfigurationService ReportPrintConfigurationService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ERPCore2.Data.Context.AppDbContext DbContext

<GenericEditModalComponent TEntity="PurchaseReturn" 
                          TService="IPurchaseReturnService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          Id="@PurchaseReturnId"
                          Service="@PurchaseReturnService"
                          EntityName="進貨退出"
                          EntityNamePlural="進貨退出"
                          ModalTitle="@(PurchaseReturnId.HasValue ? "編輯進貨退出" : "新增進貨退出")"
                          Size="GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@(autoCompleteConfig?.Prefillers)"
                          AutoCompleteCollections="@(autoCompleteConfig?.Collections)"
                          AutoCompleteDisplayProperties="@(autoCompleteConfig?.DisplayProperties)"
                          AutoCompleteValueProperties="@(autoCompleteConfig?.ValueProperties)"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadPurchaseReturnData"
                          AdditionalDataLoader="@LoadAdditionalDataAsync"
                          UseGenericSave="false"
                          CustomValidator="@ValidatePurchaseReturnDetailsAsync"
                          SaveHandler="@SavePurchaseReturnWithDetails"
                          SaveSuccessMessage="@(PurchaseReturnId.HasValue ? "進貨退出更新成功" : "進貨退出新增成功")"
                          SaveFailureMessage="進貨退出儲存失敗"
                          RequiredPermission="PurchaseReturn.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          GetStatusMessage="@GetStatusMessage"
                          FormHeaderContent="@GetWarningMessage()"
                          CustomModules="@GetCustomModules()"
                          ShowPrintButton="true"
                          OnPrint="@HandlePrint" />

@* 廠商編輯 Modal *@
<SupplierEditModalComponent @ref="supplierEditModal"
                           IsVisible="@supplierModalManager.IsModalVisible"
                           IsVisibleChanged="@supplierModalManager.HandleModalVisibilityChangedAsync"
                           SupplierId="@supplierModalManager.SelectedEntityId"
                           PrefilledValues="@supplierModalManager.PrefilledValues"
                           OnSupplierSaved="@OnSupplierSavedWrapper"
                           OnCancel="@supplierModalManager.HandleModalCancelAsync" />

@* 沖款單編輯 Modal *@
<SetoffDocumentEditModalComponent @ref="setoffDocumentEditModal"
                                 IsVisible="@showSetoffDocumentModal"
                                 IsVisibleChanged="@((bool visible) => showSetoffDocumentModal = visible)"
                                 SetoffDocumentId="@selectedSetoffDocumentId"
                                 OnSetoffDocumentSaved="@HandleSetoffDocumentSaved"
                                 OnCancel="@(() => showSetoffDocumentModal = false)" />

@code {
    // 參數
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? PurchaseReturnId { get; set; }
    [Parameter] public EventCallback<PurchaseReturn> OnPurchaseReturnSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    
    // ===== 預填參數（用於從進貨單轉單） =====
    [Parameter] public int? PrefilledSupplierId { get; set; }
    [Parameter] public int? PrefilledPurchaseReceivingId { get; set; }

    // 組件參考
    private GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>? editModalComponent;

    // 表單欄位和區塊
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();

    // 相關資料
    private List<Supplier> suppliers = new();
    private List<PurchaseReceiving> purchaseReceivings = new();
    private List<Product> products = new();
    
    // AutoComplete 配置
    private AutoCompleteConfig? autoCompleteConfig;
    
    // ===== 篩選狀態 =====
    private int? filterProductId = null;
    private int? filterPurchaseReceivingId = null;
    
    // ===== 退貨明細 =====
    private List<PurchaseReturnDetail> purchaseReturnDetails = new();
    private PurchaseReturnTable? purchaseReturnDetailManager;
    
    // Modal 管理器
    private SupplierEditModalComponent? supplierEditModal;
    private RelatedEntityModalManager<Supplier> supplierModalManager = default!;
    private ModalManagerCollection modalManagers = default!;
    
    // ===== 相關單據 Modal =====
    private SetoffDocumentEditModalComponent? setoffDocumentEditModal;
    private bool showSetoffDocumentModal = false;
    private int? selectedSetoffDocumentId = null;
    
    // ===== 系統參數 - 稅率快取（避免重複查詢資料庫） =====
    private decimal currentTaxRate = 5.0m; // 預設 5%，實際值會在初始化時從資料庫載入

    // ===== 鎖定狀態 =====
    private bool hasUndeletableDetails = false;
    private bool isDetailDataReady = false;
    
    // ===== 明細載入狀態 =====
    private bool shouldAutoLoadReturnable = false;  // 標記是否需要自動載入可退回商品

    // ===== 生命週期 =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 使用 ModalManagerInitHelper 初始化 Modal 管理器
            modalManagers = ModalManagerInitHelper.CreateBuilder<PurchaseReturn, IPurchaseReturnService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Supplier>(nameof(PurchaseReturn.SupplierId), "廠商")
                .Build();
            supplierModalManager = modalManagers.Get<Supplier>(nameof(PurchaseReturn.SupplierId));
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"初始化進貨退出編輯組件時發生錯誤：{ex.Message}");
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            if (IsVisible)
            {
                await LoadAdditionalDataAsync();
                await InitializeFormFieldsAsync();
                
                // 如果有預填廠商，在表單欄位初始化後再次更新選項
                if (PrefilledSupplierId.HasValue && PrefilledSupplierId.Value > 0)
                {
                    await UpdateFilterProductOptions(PrefilledSupplierId.Value);
                    await UpdateFilterPurchaseReceivingOptions(PrefilledSupplierId.Value);
                    StateHasChanged(); // 強制更新 UI
                }
            }
            else
            {
                //  Modal 關閉時重置自動載入相關標記
                shouldAutoLoadReturnable = false;
            }
            
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入進貨退出資料時發生錯誤：{ex.Message}");
        }
    }

    // ===== 事件處理 =====
    private async Task HandleSaveSuccess()
    {
        try
        {
            // 如果父組件需要知道進貨退出已儲存
            if (OnPurchaseReturnSaved.HasDelegate && editModalComponent?.Entity != null)
            {
                await OnPurchaseReturnSaved.InvokeAsync(editModalComponent.Entity);
            }
            // 不需要手動關閉 Modal，GenericEditModalComponent 會處理
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理儲存成功事件時發生錯誤：{ex.Message}");
        }
    }

    private async Task HandleCancel()
    {
        try
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }
            await CloseModal();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理取消事件時發生錯誤：{ex.Message}");
        }
    }

    private async Task HandlePrint()
    {
        try
        {
            // 使用通用 Helper 進行完整驗證（實體、ID、必要資料）
            var (isValid, errorMessage) = ReportPrintHelper.ValidateForPrint(
                editModalComponent?.Entity,
                PurchaseReturnId,
                isApproved: false, // 進貨退出單不需要核准即可列印
                entityName: "進貨退出單",
                requireApproval: false
            );
            
            if (!isValid)
            {
                await NotificationService.ShowWarningAsync(errorMessage);
                return;
            }
            
            // 直接執行列印，使用預設設定
            await HandleDirectPrint(null);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"列印進貨退出單時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 直接執行列印 - 可以使用指定的列印配置或預設配置
    /// </summary>
    private async Task HandleDirectPrint(Data.Entities.ReportPrintConfiguration? printConfig)
    {
        try
        {
            if (!PurchaseReturnId.HasValue)
            {
                await NotificationService.ShowErrorAsync("無法列印：進貨退出單 ID 不存在");
                return;
            }

            // 驗證列印配置
            var (isValid, errorMessage) = ReportPrintHelper.ValidateConfiguration(printConfig);
            if (!isValid)
            {
                await NotificationService.ShowWarningAsync(errorMessage);
                return;
            }

            // 使用通用 Helper 建立列印 URL（新版路由）
            var printUrl = ReportPrintHelper.BuildPrintUrl(
                baseUrl: NavigationManager.BaseUri,
                reportType: "purchase-report/return",
                documentId: PurchaseReturnId.Value,
                configuration: printConfig,
                autoprint: true
            );

            // 使用通用 Helper 執行列印（隱藏 iframe 方式）
            var success = await ReportPrintHelper.ExecutePrintWithHiddenIframeAsync(
                printUrl,
                JSRuntime
            );
            
            if (success)
            {
                await NotificationService.ShowSuccessAsync("列印指令已發送");
            }
            else
            {
                await NotificationService.ShowErrorAsync("列印執行失敗");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDirectPrint), GetType(), 
                additionalData: $"進貨退出單直接列印失敗 - ID: {PurchaseReturnId}, Config: {printConfig?.ReportName}");
            await NotificationService.ShowErrorAsync("列印執行時發生錯誤");
        }
    }

    private async Task CloseModal()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }

    // ===== 資料載入 =====
    private async Task<PurchaseReturn?> LoadPurchaseReturnData()
    {
        try
        {
            isDetailDataReady = false;
            hasUndeletableDetails = false;
            
            if (!PurchaseReturnId.HasValue)
            {
                purchaseReturnDetails = new List<PurchaseReturnDetail>(); // 清空明細
                isDetailDataReady = true;
                
                // 設定篩選參數（用於自動載入）
                if (PrefilledPurchaseReceivingId.HasValue && PrefilledPurchaseReceivingId.Value > 0)
                {
                    filterPurchaseReceivingId = PrefilledPurchaseReceivingId.Value;
                }
                
                try
                {
                    var number = await EntityCodeGenerationHelper.GenerateForEntity<PurchaseReturn, IPurchaseReturnService>(PurchaseReturnService, DbContext);                    
                    return new PurchaseReturn
                    {
                        Code = number,
                        ReturnDate = DateTime.Today,
                        Status = EntityStatus.Active,
                        SupplierId = PrefilledSupplierId ?? 0,
                        PurchaseReceivingId = PrefilledPurchaseReceivingId // 直接設定實體屬性
                    };
                }
                catch (Exception)
                {
                    throw;
                }
            }
            else
            {                
                if (PurchaseReturnService == null)
                {
                    isDetailDataReady = true;
                    return null;
                }
                
                var purchaseReturn = await PurchaseReturnService.GetWithDetailsAsync(PurchaseReturnId.Value);
                
                if (purchaseReturn != null)
                {
                    // 檢查明細
                    if (purchaseReturn.PurchaseReturnDetails == null)
                    {
                        purchaseReturnDetails = new List<PurchaseReturnDetail>();
                    }
                    else
                    {
                        // 使用硬刪除後不需要篩選 IsDeleted，因為已刪除的記錄不會存在於資料庫中
                        purchaseReturnDetails = purchaseReturn.PurchaseReturnDetails.ToList();
                    }
                    
                    //  關鍵：載入明細相關資料（沖款記錄）
                    await LoadDetailRelatedDataAsync();
                    isDetailDataReady = true;
                    StateHasChanged();

                    // 檢查並設定預設值
                    if (purchaseReturn.ReturnDate == default(DateTime))
                    {
                        purchaseReturn.ReturnDate = DateTime.Today;
                    }
                    
                    if (purchaseReturn.Status == default(EntityStatus))
                    {
                        purchaseReturn.Status = EntityStatus.Active;
                    }
                    
                }
                else
                {
                    purchaseReturnDetails = new List<PurchaseReturnDetail>();
                    isDetailDataReady = true;
                }
                
                return purchaseReturn;
            }
        }
        catch (Exception)
        {            
            // 確保即使發生錯誤也要初始化明細列表
            purchaseReturnDetails = new List<PurchaseReturnDetail>();
            isDetailDataReady = true; // 錯誤也要允許渲染
            return null;
        }
    }

    /// <summary>
    /// 載入明細相關資料（沖款記錄）- 用於判斷是否有不可刪除的明細
    /// 必須在 DataLoader 中同步執行，確保狀態訊息正確顯示
    /// </summary>
    private async Task LoadDetailRelatedDataAsync()
    {
        try
        {
            if (!purchaseReturnDetails.Any())
            {
                hasUndeletableDetails = false;
                return;
            }

            bool hasUndeletable = false;
            
            foreach (var detail in purchaseReturnDetails.Where(d => d.Id > 0))
            {
                // 檢查沖款記錄
                if (detail.TotalReceivedAmount > 0)
                {
                    hasUndeletable = true;
                    break;
                }
            }
            
            hasUndeletableDetails = hasUndeletable;
            
            if (hasUndeletableDetails)
            {
                UpdateFieldsReadOnlyState();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDetailRelatedDataAsync), GetType());
            hasUndeletableDetails = false;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            
            await Task.WhenAll(
                LoadSuppliersAsync(),
                LoadPurchaseReceivingsAsync(),
                LoadProductsAsync()
            );
            
            // 一次性載入系統稅率（避免每次計算都查詢資料庫）
            currentTaxRate = await TaxCalculationHelper.LoadTaxRateAsync(SystemParameterService);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入附加資料時發生錯誤：{ex.Message}");
        }
    }

    private async Task LoadSuppliersAsync()
    {
        try
        {
            suppliers = await SupplierService.GetAllAsync();
        }
        catch (Exception)
        {
            suppliers = new List<Supplier>();
        }
    }

    private async Task LoadPurchaseReceivingsAsync()
    {
        try
        {
            purchaseReceivings = await PurchaseReceivingService.GetAllAsync();
        }
        catch (Exception)
        {
            purchaseReceivings = new List<PurchaseReceiving>();
        }
    }

    private async Task LoadProductsAsync()
    {
        try
        {
            products = await ProductService.GetAllAsync();
            
            // 配置 AutoComplete
            autoCompleteConfig = new AutoCompleteConfigBuilder<PurchaseReturn>()
                .AddField(nameof(PurchaseReturn.SupplierId), "CompanyName", suppliers)
                .AddField(nameof(PurchaseReturn.PurchaseReceivingId), "Code", purchaseReceivings)
                .Build();
        }
        catch (Exception)
        {
            products = new List<Product>();
        }
    }

    // ===== 表單設定 =====
    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(PurchaseReturn.Code),
                    Label = "退回單號",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入退回單號",
                    IsRequired = true,
                    MaxLength = 30,
                    Order = 1,
                    HelpText = "系統自動生成的唯一退回單號，也可手動修改",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.SupplierId),
                    Label = "篩選廠商",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇廠商",
                    IsRequired = true,
                    MinSearchLength = 0,
                    Order = 2,
                    HelpText = "輸入廠商名稱進行搜尋，或直接選擇",
                    ActionButtons = await GetSupplierActionButtonsAsync(),
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = "FilterProductId", // 篩選用的虛擬欄位
                    Label = "篩選商品",
                    FieldType = FormFieldType.Select,
                    IsRequired = false,
                    Order = 3,
                    Options = await GetFilterProductOptions(),
                    HelpText = "選擇特定商品進行篩選，或留空顯示所有商品",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.PurchaseReceivingId), // 使用實體屬性
                    Label = "篩選進貨單",
                    FieldType = FormFieldType.Select,
                    IsRequired = false,
                    Order = 4,
                    Options = await GetFilterPurchaseReceivingOptions(),
                    HelpText = "選擇特定進貨單進行篩選，或留空顯示所有進貨單",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.ReturnDate),
                    Label = "退回日期",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    Order = 5,
                    HelpText = "請選擇退回日期",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.TotalReturnAmount),
                    Label = "退回總金額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true,
                    Order = 7,
                    HelpText = "系統自動計算的退回總金額"
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.ReturnTaxAmount),
                    Label = TaxCalculationHelper.GenerateTaxAmountLabel("退回稅額", currentTaxRate),
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true,
                    Order = 8,
                    HelpText = TaxCalculationHelper.GenerateTaxAmountHelpText("退回單", currentTaxRate)
                },
                new()
                {
                    PropertyName = nameof(PurchaseReturn.TotalReturnAmountWithTax),
                    Label = "退回含稅總金額",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    IsReadOnly = true,
                    Order = 9,
                    HelpText = "系統自動計算的退回含稅總金額"
                },
                FormFieldConfigurationHelper.CreateRemarksField<PurchaseReturn>(
                    readOnly: hasUndeletableDetails // 根據明細狀態決定是否鎖定
                ),
            };

            formSections = FormSectionHelper<PurchaseReturn>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    pr => pr.Code,
                    pr => pr.SupplierId,
                    pr => pr.PurchaseReceivingId,
                    pr => pr.ReturnDate)
                .AddCustomFields(FormSectionNames.BasicInfo, "FilterProductId")
                .AddToSection(FormSectionNames.AmountInfoAutoCalculated,
                    pr => pr.TotalReturnAmount,
                    pr => pr.ReturnTaxAmount,
                    pr => pr.TotalReturnAmountWithTax)
                .AddToSection(FormSectionNames.AdditionalInfo,
                    pr => pr.Remarks)
                .Build();
            
        }
        catch (Exception)
        {            
            // 確保即使發生錯誤也有基本的表單結構
            formFields = new List<FormFieldDefinition>();
            formSections = new Dictionary<string, string>();
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        if (formFields == null)
        {
            return new List<FormFieldDefinition>();
        }
        return formFields;
    }

    /// <summary>
    /// 處理有不可刪除明細的狀態變更
    /// 當有不可刪除的明細時(已沖款),鎖定主檔的所有可編輯欄位
    /// </summary>
    private async Task HandleHasUndeletableDetailsChanged(bool hasUndeletable)
    {
        try
        {
            hasUndeletableDetails = hasUndeletable;
            
            // 更新欄位的唯讀狀態
            UpdateFieldsReadOnlyState();
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理明細鎖定狀態時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 根據 hasUndeletableDetails 狀態更新欄位的唯讀狀態
    /// </summary>
    private void UpdateFieldsReadOnlyState()
    {
        // 使用 FormFieldLockHelper 批次鎖定/解鎖欄位
        var fieldsToLock = new[]
        {
            nameof(PurchaseReturn.Code),
            "FilterProductId",
            nameof(PurchaseReturn.PurchaseReceivingId),
            nameof(PurchaseReturn.ReturnDate),
            nameof(BaseEntity.Remarks)
        };
        
        // 鎖定或解鎖一般欄位（不需要 ActionButtons）
        FormFieldLockHelper.LockMultipleFieldsSimple(
            formFields, 
            fieldsToLock, 
            isLocked: hasUndeletableDetails
        );
        
        // 特殊處理廠商欄位（需要 ActionButtons）
        if (hasUndeletableDetails)
        {
            // 鎖定：移除 ActionButtons
            FormFieldLockHelper.LockField(
                formFields,
                nameof(PurchaseReturn.SupplierId),
                isLocked: true
            );
        }
        else
        {
            // 解鎖：恢復 ActionButtons
            FormFieldLockHelper.LockField(
                formFields,
                nameof(PurchaseReturn.SupplierId),
                isLocked: false,
                actionButtonsGetter: GetSupplierActionButtonsAsync
            );
        }
    }

    /// <summary>
    /// 取得狀態訊息（頂部徽章）
    /// 當有不可刪除的明細時，顯示鎖定提示
    /// </summary>
    private async Task<(string Message, GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.BadgeVariant Variant, string IconClass)?> 
        GetStatusMessage()
    {
        try
        {
            if (!isDetailDataReady || editModalComponent?.Entity == null)
                return null;
            
            if (hasUndeletableDetails)
            {
                return (
                    "明細有沖款記錄，主檔欄位已鎖定",
                    GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.BadgeVariant.Warning,
                    "fas fa-lock"
                );
            }
            
            return null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetStatusMessage), GetType());
            return null;
        }
    }

    /// <summary>
    /// 取得警告訊息（表單頂部）
    /// 當有不可刪除的明細時，顯示詳細說明
    /// </summary>
    private RenderFragment? GetWarningMessage() => __builder =>
    {
        <GenericLockedFieldMessage IsVisible="@(isDetailDataReady && hasUndeletableDetails)"
                                  Message="因部分明細有沖款記錄，為保護資料完整性主檔欄位已設唯讀。"/>
    };

    /// <summary>
    /// 取得商品篩選選項 - 根據選擇的廠商篩選
    /// </summary>
    private async Task<List<SelectOption>> GetFilterProductOptions()
    {
        try
        {
            var options = new List<SelectOption> {};
            
            // 如果有選擇廠商，只顯示該廠商的產品
            if (editModalComponent?.Entity?.SupplierId > 0)
            {
                var supplierProducts = await ProductService.GetBySupplierAsync(editModalComponent.Entity.SupplierId);
                options.AddRange(supplierProducts.Select(p => new SelectOption
                {
                    Value = p.Id.ToString(),
                    Text = $"{p.Code} - {p.Name}"
                }));
            }
            
            return options;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入商品選項時發生錯誤：{ex.Message}");
            return new List<SelectOption> {};
        }
    }

    /// <summary>
    /// 取得進貨單篩選選項 - 根據選擇的廠商篩選
    /// </summary>
    private async Task<List<SelectOption>> GetFilterPurchaseReceivingOptions()
    {
        try
        {
            var options = new List<SelectOption> {};
            
            // 如果有選擇廠商，只顯示該廠商的進貨單
            if (editModalComponent?.Entity?.SupplierId > 0)
            {
                var supplierReceivings = purchaseReceivings
                    .Where(pr => pr.SupplierId == editModalComponent.Entity.SupplierId)
                    .ToList();
                    
                options.AddRange(supplierReceivings.Select(pr => new SelectOption
                {
                    Value = pr.Id.ToString(),
                    Text = pr.Code ?? string.Empty
                }));
            }
            
            return options;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入進貨單選項時發生錯誤：{ex.Message}");
            return new List<SelectOption> {};
        }
    }

    /// <summary>
    /// 更新商品篩選選項 - 當廠商變更時調用
    /// </summary>
    private async Task UpdateFilterProductOptions(int? supplierId = null)
    {
        try
        {
            // 找到商品篩選欄位並更新其選項
            var filterProductField = formFields.FirstOrDefault(f => f.PropertyName == "FilterProductId");
            if (filterProductField != null)
            {
                var options = new List<SelectOption> {};
                
                if (supplierId.HasValue && supplierId.Value > 0)
                {
                    var supplierProducts = await ProductService.GetBySupplierAsync(supplierId.Value);
                    options.AddRange(supplierProducts.Select(p => new SelectOption
                    {
                        Value = p.Id.ToString(),
                        Text = $"{p.Code} - {p.Name}"
                    }));
                }
                
                filterProductField.Options = options;
                
                // 清空目前的商品篩選選擇
                filterProductId = null;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"更新商品篩選選項時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 更新進貨單篩選選項 - 當廠商變更時調用
    /// </summary>
    private async Task UpdateFilterPurchaseReceivingOptions(int? supplierId = null)
    {
        try
        {
            // 找到進貨單篩選欄位並更新其選項
            var filterReceivingField = formFields.FirstOrDefault(f => f.PropertyName == nameof(PurchaseReturn.PurchaseReceivingId));
            if (filterReceivingField != null)
            {
                var options = new List<SelectOption> {};
                
                if (supplierId.HasValue && supplierId.Value > 0)
                {
                    var supplierReceivings = purchaseReceivings
                        .Where(pr => pr.SupplierId == supplierId.Value)
                        .ToList();
                        
                    options.AddRange(supplierReceivings.Select(pr => new SelectOption
                    {
                        Value = pr.Id.ToString(),
                        Text = pr.Code ?? string.Empty
                    }));
                }
                
                filterReceivingField.Options = options;
                
                // 只在沒有預填值時才清空選擇
                if (!PrefilledPurchaseReceivingId.HasValue || PrefilledPurchaseReceivingId.Value <= 0)
                {
                    filterPurchaseReceivingId = null;
                }
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"更新進貨單篩選選項時發生錯誤：{ex.Message}");
        }
    }

    // ===== Modal 管理器配置方法 =====
    
    /// <summary>
    /// 配置 Modal 管理器
    /// </summary>
    private Dictionary<string, object> GetModalManagers()
    {

        return new Dictionary<string, object>
        {
            { nameof(PurchaseReturn.SupplierId), supplierModalManager ?? new object() }
        };
    }
    
    // ===== ActionButton 產生方法 =====
    
    /// <summary>
    /// 產生廠商操作按鈕 - 使用統一 Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetSupplierActionButtonsAsync()
    {
        var buttons = await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            supplierModalManager, 
            nameof(PurchaseReturn.SupplierId)
        );
        
        return buttons;
    }
    
    // ===== Modal 事件包裝器方法 =====
    
    /// <summary>
    /// 包裝廠商儲存事件
    /// </summary>
    private async Task OnSupplierSavedWrapper(Supplier savedSupplier)
    {
        await supplierModalManager.HandleEntitySavedAsync(savedSupplier, shouldAutoSelect: true);
    }
    
    /// <summary>
    /// 處理開啟相關單據的事件
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            if (args.type == RelatedDocumentType.SetoffDocument)
            {
                // 開啟沖款單
                selectedSetoffDocumentId = args.id;
                showSetoffDocumentModal = true;
                StateHasChanged();
            }
            else
            {
                await NotificationService.ShowWarningAsync("不支援的單據類型", "提示");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"開啟單據失敗：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 處理沖款單儲存後的事件
    /// </summary>
    private async Task HandleSetoffDocumentSaved(SetoffDocument savedDocument)
    {
        try
        {
            showSetoffDocumentModal = false;
            await NotificationService.ShowSuccessAsync("沖款單已更新");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理沖款單儲存事件失敗：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 處理欄位值變更事件 - 使用統一 Helper
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // 當廠商變更時，更新篩選選項
            if (fieldChange.PropertyName == nameof(PurchaseReturn.SupplierId))
            {
                int? supplierId = null;
                if (fieldChange.Value != null && 
                    int.TryParse(fieldChange.Value.ToString(), out int parsedSupplierId) && 
                    parsedSupplierId > 0)
                {
                    supplierId = parsedSupplierId;
                }
                
                // 更新商品和進貨單篩選選項
                await UpdateFilterProductOptions(supplierId);
                await UpdateFilterPurchaseReceivingOptions(supplierId);
                
                //  關鍵：只有在沒有不可刪除明細時才更新 ActionButtons
                if (!hasUndeletableDetails)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        supplierModalManager, 
                        formFields, 
                        nameof(PurchaseReturn.SupplierId), 
                        fieldChange.Value
                    );
                }
                
                StateHasChanged();
            }
            
            // 當商品篩選變更時，更新篩選狀態並觸發重新渲染
            if (fieldChange.PropertyName == "FilterProductId")
            {
                if (fieldChange.Value != null && 
                    int.TryParse(fieldChange.Value.ToString(), out int productId) && 
                    productId > 0)
                {
                    filterProductId = productId;
                }
                else
                {
                    filterProductId = null;
                }
                StateHasChanged();
            }
            
            // 當進貨單篩選變更時，更新篩選狀態並觸發重新渲染
            if (fieldChange.PropertyName == nameof(PurchaseReturn.PurchaseReceivingId))
            {
                if (fieldChange.Value != null && 
                    int.TryParse(fieldChange.Value.ToString(), out int receivingId) && 
                    receivingId > 0)
                {
                    filterPurchaseReceivingId = receivingId;
                }
                else
                {
                    filterPurchaseReceivingId = null;
                }
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理欄位變更時發生錯誤：{ex.Message}");
        }
    }

    // ===== 輔助方法 =====

    /// <summary>
    /// 配置自訂模組
    /// </summary>
    private List<GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.CustomModule> GetCustomModules()
    {
        try
        {

            if (editModalComponent == null)
            {

                return new List<GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.CustomModule>();
            }

            var content = CreateReturnDetailManagerContent();

            return new List<GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.CustomModule>
            {
                new GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.CustomModule
                {
                    Title = "",
                    Order = 1,
                    CssClass = "mt-4",
                    IsVisible = true,
                    Content = content
                }
            };
        }
        catch
        {
            // 如果創建模組時發生錯誤，返回空列表
            return new List<GenericEditModalComponent<PurchaseReturn, IPurchaseReturnService>.CustomModule>();
        }
    }

    /// <summary>
    /// 創建退貨明細管理器內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateReturnDetailManagerContent() => __builder =>
    {
        try
        {

            @if (editModalComponent?.Entity != null)
            {
                @if (!isDetailDataReady)
                {
                    <div class="d-flex justify-content-center align-items-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span class="text-muted">載入明細資料中...</span>
                    </div>
                }
                else if (editModalComponent.Entity.SupplierId > 0)
                {
                    try
                    {

                        <PurchaseReturnTable @ref="purchaseReturnDetailManager"
                            SupplierId="@editModalComponent.Entity.SupplierId"
                            FilterPurchaseReceivingId="@filterPurchaseReceivingId"
                            FilterProductId="@filterProductId"
                            IsEditMode="@(PurchaseReturnId.HasValue)"
                            ExistingReturnDetails="@(purchaseReturnDetails ?? new List<PurchaseReturnDetail>())"
                            OnReturnDetailsChanged="@HandleReturnDetailsChanged"
                            OnHasUndeletableDetailsChanged="@HandleHasUndeletableDetailsChanged"
                            OnOpenRelatedDocument="@HandleOpenRelatedDocument" />
                    }
                    catch (Exception ex)
                    {
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>載入退貨明細管理器時發生錯誤</strong>
                            <br/>錯誤類型：@ex.GetType().Name
                            <br/>錯誤訊息：@ex.Message
                            <br/>請檢查資料完整性或聯繫系統管理員
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-info text-center" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        請先選擇廠商後再進行退貨明細管理
                    </div>
                }
            }
            else
            {
                var componentStatus = editModalComponent == null ? "null" : "not null";
                var entityStatus = editModalComponent?.Entity == null ? "null" : "not null";
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">載入中...</span>
                    </div>
                    <p class="text-muted mt-2">正在載入退貨明細管理器...</p>
                </div>
            }
        }
        catch (Exception ex)
        {
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>載入退貨明細管理器時發生嚴重錯誤</strong>
                <br/>錯誤類型：@ex.GetType().Name
                <br/>錯誤訊息：@ex.Message
                <br/>請重新整理頁面，如問題持續請聯繫系統管理員
                <details class="mt-2">
                    <summary>技術詳情</summary>
                    <pre class="mt-1 small">@ex.StackTrace</pre>
                </details>
            </div>
        }
    };

    /// <summary>
    /// 處理退貨明細變更
    /// </summary>
    private async Task HandleReturnDetailsChanged(List<PurchaseReturnDetail> returnDetails)
    {
        try
        { 
            // 儲存退貨明細到內部狀態
            purchaseReturnDetails = returnDetails ?? new List<PurchaseReturnDetail>();
            
            // 更新主檔的總金額和稅額
            if (editModalComponent?.Entity != null)
            {
                // 1. 計算總金額（未稅）= Σ(退回數量 × 單價)
                editModalComponent.Entity.TotalReturnAmount = purchaseReturnDetails
                    .Where(d => d.ProductId > 0 && d.ReturnQuantity > 0)
                    .Sum(d => d.ReturnQuantity * d.OriginalUnitPrice);
                
                // 2. 計算稅額（使用 TaxCalculationHelper 統一處理）
                editModalComponent.Entity.ReturnTaxAmount = TaxCalculationHelper.CalculateTax(
                    editModalComponent.Entity.TotalReturnAmount, 
                    currentTaxRate
                );
                
                // 3. 含稅總金額會自動計算（TotalReturnAmountWithTax 是計算屬性）
                //    = TotalReturnAmount + ReturnTaxAmount
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理退貨明細變更時發生錯誤：{ex.Message}");
        }
    }



    /// <summary>
    /// 驗證進貨退出明細 - 在儲存主檔之前執行
    /// </summary>
    private async Task<bool> ValidatePurchaseReturnDetailsAsync(PurchaseReturn purchaseReturn)
    {
        try
        {
            // 首先呼叫明細管理器的驗證方法
            if (purchaseReturnDetailManager != null)
            {
                bool isValidDetails = await purchaseReturnDetailManager.ValidateAsync();
                if (!isValidDetails)
                {
                    return false;
                }
            }
            
            // 檢查是否有有效的明細
            var validDetails = purchaseReturnDetails.Where(d => d.ProductId > 0 && d.ReturnQuantity > 0).ToList();
            if (!validDetails.Any())
            {
                await NotificationService.ShowErrorAsync("至少需要一筆退貨明細");
                return false;
            }
            
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"驗證退貨明細時發生錯誤：{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// 自訂儲存邏輯 - 同時儲存主檔和明細
    /// </summary>
    private async Task<bool> SavePurchaseReturnWithDetails(PurchaseReturn purchaseReturn)
    {
        try
        {
            if (purchaseReturn == null)
            {
                return false;
            }
            
            // 先執行自訂驗證
            if (!await ValidatePurchaseReturnDetailsAsync(purchaseReturn))
            {
                return false;
            }
            
            if (PurchaseReturnService == null)
            {
                return false;
            }
            
            if (purchaseReturnDetails == null)
            {
                purchaseReturnDetails = new List<PurchaseReturnDetail>();
            }
                        
            // 呼叫服務的 SaveWithDetailsAsync 方法
            var result = await PurchaseReturnService.SaveWithDetailsAsync(purchaseReturn, purchaseReturnDetails);
            
            if (result == null)
            {
                return false;
            }
            
            if (result.IsSuccess)
            {
                return true;
            }
            else
            {
                await NotificationService.ShowErrorAsync($"儲存失敗：{result.ErrorMessage}");
                return false;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"儲存採購退貨時發生錯誤：{ex.Message}");
            return false;
        }
    }
    
    // ===== 公開方法（供外部組件調用） =====
    
    /// <summary>
    /// 開啟新增進貨退出 Modal 並預填進貨單資訊（公開方法供外部調用）
    /// </summary>
    public async Task ShowAddModalWithPrefilledReceiving(int supplierId, int purchaseReceivingId)
    {
        try
        {
            // 使用 DocumentConversionHelper 統一處理轉單邏輯
            var success = await DocumentConversionHelper.ShowConversionModalAsync(
                setPrefilledValues: () =>
                {
                    PurchaseReturnId = null;
                    PrefilledSupplierId = supplierId;
                    PrefilledPurchaseReceivingId = purchaseReceivingId;
                    //  立即設定篩選ID（確保明細管理器渲染時就能使用正確的篩選參數）
                    filterPurchaseReceivingId = purchaseReceivingId;
                    shouldAutoLoadReturnable = true;
                },
                isVisibleChanged: IsVisibleChanged,
                autoLoadAction: async () =>
                {
                    shouldAutoLoadReturnable = false;
                    if (purchaseReturnDetailManager != null)
                    {
                        await purchaseReturnDetailManager.LoadAllReturnableItems();
                    }
                },
                detailManagerReady: () => purchaseReturnDetailManager != null,
                shouldAutoLoad: () => shouldAutoLoadReturnable,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("轉單流程執行失敗");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledReceiving), GetType(), 
                additionalData: $"開啟預填進貨退出Modal失敗 - SupplierId: {supplierId}, ReceivingId: {purchaseReceivingId}");
            await NotificationService.ShowErrorAsync("開啟進貨退出時發生錯誤");
        }
    }
}

