@* 進貨編輯模態組件 *@
@using ERPCore2.Helpers
@using ERPCore2.Services.Reports
@using ERPCore2.Services.Reports.Interfaces
@inject IPurchaseReceivingService PurchaseReceivingService
@inject IPurchaseReceivingDetailService PurchaseReceivingDetailService
@inject IPurchaseOrderService PurchaseOrderService
@inject IPurchaseOrderDetailService PurchaseOrderDetailService
@inject IWarehouseService WarehouseService
@inject IWarehouseLocationService WarehouseLocationService
@inject INotificationService NotificationService
@inject ISupplierService SupplierService
@inject IEmployeeService EmployeeService
@inject IProductService ProductService
@inject ISystemParameterService SystemParameterService
@inject IPurchaseReturnService PurchaseReturnService
@inject IPurchaseReturnDetailService PurchaseReturnDetailService
@inject ISetoffDocumentService SetoffDocumentService
@inject IReportPrintConfigurationService ReportPrintConfigurationService
@inject IPurchaseReceivingReportService PurchaseReceivingReportService
@inject ActionButtonHelper ActionButtonHelper
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ERPCore2.Data.Context.AppDbContext DbContext
@inject IStringLocalizer<SharedResource> L
@implements IDisposable

<GenericEditModalComponent TEntity="PurchaseReceiving" 
                          TService="IPurchaseReceivingService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@PurchaseReceivingId"
                          Service="@PurchaseReceivingService"
                          EntityName="@L["Entity.PurchaseReceiving"]"
                          EntityNamePlural="@L["Entity.PurchaseReceiving"]"
                          ModalTitle="@(PurchaseReceivingId.HasValue ? L["Message.EditTitle", L["Entity.PurchaseReceiving"]].ToString() : L["Message.CreateTitle", L["Entity.PurchaseReceivingDoc"]].ToString())"
                          Size="GenericEditModalComponent<PurchaseReceiving, IPurchaseReceivingService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@autoCompleteConfig?.Prefillers"
                          AutoCompleteCollections="@autoCompleteConfig?.Collections"
                          AutoCompleteDisplayProperties="@autoCompleteConfig?.DisplayProperties"
                          AutoCompleteValueProperties="@autoCompleteConfig?.ValueProperties"
                          ModalManagers="@modalManagers?.AsDictionary()"
                          DataLoader="@LoadPurchaseReceivingData"
                          UseGenericSave="true"
                          CustomValidator="@ValidatePurchaseReceivingDetailsAsync"
                          AfterSave="@SavePurchaseReceivingDetailsAsync"
                          SaveSuccessMessage="@(PurchaseReceivingId.HasValue ? L["Message.UpdateSuccess", L["Entity.PurchaseReceiving"]].ToString() : L["Message.CreateSuccess", L["Entity.PurchaseReceiving"]].ToString())"
                          SaveFailureMessage="@L["Message.SaveFailure", L["Entity.PurchaseReceiving"]]"
                          RequiredPermission="PurchaseReceiving.Read"
                          OnEntitySaved="@OnPurchaseReceivingSaved"
                          OnCancel="@OnCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          OnTaxMethodChanged="@(() => HandleReceivingDetailsChanged(purchaseReceivingDetails))"
                          GetStatusMessage="@GetPurchaseReceivingStatusMessage"
                          FormHeaderContent="@GetWarningMessage()"
                          TabDefinitions="@tabDefinitions"
                          CustomActionButtons="@GetCustomActionButtons()"
                          ShowPrintButton="true"
                          ReportService="@PurchaseReceivingReportService"
                          ReportId="PO002"
                          ReportPreviewTitle="@L["Label.DocumentPreview", L["Entity.PurchaseReceivingDoc"]]"
                          GetReportDocumentName="@(e => $"進貨單-{e.Code}")"
                          OnEntityLoaded="@HandleEntityLoaded" />

@* 廠商編輯 Modal *@
@if (supplierModalManager != null)
{
    <SupplierEditModalComponent @ref="supplierEditModal"
                               IsVisible="@supplierModalManager.IsModalVisible"
                               IsVisibleChanged="@supplierModalManager.HandleModalVisibilityChangedAsync"
                               SupplierId="@supplierModalManager.SelectedEntityId"
                               PrefilledValues="@supplierModalManager.PrefilledValues"
                               OnSupplierSaved="@supplierModalManager.OnSavedAsync"
                               OnCancel="@supplierModalManager.HandleModalCancelAsync" />
}

@* 商品編輯 Modal *@
@if (productModalManager != null)
{
    <ProductEditModalComponent @ref="productEditModal"
                              IsVisible="@productModalManager.IsModalVisible"
                              IsVisibleChanged="@productModalManager.HandleModalVisibilityChangedAsync"
                              ProductId="@productModalManager.SelectedEntityId"
                              OnProductSaved="@productModalManager.OnSavedAsync"
                              OnCancel="@productModalManager.HandleModalCancelAsync" />
}

@* 進貨退出編輯 Modal *@
<PurchaseReturnEditModalComponent @ref="purchaseReturnEditModal"
                                 IsVisible="@showPurchaseReturnModal"
                                 IsVisibleChanged="@((bool visible) => showPurchaseReturnModal = visible)"
                                 PurchaseReturnId="@selectedPurchaseReturnId"
                                 OnPurchaseReturnSaved="@HandlePurchaseReturnSaved"
                                 OnCancel="@(() => showPurchaseReturnModal = false)" />

@* 沖款單編輯 Modal *@
<SetoffDocumentEditModalComponent @ref="setoffDocumentEditModal"
                                 IsVisible="@showSetoffDocumentModal"
                                 IsVisibleChanged="@((bool visible) => showSetoffDocumentModal = visible)"
                                 SetoffDocumentId="@selectedSetoffDocumentId"
                                 OnSetoffDocumentSaved="@HandleSetoffDocumentSaved"
                                 OnCancel="@(() => showSetoffDocumentModal = false)" />

@* 採購訂單編輯 Modal（從來源採購訂單 Tab 開啟） *@
<PurchaseOrderEditModalComponent @ref="purchaseOrderEditModal"
                                  IsVisible="@showPurchaseOrderModal"
                                  IsVisibleChanged="@((bool visible) => showPurchaseOrderModal = visible)"
                                  PurchaseOrderId="@selectedPurchaseOrderId"
                                  OnCancel="@(() => showPurchaseOrderModal = false)" />

@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? PurchaseReceivingId { get; set; }
    [Parameter] public EventCallback<PurchaseReceiving> OnPurchaseReceivingSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    
    // ===== 預填參數（用於從採購單轉單） =====
    [Parameter] public int? PrefilledSupplierId { get; set; }
    [Parameter] public int? PrefilledPurchaseOrderId { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<PurchaseReceiving, IPurchaseReceivingService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    private List<FormTabDefinition>? tabDefinitions;
    
    // AutoComplete 配置
    private AutoCompleteConfig? autoCompleteConfig;
    
    private List<PurchaseOrder> purchaseOrders = new();
    private List<Warehouse> warehouses = new();
    private List<WarehouseLocation> warehouseLocations = new();
    private List<Supplier> suppliers = new();
    private List<Employee> employees = new();
    private List<Product> products = new();
    
    // ===== 下拉選單選項 =====
    private List<SelectOption> taxCalculationMethodOptions = new();
    
    // ===== 進貨明細 =====
    private List<PurchaseReceivingDetail> purchaseReceivingDetails = new();
    private PurchaseReceivingTable<PurchaseReceiving, PurchaseReceivingDetail>? purchaseReceivingDetailManager;
    
    // 方案 D 改良版：資料版本計數器
    private int _detailsDataVersion = 0;
    
    // ===== 篩選狀態 =====
    private int? filterProductId = null;
    private int? filterPurchaseOrderId = null;
    
    // ===== 快取狀態 - 避免重複查詢 =====
    private int? cachedSupplierId = null;  // 快取的廠商ID
    private List<PurchaseOrder> cachedPurchaseOrders = new();  // 快取的採購單資料
    
    // ===== 防抖動機制 - 避免短時間內重複處理相同變更 =====
    private CancellationTokenSource? _supplierChangeCts;  // 廠商變更的取消令牌
    
    // ===== 鎖定狀態 =====
    private bool hasUndeletableDetails = false;
    
    // ===== 明細載入狀態 =====
    private bool isDetailDataReady = false;  // 標記明細相關資料是否已完整載入（包括退貨數量）
    private bool shouldAutoLoadUnreceived = false;  // 標記是否需要自動載入未入庫商品
    
    // ===== Modal 管理器 =====
    private SupplierEditModalComponent? supplierEditModal;
    private ProductEditModalComponent? productEditModal;
    private RelatedEntityModalManager<Supplier> supplierModalManager = default!;
    private RelatedEntityModalManager<Product> productModalManager = default!;
    private ModalManagerCollection modalManagers = default!;
    
    
    // ===== 相關單據 Modal =====
    private PurchaseReturnEditModalComponent? purchaseReturnEditModal;
    private SetoffDocumentEditModalComponent? setoffDocumentEditModal;
    private bool showPurchaseReturnModal = false;
    private bool showSetoffDocumentModal = false;
    private int? selectedPurchaseReturnId = null;
    private int? selectedSetoffDocumentId = null;

    // ===== Tab 元件參考 =====
    private PurchaseReceivingReturnTab? returnTab;
    private PurchaseReceivingSetoffTab? setoffTab;
    private PurchaseReceivingOrderTab? orderTab;

    // ===== 採購訂單 Modal（從來源採購訂單 Tab 開啟） =====
    private PurchaseOrderEditModalComponent? purchaseOrderEditModal;
    private bool showPurchaseOrderModal = false;
    private int? selectedPurchaseOrderId = null;
    
    // ===== 系統參數 - 稅率快取（避免重複查詢資料庫） =====
    private decimal currentTaxRate = 5.0m; // 預設 5%，實際值會在初始化時從資料庫載入
    
    // ===== 審核開關狀態 =====
    private bool isApprovalEnabled = true; // 是否啟用採購單審核功能（從系統參數載入）

    // ===== 建構函數 =====
    public PurchaseReceivingEditModalComponent()
    {
        // 移除原有的建構函數初始化
        // 現在使用 ModalManagerInitHelper 在 OnInitializedAsync 中統一初始化
    }

    // ===== 必要方法 =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 載入審核開關設定（優先執行,影響後續邏輯）
            isApprovalEnabled = await SystemParameterService.IsPurchaseOrderApprovalEnabledAsync();
            
            // 使用 ModalManagerInitHelper 初始化 Modal 管理器
            modalManagers = ModalManagerInitHelper.CreateBuilder<PurchaseReceiving, IPurchaseReceivingService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Supplier>(nameof(PurchaseReceiving.SupplierId), "廠商")
                .AddManager<Product>("FilterProductId", "商品")
                .Build();
            supplierModalManager = modalManagers.Get<Supplier>(nameof(PurchaseReceiving.SupplierId));
            productModalManager = modalManagers.Get<Product>("FilterProductId");

            // 移除自動載入資料，改為在 OnParametersSetAsync 中根據 IsVisible 載入
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化組件時發生錯誤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        try
        {
            if (IsVisible)
            {
                await LoadAdditionalDataAsync();
                await InitializeFormFieldsAsync();
                
                // 移除此處的更新呼叫，避免與 LoadPurchaseReceivingData 重複
                // LoadPurchaseReceivingData 會在載入實體時自動處理採購單選項更新
            }
            else
            {
                //  Modal 關閉時重置自動載入相關標記
                shouldAutoLoadUnreceived = false;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"參數設置時發生錯誤：{ex.Message}");
        }
    }
    /// <summary>
    /// 取得自訂操作按鈕（顯示在 Modal 頂部左側）
    /// </summary>
    private RenderFragment? GetCustomActionButtons() => __builder =>
    {
        @* 轉庫退出按鈕 - 只在進貨單已儲存時顯示 *@
        @if (editModalComponent?.Entity != null && 
            PurchaseReceivingId.HasValue)
        {
            <GenericButtonComponent Text="@L["Button.ConvertToReturn"]"
                                  Variant="ButtonVariant.Yellow" 
                                  OnClick="HandleCreateReturnFromReceiving" />
            <GenericButtonComponent Text="@L["Button.ConvertToSetoff"]"
                                  Variant="ButtonVariant.Green" 
                                  OnClick="HandleCreateSetoffFromReceiving" />
        }
    };

    /// <summary>
    /// 從進貨單轉庫退出
    /// </summary>
    private async Task HandleCreateReturnFromReceiving()
    {
        try
        {
            // 1. 驗證進貨單資料
            if (!PurchaseReceivingId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("無法轉庫退出：進貨單資料不存在");
                return;
            }
            
            // 2. 驗證廠商資料
            if (editModalComponent.Entity.SupplierId <= 0)
            {
                await NotificationService.ShowWarningAsync("進貨單缺少廠商資訊，無法轉庫退出");
                return;
            }
            
            // 3. 檢查是否有明細
            if (!purchaseReceivingDetails.Any())
            {
                await NotificationService.ShowWarningAsync("進貨單沒有明細資料，無法轉庫退出");
                return;
            }
            
            // 4. 檢查是否有可退回的明細（已入庫數量 > 已退貨數量）
            bool hasReturnableDetails = false;
            foreach (var detail in purchaseReceivingDetails)
            {
                var returnedQty = await PurchaseReturnDetailService.GetReturnedQuantityByReceivingDetailAsync(detail.Id);
                if (detail.ReceivedQuantity > returnedQty)
                {
                    hasReturnableDetails = true;
                    break;
                }
            }
            
            if (!hasReturnableDetails)
            {
                await NotificationService.ShowWarningAsync("進貨單所有明細皆已完成退貨，無需再轉庫退出");
                return;
            }
            
            // 5. 呼叫進貨退出組件的公開方法
            await purchaseReturnEditModal!.ShowAddModalWithPrefilledReceiving(
                editModalComponent.Entity.SupplierId,
                PurchaseReceivingId.Value
            );
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCreateReturnFromReceiving), GetType(), 
                additionalData: $"轉庫退出失敗 - ReceivingId: {PurchaseReceivingId}");
            await NotificationService.ShowErrorAsync("轉庫退出時發生錯誤");
        }
    }

    /// <summary>
    /// 從進貨單轉沖款單
    /// </summary>
    private async Task HandleCreateSetoffFromReceiving()
    {
        try
        {
            // 1. 驗證進貨單資料
            if (!PurchaseReceivingId.HasValue || editModalComponent?.Entity == null)
            {
                await NotificationService.ShowWarningAsync("無法轉沖款：進貨單資料不存在");
                return;
            }
            
            // 2. 驗證廠商資料
            if (editModalComponent.Entity.SupplierId <= 0)
            {
                await NotificationService.ShowWarningAsync("進貨單缺少廠商資訊，無法轉沖款");
                return;
            }
            
            // 3. 檢查是否有明細
            if (!purchaseReceivingDetails.Any())
            {
                await NotificationService.ShowWarningAsync("進貨單沒有明細資料，無法轉沖款");
                return;
            }
            
            // 4. 檢查是否有可沖款的明細（SubtotalAmount > TotalPaidAmount，即有未結清餘額）
            bool hasUnsettledDetails = purchaseReceivingDetails
                .Any(detail => detail.SubtotalAmount > detail.TotalPaidAmount && !detail.IsSettled);
            
            if (!hasUnsettledDetails)
            {
                await NotificationService.ShowWarningAsync("進貨單所有明細皆已完成沖款，無需再轉沖款");
                return;
            }
            
            // 5. 呼叫沖款單組件的公開方法
            await setoffDocumentEditModal!.ShowAddModalWithPrefilledReceiving(
                editModalComponent.Entity.SupplierId,
                PurchaseReceivingId.Value
            );
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCreateSetoffFromReceiving), GetType(), 
                additionalData: $"轉沖款失敗 - ReceivingId: {PurchaseReceivingId}");
            await NotificationService.ShowErrorAsync("轉沖款時發生錯誤");
        }
    }

    /// <summary>
    /// 取得進貨單狀態訊息（顯示鎖定狀態）
    /// </summary>
    private async Task<(string Message, GenericEditModalComponent<PurchaseReceiving, IPurchaseReceivingService>.BadgeVariant Variant, string IconClass)?> GetPurchaseReceivingStatusMessage()
    {
        try
        {
            // 如果資料還沒準備好，不顯示訊息
            if (!isDetailDataReady || editModalComponent?.Entity == null)
                return null;
            
            // 只有在有不可刪除的明細時才顯示鎖定訊息
            if (hasUndeletableDetails)
            {
                return (
                    "明細有其他動作，主檔欄位已鎖定",
                    GenericEditModalComponent<PurchaseReceiving, IPurchaseReceivingService>.BadgeVariant.Warning,
                    "fas fa-lock"
                );
            }
            
            // 正常狀態不顯示訊息
            return null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetPurchaseReceivingStatusMessage), GetType());
            return null;
        }
    }

    /// <summary>
    /// 取得警告訊息（顯示在表單最上方）
    /// </summary>
    private RenderFragment? GetWarningMessage() => __builder =>
    {
        <GenericLockedFieldMessage IsVisible="@(isDetailDataReady && hasUndeletableDetails)"
                                  Message="@EditModalMessages.UndeletableDetailsWarning"/>
    };

    /// <summary>
    /// 載入進貨資料
    /// </summary>
    private async Task<PurchaseReceiving?> LoadPurchaseReceivingData()
    {
        try
        {
            // 重置明細資料準備狀態
            isDetailDataReady = false;
            hasUndeletableDetails = false;
            
            if (!PurchaseReceivingId.HasValue)
            {
                // 新增模式
                var newReceiving = new PurchaseReceiving
                {
                    Code = await EntityCodeGenerationHelper.GenerateForEntity<PurchaseReceiving, IPurchaseReceivingService>(PurchaseReceivingService, DbContext),
                    ReceiptDate = DateTime.Now,
                    SupplierId = PrefilledSupplierId ?? 0,
                };

                // 如果有預填採購單，初始化篩選狀態
                filterPurchaseOrderId = PrefilledPurchaseOrderId;

                //  如果是從採購單轉單，繼承採購單的稅率算法
                if (PrefilledPurchaseOrderId.HasValue && PrefilledPurchaseOrderId.Value > 0)
                {
                    var purchaseOrder = await PurchaseOrderService.GetByIdAsync(PrefilledPurchaseOrderId.Value);
                    if (purchaseOrder != null)
                    {
                        newReceiving.TaxCalculationMethod = purchaseOrder.TaxCalculationMethod;
                    }
                }
                
                // 如果有預填的廠商ID，更新採購單選項和商品篩選選項
                if (newReceiving.SupplierId > 0)
                {
                    await UpdatePurchaseOrderOptions(newReceiving.SupplierId);
                    await UpdateFilterProductOptions(newReceiving.SupplierId);
                }
                
                // 清空明細
                purchaseReceivingDetails.Clear();
                
                // 新增模式下直接標記為準備就緒（沒有明細需要載入）
                isDetailDataReady = true;
                
                return newReceiving;
            }

            // 編輯模式
            var purchaseReceiving = await PurchaseReceivingService.GetByIdAsync(PurchaseReceivingId.Value);
            
            if (purchaseReceiving != null)
            {
                // 載入進貨明細
                await LoadPurchaseReceivingDetails(PurchaseReceivingId.Value);
                
                //  關鍵：載入退貨數量和沖款資料，並更新 hasUndeletableDetails
                await LoadDetailRelatedDataAsync();
                
                //  標記明細資料已準備就緒（包括退貨數量等資訊）
                isDetailDataReady = true;
                
                // 如果有廠商ID，更新採購單選項和商品篩選選項
                if (purchaseReceiving.SupplierId > 0)
                {
                    await UpdatePurchaseOrderOptions(purchaseReceiving.SupplierId);
                    await UpdateFilterProductOptions(purchaseReceiving.SupplierId);
                }
                
                // 採購單 FK 已移至篩選條件（FilterPurchaseOrderId），不再從實體載入
                
                // 觸發重新渲染
                StateHasChanged();
            }
            
            return purchaseReceiving;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入進貨資料時發生錯誤：{ex.Message}");
            isDetailDataReady = true; // 即使錯誤也要允許渲染，避免卡住
            return null;
        }
    }

    /// <summary>
    /// 載入額外資料
    /// </summary>
    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            var tasks = new List<Task>
            {
                LoadPurchaseOrdersAsync(),
                LoadWarehousesAsync(),
                LoadWarehouseLocationsAsync(),
                LoadSuppliersAsync(),
                LoadEmployeesAsync(),
                LoadProductsAsync()
            };
            
            await Task.WhenAll(tasks);
            
            //  一次性載入系統稅率（避免每次計算都查詢資料庫）
            currentTaxRate = await TaxCalculationHelper.LoadTaxRateAsync(SystemParameterService);
            
            taxCalculationMethodOptions = TaxCalculationHelper.GetTaxMethodOptions();
            
            //  在所有資料載入完成後建立 AutoComplete 配置
            // 確保 suppliers、purchaseOrders 和 products 都已載入
            autoCompleteConfig = new AutoCompleteConfigBuilder<PurchaseReceiving>()
                .AddField(nameof(PurchaseReceiving.SupplierId), "CompanyName", suppliers)
                .AddField("FilterPurchaseOrderId", "Code", new List<PurchaseOrder>())  // 初始為空，等廠商選擇後才載入
                .AddFieldWithMultipleSearchProperties(
                    "FilterProductId",  // 虛擬欄位，不是實體屬性
                    "Name",  // 主要顯示欄位
                    products,
                    new[] { "Code", "Name" })  // 可搜尋的欄位
                .Build();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入額外資料時發生錯誤：{ex.Message}");
        }
    }

    private async Task LoadPurchaseOrdersAsync()
    {
        try
        {
            // 使用服務的方法來獲取包含完整關聯資料的採購單
            // 這樣我們可以正確判斷採購單的完成狀態
            purchaseOrders = await PurchaseOrderService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入採購單資料時發生錯誤：{ex.Message}");
            purchaseOrders = new List<PurchaseOrder>();
        }
    }

    private async Task LoadWarehousesAsync()
    {
        try
        {
            warehouses = await WarehouseService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入倉庫資料時發生錯誤：{ex.Message}");
            warehouses = new List<Warehouse>();
        }
    }

    private async Task LoadWarehouseLocationsAsync()
    {
        try
        {
            warehouseLocations = await WarehouseLocationService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入倉庫位置資料時發生錯誤：{ex.Message}");
            warehouseLocations = new List<WarehouseLocation>();
        }
    }

    private async Task LoadSuppliersAsync()
    {
        try
        {
            suppliers = await SupplierService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入廠商資料時發生錯誤：{ex.Message}");
            suppliers = new List<Supplier>();
        }
    }

    private async Task LoadEmployeesAsync()
    {
        try
        {
            var result = await EmployeeService.GetActiveEmployeesAsync();
            if (result.IsSuccess && result.Data != null)
            {
                employees = result.Data;
            }
            else
            {
                employees = new List<Employee>();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入員工資料時發生錯誤：{ex.Message}");
            employees = new List<Employee>();
        }
    }

    private async Task LoadProductsAsync()
    {
        try
        {
            var allProducts = await ProductService.GetActiveProductsAsync();
            products = allProducts.ToList();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入商品資料時發生錯誤：{ex.Message}");
            products = new List<Product>();
        }
    }

    /// <summary>
    /// 更新採購單選項 - 根據廠商ID過濾，並排除已完成的採購單
    /// 同時動態控制欄位的啟用/停用狀態
    /// 使用快取機制避免重複查詢
    /// </summary>
    private async Task UpdatePurchaseOrderOptions(int? supplierId = null)
    {
        try
        {
            // 找到採購單欄位並更新其選項
            var purchaseOrderField = formFields.FirstOrDefault(f => f.PropertyName == "FilterPurchaseOrderId");
            
            if (purchaseOrderField != null)
            {
                if (supplierId.HasValue && supplierId.Value > 0)
                {
                    // 有選擇廠商：啟用欄位（若主檔未鎖定）並載入該廠商的未完成採購單
                    purchaseOrderField.IsReadOnly = hasUndeletableDetails;
                    purchaseOrderField.Placeholder = L["Placeholder.PleaseInputOrSelect", L["Entity.PurchaseOrder"]];
                    
                    // 檢查快取：如果廠商ID相同，直接使用快取資料
                    List<PurchaseOrder> supplierOrders;
                    if (cachedSupplierId == supplierId.Value && cachedPurchaseOrders.Any())
                    {
                        supplierOrders = cachedPurchaseOrders;
                    }
                    else
                    {
                        // 使用新的服務方法獲取包含完整關聯資料的採購單
                        supplierOrders = await PurchaseOrderService.GetIncompleteOrdersBySupplierAsync(supplierId.Value);
                        
                        // 更新快取
                        cachedSupplierId = supplierId.Value;
                        cachedPurchaseOrders = supplierOrders ?? new List<PurchaseOrder>();
                    }
                    
                    // 過濾掉已完成的採購單（加入 null 檢查）
                    var filteredPurchaseOrders = (supplierOrders ?? new List<PurchaseOrder>())
                        .Where(po => !IsOrderFullyCompleted(po))
                        .ToList();
                    
                    // 更新 Options（用於下拉顯示）
                    var options = filteredPurchaseOrders.Select(po => new SelectOption
                    {
                        Value = po.Id.ToString(),
                        Text = po.Code ?? string.Empty
                    }).ToList();
                    purchaseOrderField.Options = options;
                    
                    // 更新 AutoComplete 資料集合（用於搜尋）
                    if (autoCompleteConfig?.Collections != null &&
                        autoCompleteConfig.Collections.ContainsKey("FilterPurchaseOrderId"))
                    {
                        autoCompleteConfig.Collections["FilterPurchaseOrderId"] = filteredPurchaseOrders;
                    }
                }
                else
                {
                    // 清空快取
                    cachedSupplierId = null;
                    cachedPurchaseOrders.Clear();
                    
                    // 沒有選擇廠商：停用欄位並清空選項
                    purchaseOrderField.IsReadOnly = true;
                    purchaseOrderField.Placeholder = L["Placeholder.PleaseInputOrSelect", L["Entity.Supplier"]];
                    purchaseOrderField.Options = new List<SelectOption>();
                    
                    // 清空 AutoComplete 資料集合
                    if (autoCompleteConfig?.Collections != null &&
                        autoCompleteConfig.Collections.ContainsKey("FilterPurchaseOrderId"))
                    {
                        autoCompleteConfig.Collections["FilterPurchaseOrderId"] = new List<PurchaseOrder>();
                    }

                    // 清空篩選採購單
                    filterPurchaseOrderId = null;
                }
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"更新採購單選項時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 判斷採購單是否已完全完成
    /// 完成條件：所有明細都已完成進貨（進貨數量 == 採購數量 或 標記為已完成）
    /// </summary>
    private bool IsOrderFullyCompleted(PurchaseOrder purchaseOrder)
    {
        try
        {
            // 如果沒有明細，視為未完成
            if (purchaseOrder.PurchaseOrderDetails?.Any() != true)
            {
                return false;
            }
            
            // 檢查是否所有明細都已完成
            return purchaseOrder.PurchaseOrderDetails.All(pod => 
            {
                // 檢查該明細是否有對應的進貨記錄且標記為完成
                var hasCompletedReceiving = pod.PurchaseReceivingDetails?.Any(prd => prd.IsReceivingCompleted) == true;
                // 或者已經完全進貨（進貨數量 >= 訂購數量）
                var isQuantityFullyReceived = pod.ReceivedQuantity >= pod.OrderQuantity;
                
                return hasCompletedReceiving || isQuantityFullyReceived;
            });
        }
        catch
        {
            // 如果判斷過程中發生錯誤，預設為未完成以避免遺漏
            return false;
        }
    }

    /// <summary>
    /// 初始化表單欄位
    /// </summary>
    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(PurchaseReceiving.Code),
                    Label = L["Field.PurchaseReceivingCode"],
                    FieldType = FormFieldType.Text,
                    Placeholder = L["Placeholder.AutoGenerated"],
                    IsRequired = true,
                    IsReadOnly = true,
                    MaxLength = 50,
                    HelpText = "系統自動產生的進貨單號"
                },
                new()
                {
                    PropertyName = nameof(PurchaseReceiving.SupplierId),
                    Label = L["Entity.Supplier"],
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = L["Placeholder.PleaseInputOrSelect", L["Entity.Supplier"]],
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "輸入廠商名稱進行篩選，或直接選擇",
                    ActionButtons = await GetSupplierActionButtonsAsync(),
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = "FilterPurchaseOrderId", // 篩選用的虛擬欄位，不儲存至資料庫
                    Label = L["Entity.PurchaseOrder"],
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = L["Placeholder.PleaseInputOrSelect", L["Entity.Supplier"]],
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "請先選擇廠商後，才能選擇該廠商的未完成採購單，或留空使用多採購單模式。此欄位不會儲存。",
                    IsReadOnly = true, // 預設停用，等待廠商選取後由 UpdateFilterFieldsState 更新
                    IsFilterOnly = true
                },
                new()
                {
                    PropertyName = "FilterProductId", // 篩選用的虛擬欄位，不儲存至資料庫
                    Label = L["Entity.Product"],
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = L["Placeholder.PleaseInputOrSelect", L["Entity.Product"]],
                    IsRequired = false,
                    MinSearchLength = 0,
                    HelpText = "選擇特定商品進行篩選，或留空顯示所有商品（僅外購類型）。此欄位不會儲存。",
                    IsReadOnly = true, // 預設停用，等待廠商選取後由 UpdateFilterFieldsState 更新
                    IsFilterOnly = true
                },
                new()
                {
                    PropertyName = nameof(PurchaseReceiving.ReceiptDate),
                    Label = L["Field.ReceiptDate"],
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "貨品實際進貨日",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                new()
                {
                    PropertyName = nameof(PurchaseReceiving.TaxCalculationMethod),
                    Label = L["Field.TaxType"],
                    FieldType = FormFieldType.Select,
                    IsRequired = true,
                    Options = taxCalculationMethodOptions,
                    HelpText = "選擇稅額計算方式：外加稅、內含稅或不含稅",
                    IsReadOnly = hasUndeletableDetails // 根據明細狀態決定是否鎖定
                },
                
                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseReceiving.TotalAmount),
                    Label = L["Field.Amount"],
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "入庫單的總金額，根據明細自動計算",
                    IsReadOnly = true, // 總金額欄位始終為唯讀
                    CssClass = "text-warning fw-bold" // 使用黃色粗體顯示
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseReceiving.PurchaseReceivingTaxAmount),
                    Label = L["Field.TaxAmount"],
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "採購單的稅額，根據總金額和稅率自動計算",
                    IsReadOnly = true, // 稅額欄位始終為唯讀
                    CssClass = "text-info fw-bold" // 使用藍色粗體顯示
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseReceiving.PurchaseReceivingTotalAmountIncludingTax),
                    Label = L["Field.TotalAmount"],
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "採購單的含稅總金額，根據明細自動計算",
                    IsReadOnly = true, // 含稅總金額欄位始終為唯讀
                    CssClass = "text-success fw-bold" // 使用綠色粗體顯示
                },


                FormFieldConfigurationHelper.CreateRemarksField<PurchaseReceiving>(
                    readOnly: hasUndeletableDetails // 根據明細狀態決定是否鎖定
                )
            };

            var layout = FormSectionHelper<PurchaseReceiving>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    pr => pr.Code,
                    pr => pr.SupplierId,
                    pr => pr.ReceiptDate)
                .AddCustomFields(FormSectionNames.FilterConditions, "FilterPurchaseOrderId", "FilterProductId")  // 虛擬篩選欄位，不存DB
                .AddToSection(FormSectionNames.AmountInfo,
                    pr => pr.TaxCalculationMethod,
                    pr => pr.TotalAmount,
                    pr => pr.PurchaseReceivingTaxAmount,
                    pr => pr.PurchaseReceivingTotalAmountIncludingTax)
                .AddToSection(FormSectionNames.OtherInfo,
                    pr => pr.Remarks)
                .GroupIntoTab("進貨資料", "bi-file-earmark-text",
                    FormSectionNames.BasicInfo, FormSectionNames.FilterConditions,
                    FormSectionNames.AmountInfo, FormSectionNames.OtherInfo)
                .GroupIntoCustomTab("進貨明細", "bi-list-ul", CreateReceivingDetailManagerContent())
                .GroupIntoCustomTab("退回記錄", "bi-arrow-return-left", CreateReturnTabContent())
                .GroupIntoCustomTab("沖款記錄", "bi-cash-coin", CreateSetoffTabContent())
                .GroupIntoCustomTab("來源採購訂單", "bi-cart3", CreateOrderTabContent())
                .BuildAll();
            formSections = layout.FieldSections;
            tabDefinitions = layout.TabDefinitions;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"初始化表單欄位時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 更新商品篩選的 AutoComplete 資料集合
    /// 進貨時顯示所有外購類型商品（不根據廠商篩選，因為可以向任何廠商採購任何外購商品）
    /// </summary>
    private async Task UpdateFilterProductOptions(int? supplierId = null)
    {
        try
        {
            if (autoCompleteConfig?.Collections == null)
                return;
            
            // 進貨時始終顯示所有外購商品，不限制廠商
            // 原因：一個外購商品可能向多個廠商採購，不應該限制選擇
            List<Product> filteredProducts = products;
            
            // 更新 AutoComplete 的資料集合
            if (autoCompleteConfig.Collections.ContainsKey("FilterProductId"))
            {
                autoCompleteConfig.Collections["FilterProductId"] = filteredProducts;
            }
            
            // 清空目前的商品篩選選擇
            filterProductId = null;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"更新商品篩選選項時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 取得表單欄位清單
    /// </summary>


    /// <summary>
    // ===== 進貨明細管理方法 =====
    
    /// <summary>
    /// 處理實體載入完成事件（由 GenericEditModalComponent 的導航觸發）
    /// 方案 A + D 重構：明細已由 DataLoader 載入，Table 自動偵測參數變化
    /// 只需處理 UI 刷新
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            UpdateFilterFieldsState();

            if (loadedEntityId > 0)
            {
                if (returnTab != null) await returnTab.LoadAsync(loadedEntityId);
                if (setoffTab != null) await setoffTab.LoadAsync(loadedEntityId);
                if (orderTab != null) await orderTab.LoadAsync(loadedEntityId);
            }
            else
            {
                returnTab?.Clear();
                setoffTab?.Clear();
                orderTab?.Clear();
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleEntityLoaded), GetType(),
                additionalData: $"處理實體載入事件失敗 - EntityId: {loadedEntityId}");
            await NotificationService.ShowErrorAsync("載入明細資料時發生錯誤");
        }
    }
    
    /// <summary>
    /// 載入進貨明細
    /// </summary>
    private async Task LoadPurchaseReceivingDetails(int purchaseReceivingId)
    {
        try
        {
            // 從服務載入進貨明細
            var receiving = await PurchaseReceivingService.GetByIdAsync(purchaseReceivingId);
            purchaseReceivingDetails = receiving?.PurchaseReceivingDetails?.ToList() ?? new List<PurchaseReceivingDetail>();
            
            // 方案 D 改良版：遞增版本號
            _detailsDataVersion++;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入進貨明細失敗：{ex.Message}");
            purchaseReceivingDetails = new List<PurchaseReceivingDetail>();
        }
    }

    /// <summary>
    /// 載入明細相關資料（退貨數量、沖款記錄等）
    /// 這個方法在主檔載入時就同步執行，確保 hasUndeletableDetails 狀態在渲染前就正確
    /// </summary>
    private async Task LoadDetailRelatedDataAsync()
    {
        try
        {
            if (!purchaseReceivingDetails.Any())
            {
                hasUndeletableDetails = false;
                return;
            }

            // 檢查是否有不可刪除的明細
            bool hasUndeletable = false;
            
            foreach (var detail in purchaseReceivingDetails.Where(d => d.Id > 0))
            {
                // 檢查 1：退貨記錄
                var returnedQty = await PurchaseReturnDetailService.GetReturnedQuantityByReceivingDetailAsync(detail.Id);
                if (returnedQty > 0)
                {
                    hasUndeletable = true;
                    break;
                }
                
                // 檢查 2：沖款記錄（直接讀取 TotalPaidAmount 欄位）
                if (detail.TotalPaidAmount > 0)
                {
                    hasUndeletable = true;
                    break;
                }
            }
            
            hasUndeletableDetails = hasUndeletable;
            
            // 如果有不可刪除的明細，立即更新欄位狀態
            if (hasUndeletableDetails)
            {
                UpdateFieldsReadOnlyState();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDetailRelatedDataAsync), GetType());
            hasUndeletableDetails = false; // 錯誤時保守處理，不鎖定
        }
    }

    /// <summary>
    /// 處理進貨明細變更 - 自動計算稅額
    /// </summary>
    /// <summary>
    /// 處理進貨明細變更 - 使用明細獨立稅率計算稅額，支援三種稅率算法
    /// </summary>
    private async Task HandleReceivingDetailsChanged(List<PurchaseReceivingDetail> details)
    {
        try
        {
            editModalComponent?.MarkDirty();
            purchaseReceivingDetails = details ?? new List<PurchaseReceivingDetail>();
            
            // 更新主檔的總金額和稅額
            if (editModalComponent?.Entity != null)
            {
                var (total, tax) = TaxCalculationHelper.CalculateFromDetails(
                    purchaseReceivingDetails,
                    editModalComponent.Entity.TaxCalculationMethod,
                    currentTaxRate,
                    d => d.SubtotalAmount,
                    d => d.TaxRate);
                editModalComponent.Entity.TotalAmount = total;
                editModalComponent.Entity.PurchaseReceivingTaxAmount = tax;

                // 含稅總金額會自動計算（PurchaseReceivingTotalAmountIncludingTax 是計算屬性）

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理明細變更時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 處理已刪除的進貨明細ID
    /// </summary>
    private async Task HandleDeletedDetailsChanged(List<int> deletedDetailIds)
    {
        try
        {
            if (deletedDetailIds?.Any() == true)
            {
                // 如果是編輯模式，實際從資料庫永久刪除
                if (PurchaseReceivingId.HasValue)
                {
                    foreach (var detailId in deletedDetailIds)
                    {
                        var result = await PurchaseReceivingDetailService.PermanentDeleteAsync(detailId);
                        if (!result.IsSuccess)
                        {
                            await NotificationService.ShowErrorAsync($"刪除明細ID {detailId} 失敗: {result.ErrorMessage}");
                            return;
                        }
                    }
                    await NotificationService.ShowSuccessAsync($"已永久刪除 {deletedDetailIds.Count} 筆進貨明細");
                }
                
                // 從本地狀態中移除已刪除的明細
                if (purchaseReceivingDetails != null)
                {
                    purchaseReceivingDetails = purchaseReceivingDetails
                        .Where(detail => !deletedDetailIds.Contains(detail.Id))
                        .ToList();
                }
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"永久刪除進貨明細時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 處理有不可刪除明細的狀態變更
    /// 當有不可刪除的明細時(已退貨或已沖款),鎖定主檔的廠商和採購單欄位
    /// </summary>
    private async Task HandleHasUndeletableDetailsChanged(bool hasUndeletable)
    {
        try
        {
            hasUndeletableDetails = hasUndeletable;
            
            // 更新欄位的唯讀狀態
            UpdateFieldsReadOnlyState();
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理明細鎖定狀態時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 根據 hasUndeletableDetails 狀態更新欄位的唯讀狀態
    /// </summary>
    private void UpdateFieldsReadOnlyState()
    {
        // 統一鎖定/解鎖所有受影響欄位（含 ActionButtons 處理）
        FormFieldLockHelper.LockMultipleFields(
            formFields,
            new[]
            {
                nameof(PurchaseReceiving.ReceiptDate),
                nameof(PurchaseReceiving.TaxCalculationMethod),
                nameof(BaseEntity.Remarks),
                nameof(PurchaseReceiving.SupplierId)
            },
            isLocked: hasUndeletableDetails,
            actionButtonsMap: new Dictionary<string, Func<Task<List<FieldActionButton>>>>
            {
                { nameof(PurchaseReceiving.SupplierId), GetSupplierActionButtonsAsync }
            }
        );

        UpdateFilterFieldsState();
    }

    private void UpdateFilterFieldsState()
    {
        bool noSupplier = !(editModalComponent?.Entity?.SupplierId > 0);
        var purchaseOrderFilter = formFields.FirstOrDefault(f => f.PropertyName == "FilterPurchaseOrderId");
        if (purchaseOrderFilter != null) purchaseOrderFilter.IsReadOnly = noSupplier || hasUndeletableDetails;
        var productFilter = formFields.FirstOrDefault(f => f.PropertyName == "FilterProductId");
        if (productFilter != null) productFilter.IsReadOnly = noSupplier || hasUndeletableDetails;
    }

    /// <summary>
    /// 處理欄位值變更事件
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            bool needsRerender = false; //  標記是否需要重新渲染
            
            // 當廠商變更時，更新採購單選項並清空採購單選擇
            if (fieldChange.PropertyName == nameof(PurchaseReceiving.SupplierId))
            {
                // 取消之前的變更處理（防抖動）
                _supplierChangeCts?.Cancel();
                _supplierChangeCts = new CancellationTokenSource();
                var currentCts = _supplierChangeCts;
                
                // 清空採購單篩選
                filterPurchaseOrderId = null;
                
                // 更新採購單選項
                int? supplierId = null;
                if (fieldChange.Value != null && 
                    int.TryParse(fieldChange.Value.ToString(), out int parsedSupplierId) && 
                    parsedSupplierId > 0)
                {
                    supplierId = parsedSupplierId;
                }
                
                // 延遲 100ms 執行，避免短時間內重複觸發
                try
                {
                    await Task.Delay(100, currentCts.Token);
                    
                    // 檢查是否已被取消
                    if (currentCts.IsCancellationRequested)
                    {
                        return;
                    }
                    
                    await UpdatePurchaseOrderOptions(supplierId);

                    // 更新商品篩選的選項清單
                    await UpdateFilterProductOptions(supplierId);

                    // 廠商變更時更新篩選欄位停用狀態
                    bool noSupplier = !supplierId.HasValue;
                    var purchaseOrderFilter = formFields.FirstOrDefault(f => f.PropertyName == "FilterPurchaseOrderId");
                    if (purchaseOrderFilter != null) purchaseOrderFilter.IsReadOnly = noSupplier || hasUndeletableDetails;
                    var productFilter = formFields.FirstOrDefault(f => f.PropertyName == "FilterProductId");
                    if (productFilter != null) productFilter.IsReadOnly = noSupplier || hasUndeletableDetails;

                    needsRerender = true; // 廠商變更需要重新渲染
                }
                catch (TaskCanceledException)
                {
                    // 正常的取消，不需要處理
                    return;
                }
            }
            // 當採購單篩選變更時，更新篩選狀態並觸發重新渲染
            else if (fieldChange.PropertyName == "FilterPurchaseOrderId")
            {
                var valueStr = fieldChange.Value?.ToString();
                if (string.IsNullOrWhiteSpace(valueStr) || valueStr == "0")
                    filterPurchaseOrderId = null;
                else if (int.TryParse(valueStr, out var parsedId) && parsedId > 0)
                    filterPurchaseOrderId = parsedId;
                else
                    filterPurchaseOrderId = null;
                needsRerender = true;
            }
            // 當商品篩選變更時，更新篩選狀態並觸發重新渲染
            else if (fieldChange.PropertyName == "FilterProductId")
            {
                if (fieldChange.Value != null &&
                    int.TryParse(fieldChange.Value.ToString(), out int productId) &&
                    productId > 0)
                {
                    filterProductId = productId;
                }
                else
                {
                    filterProductId = null;
                }

                needsRerender = true; // 需要重新渲染以讓 PurchaseReceivingTable 收到新的 FilterProductId
            }
            
            //  只在真正需要時才呼叫一次 StateHasChanged
            if (needsRerender)
            {
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理欄位變更時發生錯誤：{ex.Message}");
        }
    }

    /// <summary>
    /// 驗證進貨明細 - 在儲存主檔之前執行
    /// </summary>
    private async Task<bool> ValidatePurchaseReceivingDetailsAsync(PurchaseReceiving purchaseReceiving)
    {
        try
        {
            // 如果明細管理組件存在，執行驗證
            if (purchaseReceivingDetailManager != null)
            {
                var isValid = await purchaseReceivingDetailManager.ValidateAsync();
                return isValid;
            }
            
            // 如果組件不存在，預設通過驗證
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"驗證明細時發生錯誤：{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// AfterSave 回調方法 - 在主檔儲存後處理明細並使用差異比較更新庫存
    /// 處理流程：
    /// 1. 儲存有效的明細資料（有選擇商品和倉庫的記錄）
    /// 2. 更新主檔總金額
    /// 3. 使用新的 UpdateInventoryByDifferenceAsync 方法進行庫存差異更新
    /// 4. 差異更新邏輯：
    ///    - 比較編輯前後明細的變化
    ///    - 只針對變更的部分進行庫存調整
    ///    - 新增：直接增加庫存
    ///    - 修改：調整庫存差異（增加或減少）
    ///    - 刪除：回退庫存
    ///    - 商品替換：從原商品減去庫存，向新商品增加庫存
    /// </summary>
    private async Task SavePurchaseReceivingDetailsAsync(PurchaseReceiving purchaseReceiving)
    {
        try
        {
            // 只有在進貨單ID存在時才處理明細
            if (purchaseReceiving.Id <= 0)
            {
                return;
            }

            // 過濾有效的明細（有選擇商品和倉庫的）
            var validDetails = purchaseReceivingDetails
                .Where(detail => detail.ProductId > 0 && detail.WarehouseId > 0)
                .ToList();

            if (validDetails.Any())
            {
                // 更新明細資訊 - 使用獨立的服務調用，避免嵌套交易
                foreach (var detail in validDetails)
                {
                    detail.PurchaseReceivingId = purchaseReceiving.Id;
                    
                    // 同步主檔的批號到明細
                    if (!string.IsNullOrWhiteSpace(purchaseReceiving.BatchNumber))
                    {
                        detail.BatchNumber = purchaseReceiving.BatchNumber;
                    }
                    
                    if (detail.Id == 0)
                    {
                        // 新記錄 - 使用基本的 Create 方法
                        var createResult = await PurchaseReceivingDetailService.CreateAsync(detail);
                        if (!createResult.IsSuccess)
                        {
                            await NotificationService.ShowWarningAsync($"明細儲存警告：{createResult.ErrorMessage}");
                        }
                    }
                    else
                    {
                        // 更新現有記錄 - 使用基本的 Update 方法
                        var updateResult = await PurchaseReceivingDetailService.UpdateAsync(detail);
                        if (!updateResult.IsSuccess)
                        {
                            await NotificationService.ShowWarningAsync($"明細更新警告：{updateResult.ErrorMessage}");
                        }
                    }
                }

                // 重新載入明細資料以更新UI顯示
                purchaseReceivingDetails = await PurchaseReceivingDetailService.GetByPurchaseReceivingIdAsync(purchaseReceiving.Id);
            }

            // 更新主檔的總金額和稅額（使用明細稅額加總算法）
            purchaseReceiving.TotalAmount = purchaseReceivingDetails.Sum(d => d.SubtotalAmount);
            
            // 【新式算法】每筆明細分別計算稅額，再加總（支援不同商品不同稅率）
            purchaseReceiving.PurchaseReceivingTaxAmount = purchaseReceivingDetails.Sum(d => 
            {
                // 使用明細的稅率，若無則使用系統預設值
                var detailTaxRate = d.TaxRate ?? currentTaxRate;
                // 計算此筆明細的稅額 = 小計 × 稅率%
                var detailTaxAmount = d.SubtotalAmount * (detailTaxRate / 100m);
                return Math.Round(detailTaxAmount, 2);
            });
            
            if (purchaseReceiving.TotalAmount > 0)
            {
                var updateResult = await PurchaseReceivingService.UpdateAsync(purchaseReceiving);
                if (!updateResult.IsSuccess)
                {
                    await NotificationService.ShowWarningAsync($"總金額更新警告：{updateResult.ErrorMessage}");
                }
            }

            // 更新相關採購單明細的已進貨量（僅處理有採購單的明細）
            if (validDetails.Any())
            {
                var uniquePurchaseOrderDetailIds = validDetails
                    .Where(d => d.PurchaseOrderDetailId.HasValue && d.PurchaseOrderDetailId.Value > 0)
                    .Select(d => d.PurchaseOrderDetailId!.Value)
                    .Distinct();

                foreach (var purchaseOrderDetailId in uniquePurchaseOrderDetailIds)
                {
                    var recalculateResult = await PurchaseOrderDetailService.RecalculateReceivedQuantityAsync(purchaseOrderDetailId);
                    if (!recalculateResult.IsSuccess)
                    {
                        await NotificationService.ShowWarningAsync($"採購單明細已進貨量更新失敗：{recalculateResult.ErrorMessage}");
                    }
                }
            }

            // 使用差異比較進行庫存更新 - 避免重複累加和商品替換問題
            if (validDetails.Any())
            {
                try
                {
                    // 判斷是新增還是編輯模式
                    bool isEditMode = PurchaseReceivingId.HasValue && PurchaseReceivingId.Value > 0;
                    
                    if (isEditMode)
                    {
                        // 編輯模式：使用差異比較更新庫存
                        var differenceResult = await PurchaseReceivingService.UpdateInventoryByDifferenceAsync(purchaseReceiving.Id, 0);
                        if (differenceResult.IsSuccess)
                        {
                            await NotificationService.ShowSuccessAsync("進貨明細儲存成功，庫存已差異更新");
                        }
                        else
                        {
                            await NotificationService.ShowWarningAsync($"明細儲存成功，但庫存差異更新失敗：{differenceResult.ErrorMessage}");
                        }
                    }
                    else
                    {
                        // 新增模式：只在第一次新增時使用確認流程，避免重複更新庫存
                        // 檢查是否已經有庫存交易記錄，避免重複確認
                        var hasExistingTransactions = await HasExistingInventoryTransactions(purchaseReceiving.Code ?? string.Empty);
                        
                        if (!hasExistingTransactions)
                        {
                            var confirmResult = await PurchaseReceivingService.ConfirmReceiptAsync(purchaseReceiving.Id, 0);
                            if (confirmResult.IsSuccess)
                            {
                                await NotificationService.ShowSuccessAsync("進貨明細儲存成功，庫存已自動更新");
                            }
                            else
                            {
                                await NotificationService.ShowWarningAsync($"明細儲存成功，但庫存更新失敗：{confirmResult.ErrorMessage}");
                            }
                        }
                        else
                        {
                            await NotificationService.ShowInfoAsync("進貨明細儲存成功，庫存已存在無需重複更新");
                        }
                    }
                }
                catch (Exception ex)
                {
                    await NotificationService.ShowWarningAsync($"明細儲存成功，但庫存更新發生錯誤：{ex.Message}");
                }
            }

            StateHasChanged(); // 通知UI更新
        }
        catch (Exception ex)
        {
            // 記錄錯誤但不中斷流程，因為主要實體已經儲存成功
            await NotificationService.ShowWarningAsync($"明細處理時發生警告：{ex.Message}");
        }
    }

    /// <summary>
    /// 檢查是否已經存在庫存交易記錄
    /// </summary>
    private Task<bool> HasExistingInventoryTransactions(string receiptNumber)
    {
        try
        {
            // 這裡可以通過庫存服務檢查是否已存在相關交易記錄
            // 暫時返回 false，表示總是允許進行庫存更新
            // 如果需要更嚴格的檢查，可以注入 IInventoryTransactionService 進行查詢
            return Task.FromResult(false);
        }
        catch
        {
            // 發生錯誤時返回 false，允許庫存更新
            return Task.FromResult(false);
        }
    }

    /// <summary>
    /// 創建進貨明細管理器內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateReceivingDetailManagerContent() => __builder =>
    {
        <DetailSectionWrapper IsEntityReady="@(editModalComponent?.Entity != null)"
                              EntityLoadingVariant="DetailSectionWrapper.LoadingVariant.Text"
                              EntityLoadingMessage="請先選擇廠商後再管理進貨明細"
                              IsDetailDataReady="@isDetailDataReady"
                              IsPreconditionMet="@(editModalComponent?.Entity?.SupplierId > 0)"
                              PreconditionMessage="請先選擇廠商後再進行採購明細管理">
            <PurchaseReceivingTable @ref="purchaseReceivingDetailManager"
                                    TMainEntity="PurchaseReceiving"
                                    TDetailEntity="PurchaseReceivingDetail"
                                    SelectedSupplierId="@editModalComponent!.Entity.SupplierId"
                                    SelectedPurchaseOrderId="@filterPurchaseOrderId"
                                    FilterProductId="@filterProductId"
                                    SelectedSupplierName="@GetSelectedSupplierName()"
                                    SelectedPurchaseOrderCode="@GetSelectedPurchaseOrderCode()"
                                    FilterProductName="@GetFilterProductName()"
                                    TaxCalculationMethod="@editModalComponent.Entity.TaxCalculationMethod"
                                    MainEntity="@editModalComponent.Entity"
                                    ExistingDetails="@purchaseReceivingDetails"
                                    DataVersion="@_detailsDataVersion"
                                    IsParentLoading="@(editModalComponent?.IsLoading ?? false)"
                                    OnDetailsChanged="@HandleReceivingDetailsChanged"
                                    OnDeletedDetailsChanged="@HandleDeletedDetailsChanged"
                                    OnHasUndeletableDetailsChanged="@HandleHasUndeletableDetailsChanged"
                                    OnOpenRelatedDocument="@HandleOpenRelatedDocument"
                                    MainEntityIdPropertyName="PurchaseReceivingId"
                                    QuantityPropertyName="ReceivedQuantity"
                                    UnitPricePropertyName="UnitPrice"
                                    RemarksPropertyName="Remarks"
                                    PurchaseOrderDetailIdPropertyName="PurchaseOrderDetailId"
                                    ShowWarehouse="true"
                                    ShowWarehouseLocation="true"
                                    WarehouseIdPropertyName="WarehouseId"
                                    WarehouseLocationIdPropertyName="WarehouseLocationId"
                                    Warehouses="@warehouses"
                                    WarehouseLocations="@warehouseLocations"
                                    IsReadOnly="false" />
        </DetailSectionWrapper>
    };
    
    /// <summary>退回記錄 Tab 內容</summary>
    private RenderFragment CreateReturnTabContent() => __builder =>
    {
        <PurchaseReceivingReturnTab @ref="returnTab"
                                    OnOpenReturn="@HandleOpenPurchaseReturn" />
    };

    /// <summary>沖款記錄 Tab 內容</summary>
    private RenderFragment CreateSetoffTabContent() => __builder =>
    {
        <PurchaseReceivingSetoffTab @ref="setoffTab"
                                    OnOpenSetoff="@HandleOpenSetoffFromTab" />
    };

    /// <summary>來源採購訂單 Tab 內容</summary>
    private RenderFragment CreateOrderTabContent() => __builder =>
    {
        <PurchaseReceivingOrderTab @ref="orderTab"
                                   OnOpenOrder="@HandleOpenPurchaseOrder" />
    };

    private void HandleOpenPurchaseReturn(int id)
    {
        selectedPurchaseReturnId = id;
        showPurchaseReturnModal = true;
        StateHasChanged();
    }

    private void HandleOpenSetoffFromTab(int id)
    {
        selectedSetoffDocumentId = id;
        showSetoffDocumentModal = true;
        StateHasChanged();
    }

    private void HandleOpenPurchaseOrder(int id)
    {
        selectedPurchaseOrderId = id;
        showPurchaseOrderModal = true;
        StateHasChanged();
    }

    // ===== 輔助方法：取得選項名稱 =====

    private string? GetSelectedSupplierName()
        => EntityDisplayHelper.GetDisplayValue(editModalComponent?.Entity?.SupplierId, suppliers, s => s.CompanyName);

    private string? GetSelectedPurchaseOrderCode()
        => EntityDisplayHelper.GetDisplayValue(filterPurchaseOrderId, purchaseOrders, po => po.Code);

    private string? GetFilterProductName()
        => EntityDisplayHelper.GetDisplayValue(filterProductId, products, p => $"{p.Code} {p.Name}");
    
    // ===== ActionButton 產生方法 =====    /// <summary>
    /// 產生廠商操作按鈕 - 使用統一 Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetSupplierActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            supplierModalManager, 
            nameof(PurchaseReceiving.SupplierId)
        );
    }


    /// <summary>
    /// 處理開啟相關單據的事件
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            if (args.type == RelatedDocumentType.ReturnDocument)
            {
                // 開啟進貨退出 Modal
                selectedPurchaseReturnId = args.id;
                showPurchaseReturnModal = true;
            }
            else if (args.type == RelatedDocumentType.SetoffDocument)
            {
                // 開啟沖款單 Modal
                selectedSetoffDocumentId = args.id;
                showSetoffDocumentModal = true;
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"開啟單據失敗：{ex.Message}");
        }
    }

    /// <summary>
    /// 處理進貨退出儲存後的事件
    /// </summary>
    /// <summary>
    /// 處理進貨退出儲存後的事件
    /// 使用 ChildDocumentRefreshHelper 統一處理刷新邏輯
    /// </summary>
    private async Task HandlePurchaseReturnSaved(PurchaseReturn savedReturn)
    {
        await ChildDocumentRefreshHelper.HandleChildDocumentSavedWithCustomRefreshAsync(
            closeModal: () =>
            {
                showPurchaseReturnModal = false;
                selectedPurchaseReturnId = null;
            },
            customRefresh: async () =>
            {
                //  關鍵修復：呼叫 Table 組件的公開刷新方法
                // 重新載入進貨明細的退貨數量資訊
                if (purchaseReceivingDetailManager != null)
                {
                    await purchaseReceivingDetailManager.LoadReturnedQuantitiesAsync();
                }
            },
            stateHasChanged: StateHasChanged,
            invokeAsync: InvokeAsync
        );
    }

    /// <summary>
    /// 處理沖款單儲存後的事件
    /// 使用 ChildDocumentRefreshHelper 簡化版處理
    /// </summary>
    private async Task HandleSetoffDocumentSaved(SetoffDocument savedDocument)
    {
        await ChildDocumentRefreshHelper.HandleChildDocumentSavedSimpleAsync(
            closeModal: () =>
            {
                showSetoffDocumentModal = false;
                selectedSetoffDocumentId = null;
            },
            stateHasChanged: StateHasChanged
        );
    }

    // ===== 公開方法（供外部組件調用） =====
    
    /// <summary>
    /// 組件渲染完成後的回調
    /// </summary>
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        // 自動載入邏輯已移至 ShowAddModalWithPrefilledOrder 方法中
    }
    
    /// <summary>
    /// 開啟新增進貨單 Modal 並預填採購單資訊（公開方法供外部調用）
    /// </summary>
    public async Task ShowAddModalWithPrefilledOrder(int supplierId, int purchaseOrderId)
    {
        try
        {
            // 使用 DocumentConversionHelper 統一處理轉單邏輯
            var success = await DocumentConversionHelper.ShowConversionModalAsync(
                setPrefilledValues: () =>
                {
                    PurchaseReceivingId = null;
                    PrefilledSupplierId = supplierId;
                    PrefilledPurchaseOrderId = purchaseOrderId;
                    shouldAutoLoadUnreceived = true;
                },
                isVisibleChanged: IsVisibleChanged,
                autoLoadAction: async () =>
                {
                    shouldAutoLoadUnreceived = false;
                    if (purchaseReceivingDetailManager != null)
                    {
                        await purchaseReceivingDetailManager.LoadAllUnreceivedItems();
                    }
                },
                detailManagerReady: () => purchaseReceivingDetailManager != null,
                shouldAutoLoad: () => shouldAutoLoadUnreceived,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("轉單流程執行失敗");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledOrder), GetType(), 
                additionalData: $"開啟預填進貨單Modal失敗 - SupplierId: {supplierId}, OrderId: {purchaseOrderId}");
            await NotificationService.ShowErrorAsync("開啟進貨單時發生錯誤");
        }
    }

    /// <summary>
    /// 釋放資源
    /// </summary>
    public void Dispose()
    {
        try
        {
            // 取消任何進行中的防抖動操作
            _supplierChangeCts?.Cancel();
            _supplierChangeCts?.Dispose();
            
            // 清理任何需要清理的資源
            purchaseReceivingDetails?.Clear();
            formFields?.Clear();
            formSections?.Clear();
            purchaseOrders?.Clear();
            warehouses?.Clear();
            warehouseLocations?.Clear();
            suppliers?.Clear();
            employees?.Clear();
            products?.Clear();
            cachedPurchaseOrders?.Clear();
        }
        catch
        {
            // 忽略清理過程中的錯誤
        }
    }
}
