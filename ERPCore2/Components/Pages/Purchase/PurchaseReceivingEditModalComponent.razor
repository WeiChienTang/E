@* é€²è²¨ç·¨è¼¯æ¨¡æ…‹çµ„ä»¶ *@
@inject IPurchaseReceivingService PurchaseReceivingService
@inject IPurchaseReceivingDetailService PurchaseReceivingDetailService
@inject IPurchaseOrderService PurchaseOrderService
@inject IPurchaseOrderDetailService PurchaseOrderDetailService
@inject IWarehouseService WarehouseService
@inject IWarehouseLocationService WarehouseLocationService
@inject INotificationService NotificationService
@inject ISupplierService SupplierService
@inject IEmployeeService EmployeeService
@inject IProductService ProductService
@inject ISystemParameterService SystemParameterService
@inject IPurchaseReturnService PurchaseReturnService
@inject IPurchaseReturnDetailService PurchaseReturnDetailService
@inject ISetoffDocumentService SetoffDocumentService
@inject IReportPrintConfigurationService ReportPrintConfigurationService
@inject ActionButtonHelper ActionButtonHelper
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@implements IDisposable

<GenericEditModalComponent TEntity="PurchaseReceiving" 
                          TService="IPurchaseReceivingService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          Id="@PurchaseReceivingId"
                          Service="@PurchaseReceivingService"
                          EntityName="é€²è²¨"
                          EntityNamePlural="é€²è²¨"
                          ModalTitle="@(PurchaseReceivingId.HasValue ? "ç·¨è¼¯é€²è²¨" : "æ–°å¢é€²è²¨å–®")"
                          Size="GenericEditModalComponent<PurchaseReceiving, IPurchaseReceivingService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@GetAutoCompletePrefillers()"
                          AutoCompleteCollections="@GetAutoCompleteCollections()"
                          AutoCompleteDisplayProperties="@GetAutoCompleteDisplayProperties()"
                          AutoCompleteValueProperties="@GetAutoCompleteValueProperties()"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadPurchaseReceivingData"
                          AdditionalDataLoader="@LoadAdditionalDataAsync"
                          UseGenericSave="true"
                          CustomValidator="@ValidatePurchaseReceivingDetailsAsync"
                          AfterSave="@SavePurchaseReceivingDetailsAsync"
                          SaveSuccessMessage="@(PurchaseReceivingId.HasValue ? "é€²è²¨æ›´æ–°æˆåŠŸ" : "é€²è²¨æ–°å¢æˆåŠŸ")"
                          SaveFailureMessage="é€²è²¨å„²å­˜å¤±æ•—"
                          RequiredPermission="PurchaseReceiving.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          GetStatusMessage="@GetPurchaseReceivingStatusMessage"
                          FormHeaderContent="@GetWarningMessage()"
                          CustomModules="@GetCustomModules()"
                          ShowPrintButton="true"
                          OnPrint="@HandlePrint" />

@* å» å•†ç·¨è¼¯ Modal *@
<SupplierEditModalComponent @ref="supplierEditModal"
                           IsVisible="@supplierModalManager.IsModalVisible"
                           IsVisibleChanged="@supplierModalManager.HandleModalVisibilityChangedAsync"
                           SupplierId="@supplierModalManager.SelectedEntityId"
                           PrefilledValues="@supplierModalManager.PrefilledValues"
                           OnSupplierSaved="@OnSupplierSavedWrapper"
                           OnCancel="@supplierModalManager.HandleModalCancelAsync" />

@* é€²è²¨é€€å‡ºç·¨è¼¯ Modal *@
<PurchaseReturnEditModalComponent @ref="purchaseReturnEditModal"
                                 IsVisible="@showPurchaseReturnModal"
                                 IsVisibleChanged="@((bool visible) => showPurchaseReturnModal = visible)"
                                 PurchaseReturnId="@selectedPurchaseReturnId"
                                 OnPurchaseReturnSaved="@HandlePurchaseReturnSaved"
                                 OnCancel="@(() => showPurchaseReturnModal = false)" />

@* æ²–æ¬¾å–®ç·¨è¼¯ Modal *@
<SetoffDocumentEditModalComponent @ref="setoffDocumentEditModal"
                                 IsVisible="@showSetoffDocumentModal"
                                 IsVisibleChanged="@((bool visible) => showSetoffDocumentModal = visible)"
                                 SetoffDocumentId="@selectedSetoffDocumentId"
                                 OnSetoffDocumentSaved="@HandleSetoffDocumentSaved"
                                 OnCancel="@(() => showSetoffDocumentModal = false)" />

@code {
    // ===== å¿…è¦åƒæ•¸ =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? PurchaseReceivingId { get; set; }
    [Parameter] public EventCallback<PurchaseReceiving> OnPurchaseReceivingSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== å…§éƒ¨ç‹€æ…‹ =====
    private GenericEditModalComponent<PurchaseReceiving, IPurchaseReceivingService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    private List<PurchaseOrder> purchaseOrders = new();
    private List<Warehouse> warehouses = new();
    private List<WarehouseLocation> warehouseLocations = new();
    private List<Supplier> suppliers = new();
    private List<Employee> employees = new();
    private List<Product> products = new();
    
    // ===== é€²è²¨æ˜ç´° =====
    private List<PurchaseReceivingDetail> purchaseReceivingDetails = new();
    private PurchaseReceivingDetailManagerComponent<PurchaseReceiving, PurchaseReceivingDetail>? purchaseReceivingDetailManager;
    
    // ===== ç¯©é¸ç‹€æ…‹ =====
    private int? filterProductId = null;
    
    // ===== é–å®šç‹€æ…‹ =====
    private bool hasUndeletableDetails = false;
    
    // ===== æ˜ç´°è¼‰å…¥ç‹€æ…‹ =====
    private bool isDetailDataReady = false;  // æ¨™è¨˜æ˜ç´°ç›¸é—œè³‡æ–™æ˜¯å¦å·²å®Œæ•´è¼‰å…¥ï¼ˆåŒ…æ‹¬é€€è²¨æ•¸é‡ï¼‰
    
    // ===== Modal ç®¡ç†å™¨ =====
    private SupplierEditModalComponent? supplierEditModal;
    private RelatedEntityModalManager<Supplier> supplierModalManager = default!;
    
    // ===== ç›¸é—œå–®æ“š Modal =====
    private PurchaseReturnEditModalComponent? purchaseReturnEditModal;
    private SetoffDocumentEditModalComponent? setoffDocumentEditModal;
    private bool showPurchaseReturnModal = false;
    private bool showSetoffDocumentModal = false;
    private int? selectedPurchaseReturnId = null;
    private int? selectedSetoffDocumentId = null;
    
    // ===== ç³»çµ±åƒæ•¸ - ç¨…ç‡å¿«å–ï¼ˆé¿å…é‡è¤‡æŸ¥è©¢è³‡æ–™åº«ï¼‰ =====
    private decimal currentTaxRate = 5.0m; // é è¨­ 5%ï¼Œå¯¦éš›å€¼æœƒåœ¨åˆå§‹åŒ–æ™‚å¾è³‡æ–™åº«è¼‰å…¥

    // ===== å¿…è¦æ–¹æ³• =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // åˆå§‹åŒ– Modal ç®¡ç†å™¨
            InitializeSupplierModalManager();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–çµ„ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        try
        {
            if (IsVisible)
            {
                await LoadAdditionalDataAsync();
                await InitializeFormFieldsAsync();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"åƒæ•¸è¨­ç½®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è™•ç†å„²å­˜æˆåŠŸäº‹ä»¶
    /// </summary>
    private async Task HandleSaveSuccess()
    {
        try
        {
            // å¦‚æœçˆ¶çµ„ä»¶éœ€è¦çŸ¥é“é€²è²¨å·²å„²å­˜
            if (OnPurchaseReceivingSaved.HasDelegate && editModalComponent?.Entity != null)
            {
                await OnPurchaseReceivingSaved.InvokeAsync(editModalComponent.Entity);
            }
            // ä¸éœ€è¦æ‰‹å‹•é—œé–‰ Modalï¼ŒGenericEditModalComponent æœƒè™•ç†
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†æˆåŠŸäº‹ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è™•ç†å–æ¶ˆäº‹ä»¶
    /// </summary>
    private async Task HandleCancel()
    {
        try
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }
            // ä¸è¦ç›´æ¥èª¿ç”¨ CloseModalï¼Œè®“ GenericEditModalComponent è™•ç†
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é—œé–‰è¦–çª—æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è™•ç†åˆ—å°äº‹ä»¶
    /// </summary>
    private async Task HandlePrint()
    {
        try
        {
            // ä½¿ç”¨é€šç”¨ Helper é€²è¡Œå®Œæ•´é©—è­‰ï¼ˆå¯¦é«”ã€IDï¼‰
            // é€²è²¨å–®ä¸éœ€è¦æ ¸å‡†å³å¯åˆ—å°
            var (isValid, errorMessage) = ReportPrintHelper.ValidateForPrint(
                entity: editModalComponent?.Entity,
                entityId: PurchaseReceivingId,
                isApproved: true, // é€²è²¨å–®ä¸éœ€è¦æ ¸å‡†ç‹€æ…‹
                entityName: "é€²è²¨å–®",
                requireApproval: false // ä¸éœ€è¦æ ¸å‡†
            );
            
            if (!isValid)
            {
                await NotificationService.ShowWarningAsync(errorMessage);
                return;
            }
            
            // ç›´æ¥åŸ·è¡Œåˆ—å°ï¼Œä½¿ç”¨é è¨­è¨­å®š
            await HandleDirectPrint(null);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePrint), GetType(), 
                additionalData: $"é€²è²¨å–®åˆ—å°è™•ç†å¤±æ•— - ID: {PurchaseReceivingId}");
            await NotificationService.ShowErrorAsync("åˆ—å°è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    /// <summary>
    /// ç›´æ¥åŸ·è¡Œåˆ—å° - å¯ä»¥ä½¿ç”¨æŒ‡å®šçš„åˆ—å°é…ç½®æˆ–é è¨­é…ç½®
    /// </summary>
    private async Task HandleDirectPrint(ReportPrintConfiguration? printConfig)
    {
        try
        {
            if (!PurchaseReceivingId.HasValue)
            {
                await NotificationService.ShowWarningAsync("ç„¡æ³•åˆ—å°ï¼šé€²è²¨å–®IDä¸å­˜åœ¨");
                return;
            }

            // é©—è­‰åˆ—å°é…ç½®
            var (isValid, errorMessage) = ReportPrintHelper.ValidateConfiguration(printConfig);
            if (!isValid)
            {
                await NotificationService.ShowWarningAsync($"åˆ—å°é…ç½®ç„¡æ•ˆï¼š{errorMessage}");
                return;
            }

            // ä½¿ç”¨é€šç”¨ Helper å»ºç«‹åˆ—å° URL
            var printUrl = ReportPrintHelper.BuildPrintUrl(
                baseUrl: NavigationManager.BaseUri,
                reportType: "purchase-receiving",
                documentId: PurchaseReceivingId.Value,
                configuration: printConfig,
                autoprint: true
            );

            // ä½¿ç”¨é€šç”¨ Helper åŸ·è¡Œåˆ—å°ï¼ˆéš±è— iframe æ–¹å¼ï¼‰
            var success = await ReportPrintHelper.ExecutePrintWithHiddenIframeAsync(
                printUrl: printUrl,
                jsRuntime: JSRuntime,
                iframeId: "printFrame"
            );
            
            if (success)
            {
                var configName = ReportPrintHelper.GetDisplayName(printConfig);
                await NotificationService.ShowSuccessAsync($"å·²ä½¿ç”¨ {configName} é€å‡ºåˆ—å°");
            }
            else
            {
                await NotificationService.ShowErrorAsync("åˆ—å°åŸ·è¡Œå¤±æ•—");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDirectPrint), GetType(), 
                additionalData: $"é€²è²¨å–®ç›´æ¥åˆ—å°å¤±æ•— - ID: {PurchaseReceivingId}, Config: {printConfig?.ReportName}");
            await NotificationService.ShowErrorAsync("åˆ—å°åŸ·è¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    /// <summary>
    /// å–å¾—é€²è²¨å–®ç‹€æ…‹è¨Šæ¯ï¼ˆé¡¯ç¤ºé–å®šç‹€æ…‹ï¼‰
    /// </summary>
    private async Task<(string Message, GenericEditModalComponent<PurchaseReceiving, IPurchaseReceivingService>.BadgeVariant Variant, string IconClass)?> GetPurchaseReceivingStatusMessage()
    {
        try
        {
            // å¦‚æœè³‡æ–™é‚„æ²’æº–å‚™å¥½ï¼Œä¸é¡¯ç¤ºè¨Šæ¯
            if (!isDetailDataReady || editModalComponent?.Entity == null)
                return null;
            
            // åªæœ‰åœ¨æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚æ‰é¡¯ç¤ºé–å®šè¨Šæ¯
            if (hasUndeletableDetails)
            {
                return (
                    "æ˜ç´°æœ‰å…¶ä»–å‹•ä½œï¼Œä¸»æª”æ¬„ä½å·²é–å®š",
                    GenericEditModalComponent<PurchaseReceiving, IPurchaseReceivingService>.BadgeVariant.Warning,
                    "fas fa-lock"
                );
            }
            
            // æ­£å¸¸ç‹€æ…‹ä¸é¡¯ç¤ºè¨Šæ¯
            return null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetPurchaseReceivingStatusMessage), GetType());
            return null;
        }
    }

    /// <summary>
    /// å–å¾—è­¦å‘Šè¨Šæ¯ï¼ˆé¡¯ç¤ºåœ¨è¡¨å–®æœ€ä¸Šæ–¹ï¼‰
    /// </summary>
    private RenderFragment? GetWarningMessage() => __builder =>
    {
        @if (isDetailDataReady && hasUndeletableDetails)
        {
            <div class="alert alert-warning mb-2 py-2" role="alert">
                <i class="fas fa-lock me-2"></i>å› éƒ¨åˆ†æ˜ç´°æœ‰å…¶ä»–å‹•ä½œï¼Œç‚ºä¿è­·è³‡æ–™å®Œæ•´æ€§ä¸»æª”æ¬„ä½å·²è¨­å”¯è®€ã€‚
            </div>
        }
    };

    /// <summary>
    /// è¼‰å…¥é€²è²¨è³‡æ–™
    /// </summary>
    private async Task<PurchaseReceiving?> LoadPurchaseReceivingData()
    {
        try
        {
            // ğŸ”‘ é‡ç½®æ˜ç´°è³‡æ–™æº–å‚™ç‹€æ…‹
            isDetailDataReady = false;
            hasUndeletableDetails = false;
            
            if (!PurchaseReceivingId.HasValue)
            {
                // æ–°å¢æ¨¡å¼
                var newReceiving = new PurchaseReceiving
                {
                    ReceiptNumber = await GenerateReceiptNumberAsync(),
                    ReceiptDate = DateTime.Now
                };
                
                // æ¸…ç©ºæ˜ç´°
                purchaseReceivingDetails.Clear();
                
                // æ–°å¢æ¨¡å¼ä¸‹ç›´æ¥æ¨™è¨˜ç‚ºæº–å‚™å°±ç·’ï¼ˆæ²’æœ‰æ˜ç´°éœ€è¦è¼‰å…¥ï¼‰
                isDetailDataReady = true;
                
                return newReceiving;
            }

            // ç·¨è¼¯æ¨¡å¼
            var purchaseReceiving = await PurchaseReceivingService.GetByIdAsync(PurchaseReceivingId.Value);
            
            if (purchaseReceiving != null)
            {
                // è¼‰å…¥é€²è²¨æ˜ç´°
                await LoadPurchaseReceivingDetails(PurchaseReceivingId.Value);
                
                // ğŸ”‘ é—œéµï¼šè¼‰å…¥é€€è²¨æ•¸é‡å’Œæ²–æ¬¾è³‡æ–™ï¼Œä¸¦æ›´æ–° hasUndeletableDetails
                await LoadDetailRelatedDataAsync();
                
                // ğŸ”‘ æ¨™è¨˜æ˜ç´°è³‡æ–™å·²æº–å‚™å°±ç·’ï¼ˆåŒ…æ‹¬é€€è²¨æ•¸é‡ç­‰è³‡è¨Šï¼‰
                isDetailDataReady = true;
                
                // å¦‚æœæœ‰å» å•†IDï¼Œæ›´æ–°æ¡è³¼å–®é¸é …å’Œç”¢å“ç¯©é¸é¸é …
                if (purchaseReceiving.SupplierId > 0)
                {
                    await UpdatePurchaseOrderOptions(purchaseReceiving.SupplierId);
                    await UpdateFilterProductOptions(purchaseReceiving.SupplierId);
                }
                
                // è¼‰å…¥å°æ‡‰çš„æ¡è³¼å–®æ˜ç´°
                if (purchaseReceiving.PurchaseOrderId.HasValue && purchaseReceiving.PurchaseOrderId.Value > 0)
                {
                    // æ³¨æ„ï¼šèˆŠçš„å–®ä¸€æ¡è³¼å–®æ¨¡å¼å·²ç§»é™¤ï¼Œæ­¤è™•ä¿ç•™ç¨‹å¼ç¢¼çµæ§‹ä½†ä¸åŸ·è¡Œå¯¦éš›è¼‰å…¥
                }
                
                // è§¸ç™¼é‡æ–°æ¸²æŸ“
                StateHasChanged();
            }
            
            return purchaseReceiving;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥é€²è²¨è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            isDetailDataReady = true; // å³ä½¿éŒ¯èª¤ä¹Ÿè¦å…è¨±æ¸²æŸ“ï¼Œé¿å…å¡ä½
            return null;
        }
    }

    /// <summary>
    /// è¼‰å…¥é¡å¤–è³‡æ–™
    /// </summary>
    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            var tasks = new List<Task>
            {
                LoadPurchaseOrdersAsync(),
                LoadWarehousesAsync(),
                LoadWarehouseLocationsAsync(),
                LoadSuppliersAsync(),
                LoadEmployeesAsync(),
                LoadProductsAsync()
            };
            
            await Task.WhenAll(tasks);
            
            // ğŸ”‘ ä¸€æ¬¡æ€§è¼‰å…¥ç³»çµ±ç¨…ç‡ï¼ˆé¿å…æ¯æ¬¡è¨ˆç®—éƒ½æŸ¥è©¢è³‡æ–™åº«ï¼‰
            try
            {
                currentTaxRate = await SystemParameterService.GetTaxRateAsync();
            }
            catch (Exception)
            {
                // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼ 5%
                currentTaxRate = 5.0m;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥é¡å¤–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    private async Task LoadPurchaseOrdersAsync()
    {
        try
        {
            // ä½¿ç”¨æœå‹™çš„æ–¹æ³•ä¾†ç²å–åŒ…å«å®Œæ•´é—œè¯è³‡æ–™çš„æ¡è³¼å–®
            // é€™æ¨£æˆ‘å€‘å¯ä»¥æ­£ç¢ºåˆ¤æ–·æ¡è³¼å–®çš„å®Œæˆç‹€æ…‹
            purchaseOrders = await PurchaseOrderService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥æ¡è³¼å–®è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            purchaseOrders = new List<PurchaseOrder>();
        }
    }

    private async Task LoadWarehousesAsync()
    {
        try
        {
            warehouses = await WarehouseService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å€‰åº«è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            warehouses = new List<Warehouse>();
        }
    }

    private async Task LoadWarehouseLocationsAsync()
    {
        try
        {
            warehouseLocations = await WarehouseLocationService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å€‰åº«ä½ç½®è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            warehouseLocations = new List<WarehouseLocation>();
        }
    }

    private async Task LoadSuppliersAsync()
    {
        try
        {
            suppliers = await SupplierService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å» å•†è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            suppliers = new List<Supplier>();
        }
    }

    private async Task LoadEmployeesAsync()
    {
        try
        {
            var result = await EmployeeService.GetActiveEmployeesAsync();
            if (result.IsSuccess && result.Data != null)
            {
                employees = result.Data;
            }
            else
            {
                employees = new List<Employee>();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å“¡å·¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            employees = new List<Employee>();
        }
    }

    private async Task LoadProductsAsync()
    {
        try
        {
            products = await ProductService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ç”¢å“è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            products = new List<Product>();
        }
    }

    /// <summary>
    /// æ›´æ–°æ¡è³¼å–®é¸é … - æ ¹æ“šå» å•†IDéæ¿¾ï¼Œä¸¦æ’é™¤å·²å®Œæˆçš„æ¡è³¼å–®
    /// </summary>
    private async Task UpdatePurchaseOrderOptions(int? supplierId = null)
    {
        try
        {
            // æ‰¾åˆ°æ¡è³¼å–®æ¬„ä½ä¸¦æ›´æ–°å…¶é¸é …
            var purchaseOrderField = formFields.FirstOrDefault(f => f.PropertyName == nameof(PurchaseReceiving.PurchaseOrderId));
            if (purchaseOrderField != null)
            {
                var options = new List<SelectOption> {};
                
                if (supplierId.HasValue && supplierId.Value > 0)
                {
                    // ä½¿ç”¨æ–°çš„æœå‹™æ–¹æ³•ç²å–åŒ…å«å®Œæ•´é—œè¯è³‡æ–™çš„æ¡è³¼å–®
                    var supplierOrders = await PurchaseOrderService.GetIncompleteOrdersBySupplierAsync(supplierId.Value);
                    
                    // éæ¿¾æ‰å·²å®Œæˆçš„æ¡è³¼å–®
                    var filteredPurchaseOrders = supplierOrders
                        .Where(po => !IsOrderFullyCompleted(po))
                        .ToList();
                    
                    options.AddRange(filteredPurchaseOrders.Select(po => new SelectOption
                    {
                        Value = po.Id.ToString(),
                        Text = $"{po.PurchaseOrderNumber} - {po.Supplier?.CompanyName ?? "æœªçŸ¥å» å•†"}"
                    }));
                }
                // å¦‚æœæ²’æœ‰é¸æ“‡å» å•†æˆ–é¸æ“‡äº†ç„¡æ•ˆçš„å» å•†ï¼Œåªé¡¯ç¤º"è«‹é¸æ“‡..."é¸é …
                
                purchaseOrderField.Options = options;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æ›´æ–°æ¡è³¼å–®é¸é …æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// åˆ¤æ–·æ¡è³¼å–®æ˜¯å¦å·²å®Œå…¨å®Œæˆ
    /// å®Œæˆæ¢ä»¶ï¼šæ‰€æœ‰æ˜ç´°éƒ½å·²å®Œæˆé€²è²¨ï¼ˆé€²è²¨æ•¸é‡ == æ¡è³¼æ•¸é‡ æˆ– æ¨™è¨˜ç‚ºå·²å®Œæˆï¼‰
    /// </summary>
    private bool IsOrderFullyCompleted(PurchaseOrder purchaseOrder)
    {
        try
        {
            // å¦‚æœæ²’æœ‰æ˜ç´°ï¼Œè¦–ç‚ºæœªå®Œæˆ
            if (purchaseOrder.PurchaseOrderDetails?.Any() != true)
            {
                return false;
            }
            
            // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰æ˜ç´°éƒ½å·²å®Œæˆ
            return purchaseOrder.PurchaseOrderDetails.All(pod => 
            {
                // æª¢æŸ¥è©²æ˜ç´°æ˜¯å¦æœ‰å°æ‡‰çš„é€²è²¨è¨˜éŒ„ä¸”æ¨™è¨˜ç‚ºå®Œæˆ
                var hasCompletedReceiving = pod.PurchaseReceivingDetails?.Any(prd => prd.IsReceivingCompleted) == true;
                // æˆ–è€…å·²ç¶“å®Œå…¨é€²è²¨ï¼ˆé€²è²¨æ•¸é‡ >= è¨‚è³¼æ•¸é‡ï¼‰
                var isQuantityFullyReceived = pod.ReceivedQuantity >= pod.OrderQuantity;
                
                return hasCompletedReceiving || isQuantityFullyReceived;
            });
        }
        catch
        {
            // å¦‚æœåˆ¤æ–·éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œé è¨­ç‚ºæœªå®Œæˆä»¥é¿å…éºæ¼
            return false;
        }
    }

    /// <summary>
    /// åˆå§‹åŒ–è¡¨å–®æ¬„ä½
    /// </summary>
    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(PurchaseReceiving.ReceiptNumber),
                    Label = "é€²è²¨å–®è™Ÿ",
                    FieldType = FormFieldType.Text,
                    Placeholder = "ç³»çµ±è‡ªå‹•ç”¢ç”Ÿ",
                    IsRequired = true,
                    IsReadOnly = true,
                    MaxLength = 50,
                    HelpText = "ç³»çµ±è‡ªå‹•ç”¢ç”Ÿçš„é€²è²¨å–®è™Ÿ"
                },
                new()
                {
                    PropertyName = nameof(PurchaseReceiving.SupplierId),
                    Label = "ç¯©é¸å» å•†",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡å» å•†",
                    IsRequired = true,
                    MinSearchLength = 0,
                    HelpText = "è¼¸å…¥å» å•†åç¨±é€²è¡Œç¯©é¸ï¼Œæˆ–ç›´æ¥é¸æ“‡",
                    ActionButtons = await GetSupplierActionButtonsAsync()
                },
                new()
                {
                    PropertyName = "FilterProductId", // ç¯©é¸ç”¨çš„è™›æ“¬æ¬„ä½
                    Label = "ç¯©é¸ç”¢å“",
                    FieldType = FormFieldType.Select,
                    IsRequired = false,
                    Options = await GetFilterProductOptions(),
                    HelpText = "é¸æ“‡ç‰¹å®šç”¢å“é€²è¡Œç¯©é¸ï¼Œæˆ–ç•™ç©ºé¡¯ç¤ºæ‰€æœ‰ç”¢å“"
                },
                new()
                {
                    PropertyName = nameof(PurchaseReceiving.PurchaseOrderId),
                    Label = "ç¯©é¸æ¡è³¼å–®",
                    FieldType = FormFieldType.Select,
                    IsRequired = false,  // æ”¹ç‚ºéå¿…å¡«ï¼Œæ”¯æ´å¤šæ¡è³¼å–®æ¨¡å¼
                    HelpText = "å¯é¸æ“‡ç‰¹å®šæ¡è³¼å–®é€²è¡Œç¯©é¸ï¼Œæˆ–ç•™ç©ºä½¿ç”¨å¤šæ¡è³¼å–®æ¨¡å¼"
                },
                new()
                {
                    PropertyName = nameof(PurchaseReceiving.ReceiptDate),
                    Label = "é€²è²¨æ—¥",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "è²¨å“å¯¦éš›é€²è²¨æ—¥"
                },
                
                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseReceiving.TotalAmount),
                    Label = "å…¥åº«ç¸½é‡‘é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "å…¥åº«å–®çš„ç¸½é‡‘é¡ï¼Œæ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—",
                    IsReadOnly = true // ç¸½é‡‘é¡æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseReceiving.PurchaseReceivingTaxAmount),
                    Label = $"æ¡è³¼ç¨…é¡({currentTaxRate:F2}%)",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = $"æ¡è³¼å–®çš„ç¨…é¡ï¼Œæ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—ï¼ˆç¨…ç‡ï¼š{currentTaxRate:F2}%ï¼‰",
                    IsReadOnly = true // ç¨…é¡æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(PurchaseReceiving.PurchaseReceivingTotalAmountIncludingTax),
                    Label = "å«ç¨…ç¸½é‡‘é¡",
                    FieldType = FormFieldType.Number,
                    IsRequired = false,
                    HelpText = "æ¡è³¼å–®çš„å«ç¨…ç¸½é‡‘é¡ï¼Œæ ¹æ“šæ˜ç´°è‡ªå‹•è¨ˆç®—",
                    IsReadOnly = true // å«ç¨…ç¸½é‡‘é¡æ¬„ä½å§‹çµ‚ç‚ºå”¯è®€
                },


                FormFieldConfigurationHelper.CreateRemarksField<PurchaseReceiving>()
            };

            formSections = new Dictionary<string, string>
            {
                { nameof(PurchaseReceiving.ReceiptNumber), "åŸºæœ¬è³‡è¨Š" },
                { nameof(PurchaseReceiving.SupplierId), "åŸºæœ¬è³‡è¨Š" },
                { "FilterProductId", "åŸºæœ¬è³‡è¨Š" },
                { nameof(PurchaseReceiving.PurchaseOrderId), "åŸºæœ¬è³‡è¨Š" },
                { nameof(PurchaseReceiving.ReceiptDate), "åŸºæœ¬è³‡è¨Š" },
                { nameof(PurchaseReceiving.TotalAmount), "é‡‘é¡è³‡è¨Š(ç³»çµ±è‡ªå‹•è¨ˆç®—)" },
                { nameof(PurchaseReceiving.PurchaseReceivingTaxAmount), "é‡‘é¡è³‡è¨Š(ç³»çµ±è‡ªå‹•è¨ˆç®—)" },
                { nameof(PurchaseReceiving.PurchaseReceivingTotalAmountIncludingTax), "é‡‘é¡è³‡è¨Š(ç³»çµ±è‡ªå‹•è¨ˆç®—)" },
                { nameof(BaseEntity.Remarks), "å…¶ä»–è³‡è¨Š" }
            };
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"åˆå§‹åŒ–è¡¨å–®æ¬„ä½æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// å–å¾—ç”¢å“ç¯©é¸é¸é … - æ ¹æ“šé¸æ“‡çš„å» å•†ç¯©é¸
    /// </summary>
    private async Task<List<SelectOption>> GetFilterProductOptions()
    {
        try
        {
            var options = new List<SelectOption> {};
            
            // å¦‚æœæœ‰é¸æ“‡å» å•†ï¼Œåªé¡¯ç¤ºè©²å» å•†çš„ç”¢å“
            if (editModalComponent?.Entity?.SupplierId > 0)
            {
                var supplierProducts = await ProductService.GetBySupplierAsync(editModalComponent.Entity.SupplierId);
                options.AddRange(supplierProducts.Select(p => new SelectOption
                {
                    Value = p.Id.ToString(),
                    Text = $"{p.Code} - {p.Name}"
                }));
            }
            
            return options;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ç”¢å“é¸é …æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return new List<SelectOption> {};
        }
    }

    /// <summary>
    /// æ›´æ–°ç”¢å“ç¯©é¸é¸é … - ç•¶å» å•†è®Šæ›´æ™‚èª¿ç”¨
    /// </summary>
    private async Task UpdateFilterProductOptions(int? supplierId = null)
    {
        try
        {
            // æ‰¾åˆ°ç”¢å“ç¯©é¸æ¬„ä½ä¸¦æ›´æ–°å…¶é¸é …
            var filterProductField = formFields.FirstOrDefault(f => f.PropertyName == "FilterProductId");
            if (filterProductField != null)
            {
                var options = new List<SelectOption> {};
                
                if (supplierId.HasValue && supplierId.Value > 0)
                {
                    var supplierProducts = await ProductService.GetBySupplierAsync(supplierId.Value);
                    options.AddRange(supplierProducts.Select(p => new SelectOption
                    {
                        Value = p.Id.ToString(),
                        Text = $"{p.Code} - {p.Name}"
                    }));
                }
                
                filterProductField.Options = options;
                
                // æ¸…ç©ºç›®å‰çš„ç”¢å“ç¯©é¸é¸æ“‡
                filterProductId = null;
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æ›´æ–°ç”¢å“ç¯©é¸é¸é …æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// å–å¾—è¡¨å–®æ¬„ä½æ¸…å–®
    /// </summary>
    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }

    /// <summary>
    /// é…ç½® AutoComplete é å¡«å™¨
    /// </summary>
    private Dictionary<string, Func<string, Dictionary<string, object?>>> GetAutoCompletePrefillers()
    {
        return new Dictionary<string, Func<string, Dictionary<string, object?>>>
        {
            {
                nameof(PurchaseReceiving.SupplierId),
                searchTerm => new Dictionary<string, object?>
                {
                    ["CompanyName"] = searchTerm
                }
            }
        };
    }

    /// <summary>
    /// é…ç½® Modal ç®¡ç†å™¨
    /// </summary>
    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(PurchaseReceiving.SupplierId), supplierModalManager }
        };
    }

    /// <summary>
    /// é…ç½® AutoComplete è³‡æ–™é›†åˆ
    /// </summary>
    private Dictionary<string, IEnumerable<object>> GetAutoCompleteCollections()
    {
        return new Dictionary<string, IEnumerable<object>>
        {
            { nameof(PurchaseReceiving.SupplierId), suppliers.Cast<object>() }
        };
    }

    /// <summary>
    /// é…ç½® AutoComplete é¡¯ç¤ºå±¬æ€§
    /// </summary>
    private Dictionary<string, string> GetAutoCompleteDisplayProperties()
    {
        return new Dictionary<string, string>
        {
            { nameof(PurchaseReceiving.SupplierId), "CompanyName" }
        };
    }

    /// <summary>
    /// é…ç½® AutoComplete å€¼å±¬æ€§
    /// </summary>
    private Dictionary<string, string> GetAutoCompleteValueProperties()
    {
        return new Dictionary<string, string>
        {
            { nameof(PurchaseReceiving.SupplierId), "Id" }
        };
    }

    /// <summary>
    /// ç”Ÿæˆé€²è²¨å–®è™Ÿ
    /// </summary>
    private async Task<string> GenerateReceiptNumberAsync()
    {
        return await CodeGenerationHelper.GenerateEntityCodeAsync(
            PurchaseReceivingService,
            "RCV",
            (service, code, excludeId) => service.IsReceiptNumberExistsAsync(code, excludeId)
        );
    }

    // ===== é€²è²¨æ˜ç´°ç®¡ç†æ–¹æ³• =====
    
    /// <summary>
    /// è¼‰å…¥é€²è²¨æ˜ç´°
    /// </summary>
    private async Task LoadPurchaseReceivingDetails(int purchaseReceivingId)
    {
        try
        {
            // å¾æœå‹™è¼‰å…¥é€²è²¨æ˜ç´°
            var receiving = await PurchaseReceivingService.GetByIdAsync(purchaseReceivingId);
            purchaseReceivingDetails = receiving?.PurchaseReceivingDetails?.ToList() ?? new List<PurchaseReceivingDetail>();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥é€²è²¨æ˜ç´°å¤±æ•—ï¼š{ex.Message}");
            purchaseReceivingDetails = new List<PurchaseReceivingDetail>();
        }
    }

    /// <summary>
    /// è¼‰å…¥æ˜ç´°ç›¸é—œè³‡æ–™ï¼ˆé€€è²¨æ•¸é‡ã€æ²–æ¬¾è¨˜éŒ„ç­‰ï¼‰
    /// é€™å€‹æ–¹æ³•åœ¨ä¸»æª”è¼‰å…¥æ™‚å°±åŒæ­¥åŸ·è¡Œï¼Œç¢ºä¿ hasUndeletableDetails ç‹€æ…‹åœ¨æ¸²æŸ“å‰å°±æ­£ç¢º
    /// </summary>
    private async Task LoadDetailRelatedDataAsync()
    {
        try
        {
            if (!purchaseReceivingDetails.Any())
            {
                hasUndeletableDetails = false;
                return;
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
            bool hasUndeletable = false;
            
            foreach (var detail in purchaseReceivingDetails.Where(d => d.Id > 0))
            {
                // æª¢æŸ¥ 1ï¼šé€€è²¨è¨˜éŒ„
                var returnedQty = await PurchaseReturnDetailService.GetReturnedQuantityByReceivingDetailAsync(detail.Id);
                if (returnedQty > 0)
                {
                    hasUndeletable = true;
                    break;
                }
                
                // æª¢æŸ¥ 2ï¼šæ²–æ¬¾è¨˜éŒ„ï¼ˆç›´æ¥è®€å– TotalPaidAmount æ¬„ä½ï¼‰
                if (detail.TotalPaidAmount > 0)
                {
                    hasUndeletable = true;
                    break;
                }
            }
            
            hasUndeletableDetails = hasUndeletable;
            
            // å¦‚æœæœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼Œç«‹å³æ›´æ–°æ¬„ä½ç‹€æ…‹
            if (hasUndeletableDetails)
            {
                UpdateFieldsReadOnlyState();
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDetailRelatedDataAsync), GetType());
            hasUndeletableDetails = false; // éŒ¯èª¤æ™‚ä¿å®ˆè™•ç†ï¼Œä¸é–å®š
        }
    }

    /// <summary>
    /// è™•ç†é€²è²¨æ˜ç´°è®Šæ›´ - è‡ªå‹•è¨ˆç®—ç¨…é¡
    /// </summary>
    private async Task HandleReceivingDetailsChanged(List<PurchaseReceivingDetail> details)
    {
        try
        {
            purchaseReceivingDetails = details ?? new List<PurchaseReceivingDetail>();
            
            // æ›´æ–°ä¸»æª”çš„ç¸½é‡‘é¡å’Œç¨…é¡ï¼ˆåƒè€ƒ README_ç¨…é¡è‡ªå‹•è¨ˆç®—.mdï¼‰
            if (editModalComponent?.Entity != null)
            {
                // 1. è¨ˆç®—ç¸½é‡‘é¡ï¼ˆæœªç¨…ï¼‰= Î£(é€²è²¨æ•¸é‡ Ã— å–®åƒ¹)
                editModalComponent.Entity.TotalAmount = purchaseReceivingDetails.Sum(d => d.SubtotalAmount);
                
                // 2. è¨ˆç®—ç¨…é¡ = ç¸½é‡‘é¡ Ã— ç¨…ç‡ï¼ˆä½¿ç”¨å¿«å–çš„ç¨…ç‡ï¼Œé¿å…æ¯æ¬¡éƒ½æŸ¥è©¢è³‡æ–™åº«ï¼‰
                editModalComponent.Entity.PurchaseReceivingTaxAmount = Math.Round(
                    editModalComponent.Entity.TotalAmount * (currentTaxRate / 100), 
                    2  // å››æ¨äº”å…¥åˆ°å°æ•¸é»å¾Œ2ä½
                );
                
                // 3. å«ç¨…ç¸½é‡‘é¡æœƒè‡ªå‹•è¨ˆç®—ï¼ˆPurchaseReceivingTotalAmountIncludingTax æ˜¯è¨ˆç®—å±¬æ€§ï¼‰
                //    = TotalAmount + PurchaseReceivingTaxAmount
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†æ˜ç´°è®Šæ›´æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è™•ç†å·²åˆªé™¤çš„é€²è²¨æ˜ç´°ID
    /// </summary>
    private async Task HandleDeletedDetailsChanged(List<int> deletedDetailIds)
    {
        try
        {
            if (deletedDetailIds?.Any() == true)
            {
                // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ï¼Œå¯¦éš›å¾è³‡æ–™åº«æ°¸ä¹…åˆªé™¤
                if (PurchaseReceivingId.HasValue)
                {
                    foreach (var detailId in deletedDetailIds)
                    {
                        var result = await PurchaseReceivingDetailService.PermanentDeleteAsync(detailId);
                        if (!result.IsSuccess)
                        {
                            await NotificationService.ShowErrorAsync($"åˆªé™¤æ˜ç´°ID {detailId} å¤±æ•—: {result.ErrorMessage}");
                            return;
                        }
                    }
                    await NotificationService.ShowSuccessAsync($"å·²æ°¸ä¹…åˆªé™¤ {deletedDetailIds.Count} ç­†é€²è²¨æ˜ç´°");
                }
                
                // å¾æœ¬åœ°ç‹€æ…‹ä¸­ç§»é™¤å·²åˆªé™¤çš„æ˜ç´°
                if (purchaseReceivingDetails != null)
                {
                    purchaseReceivingDetails = purchaseReceivingDetails
                        .Where(detail => !deletedDetailIds.Contains(detail.Id))
                        .ToList();
                }
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æ°¸ä¹…åˆªé™¤é€²è²¨æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è™•ç†æœ‰ä¸å¯åˆªé™¤æ˜ç´°çš„ç‹€æ…‹è®Šæ›´
    /// ç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚(å·²é€€è²¨æˆ–å·²æ²–æ¬¾),é–å®šä¸»æª”çš„å» å•†å’Œæ¡è³¼å–®æ¬„ä½
    /// </summary>
    private async Task HandleHasUndeletableDetailsChanged(bool hasUndeletable)
    {
        try
        {
            hasUndeletableDetails = hasUndeletable;
            
            // æ›´æ–°æ¬„ä½çš„å”¯è®€ç‹€æ…‹
            UpdateFieldsReadOnlyState();
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†æ˜ç´°é–å®šç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// æ›´æ–°æ¬„ä½çš„å”¯è®€ç‹€æ…‹
    /// ç•¶æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°æ™‚,æ‰€æœ‰ä½¿ç”¨è€…å¯è¼¸å…¥çš„æ¬„ä½éƒ½æ‡‰è¨­ç‚ºå”¯è®€:
    /// - å» å•† (SupplierId) - åŒæ™‚ç¦ç”¨æ–°å¢/ç·¨è¼¯æŒ‰éˆ•
    /// - æ¡è³¼å–® (PurchaseOrderId)
    /// - ç”¢å“ç¯©é¸ (FilterProductId)
    /// - é€²è²¨æ—¥ (ReceiptDate)
    /// - å‚™è¨» (Remarks)
    /// 
    /// ä¸é–å®šçš„æ¬„ä½ï¼ˆç³»çµ±è‡ªå‹•è¨ˆç®—/ç”Ÿæˆï¼‰:
    /// - é€²è²¨å–®è™Ÿ (ReceiptNumber) - å·²ç¶“æ˜¯å”¯è®€
    /// - ç¸½é‡‘é¡ (TotalAmount) - å·²ç¶“æ˜¯å”¯è®€
    /// - ç¨…é¡ (PurchaseReceivingTaxAmount) - å·²ç¶“æ˜¯å”¯è®€
    /// - å«ç¨…ç¸½é‡‘é¡ (PurchaseReceivingTotalAmountIncludingTax) - å·²ç¶“æ˜¯å”¯è®€
    /// </summary>
    private void UpdateFieldsReadOnlyState()
    {
        // å» å•†æ¬„ä½ - è¨­ç‚ºå”¯è®€ä¸¦æ¸…ç©º ActionButtons
        var supplierField = formFields.FirstOrDefault(f => f.PropertyName == nameof(PurchaseReceiving.SupplierId));
        if (supplierField != null)
        {
            supplierField.IsReadOnly = hasUndeletableDetails;
            
            // å¦‚æœæœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼Œç§»é™¤æ“ä½œæŒ‰éˆ•ï¼›å¦å‰‡æ¢å¾©æ“ä½œæŒ‰éˆ•
            if (hasUndeletableDetails)
            {
                supplierField.ActionButtons = new List<FieldActionButton>();
            }
            else
            {
                supplierField.ActionButtons = GetSupplierActionButtonsAsync().Result;
            }
        }
        
        // æ¡è³¼å–®æ¬„ä½
        var purchaseOrderField = formFields.FirstOrDefault(f => f.PropertyName == nameof(PurchaseReceiving.PurchaseOrderId));
        if (purchaseOrderField != null)
        {
            purchaseOrderField.IsReadOnly = hasUndeletableDetails;
        }
        
        // ç”¢å“ç¯©é¸æ¬„ä½
        var filterProductField = formFields.FirstOrDefault(f => f.PropertyName == "FilterProductId");
        if (filterProductField != null)
        {
            filterProductField.IsReadOnly = hasUndeletableDetails;
        }
        
        // é€²è²¨æ—¥æ¬„ä½
        var receiptDateField = formFields.FirstOrDefault(f => f.PropertyName == nameof(PurchaseReceiving.ReceiptDate));
        if (receiptDateField != null)
        {
            receiptDateField.IsReadOnly = hasUndeletableDetails;
        }
        
        // å‚™è¨»æ¬„ä½
        var remarksField = formFields.FirstOrDefault(f => f.PropertyName == nameof(BaseEntity.Remarks));
        if (remarksField != null)
        {
            remarksField.IsReadOnly = hasUndeletableDetails;
        }
    }

    /// <summary>
    /// è™•ç†æ¬„ä½å€¼è®Šæ›´äº‹ä»¶
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // ç•¶å» å•†è®Šæ›´æ™‚ï¼Œæ›´æ–°æ¡è³¼å–®é¸é …ä¸¦æ¸…ç©ºæ¡è³¼å–®é¸æ“‡
            if (fieldChange.PropertyName == nameof(PurchaseReceiving.SupplierId))
            {
                // æ¸…ç©ºæ¡è³¼å–®é¸æ“‡
                if (editModalComponent?.Entity != null)
                {
                    editModalComponent.Entity.PurchaseOrderId = null;
                }
                
                // æ›´æ–°æ¡è³¼å–®é¸é …
                int? supplierId = null;
                if (fieldChange.Value != null && 
                    int.TryParse(fieldChange.Value.ToString(), out int parsedSupplierId) && 
                    parsedSupplierId > 0)
                {
                    supplierId = parsedSupplierId;
                }
                
                await UpdatePurchaseOrderOptions(supplierId);
                
                // æ›´æ–°ç”¢å“ç¯©é¸é¸é …
                await UpdateFilterProductOptions(supplierId);
                
                // æ›´æ–°å» å•†æ¬„ä½çš„æ“ä½œæŒ‰éˆ• - åªæœ‰åœ¨æ²’æœ‰ä¸å¯åˆªé™¤æ˜ç´°æ™‚æ‰æ›´æ–°
                if (!hasUndeletableDetails)
                {
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        supplierModalManager, 
                        formFields, 
                        nameof(PurchaseReceiving.SupplierId), 
                        fieldChange.Value
                    );
                }
                
                StateHasChanged();
            }
            
            // ç•¶æ¡è³¼å–®IDè®Šæ›´æ™‚ï¼Œè§¸ç™¼é‡æ–°æ¸²æŸ“ä»¥ç¯©é¸å°æ‡‰çš„æ¡è³¼æ˜ç´°
            if (fieldChange.PropertyName == nameof(PurchaseReceiving.PurchaseOrderId))
            {
                // ç„¡è«–é¸æ“‡äº†ç‰¹å®šæ¡è³¼å–®é‚„æ˜¯æ¸…ç©ºé¸æ“‡ï¼Œéƒ½éœ€è¦é‡æ–°æ¸²æŸ“
                StateHasChanged();
            }
            
            // ç•¶ç”¢å“ç¯©é¸è®Šæ›´æ™‚ï¼Œæ›´æ–°ç¯©é¸ç‹€æ…‹ä¸¦è§¸ç™¼é‡æ–°æ¸²æŸ“
            if (fieldChange.PropertyName == "FilterProductId")
            {
                if (fieldChange.Value != null && 
                    int.TryParse(fieldChange.Value.ToString(), out int productId) && 
                    productId > 0)
                {
                    filterProductId = productId;
                }
                else
                {
                    filterProductId = null;
                }
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è™•ç†æ¬„ä½è®Šæ›´æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// é©—è­‰é€²è²¨æ˜ç´° - åœ¨å„²å­˜ä¸»æª”ä¹‹å‰åŸ·è¡Œ
    /// </summary>
    private async Task<bool> ValidatePurchaseReceivingDetailsAsync(PurchaseReceiving purchaseReceiving)
    {
        try
        {
            // å¦‚æœæ˜ç´°ç®¡ç†çµ„ä»¶å­˜åœ¨ï¼ŒåŸ·è¡Œé©—è­‰
            if (purchaseReceivingDetailManager != null)
            {
                return await purchaseReceivingDetailManager.ValidateAsync();
            }
            
            // å¦‚æœçµ„ä»¶ä¸å­˜åœ¨ï¼Œé è¨­é€šéé©—è­‰
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é©—è­‰æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// AfterSave å›èª¿æ–¹æ³• - åœ¨ä¸»æª”å„²å­˜å¾Œè™•ç†æ˜ç´°ä¸¦ä½¿ç”¨å·®ç•°æ¯”è¼ƒæ›´æ–°åº«å­˜
    /// è™•ç†æµç¨‹ï¼š
    /// 1. å„²å­˜æœ‰æ•ˆçš„æ˜ç´°è³‡æ–™ï¼ˆæœ‰é¸æ“‡å•†å“å’Œå€‰åº«çš„è¨˜éŒ„ï¼‰
    /// 2. æ›´æ–°ä¸»æª”ç¸½é‡‘é¡
    /// 3. ä½¿ç”¨æ–°çš„ UpdateInventoryByDifferenceAsync æ–¹æ³•é€²è¡Œåº«å­˜å·®ç•°æ›´æ–°
    /// 4. å·®ç•°æ›´æ–°é‚è¼¯ï¼š
    ///    - æ¯”è¼ƒç·¨è¼¯å‰å¾Œæ˜ç´°çš„è®ŠåŒ–
    ///    - åªé‡å°è®Šæ›´çš„éƒ¨åˆ†é€²è¡Œåº«å­˜èª¿æ•´
    ///    - æ–°å¢ï¼šç›´æ¥å¢åŠ åº«å­˜
    ///    - ä¿®æ”¹ï¼šèª¿æ•´åº«å­˜å·®ç•°ï¼ˆå¢åŠ æˆ–æ¸›å°‘ï¼‰
    ///    - åˆªé™¤ï¼šå›é€€åº«å­˜
    ///    - ç”¢å“æ›¿æ›ï¼šå¾åŸç”¢å“æ¸›å»åº«å­˜ï¼Œå‘æ–°ç”¢å“å¢åŠ åº«å­˜
    /// </summary>
    private async Task SavePurchaseReceivingDetailsAsync(PurchaseReceiving purchaseReceiving)
    {
        try
        {
            // åªæœ‰åœ¨é€²è²¨å–®IDå­˜åœ¨æ™‚æ‰è™•ç†æ˜ç´°ï¼ˆæ–°å¢é€²è²¨å–®æ™‚å¯èƒ½IDé‚„æ˜¯0ï¼‰
            if (purchaseReceiving.Id <= 0)
            {
                return; // æ–°å¢çš„é€²è²¨å–®ï¼ŒIDå¯èƒ½é‚„æ²’è¨­å®šï¼Œè·³éæ˜ç´°å„²å­˜
            }

            // éæ¿¾æœ‰æ•ˆçš„æ˜ç´°ï¼ˆæœ‰é¸æ“‡å•†å“å’Œå€‰åº«çš„ï¼‰
            var validDetails = purchaseReceivingDetails
                .Where(detail => detail.ProductId > 0 && detail.WarehouseId > 0)
                .ToList();

            if (validDetails.Any())
            {
                // æ›´æ–°æ˜ç´°è³‡è¨Š - ä½¿ç”¨ç¨ç«‹çš„æœå‹™èª¿ç”¨ï¼Œé¿å…åµŒå¥—äº¤æ˜“
                foreach (var detail in validDetails)
                {
                    detail.PurchaseReceivingId = purchaseReceiving.Id;
                    
                    // åŒæ­¥ä¸»æª”çš„æ‰¹è™Ÿåˆ°æ˜ç´°
                    if (!string.IsNullOrWhiteSpace(purchaseReceiving.BatchNumber))
                    {
                        detail.BatchNumber = purchaseReceiving.BatchNumber;
                    }
                    
                    if (detail.Id == 0)
                    {
                        // æ–°è¨˜éŒ„ - ä½¿ç”¨åŸºæœ¬çš„ Create æ–¹æ³•
                        var createResult = await PurchaseReceivingDetailService.CreateAsync(detail);
                        if (!createResult.IsSuccess)
                        {
                            await NotificationService.ShowWarningAsync($"æ˜ç´°å„²å­˜è­¦å‘Šï¼š{createResult.ErrorMessage}");
                        }
                    }
                    else
                    {
                        // æ›´æ–°ç¾æœ‰è¨˜éŒ„ - ä½¿ç”¨åŸºæœ¬çš„ Update æ–¹æ³•
                        var updateResult = await PurchaseReceivingDetailService.UpdateAsync(detail);
                        if (!updateResult.IsSuccess)
                        {
                            await NotificationService.ShowWarningAsync($"æ˜ç´°æ›´æ–°è­¦å‘Šï¼š{updateResult.ErrorMessage}");
                        }
                    }
                }

                // é‡æ–°è¼‰å…¥æ˜ç´°è³‡æ–™ä»¥æ›´æ–°UIé¡¯ç¤º
                purchaseReceivingDetails = await PurchaseReceivingDetailService.GetByPurchaseReceivingIdAsync(purchaseReceiving.Id);
            }

            // æ›´æ–°ä¸»æª”çš„ç¸½é‡‘é¡å’Œç¨…é¡
            purchaseReceiving.TotalAmount = purchaseReceivingDetails.Sum(d => d.SubtotalAmount);
            purchaseReceiving.PurchaseReceivingTaxAmount = Math.Round(
                purchaseReceiving.TotalAmount * (currentTaxRate / 100), 
                2  // å››æ¨äº”å…¥åˆ°å°æ•¸é»å¾Œ2ä½
            );
            
            if (purchaseReceiving.TotalAmount > 0)
            {
                var updateResult = await PurchaseReceivingService.UpdateAsync(purchaseReceiving);
                if (!updateResult.IsSuccess)
                {
                    await NotificationService.ShowWarningAsync($"ç¸½é‡‘é¡æ›´æ–°è­¦å‘Šï¼š{updateResult.ErrorMessage}");
                }
            }

            // æ›´æ–°ç›¸é—œæ¡è³¼å–®æ˜ç´°çš„å·²é€²è²¨é‡
            if (validDetails.Any())
            {
                var uniquePurchaseOrderDetailIds = validDetails
                    .Where(d => d.PurchaseOrderDetailId > 0)
                    .Select(d => d.PurchaseOrderDetailId)
                    .Distinct();

                foreach (var purchaseOrderDetailId in uniquePurchaseOrderDetailIds)
                {
                    var recalculateResult = await PurchaseOrderDetailService.RecalculateReceivedQuantityAsync(purchaseOrderDetailId);
                    if (!recalculateResult.IsSuccess)
                    {
                        await NotificationService.ShowWarningAsync($"æ¡è³¼å–®æ˜ç´°å·²é€²è²¨é‡æ›´æ–°å¤±æ•—ï¼š{recalculateResult.ErrorMessage}");
                    }
                }
            }

            // ä½¿ç”¨å·®ç•°æ¯”è¼ƒé€²è¡Œåº«å­˜æ›´æ–° - é¿å…é‡è¤‡ç´¯åŠ å’Œç”¢å“æ›¿æ›å•é¡Œ
            if (validDetails.Any())
            {
                try
                {
                    // åˆ¤æ–·æ˜¯æ–°å¢é‚„æ˜¯ç·¨è¼¯æ¨¡å¼
                    bool isEditMode = PurchaseReceivingId.HasValue && PurchaseReceivingId.Value > 0;
                    
                    if (isEditMode)
                    {
                        // ç·¨è¼¯æ¨¡å¼ï¼šä½¿ç”¨å·®ç•°æ¯”è¼ƒæ›´æ–°åº«å­˜
                        var differenceResult = await PurchaseReceivingService.UpdateInventoryByDifferenceAsync(purchaseReceiving.Id, 0);
                        if (differenceResult.IsSuccess)
                        {
                            await NotificationService.ShowSuccessAsync("é€²è²¨æ˜ç´°å„²å­˜æˆåŠŸï¼Œåº«å­˜å·²å·®ç•°æ›´æ–°");
                        }
                        else
                        {
                            await NotificationService.ShowWarningAsync($"æ˜ç´°å„²å­˜æˆåŠŸï¼Œä½†åº«å­˜å·®ç•°æ›´æ–°å¤±æ•—ï¼š{differenceResult.ErrorMessage}");
                        }
                    }
                    else
                    {
                        // æ–°å¢æ¨¡å¼ï¼šåªåœ¨ç¬¬ä¸€æ¬¡æ–°å¢æ™‚ä½¿ç”¨ç¢ºèªæµç¨‹ï¼Œé¿å…é‡è¤‡æ›´æ–°åº«å­˜
                        // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰åº«å­˜äº¤æ˜“è¨˜éŒ„ï¼Œé¿å…é‡è¤‡ç¢ºèª
                        var hasExistingTransactions = await HasExistingInventoryTransactions(purchaseReceiving.ReceiptNumber);
                        
                        if (!hasExistingTransactions)
                        {
                            var confirmResult = await PurchaseReceivingService.ConfirmReceiptAsync(purchaseReceiving.Id, 0);
                            if (confirmResult.IsSuccess)
                            {
                                await NotificationService.ShowSuccessAsync("é€²è²¨æ˜ç´°å„²å­˜æˆåŠŸï¼Œåº«å­˜å·²è‡ªå‹•æ›´æ–°");
                            }
                            else
                            {
                                await NotificationService.ShowWarningAsync($"æ˜ç´°å„²å­˜æˆåŠŸï¼Œä½†åº«å­˜æ›´æ–°å¤±æ•—ï¼š{confirmResult.ErrorMessage}");
                            }
                        }
                        else
                        {
                            await NotificationService.ShowInfoAsync("é€²è²¨æ˜ç´°å„²å­˜æˆåŠŸï¼Œåº«å­˜å·²å­˜åœ¨ç„¡éœ€é‡è¤‡æ›´æ–°");
                        }
                    }
                }
                catch (Exception ex)
                {
                    await NotificationService.ShowWarningAsync($"æ˜ç´°å„²å­˜æˆåŠŸï¼Œä½†åº«å­˜æ›´æ–°ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
                }
            }

            StateHasChanged(); // é€šçŸ¥UIæ›´æ–°
        }
        catch (Exception ex)
        {
            // è¨˜éŒ„éŒ¯èª¤ä½†ä¸ä¸­æ–·æµç¨‹ï¼Œå› ç‚ºä¸»è¦å¯¦é«”å·²ç¶“å„²å­˜æˆåŠŸ
            await NotificationService.ShowWarningAsync($"æ˜ç´°è™•ç†æ™‚ç™¼ç”Ÿè­¦å‘Šï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦å·²ç¶“å­˜åœ¨åº«å­˜äº¤æ˜“è¨˜éŒ„
    /// </summary>
    private Task<bool> HasExistingInventoryTransactions(string receiptNumber)
    {
        try
        {
            // é€™è£¡å¯ä»¥é€šéåº«å­˜æœå‹™æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸é—œäº¤æ˜“è¨˜éŒ„
            // æš«æ™‚è¿”å› falseï¼Œè¡¨ç¤ºç¸½æ˜¯å…è¨±é€²è¡Œåº«å­˜æ›´æ–°
            // å¦‚æœéœ€è¦æ›´åš´æ ¼çš„æª¢æŸ¥ï¼Œå¯ä»¥æ³¨å…¥ IInventoryTransactionService é€²è¡ŒæŸ¥è©¢
            return Task.FromResult(false);
        }
        catch
        {
            // ç™¼ç”ŸéŒ¯èª¤æ™‚è¿”å› falseï¼Œå…è¨±åº«å­˜æ›´æ–°
            return Task.FromResult(false);
        }
    }

    /// <summary>
    /// é…ç½®è‡ªè¨‚æ¨¡çµ„
    /// </summary>
    private List<GenericEditModalComponent<PurchaseReceiving, IPurchaseReceivingService>.CustomModule> GetCustomModules()
    {
        try
        {
            if (editModalComponent == null)
            {
                return new List<GenericEditModalComponent<PurchaseReceiving, IPurchaseReceivingService>.CustomModule>();
            }

            return new List<GenericEditModalComponent<PurchaseReceiving, IPurchaseReceivingService>.CustomModule>
            {
                new GenericEditModalComponent<PurchaseReceiving, IPurchaseReceivingService>.CustomModule
                {
                    Title = "",
                    Order = 1,
                    CssClass = "",  // ç§»é™¤ mt-4ï¼Œè®“è­¦å‘Šè¨Šæ¯ç·Šè²¼ä¸Šæ–¹
                    IsVisible = true,
                    Content = CreateReceivingDetailManagerContent()
                }
            };
        }
        catch
        {
            // å¦‚æœå‰µå»ºæ¨¡çµ„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè¿”å›ç©ºåˆ—è¡¨
            return new List<GenericEditModalComponent<PurchaseReceiving, IPurchaseReceivingService>.CustomModule>();
        }
    }

    /// <summary>
    /// å‰µå»ºé€²è²¨æ˜ç´°ç®¡ç†å™¨å…§å®¹çš„ RenderFragment
    /// </summary>
    private RenderFragment CreateReceivingDetailManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null)
            {
                // ğŸ”‘ é—œéµæ”¹è®Šï¼šç­‰å¾…æ˜ç´°è³‡æ–™å®Œå…¨æº–å‚™å¥½ï¼ˆåŒ…æ‹¬é€€è²¨æ•¸é‡ç­‰ï¼‰å¾Œæ‰æ¸²æŸ“
                @if (!isDetailDataReady)
                {
                    <div class="d-flex justify-content-center align-items-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span class="text-muted">è¼‰å…¥æ˜ç´°è³‡æ–™ä¸­...</span>
                    </div>
                }
                // ä½¿ç”¨å¤šæ¡è³¼å–®æ¨¡å¼
                else if (editModalComponent.Entity.SupplierId > 0)
                {
                    // å¤šæ¡è³¼å–®æ¨¡å¼
                    try
                    {
                        <PurchaseReceivingDetailManagerComponent @ref="purchaseReceivingDetailManager"
                                                               TMainEntity="PurchaseReceiving" 
                                                               TDetailEntity="PurchaseReceivingDetail"
                                                               SelectedSupplierId="@editModalComponent.Entity.SupplierId"
                                                               SelectedPurchaseOrderId="@editModalComponent.Entity.PurchaseOrderId"
                                                               FilterProductId="@filterProductId"
                                                               MainEntity="@editModalComponent.Entity"
                                                               ExistingDetails="@purchaseReceivingDetails"
                                                               OnDetailsChanged="@HandleReceivingDetailsChanged"
                                                               OnDeletedDetailsChanged="@HandleDeletedDetailsChanged"
                                                               OnHasUndeletableDetailsChanged="@HandleHasUndeletableDetailsChanged"
                                                               OnOpenRelatedDocument="@HandleOpenRelatedDocument"
                                                               MainEntityIdPropertyName="PurchaseReceivingId"
                                                               QuantityPropertyName="ReceivedQuantity"
                                                               UnitPricePropertyName="UnitPrice"
                                                               RemarksPropertyName="InspectionRemarks"
                                                               PurchaseOrderDetailIdPropertyName="PurchaseOrderDetailId"
                                                               ReceivedQuantityLabel="é€²è²¨æ•¸é‡"
                                                               PriceLabel="å–®åƒ¹"
                                                               RemarksLabel="å‚™è¨»"
                                                               ShowWarehouse="true"
                                                               ShowWarehouseLocation="true"
                                                               WarehouseIdPropertyName="WarehouseId"
                                                               WarehouseLocationIdPropertyName="WarehouseLocationId"
                                                               Warehouses="@warehouses"
                                                               WarehouseLocations="@warehouseLocations"
                                                               IsReadOnly="false" />
                    }
                    catch
                    {
                        <div class="alert alert-warning" role="alert">
                            è¼‰å…¥æ˜ç´°ç®¡ç†å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-info text-center" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        è«‹å…ˆé¸æ“‡å» å•†å¾Œå†é€²è¡Œæ¡è³¼æ˜ç´°ç®¡ç†
                    </div>
                }
            }
            else
            {
                <div class="text-center py-3">
                    <span class="text-muted">è«‹å…ˆé¸æ“‡å» å•†å¾Œå†ç®¡ç†é€²è²¨æ˜ç´°</span>
                </div>
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                è¼‰å…¥æ˜ç´°ç®¡ç†å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚
            </div>
        }
    };
    
    // ===== Modal ç®¡ç†å™¨åˆå§‹åŒ–æ–¹æ³• =====
    
    /// <summary>
    /// åˆå§‹åŒ–å» å•† Modal ç®¡ç†å™¨
    /// </summary>
    private void InitializeSupplierModalManager()
    {
        supplierModalManager = new RelatedEntityManagerBuilder<Supplier>(NotificationService, "å» å•†")
            .WithPropertyName(nameof(PurchaseReceiving.SupplierId))
            .WithReloadCallback(LoadAdditionalDataAsync)
            .WithStateChangedCallback(StateHasChanged)
            .WithAutoSelectCallback(supplierId => 
            {
                if (editModalComponent?.Entity != null)
                {
                    editModalComponent.Entity.SupplierId = supplierId;
                }
            })
            .WithCustomPostProcess(async supplier => 
            {
                await InitializeFormFieldsAsync();
            })
            .Build();
    }

    /// <summary>
    /// ç”¢ç”Ÿå» å•†æ“ä½œæŒ‰éˆ• - ä½¿ç”¨çµ±ä¸€ Helper
    /// </summary>
    private async Task<List<FieldActionButton>> GetSupplierActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent, 
            supplierModalManager, 
            nameof(PurchaseReceiving.SupplierId)
        );
    }

    /// <summary>
    /// åŒ…è£å» å•†å„²å­˜äº‹ä»¶
    /// </summary>
    private async Task OnSupplierSavedWrapper(Supplier savedSupplier)
    {
        await supplierModalManager.HandleEntitySavedAsync(savedSupplier, shouldAutoSelect: true);
    }

    /// <summary>
    /// è™•ç†é–‹å•Ÿç›¸é—œå–®æ“šçš„äº‹ä»¶
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            if (args.type == RelatedDocumentType.ReturnDocument)
            {
                // é–‹å•Ÿé€²è²¨é€€å‡º Modal
                selectedPurchaseReturnId = args.id;
                showPurchaseReturnModal = true;
            }
            else if (args.type == RelatedDocumentType.SetoffDocument)
            {
                // é–‹å•Ÿæ²–æ¬¾å–® Modal
                selectedSetoffDocumentId = args.id;
                showSetoffDocumentModal = true;
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é–‹å•Ÿå–®æ“šå¤±æ•—ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// è™•ç†é€²è²¨é€€å‡ºå„²å­˜å¾Œçš„äº‹ä»¶
    /// </summary>
    private async Task HandlePurchaseReturnSaved(PurchaseReturn savedReturn)
    {
        // é—œé–‰ Modal
        showPurchaseReturnModal = false;
        selectedPurchaseReturnId = null;
        
        // é‡æ–°è¼‰å…¥é€²è²¨æ˜ç´°çš„é€€è²¨æ•¸é‡è³‡è¨Š
        if (purchaseReceivingDetailManager != null)
        {
            await purchaseReceivingDetailManager.LoadReturnedQuantitiesAsync();
        }
        
        StateHasChanged();
    }

    /// <summary>
    /// è™•ç†æ²–æ¬¾å–®å„²å­˜å¾Œçš„äº‹ä»¶
    /// </summary>
    private void HandleSetoffDocumentSaved(SetoffDocument savedDocument)
    {
        // é—œé–‰ Modal
        showSetoffDocumentModal = false;
        selectedSetoffDocumentId = null;
        
        // å¦‚æœéœ€è¦ï¼Œå¯ä»¥é‡æ–°è¼‰å…¥ç›¸é—œè³‡æ–™
        // ç›®å‰æ²’æœ‰ç‰¹åˆ¥éœ€è¦é‡æ–°è¼‰å…¥çš„è³‡æ–™
        
        StateHasChanged();
    }

    /// <summary>
    /// é‡‹æ”¾è³‡æº
    /// </summary>
    public void Dispose()
    {
        try
        {
            // æ¸…ç†ä»»ä½•éœ€è¦æ¸…ç†çš„è³‡æº
            purchaseReceivingDetails?.Clear();
            formFields?.Clear();
            formSections?.Clear();
            purchaseOrders?.Clear();
            warehouses?.Clear();
            warehouseLocations?.Clear();
            suppliers?.Clear();
            employees?.Clear();
            products?.Clear();
        }
        catch
        {
            // å¿½ç•¥æ¸…ç†éç¨‹ä¸­çš„éŒ¯èª¤
        }
    }
}
