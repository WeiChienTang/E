@* 採購入庫明細管理組件 - 簡化版本 *@

@using ERPCore2.Helpers.InteractiveTableComponentHelper
@using ERPCore2.Helpers
@using ERPCore2.Models.Enums
@inject IStringLocalizer<SharedResource> L
@inject IProductService ProductService
@inject IPurchaseOrderService PurchaseOrderService
@inject IPurchaseReceivingDetailService PurchaseReceivingDetailService
@inject ISystemParameterService SystemParameterService
@inject INotificationService NotificationService
@inject RelatedDocumentsHelper RelatedDocumentsHelper
@inject IPurchaseReturnDetailService PurchaseReturnDetailService
@inject IJSRuntime JSRuntime

@inherits BaseDetailTableComponent<PurchaseReceiving, PurchaseReceivingDetail, PurchaseReceivingTable.ReceivingItem>

@if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <p class="text-muted">請先選擇廠商</p>
        </div>
    </div>
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="ReceivingItem"
                                      OnDataChanged="@NotifyDetailsChangedAsync"
                                      Items="@Items"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"
                                      EmptyMessage="尚未新增入庫商品"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="false"
                                      ActionsColumnWidth="60px"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"
                                      OnItemDelete="@HandleItemDelete"
                                      EnableAutoEmptyRow="true"
                                      AllowAddNewRow="@(!_hasUndeletableDetails && !IsReadOnly)"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@(() => new ReceivingItem())" />
        </div>
        
        <div class="card-footer">
            <div class="table-action-bar">
                @* 左側按鈕組 *@
                <div class="btn-group-left">
                    <GenericButtonComponent
                                          Text="智能下單"
                                          OnClick="@SmartLoadReceivingDetails"
                                          IsDisabled="@(!CanUseSmartLoad || IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetSmartLoadTooltip()"
                                          Variant="ButtonVariant.DarkBlue"
                                          Size="ButtonSize.Small" />
                    <GenericButtonComponent
                                          Text="載入"
                                          OnClick="@ShowLoadConfirmModal"
                                          IsDisabled="@(IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetLoadPurchaseOrderTooltip()"
                                          Variant="ButtonVariant.DarkBlue"
                                          Size="ButtonSize.Small" />
                </div>
                
                @* 右側按鈕組 *@
                <div class="btn-group-right">
                    @* 倉庫統一按鈕（下拉選單） *@
                    <div class="dropdown">
                        <GenericButtonComponent
                                              Text="倉庫統一"
                                              Variant="ButtonVariant.Green"
                                              Size="ButtonSize.Small"
                                              IsDisabled="@(!HasItems || IsReadOnly || _hasUndeletableDetails)"
                                              Title="@GetUnifyWarehouseTooltip()"
                                              AdditionalAttributes="@(new Dictionary<string, object> 
                                              { 
                                                  { "data-bs-toggle", "dropdown" },
                                                  { "aria-expanded", "false" }
                                              })" />
                        <ul class="dropdown-menu dropdown-menu-end">
                            @if (Warehouses.Any())
                            {
                                @foreach (var warehouse in Warehouses)
                                {
                                    <li>
                                        <a class="dropdown-item" 
                                           href="#" 
                                           @onclick="() => UnifyWarehouse(warehouse.Id)"
                                           @onclick:preventDefault="true">
                                            @warehouse.Name
                                        </a>
                                    </li>
                                }
                            }
                            else
                            {
                                <li><span class="dropdown-item-text text-muted">無可用倉庫</span></li>
                            }
                        </ul>
                    </div>
                    
                    <GenericButtonComponent
                                          Text="清除明細"
                                          OnClick="@ClearAllDetails"
                                          IsDisabled="@(!HasItems || IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetClearDetailsTooltip()"
                                          Variant="ButtonVariant.Red"
                                          Size="ButtonSize.Small" />
                </div>
            </div>
        </div>
    </div>
}

<!-- 相關單據查看 Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

<!-- 載入確認 Modal -->
<GenericConfirmModalComponent IsVisible="@_showLoadConfirmModal"
                             IsVisibleChanged="@((bool visible) => _showLoadConfirmModal = visible)"
                             Title="載入確認"
                             Icon="bi-box-arrow-in-down"
                             Message="即將載入以下條件的待進貨明細："
                             Conditions="@_loadConditions"
                             SummaryMessage="@_loadSummaryMessage"
                             ConfirmButtonVariant="ButtonVariant.Blue"
                             OnConfirm="@ExecuteLoadAllUnreceivedItems"
                             OnCancel="@(() => _showLoadConfirmModal = false)" />

@code {
    // ===== 參數 =====
    [Parameter] public int? SelectedPurchaseOrderId { get; set; }
    [Parameter] public int? FilterProductId { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }
    [Parameter] public bool ShowWarehouse { get; set; } = true;
    [Parameter] public bool ShowWarehouseLocation { get; set; } = true;
    [Parameter] public List<Warehouse> Warehouses { get; set; } = new();
    [Parameter] public List<WarehouseLocation> WarehouseLocations { get; set; } = new();
    [Parameter] public TaxCalculationMethod TaxCalculationMethod { get; set; } = TaxCalculationMethod.TaxExclusive;
    
    // ===== 私有欄位 =====
    private List<Product> AvailableProducts { get; set; } = new();
    private List<PurchaseOrderDetail> AvailablePurchaseDetails { get; set; } = new();
    private List<int> _deletedDetailIds = new(); // 追蹤已刪除的明細ID
    private Dictionary<int, decimal> _returnedQuantities = new(); // 追蹤每個明細的已退貨數量 (Key: DetailId, Value: 已退貨數量)
    
    // ===== 相關單據查看 =====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;
    
    // ===== 載入確認 Modal =====
    private bool _showLoadConfirmModal = false;
    private List<string> _loadConditions = new();
    private string _loadSummaryMessage = string.Empty;
    
    // ===== 額外參數（用於顯示確認訊息） =====
    [Parameter] public string? SelectedSupplierName { get; set; }
    [Parameter] public string? SelectedPurchaseOrderCode { get; set; }
    [Parameter] public string? FilterProductName { get; set; }
    
    // ===== 內部類別 =====
    public class ReceivingItem
    {
        // 基本資料
        public Product? SelectedProduct { get; set; }
        public PurchaseOrderDetail? SelectedPurchaseDetail { get; set; }  // 採購明細
        public string ProductSearchValue { get; set; } = string.Empty;
        
        // 數量和價格
        public int OrderQuantity { get; set; }
        public int ReceivedQuantity { get; set; }
        public int TotalReturnedQuantity { get; set; } // 累計退貨數量
        public decimal UnitPrice { get; set; }
        public decimal TaxRate { get; set; }
        
        // 倉庫
        public Warehouse? SelectedWarehouse { get; set; }
        public WarehouseLocation? SelectedWarehouseLocation { get; set; }
        
        // 倉庫ID（用於Select欄位綁定）
        public int? WarehouseId
        {
            get => SelectedWarehouse?.Id;
            set
            {
                // 當設定值時，需要從 Warehouses 集合中找到對應的倉庫物件
                // 這個設定會在 OnWarehouseChange 中處理
            }
        }
        
        // 備註
        public string Remarks { get; set; } = string.Empty;
        
        // SearchableSelect 需要的屬性
        public List<object> FilteredItems { get; set; } = new();
        public bool ShowDropdown { get; set; }
        public int SelectedIndex { get; set; } = -1;
        
        // 現有實體（編輯模式用）
        public PurchaseReceivingDetail? ExistingDetailEntity { get; set; }
    }
    
    // ===== 生命週期 =====
    private int? _previousPurchaseOrderId = null; // 追蹤採購單變更
    private int? _previousFilterProductId = null; // 追蹤商品篩選變更

    protected override async Task OnInitializedAsync()
    {
        _previousPurchaseOrderId = SelectedPurchaseOrderId;
        _previousFilterProductId = FilterProductId;
        await base.OnInitializedAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        bool purchaseOrderChanged = _previousPurchaseOrderId != SelectedPurchaseOrderId;
        bool filterProductChanged = _previousFilterProductId != FilterProductId;

        await base.OnParametersSetAsync();

        if (purchaseOrderChanged || filterProductChanged)
        {
            _previousPurchaseOrderId = SelectedPurchaseOrderId;
            _previousFilterProductId = FilterProductId;
            await LoadProductsAsync();
            StateHasChanged();
        }
    }

    protected override async Task OnCounterpartyChangedAsync()
    {
        await LoadProductsAsync();
    }

    protected override async Task LoadItemsFromDetailsAsync()
    {
        _deletedDetailIds.Clear();
        foreach (var detail in ExistingDetails.OfType<PurchaseReceivingDetail>())
        {
            var item = new ReceivingItem
            {
                SelectedPurchaseDetail = detail.PurchaseOrderDetail,
                SelectedProduct = detail.Product,
                ProductSearchValue = detail.PurchaseOrderDetail != null
                    ? FormatPurchaseDetailDisplay(detail.PurchaseOrderDetail)
                    : (detail.Product != null ? FormatProductDisplay(detail.Product) : ""),
                OrderQuantity = detail.OrderQuantity,
                ReceivedQuantity = detail.ReceivedQuantity,
                TotalReturnedQuantity = detail.TotalReturnedQuantity,
                UnitPrice = detail.UnitPrice,
                TaxRate = detail.TaxRate ?? await SystemParameterService.GetTaxRateAsync(),
                SelectedWarehouse = detail.Warehouse,
                SelectedWarehouseLocation = detail.WarehouseLocation,
                Remarks = detail.Remarks ?? "",
                ExistingDetailEntity = detail
            };
            Items.Add(item);
        }
        await LoadReturnedQuantitiesAsync();
    }

    protected override bool ComputeHasUndeletableDetails()
        => Items.Any(item => item.ExistingDetailEntity != null &&
            !DetailLockHelper.CanDeleteItem(item.ExistingDetailEntity, out _,
                checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities));

    protected override List<PurchaseReceivingDetail> ConvertItemsToDetails()
    {
        var entities = new List<PurchaseReceivingDetail>();
        foreach (var item in Items.Where(x => x.SelectedProduct != null))
        {
            PurchaseReceivingDetail entity = item.ExistingDetailEntity ?? new PurchaseReceivingDetail();
            if (item.ExistingDetailEntity == null && MainEntity != null)
                entity.PurchaseReceivingId = MainEntity.Id;

            entity.ProductId = item.SelectedProduct!.Id;
            entity.ReceivedQuantity = item.ReceivedQuantity;
            entity.OrderQuantity = item.OrderQuantity > 0 ? item.OrderQuantity : item.ReceivedQuantity;
            entity.UnitPrice = item.UnitPrice;
            entity.TaxRate = item.TaxRate;
            entity.Remarks = item.Remarks;
            entity.PurchaseOrderDetailId = item.SelectedPurchaseDetail?.Id;
            if (item.SelectedWarehouse != null) entity.WarehouseId = item.SelectedWarehouse.Id;
            if (item.SelectedWarehouseLocation != null) entity.WarehouseLocationId = item.SelectedWarehouseLocation.Id;
            entities.Add(entity);
        }
        return entities;
    }
    
    // ===== 欄位定義 =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();
        
        // 1. 商品編號/名稱 - 觸發欄位
        columns.Add(new InteractiveColumnDefinition
        {
            Title = L["Column.ProductCodeName"],
            PropertyName = "ProductSearchValue",
            EmptyCheckPropertyName = "SelectedProduct",
            TriggerEmptyRowOnFilled = true,  // 選擇後自動新增空行
            ColumnType = InteractiveColumnType.SearchableSelect,
            Width = "300px",
            Placeholder = "請輸入商品編號或名稱",
            SearchValuePropertyName = nameof(ReceivingItem.ProductSearchValue),
            FilteredItemsPropertyName = nameof(ReceivingItem.FilteredItems),
            ShowDropdownPropertyName = nameof(ReceivingItem.ShowDropdown),
            SelectedIndexPropertyName = nameof(ReceivingItem.SelectedIndex),
            IsDisabledFunc = item =>
            {
                var receivingItem = (ReceivingItem)item;
                var isEmptyRow = receivingItem.SelectedProduct == null;
                return !DetailLockHelper.CanDeleteItem(receivingItem.ExistingDetailEntity, out _, 
                    checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities) && !isEmptyRow;
            },
            ItemDisplayFormatter = (item) =>
            {
                if (item is PurchaseOrderDetail detail)
                    return FormatPurchaseDetailDropdownText(detail);
                else if (item is Product product)
                    return FormatProductDropdownText(product);
                return string.Empty;
            },
            OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                await OnProductSearch((ReceivingItem)args.Item1, args.Item2);
            }),
            OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async args =>
            {
                await OnProductSelect((ReceivingItem)args.Item1, args.Item2);
            }),
            OnInputFocus = EventCallback.Factory.Create<object>(this, item =>
            {
                OnProductFocus((ReceivingItem)item);
            }),
            OnInputBlur = EventCallback.Factory.Create<object>(this, item =>
            {
                OnProductBlur((ReceivingItem)item);
            }),
            EnableKeyboardNavigation = true,
            GetDropdownItems = (item) => ((ReceivingItem)item).FilteredItems,
            GetSelectedIndex = (item) => ((ReceivingItem)item).SelectedIndex,
            SetSelectedIndex = (item, index) => ((ReceivingItem)item).SelectedIndex = index,
            GetShowDropdown = (item) => ((ReceivingItem)item).ShowDropdown,
            SetShowDropdown = (item, show) => ((ReceivingItem)item).ShowDropdown = show,
            MaxDisplayItems = 20
        });
        
        // 2. 採購數量（唯讀）
        columns.Add(new InteractiveColumnDefinition
        {
            Title = L["Column.PurchaseQuantity"],
            PropertyName = "OrderQuantity",
            ColumnType = InteractiveColumnType.Display,
            Width = "100px",
            TextAlign = "right",
            IsReadOnly = true
        });
        
        // 3. 入庫數量
        columns.Add(new InteractiveColumnDefinition
        {
            Title = L["Column.ReceivedQuantity"],
            PropertyName = "ReceivedQuantity",
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            MinValue = 0,
            IsDisabledFunc = item =>
            {
                var receivingItem = (ReceivingItem)item;
                var isEmptyRow = receivingItem.SelectedProduct == null;
                return !DetailLockHelper.CanDeleteItem(receivingItem.ExistingDetailEntity, out _, 
                    checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities) && !isEmptyRow;
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                await OnQuantityChange((ReceivingItem)args.Item1, args.Item2);
            })
        });
        
        // 4. 已退數量（唯讀，顯示累計退貨數量）
        columns.Add(new InteractiveColumnDefinition
        {
            Title = L["Column.AlreadyReturnedQuantity"],
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "100px",
            CustomTemplate = item =>
            {
                var receivingItem = (ReceivingItem)item;
                var totalReturned = receivingItem.TotalReturnedQuantity;
                
                if (totalReturned > 0)
                {
                    // 有退貨記錄：用藍色顯示並加上圖示
                    return @<div class="text-end text-info fw-bold" title="已有退貨記錄">
                        <i class="bi bi-arrow-return-left me-1"></i>@totalReturned
                    </div>;
                }
                else if (receivingItem.SelectedProduct != null)
                {
                    // 無退貨記錄：用灰色顯示
                    return @<div class="text-end text-muted">0</div>;
                }
                else
                {
                    // 空行：不顯示
                    return @<div class="text-end text-muted">-</div>;
                }
            }
        });
        
        // 5. 單價
        columns.Add(new InteractiveColumnDefinition
        {
            Title = L["Column.UnitPrice"],
            PropertyName = "UnitPrice",
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            MinValue = 0,
            IsDisabledFunc = item =>
            {
                var receivingItem = (ReceivingItem)item;
                var isEmptyRow = receivingItem.SelectedProduct == null;
                return !DetailLockHelper.CanDeleteItem(receivingItem.ExistingDetailEntity, out _, 
                    checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities) && !isEmptyRow;
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                await OnPriceChange((ReceivingItem)args.Item1, args.Item2);
            })
        });
        
        // 6. 稅率%
        columns.Add(new InteractiveColumnDefinition
        {
            Title = L["Field.TaxRate"],
            PropertyName = "TaxRate",
            ColumnType = InteractiveColumnType.Number,
            Width = "80px",
            MinValue = 0,
            MaxValue = 100,
            IsDisabledFunc = item =>
            {
                var receivingItem = (ReceivingItem)item;
                var isEmptyRow = receivingItem.SelectedProduct == null;
                // 免稅模式 或 已有退貨/沖款記錄時禁用
                return TaxCalculationMethod == TaxCalculationMethod.NoTax ||
                       (!DetailLockHelper.CanDeleteItem(receivingItem.ExistingDetailEntity, out _, 
                           checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities) && !isEmptyRow);
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                await OnTaxRateChange((ReceivingItem)args.Item1, args.Item2);
            })
        });
        
        // 7. 小計（計算欄位）
        columns.Add(new InteractiveColumnDefinition
        {
            Title = L["Column.Subtotal"],
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item =>
            {
                var receivingItem = (ReceivingItem)item;
                var subtotal = CalculateSubtotal(receivingItem);
                return @<div class="text-end fw-bold text-success">@subtotal.ToString("N0")</div>;
            }
        });
        
        // 8. 倉庫
        columns.Add(new InteractiveColumnDefinition
        {
            Title = L["Entity.Warehouse"],
            PropertyName = "WarehouseId",
            ColumnType = InteractiveColumnType.Select,
            Width = "120px",
            Placeholder = "請選擇",
            Options = Warehouses.Select(w => new InteractiveSelectOption
            {
                Value = w.Id.ToString(),
                Text = w.Name
            }).ToList(),
            IsDisabledFunc = item =>
            {
                var receivingItem = (ReceivingItem)item;
                var isEmptyRow = receivingItem.SelectedProduct == null;
                return !DetailLockHelper.CanDeleteItem(receivingItem.ExistingDetailEntity, out _, 
                    checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities) && !isEmptyRow;
            },
            OnSelectionChanged = EventCallback.Factory.Create<(object, object?)>(this, async args =>
            {
                await OnWarehouseChange((ReceivingItem)args.Item1, args.Item2?.ToString());
            })
        });
        
        // 9. 庫位
        columns.Add(new InteractiveColumnDefinition
        {
            Title = L["Column.Location"],
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item =>
            {
                var receivingItem = (ReceivingItem)item;
                var selectedLocationId = receivingItem.SelectedWarehouseLocation?.Id.ToString() ?? "";
                
                var availableLocations = receivingItem.SelectedWarehouse != null
                    ? WarehouseLocations.Where(wl => wl.WarehouseId == receivingItem.SelectedWarehouse.Id).ToList()
                    : new List<WarehouseLocation>();
                
                // 檢查是否應該禁用（唯讀模式 或 已有退貨/沖款記錄）
                var isEmptyRow = receivingItem.SelectedProduct == null;
                var isDisabled = IsReadOnly || 
                                (!DetailLockHelper.CanDeleteItem(receivingItem.ExistingDetailEntity, out _, 
                                    checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities) && !isEmptyRow);
                
                if (isDisabled)
                {
                    var displayText = receivingItem.SelectedWarehouseLocation?.Name ?? "未選擇";
                    return @<span class="text-muted">@displayText</span>;
                }
                
                return @<select class="form-select form-select-sm"
                               value="@selectedLocationId"
                               @onchange="(e) => OnWarehouseLocationChange(receivingItem, e.Value?.ToString())">
                    <option value="">請選擇</option>
                    @foreach (var location in availableLocations)
                    {
                        <option value="@location.Id">@location.Name</option>
                    }
                </select>;
            }
        });
        
        // 10. 備註 - 使用 Custom 類型，確保有下一步時仍可編輯（參考 PurchaseOrderTable.razor）
        columns.Add(new InteractiveColumnDefinition
        {
            Title = L["Label.Remarks"],
            PropertyName = "Remarks",
            ColumnType = InteractiveColumnType.Custom,
            Width = "150px",
            HideOnMobile = true,
            ExcludeFromEmptyCheck = true,  // 備註不參與空行檢查
            Tooltip = "選填。可記錄入庫相關的備註資訊（有退貨或沖款記錄時仍可編輯）",
            CustomTemplate = item =>
            {
                var receivingItem = (ReceivingItem)item;
                // 備註欄位只受 IsReadOnly 影響，有下一步（退貨/沖款）時仍可編輯
                var isFieldReadOnly = IsReadOnly;
                
                // 如果是唯讀狀態，直接顯示 span
                if (isFieldReadOnly)
                {
                    var displayText = string.IsNullOrEmpty(receivingItem.Remarks) ? "無備註" : receivingItem.Remarks;
                    return @<div class="d-flex align-items-center" style="min-height: 31px;">
                        <span class="text-muted">@displayText</span>
                    </div>;
                }
                
                return @<input type="text" class="form-control" 
                               value="@receivingItem.Remarks"
                               @oninput="(e) => OnRemarksInput(receivingItem, e.Value?.ToString())"/>;
            }
        });
        
        return columns;
    }
    
    // ===== 事件處理 =====
    
    // 商品搜尋
    private Task OnProductSearch(ReceivingItem item, string? searchValue)
    {
        item.ProductSearchValue = searchValue ?? string.Empty;
        
        var combinedItems = new List<object>();
        
        if (!string.IsNullOrWhiteSpace(searchValue))
        {
            // 1. 搜尋採購明細（優先顯示）
            var filteredDetails = AvailablePurchaseDetails
                .Where(d =>
                    (d.PurchaseOrder?.Code != null && d.PurchaseOrder.Code.Contains(searchValue, StringComparison.OrdinalIgnoreCase)) ||
                    (d.Product?.Code != null && d.Product.Code.Contains(searchValue, StringComparison.OrdinalIgnoreCase)) ||
                    (d.Product?.Name != null && d.Product.Name.Contains(searchValue, StringComparison.OrdinalIgnoreCase)))
                .Take(10)
                .ToList();
            
            // 2. 搜尋一般商品
            var filteredProducts = AvailableProducts
                .Where(p =>
                    (p.Code != null && p.Code.Contains(searchValue, StringComparison.OrdinalIgnoreCase)) ||
                    (p.Name != null && p.Name.Contains(searchValue, StringComparison.OrdinalIgnoreCase)))
                .Take(10)
                .ToList();
            
            combinedItems.AddRange(filteredDetails.Cast<object>());
            combinedItems.AddRange(filteredProducts.Cast<object>());
        }
        else
        {
            // 沒有搜尋條件時，優先顯示採購明細，然後是一般商品
            var topDetails = AvailablePurchaseDetails.Take(10).ToList();
            var topProducts = AvailableProducts.Take(10).ToList();
            
            combinedItems.AddRange(topDetails.Cast<object>());
            combinedItems.AddRange(topProducts.Cast<object>());
        }
        
        item.FilteredItems = combinedItems;
        item.ShowDropdown = true;
        item.SelectedIndex = -1;
        
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    private void OnProductFocus(ReceivingItem item)
    {
        _ = OnProductSearch(item, item.ProductSearchValue);
    }
    
    private void OnProductBlur(ReceivingItem item)
    {
        Task.Delay(200).ContinueWith(_ =>
        {
            item.ShowDropdown = false;
            InvokeAsync(StateHasChanged);
        });
    }
    
    // 商品選擇
    private async Task OnProductSelect(ReceivingItem item, object? selectedItem)
    {
        if (selectedItem is PurchaseOrderDetail detail)
        {
            // 選擇採購明細
            item.SelectedPurchaseDetail = detail;
            item.SelectedProduct = detail.Product;
            item.ProductSearchValue = FormatPurchaseDetailDisplay(detail);
            item.OrderQuantity = detail.OrderQuantity;
            item.ReceivedQuantity = detail.PendingQuantity; // 預設填入待進貨數量
            item.UnitPrice = detail.UnitPrice;
            item.TaxRate = detail.TaxRate ?? detail.Product?.TaxRate ?? await SystemParameterService.GetTaxRateAsync();
        }
        else if (selectedItem is Product product)
        {
            // 選擇一般商品
            item.SelectedPurchaseDetail = null;
            item.SelectedProduct = product;
            item.ProductSearchValue = FormatProductDisplay(product);
            item.OrderQuantity = 0;
            item.ReceivedQuantity = 0;
            item.UnitPrice = 0; // 需手動輸入單價
            item.TaxRate = product.TaxRate ?? await SystemParameterService.GetTaxRateAsync();
        }
        else
        {
            item.SelectedPurchaseDetail = null;
            item.SelectedProduct = null;
            item.ProductSearchValue = string.Empty;
        }
        
        item.ShowDropdown = false;
        item.SelectedIndex = -1;
        await NotifyDetailsChangedAsync();
    }
    
    // 數量變更
    private async Task OnQuantityChange(ReceivingItem item, string? value)
    {
        item.ReceivedQuantity = InputEventHelper.HandleIntegerInput(value);
        await NotifyDetailsChangedAsync();
    }
    
    // 單價變更
    private async Task OnPriceChange(ReceivingItem item, string? value)
    {
        item.UnitPrice = InputEventHelper.HandlePriceInput(value);
        await NotifyDetailsChangedAsync();
    }
    
    // 稅率變更
    private async Task OnTaxRateChange(ReceivingItem item, string? value)
    {
        item.TaxRate = InputEventHelper.HandlePercentageInput(value);
        await NotifyDetailsChangedAsync();
    }
    
    // 倉庫變更
    private async Task OnWarehouseChange(ReceivingItem item, string? warehouseIdStr)
    {
        if (int.TryParse(warehouseIdStr, out var warehouseId))
        {
            item.SelectedWarehouse = Warehouses.FirstOrDefault(w => w.Id == warehouseId);
        }
        else
        {
            item.SelectedWarehouse = null;
        }
        
        // 清空庫位
        item.SelectedWarehouseLocation = null;
        await NotifyDetailsChangedAsync();
    }
    
    // 庫位變更
    private async Task OnWarehouseLocationChange(ReceivingItem item, string? locationIdStr)
    {
        if (int.TryParse(locationIdStr, out var locationId))
        {
            item.SelectedWarehouseLocation = WarehouseLocations.FirstOrDefault(wl => wl.Id == locationId);
        }
        else
        {
            item.SelectedWarehouseLocation = null;
        }
        await NotifyDetailsChangedAsync();
    }
    
    // 備註變更
    private async Task OnRemarksChange(ReceivingItem item, string? value)
    {
        item.Remarks = InputEventHelper.HandleTextInput(value);
        await NotifyDetailsChangedAsync();
    }
    
    // 備註輸入 - 用於 Custom 類型的 @oninput 事件
    private async Task OnRemarksInput(ReceivingItem item, string? value)
    {
        item.Remarks = InputEventHelper.HandleTextInput(value);
        await NotifyDetailsChangedAsync();
    }
    
    // 刪除項目
    private async Task HandleItemDelete(ReceivingItem item)
    {
        // 如果是現有明細，記錄其ID以便後續刪除
        if (item.ExistingDetailEntity != null && item.ExistingDetailEntity.Id > 0 &&
            !_deletedDetailIds.Contains(item.ExistingDetailEntity.Id))
        {
            _deletedDetailIds.Add(item.ExistingDetailEntity.Id);
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds);
        }

        Items.Remove(item);
        await NotifyDetailsChangedAsync();
    }
    
    // ===== 自訂操作按鈕模板 =====
    private RenderFragment<ReceivingItem> GetCustomActionsTemplate => item => __builder =>
    {
        var isLastEmptyRow = tableComponent?.IsLastEmptyRow(item) ?? false;
        
        // 使用 DetailLockHelper 檢查是否可以刪除（需傳入退貨數量字典）
        if (isLastEmptyRow)
        {
            // 最後一個空行：顯示禁用的刪除按鈕
            <GenericButtonComponent Variant="ButtonVariant.Red"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="true"
                                   Title="至少需要保留一個空行"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else if (DetailLockHelper.CanDeleteItem(item.ExistingDetailEntity, out _, 
            checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities))
        {
            // 可以刪除：顯示刪除按鈕
            <GenericButtonComponent Variant="ButtonVariant.Red"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="@IsReadOnly"
                                   Title="刪除"
                                   OnClick="async () => await HandleItemDelete(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else
        {
            // 已被使用：顯示查看按鈕
            <GenericButtonComponent Variant="ButtonVariant.Blue"
                                   IconClass="bi bi-eye text-white"
                                   Size="ButtonSize.Large"
                                   Title="查看相關單據"
                                   OnClick="async () => await ShowRelatedDocuments(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
    };
    
    // ===== 輔助方法 =====
    
    // 載入商品清單
    private async Task LoadProductsAsync()
    {
        if (SelectedSupplierId.HasValue && SelectedSupplierId.Value > 0)
        {
            // 1. 載入採購明細（未完成進貨的，不檢查審核狀態）
            var allPurchaseDetails = await PurchaseOrderService.GetReceivingDetailsBySupplierAsync(
                SelectedSupplierId.Value,
                includeCompleted: false,
                checkApproval: false);
            
            // 根據 SelectedPurchaseOrderId 篩選採購明細
            if (SelectedPurchaseOrderId.HasValue && SelectedPurchaseOrderId.Value > 0)
            {
                AvailablePurchaseDetails = allPurchaseDetails
                    .Where(d => d.PurchaseOrderId == SelectedPurchaseOrderId.Value)
                    .ToList();
            }
            else
            {
                AvailablePurchaseDetails = allPurchaseDetails;
            }
            
            // 根據 FilterProductId 進一步篩選採購明細
            if (FilterProductId.HasValue && FilterProductId.Value > 0)
            {
                AvailablePurchaseDetails = AvailablePurchaseDetails
                    .Where(d => d.ProductId == FilterProductId.Value)
                    .ToList();
            }
            
            // 2. 載入所有啟用的商品
            var allProducts = await ProductService.GetActiveProductsAsync();
            AvailableProducts = allProducts.ToList();
            
            // 根據 FilterProductId 篩選商品
            if (FilterProductId.HasValue && FilterProductId.Value > 0)
            {
                AvailableProducts = AvailableProducts
                    .Where(p => p.Id == FilterProductId.Value)
                    .ToList();
            }
        }
        else
        {
            AvailablePurchaseDetails = new List<PurchaseOrderDetail>();
            AvailableProducts = new List<Product>();
        }
    }
    
    // 計算小計
    private decimal CalculateSubtotal(ReceivingItem item)
    {
        if (item.ReceivedQuantity <= 0 || item.UnitPrice <= 0)
            return 0;
        
        var baseAmount = item.ReceivedQuantity * item.UnitPrice;
        
        return TaxCalculationMethod switch
        {
            TaxCalculationMethod.TaxExclusive => Math.Round(baseAmount * (1 + item.TaxRate / 100), 0),
            TaxCalculationMethod.TaxInclusive => Math.Round(baseAmount, 0),
            TaxCalculationMethod.NoTax => Math.Round(baseAmount, 0),
            _ => Math.Round(baseAmount, 0)
        };
    }
    
    /// <summary>
    /// 格式化採購明細顯示文字（用於下拉選單 - 兩行顯示）
    /// 第一行：採購單號 + 待進數量（小字藍色）
    /// 第二行：商品編號 商品名稱
    /// </summary>
    private string FormatPurchaseDetailDropdownText(PurchaseOrderDetail detail)
    {
        if (detail?.Product == null) return "";
        
        var product = detail.Product;
        var purchaseOrderNumber = detail.PurchaseOrder?.Code ?? "N/A";
        var pendingQty = detail.PendingQuantity;
        
        var productDisplay = !string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name)
            ? $"{product.Code} {product.Name}"
            : (!string.IsNullOrEmpty(product.Code) ? product.Code : product.Name ?? "");
        
        // 兩行顯示：採購單號在上（小字藍色），商品資訊在下
        return $"<div style='line-height: 1.3;'>" +
               $"<small class='text-primary'>採購: {purchaseOrderNumber} (待進: {pendingQty:G29})</small><br/>" +
               $"<span>{productDisplay}</span></div>";
    }
    
    /// <summary>
    /// 格式化一般商品顯示文字（用於下拉選單 - 兩行顯示）
    /// </summary>
    private string FormatProductDropdownText(Product product)
    {
        if (product == null) return "";
        
        var productDisplay = !string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name)
            ? $"{product.Code} {product.Name}"
            : (!string.IsNullOrEmpty(product.Code) ? product.Code : product.Name ?? "");
        
        // 兩行顯示：提示文字在上（小字灰色），商品資訊在下
        return $"<div style='line-height: 1.3;'>" +
               $"<small class='text-muted'>一般商品</small><br/>" +
               $"<span>{productDisplay}</span></div>";
    }
    
    /// <summary>
    /// 格式化採購明細顯示文字（用於輸入框顯示 - 單行簡潔格式）
    /// </summary>
    private string FormatPurchaseDetailDisplay(PurchaseOrderDetail detail)
    {
        if (detail?.Product == null) return "";
        
        var product = detail.Product;
        var purchaseOrderNumber = detail.PurchaseOrder?.Code ?? "N/A";
        
        var productDisplay = !string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name)
            ? $"{product.Code} {product.Name}"
            : (!string.IsNullOrEmpty(product.Code) ? product.Code : product.Name ?? "");
        
        // 輸入框顯示：簡潔的單行格式
        return $"{purchaseOrderNumber} | {productDisplay}";
    }
    
    /// <summary>
    /// 格式化商品顯示（用於輸入框顯示 - 單行簡潔格式）
    /// </summary>
    private string FormatProductDisplay(Product product)
    {
        if (product == null) return "";
        
        if (!string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name))
            return $"{product.Code} {product.Name}";
        
        return product.Code ?? product.Name ?? "";
    }
    
    // ===== 公開方法 =====

    /// <summary>
    /// 驗證明細資料（供父組件呼叫）
    /// </summary>
    public async Task<bool> ValidateAsync()
    {
        // 檢查是否有有效的明細
        var validItems = Items.Where(x => x.SelectedProduct != null && x.ReceivedQuantity > 0).ToList();
        
        if (!validItems.Any())
        {
            await NotificationService.ShowWarningAsync("請至少新增一筆商品明細");
            return false;
        }
        
        // 檢查每筆明細是否都有選擇倉庫
        var itemsWithoutWarehouse = validItems.Where(x => x.SelectedWarehouse == null).ToList();
        if (itemsWithoutWarehouse.Any())
        {
            var productNames = string.Join("、", itemsWithoutWarehouse.Select(x => x.SelectedProduct?.Name ?? "未知商品"));
            await NotificationService.ShowWarningAsync($"以下商品尚未選擇倉庫：{productNames}");
            return false;
        }

        return true;
    }
    
    /// <summary>
    /// 載入退貨數量 - 從進貨明細的 TotalReturnedQuantity 欄位直接讀取
    /// 簡化版：不再需要查詢 PurchaseReturnDetail 表，直接從 Entity 讀取
    /// </summary>
    public async Task LoadReturnedQuantitiesAsync()
    {
        try
        {
            _returnedQuantities.Clear();
            
            // 只處理已儲存的明細（有ID的）
            var items = Items
                .Where(item => item.ExistingDetailEntity != null)
                .ToList();
            
            if (!items.Any())
            {
                return;
            }
            
            // 直接從 ReceivingItem 的 TotalReturnedQuantity 屬性讀取
            // 這個值已經在 LoadItemsFromDetailsAsync 中從 Entity 載入
            foreach (var item in items)
            {
                var detailId = item.ExistingDetailEntity!.Id;
                if (detailId > 0 && item.TotalReturnedQuantity > 0)
                {
                    _returnedQuantities[detailId] = item.TotalReturnedQuantity;
                }
            }
            
            await Task.CompletedTask; // 保持非同步簽章，但實際上不需要查詢
        }
        catch (Exception)
        {
            // 發生錯誤時清空字典，避免顯示錯誤的鎖定狀態
            _returnedQuantities.Clear();
        }
    }
    
    /// <summary>
    /// 顯示載入確認 Modal - 收集載入條件並顯示給使用者確認
    /// </summary>
    private async Task ShowLoadConfirmModal()
    {
        try
        {
            // 檢查是否已選擇廠商
            if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
            {
                await NotificationService.ShowWarningAsync("請先選擇廠商");
                return;
            }
            
            // 建立載入條件清單
            _loadConditions = new List<string>();
            
            // 條件1：廠商
            var supplierName = !string.IsNullOrWhiteSpace(SelectedSupplierName) 
                ? SelectedSupplierName 
                : $"廠商 ID: {SelectedSupplierId.Value}";
            _loadConditions.Add($"廠商：{supplierName}");
            
            // 條件2：採購單（如有選擇）
            if (SelectedPurchaseOrderId.HasValue && SelectedPurchaseOrderId.Value > 0)
            {
                var orderCode = !string.IsNullOrWhiteSpace(SelectedPurchaseOrderCode)
                    ? SelectedPurchaseOrderCode
                    : $"採購單 ID: {SelectedPurchaseOrderId.Value}";
                _loadConditions.Add($"採購單：{orderCode}");
            }
            else
            {
                _loadConditions.Add("採購單：全部未完成採購單");
            }
            
            // 條件3：商品篩選（如有選擇）
            if (FilterProductId.HasValue && FilterProductId.Value > 0)
            {
                var productName = !string.IsNullOrWhiteSpace(FilterProductName)
                    ? FilterProductName
                    : $"商品 ID: {FilterProductId.Value}";
                _loadConditions.Add($"商品篩選：{productName}");
            }
            
            // 計算符合條件的明細數量
            int matchingCount = await GetMatchingUnreceivedCountAsync();
            
            if (matchingCount == 0)
            {
                await NotificationService.ShowInfoAsync("目前沒有符合條件的待進貨明細");
                return;
            }
            
            _loadSummaryMessage = $"共 {matchingCount} 筆，是否確定載入？";
            
            // 顯示確認 Modal
            _showLoadConfirmModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"準備載入資料時發生錯誤：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 取得符合條件的待進貨明細數量
    /// </summary>
    private async Task<int> GetMatchingUnreceivedCountAsync()
    {
        try
        {
            // 如果有指定採購單，從該採購單載入
            if (SelectedPurchaseOrderId.HasValue && SelectedPurchaseOrderId.Value > 0)
            {
                var purchaseOrderDetails = await PurchaseOrderService.GetOrderDetailsAsync(SelectedPurchaseOrderId.Value);
                
                if (purchaseOrderDetails?.Any() != true)
                    return 0;
                
                var unreceivedDetails = purchaseOrderDetails
                    .Where(d => !d.IsReceivingCompleted && d.OrderQuantity - d.ReceivedQuantity > 0);
                
                // 如果有商品篩選，進一步過濾
                if (FilterProductId.HasValue && FilterProductId.Value > 0)
                {
                    unreceivedDetails = unreceivedDetails.Where(d => d.ProductId == FilterProductId.Value);
                }
                
                return unreceivedDetails.Count();
            }
            else
            {
                // 沒有指定採購單，載入該廠商所有待進貨明細
                var allPurchaseDetails = await PurchaseOrderService.GetReceivingDetailsBySupplierAsync(
                    SelectedSupplierId!.Value,
                    includeCompleted: false,
                    checkApproval: false);
                
                var unreceivedDetails = allPurchaseDetails
                    .Where(d => !d.IsReceivingCompleted && d.OrderQuantity - d.ReceivedQuantity > 0);
                
                // 如果有商品篩選，進一步過濾
                if (FilterProductId.HasValue && FilterProductId.Value > 0)
                {
                    unreceivedDetails = unreceivedDetails.Where(d => d.ProductId == FilterProductId.Value);
                }
                
                return unreceivedDetails.Count();
            }
        }
        catch
        {
            return 0;
        }
    }

    /// <summary>
    /// 執行載入所有未入庫項目 - 使用者確認後執行
    /// </summary>
    private async Task ExecuteLoadAllUnreceivedItems()
    {
        try
        {
            // 檢查是否已選擇廠商
            if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
            {
                return;
            }
            
            _dataLoadCompleted = false;
            Items.Clear();
            _deletedDetailIds.Clear();
            
            List<PurchaseOrderDetail> unreceivedDetails;
            
            // 根據是否有指定採購單來決定載入邏輯
            if (SelectedPurchaseOrderId.HasValue && SelectedPurchaseOrderId.Value > 0)
            {
                // 從指定採購單載入
                var purchaseOrder = await PurchaseOrderService.GetByIdAsync(SelectedPurchaseOrderId.Value);
                if (purchaseOrder == null)
                {
                    await NotificationService.ShowErrorAsync("找不到指定的採購單");
                    _dataLoadCompleted = true;
                    StateHasChanged();
                    return;
                }
                
                var purchaseOrderDetails = await PurchaseOrderService.GetOrderDetailsAsync(SelectedPurchaseOrderId.Value);
                
                if (purchaseOrderDetails?.Any() != true)
                {
                    _dataLoadCompleted = true;
                    StateHasChanged();
                    return;
                }
                
                // 手動設定每個明細的 PurchaseOrder 參照
                foreach (var detail in purchaseOrderDetails)
                {
                    detail.PurchaseOrder = purchaseOrder;
                }
                
                unreceivedDetails = purchaseOrderDetails
                    .Where(d => !d.IsReceivingCompleted && d.OrderQuantity - d.ReceivedQuantity > 0)
                    .ToList();
            }
            else
            {
                // 從該廠商所有未完成採購單載入
                var allPurchaseDetails = await PurchaseOrderService.GetReceivingDetailsBySupplierAsync(
                    SelectedSupplierId.Value,
                    includeCompleted: false,
                    checkApproval: false);
                
                unreceivedDetails = allPurchaseDetails
                    .Where(d => !d.IsReceivingCompleted && d.OrderQuantity - d.ReceivedQuantity > 0)
                    .ToList();
            }
            
            // 如果有商品篩選，進一步過濾
            if (FilterProductId.HasValue && FilterProductId.Value > 0)
            {
                unreceivedDetails = unreceivedDetails
                    .Where(d => d.ProductId == FilterProductId.Value)
                    .ToList();
            }
            
            if (!unreceivedDetails.Any())
            {
                await NotificationService.ShowInfoAsync("沒有符合條件的待進貨明細");
                _dataLoadCompleted = true;
                StateHasChanged();
                return;
            }
            
            // 取得系統預設稅率
            var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();
            
            // 轉換為 ReceivingItem
            foreach (var detail in unreceivedDetails)
            {
                var item = new ReceivingItem
                {
                    SelectedPurchaseDetail = detail,
                    SelectedProduct = detail.Product,
                    ProductSearchValue = FormatPurchaseDetailDisplay(detail),
                    OrderQuantity = detail.OrderQuantity,
                    ReceivedQuantity = detail.OrderQuantity - detail.ReceivedQuantity, // 預設填入待進貨數量
                    UnitPrice = detail.UnitPrice,
                    TaxRate = detail.TaxRate ?? detail.Product?.TaxRate ?? defaultTaxRate,
                    Remarks = detail.Remarks ?? ""
                };
                
                Items.Add(item);
            }
            
            _dataLoadCompleted = true;
            
            // 通知父組件明細已變更
            await NotifyDetailsChangedAsync();
            
            StateHasChanged();
            
            await NotificationService.ShowSuccessAsync($"已載入 {unreceivedDetails.Count} 筆待進貨明細");
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入未進貨明細時發生錯誤：{ex.Message}");
            _dataLoadCompleted = true;
        }
    }

    /// <summary>
    /// 載入所有未入庫項目 - 從選定的採購單載入未完成進貨的明細（保留原方法供外部呼叫）
    /// </summary>
    public async Task LoadAllUnreceivedItems()
    {
        await ExecuteLoadAllUnreceivedItems();
    }
    
    // ===== 按鈕功能方法 =====
    
    /// <summary>
    /// 計算屬性：是否可以使用智能下單（讀取歷史入庫記錄）
    /// </summary>
    private bool CanUseSmartLoad => 
        SelectedSupplierId.HasValue && 
        SelectedSupplierId.Value > 0 &&
        !IsReadOnly;
    
    /// <summary>
    /// 取得智能下單按鈕的提示文字
    /// </summary>
    private string GetSmartLoadTooltip()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
            return "請先選擇廠商";
        
        if (IsReadOnly)
            return "唯讀模式無法使用";
        
        if (_hasUndeletableDetails)
            return "部分明細已有退貨或沖款記錄，無法使用智能下單";
        
        return "載入該廠商最後一次入庫記錄作為參考";
    }
    
    /// <summary>
    /// 計算屬性：是否可以使用載入採購（載入特定採購單的待進貨明細）
    /// </summary>
    private bool CanLoadPurchaseOrder => 
        SelectedSupplierId.HasValue && 
        SelectedSupplierId.Value > 0 &&
        SelectedPurchaseOrderId.HasValue &&
        SelectedPurchaseOrderId.Value > 0 &&
        !IsReadOnly;
    
    /// <summary>
    /// 取得載入採購按鈕的提示文字
    /// </summary>
    private string GetLoadPurchaseOrderTooltip()
    {
        if (IsReadOnly)
            return "唯讀模式無法使用";
        
        if (_hasUndeletableDetails)
            return "部分明細已有退貨或沖款記錄，無法載入採購";
        
        return "載入符合條件的待進貨明細";
    }
    
    /// <summary>
    /// 計算屬性：是否有入庫明細項目
    /// </summary>
    private bool HasItems =>
        Items.Any(item => item.SelectedProduct != null);
    
    /// <summary>
    /// 取得倉庫統一按鈕的提示文字
    /// </summary>
    private string GetUnifyWarehouseTooltip()
    {
        if (!HasItems)
            return "目前無明細可設定";
        
        if (IsReadOnly)
            return "唯讀模式無法使用";
        
        if (_hasUndeletableDetails)
            return "部分明細已有退貨或沖款記錄，無法統一設定倉庫";
        
        return "統一設定所有明細的倉庫";
    }
    
    /// <summary>
    /// 取得清除明細按鈕的提示文字
    /// </summary>
    private string GetClearDetailsTooltip()
    {
        if (!HasItems)
            return "目前無明細可清除";
        
        if (IsReadOnly)
            return "唯讀模式無法使用";
        
        if (_hasUndeletableDetails)
            return "部分明細已有退貨或沖款記錄，無法清除明細";
        
        return "清空所有入庫明細";
    }
    
    /// <summary>
    /// 智能下單 - 載入該廠商最後一次入庫記錄
    /// </summary>
    private async Task SmartLoadReceivingDetails()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
        {
            await NotificationService.ShowWarningAsync("請先選擇廠商");
            return;
        }
        
        try
        {
            // 如果目前有明細，先詢問是否清除
            if (Items.Any(item => item.SelectedProduct != null))
            {
                var confirmed = await NotificationService.ShowConfirmAsync(
                    "此操作會清除目前的入庫明細並載入歷史記錄，是否繼續？",
                    "智能下單確認");
                
                if (!confirmed)
                {
                    return;
                }
            }
            
            _dataLoadCompleted = false;
            Items.Clear();
            _deletedDetailIds.Clear();
            StateHasChanged();
            
            // 從服務獲取廠商的最近一次完整入庫記錄
            var lastReceivingDetails = await PurchaseReceivingDetailService.GetLastCompleteReceivingAsync(SelectedSupplierId.Value);
            
            if (!lastReceivingDetails.Any())
            {
                await NotificationService.ShowInfoAsync("該廠商沒有入庫歷史紀錄可參考");
                _dataLoadCompleted = true;
                StateHasChanged();
                return;
            }
            
            // 取得系統預設稅率
            var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();
            
            // 將歷史入庫轉換為新的入庫項目
            foreach (var detail in lastReceivingDetails)
            {
                if (detail.Product == null) continue; // 跳過沒有商品的明細
                
                var item = new ReceivingItem
                {
                    SelectedPurchaseDetail = null, // 智能下單不關聯採購明細
                    SelectedProduct = detail.Product,
                    ProductSearchValue = FormatProductDisplay(detail.Product),
                    OrderQuantity = 0, // 智能下單沒有採購數量
                    ReceivedQuantity = detail.ReceivedQuantity, // 參考上次的入庫數量
                    UnitPrice = detail.UnitPrice,
                    TaxRate = detail.TaxRate ?? detail.Product?.TaxRate ?? defaultTaxRate,
                    SelectedWarehouse = detail.Warehouse,
                    SelectedWarehouseLocation = detail.WarehouseLocation,
                    Remarks = detail.Remarks ?? ""
                };
                
                Items.Add(item);
            }
            
            _dataLoadCompleted = true;
            
            // 通知父組件明細已變更
            await NotifyDetailsChangedAsync();
            
            tableComponent?.RefreshEmptyRow();
            StateHasChanged();
            
            await NotificationService.ShowSuccessAsync($"已載入 {lastReceivingDetails.Count} 項商品作為參考");
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"智能下單時發生錯誤：{ex.Message}");
            _dataLoadCompleted = true;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// 統一設定所有明細的倉庫
    /// </summary>
    private async Task UnifyWarehouse(int warehouseId)
    {
        var warehouse = Warehouses.FirstOrDefault(w => w.Id == warehouseId);
        if (warehouse == null)
        {
            await NotificationService.ShowErrorAsync("找不到指定的倉庫");
            return;
        }
        
        // 只更新有選擇商品的項目
        var validItems = Items.Where(item => item.SelectedProduct != null).ToList();
        
        if (!validItems.Any())
        {
            await NotificationService.ShowWarningAsync("目前沒有可設定的明細");
            return;
        }
        
        // 分離可修改和不可修改的明細
        var modifiableItems = new List<ReceivingItem>();
        var lockedItems = new List<ReceivingItem>();
        
        foreach (var item in validItems)
        {
            // 檢查是否被鎖定（已有退貨或沖款記錄）
            if (item.ExistingDetailEntity != null && 
                !DetailLockHelper.CanDeleteItem(item.ExistingDetailEntity, out _, 
                    checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities))
            {
                lockedItems.Add(item);
            }
            else
            {
                modifiableItems.Add(item);
            }
        }
        
        if (!modifiableItems.Any())
        {
            await NotificationService.ShowWarningAsync("所有明細都已被鎖定（已有退貨或沖款記錄），無法統一設定倉庫");
            return;
        }
        
        // 只更新可修改的明細
        foreach (var item in modifiableItems)
        {
            item.SelectedWarehouse = warehouse;
            // 清空庫位（因為倉庫變更了）
            item.SelectedWarehouseLocation = null;
        }
        
        await NotifyDetailsChangedAsync();
        StateHasChanged();
        
        // 顯示結果訊息
        if (lockedItems.Any())
        {
            await NotificationService.ShowSuccessAsync(
                $"已將 {modifiableItems.Count} 筆明細的倉庫統一設定為「{warehouse.Name}」\n" +
                $"（{lockedItems.Count} 筆明細因已有退貨或沖款記錄而無法修改）");
        }
        else
        {
            await NotificationService.ShowSuccessAsync($"已將 {modifiableItems.Count} 筆明細的倉庫統一設定為「{warehouse.Name}」");
        }
    }
    
    /// <summary>
    /// 清除所有明細（僅從畫面移除，不從資料庫刪除）
    /// </summary>
    private async Task ClearAllDetails()
    {
        if (!Items.Any(item => item.SelectedProduct != null))
        {
            await NotificationService.ShowWarningAsync("目前沒有可清除的明細");
            return;
        }
        
        // 分離可清除和已鎖定的明細
        var validItems = Items.Where(item => item.SelectedProduct != null).ToList();
        var clearableItems = new List<ReceivingItem>();
        var lockedItems = new List<ReceivingItem>();
        
        foreach (var item in validItems)
        {
            // 檢查是否被鎖定（已有退貨或沖款記錄）
            if (item.ExistingDetailEntity != null && 
                !DetailLockHelper.CanDeleteItem(item.ExistingDetailEntity, out _, 
                    checkReturn: true, checkPayment: true, returnedQuantities: _returnedQuantities))
            {
                lockedItems.Add(item);
            }
            else
            {
                clearableItems.Add(item);
            }
        }
        
        if (!clearableItems.Any())
        {
            await NotificationService.ShowWarningAsync("所有明細都已被鎖定（已有退貨或沖款記錄），無法清除");
            return;
        }
        
        // 🔑 重要：「清除明細」只從畫面移除，不加入 _deletedDetailIds
        // 這樣儲存時不會真的從資料庫刪除，只是不包含在更新的明細清單中
        // 直接清除可清除的明細，不需要確認
        foreach (var item in clearableItems)
        {
            Items.Remove(item);
        }
        
        // 通知變更（但不觸發 OnDeletedDetailsChanged）
        await NotifyDetailsChangedAsync();
        
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
        
        // 顯示結果訊息
        if (lockedItems.Any())
        {
            await NotificationService.ShowSuccessAsync(
                $"已清除 {clearableItems.Count} 筆明細\n" +
                $"（保留 {lockedItems.Count} 筆已被鎖定的明細）");
        }
        else
        {
            await NotificationService.ShowSuccessAsync($"已清除 {clearableItems.Count} 筆入庫明細");
        }
    }
    
    // ===== 相關單據查看方法 =====
    
    /// <summary>
    /// 顯示相關單據（退貨單、沖款單）
    /// </summary>
    private async Task ShowRelatedDocuments(ReceivingItem item)
    {
        if (item.ExistingDetailEntity is not PurchaseReceivingDetail detail || detail.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("此項目尚未儲存，無法查看相關單據", "提示");
            return;
        }

        selectedProductName = item.SelectedProduct?.Name ?? "未知商品";
        
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsForPurchaseReceivingDetailAsync(detail.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入相關單據失敗：{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// 處理點擊相關單據的事件
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // 觸發事件，讓父組件（EditModal）處理開啟相關單據
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            // 如果父組件沒有處理，顯示提示訊息
            await NotificationService.ShowInfoAsync(
                $"請在主畫面中開啟 {document.TypeDisplayName}: {document.DocumentNumber}", 
                "提示"
            );
        }
    }
}
