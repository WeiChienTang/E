@page "/purchase/orders"
@using ERPCore2.Components.Shared.Report
@using ERPCore2.Components.Shared.Buttons
@using ERPCore2.Components.Shared.Approval
@using ERPCore2.Models
@inject IPurchaseOrderService PurchaseOrderService
@inject ISupplierService SupplierService
@inject ICompanyService CompanyService
@inject INotificationService NotificationService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<GenericIndexPageComponent TEntity="PurchaseOrder" 
                          TService="IPurchaseOrderService"
                          Service="@PurchaseOrderService"
                          EntityBasePath="/purchase/orders"
                          PageTitle="æ¡è³¼å–®ç¶­è­·"                          
                          PageSubtitle="ç®¡ç†æ‰€æœ‰æ¡è³¼å–®è³‡æ–™"
                          EntityName="æ¡è³¼å–®"
                          BreadcrumbItems="@breadcrumbItems"
                          FilterDefinitions="@filterDefinitions"
                          ColumnDefinitions="@columnDefinitions"
                          DataLoader="@LoadPurchaseOrdersAsync"
                          FilterApplier="@ApplyPurchaseOrderFilters"
                          GetEntityDisplayName="@(order => order.PurchaseOrderNumber)"
                          RequiredPermission="PurchaseOrder.Read"
                          ShowDefaultActions="false"
                          OnAddClick="@modalHandler.ShowAddModalAsync"
                          OnRowClick="@modalHandler.ShowEditModalAsync"
                          @ref="indexComponent">
    <CustomActionButtons>
        @* æ‰¹æ¬¡å¯©æ ¸æŒ‰éˆ• *@
        <GenericButtonComponent Variant="ButtonVariant.Warning" 
                               Text="æ‰¹æ¬¡å¯©æ ¸" 
                               OnClick="@HandleBatchApprovalAsync" 
                               IsDisabled="@indexComponent.IsLoading" 
                               Title="æ‰¹æ¬¡å¯©æ ¸æ¡è³¼å–®"
                               CssClass="index-action-btn" 
                               IconClass="fas fa-check-double" />
        
        @* æ‰¹æ¬¡åˆ—å°æŒ‰éˆ• *@
        <GenericButtonComponent Variant="ButtonVariant.Info" 
                               Text="å¤šç­†åˆ—å°" 
                               OnClick="@HandleBatchPrintAsync" 
                               IsDisabled="@indexComponent.IsLoading" 
                               Title="æ‰¹æ¬¡åˆ—å°æ¡è³¼å–®"
                               CssClass="index-action-btn" 
                               IconClass="fas fa-print" />
        
        @* æ–°å¢æŒ‰éˆ• *@
        <GenericButtonComponent Variant="ButtonVariant.Primary" 
                               Text="æ–°å¢æ¡è³¼å–®" 
                               OnClick="@modalHandler.ShowAddModalAsync" 
                               IsDisabled="@indexComponent.IsLoading" 
                               Title="æ–°å¢æ¡è³¼å–®è³‡æ–™"
                               CssClass="index-action-btn" 
                               IconClass="fas fa-plus" />
        
        @* é‡æ–°æ•´ç†æŒ‰éˆ• *@
        <GenericButtonComponent Variant="ButtonVariant.Success" 
                               Text="é‡æ–°æ•´ç†" 
                               OnClick="@indexComponent.Refresh" 
                               IsDisabled="@indexComponent.IsLoading" 
                               Title="é‡æ–°æ•´ç†è³‡æ–™"
                               CssClass="index-action-btn" 
                               IconClass="fas fa-sync" />
    </CustomActionButtons>
</GenericIndexPageComponent>

@* æ¡è³¼å–®ç·¨è¼¯ Modal *@
<PurchaseOrderEditModalComponent IsVisible="@showEditModal"
                                IsVisibleChanged="@((bool visible) => showEditModal = visible)"
                                PurchaseOrderId="@editingPurchaseOrderId"
                                OnPurchaseOrderSaved="@modalHandler.OnEntitySavedAsync"
                                OnCancel="@modalHandler.OnModalCancelAsync" />

@* æ‰¹æ¬¡å¯©æ ¸ Modal - ä½¿ç”¨æ–°çµ„ä»¶ *@
<BatchApprovalModalComponent TEntity="PurchaseOrder"
                            IsVisible="@showBatchApprovalModal"
                            IsVisibleChanged="@((bool visible) => showBatchApprovalModal = visible)"
                            Title="æ¡è³¼å–®æ‰¹æ¬¡å¯©æ ¸"
                            EntityName="æ¡è³¼å–®"
                            LoadPendingItems="@LoadPendingPurchaseOrdersAsync"
                            OnApproveItem="@ApproveSinglePurchaseOrderAsync"
                            OnApproveAll="@ApproveAllPurchaseOrdersAsync"
                            OnViewClick="@HandleApprovalViewClick"
                            ColumnDefinitions="@GetApprovalColumnDefinitions()"
                            OnApprovalCompleted="@HandleApprovalCompleted" />

@* æ‰¹æ¬¡åˆ—å°ç¯©é¸ Modal - ä½¿ç”¨æ–°æ¶æ§‹ *@
<BatchPrintFilterModalComponent IsVisible="@showBatchPrintModal"
                               IsVisibleChanged="@((bool visible) => showBatchPrintModal = visible)"
                               Title="æ¡è³¼å–®æ‰¹æ¬¡åˆ—å°æ¢ä»¶"
                               OnConfirm="@HandleBatchPrintConfirmAsync"
                               OnCancel="@HandleBatchPrintCancelAsync">
    @* å€å¡Š 1: å» å•†å¤šé¸ç¯©é¸ *@
    <FilterSectionComponent Title="å» å•†ç¯©é¸ (å¯å¤šé¸)" 
                           Badge="@($"{selectedSuppliers.Count} / {suppliers.Count}")">
        <MultiSelectFilterComponent TItem="Supplier"
                                   Items="@suppliers"
                                   @bind-SelectedItems="@selectedSuppliers"
                                   DisplayProperty="CompanyName"
                                   ValueProperty="Id"
                                   Placeholder="è«‹è¼¸å…¥å» å•†åç¨±æœå°‹..."
                                   EmptyMessage="å°šæœªé¸æ“‡å» å•†ï¼Œç•™ç©ºè¡¨ç¤ºåˆ—å°æ‰€æœ‰å» å•†çš„æ¡è³¼å–®"
                                   ShowCard="false" />
    </FilterSectionComponent>
    
    @* å€å¡Š 2: æ¡è³¼æ—¥æœŸç¯„åœ - ä½¿ç”¨æ—¥æœŸç¯„åœå…ƒä»¶ *@
    <FilterSectionComponent Title="æ¡è³¼æ—¥æœŸ" 
                           IconClass="bi bi-calendar-range">
        <DateRangeFilterComponent @bind-StartDate="@batchPrintStartDate"
                                 @bind-EndDate="@batchPrintEndDate"
                                 StartDateLabel="èµ·å§‹æ—¥æœŸ"
                                 EndDateLabel="çµæŸæ—¥æœŸ"
                                 ShowQuickSelectors="true"
                                 AutoValidate="true"
                                 ShowValidationMessage="true" />
    </FilterSectionComponent>
</BatchPrintFilterModalComponent>

@code {
    // çµ„ä»¶åƒè€ƒ
    private GenericIndexPageComponent<PurchaseOrder, IPurchaseOrderService> indexComponent = default!;
    
    // é¸é …æ¸…å–®
    private List<Supplier> suppliers = new();
    private List<Company> companies = new();
    
    // é…ç½®ç›¸é—œ
    private List<SearchFilterDefinition> filterDefinitions = new();
    private List<TableColumnDefinition> columnDefinitions = new();
    private List<GenericHeaderComponent.BreadcrumbItem> breadcrumbItems = new();

    // Modal ç›¸é—œç‹€æ…‹
    private bool showEditModal = false;
    private int? editingPurchaseOrderId = null;
    
    // æ‰¹æ¬¡å¯©æ ¸ Modal ç›¸é—œç‹€æ…‹
    private bool showBatchApprovalModal = false;
    
    // æ‰¹æ¬¡åˆ—å° Modal ç›¸é—œç‹€æ…‹
    private bool showBatchPrintModal = false;
    private List<Supplier> selectedSuppliers = new();
    private DateTime? batchPrintStartDate = null;
    private DateTime? batchPrintEndDate = null;
    
    // Modal è™•ç†å™¨
    private ModalHandler<PurchaseOrder, GenericIndexPageComponent<PurchaseOrder, IPurchaseOrderService>> modalHandler = default!;

    // ğŸ‘‡ æ–°å¢æ¬„ä½é…ç½®è®Šæ•¸
    private PurchaseOrderFieldConfiguration fieldConfiguration = default!;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // åˆå§‹åŒ– Modal è™•ç†å™¨
            modalHandler = ModalHelper.CreateModalHandler<PurchaseOrder, GenericIndexPageComponent<PurchaseOrder, IPurchaseOrderService>>(
                id => editingPurchaseOrderId = id,
                visible => showEditModal = visible,
                () => indexComponent,
                StateHasChanged,
                GetType());
            
            await InitializeBreadcrumbsAsync();
            
            // è¼‰å…¥ç›¸é—œè³‡æ–™
            await LoadSuppliersAsync();
            await LoadCompaniesAsync();
            
            // ğŸ‘‡ ä½¿ç”¨æ¬„ä½é…ç½®æ›¿ä»£åŸæœ¬çš„æ–¹æ³•èª¿ç”¨
            fieldConfiguration = new PurchaseOrderFieldConfiguration(suppliers, companies, NotificationService);
            filterDefinitions = fieldConfiguration.BuildFilters();
            columnDefinitions = fieldConfiguration.BuildColumns();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(OnInitializedAsync), GetType(), additionalData: "åˆå§‹åŒ–æ¡è³¼å–®é é¢å¤±æ•—");
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–æ¡è³¼å–®é é¢å¤±æ•—");
        }
    }    

    private async Task InitializeBreadcrumbsAsync()
    {
        try
        {
            breadcrumbItems = new List<GenericHeaderComponent.BreadcrumbItem>
            {
                new("é¦–é ", "/"),
                new("æ¡è³¼ç®¡ç†", "/purchase"),
                new("æ¡è³¼å–®ç®¡ç†")
            };
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(InitializeBreadcrumbsAsync), GetType(), additionalData: "åˆå§‹åŒ–éºµåŒ…å±‘å°èˆªå¤±æ•—");

            // è¨­å®šå®‰å…¨çš„é è¨­å€¼
            breadcrumbItems = new List<GenericHeaderComponent.BreadcrumbItem>();
        }
    }

    private async Task LoadSuppliersAsync()
    {
        try
        {
            suppliers = await SupplierService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadSuppliersAsync), GetType(), additionalData: "è¼‰å…¥å» å•†è³‡æ–™å¤±æ•—");
            await NotificationService.ShowErrorAsync("è¼‰å…¥å» å•†è³‡æ–™å¤±æ•—");
            // è¨­å®šå®‰å…¨çš„é è¨­å€¼
            suppliers = new List<Supplier>();
        }
    }

    private async Task LoadCompaniesAsync()
    {
        try
        {
            companies = await CompanyService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadCompaniesAsync), GetType(), additionalData: "è¼‰å…¥å…¬å¸è³‡æ–™å¤±æ•—");
            await NotificationService.ShowErrorAsync("è¼‰å…¥å…¬å¸è³‡æ–™å¤±æ•—");
            // è¨­å®šå®‰å…¨çš„é è¨­å€¼
            companies = new List<Company>();
        }
    }

    // è¼‰å…¥æ¡è³¼å–®è³‡æ–™
    private async Task<List<PurchaseOrder>> LoadPurchaseOrdersAsync()
    {
        try
        {
            return await PurchaseOrderService.GetAllAsync();
        }
        catch (Exception ex)
        {
            // è¨˜éŒ„éŒ¯èª¤åˆ°è³‡æ–™åº«ä¸¦é€šçŸ¥ä½¿ç”¨è€…
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadPurchaseOrdersAsync), GetType(), additionalData: "è¼‰å…¥æ¡è³¼å–®è³‡æ–™å¤±æ•—");
            await NotificationService.ShowErrorAsync("è¼‰å…¥æ¡è³¼å–®è³‡æ–™å¤±æ•—");
            // è¨­å®šå®‰å…¨çš„é è¨­å€¼
            return new List<PurchaseOrder>();
        }
    }

    // ç¯©é¸æ–¹æ³• - ç¾åœ¨å·²ç”± FilterHelper è™•ç†æ‰€æœ‰éŒ¯èª¤æƒ…æ³
    private IQueryable<PurchaseOrder> ApplyPurchaseOrderFilters(SearchFilterModel searchModel, IQueryable<PurchaseOrder> query)
    {
        // ç¢ºä¿ fieldConfiguration å·²åˆå§‹åŒ–ï¼ˆé¿å…èˆ‡ GenericIndexPageComponent åˆå§‹åŒ–çš„ç«¶çˆ­æ¢ä»¶ï¼‰
        if (fieldConfiguration == null)
        {
            // å¦‚æœé…ç½®æœªåˆå§‹åŒ–ï¼Œå›å‚³åŸºæœ¬æ’åºçš„æŸ¥è©¢ï¼ˆID é™åºï¼Œæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
            return query.OrderByDescending(e => e.Id);
        }

        return fieldConfiguration.ApplyFilters(searchModel, query, nameof(ApplyPurchaseOrderFilters), GetType());
    }

    // ===== æ‰¹æ¬¡å¯©æ ¸ç›¸é—œæ–¹æ³• =====
    
    /// <summary>
    /// è™•ç†æ‰¹æ¬¡å¯©æ ¸æŒ‰éˆ•é»æ“Šäº‹ä»¶
    /// </summary>
    private async Task HandleBatchApprovalAsync()
    {
        try
        {
            // ç›´æ¥é¡¯ç¤ºæ‰¹æ¬¡å¯©æ ¸ Modal
            showBatchApprovalModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleBatchApprovalAsync), GetType(), additionalData: "é–‹å•Ÿæ‰¹æ¬¡å¯©æ ¸è¦–çª—å¤±æ•—");
            await NotificationService.ShowErrorAsync("é–‹å•Ÿæ‰¹æ¬¡å¯©æ ¸è¦–çª—å¤±æ•—");
        }
    }

    /// <summary>
    /// è¼‰å…¥å¾…å¯©æ ¸çš„æ¡è³¼å–®
    /// </summary>
    private async Task<List<PurchaseOrder>> LoadPendingPurchaseOrdersAsync()
    {
        try
        {
            var allOrders = await PurchaseOrderService.GetAllAsync();
            return allOrders.Where(o => !o.IsApproved).ToList();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadPendingPurchaseOrdersAsync), GetType(), additionalData: "è¼‰å…¥å¾…å¯©æ ¸æ¡è³¼å–®å¤±æ•—");
            await NotificationService.ShowErrorAsync("è¼‰å…¥å¾…å¯©æ ¸æ¡è³¼å–®å¤±æ•—");
            return new List<PurchaseOrder>();
        }
    }

    /// <summary>
    /// å¯©æ ¸å–®ç­†æ¡è³¼å–®
    /// </summary>
    private async Task<bool> ApproveSinglePurchaseOrderAsync(PurchaseOrder order)
    {
        try
        {
            order.IsApproved = true;
            order.ApprovedAt = DateTime.Now;
            // TODO: è¨­å®š ApprovedBy ç‚ºç•¶å‰ä½¿ç”¨è€…
            
            await PurchaseOrderService.UpdateAsync(order);
            return true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ApproveSinglePurchaseOrderAsync), GetType(), 
                additionalData: new { OrderId = order.Id, OrderNumber = order.PurchaseOrderNumber });
            return false;
        }
    }

    /// <summary>
    /// æ‰¹æ¬¡å¯©æ ¸æ‰€æœ‰æ¡è³¼å–®
    /// </summary>
    private async Task<(int successCount, int failCount)> ApproveAllPurchaseOrdersAsync(List<PurchaseOrder> orders)
    {
        int successCount = 0;
        int failCount = 0;

        foreach (var order in orders)
        {
            try
            {
                if (!order.IsApproved)
                {
                    order.IsApproved = true;
                    order.ApprovedAt = DateTime.Now;
                    // TODO: è¨­å®š ApprovedBy ç‚ºç•¶å‰ä½¿ç”¨è€…
                    
                    await PurchaseOrderService.UpdateAsync(order);
                    successCount++;
                }
            }
            catch (Exception ex)
            {
                failCount++;
                await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ApproveAllPurchaseOrdersAsync), GetType(), 
                    additionalData: new { OrderId = order.Id, OrderNumber = order.PurchaseOrderNumber });
            }
        }

        return (successCount, failCount);
    }

    /// <summary>
    /// è™•ç†å¯©æ ¸ Modal ä¸­çš„æŸ¥çœ‹æŒ‰éˆ•é»æ“Š
    /// </summary>
    private async Task HandleApprovalViewClick(PurchaseOrder order)
    {
        try
        {
            // ä¸é—œé–‰æ‰¹æ¬¡å¯©æ ¸ Modalï¼Œç›´æ¥é–‹å•Ÿç·¨è¼¯ Modal
            await modalHandler.ShowEditModalAsync(order);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleApprovalViewClick), GetType(), 
                additionalData: new { OrderId = order.Id });
            await NotificationService.ShowErrorAsync("é–‹å•ŸæŸ¥çœ‹è¦–çª—å¤±æ•—");
        }
    }

    /// <summary>
    /// å¯©æ ¸å®Œæˆå¾Œçš„è™•ç†
    /// </summary>
    private async Task HandleApprovalCompleted()
    {
        try
        {
            // åˆ·æ–°ä¸»åˆ—è¡¨
            await indexComponent.Refresh();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleApprovalCompleted), GetType(), 
                additionalData: "åˆ·æ–°åˆ—è¡¨å¤±æ•—");
        }
    }

    /// <summary>
    /// å–å¾—æ‰¹æ¬¡å¯©æ ¸ Modal çš„è¡¨æ ¼æ¬„ä½å®šç¾©
    /// </summary>
    private List<InteractiveColumnDefinition> GetApprovalColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = "æ¡è³¼å–®è™Ÿ",
                PropertyName = nameof(PurchaseOrder.PurchaseOrderNumber),
                ColumnType = InteractiveColumnType.Display,
                Width = "150px"
            },
            new()
            {
                Title = "å» å•†",
                PropertyName = "Supplier.CompanyName",
                ColumnType = InteractiveColumnType.Display,
                Width = "200px"
            },
            new()
            {
                Title = "è¨‚å–®æ—¥æœŸ",
                PropertyName = nameof(PurchaseOrder.OrderDate),
                ColumnType = InteractiveColumnType.Display,
                Width = "120px",
                DisplayFormatter = value => 
                {
                    if (value is DateTime date)
                        return $"<span style='font-size: 0.875rem;'>{date:yyyy/MM/dd}</span>";
                    return "-";
                }
            },
            new()
            {
                Title = "é è¨ˆåˆ°è²¨æ—¥",
                PropertyName = nameof(PurchaseOrder.ExpectedDeliveryDate),
                ColumnType = InteractiveColumnType.Display,
                Width = "120px",
                DisplayFormatter = value => 
                {
                    if (value is DateTime date)
                        return $"<span style='font-size: 0.875rem;'>{date:yyyy/MM/dd}</span>";
                    return "<span style='font-size: 0.875rem;'>-</span>";
                }
            },
            new()
            {
                Title = "ç¸½é‡‘é¡",
                PropertyName = nameof(PurchaseOrder.TotalAmount),
                ColumnType = InteractiveColumnType.Display,
                Width = "120px",
                CellCssClass = "text-end",
                DisplayFormatter = value => 
                {
                    if (value is decimal amount)
                        return $"<span style='font-size: 0.875rem;' class='fw-bold'>{amount:N0}</span>";
                    return "0";
                }
            },
            new()
            {
                Title = "å»ºç«‹æ—¥æœŸ",
                PropertyName = nameof(PurchaseOrder.CreatedAt),
                ColumnType = InteractiveColumnType.Display,
                Width = "150px",
                DisplayFormatter = value => 
                {
                    if (value is DateTime date)
                        return $"<span style='font-size: 0.875rem;'>{date:yyyy/MM/dd HH:mm}</span>";
                    return "-";
                }
            }
        };
    }

    // ===== æ‰¹æ¬¡åˆ—å°ç›¸é—œæ–¹æ³• =====
    
    /// <summary>
    /// å¤šç­†åˆ—å°è™•ç†æ–¹æ³•
    /// </summary>
    private async Task HandleBatchPrintAsync()
    {
        try
        {
            // é¡¯ç¤ºæ‰¹æ¬¡åˆ—å°ç¯©é¸ Modal
            showBatchPrintModal = true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleBatchPrintAsync), GetType(), additionalData: "é–‹å•Ÿå¤šç­†åˆ—å°è¦–çª—å¤±æ•—");
            await NotificationService.ShowErrorAsync("é–‹å•Ÿå¤šç­†åˆ—å°è¦–çª—å¤±æ•—");
        }
    }

    // è™•ç†æ‰¹æ¬¡åˆ—å°ç¢ºèª
    private async Task HandleBatchPrintConfirmAsync()
    {
        try
        {
            // çµ„è£æ‰¹æ¬¡åˆ—å°æ¢ä»¶
            var criteria = new BatchPrintCriteria
            {
                StartDate = batchPrintStartDate,
                EndDate = batchPrintEndDate,
                RelatedEntityIds = selectedSuppliers.Select(s => s.Id).ToList(),
                ReportType = "PurchaseOrder",
                MaxResults = 100,
                IncludeCancelled = false
            };

            // é©—è­‰ç¯©é¸æ¢ä»¶
            var validation = criteria.Validate();
            if (!validation.IsValid)
            {
                await NotificationService.ShowErrorAsync($"ç¯©é¸æ¢ä»¶éŒ¯èª¤ï¼š{validation.GetAllErrors()}");
                return;
            }

            // åºåˆ—åŒ–æ¢ä»¶ç‚º JSON
            var jsonPayload = System.Text.Json.JsonSerializer.Serialize(criteria);

            // é–‹å•Ÿæ–°è¦–çª—é¡¯ç¤ºæ‰¹æ¬¡å ±è¡¨ï¼ˆä½¿ç”¨æ–°è·¯ç”±ï¼‰
            var apiUrl = "/api/purchase-report/order/batch?autoprint=true";
            await JSRuntime.InvokeVoidAsync("openBatchPrintWindow", apiUrl, jsonPayload);

            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            await NotificationService.ShowSuccessAsync($"å·²é–‹å•Ÿæ‰¹æ¬¡åˆ—å°è¦–çª— ({criteria.GetSummary()})");
            
            // é—œé–‰ Modal
            showBatchPrintModal = false;
            
            // æ¸…ç©ºé¸æ“‡
            selectedSuppliers.Clear();
            batchPrintStartDate = null;
            batchPrintEndDate = null;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleBatchPrintConfirmAsync), GetType(), additionalData: "åŸ·è¡Œæ‰¹æ¬¡åˆ—å°å¤±æ•—");
            await NotificationService.ShowErrorAsync("åŸ·è¡Œæ‰¹æ¬¡åˆ—å°å¤±æ•—");
        }
    }

    // è™•ç†æ‰¹æ¬¡åˆ—å°å–æ¶ˆ
    private async Task HandleBatchPrintCancelAsync()
    {
        try
        {
            showBatchPrintModal = false;
            
            // æ¸…ç©ºæ‰€æœ‰ç¯©é¸æ¢ä»¶
            selectedSuppliers.Clear();
            batchPrintStartDate = null;
            batchPrintEndDate = null;
            
            await Task.CompletedTask;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleBatchPrintCancelAsync), GetType(), additionalData: "å–æ¶ˆæ‰¹æ¬¡åˆ—å°å¤±æ•—");
        }
    }
}
