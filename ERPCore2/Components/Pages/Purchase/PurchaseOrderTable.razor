@* 採購單商品管理組件 - 繼承 BaseDetailTableComponent，只保留採購特有邏輯 *@
@inherits BaseDetailTableComponent<PurchaseOrder, PurchaseOrderDetail, PurchaseOrderTable.ProductItem>

@using ERPCore2.Models.Enums
@inject IStringLocalizer<SharedResource> L
@inject IPurchaseOrderDetailService PurchaseOrderDetailService
@inject IProductSupplierService ProductSupplierService
@inject ISystemParameterService SystemParameterService
@inject INotificationService NotificationService
@inject RelatedDocumentsHelper RelatedDocumentsHelper
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime

@if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="supplier-warning">
                <p class="text-muted">選擇廠商後即可查看該廠商的未完成進貨商品</p>
            </div>
        </div>
    </div>
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="ProductItem"
                                      OnDataChanged="@NotifyDetailsChangedAsync"
                                      Items="@Items"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"
                                      EmptyMessage="尚未新增商品"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="false"
                                      ActionsColumnWidth = "60px"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"
                                      OnItemDelete="@HandleItemDelete"
                                      EnableAutoEmptyRow="true"
                                      AllowAddNewRow="@(!_hasUndeletableDetails && !IsReadOnly)"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@(() => new ProductItem())" />
        </div>

        <div class="card-footer">
            <div class="table-action-bar">
                <div class="btn-group-left">
                    <GenericButtonComponent Text="智能下單"
                                          Variant="ButtonVariant.DarkBlue"
                                          OnClick="SmartPurchaseOrder"
                                          IsDisabled="@(!CanUseSmartPurchase)"
                                          Title="@GetSmartPurchaseTooltip()" />
                </div>
                <div class="btn-group-right">
                    <GenericButtonComponent Text="清除明細"
                                          Variant="ButtonVariant.Red"
                                          OnClick="ClearAllDetails"
                                          IsDisabled="@_hasUndeletableDetails"
                                          Title="@(_hasUndeletableDetails ? "部分商品已有進貨記錄，無法清除明細" : "清除所有商品明細")" />
                </div>
            </div>
        </div>
    </div>
}

<!-- 相關單據查看 Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

@code {
    // ===== 採購特有參數 =====

    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public TaxCalculationMethod TaxCalculationMethod { get; set; } = TaxCalculationMethod.TaxExclusive;
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }

    // ===== 廠商已知商品（供應商品目錄）=====
    private HashSet<int> _supplierKnownProductIds = new();

    // ===== 智能下單 =====
    private bool _hasLastPurchaseRecord = false;

    // ===== 相關單據查看 =====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;

    // ===== 稅率算法輔助 =====
    private bool IsTaxCalculationMethodNoTax => TaxCalculationMethod == TaxCalculationMethod.NoTax;

    // ===== BaseDetailTableComponent 抽象方法實作 =====

    /// <summary>
    /// 將 ExistingDetails (PurchaseOrderDetail) 對應到 ProductItem 列表
    /// </summary>
    protected override async Task LoadItemsFromDetailsAsync()
    {
        if (ExistingDetails?.Any() != true)
            return;

        // 批次查詢使用記錄，避免 N+1 問題
        var detailIds = ExistingDetails
            .Where(d => d.Id > 0)
            .Select(d => d.Id)
            .ToList();

        var usageRecordMap = detailIds.Any()
            ? await RelatedDocumentsHelper.HasUsageRecordBatchForPurchaseOrderDetailsAsync(detailIds)
            : new Dictionary<int, bool>();

        foreach (var detail in ExistingDetails)
        {
            var product = Products.FirstOrDefault(p => p.Id == detail.ProductId);
            if (product == null) continue;

            var item = new ProductItem
            {
                SelectedProduct = product,
                SelectedProductId = detail.ProductId,
                ProductSearchValue = $"[{product.Code}] {product.Name}",
                Quantity = detail.OrderQuantity,
                ReceivedQuantity = detail.ReceivedQuantity,
                Price = detail.UnitPrice,
                TaxRate = detail.TaxRate ?? await SystemParameterService.GetTaxRateAsync(),
                Remarks = detail.Remarks ?? string.Empty,
                IsReceivingCompleted = detail.IsReceivingCompleted,
                CompletedByEmployeeId = detail.CompletedByEmployeeId,
                CompletedAt = detail.CompletedAt,
                ExistingDetailEntity = detail
            };

            item.HasUsageRecordCache = usageRecordMap.GetValueOrDefault(detail.Id, false);
            Items.Add(item);
        }
    }

    /// <summary>
    /// 採購明細的鎖定條件：已有入庫記錄時不可刪除
    /// </summary>
    protected override bool ComputeHasUndeletableDetails()
        => Items.Any(p => !DetailLockHelper.CanDeleteItem(p, out _, checkReceiving: true));

    /// <summary>
    /// 將 ProductItem 轉換回 PurchaseOrderDetail 列表
    /// </summary>
    protected override List<PurchaseOrderDetail> ConvertItemsToDetails()
    {
        var details = new List<PurchaseOrderDetail>();

        foreach (var item in Items.Where(x => x.SelectedProduct != null))
        {
            PurchaseOrderDetail detail;

            if (item.ExistingDetailEntity != null)
            {
                detail = item.ExistingDetailEntity;
            }
            else
            {
                detail = new PurchaseOrderDetail();
                if (MainEntity != null)
                    detail.PurchaseOrderId = MainEntity.Id;
            }

            detail.ProductId = item.SelectedProduct!.Id;
            detail.OrderQuantity = item.Quantity;
            detail.ReceivedQuantity = item.ReceivedQuantity;
            detail.UnitPrice = item.Price;
            detail.TaxRate = item.TaxRate;
            detail.Remarks = item.Remarks;
            detail.IsReceivingCompleted = item.IsReceivingCompleted;
            detail.CompletedByEmployeeId = item.CompletedByEmployeeId;
            detail.CompletedAt = item.CompletedAt;

            details.Add(detail);
        }

        return details;
    }

    // ===== BaseDetailTableComponent 虛方法覆寫 =====

    /// <summary>
    /// 廠商切換時：重新載入該廠商的已知商品目錄（★ 標示用）
    /// </summary>
    protected override async Task OnCounterpartyChangedAsync()
    {
        _supplierKnownProductIds.Clear();
        if (SelectedSupplierId.HasValue && SelectedSupplierId.Value > 0)
            await LoadSupplierKnownProductsAsync(SelectedSupplierId.Value);
    }

    /// <summary>
    /// 資料載入後：檢查是否有歷史採購記錄（智能下單用）
    /// </summary>
    protected override async Task OnAfterLoadAsync()
    {
        await CheckLastPurchaseRecordAsync();
    }

    // ===== 私有初始化方法 =====

    private async Task LoadSupplierKnownProductsAsync(int supplierId)
    {
        try
        {
            var bindings = await ProductSupplierService.GetBySupplierIdAsync(supplierId);
            _supplierKnownProductIds = bindings.Select(b => b.ProductId).ToHashSet();
        }
        catch
        {
            _supplierKnownProductIds = new HashSet<int>();
        }
    }

    private async Task CheckLastPurchaseRecordAsync()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
        {
            _hasLastPurchaseRecord = false;
            return;
        }

        try
        {
            var lastPurchaseDetails = await PurchaseOrderDetailService.GetLastCompletePurchaseAsync(SelectedSupplierId.Value);
            _hasLastPurchaseRecord = lastPurchaseDetails?.Any() == true;
        }
        catch
        {
            _hasLastPurchaseRecord = false;
        }
    }

    // ===== 欄位定義 =====

    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // 商品選擇欄位 - 觸發欄位
        columns.Add(new()
        {
            Title = L["Column.ProductCodeName"],
            PropertyName = "ProductSearchValue",
            EmptyCheckPropertyName = "SelectedProduct",
            TriggerEmptyRowOnFilled = true,
            ColumnType = InteractiveColumnType.SearchableSelect,
            Width = "250px",
            Tooltip = "搜尋並選擇商品（輸入編號或名稱）。已有進貨記錄的商品將無法變更",
            Placeholder = "請輸入商品編號或名稱",
            SearchValuePropertyName = nameof(ProductItem.ProductSearchValue),
            FilteredItemsPropertyName = nameof(ProductItem.FilteredProducts),
            ShowDropdownPropertyName = nameof(ProductItem.ShowProductDropdown),
            SelectedIndexPropertyName = nameof(ProductItem.ProductSelectedIndex),
            ItemDisplayFormatter = (item) =>
            {
                var product = (Product)item;
                var prefix = _supplierKnownProductIds.Contains(product.Id) ? "★ " : "";
                return $"{prefix}[{product.Code}] {product.Name}";
            },
            IsDisabledFunc = item =>
            {
                var productItem = (ProductItem)item;
                return IsReadOnly || !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true);
            },
            TooltipFunc = item =>
            {
                var productItem = (ProductItem)item;
                return !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true)
                    ? "此商品已有進貨記錄，無法修改商品選擇" : null;
            },
            OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, (tuple) =>
            {
                var (item, searchValue) = tuple;
                OnProductSearchChanged((ProductItem)item, searchValue);
            }),
            OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
            {
                var (item, selectedItem) = tuple;
                await OnProductSelected((ProductItem)item, (Product?)selectedItem);
            }),
            OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
            {
                var productItem = (ProductItem)item;
                var availableProducts = GetAvailableProducts();
                productItem.FilteredProducts = availableProducts.Take(20).ToList();
                productItem.ShowProductDropdown = true;
                productItem.ProductSelectedIndex = -1;
                StateHasChanged();
            }),
            OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
            {
                Task.Delay(200).ContinueWith(_ =>
                {
                    var productItem = (ProductItem)item;
                    productItem.ShowProductDropdown = false;
                    InvokeAsync(StateHasChanged);
                });
            }),
            EnableKeyboardNavigation = true,
            GetDropdownItems = (item) => ((ProductItem)item).FilteredProducts,
            GetSelectedIndex = (item) => ((ProductItem)item).ProductSelectedIndex,
            SetSelectedIndex = (item, index) => ((ProductItem)item).ProductSelectedIndex = index,
            GetShowDropdown = (item) => ((ProductItem)item).ShowProductDropdown,
            SetShowDropdown = (item, show) => ((ProductItem)item).ShowProductDropdown = show,
            MaxDisplayItems = 20
        });

        // 數量欄位
        columns.Add(new()
        {
            Title = L["Column.Quantity"],
            PropertyName = "Quantity",
            ColumnType = InteractiveColumnType.Number,
            Width = "80px",
            Tooltip = "採購的商品數量。已有進貨記錄的商品將無法修改數量",
            IsDisabledFunc = item =>
            {
                var productItem = (ProductItem)item;
                return !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true);
            },
            TooltipFunc = item =>
            {
                var productItem = (ProductItem)item;
                return !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true)
                    ? "此商品已有進貨記錄，無法修改數量" : null;
            },
            CustomTemplate = item =>
            {
                var productItem = (ProductItem)item;
                var isLocked = !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true);
                if (isLocked || IsReadOnly)
                {
                    return @<div class="d-flex align-items-center" style="min-height: 31px;">
                        <span>@productItem.Quantity</span>
                    </div>;
                }
                return @<input type="number" class="form-control text-end"
                               value="@productItem.Quantity"
                               min="1"
                               @oninput="async (e) => await OnQuantityInput(productItem, e.Value?.ToString())" />;
            }
        });

        // 已入庫欄位（唯讀顯示）
        columns.Add(new()
        {
            Title = L["Column.ReceivedQuantity"],
            PropertyName = "ReceivedQuantity",
            ColumnType = InteractiveColumnType.Display,
            Width = "80px",
            IsReadOnly = true,
            ExcludeFromEmptyCheck = true,
            Tooltip = "已完成入庫的數量（從入庫單自動更新）",
            DisplayFormatter = item =>
            {
                if (item is not ProductItem productItem) return "-";
                return productItem.ReceivedQuantity.ToString();
            }
        });

        // 單價欄位
        columns.Add(new()
        {
            Title = L["Column.UnitPrice"],
            PropertyName = "Price",
            ColumnType = InteractiveColumnType.Number,
            Width = "100px",
            UseThousandsSeparator = true,
            Tooltip = "採購的商品單價",
            IsDisabledFunc = item =>
            {
                var productItem = (ProductItem)item;
                return !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true);
            },
            CustomTemplate = item =>
            {
                var productItem = (ProductItem)item;
                var isLocked = !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true);
                if (isLocked || IsReadOnly)
                {
                    return @<div class="d-flex align-items-center justify-content-end" style="min-height: 31px;">
                        <span>@productItem.Price.ToString("N2")</span>
                    </div>;
                }
                return @<input type="number" class="form-control text-end"
                               value="@productItem.Price"
                               min="0"
                               step="0.01"
                               @oninput="async (e) => await OnPriceInput(productItem, e.Value?.ToString())" />;
            }
        });

        // 稅率欄位
        if (!IsTaxCalculationMethodNoTax)
        {
            columns.Add(new()
            {
                Title = L["Column.TaxRate"],
                PropertyName = "TaxRate",
                ColumnType = InteractiveColumnType.Custom,
                Width = "80px",
                ExcludeFromEmptyCheck = true,
                Tooltip = "稅率（%）",
                CustomTemplate = item =>
                {
                    var productItem = (ProductItem)item;
                    var isLocked = !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true);
                    if (isLocked || IsReadOnly)
                    {
                        return @<div class="d-flex align-items-center" style="min-height: 31px;">
                            <span>@productItem.TaxRate%</span>
                        </div>;
                    }
                    return @<input type="number" class="form-control text-end"
                                   value="@productItem.TaxRate"
                                   min="0"
                                   max="100"
                                   step="0.01"
                                   @oninput="async (e) => await OnTaxRateInput(productItem, e.Value?.ToString())" />;
                }
            });
        }

        // 小計欄位（唯讀計算）
        columns.Add(new()
        {
            Title = L["Column.Subtotal"],
            PropertyName = "Subtotal",
            ColumnType = InteractiveColumnType.Display,
            Width = "100px",
            IsReadOnly = true,
            ExcludeFromEmptyCheck = true,
            Tooltip = GetSubtotalTooltip(),
            DisplayFormatter = item =>
            {
                if (item is not ProductItem productItem) return "-";
                var subtotal = CalculateItemSubtotal(productItem);
                return subtotal > 0 ? subtotal.ToString("N0") : "-";
            }
        });

        // 完成狀態欄位
        columns.Add(new()
        {
            Title = L["Column.IsReceivingCompleted"],
            PropertyName = "IsReceivingCompleted",
            ColumnType = InteractiveColumnType.Custom,
            Width = "80px",
            ExcludeFromEmptyCheck = true,
            HideOnMobile = true,
            Tooltip = "標記此商品的進貨是否已完成（可手動提前標記）",
            CustomTemplate = item =>
            {
                var productItem = (ProductItem)item;
                var isFullyReceived = productItem.ReceivedQuantity >= productItem.Quantity && productItem.Quantity > 0;
                var isDisabled = IsReadOnly || isFullyReceived;
                var tooltip = isFullyReceived ? "已完全進貨，無法取消" : null;
                return @<div class="form-check form-switch d-flex justify-content-center align-items-center" style="min-height: 31px;">
                    <input class="form-check-input"
                           type="checkbox"
                           checked="@productItem.IsReceivingCompleted"
                           disabled="@isDisabled"
                           title="@tooltip"
                           @onchange="async (e) => await OnIsReceivingCompletedChanged(productItem, (bool)(e.Value ?? false))" />
                </div>;
            },
            TooltipFunc = item =>
            {
                var productItem = (ProductItem)item;
                var isFullyReceived = productItem.ReceivedQuantity >= productItem.Quantity && productItem.Quantity > 0;
                return isFullyReceived ? "已完全進貨，無法取消" : null;
            },
            OnCheckboxChanged = EventCallback.Factory.Create<(object, bool)>(this, async args =>
            {
                var (item, newValue) = args;
                await OnIsReceivingCompletedChanged((ProductItem)item, newValue);
            })
        });

        // 備註欄位
        columns.Add(new()
        {
            Title = L["Label.Remarks"],
            PropertyName = "Remarks",
            ColumnType = InteractiveColumnType.Custom,
            Width = "300px",
            HideOnMobile = true,
            ExcludeFromEmptyCheck = true,
            Tooltip = "選填。可記錄採購相關的備註資訊（核准後仍可編輯）",
            CustomTemplate = item =>
            {
                var productItem = (ProductItem)item;
                var isFieldReadOnly = IsReadOnly;

                if (isFieldReadOnly)
                {
                    var displayText = string.IsNullOrEmpty(productItem.Remarks) ? "無備註" : productItem.Remarks;
                    return @<div class="d-flex align-items-center" style="min-height: 31px;">
                        <span class="text-muted">@displayText</span>
                    </div>;
                }

                return @<input type="text" class="form-control "
                               value="@productItem.Remarks"
                               @oninput="(e) => OnRemarksInput(productItem, e.Value?.ToString())" />;
            }
        });

        return columns;
    }

    private RenderFragment<ProductItem> GetCustomActionsTemplate => item => __builder =>
    {
        var isLastEmptyRow = tableComponent?.IsLastEmptyRow(item) ?? false;

        if (DetailLockHelper.CanDeleteItem(item, out _, checkReceiving: true) && !isLastEmptyRow)
        {
            <GenericButtonComponent Variant="ButtonVariant.Red"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="@IsReadOnly"
                                   Title="刪除"
                                   OnClick="async () => await HandleItemDelete(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else if (isLastEmptyRow)
        {
            <GenericButtonComponent Variant="ButtonVariant.Red"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="true"
                                   Title="至少需要保留一個空行"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else
        {
            <GenericButtonComponent Variant="ButtonVariant.Blue"
                                   IconClass="bi bi-eye text-white"
                                   Size="ButtonSize.Large"
                                   Title="查看相關單據"
                                   OnClick="async () => await ShowRelatedDocuments(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
    };

    private async Task HandleItemDelete(ProductItem item)
    {
        var index = Items.IndexOf(item);
        await RemoveItemAsync(index);
    }

    // ===== 商品選擇事件處理 =====

    private void OnProductSearchChanged(ProductItem item, string? searchValue)
    {
        item.ProductSearchValue = searchValue ?? string.Empty;

        var availableProducts = GetAvailableProducts();

        if (string.IsNullOrWhiteSpace(searchValue))
        {
            item.FilteredProducts = availableProducts.Take(20).ToList();
        }
        else
        {
            item.FilteredProducts = availableProducts
                .Where(p => (p.Code?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                           (p.Name?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false))
                .Take(20)
                .ToList();
        }

        item.ShowProductDropdown = true;
        item.ProductSelectedIndex = -1;
        StateHasChanged();
    }

    private async Task OnProductSelected(ProductItem item, Product? selectedProduct)
    {
        if (selectedProduct != null)
        {
            item.SelectedProduct = selectedProduct;
            item.SelectedProductId = selectedProduct.Id;
            item.ProductSearchValue = $"[{selectedProduct.Code}] {selectedProduct.Name}";

            item.TaxRate = selectedProduct.TaxRate.HasValue
                ? selectedProduct.TaxRate.Value
                : await SystemParameterService.GetTaxRateAsync();
        }
        else
        {
            item.SelectedProduct = null;
            item.SelectedProductId = null;
            item.ProductSearchValue = string.Empty;
        }

        item.ShowProductDropdown = false;
        item.ProductSelectedIndex = -1;

        await NotifyDetailsChangedAsync();
    }

    // ===== 欄位變更事件處理 =====

    private async Task OnQuantityInput(ProductItem item, string? value)
    {
        item.Quantity = (int)InputEventHelper.HandleQuantityInput(value, 0);
        await NotifyDetailsChangedAsync();
    }

    private async Task OnPriceInput(ProductItem item, string? value)
    {
        item.Price = InputEventHelper.HandlePriceInput(value, 0);
        await NotifyDetailsChangedAsync();
    }

    private async Task OnTaxRateInput(ProductItem item, string? value)
    {
        item.TaxRate = InputEventHelper.HandlePercentageInput(value, 0, 100, 0);
        await NotifyDetailsChangedAsync();
    }

    private void OnRemarksInput(ProductItem item, string? value)
    {
        item.Remarks = InputEventHelper.HandleTextInput(value, string.Empty);
        // 備註不觸發 NotifyDetailsChangedAsync 以避免過於頻繁的轉換
    }

    private async Task OnIsReceivingCompletedChanged(ProductItem item, bool newValue)
    {
        var isFullyReceived = item.ReceivedQuantity >= item.Quantity;

        if (isFullyReceived && item.IsReceivingCompleted && !newValue)
        {
            await NotificationService.ShowWarningAsync("此商品已全數入庫，無法取消完成狀態");
            return;
        }

        item.IsReceivingCompleted = newValue;

        if (newValue)
        {
            var currentUserId = await GetCurrentUserIdAsync();
            if (currentUserId.HasValue)
            {
                item.CompletedByEmployeeId = currentUserId.Value;
                item.CompletedAt = DateTime.Now;
            }
        }
        else
        {
            item.CompletedByEmployeeId = null;
            item.CompletedAt = null;
        }

        await NotifyDetailsChangedAsync();
    }

    public async Task RemoveItemAsync(int index)
    {
        if (IsReadOnly || index < 0 || index >= Items.Count) return;

        Items.RemoveAt(index);
        await NotifyDetailsChangedAsync();
    }

    // ===== 工具方法 =====

    private List<Product> GetAvailableProducts()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
            return new List<Product>();

        return Products
            .OrderByDescending(p => _supplierKnownProductIds.Contains(p.Id))
            .ThenBy(p => p.Code)
            .ToList();
    }

    private decimal CalculateItemSubtotal(ProductItem item)
    {
        if (item.SelectedProduct == null || item.Quantity <= 0 || item.Price <= 0)
            return 0;

        var subtotal = CalculationHelper.CalculateSubtotal(
            item.Quantity,
            item.Price,
            discountPercentage: 0,
            item.TaxRate,
            TaxCalculationMethod
        );

        return CalculationHelper.Round(subtotal, 0);
    }

    private string GetSubtotalTooltip() => TaxCalculationMethod switch
    {
        TaxCalculationMethod.TaxExclusive => "外加稅：數量 × 單價 × (1 + 稅率%)",
        TaxCalculationMethod.TaxInclusive => "內含稅：數量 × 單價（單價已含稅）",
        TaxCalculationMethod.NoTax => "免稅：數量 × 單價",
        _ => "數量 × 單價"
    };

    private decimal GetTotalAmount()
        => Items.Where(item => item.SelectedProduct != null && item.Quantity > 0)
                .Sum(item => item.Quantity * item.Price);

    public async Task<bool> ValidateAsync()
    {
        var validItemsCount = Items.Count(item => item.SelectedProduct != null);
        if (validItemsCount < 1)
        {
            await NotificationService.ShowErrorAsync("至少需要一個商品");
            return false;
        }
        return true;
    }

    // ===== 智能下單 =====

    private bool CanUseSmartPurchase =>
        SelectedSupplierId.HasValue &&
        SelectedSupplierId.Value > 0 &&
        !Items.Any(item => item.SelectedProduct != null) &&
        _hasLastPurchaseRecord;

    private string GetSmartPurchaseTooltip()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
            return "請先選擇廠商";
        if (Items.Any(item => item.SelectedProduct != null))
            return "目前已有明細資料，無法使用智能下單";
        if (!_hasLastPurchaseRecord)
            return "此廠商沒有歷史採購記錄";
        return "載入該廠商上次採購的商品明細";
    }

    private async Task SmartPurchaseOrder()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
        {
            await NotificationService.ShowWarningAsync("請先選擇廠商後再使用智能下單");
            return;
        }

        try
        {
            var lastPurchaseDetails = await PurchaseOrderDetailService.GetLastCompletePurchaseAsync(SelectedSupplierId.Value);

            if (!lastPurchaseDetails.Any())
            {
                await NotificationService.ShowInfoAsync("該廠商沒有歷史採購記錄，無法使用智能下單");
                return;
            }

            var hasExistingData = Items.Any(item => item.SelectedProduct != null);
            if (hasExistingData)
            {
                await NotificationService.ShowWarningAsync(
                    $"智能下單確認: 此操作將清空現有的商品明細並載入 {lastPurchaseDetails.Count} 項上次採購的商品。");
            }

            await LoadLastPurchaseDetailsInternal(lastPurchaseDetails);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"智能下單失敗：{ex.Message}");
        }
    }

    private async Task LoadLastPurchaseDetailsInternal(List<PurchaseOrderDetail> lastPurchaseDetails)
    {
        try
        {
            _dataLoadCompleted = false;
            Items.Clear();

            foreach (var detail in lastPurchaseDetails)
            {
                var productItem = new ProductItem
                {
                    SelectedProduct = detail.Product,
                    SelectedProductId = detail.Product?.Id,
                    ProductSearchValue = detail.Product != null
                        ? $"[{detail.Product.Code}] {detail.Product.Name}"
                        : string.Empty,
                    Quantity = detail.OrderQuantity,
                    Price = detail.UnitPrice,
                    TaxRate = detail.TaxRate ?? await SystemParameterService.GetTaxRateAsync(),
                    ReceivedQuantity = 0,
                    IsReceivingCompleted = false,
                    Remarks = string.Empty
                };

                Items.Add(productItem);
            }

            await NotifyDetailsChangedAsync();

            _dataLoadCompleted = true;
            StateHasChanged();

            await NotificationService.ShowSuccessAsync($"成功載入 {lastPurchaseDetails.Count} 項上次採購的商品明細");
        }
        catch (Exception ex)
        {
            _dataLoadCompleted = true;
            await NotificationService.ShowErrorAsync($"載入上次採購明細失敗：{ex.Message}");
        }
    }

    // ===== 清除明細 =====

    private async Task ClearAllDetails()
    {
        if (!Items.Any(item => item.SelectedProduct != null))
        {
            await NotificationService.ShowWarningAsync("目前沒有可清除的明細");
            return;
        }

        var validItems = Items.Where(item => item.SelectedProduct != null).ToList();
        var clearableItems = validItems
            .Where(item => DetailLockHelper.CanDeleteItem(item, out _, checkReceiving: true))
            .ToList();
        var lockedItems = validItems
            .Where(item => !DetailLockHelper.CanDeleteItem(item, out _, checkReceiving: true))
            .ToList();

        if (!clearableItems.Any())
        {
            await NotificationService.ShowWarningAsync("所有明細都已被鎖定（已有進貨記錄），無法清除");
            return;
        }

        foreach (var item in clearableItems)
            Items.Remove(item);

        await NotifyDetailsChangedAsync();
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();

        if (lockedItems.Any())
        {
            await NotificationService.ShowSuccessAsync(
                $"已清除 {clearableItems.Count} 筆明細（保留 {lockedItems.Count} 筆已被鎖定的明細）");
        }
        else
        {
            await NotificationService.ShowSuccessAsync($"已清除 {clearableItems.Count} 筆採購明細");
        }
    }

    // ===== 相關單據查看 =====

    private async Task ShowRelatedDocuments(ProductItem item)
    {
        if (item.ExistingDetailEntity == null || item.ExistingDetailEntity.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("此項目尚未儲存，無法查看相關單據", "提示");
            return;
        }

        selectedProductName = item.SelectedProduct?.Name ?? "未知商品";
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsForPurchaseOrderDetailAsync(item.ExistingDetailEntity.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入相關單據失敗：{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            await NotificationService.ShowInfoAsync(
                $"請在主畫面中開啟 {document.TypeDisplayName}: {document.DocumentNumber}", "提示");
        }
    }

    private async Task<int?> GetCurrentUserIdAsync()
        => await CurrentUserHelper.GetCurrentEmployeeIdAsync(AuthenticationStateProvider);

    // ===== UI 列表項目模型 =====

    public class ProductItem
    {
        public Product? SelectedProduct { get; set; }
        public int? SelectedProductId { get; set; }
        public int Quantity { get; set; } = 0;
        public int ReceivedQuantity { get; set; } = 0;
        public decimal Price { get; set; } = 0;
        public decimal TaxRate { get; set; } = 0;
        public string Remarks { get; set; } = string.Empty;
        public bool IsReceivingCompleted { get; set; } = false;
        public int? CompletedByEmployeeId { get; set; }
        public DateTime? CompletedAt { get; set; }
        public PurchaseOrderDetail? ExistingDetailEntity { get; set; }

        // 是否已被入庫單使用（批次查詢快取）
        public bool? HasUsageRecordCache { get; set; } = null;

        // SearchableSelect 支援屬性
        public string ProductSearchValue { get; set; } = string.Empty;
        public List<Product> FilteredProducts { get; set; } = new();
        public bool ShowProductDropdown { get; set; } = false;
        public int ProductSelectedIndex { get; set; } = -1;

        // 計算屬性
        public string UnitName => SelectedProduct?.Unit?.Name ?? string.Empty;
    }
}
