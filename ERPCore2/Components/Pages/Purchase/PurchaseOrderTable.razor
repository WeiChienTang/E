@* æ¡è³¼å–®å•†å“ç®¡ç†çµ„ä»¶ - ä½¿ç”¨ InteractiveTableComponent çµ±ä¸€UI ä¸¦æ•´åˆè‡ªå‹•ç©ºè¡ŒåŠŸèƒ½ *@

@using ERPCore2.Helpers
@using ERPCore2.Models.Enums
@inject IProductService ProductService
@inject IPurchaseOrderDetailService PurchaseOrderDetailService
@inject ISystemParameterService SystemParameterService
@inject INotificationService NotificationService
@inject RelatedDocumentsHelper RelatedDocumentsHelper
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime

@typeparam TMainEntity where TMainEntity : BaseEntity
@typeparam TDetailEntity where TDetailEntity : BaseEntity, new()

@if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="supplier-warning">
                <p class="text-muted">é¸æ“‡å» å•†å¾Œå³å¯æŸ¥çœ‹è©²å» å•†çš„æœªå®Œæˆé€²è²¨å•†å“</p>
            </div>
        </div>
    </div>
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">        
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="ProductItem" 
                                      Items="@ProductItems"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"
                                      EmptyMessage="å°šæœªæ–°å¢å•†å“"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="false"
                                      ActionsColumnWidth = "60px"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"
                                      OnItemDelete="@HandleItemDelete"
                                      EnableAutoEmptyRow="true"
                                      AllowAddNewRow="@(!_hasUndeletableDetails && !IsReadOnly)"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@(() => new ProductItem())" />
        </div>
        
        <div class="card-footer">
            <div class="table-action-bar">
                <div class="btn-group-left">
                    <GenericButtonComponent Text="æ™ºèƒ½ä¸‹å–®"
                                          Variant="ButtonVariant.DarkBlue"
                                          OnClick="SmartPurchaseOrder"
                                          IsDisabled="@(!CanUseSmartPurchase)"
                                          Title="@GetSmartPurchaseTooltip()" />
                </div>
                <div class="btn-group-right">
                    <GenericButtonComponent Text="æ¸…é™¤æ˜ç´°"
                                          Variant="ButtonVariant.Red"
                                          OnClick="ClearAllDetails"
                                          IsDisabled="@_hasUndeletableDetails"
                                          Title="@(_hasUndeletableDetails ? "éƒ¨åˆ†å•†å“å·²æœ‰é€²è²¨è¨˜éŒ„ï¼Œç„¡æ³•æ¸…é™¤æ˜ç´°" : "æ¸…é™¤æ‰€æœ‰å•†å“æ˜ç´°")" />
                </div>
            </div>
        </div>
    </div>
}

<!-- ç›¸é—œå–®æ“šæŸ¥çœ‹ Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

@code {
    // ===== åŸºæœ¬åƒæ•¸ =====
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public EventCallback<List<ProductItem>> OnProductItemsChanged { get; set; }
    
    // ===== æ–°å¢å» å•†éæ¿¾åƒæ•¸ =====
    [Parameter] public int? SelectedSupplierId { get; set; }
    
    // ===== æ³›å‹åƒæ•¸ =====
    [Parameter] public TMainEntity? MainEntity { get; set; }
    [Parameter] public List<TDetailEntity> ExistingDetails { get; set; } = new List<TDetailEntity>();
    [Parameter] public EventCallback<List<TDetailEntity>> OnDetailsChanged { get; set; }
    
    // ===== æ¬„ä½æ˜ å°„åƒæ•¸ =====
    [Parameter] public string MainEntityIdPropertyName { get; set; } = string.Empty;
    [Parameter] public string QuantityPropertyName { get; set; } = "Quantity";
    [Parameter] public string ReceivedQuantityPropertyName { get; set; } = "ReceivedQuantity";
    [Parameter] public string UnitPricePropertyName { get; set; } = "UnitPrice";
    [Parameter] public string RemarksPropertyName { get; set; } = "Remarks";
    [Parameter] public string? UnitIdPropertyName { get; set; }
    [Parameter] public string? IsReceivingCompletedPropertyName { get; set; }        
    
    // ===== å”¯è®€æ¨¡å¼åƒæ•¸ =====
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ä¿®æ­£ï¼šçˆ¶å…ƒä»¶è¼‰å…¥ä¸­æ¨™è¨˜ï¼Œç”¨æ–¼è·³é OnInitializedAsync ä¸­çš„é‡è¤‡è¼‰å…¥
    [Parameter] public bool IsParentLoading { get; set; } = false;
    
    // ===== æ ¸å‡†ç‹€æ…‹åƒæ•¸ =====
    [Parameter] public bool IsApproved { get; set; } = false;
    
    // ===== ä¸å¯åˆªé™¤æ˜ç´°ç‹€æ…‹è®Šæ›´äº‹ä»¶ =====
    [Parameter] public EventCallback<bool> OnHasUndeletableDetailsChanged { get; set; }
    
    // ===== ç›¸é—œå–®æ“šé–‹å•Ÿäº‹ä»¶ =====
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }
    
    // ===== ç¨…ç‡ç®—æ³•åƒæ•¸ =====
    [Parameter] public TaxCalculationMethod TaxCalculationMethod { get; set; } = TaxCalculationMethod.TaxExclusive;
    
    // ===== ç¨…ç‡ç®—æ³•è¼”åŠ©å±¬æ€§ =====
    private bool IsTaxCalculationMethodNoTax => TaxCalculationMethod == TaxCalculationMethod.NoTax;

    // ===== InteractiveTableComponent åƒè€ƒ =====
    private InteractiveTableComponent<ProductItem>? tableComponent;

    private List<ProductItem> ProductItems { get; set; } = new List<ProductItem>();
    private int? _previousSelectedSupplierId = null;
    
    // ===== è³‡æ–™è¼‰å…¥ç‹€æ…‹æ§åˆ¶ =====
    private bool _dataLoadCompleted = true;  // è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜
    
    // ===== ä¸å¯åˆªé™¤æ˜ç´°ç‹€æ…‹è¿½è¹¤ =====
    private bool _hasUndeletableDetails = false;  // æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°ï¼ˆå·²æœ‰é€²è²¨è¨˜éŒ„ï¼‰
    
    // æ–¹æ¡ˆ D æ”¹è‰¯ç‰ˆï¼šä½¿ç”¨ DataVersion è¿½è¹¤ï¼Œé¿å… ReferenceEquals å¤±æ•ˆ
    // ç”±çˆ¶å…ƒä»¶æ§åˆ¶ä½•æ™‚éœ€è¦é‡æ–°è¼‰å…¥
    [Parameter] public int DataVersion { get; set; } = 0;
    private int _previousDataVersion = 0;
    
    // ===== ç›¸é—œå–®æ“šæŸ¥çœ‹ =====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;

    protected override async Task OnInitializedAsync()
    {
        // åˆå§‹åŒ–è¿½è¹¤è®Šæ•¸
        _previousSelectedSupplierId = SelectedSupplierId;
        
        // ä¿®æ­£ï¼šå¦‚æœçˆ¶å…ƒä»¶æ­£åœ¨è¼‰å…¥ä¸­ï¼Œè·³éè³‡æ–™è¼‰å…¥
        // ğŸ”¥ é‡è¦ï¼šæ­¤æ™‚ä¸è¨­å®š _previousDataVersionï¼Œè®“ OnParametersSetAsync èƒ½å¤ åµæ¸¬åˆ°è®ŠåŒ–
        if (IsParentLoading)
        {
            return;
        }
        
        // åªæœ‰åœ¨æˆåŠŸè¼‰å…¥å¾Œæ‰è¨­å®š _previousDataVersion
        _previousDataVersion = DataVersion;
        
        // ä¿®æ­£ 3ï¼šé¦–æ¬¡æ›è¼‰æ™‚è¼‰å…¥è³‡æ–™
        // å°èˆªæ™‚å› ç‚ºç§»é™¤äº† @keyï¼Œå…ƒä»¶ä¸æœƒé‡å»ºï¼ŒOnInitializedAsync åªåŸ·è¡Œä¸€æ¬¡
        // å¾ŒçºŒå°èˆªç”± OnParametersSetAsync + DataVersion è®Šæ›´ä¾†è™•ç†
        
        await LoadExistingDetailsAsync();
        
        // æª¢æŸ¥æ˜¯å¦æœ‰æ­·å²æ¡è³¼è¨˜éŒ„
        await CheckLastPurchaseRecordAsync();
    }

    // é˜²æ­¢é‡å…¥ flag
    private bool _isLoadingDetails = false;

    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        
        // é˜²æ­¢é‡å…¥ï¼šå¦‚æœæ­£åœ¨è¼‰å…¥ä¸­ï¼Œè·³é
        if (_isLoadingDetails)
        {
            return;
        }
        
        // æ–¹æ¡ˆ D æ”¹è‰¯ç‰ˆï¼šå„ªå…ˆæª¢æŸ¥ DataVersion
        // DataVersion è®Šæ›´ä»£è¡¨çˆ¶å…ƒä»¶å·²ç¶“è¼‰å…¥æ–°è³‡æ–™ï¼Œæ­¤æ™‚ä¸éœ€è¦å†æª¢æŸ¥ supplierChanged
        bool versionChanged = DataVersion != _previousDataVersion;
        
        if (versionChanged)
        {
            // é—œéµï¼šåŒæ™‚æ›´æ–°æ‰€æœ‰è¿½è¹¤è®Šæ•¸ï¼Œé¿å…å¾ŒçºŒçš„ supplierChanged èª¤åˆ¤
            _previousDataVersion = DataVersion;
            _previousSelectedSupplierId = SelectedSupplierId;
            
            _isLoadingDetails = true;
            try
            {
                await LoadExistingDetailsAsync();
                tableComponent?.RefreshEmptyRow();
            }
            finally
            {
                _isLoadingDetails = false;
            }
        }
        else
        {
            // åªæœ‰åœ¨ DataVersion æ²’è®Šçš„æƒ…æ³ä¸‹ï¼Œæ‰æª¢æŸ¥ supplierChanged
            // é€™ä¸»è¦ç”¨æ–¼ä½¿ç”¨è€…åœ¨åŒä¸€ç­†è¨˜éŒ„å…§æ‰‹å‹•æ›´æ›å» å•†çš„æƒ…æ³
            bool supplierChanged = _previousSelectedSupplierId != SelectedSupplierId;
            
            if (supplierChanged)
            {
                _previousSelectedSupplierId = SelectedSupplierId;
                
                _isLoadingDetails = true;
                try
                {
                    // å¦‚æœæ›´æ›å» å•†ï¼Œéœ€è¦æ¸…ç©ºç¾æœ‰é¸é …ä¸¦é‡æ–°è¼‰å…¥
                    ProductItems.Clear();
                    await LoadExistingDetailsAsync();
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰æ­·å²æ¡è³¼è¨˜éŒ„
                    await CheckLastPurchaseRecordAsync();
                }
                finally
                {
                    _isLoadingDetails = false;
                }
            }
        }
    }
    
    /// <summary>
    /// æª¢æŸ¥æ˜¯å¦æœ‰æ­·å²æ¡è³¼è¨˜éŒ„
    /// </summary>
    private async Task CheckLastPurchaseRecordAsync()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
        {
            _hasLastPurchaseRecord = false;
            return;
        }
        
        try
        {
            var lastPurchaseDetails = await PurchaseOrderDetailService.GetLastCompletePurchaseAsync(SelectedSupplierId.Value);
            _hasLastPurchaseRecord = lastPurchaseDetails?.Any() == true;
        }
        catch
        {
            _hasLastPurchaseRecord = false;
        }
    }

    // ===== InteractiveTableComponent æ–¹æ³• =====
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        //  å•†å“é¸æ“‡æ¬„ä½ - è§¸ç™¼æ¬„ä½ï¼ˆç¬¬ä¸€å€‹æ¬„ä½é è¨­ç‚ºè§¸ç™¼æ¬„ä½ï¼‰
        columns.Add(new() 
        { 
            Title = "å•†å“ç·¨è™Ÿ/åç¨±", 
            PropertyName = "ProductSearchValue",
            EmptyCheckPropertyName = "SelectedProduct",  // æª¢æŸ¥ SelectedProduct ç‰©ä»¶
            TriggerEmptyRowOnFilled = true,  // é¸æ“‡å•†å“å¾Œè‡ªå‹•æ–°å¢ç©ºè¡Œ
            ColumnType = InteractiveColumnType.SearchableSelect,
            Width = "250px",
            Tooltip = "æœå°‹ä¸¦é¸æ“‡å•†å“ï¼ˆè¼¸å…¥ç·¨è™Ÿæˆ–åç¨±ï¼‰ã€‚å·²æœ‰é€²è²¨è¨˜éŒ„çš„å•†å“å°‡ç„¡æ³•è®Šæ›´",
            Placeholder = "è«‹è¼¸å…¥å•†å“ç·¨è™Ÿæˆ–åç¨±",
            SearchValuePropertyName = nameof(ProductItem.ProductSearchValue),
            FilteredItemsPropertyName = nameof(ProductItem.FilteredProducts),
            ShowDropdownPropertyName = nameof(ProductItem.ShowProductDropdown),
            SelectedIndexPropertyName = nameof(ProductItem.ProductSelectedIndex),
            ItemDisplayFormatter = (item) =>
            {
                var product = (Product)item;
                return $"[{product.Code}] {product.Name}";
            },
            IsDisabledFunc = item =>
            {
                var productItem = (ProductItem)item;
                return IsReadOnly || !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true);
            },
            TooltipFunc = item =>
            {
                var productItem = (ProductItem)item;
                return !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true) 
                    ? "æ­¤å•†å“å·²æœ‰é€²è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹å•†å“é¸æ“‡" : null;
            },
            OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, (tuple) =>
            {
                var (item, searchValue) = tuple;
                OnProductSearchChanged((ProductItem)item, searchValue);
            }),
            OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
            {
                var (item, selectedItem) = tuple;
                await OnProductSelected((ProductItem)item, (Product?)selectedItem);
            }),
            OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
            {
                var productItem = (ProductItem)item;
                var availableProducts = GetAvailableProducts();
                productItem.FilteredProducts = availableProducts.Take(20).ToList();
                productItem.ShowProductDropdown = true;
                productItem.ProductSelectedIndex = -1;
                StateHasChanged();
            }),
            OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
            {
                Task.Delay(200).ContinueWith(_ =>
                {
                    var productItem = (ProductItem)item;
                    productItem.ShowProductDropdown = false;
                    InvokeAsync(StateHasChanged);
                });
            }),
            EnableKeyboardNavigation = true,
            GetDropdownItems = (item) => ((ProductItem)item).FilteredProducts,
            GetSelectedIndex = (item) => ((ProductItem)item).ProductSelectedIndex,
            SetSelectedIndex = (item, index) => ((ProductItem)item).ProductSelectedIndex = index,
            GetShowDropdown = (item) => ((ProductItem)item).ShowProductDropdown,
            SetShowDropdown = (item, show) => ((ProductItem)item).ShowProductDropdown = show,
            MaxDisplayItems = 20
        });
        
        // æ•¸é‡æ¬„ä½
        columns.Add(new() 
        { 
            Title = "æ•¸é‡", 
            PropertyName = "Quantity",
            ColumnType = InteractiveColumnType.Number,
            Width = "80px",
            Tooltip = "æ¡è³¼çš„å•†å“æ•¸é‡ã€‚å·²æœ‰é€²è²¨è¨˜éŒ„çš„å•†å“å°‡ç„¡æ³•ä¿®æ”¹æ•¸é‡",
            IsDisabledFunc = item =>
            {
                var productItem = (ProductItem)item;
                return !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true);
            },
            TooltipFunc = item =>
            {
                var productItem = (ProductItem)item;
                return !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true) 
                    ? "æ­¤å•†å“å·²æœ‰é€²è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹æ•¸é‡" : null;
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnQuantityInput((ProductItem)item, valueString);
            })
        });
        
        // å–®ä½æ¬„ä½ (å”¯è®€ - é¡¯ç¤ºå•†å“çš„å–®ä½åç¨±)
        columns.Add(new() 
        { 
            Title = "å–®ä½", 
            PropertyName = "UnitName",
            ColumnType = InteractiveColumnType.Display,
            Width = "60px",
            Tooltip = "å•†å“çš„è¨ˆé‡å–®ä½ï¼ˆå”¯è®€ï¼Œè«‹åœ¨å•†å“è³‡æ–™ä¸­ä¿®æ”¹ï¼‰",
            IsReadOnly = true
        });
    
        // å…¥åº«é‡æ¬„ä½ (åªè®€)
        columns.Add(new() 
        { 
            Title = "å·²å…¥åº«", 
            PropertyName = "ReceivedQuantity",
            ColumnType = InteractiveColumnType.Display,
            Width = "80px",
            Tooltip = "å·²å…¥åº«çš„ç´¯è¨ˆæ•¸é‡ï¼ˆå”¯è®€ï¼‰",
            TextAlign = "right",
            IsReadOnly = true
        });

        // å–®åƒ¹æ¬„ä½
        columns.Add(new() 
        { 
            Title = "å–®åƒ¹", 
            PropertyName = "Price",
            ColumnType = InteractiveColumnType.Number,  // é è¨­é¡¯ç¤ºåƒåˆ†ä½
            Width = "120px",
            Tooltip = "å•†å“çš„æ¡è³¼å–®åƒ¹ã€‚å·²æœ‰é€²è²¨è¨˜éŒ„çš„å•†å“å°‡ç„¡æ³•ä¿®æ”¹å–®åƒ¹",
            IsDisabledFunc = item =>
            {
                var productItem = (ProductItem)item;
                return !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true);
            },
            TooltipFunc = item =>
            {
                var productItem = (ProductItem)item;
                return !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true) 
                    ? "æ­¤å•†å“å·²æœ‰é€²è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹å–®åƒ¹" : null;
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnPriceInput((ProductItem)item, valueString);
            })
        });

        // ç¨…ç‡æ¬„ä½ï¼ˆå¯ç·¨è¼¯ï¼‰
        columns.Add(new()
        {
            Title = "ç¨…ç‡%",
            PropertyName = "TaxRate",
            ColumnType = InteractiveColumnType.Number,
            Width = "80px",
            Tooltip = "å•†å“çš„ç¨…ç‡ï¼ˆ0% ~ 100%ï¼‰ï¼Œå¯æ‰‹å‹•èª¿æ•´ã€‚ç•¶ä¸»æª”é¸æ“‡å…ç¨…æ™‚æ­¤æ¬„ä½å°‡è¢«ç¦ç”¨",
            IsDisabledFunc = item =>
            {
                var productItem = (ProductItem)item;
                // ç•¶ä¸»æª”é¸æ“‡å…ç¨…æ™‚ï¼Œç¦ç”¨ç¨…ç‡æ¬„ä½
                return IsReadOnly || IsTaxCalculationMethodNoTax || 
                       !DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true);
            },
            TooltipFunc = item =>
            {
                var productItem = (ProductItem)item;
                if (IsTaxCalculationMethodNoTax) return "ä¸»æª”å·²é¸æ“‡å…ç¨…ï¼Œæ­¤æ¬„ä½å·²åœç”¨";
                if (!DetailLockHelper.CanDeleteItem(productItem, out _, checkReceiving: true))
                    return "æ­¤å•†å“å·²æœ‰é€²è²¨è¨˜éŒ„ï¼Œç„¡æ³•ä¿®æ”¹ç¨…ç‡";
                return null;
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnTaxRateInput((ProductItem)item, valueString);
            })
        });

        // å°è¨ˆæ¬„ä½ï¼ˆæ ¹æ“šç¨…ç‡ç®—æ³•é¡¯ç¤ºï¼‰
        columns.Add(new()
        {
            Title = "å°è¨ˆ",
            Tooltip = GetSubtotalTooltip(),
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item =>
            {
                var productItem = (ProductItem)item;
                var subtotal = CalculateItemSubtotal(productItem);
                var displayValue = NumberFormatHelper.FormatSmartZeroAsEmpty(subtotal);
                return @<div class="text-end fw-bold text-success">@displayValue</div>;
            }
        });

        // å®Œæˆé€²è²¨æ¬„ä½
        columns.Add(new() 
        { 
            Title = "çµæ¡ˆ", 
            PropertyName = "IsReceivingCompleted",
            ColumnType = InteractiveColumnType.Checkbox,
            Width = "60px",
            Tooltip = "æ‰‹å‹•æ¨™è¨˜æ­¤å•†å“å·²å®Œæˆæ‰€æœ‰é€²è²¨ä½œæ¥­ï¼ˆå³ä½¿æ•¸é‡æœªå®Œå…¨å…¥åº«ï¼‰\næ ¸å‡†å¾Œä»å¯ä¿®æ”¹æ­¤ç‹€æ…‹",
            IsDisabledFunc = item =>
            {
                var productItem = (ProductItem)item;
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“å®Œå…¨é€²è²¨ï¼ˆå…¥åº« >= æ¡è³¼ï¼‰
                var isFullyReceived = productItem.ReceivedQuantity >= productItem.Quantity;
                // å¦‚æœå·²å®Œå…¨é€²è²¨ä¸”å·²æ¨™è¨˜å®Œæˆï¼Œå‰‡ç¦ç”¨ï¼ˆä¸èƒ½å–æ¶ˆï¼‰
                return IsReadOnly || (isFullyReceived && productItem.IsReceivingCompleted);
            },
            TooltipFunc = item =>
            {
                var productItem = (ProductItem)item;
                var isFullyReceived = productItem.ReceivedQuantity >= productItem.Quantity;
                if (isFullyReceived && productItem.IsReceivingCompleted)
                    return "å·²å®Œå…¨é€²è²¨ï¼Œç„¡æ³•å–æ¶ˆ";
                return null;
            },
            OnCheckboxChanged = EventCallback.Factory.Create<(object, bool)>(this, async args =>
            {
                var (item, newValue) = args;
                await OnIsReceivingCompletedChanged((ProductItem)item, newValue);
            })
        });

        // å‚™è¨»æ¬„ä½ - æ ¸å‡†å¾Œä»å¯ç·¨è¼¯ï¼ˆç”¨æ–¼è¨˜éŒ„åŸ·è¡Œç‹€æ³ï¼‰
        columns.Add(new() 
        { 
            Title = "å‚™è¨»", 
            PropertyName = "Remarks",
            ColumnType = InteractiveColumnType.Custom,
            Width = "300px",
            HideOnMobile = true,
            ExcludeFromEmptyCheck = true,  // å‚™è¨»ä¸åƒèˆ‡ç©ºè¡Œæª¢æŸ¥
            Tooltip = "é¸å¡«ã€‚å¯è¨˜éŒ„æ¡è³¼ç›¸é—œçš„å‚™è¨»è³‡è¨Šï¼ˆæ ¸å‡†å¾Œä»å¯ç·¨è¼¯ï¼‰",
            CustomTemplate = item => 
            {
                var productItem = (ProductItem)item;
                // éŠ·è²¨ å‚™è¨»æ¬„ä½åªå— IsReadOnly å½±éŸ¿ï¼Œæ ¸å‡†å¾Œä»å¯ç·¨è¼¯
                var isFieldReadOnly = IsReadOnly;
                
                // å¦‚æœæ˜¯å”¯è®€ç‹€æ…‹ï¼Œç›´æ¥é¡¯ç¤º span
                if (isFieldReadOnly)
                {
                    var displayText = string.IsNullOrEmpty(productItem.Remarks) ? "ç„¡å‚™è¨»" : productItem.Remarks;
                    return @<div class="d-flex align-items-center" style="min-height: 31px;">
                        <span class="text-muted">@displayText</span>
                    </div>;
                }
                
                return @<input type="text" class="form-control " 
                               value="@productItem.Remarks"
                               @oninput="(e) => OnRemarksInput(productItem, e.Value?.ToString())"/>;
            }
        });

        return columns;
    }

    private RenderFragment<ProductItem> GetCustomActionsTemplate => item => __builder =>
    {
        // æª¢æŸ¥æ˜¯å¦ç‚ºæœ€å¾Œä¸€å€‹ç©ºè¡Œï¼ˆä¸å¯åˆªé™¤ï¼‰
        var isLastEmptyRow = tableComponent?.IsLastEmptyRow(item) ?? false;
        
        // ä½¿ç”¨ DetailLockHelper æª¢æŸ¥æ˜¯å¦å¯ä»¥åˆªé™¤
        if (DetailLockHelper.CanDeleteItem(item, out _, checkReceiving: true) && !isLastEmptyRow)
        {
            // å¯ä»¥åˆªé™¤ï¼šé¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Red"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="@IsReadOnly"
                                   Title="åˆªé™¤"
                                   OnClick="async () => await HandleItemDelete(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else if (isLastEmptyRow)
        {
            // æœ€å¾Œä¸€å€‹ç©ºè¡Œï¼šé¡¯ç¤ºç¦ç”¨çš„åˆªé™¤æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Red"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="true"
                                   Title="è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹ç©ºè¡Œ"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else
        {
            // å·²è¢«ä½¿ç”¨ï¼šé¡¯ç¤ºæŸ¥çœ‹æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Blue"
                                   IconClass="bi bi-eye text-white"
                                   Size="ButtonSize.Large"
                                   Title="æŸ¥çœ‹ç›¸é—œå–®æ“š"
                                   OnClick="async () => await ShowRelatedDocuments(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
    };

    private async Task HandleItemDelete(ProductItem item)
    {
        var index = ProductItems.IndexOf(item);
        await RemoveItemAsync(index);
    }

    // ===== å…§éƒ¨æ–¹æ³• =====

    /// <summary>
    /// å…¬é–‹æ–¹æ³•ï¼šåˆ·æ–°æ˜ç´°è³‡æ–™ï¼ˆä¾›çˆ¶çµ„ä»¶å‘¼å«ï¼‰
    /// ç”¨æ–¼å­å–®æ“šå„²å­˜å¾Œï¼Œé‡æ–°è¼‰å…¥æ˜ç´°ä»¥æ›´æ–°ç›¸é—œæ•¸é‡ï¼ˆå¦‚å…¥åº«é‡ï¼‰
    /// 
    /// ä½¿ç”¨å ´æ™¯ï¼š
    /// - é€²è²¨å–®å„²å­˜å¾Œï¼Œåˆ·æ–°æ¡è³¼å–®æ˜ç´°çš„ã€Œå…¥åº«é‡ã€
    /// - ç¢ºä¿ UI é¡¯ç¤ºæœ€æ–°çš„è³‡æ–™ç‹€æ…‹
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadExistingDetailsAsync();
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }

    /// <summary>
    /// å¾ç¾æœ‰æ˜ç´°è³‡æ–™è¼‰å…¥åˆ° ProductItems
    /// </summary>
    private async Task LoadExistingDetailsAsync()
    {
        if (ExistingDetails?.Any() != true) 
        {
            return;
        }

        //  é–‹å§‹è¼‰å…¥è³‡æ–™ - è¨­å®šç‚ºæœªå®Œæˆ
        _dataLoadCompleted = false;
        
        ProductItems.Clear();
        
        // æ–¹æ¡ˆ Cï¼šæ‰¹æ¬¡æŸ¥è©¢å–ä»£é€ç­†æŸ¥è©¢ - è§£æ±º N+1 å•é¡Œ
        // é å…ˆå–å¾—æ‰€æœ‰æ˜ç´°çš„ä½¿ç”¨ç´€éŒ„ï¼Œå°‡ N æ¬¡æŸ¥è©¢åˆä½µç‚º 1 æ¬¡
        var detailIds = ExistingDetails
            .Select(d => GetPropertyValue<int>(d, "Id"))
            .Where(id => id > 0)
            .ToList();
        
        var usageRecordMap = detailIds.Any() 
            ? await RelatedDocumentsHelper.HasUsageRecordBatchForPurchaseOrderDetailsAsync(detailIds)
            : new Dictionary<int, bool>();
        
        foreach (var detail in ExistingDetails)
        {
            var productId = GetPropertyValue<int>(detail, "ProductId");
            var product = Products.FirstOrDefault(p => p.Id == productId);
            
            if (product != null)
            {
                var detailId = GetPropertyValue<int>(detail, "Id");
                var taxRate = GetPropertyValue<decimal?>(detail, "TaxRate");
                var item = new ProductItem
                {
                    SelectedProduct = product,
                    SelectedProductId = productId,  //  åŒæ­¥è¨­å®š ID
                    ProductSearchValue = $"[{product.Code}] {product.Name}",  // è¨­å®šæœå°‹é¡¯ç¤ºå€¼
                    Quantity = Convert.ToInt32(GetPropertyValue<object>(detail, QuantityPropertyName) ?? 0),
                    ReceivedQuantity = Convert.ToInt32(GetPropertyValue<object>(detail, ReceivedQuantityPropertyName) ?? 0),
                    Price = Convert.ToDecimal(GetPropertyValue<object>(detail, UnitPricePropertyName) ?? 0m),
                    TaxRate = taxRate ?? await SystemParameterService.GetTaxRateAsync(),
                    Remarks = GetPropertyValue<string>(detail, RemarksPropertyName) ?? string.Empty,
                    IsReceivingCompleted = !string.IsNullOrEmpty(IsReceivingCompletedPropertyName) ? 
                        Convert.ToBoolean(GetPropertyValue<object>(detail, IsReceivingCompletedPropertyName) ?? false) : false,
                    CompletedByEmployeeId = GetPropertyValue<int?>(detail, "CompletedByEmployeeId"),
                    CompletedAt = GetPropertyValue<DateTime?>(detail, "CompletedAt"),
                    ExistingDetailEntity = detail
                };
                
                // ä½¿ç”¨æ‰¹æ¬¡æŸ¥è©¢çµæœï¼Œé¿å… N+1 æŸ¥è©¢
                item.HasUsageRecordCache = usageRecordMap.GetValueOrDefault(detailId, false);
                
                ProductItems.Add(item);
            }
        }
        
        // é—œéµï¼šè¼‰å…¥å¾Œç«‹å³æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°
        bool hasUndeletableDetails = ProductItems.Any(p => !DetailLockHelper.CanDeleteItem(p, out _, checkReceiving: true));
        if (_hasUndeletableDetails != hasUndeletableDetails)
        {
            _hasUndeletableDetails = hasUndeletableDetails;
        }
        
        //  è³‡æ–™è¼‰å…¥å®Œæˆ - è§¸ç™¼ç©ºè¡Œæª¢æŸ¥ï¼ˆæ­¤æ™‚ _hasUndeletableDetails å·²ç¶“æ˜¯æ­£ç¢ºçš„å€¼ï¼‰
        _dataLoadCompleted = true;
        
        StateHasChanged();
    }

    /// <summary>
    /// è½‰æ› ProductItems ç‚ºæ˜ç´°å¯¦é«”åˆ—è¡¨
    /// </summary>
    private List<TDetailEntity> ConvertToDetailEntities()
    {
        var details = new List<TDetailEntity>();
        
        // åªè½‰æ›æœ‰é¸æ“‡å•†å“çš„é …ç›®ï¼ˆæ’é™¤ç©ºè¡Œï¼‰
        foreach (var item in ProductItems.Where(x => x.SelectedProduct != null))
        {
            TDetailEntity detail;
            
            if (item.ExistingDetailEntity != null)
            {
                detail = item.ExistingDetailEntity;
            }
            else
            {
                detail = new TDetailEntity();
                
                if (MainEntity != null && !string.IsNullOrEmpty(MainEntityIdPropertyName))
                {
                    SetPropertyValue(detail, MainEntityIdPropertyName, MainEntity.Id);
                }
            }
            
            // ç„¡è«–æ˜¯æ–°å¢æˆ–ç·¨è¼¯ï¼Œéƒ½è¦æ›´æ–° ProductIdï¼ˆå…è¨±æ›´æ›å•†å“ï¼‰
            if (item.SelectedProduct != null)
            {
                SetPropertyValue(detail, "ProductId", item.SelectedProduct.Id);
            }
            
            SetPropertyValue(detail, QuantityPropertyName, item.Quantity);
            SetPropertyValue(detail, ReceivedQuantityPropertyName, item.ReceivedQuantity);
            SetPropertyValue(detail, UnitPricePropertyName, item.Price);
            SetPropertyValue(detail, "TaxRate", item.TaxRate);
            SetPropertyValue(detail, RemarksPropertyName, item.Remarks);
            
            if (!string.IsNullOrEmpty(IsReceivingCompletedPropertyName))
            {
                SetPropertyValue(detail, IsReceivingCompletedPropertyName, item.IsReceivingCompleted);
            }
            
            // å„²å­˜å®Œæˆé€²è²¨çš„è¿½è¹¤è³‡æ–™
            SetPropertyValue(detail, "CompletedByEmployeeId", item.CompletedByEmployeeId);
            SetPropertyValue(detail, "CompletedAt", item.CompletedAt);
            
            details.Add(detail);
        }
        
        return details;
    }

    /// <summary>
    /// ç›´æ¥é€šçŸ¥è©³ç´°è³‡æ–™è®Šæ›´ - åƒè€ƒ ProductSupplierManagerComponent çš„ç°¡æ½”å¯«æ³•
    /// </summary>
    private async Task NotifyDetailsChanged()
    {
        var details = ConvertToDetailEntities();
        await DetailSyncHelper.SyncToParentAsync(details, OnDetailsChanged);
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ä¸å¯åˆªé™¤çš„æ˜ç´°(å·²æœ‰é€²è²¨è¨˜éŒ„)
        bool hasUndeletableDetails = ProductItems.Any(p => !DetailLockHelper.CanDeleteItem(p, out _, checkReceiving: true));
        
        // ç‹€æ…‹è®Šæ›´æ™‚æ‰é€šçŸ¥çˆ¶çµ„ä»¶ä¸¦è§¸ç™¼ UI æ›´æ–°
        if (_hasUndeletableDetails != hasUndeletableDetails)
        {
            _hasUndeletableDetails = hasUndeletableDetails;
            await OnHasUndeletableDetailsChanged.InvokeAsync(hasUndeletableDetails);
            
            // é—œéµï¼šç‹€æ…‹è®Šæ›´å¾Œï¼Œç«‹å³åˆ·æ–°ç©ºè¡Œï¼ˆç§»é™¤æˆ–æ–°å¢ï¼‰
            tableComponent?.RefreshEmptyRow();
            
            StateHasChanged();  // è§¸ç™¼ UI æ›´æ–°ï¼Œè®“ AllowAddNewRow åƒæ•¸ç”Ÿæ•ˆ
        }
    }

    /// <summary>
    /// ä½¿ç”¨åå°„å–å¾—å±¬æ€§å€¼
    /// </summary>
    private T? GetPropertyValue<T>(object obj, string propertyName)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property == null) return default(T);
        
        var value = property.GetValue(obj);
        if (value == null) return default(T);
        
        if (typeof(T) == typeof(object)) return (T)value;
        
        // éŠ·è²¨ ä¿®å¾©ï¼šè™•ç† nullable é¡å‹çš„è½‰æ›
        var targetType = typeof(T);
        
        // å¦‚æœç›®æ¨™é¡å‹æ˜¯ nullableï¼Œå–å¾—å…¶åº•å±¤é¡å‹
        if (targetType.IsGenericType && targetType.GetGenericTypeDefinition() == typeof(Nullable<>))
        {
            var underlyingType = Nullable.GetUnderlyingType(targetType);
            if (underlyingType != null)
            {
                // è½‰æ›ç‚ºåº•å±¤é¡å‹ï¼Œç„¶å¾Œè®“ C# è‡ªå‹•è£ç®±ç‚º nullable
                var convertedValue = Convert.ChangeType(value, underlyingType);
                return (T)convertedValue;
            }
        }
        
        return (T)Convert.ChangeType(value, targetType);
    }

    /// <summary>
    /// ä½¿ç”¨åå°„è¨­å®šå±¬æ€§å€¼
    /// </summary>
    private void SetPropertyValue(object obj, string propertyName, object? value)
    {
        var property = obj.GetType().GetProperty(propertyName);
        if (property != null && property.CanWrite)
        {
            if (value != null && property.PropertyType != value.GetType())
            {
                if (property.PropertyType.IsGenericType && property.PropertyType.GetGenericTypeDefinition() == typeof(Nullable<>))
                {
                    var underlyingType = Nullable.GetUnderlyingType(property.PropertyType);
                    value = Convert.ChangeType(value, underlyingType!);
                }
                else
                {
                    value = Convert.ChangeType(value, property.PropertyType);
                }
            }
            property.SetValue(obj, value);
        }
    }

    // ===== å•†å“é¸æ“‡äº‹ä»¶è™•ç† =====

    /// <summary>
    /// å•†å“æœå°‹è¼¸å…¥è®Šæ›´äº‹ä»¶ï¼ˆSearchableSelectï¼‰
    /// </summary>
    private void OnProductSearchChanged(ProductItem item, string? searchValue)
    {
        item.ProductSearchValue = searchValue ?? string.Empty;
        
        var availableProducts = GetAvailableProducts();
        
        if (string.IsNullOrWhiteSpace(searchValue))
        {
            // ç©ºç™½æœå°‹ï¼šé¡¯ç¤ºå‰20ç­†
            item.FilteredProducts = availableProducts.Take(20).ToList();
        }
        else
        {
            // ç¯©é¸ç¬¦åˆçš„å•†å“ï¼ˆç·¨è™Ÿæˆ–åç¨±åŒ…å«æœå°‹å­—ä¸²ï¼‰
            item.FilteredProducts = availableProducts
                .Where(p => (p.Code?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                           (p.Name?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false))
                .Take(20)
                .ToList();
        }
        
        item.ShowProductDropdown = true;
        item.ProductSelectedIndex = -1;
        StateHasChanged();
    }
    
    /// <summary>
    /// å•†å“é¸æ“‡äº‹ä»¶ï¼ˆSearchableSelectï¼‰
    /// </summary>
    private async Task OnProductSelected(ProductItem item, Product? selectedProduct)
    {
        if (selectedProduct != null)
        {
            item.SelectedProduct = selectedProduct;
            item.SelectedProductId = selectedProduct.Id;
            item.ProductSearchValue = $"[{selectedProduct.Code}] {selectedProduct.Name}";
            
            // å„ªå…ˆä½¿ç”¨å•†å“çš„ç¨…ç‡ï¼Œå¦‚æœç‚º null å‰‡å¾ç³»çµ±åƒæ•¸å–å¾—é è¨­å€¼
            if (selectedProduct.TaxRate.HasValue)
            {
                item.TaxRate = selectedProduct.TaxRate.Value;
            }
            else
            {
                // å¾ç³»çµ±åƒæ•¸å–å¾—é è¨­ç¨…ç‡
                item.TaxRate = await SystemParameterService.GetTaxRateAsync();
            }
        }
        else
        {
            item.SelectedProduct = null;
            item.SelectedProductId = null;
            item.ProductSearchValue = string.Empty;
        }
        
        item.ShowProductDropdown = false;
        item.ProductSelectedIndex = -1;
        
        await NotifyDetailsChanged();
    }

    // ===== æ¬„ä½è®Šæ›´äº‹ä»¶è™•ç† =====

    private async Task OnQuantityInput(ProductItem item, string? value)
    {
        item.Quantity = (int)InputEventHelper.HandleQuantityInput(value, 0);
        await NotifyDetailsChanged();
    }

    private async Task OnPriceInput(ProductItem item, string? value)
    {
        item.Price = InputEventHelper.HandlePriceInput(value, 0);
        await NotifyDetailsChanged();
    }

    private async Task OnTaxRateInput(ProductItem item, string? value)
    {
        item.TaxRate = InputEventHelper.HandlePercentageInput(value, 0, 100, 0);
        await NotifyDetailsChanged();
    }

    private async Task OnRemarksInput(ProductItem item, string? value)
    {
        item.Remarks = InputEventHelper.HandleTextInput(value, string.Empty);
        await NotifyDetailsChanged();
    }

    private async Task OnIsReceivingCompletedChanged(ProductItem item, bool newValue)
    {
        // æª¢æŸ¥æ˜¯å¦å·²ç¶“å®Œå…¨é€²è²¨
        var isFullyReceived = item.ReceivedQuantity >= item.Quantity;
        
        // å¦‚æœå·²å®Œå…¨é€²è²¨ä¸”å˜—è©¦å–æ¶ˆå®Œæˆç‹€æ…‹ï¼Œä¸å…è¨±
        if (isFullyReceived && item.IsReceivingCompleted && !newValue)
        {
            await NotificationService.ShowWarningAsync("æ­¤å•†å“å·²å…¨æ•¸å…¥åº«ï¼Œç„¡æ³•å–æ¶ˆå®Œæˆç‹€æ…‹");
            return;
        }
        
        // è¨­å®šæ–°ç‹€æ…‹
        item.IsReceivingCompleted = newValue;
        
        // è¨˜éŒ„æ“ä½œè€…å’Œæ™‚é–“ï¼ˆåªåœ¨æ¨™è¨˜ç‚ºå®Œæˆæ™‚è¨˜éŒ„ï¼‰
        if (newValue)
        {
            var currentUserId = await GetCurrentUserIdAsync();
            if (currentUserId.HasValue)
            {
                item.CompletedByEmployeeId = currentUserId.Value;
                item.CompletedAt = DateTime.Now;
            }
        }
        else
        {
            // å–æ¶ˆå®Œæˆæ™‚æ¸…é™¤è¨˜éŒ„
            item.CompletedByEmployeeId = null;
            item.CompletedAt = null;
        }
        
        await NotifyDetailsChanged();
    }

    public async Task RemoveItemAsync(int index)
    {
        if (IsReadOnly || index < 0 || index >= ProductItems.Count) return;
        
        var removedItem = ProductItems[index];
        ProductItems.Remove(removedItem);
        
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// å–å¾—å¯ç”¨å•†å“åˆ—è¡¨ï¼ˆæ ¹æ“šå» å•†éæ¿¾ï¼Œä¸”åªé¡¯ç¤ºå¤–è³¼å•†å“ï¼‰
    /// </summary>
    private List<Product> GetAvailableProducts()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
        {
            return new List<Product>();
        }
        
        // åªé¡¯ç¤ºå¤–è³¼é¡å‹çš„å•†å“ï¼ˆè‡ªè£½å•†å“ç”±ç”Ÿç”¢æ’ç¨‹ç”¢ç”Ÿï¼Œä¸éœ€è¦æ¡è³¼ï¼‰
        return Products.Where(p => p.ProcurementType == ProcurementType.Purchased).ToList();
    }
    
    /// <summary>
    /// è¨ˆç®—æ˜ç´°é …ç›®çš„å°è¨ˆï¼ˆæ ¹æ“šç¨…ç‡ç®—æ³•ï¼Œå››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼‰
    /// </summary>
    private decimal CalculateItemSubtotal(ProductItem item)
    {
        if (item.SelectedProduct == null || item.Quantity <= 0 || item.Price <= 0)
        {
            return 0;
        }
        
        var subtotal = CalculationHelper.CalculateSubtotal(
            item.Quantity, 
            item.Price, 
            discountPercentage: 0,
            item.TaxRate, 
            TaxCalculationMethod
        );
        
        // å››æ¨äº”å…¥åˆ°æ•´æ•¸
        return CalculationHelper.Round(subtotal, 0);
    }
    
    /// <summary>
    /// å–å¾—å°è¨ˆæ¬„ä½çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetSubtotalTooltip()
    {
        return TaxCalculationMethod switch
        {
            TaxCalculationMethod.TaxExclusive => "å¤–åŠ ç¨…ï¼šæ•¸é‡ Ã— å–®åƒ¹ Ã— (1 + ç¨…ç‡%)",
            TaxCalculationMethod.TaxInclusive => "å…§å«ç¨…ï¼šæ•¸é‡ Ã— å–®åƒ¹ï¼ˆå–®åƒ¹å·²å«ç¨…ï¼‰",
            TaxCalculationMethod.NoTax => "å…ç¨…ï¼šæ•¸é‡ Ã— å–®åƒ¹",
            _ => "æ•¸é‡ Ã— å–®åƒ¹"
        };
    }

    private decimal GetTotalAmount()
    {
        return ProductItems
            .Where(item => item.SelectedProduct != null && item.Quantity > 0)
            .Sum(item => item.Quantity * item.Price);
    }

    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        // æª¢æŸ¥æ˜¯å¦è‡³å°‘æœ‰ä¸€å€‹æœ‰æ•ˆçš„å•†å“
        var validItemsCount = ProductItems.Count(item => item.SelectedProduct != null);
        if (validItemsCount < 1)
        {
            errors.Add("è‡³å°‘éœ€è¦ä¸€å€‹å•†å“");
        }
          
        if (errors.Any())
        {
            var errorMessage = string.Join("\n", errors);
            await NotificationService.ShowErrorAsync(errorMessage);
            return false;
        }
        
        return true;
    }

    // ===== æ™ºèƒ½ä¸‹å–®åŠŸèƒ½ =====
    
    /// <summary>
    /// è¨ˆç®—å±¬æ€§ï¼šæ˜¯å¦å¯ä»¥ä½¿ç”¨æ™ºèƒ½ä¸‹å–®
    /// </summary>
    private bool CanUseSmartPurchase => 
        SelectedSupplierId.HasValue && 
        SelectedSupplierId.Value > 0 &&
        !HasProductItems &&
        _hasLastPurchaseRecord;
    
    /// <summary>
    /// è¨ˆç®—å±¬æ€§ï¼šæ˜¯å¦æœ‰å•†å“æ˜ç´°é …ç›®
    /// </summary>
    private bool HasProductItems =>
        ProductItems.Any(item => item.SelectedProduct != null);
    
    /// <summary>
    /// æ˜¯å¦æœ‰æ­·å²æ¡è³¼è¨˜éŒ„ï¼ˆå¿«å–ï¼‰
    /// </summary>
    private bool _hasLastPurchaseRecord = false;
    
    /// <summary>
    /// å–å¾—æ™ºèƒ½ä¸‹å–®æŒ‰éˆ•çš„æç¤ºæ–‡å­—
    /// </summary>
    private string GetSmartPurchaseTooltip()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
            return "è«‹å…ˆé¸æ“‡å» å•†";
        
        if (HasProductItems)
            return "ç›®å‰å·²æœ‰æ˜ç´°è³‡æ–™ï¼Œç„¡æ³•ä½¿ç”¨æ™ºèƒ½ä¸‹å–®";
        
        if (!_hasLastPurchaseRecord)
            return "æ­¤å» å•†æ²’æœ‰æ­·å²æ¡è³¼è¨˜éŒ„";
        
        return "è¼‰å…¥è©²å» å•†ä¸Šæ¬¡æ¡è³¼çš„å•†å“æ˜ç´°";
    }

    /// <summary>
    /// æ™ºèƒ½ä¸‹å–®ä¸»è¦æ–¹æ³•
    /// </summary>
    private async Task SmartPurchaseOrder()
    {
        if (!SelectedSupplierId.HasValue || SelectedSupplierId.Value <= 0)
        {
            await NotificationService.ShowWarningAsync("è«‹å…ˆé¸æ“‡å» å•†å¾Œå†ä½¿ç”¨æ™ºèƒ½ä¸‹å–®");
            return;
        }

        try
        {
            // ç²å–è©²å» å•†æœ€è¿‘ä¸€æ¬¡çš„æ¡è³¼è¨˜éŒ„
            var lastPurchaseDetails = await PurchaseOrderDetailService.GetLastCompletePurchaseAsync(SelectedSupplierId.Value);
            
            if (!lastPurchaseDetails.Any())
            {
                await NotificationService.ShowInfoAsync("è©²å» å•†æ²’æœ‰æ­·å²æ¡è³¼è¨˜éŒ„ï¼Œç„¡æ³•ä½¿ç”¨æ™ºèƒ½ä¸‹å–®");
                return;
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰ç¾æœ‰è³‡æ–™
            var hasExistingData = ProductItems.Any(item => item.SelectedProduct != null);
            
            if (hasExistingData)
            {
                // ä½¿ç”¨ç¢ºèªå°è©±æ¡†
                var confirmed = await ShowConfirmationAsync(
                    "æ™ºèƒ½ä¸‹å–®ç¢ºèª", 
                    $"æ­¤æ“ä½œå°‡æ¸…ç©ºç¾æœ‰çš„å•†å“æ˜ç´°ä¸¦è¼‰å…¥ {lastPurchaseDetails.Count} é …ä¸Šæ¬¡æ¡è³¼çš„å•†å“ã€‚\n\næ˜¯å¦ç¹¼çºŒï¼Ÿ"
                );
                
                if (!confirmed) return;
            }

            await LoadLastPurchaseDetailsInternal(lastPurchaseDetails);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æ™ºèƒ½ä¸‹å–®å¤±æ•—ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// é¡¯ç¤ºç¢ºèªå°è©±æ¡†
    /// </summary>
    private async Task<bool> ShowConfirmationAsync(string title, string message)
    {
        // æš«æ™‚ä½¿ç”¨ç°¡å–®çš„é€šçŸ¥ï¼Œç­‰å¾…ç¢ºèªå¾ŒåŸ·è¡Œ
        // åœ¨å¯¦éš›å°ˆæ¡ˆä¸­å¯èƒ½æœƒä½¿ç”¨æ›´ç²¾ç¾çš„å°è©±æ¡†çµ„ä»¶
        try 
        {
            // å…ˆé¡¯ç¤ºè­¦å‘Šè¨Šæ¯ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“å°‡è¦é€²è¡Œçš„æ“ä½œ
            await NotificationService.ShowWarningAsync($"{title}: {message}");
            return true; // æš«æ™‚ç›´æ¥è¿”å› trueï¼Œå¯¦éš›æ‡‰è©²å¯¦ä½œç¢ºèªå°è©±æ¡†
        }
        catch
        {
            return false;
        }
    }

    /// <summary>
    /// å…§éƒ¨æ–¹æ³•ï¼šè¼‰å…¥ä¸Šæ¬¡æ¡è³¼æ˜ç´°
    /// </summary>
    private async Task LoadLastPurchaseDetailsInternal(List<PurchaseOrderDetail> lastPurchaseDetails)
    {
        try
        {
            //  é–‹å§‹è¼‰å…¥è³‡æ–™ - è¨­å®šç‚ºæœªå®Œæˆ
            _dataLoadCompleted = false;
            
            // æ¸…ç©ºç¾æœ‰é …ç›®
            ProductItems.Clear();

            // è¼‰å…¥ä¸Šæ¬¡æ¡è³¼çš„æ‰€æœ‰å•†å“æ˜ç´°
            foreach (var detail in lastPurchaseDetails)
            {
                var productItem = new ProductItem
                {
                    SelectedProduct = detail.Product,
                    SelectedProductId = detail.Product?.Id,  //  åŒæ­¥è¨­å®š ID
                    ProductSearchValue = detail.Product != null ? $"[{detail.Product.Code}] {detail.Product.Name}" : string.Empty,  // è¨­å®šæœå°‹é¡¯ç¤ºå€¼
                    Quantity = detail.OrderQuantity,  // ä½¿ç”¨ä¸Šæ¬¡çš„æ¡è³¼æ•¸é‡
                    Price = detail.UnitPrice,         // ä½¿ç”¨ä¸Šæ¬¡çš„æ¡è³¼å–®åƒ¹
                    TaxRate = detail.TaxRate ?? await SystemParameterService.GetTaxRateAsync(),  // ä½¿ç”¨ä¸Šæ¬¡çš„ç¨…ç‡ï¼Œå¦‚æœç‚º null å‰‡ä½¿ç”¨ç³»çµ±é è¨­
                    ReceivedQuantity = 0,             // æ–°è¨‚å–®çš„å·²æ”¶è²¨æ•¸é‡å¾0é–‹å§‹
                    IsReceivingCompleted = false,     // æ–°è¨‚å–®æœªå®Œæˆæ”¶è²¨
                    Remarks = string.Empty           // å‚™è¨»é‡æ–°é–‹å§‹
                };

                ProductItems.Add(productItem);
            }

            // é€šçŸ¥çˆ¶çµ„ä»¶æ˜ç´°å·²è®Šæ›´
            await NotifyDetailsChanged();
            
            //  è³‡æ–™è¼‰å…¥å®Œæˆ - è§¸ç™¼ç©ºè¡Œæª¢æŸ¥
            _dataLoadCompleted = true;
            StateHasChanged();
            
            await NotificationService.ShowSuccessAsync(
                $"æˆåŠŸè¼‰å…¥ {lastPurchaseDetails.Count} é …ä¸Šæ¬¡æ¡è³¼çš„å•†å“æ˜ç´°"
            );
        }
        catch (Exception ex)
        {
            //  ç™¼ç”ŸéŒ¯èª¤ä¹Ÿè¦æ¢å¾©è¼‰å…¥å®Œæˆç‹€æ…‹
            _dataLoadCompleted = true;
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ä¸Šæ¬¡æ¡è³¼æ˜ç´°å¤±æ•—ï¼š{ex.Message}");
        }
    }

    /// <summary>
    /// æ¸…ç©ºæ‰€æœ‰æ˜ç´°ï¼ˆåƒ…å¾ç•«é¢ç§»é™¤ï¼Œä¸å¾è³‡æ–™åº«åˆªé™¤ï¼‰
    /// </summary>
    private async Task ClearAllDetails()
    {
        if (!ProductItems.Any(item => item.SelectedProduct != null))
        {
            await NotificationService.ShowWarningAsync("ç›®å‰æ²’æœ‰å¯æ¸…é™¤çš„æ˜ç´°");
            return;
        }
        
        // åˆ†é›¢å¯æ¸…é™¤å’Œå·²é–å®šçš„æ˜ç´°
        var validItems = ProductItems.Where(item => item.SelectedProduct != null).ToList();
        var clearableItems = new List<ProductItem>();
        var lockedItems = new List<ProductItem>();
        
        foreach (var item in validItems)
        {
            // æª¢æŸ¥æ˜¯å¦è¢«é–å®šï¼ˆå·²æœ‰é€²è²¨è¨˜éŒ„ï¼‰
            if (!DetailLockHelper.CanDeleteItem(item, out _, checkReceiving: true))
            {
                lockedItems.Add(item);
            }
            else
            {
                clearableItems.Add(item);
            }
        }
        
        if (!clearableItems.Any())
        {
            await NotificationService.ShowWarningAsync("æ‰€æœ‰æ˜ç´°éƒ½å·²è¢«é–å®šï¼ˆå·²æœ‰é€²è²¨è¨˜éŒ„ï¼‰ï¼Œç„¡æ³•æ¸…é™¤");
            return;
        }
        
        // ç›´æ¥æ¸…é™¤å¯æ¸…é™¤çš„æ˜ç´°ï¼Œä¸éœ€è¦ç¢ºèª
        foreach (var item in clearableItems)
        {
            ProductItems.Remove(item);
        }
        
        // é€šçŸ¥è®Šæ›´
        await NotifyDetailsChanged();
        
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
        
        // é¡¯ç¤ºçµæœè¨Šæ¯
        if (lockedItems.Any())
        {
            await NotificationService.ShowSuccessAsync(
                $"å·²æ¸…é™¤ {clearableItems.Count} ç­†æ˜ç´°\n" +
                $"ï¼ˆä¿ç•™ {lockedItems.Count} ç­†å·²è¢«é–å®šçš„æ˜ç´°ï¼‰");
        }
        else
        {
            await NotificationService.ShowSuccessAsync($"å·²æ¸…é™¤ {clearableItems.Count} ç­†æ¡è³¼æ˜ç´°");
        }
    }

    // ===== ç›¸é—œå–®æ“šæŸ¥çœ‹æ–¹æ³• =====
    
    /// <summary>
    /// é¡¯ç¤ºç›¸é—œå–®æ“šï¼ˆå…¥åº«å–®ï¼‰
    /// </summary>
    private async Task ShowRelatedDocuments(ProductItem item)
    {
        if (item.ExistingDetailEntity is not PurchaseOrderDetail detail || detail.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("æ­¤é …ç›®å°šæœªå„²å­˜ï¼Œç„¡æ³•æŸ¥çœ‹ç›¸é—œå–®æ“š", "æç¤º");
            return;
        }

        selectedProductName = item.SelectedProduct?.Name ?? "æœªçŸ¥å•†å“";
        
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsForPurchaseOrderDetailAsync(detail.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ç›¸é—œå–®æ“šå¤±æ•—ï¼š{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// è™•ç†é»æ“Šç›¸é—œå–®æ“šçš„äº‹ä»¶
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // è§¸ç™¼äº‹ä»¶ï¼Œè®“çˆ¶çµ„ä»¶ï¼ˆEditModalï¼‰è™•ç†é–‹å•Ÿç›¸é—œå–®æ“š
        // æ³¨æ„ï¼šä¸é—œé–‰ RelatedDocumentsModalï¼Œè®“ä½¿ç”¨è€…å¯ä»¥ç¹¼çºŒæŸ¥çœ‹åˆ—è¡¨
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            // å¦‚æœçˆ¶çµ„ä»¶æ²’æœ‰è™•ç†ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
            await NotificationService.ShowInfoAsync(
                $"è«‹åœ¨ä¸»ç•«é¢ä¸­é–‹å•Ÿ {document.TypeDisplayName}: {document.DocumentNumber}", 
                "æç¤º"
            );
        }
    }
    
    /// <summary>
    /// æª¢æŸ¥æŒ‡å®šçš„æ¡è³¼è¨‚å–®æ˜ç´°é …ç›®æ˜¯å¦å·²è¢«å…¥åº«å–®ä½¿ç”¨
    /// </summary>
    private async Task<bool> HasUsageRecord(ProductItem item)
    {
        if (item.ExistingDetailEntity is not PurchaseOrderDetail detail || detail.Id <= 0)
        {
            return false;
        }

        try
        {
            var documents = await RelatedDocumentsHelper.GetRelatedDocumentsForPurchaseOrderDetailAsync(detail.Id);
            var hasUsage = documents?.Any() == true;
            return hasUsage;
        }
        catch
        {
            return false;
        }
    }
    
    /// <summary>
    /// å–å¾—ç•¶å‰ä½¿ç”¨è€…ID
    /// </summary>
    private async Task<int?> GetCurrentUserIdAsync()
    {
        return await CurrentUserHelper.GetCurrentEmployeeIdAsync(AuthenticationStateProvider);
    }

    public class ProductItem
    {
        public Product? SelectedProduct { get; set; }
        public int? SelectedProductId { get; set; }  //  ç”¨æ–¼ InteractiveTableComponent Select ç¶å®š
        public int Quantity { get; set; } = 0;
        public int ReceivedQuantity { get; set; } = 0;
        public decimal Price { get; set; } = 0;
        public decimal TaxRate { get; set; } = 0;
        public string Remarks { get; set; } = string.Empty;
        public bool IsReceivingCompleted { get; set; } = false;
        public int? CompletedByEmployeeId { get; set; }
        public DateTime? CompletedAt { get; set; }
        public TDetailEntity? ExistingDetailEntity { get; set; }
        
        // æ¨™è¨˜æ˜¯å¦å·²è¢«å…¥åº«å–®ä½¿ç”¨ï¼ˆé¿å…é‡è¤‡æŸ¥è©¢ï¼‰
        public bool? HasUsageRecordCache { get; set; } = null;
        
        // SearchableSelect æ”¯æ´å±¬æ€§
        public string ProductSearchValue { get; set; } = string.Empty;
        public List<Product> FilteredProducts { get; set; } = new();
        public bool ShowProductDropdown { get; set; } = false;
        public int ProductSelectedIndex { get; set; } = -1;
        
        // è¨ˆç®—å±¬æ€§ï¼šå–®ä½åç¨±ï¼ˆå”¯è®€é¡¯ç¤ºç”¨ï¼‰
        public string UnitName => SelectedProduct?.Unit?.Name ?? string.Empty;
    }
}
