@* 採購退回明細管理組件 - 使用 InteractiveTableComponent 統一UI 並整合自動空行功能 *@

@inject IProductService ProductService
@inject IPurchaseReceivingService PurchaseReceivingService
@inject IPurchaseReturnDetailService PurchaseReturnDetailService
@inject INotificationService NotificationService
@inject RelatedDocumentsHelper RelatedDocumentsHelper
@inject ISystemParameterService SystemParameterService
@inject IJSRuntime JSRuntime

@if (!EffectiveSupplierId.HasValue || EffectiveSupplierId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="supplier-warning">
                <p class="text-muted">選擇廠商後即可查看該廠商的退回商品</p>
            </div>
        </div>
    </div>
}
else
{
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent @ref="tableComponent"
                                      TItem="ReturnItem" 
                                      Items="@ReturnItems"
                                      ColumnDefinitions="@GetColumnDefinitions()"
                                      EnableAutoEmptyRow="true"
                                      AllowAddNewRow="@(!_hasUndeletableDetails && !IsReadOnly)"
                                      DataLoadCompleted="@_dataLoadCompleted"
                                      CreateEmptyItem="@CreateNewEmptyItem"
                                      IsReadOnly="@IsReadOnly"
                                      EmptyMessage="@EmptyMessage"
                                      ShowBuiltInActions="true"
                                      ShowBuiltInDeleteButton="false"
                                      CustomActionsTemplate="@GetCustomActionsTemplate"
                                      ActionsColumnWidth = "60px" />
        </div>

        <div class="card-footer">
            <div class="table-action-bar">
                <div class="btn-group-left">
                    <GenericButtonComponent Text="載入"
                                          Variant="ButtonVariant.DarkBlue"
                                          IsDisabled="@(!CanLoadAllReturnable || _hasUndeletableDetails)"
                                          Title="@GetLoadAllReturnableTooltip()"
                                          OnClick="LoadAllReturnableItems" />
                </div>
                <div class="btn-group-right">
                    <GenericButtonComponent Text="退回全填"
                                          Variant="ButtonVariant.DarkBlue"
                                          IsDisabled="@(!HasReturnItems || IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetFillAllQuantitiesTooltip()"
                                          OnClick="FillAllQuantities" />
                    <GenericButtonComponent Text="退回清空"
                                          Variant="ButtonVariant.Red"
                                          IsDisabled="@(!HasReturnItems || IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetClearAllQuantitiesTooltip()"
                                          OnClick="ClearAllQuantities" />
                    <GenericButtonComponent Text="清除明細"
                                          Variant="ButtonVariant.Red"
                                          IsDisabled="@(!HasReturnItems || IsReadOnly || _hasUndeletableDetails)"
                                          Title="@GetClearAllDetailsTooltip()"
                                          OnClick="ClearAllDetails" />
                </div>
            </div>
        </div>
    </div>
}

<!-- 相關單據查看 Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedProductName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

@code {
    // ===== InteractiveTableComponent 參考 =====
    private InteractiveTableComponent<ReturnItem>? tableComponent;
    
    // ===== 基本參數 =====
    [Parameter] public List<Product> Products { get; set; } = new List<Product>();
    [Parameter] public EventCallback<List<ReturnItem>> OnReturnItemsChanged { get; set; }
    
    // ===== 廠商過濾參數 =====
    [Parameter] public int? SupplierId { get; set; }
    [Parameter] public int? SelectedSupplierId { get; set; }
    
    // ===== 篩選參數 =====
    [Parameter] public int? SelectedPurchaseReceivingId { get; set; }
    [Parameter] public int? FilterProductId { get; set; }
    [Parameter] public int? FilterPurchaseReceivingId { get; set; }
    
    // ===== 現有明細參數 =====
    [Parameter] public List<PurchaseReturnDetail> ExistingReturnDetails { get; set; } = new List<PurchaseReturnDetail>();
    [Parameter] public EventCallback<List<PurchaseReturnDetail>> OnDetailsChanged { get; set; }
    [Parameter] public EventCallback<List<PurchaseReturnDetail>> OnReturnDetailsChanged { get; set; }
    [Parameter] public EventCallback<List<int>> OnDeletedDetailsChanged { get; set; }
    [Parameter] public EventCallback<ReturnItem> OnItemRemoved { get; set; }
    
    /// <summary>
    /// 狀態通知參數 - 通知父組件是否有不可刪除的明細
    /// </summary>
    [Parameter] public EventCallback<bool> OnHasUndeletableDetailsChanged { get; set; }
    
    // ===== 編輯模式參數 =====
    [Parameter] public bool IsEditMode { get; set; } = false;
    
    // ===== 顯示設定 =====
    [Parameter] public string Title { get; set; } = "退回明細";
    [Parameter] public string Subtitle { get; set; } = "";
    [Parameter] public string Icon { get; set; } = "undo";
    [Parameter] public string ItemDisplayName { get; set; } = "商品";
    [Parameter] public string EmptyIcon { get; set; } = "box-open";
    [Parameter] public string EmptyMessage { get; set; } = "尚未新增退回商品";
    
    // ===== 唯讀模式參數 =====
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // ===== 稅別參數 =====
    [Parameter] public TaxCalculationMethod TaxCalculationMethod { get; set; } = TaxCalculationMethod.TaxExclusive;
    
    // ===== 稅別輔助屬性 =====
    private bool IsTaxCalculationMethodNoTax => TaxCalculationMethod == TaxCalculationMethod.NoTax;
    
    // ===== 相關單據開啟事件 =====
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }

    private List<ReturnItem> ReturnItems { get; set; } = new List<ReturnItem>();
    private List<Product> AvailableProducts { get; set; } = new List<Product>();
    private List<PurchaseReceivingDetail> AvailableReceivingDetails { get; set; } = new List<PurchaseReceivingDetail>();
    private int? _previousSelectedSupplierId = null;
    private int? _previousSelectedPurchaseReceivingId = null;
    private int? _previousFilterProductId = null;
    private List<int> _deletedDetailIds { get; set; } = new List<int>();
    
    // ===== 資料載入狀態控制 =====
    private bool _dataLoadCompleted = true;  // 資料載入完成標記
    private bool _hasUndeletableDetails = false;  // 是否有不可刪除的明細(已有沖款記錄)
    
    // ===== 相關單據查看 =====
    private bool showRelatedDocumentsModal = false;
    private string selectedProductName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;

    // ===== 計算屬性 =====
    private int? EffectiveSupplierId => SupplierId ?? SelectedSupplierId;
    private int? EffectivePurchaseReceivingId => FilterPurchaseReceivingId ?? SelectedPurchaseReceivingId;
    private int? EffectiveFilterProductId => FilterProductId;
    private EventCallback<List<PurchaseReturnDetail>> EffectiveDetailsChangedCallback => 
        OnReturnDetailsChanged.HasDelegate ? OnReturnDetailsChanged : OnDetailsChanged;
    
    /// <summary>
    /// 判斷是否可以使用「載入所有可退回」功能
    /// 規則：
    /// 1. 必須選擇廠商
    /// 2. 必須有可載入的進貨明細
    /// 3. 編輯模式下或已有明細時禁用此按鈕（避免覆蓋現有資料）
    /// </summary>
    private bool CanLoadAllReturnable => 
        EffectiveSupplierId.HasValue && 
        EffectiveSupplierId.Value > 0 && 
        GetAvailableReceivingDetails().Any() &&
        !(ExistingReturnDetails?.Any() == true) && // 編輯模式（有現有明細）時禁用
        !ReturnItems.Any(x => x.SelectedReceivingDetail != null); // 已載入明細時禁用
    
    /// <summary>
    /// 取得「載入可退回」按鈕的提示訊息
    /// </summary>
    private string GetLoadAllReturnableTooltip()
    {
        if (!EffectiveSupplierId.HasValue || EffectiveSupplierId.Value <= 0)
            return "請先選擇廠商";
        
        if (!GetAvailableReceivingDetails().Any())
            return "該廠商沒有可退回的進貨明細";
        
        if (ExistingReturnDetails?.Any() == true)
            return "編輯模式下無法載入可退回項目，以避免覆蓋現有資料";
        
        if (ReturnItems.Any(x => x.SelectedReceivingDetail != null))
            return "已有明細項目，無法再次載入以避免覆蓋現有資料";
        
        if (_hasUndeletableDetails)
            return "部分明細已有沖款記錄，無法使用智能載入";
        
        return "載入該廠商所有可退回的進貨明細";
    }
    
    /// <summary>
    /// 檢查是否有被鎖定的明細（有沖款記錄的明細）
    /// </summary>
    private bool HasLockedDetails()
    {
        return ReturnItems.Any(item => 
            item.SelectedReceivingDetail != null && !DetailLockHelper.CanDeleteItem(item.ExistingDetailEntity, out _, checkPayment: true));
    }
    
    /// <summary>
    /// 計算屬性：是否有退回明細項目
    /// </summary>
    private bool HasReturnItems =>
        ReturnItems.Any(item => item.SelectedReceivingDetail != null);
    
    /// <summary>
    /// 取得退回全填按鈕的提示文字
    /// </summary>
    private string GetFillAllQuantitiesTooltip()
    {
        if (!HasReturnItems)
            return "目前無明細可填入";
        
        if (IsReadOnly)
            return "唯讀模式無法使用";
        
        if (_hasUndeletableDetails)
            return "部分明細已有沖款記錄，無法批次填入數量";
        
        return "將所有明細的退回數量填入可退回的最大數量";
    }
    
    /// <summary>
    /// 取得退回清空按鈕的提示文字
    /// </summary>
    private string GetClearAllQuantitiesTooltip()
    {
        if (!HasReturnItems)
            return "目前無明細可清空";
        
        if (IsReadOnly)
            return "唯讀模式無法使用";
        
        if (_hasUndeletableDetails)
            return "部分明細已有沖款記錄，無法批次清空數量";
        
        return "清空所有明細的退回數量";
    }
    
    /// <summary>
    /// 取得清除明細按鈕的提示文字
    /// </summary>
    private string GetClearAllDetailsTooltip()
    {
        if (!HasReturnItems)
            return "目前無明細可清除";
        
        if (IsReadOnly)
            return "唯讀模式無法使用";
        
        if (_hasUndeletableDetails)
            return "部分明細已有沖款記錄，無法清除明細";
        
        return "清空所有退回明細";
    }

    protected override async Task OnInitializedAsync()
    {
        // 初始化時記錄當前廠商ID，避免 OnParametersSetAsync 誤判為變更
        _previousSelectedSupplierId = EffectiveSupplierId;
        _previousSelectedPurchaseReceivingId = EffectivePurchaseReceivingId;
        _previousFilterProductId = EffectiveFilterProductId;
        
        await LoadAvailableProductsAsync();
        await LoadExistingDetailsAsync();
    }

    // ===== 沖款記錄管理方法 =====
    
    /// <summary>
    /// 檢查指定的退回明細項目是否有沖款記錄
    /// 檢查邏輯：
    /// - 資料表：PurchaseReturnDetail
    /// - 欄位：TotalReceivedAmount (累計收款金額)
    /// - 條件：TotalReceivedAmount > 0 表示已有沖款記錄，不可刪除
    /// </summary>
    /// <param name="item">要檢查的退回明細項目</param>
    /// <returns>true 表示有沖款記錄，false 表示沒有</returns>
    private bool HasPaymentRecord(ReturnItem item)
    {
        if (item.ExistingDetailEntity is PurchaseReturnDetail detail && detail.Id > 0)
        {
            // 檢查 TotalReceivedAmount 是否大於 0
            return detail.TotalReceivedAmount > 0;
        }
        return false;
    }
    
    /// <summary>
    /// 取得指定退回明細項目的已收款金額
    /// </summary>
    /// <param name="item">要檢查的退回明細項目</param>
    /// <returns>已收款金額</returns>
    private decimal GetReceivedAmount(ReturnItem item)
    {
        if (item.ExistingDetailEntity is PurchaseReturnDetail detail && detail.Id > 0)
        {
            return detail.TotalReceivedAmount;
        }
        return 0;
    }
    
    /// <summary>
    /// 檢查項目是否可以刪除
    /// 檢查條件：
    /// - 沖款記錄檢查 (HasPaymentRecord)
    ///   - 資料來源：直接讀取 PurchaseReturnDetail 實體
    ///   - 檢查資料表：PurchaseReturnDetail (採購退回明細)
    ///   - 檢查欄位：TotalReceivedAmount (累計收款金額)
    ///   - 限制原因：已收款的退回明細不可刪除，避免財務資料錯亂
    /// </summary>
    /// <param name="item">要檢查的項目</param>
    /// <param name="reason">不可刪除的原因（輸出參數）</param>
    /// <returns>true 表示可以刪除，false 表示不可刪除</returns>
    private bool CanDeleteItem(ReturnItem item, out string reason)
    {
        return DetailLockHelper.CanDeleteItem(
            item.ExistingDetailEntity, 
            out reason, 
            checkPayment: true);
    }

    /// <summary>
    /// 檢查是否有不可刪除的明細（已有沖款記錄）
    /// </summary>
    private bool HasUndeletableDetails()
    {
        return ReturnItems.Any(item => 
            item.SelectedReceivingDetail != null && !CanDeleteItem(item, out _));
    }

    /// <summary>
    /// 通知父組件是否有不可刪除的明細
    /// </summary>
    private async Task NotifyHasUndeletableDetailsChanged()
    {
        if (OnHasUndeletableDetailsChanged.HasDelegate)
        {
            var hasUndeletableDetails = HasUndeletableDetails();
            
            // 狀態變更時才通知父組件並觸發 UI 更新
            if (_hasUndeletableDetails != hasUndeletableDetails)
            {
                _hasUndeletableDetails = hasUndeletableDetails;
                await OnHasUndeletableDetailsChanged.InvokeAsync(hasUndeletableDetails);
                tableComponent?.RefreshEmptyRow();  // 刷新空行狀態
                StateHasChanged();
            }
        }
    }

    /// <summary>
    /// 退回量全填（只處理未鎖定的明細）
    /// </summary>
    private async Task FillAllQuantities()
    {
        var nonEmptyItems = ReturnItems.Where(item => item.SelectedReceivingDetail != null).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("沒有可更新的明細項目", "提示");
            return;
        }
        
        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
        
        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "所有明細都已有沖款記錄，無法批次填入數量", 
                "操作限制");
            return;
        }
        
        foreach (var item in unlocked)
        {
            if (item.SelectedReceivingDetail != null)
            {
                // 退回量設為可退回的最大數量
                var maxReturnQuantity = item.AvailableQuantity;
                item.ReturnQuantity = maxReturnQuantity > 0 ? maxReturnQuantity : 0;
            }
        }
        
        var message = $"已填入 {unlocked.Count} 項明細的退回數量";
        if (locked.Any())
        {
            message += $"\n（已跳過 {locked.Count} 項已鎖定的明細）";
        }
        await NotificationService.ShowSuccessAsync(message);
        
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// 退回量清空（只處理未鎖定的明細）
    /// </summary>
    private async Task ClearAllQuantities()
    {
        var nonEmptyItems = ReturnItems.Where(item => item.SelectedReceivingDetail != null).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("沒有可更新的明細項目", "提示");
            return;
        }
        
        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
        
        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "所有明細都已有沖款記錄，無法批次清空數量", 
                "操作限制");
            return;
        }
        
        foreach (var item in unlocked)
        {
            item.ReturnQuantity = 0;
        }
        
        var message = $"已清空 {unlocked.Count} 項明細的退回數量";
        if (locked.Any())
        {
            message += $"\n（已跳過 {locked.Count} 項已鎖定的明細）";
        }
        await NotificationService.ShowSuccessAsync(message);
        
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// 明細全移除（只移除未鎖定的明細，保留已鎖定的）
    /// </summary>
    private async Task ClearAllDetails()
    {
        var nonEmptyItems = ReturnItems.Where(item => item.SelectedReceivingDetail != null).ToList();
        
        if (!nonEmptyItems.Any())
        {
            await NotificationService.ShowWarningAsync("沒有可移除的明細項目", "提示");
            return;
        }
        
        // 區分可刪除和被鎖定的明細
        var unlocked = nonEmptyItems.Where(item => CanDeleteItem(item, out _)).ToList();
        var locked = nonEmptyItems.Where(item => !CanDeleteItem(item, out _)).ToList();
        
        if (!unlocked.Any())
        {
            await NotificationService.ShowWarningAsync(
                "所有明細都已有沖款記錄，無法移除", 
                "操作限制");
            return;
        }
        
        // 通知父組件項目即將被移除
        if (OnItemRemoved.HasDelegate)
        {
            foreach (var item in unlocked)
            {
                await OnItemRemoved.InvokeAsync(item);
            }
        }
        
        // 記錄所有要刪除的現有明細 ID
        foreach (var item in unlocked.Where(item => item.ExistingDetailEntity?.Id > 0))
        {
            _deletedDetailIds.Add(item.ExistingDetailEntity!.Id);
        }
        
        // 從列表中移除未鎖定的項目，保留已鎖定的項目
        foreach (var item in unlocked)
        {
            ReturnItems.Remove(item);
        }
        
        await NotifyDetailsChanged();
        
        var message = $"已移除 {unlocked.Count} 項明細";
        if (locked.Any())
        {
            message += $"\n（已保留 {locked.Count} 項已鎖定的明細）";
        }
        await NotificationService.ShowSuccessAsync(message);
    }

    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();
        
        // 檢查篩選參數是否變更
        bool supplierChanged = _previousSelectedSupplierId != EffectiveSupplierId;
        bool purchaseReceivingChanged = _previousSelectedPurchaseReceivingId != EffectivePurchaseReceivingId;
        bool productFilterChanged = _previousFilterProductId != EffectiveFilterProductId;
        
        // 如果廠商變更，需要重新載入所有資料
        if (supplierChanged)
        {
            
            _previousSelectedSupplierId = EffectiveSupplierId;
            _previousSelectedPurchaseReceivingId = EffectivePurchaseReceivingId;
            _previousFilterProductId = EffectiveFilterProductId;
            
            await LoadAvailableProductsAsync();
            
            // 廠商變更時清空現有選項並重新載入
            ReturnItems.Clear();
            await LoadExistingDetailsAsync();
            return;
        }
        
        // 如果只是進貨單或商品篩選變更，只需要更新篩選狀態
        // ✅ 篩選邏輯會在 GetAvailableReceivingDetails() 中自動套用，不需要重新載入或渲染
        if (purchaseReceivingChanged || productFilterChanged)
        {
            _previousSelectedPurchaseReceivingId = EffectivePurchaseReceivingId;
            _previousFilterProductId = EffectiveFilterProductId;
            // ✅ 不需要 StateHasChanged()，篩選會在下次渲染時自動生效
            return;
        }
    }

    // ===== InteractiveTableComponent 方法 =====
    
    /// <summary>
    /// 建立新的空項目（用於 InteractiveTableComponent 自動空行功能）
    /// </summary>
    private ReturnItem CreateNewEmptyItem()
    {
        return new ReturnItem();
    }
    
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>();

        // 進貨明細選擇欄位 - 使用 SearchableSelect 類型
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "商品編號/名稱", 
            PropertyName = "ReceivingDetailSearchValue",
            EmptyCheckPropertyName = "SelectedReceivingDetail",
            TriggerEmptyRowOnFilled = true,
            ColumnType = InteractiveColumnType.SearchableSelect,
            Width = "300px",
            Tooltip = "搜尋並選擇要退回的進貨商品。已有沖款記錄的商品將無法變更",
            Placeholder = "請輸入進貨單號或商品名稱",
            SearchValuePropertyName = nameof(ReturnItem.ReceivingDetailSearchValue),
            FilteredItemsPropertyName = nameof(ReturnItem.FilteredReceivingDetails),
            ShowDropdownPropertyName = nameof(ReturnItem.ShowReceivingDetailDropdown),
            SelectedIndexPropertyName = nameof(ReturnItem.ReceivingDetailSelectedIndex),
            ItemDisplayFormatter = (item) =>
            {
                var detail = (PurchaseReceivingDetail)item;
                return FormatReceivingDetailDropdownText(detail);
            },
            IsDisabledFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                return IsReadOnly || HasPaymentRecord(returnItem);
            },
            TooltipFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                var hasPaymentRecord = HasPaymentRecord(returnItem);
                if (!hasPaymentRecord) return null;
                
                return $"此商品已有沖款記錄（已收款 {GetReceivedAmount(returnItem):N0} 元），無法修改商品選擇";
            },
            OnSearchInputChanged = EventCallback.Factory.Create<(object, string?)>(this, (tuple) =>
            {
                var (item, searchValue) = tuple;
                OnReceivingDetailSearchInput((ReturnItem)item, searchValue);
            }),
            OnItemSelected = EventCallback.Factory.Create<(object, object?)>(this, async (tuple) =>
            {
                var (item, selectedItem) = tuple;
                await OnReceivingDetailSelectItem((ReturnItem)item, (PurchaseReceivingDetail?)selectedItem);
            }),
            OnInputFocus = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnReceivingDetailFocus((ReturnItem)item);
            }),
            OnInputBlur = EventCallback.Factory.Create<object>(this, (item) =>
            {
                OnReceivingDetailBlur((ReturnItem)item);
            }),
            EnableKeyboardNavigation = true,
            GetDropdownItems = (item) => ((ReturnItem)item).FilteredReceivingDetails,
            GetSelectedIndex = (item) => ((ReturnItem)item).ReceivingDetailSelectedIndex,
            SetSelectedIndex = (item, index) => ((ReturnItem)item).ReceivingDetailSelectedIndex = index,
            GetShowDropdown = (item) => ((ReturnItem)item).ShowReceivingDetailDropdown,
            SetShowDropdown = (item, show) => ((ReturnItem)item).ShowReceivingDetailDropdown = show,
            MaxDisplayItems = 20
        });

        // 原始進貨數量欄位 (只讀顯示)
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "進貨量", 
            PropertyName = nameof(ReturnItem.OriginalQuantity),
            ColumnType = InteractiveColumnType.Display,
            Width = "120px",
            Tooltip = "當初進貨時的原始數量（唯讀）",
            TextAlign = "right",
            IsReadOnly = true
        });

        // 退回數量欄位
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "退回數量", 
            PropertyName = nameof(ReturnItem.ReturnQuantity),
            ColumnType = InteractiveColumnType.Number,
            Width = "120px",
            Tooltip = "要退回給廠商的商品數量。已收款的商品將無法修改數量",
            IsDisabledFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                return HasPaymentRecord(returnItem);
            },
            TooltipFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                var hasPaymentRecord = HasPaymentRecord(returnItem);
                if (!hasPaymentRecord) return null;
                
                return $"此商品已有沖款記錄（已收款 {GetReceivedAmount(returnItem):N0} 元），無法修改退回數量";
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnReturnQuantityInput((ReturnItem)item, valueString);
            })
        });

        // 單價欄位 (只讀顯示) - 使用智能小數點顯示
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "單價", 
            PropertyName = nameof(ReturnItem.OriginalUnitPrice),
            ColumnType = InteractiveColumnType.Display,
            Width = "100px",
            Tooltip = "商品的原始進貨單價（唯讀）",
            SmartDecimalDisplay = true,  // 整數不顯示小數點，有小數才顯示
            TextAlign = "right",
            IsReadOnly = true
        });

        // 稅率欄位（可編輯）
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "稅率%",
            PropertyName = nameof(ReturnItem.TaxRate),
            ColumnType = InteractiveColumnType.Number,
            Width = "80px",
            Tooltip = "商品的稅率（0% ~ 100%），可手動調整。當主檔選擇免稅時此欄位將被禁用",
            IsDisabledFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                // 當主檔選擇免稅時，禁用稅率欄位；或已有沖款記錄時也禁用
                return IsReadOnly || IsTaxCalculationMethodNoTax || HasPaymentRecord(returnItem);
            },
            TooltipFunc = item =>
            {
                var returnItem = (ReturnItem)item;
                if (IsTaxCalculationMethodNoTax) return "主檔已選擇免稅，此欄位已停用";
                if (HasPaymentRecord(returnItem))
                    return $"此商品已有沖款記錄（已收款 {GetReceivedAmount(returnItem):N0} 元），無法修改稅率";
                return null;
            },
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (item, valueString) = args;
                await OnTaxRateInput((ReturnItem)item, valueString);
            })
        });

        // 小計欄位（根據稅別計算）
        columns.Add(new InteractiveColumnDefinition
        {
            Title = "小計",
            Tooltip = GetSubtotalTooltip(),
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "120px",
            CustomTemplate = item =>
            {
                var returnItem = (ReturnItem)item;
                var subtotal = CalculateItemSubtotal(returnItem);
                var displayValue = NumberFormatHelper.FormatSmartZeroAsEmpty(subtotal);
                return @<div class="text-end fw-bold text-success">@displayValue</div>;
            }
        });

        // 備註欄位
        columns.Add(new InteractiveColumnDefinition
        { 
            Title = "備註", 
            PropertyName = nameof(ReturnItem.Remarks),
            ColumnType = InteractiveColumnType.Input,
            Width = "150px",
            HideOnMobile = true,
            Tooltip = "選填。可記錄退貨相關的備註資訊（如退貨原因等）",
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var returnItem = (ReturnItem)args.Item1;
                await OnRemarksInput(returnItem, args.Item2);
            })
        });

        return columns;
    }

    private RenderFragment<ReturnItem> GetCustomActionsTemplate => item => __builder =>
    {
        // 檢查項目是否可以刪除（綜合退貨記錄和沖款記錄檢查）
        var canDelete = CanDeleteItem(item, out _);
        
        if (canDelete)
        {
            // 可以刪除：顯示刪除按鈕
            <GenericButtonComponent Variant="ButtonVariant.Red"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="@IsReadOnly"
                                   Title="刪除"
                                   OnClick="async () => await HandleItemDelete(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else
        {
            // 不能刪除：顯示查看按鈕
            <GenericButtonComponent Variant="ButtonVariant.Blue"
                                   IconClass="bi bi-eye text-white"
                                   Size="ButtonSize.Large"
                                   Title="查看相關單據"
                                   OnClick="async () => await ShowRelatedDocuments(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
    };

    private async Task HandleItemDelete(ReturnItem item)
    {
        // 使用綜合檢查方法，確認是否可以刪除
        if (!CanDeleteItem(item, out string reason))
        {
            await NotificationService.ShowWarningAsync(
                reason, 
                "操作限制"
            );
            return;
        }
        
        var index = ReturnItems.IndexOf(item);
        await RemoveItemAsync(index);
    }

    /// <summary>
    /// 顯示相關單據（退貨單和沖款單）
    /// </summary>
    private async Task ShowRelatedDocuments(ReturnItem item)
    {
        // 檢查是否有現有的明細實體 ID
        if (item.ExistingDetailEntity is not PurchaseReturnDetail detail || detail.Id <= 0)
        {
            await NotificationService.ShowWarningAsync("此項目尚未儲存，無法查看相關單據", "提示");
            return;
        }

        // 設定商品名稱
        selectedProductName = item.SelectedReceivingDetail?.Product?.Name ?? "未知商品";

        // 顯示 Modal 並開始載入
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();

        try
        {
            // 查詢相關單據
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsForPurchaseReturnDetailAsync(detail.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入相關單據失敗：{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// 處理點擊相關單據的事件
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // 觸發事件，讓父組件（EditModal）處理開啟相關單據
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            // 如果父組件沒有處理，顯示提示訊息
            await NotificationService.ShowInfoAsync(
                $"請在主畫面中開啟 {document.TypeDisplayName}: {document.DocumentNumber}", 
                "提示"
            );
        }
    }

    // ===== 內部方法 =====
    private async Task LoadAvailableProductsAsync()
    {
        try
        {
            if (EffectiveSupplierId.HasValue && EffectiveSupplierId.Value > 0)
            {
                // 載入該廠商的可退貨進貨明細
                AvailableReceivingDetails = await PurchaseReceivingService.GetReturnableDetailsBySupplierAsync(EffectiveSupplierId.Value);
                
                // 從進貨明細中提取商品清單（向下相容）
                AvailableProducts = AvailableReceivingDetails
                    .Where(rd => rd.Product != null)
                    .Select(rd => rd.Product!)
                    .Distinct()
                    .ToList();
            }
            else
            {
                AvailableProducts = new List<Product>();
                AvailableReceivingDetails = new List<PurchaseReceivingDetail>();
            }
        }
        catch (Exception)
        {
            AvailableProducts = new List<Product>();
            AvailableReceivingDetails = new List<PurchaseReceivingDetail>();
        }
    }

    /// <summary>
    /// 公開的刷新方法，用於外部觸發明細刷新（例如：上下筆切換時）
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadExistingDetailsAsync();
        tableComponent?.RefreshEmptyRow();
        StateHasChanged();
    }
    
    private async Task LoadExistingDetailsAsync()
    {
        _dataLoadCompleted = false; // 開始載入數據時禁止自動空行
        
        if (ExistingReturnDetails?.Any() != true) 
        {
            // 通知父組件沒有不可刪除的明細
            await NotifyHasUndeletableDetailsChanged();
            _dataLoadCompleted = true; // 數據載入完成,啟用自動空行
            return;
        }

        ReturnItems.Clear();
        
        // 取得系統預設稅率（用於 fallback）
        var defaultTaxRate = await SystemParameterService.GetTaxRateAsync();
        
        foreach (var detail in ExistingReturnDetails)
        {
            var item = new ReturnItem
            {
                // 使用 Navigation Properties
                SelectedProduct = detail.Product,
                SelectedReceivingDetail = detail.PurchaseReceivingDetail,
                
                // SearchableSelect 顯示值
                ReceivingDetailSearchValue = detail.PurchaseReceivingDetail != null 
                    ? FormatReceivingDetailDisplayText(detail.PurchaseReceivingDetail) 
                    : string.Empty,
                
                // 使用屬性值
                ReturnQuantity = detail.ReturnQuantity,
                OriginalUnitPrice = detail.OriginalUnitPrice,
                // 設定稅率：明細稅率 > 進貨明細稅率 > 商品稅率 > 系統預設稅率
                TaxRate = detail.TaxRate ?? detail.PurchaseReceivingDetail?.TaxRate ?? detail.Product?.TaxRate ?? defaultTaxRate,
                Remarks = detail.Remarks ?? string.Empty,
                BatchNumber = detail.BatchNumber ?? string.Empty,
                ExistingDetailEntity = detail
            };
            
            // 設置原始數量和已退回數量
            if (item.SelectedReceivingDetail != null)
            {
                item.OriginalQuantity = item.SelectedReceivingDetail.ReceivedQuantity;
                // 已退回數量需要從資料庫計算，暫時設為0
                item.AlreadyReturnedQuantity = 0; // TODO: 需要實作計算已退回數量的邏輯
            }
            
            ReturnItems.Add(item);
        }
        
        // 檢查是否有不可刪除的明細
        bool hasUndeletableDetails = ReturnItems.Any(p => !CanDeleteItem(p, out _));
        if (_hasUndeletableDetails != hasUndeletableDetails)
        {
            _hasUndeletableDetails = hasUndeletableDetails;
        }
        
        _dataLoadCompleted = true; // 數據載入完成,啟用自動空行
        tableComponent?.RefreshEmptyRow();
        
        // 通知父組件是否有不可刪除的明細
        await NotifyHasUndeletableDetailsChanged();
    }

    private List<PurchaseReceivingDetail> GetAvailableReceivingDetails()
    {
        var filteredDetails = AvailableReceivingDetails.AsQueryable();
        
        // 根據進貨單篩選
        if (EffectivePurchaseReceivingId.HasValue && EffectivePurchaseReceivingId.Value > 0)
        {
            filteredDetails = filteredDetails.Where(rd => rd.PurchaseReceivingId == EffectivePurchaseReceivingId.Value);
        }
        
        // 根據商品篩選
        if (EffectiveFilterProductId.HasValue && EffectiveFilterProductId.Value > 0)
        {
            filteredDetails = filteredDetails.Where(rd => rd.ProductId == EffectiveFilterProductId.Value);
        }
        
        // 只顯示還有可退回數量的明細 (暫時顯示所有已進貨的明細)
        return filteredDetails.ToList();
    }

    // ===== 事件處理方法 =====
    
    // ===== 進貨明細選擇事件處理 =====
    
    /// <summary>
    /// 格式化進貨明細顯示文字（用於下拉選單 - 兩行顯示）
    /// 第一行：進貨單號 + 可退數量（小字藍色）
    /// 第二行：商品編號 商品名稱
    /// </summary>
    private string FormatReceivingDetailDropdownText(PurchaseReceivingDetail detail)
    {
        if (detail?.Product == null || detail.PurchaseReceiving == null) return "";
        
        var product = detail.Product;
        var receiptNumber = detail.PurchaseReceiving.Code ?? "N/A";
        var returnableQty = detail.RemainingReturnableQuantity;
        
        var productDisplay = !string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name)
            ? $"{product.Code} {product.Name}"
            : (!string.IsNullOrEmpty(product.Code) ? product.Code : product.Name ?? "");
        
        // 兩行顯示：進貨單號在上（小字藍色），商品資訊在下
        return $"<div style='line-height: 1.3;'>" +
               $"<small class='text-primary'>進貨: {receiptNumber} (可退: {returnableQty:G29})</small><br/>" +
               $"<span>{productDisplay}</span></div>";
    }
    
    /// <summary>
    /// 格式化進貨明細顯示文字（用於輸入框顯示 - 單行簡潔格式）
    /// </summary>
    private string FormatReceivingDetailDisplayText(PurchaseReceivingDetail detail)
    {
        if (detail?.Product == null || detail.PurchaseReceiving == null) return "";
        
        var product = detail.Product;
        var receiptNumber = detail.PurchaseReceiving.Code ?? "N/A";
        
        var productDisplay = !string.IsNullOrEmpty(product.Code) && !string.IsNullOrEmpty(product.Name)
            ? $"{product.Code} {product.Name}"
            : (!string.IsNullOrEmpty(product.Code) ? product.Code : product.Name ?? "");
        
        // 輸入框顯示：簡潔的單行格式
        return $"{receiptNumber} | {productDisplay}";
    }

    // ===== 進貨明細選擇事件處理（SearchableSelect）=====

    /// <summary>
    /// 進貨明細搜尋輸入事件
    /// </summary>
    private void OnReceivingDetailSearchInput(ReturnItem item, string? searchValue)
    {
        item.ReceivingDetailSearchValue = searchValue ?? string.Empty;
        
        var availableDetails = GetAvailableReceivingDetails();
        
        // 確保當前選中的明細也在列表中
        if (item.SelectedReceivingDetail != null && 
            !availableDetails.Any(d => d.Id == item.SelectedReceivingDetail.Id))
        {
            availableDetails = new List<PurchaseReceivingDetail>(availableDetails) { item.SelectedReceivingDetail };
        }
        
        if (string.IsNullOrWhiteSpace(searchValue))
        {
            item.FilteredReceivingDetails = availableDetails.Take(20).ToList();
        }
        else
        {
            item.FilteredReceivingDetails = availableDetails
                .Where(d => 
                    (d.PurchaseReceiving?.Code?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (d.Product?.Code?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (d.Product?.Name?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false))
                .Take(20)
                .ToList();
        }
        
        item.ShowReceivingDetailDropdown = true;
        item.ReceivingDetailSelectedIndex = -1;
        // ✅ 移除 StateHasChanged()，InteractiveTableComponent 會自動處理重新渲染
    }
    
    /// <summary>
    /// 進貨明細輸入框獲得焦點
    /// </summary>
    private void OnReceivingDetailFocus(ReturnItem item)
    {
        var availableDetails = GetAvailableReceivingDetails();
        
        // 確保當前選中的明細也在列表中
        if (item.SelectedReceivingDetail != null && 
            !availableDetails.Any(d => d.Id == item.SelectedReceivingDetail.Id))
        {
            availableDetails = new List<PurchaseReceivingDetail>(availableDetails) { item.SelectedReceivingDetail };
        }
        
        item.FilteredReceivingDetails = availableDetails.Take(20).ToList();
        item.ShowReceivingDetailDropdown = true;
        item.ReceivingDetailSelectedIndex = -1;
        // ✅ 移除 StateHasChanged()，InteractiveTableComponent 會自動處理
    }
    
    /// <summary>
    /// 進貨明細輸入框失去焦點
    /// </summary>
    private void OnReceivingDetailBlur(ReturnItem item)
    {
        Task.Delay(200).ContinueWith(_ =>
        {
            item.ShowReceivingDetailDropdown = false;
            InvokeAsync(StateHasChanged);
        });
    }
    
    /// <summary>
    /// 選擇進貨明細項目
    /// </summary>
    private async Task OnReceivingDetailSelectItem(ReturnItem returnItem, PurchaseReceivingDetail? selectedDetail)
    {
        if (selectedDetail == null)
        {
            returnItem.SelectedReceivingDetail = null;
            returnItem.SelectedProduct = null;
            returnItem.ReceivingDetailSearchValue = string.Empty;
            returnItem.OriginalQuantity = 0;
            returnItem.AlreadyReturnedQuantity = 0;
            returnItem.ReturnQuantity = 0;
            returnItem.OriginalUnitPrice = 0;
            returnItem.TaxRate = 0;
            returnItem.ShowReceivingDetailDropdown = false;
            returnItem.ReceivingDetailSelectedIndex = -1;
            await NotifyDetailsChanged();
            return;
        }
        
        returnItem.SelectedReceivingDetail = selectedDetail;
        returnItem.SelectedProduct = selectedDetail.Product;
        returnItem.ReceivingDetailSearchValue = FormatReceivingDetailDisplayText(selectedDetail);
        returnItem.OriginalQuantity = selectedDetail.ReceivedQuantity;
        returnItem.AlreadyReturnedQuantity = 0; // TODO: 需要實作計算已退回數量的邏輯
        returnItem.ReturnQuantity = 0;
        returnItem.OriginalUnitPrice = selectedDetail.UnitPrice;
        // 設定稅率：進貨明細稅率 > 商品稅率 > 系統預設稅率
        returnItem.TaxRate = selectedDetail.TaxRate ?? selectedDetail.Product?.TaxRate ?? await SystemParameterService.GetTaxRateAsync();
        returnItem.ShowReceivingDetailDropdown = false;
        returnItem.ReceivingDetailSelectedIndex = -1;
        
        await NotifyDetailsChanged();
        // ✅ 移除 StateHasChanged()，NotifyDetailsChanged 已經觸發更新，避免重複渲染
    }

    private async Task OnReturnQuantityInput(ReturnItem returnItem, string? value)
    {
        if (int.TryParse(value, out var quantity) && quantity >= 0)
        {
            var maxQuantity = returnItem.OriginalQuantity - returnItem.AlreadyReturnedQuantity;
            returnItem.ReturnQuantity = Math.Min(quantity, maxQuantity);
        }
        else
        {
            returnItem.ReturnQuantity = 0;
        }
        
        await NotifyDetailsChanged();
    }

    private async Task OnRemarksInput(ReturnItem returnItem, string? value)
    {
        returnItem.Remarks = value ?? string.Empty;
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// 處理稅率輸入
    /// </summary>
    private async Task OnTaxRateInput(ReturnItem item, string? valueString)
    {
        if (string.IsNullOrWhiteSpace(valueString))
        {
            item.TaxRate = 0;
        }
        else if (decimal.TryParse(valueString, out var taxRate))
        {
            // 限制範圍 0 ~ 100
            item.TaxRate = Math.Max(0, Math.Min(100, taxRate));
        }
        
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// 計算明細項目的小計（根據稅別，四捨五入到整數）
    /// </summary>
    private decimal CalculateItemSubtotal(ReturnItem item)
    {
        if (item.SelectedReceivingDetail == null || item.ReturnQuantity <= 0 || item.OriginalUnitPrice <= 0)
        {
            return 0;
        }
        
        var subtotal = CalculationHelper.CalculateSubtotal(
            item.ReturnQuantity,
            item.OriginalUnitPrice,
            discountPercentage: 0,
            item.TaxRate,
            TaxCalculationMethod
        );
        
        // 四捨五入到整數
        return CalculationHelper.Round(subtotal, 0);
    }
    
    /// <summary>
    /// 取得小計欄位的提示文字
    /// </summary>
    private string GetSubtotalTooltip()
    {
        return TaxCalculationMethod switch
        {
            TaxCalculationMethod.TaxExclusive => "外加稅：數量 × 單價 × (1 + 稅率%)",
            TaxCalculationMethod.TaxInclusive => "內含稅：數量 × 單價（單價已含稅）",
            TaxCalculationMethod.NoTax => "免稅：數量 × 單價",
            _ => "數量 × 單價"
        };
    }

    /// <summary>
    /// 載入所有可退回商品的主要方法（公開方法，供父組件調用）
    /// </summary>
    public async Task LoadAllReturnableItems()
    {
        try
        {
            var availableDetails = GetAvailableReceivingDetails();
            
            //  檢查是否有可載入的明細
            if (!availableDetails.Any())
            {
                await NotificationService.ShowWarningAsync("沒有可退回的進貨明細", "提示");
                return;
            }
            
            //  確認對話框 - 顯示即將載入的數量
            var confirmed = await NotificationService.ShowConfirmAsync(
                $"即將載入 {availableDetails.Count} 項可退回的進貨明細，是否繼續？\n\n" +
                "提示：如果只需要退回特定商品，建議使用商品篩選功能。",
                "智能退回確認");
            
            if (!confirmed) return;
            
            // 清除現有項目但保留已有資料的項目
            var existingItems = ReturnItems.Where(item => item.SelectedReceivingDetail != null).ToList();
            ReturnItems.Clear();
            ReturnItems.AddRange(existingItems);
            
            // 新增所有可退回的項目
            foreach (var detail in availableDetails)
            {
                // 檢查是否已經存在
                if (ReturnItems.Any(item => item.SelectedReceivingDetail?.Id == detail.Id))
                    continue;
                
                //  取得稅率（優先順序：進貨明細稅率 > 商品稅率 > 系統預設稅率）
                var taxRate = detail.TaxRate ?? detail.Product?.TaxRate ?? await SystemParameterService.GetTaxRateAsync();
                
                var newItem = new ReturnItem
                {
                    SelectedReceivingDetail = detail,
                    SelectedProduct = detail.Product,
                    ReceivingDetailSearchValue = FormatReceivingDetailDisplayText(detail),
                    OriginalQuantity = detail.ReceivedQuantity,
                    AlreadyReturnedQuantity = 0, // TODO: 需要從資料庫計算已退回數量
                    ReturnQuantity = 0,
                    OriginalUnitPrice = detail.UnitPrice,
                    TaxRate = taxRate
                };
                
                ReturnItems.Add(newItem);
            }
            
            await NotifyDetailsChanged();
            await NotificationService.ShowSuccessAsync($"已載入 {availableDetails.Count} 項可退回商品");
            StateHasChanged(); // 強制更新 UI，確保按鈕狀態正確更新
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入可退回商品時發生錯誤：{ex.Message}");
        }
    }

    private async Task RemoveItemAsync(int index)
    {
        if (index >= 0 && index < ReturnItems.Count)
        {
            var itemToRemove = ReturnItems[index];
            
            // 如果被刪除的項目有對應的資料庫實體，記錄其 ID 以便後續刪除
            if (itemToRemove.ExistingDetailEntity?.Id > 0)
            {
                _deletedDetailIds.Add(itemToRemove.ExistingDetailEntity.Id);
            }
            
            // 通知父組件項目即將被移除（讓父組件可以處理實際的資料庫刪除）
            if (OnItemRemoved.HasDelegate)
            {
                await OnItemRemoved.InvokeAsync(itemToRemove);
            }
            
            ReturnItems.RemoveAt(index);
            await NotifyDetailsChanged();
        }
    }

    private async Task NotifyDetailsChanged()
    {
        // 轉換為 PurchaseReturnDetail 實體
        var details = ReturnItems.Where(item => item.SelectedReceivingDetail != null && item.ReturnQuantity > 0)
                                 .Select(ConvertToEntity)
                                 .Where(detail => detail != null)
                                 .Cast<PurchaseReturnDetail>()
                                 .ToList();
        
        if (EffectiveDetailsChangedCallback.HasDelegate)
        {
            await DetailSyncHelper.SyncToParentAsync(details, EffectiveDetailsChangedCallback);
        }
        
        // 通知已刪除的明細 ID
        if (OnDeletedDetailsChanged.HasDelegate && _deletedDetailIds.Any())
        {
            await OnDeletedDetailsChanged.InvokeAsync(_deletedDetailIds.ToList());
            // 清空已通知的刪除 ID，避免重複刪除
            _deletedDetailIds.Clear();
        }
        
        if (OnReturnItemsChanged.HasDelegate)
        {
            await OnReturnItemsChanged.InvokeAsync(ReturnItems);
        }

        // 通知父組件是否有不可刪除的明細
        await NotifyHasUndeletableDetailsChanged();
    }

    private PurchaseReturnDetail? ConvertToEntity(ReturnItem item)
    {
        if (item.SelectedReceivingDetail == null || item.SelectedProduct == null || item.ReturnQuantity <= 0)
        {
            return null;
        }
        
        // 如果已有實體，更新它
        if (item.ExistingDetailEntity != null)
        {
            var existingDetail = item.ExistingDetailEntity;
            existingDetail.ReturnQuantity = item.ReturnQuantity;
            existingDetail.OriginalUnitPrice = item.OriginalUnitPrice;
            existingDetail.TaxRate = item.TaxRate;
            existingDetail.Remarks = item.Remarks;
            existingDetail.BatchNumber = item.BatchNumber;
            existingDetail.PurchaseReceivingDetailId = item.SelectedReceivingDetail.Id;
            existingDetail.ProductId = item.SelectedProduct.Id;
            
            return existingDetail;
        }
        
        // 創建新實體
        return new PurchaseReturnDetail
        {
            ProductId = item.SelectedProduct.Id,
            PurchaseReceivingDetailId = item.SelectedReceivingDetail.Id,
            ReturnQuantity = item.ReturnQuantity,
            OriginalUnitPrice = item.OriginalUnitPrice,
            TaxRate = item.TaxRate,
            Remarks = item.Remarks,
            BatchNumber = item.BatchNumber
        };
    }

    // ===== 公開方法 - 供父組件調用 =====
    public async Task<bool> ValidateAsync()
    {
        try
        {
            // 檢查是否有有效的退回明細
            var validItems = ReturnItems.Where(item => item.SelectedReceivingDetail != null && item.ReturnQuantity > 0).ToList();
            
            if (!validItems.Any())
            {
                await NotificationService.ShowWarningAsync("至少需要一筆有效的退回明細");
                return false;
            }
            
            // 檢查退回數量是否超過可退回數量
            foreach (var item in validItems)
            {
                var maxQuantity = item.OriginalQuantity - item.AlreadyReturnedQuantity;
                if (item.ReturnQuantity > maxQuantity)
                {
                    await NotificationService.ShowErrorAsync($"商品 {item.SelectedProduct?.Name} 的退回數量 ({item.ReturnQuantity}) 超過可退回數量 ({maxQuantity})");
                    return false;
                }
            }
            
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"驗證退回明細時發生錯誤：{ex.Message}");
            return false;
        }
    }
    
    // ===== ReturnItem 內部類別 =====
    public class ReturnItem
    {
        public Product? SelectedProduct { get; set; }
        public PurchaseReceivingDetail? SelectedReceivingDetail { get; set; }
        
        public int OriginalQuantity { get; set; } = 0;
        public int AlreadyReturnedQuantity { get; set; } = 0;
        public int ReturnQuantity { get; set; } = 0;
        
        public decimal OriginalUnitPrice { get; set; } = 0;
        
        public decimal TaxRate { get; set; } = 0;
        
        public string Remarks { get; set; } = string.Empty;
        public string BatchNumber { get; set; } = string.Empty;
        
        public PurchaseReturnDetail? ExistingDetailEntity { get; set; }
        public string? ValidationError { get; set; }
        
        // === SearchableSelect 支援屬性 ===
        public string ReceivingDetailSearchValue { get; set; } = string.Empty;
        public List<PurchaseReceivingDetail> FilteredReceivingDetails { get; set; } = new();
        public bool ShowReceivingDetailDropdown { get; set; } = false;
        public int ReceivingDetailSelectedIndex { get; set; } = -1;
        
        // 計算屬性
        public decimal ReturnSubtotal => ReturnQuantity * OriginalUnitPrice;
        public int AvailableQuantity => OriginalQuantity - AlreadyReturnedQuantity;
        
        /// <summary>
        /// 取得顯示用的商品名稱（包含進貨單號）
        /// </summary>
        public string DisplayName => 
            SelectedReceivingDetail?.Product != null && !string.IsNullOrEmpty(SelectedReceivingDetail.PurchaseReceiving?.Code)
                ? $"[{SelectedReceivingDetail.PurchaseReceiving.Code}] [{SelectedReceivingDetail.Product.Code}] {SelectedReceivingDetail.Product.Name}"
                : SelectedProduct != null 
                    ? $"[{SelectedProduct.Code}] {SelectedProduct.Name}" 
                    : "";
    }
}
