@page "/Error"
@page "/Error/{errorId}"
@attribute [Authorize]
@inject IErrorLogService ErrorLogService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject IStringLocalizer<ERPCore2.SharedResource> L
@rendermode InteractiveServer

<PageTitle>@L["Error.PageTitle"]</PageTitle>

<PagePermissionCheck RequiredPermission="System.Admin">
    <div class="error-page">
        <div class="error-container">
            <div class="error-content">
                <div class="error-icon">
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                </div>
                
                <h2 class="error-title">@L["Error.PageHasError"]</h2>

                <div class="error-message">
                    <p class="lead mb-3">
                        @L["Error.ContactEngineer"]
                    </p>

                    @if (!string.IsNullOrEmpty(userFriendlyMessage))
                    {
                        <div class="alert alert-info">
                            <strong>@L["Error.ErrorMessage"]</strong>@userFriendlyMessage
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(ErrorId))
                    {
                        <div class="alert alert-secondary">
                            <small>
                                <i class="fas fa-code me-1"></i>
                                @L["Error.ErrorId"]@ErrorId
                            </small>
                        </div>
                    }
                </div>

                <div class="error-actions">
                    <button class="btn btn-primary me-2" @onclick="GoBack">
                        <i class="fas fa-arrow-left me-1"></i> @L["Button.GoBack"]
                    </button>
                    <button class="btn btn-secondary me-2" @onclick="GoHome">
                        <i class="fas fa-home me-1"></i> @L["Button.BackToHome"]
                    </button>
                    <button class="btn btn-outline-info" @onclick="ReportError">
                        <i class="fas fa-bug me-1"></i> @L["Error.ReportError"]
                    </button>
                </div>

                @if (showTechnicalDetails)
                {
                    <div class="technical-details mt-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-cogs me-2"></i>@L["Error.TechnicalDetails"]
                                </h6>
                            </div>
                            <div class="card-body">
                                @if (errorLog != null)
                                {
                                    <div class="row">
                                        <div class="col-md-6">
                                            <small class="text-muted">@L["Error.OccurredAt"]</small><br>
                                            <span>@errorLog.OccurredAt.ToString("yyyy/MM/dd HH:mm:ss")</span>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted">@L["Error.ExceptionType"]</small><br>
                                            <span>@(errorLog.ExceptionType ?? L["Error.Unknown"].ToString())</span>
                                        </div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(errorLog.Module))
                                    {
                                        <div class="mt-2">
                                            <small class="text-muted">@L["Error.Module"]</small><br>
                                            <span>@errorLog.Module</span>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                }

                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-secondary" @onclick="ToggleTechnicalDetails">
                        <i class="fas @(showTechnicalDetails ? "fa-eye-slash" : "fa-eye") me-1"></i>
                        @(showTechnicalDetails ? L["Error.HideTechnicalDetails"].ToString() : L["Error.ShowTechnicalDetails"].ToString())
                    </button>
                </div>
            </div>
        </div>
    </div>
</PagePermissionCheck>
@code {
    [Parameter] public string? ErrorId { get; set; }
    
    private string userFriendlyMessage = string.Empty;
    private ErrorLog? errorLog;
    private bool showTechnicalDetails = false;
    
    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(ErrorId))
        {
            await LoadErrorDetails();
        }
        else
        {
            userFriendlyMessage = L["Error.UnknownError"].ToString();
        }
    }

    private async Task LoadErrorDetails()
    {
        try
        {
            errorLog = await ErrorLogService.GetByErrorIdAsync(ErrorId!);
            userFriendlyMessage = TranslateToUserFriendlyMessage(errorLog?.Message);
        }
        catch
        {
            userFriendlyMessage = L["Error.UnknownError"].ToString();
        }
    }

    private string TranslateToUserFriendlyMessage(string? errorMessage)
    {
        if (string.IsNullOrEmpty(errorMessage)) return L["Error.UnknownError"].ToString();

        // 根據錯誤訊息內容返回友善訊息
        var message = errorMessage.ToLowerInvariant();

        return message switch
        {
            var msg when msg.Contains("timeout") || msg.Contains("逾時") => L["Error.MsgTimeout"].ToString(),
            var msg when msg.Contains("connection") || msg.Contains("連線") => L["Error.MsgConnection"].ToString(),
            var msg when msg.Contains("unauthorized") || msg.Contains("權限") => L["Error.MsgUnauthorized"].ToString(),
            var msg when msg.Contains("validation") || msg.Contains("驗證") => L["Error.MsgValidation"].ToString(),
            var msg when msg.Contains("file") || msg.Contains("檔案") => L["Error.MsgFile"].ToString(),
            var msg when msg.Contains("memory") || msg.Contains("記憶體") => L["Error.MsgMemory"].ToString(),
            var msg when msg.Contains("sql") || msg.Contains("database") => L["Error.MsgDatabase"].ToString(),
            _ => L["Error.MsgGeneral"].ToString()
        };
    }
    
    private async Task GoBack()
    {
        await JSRuntime.InvokeVoidAsync("history.back");
    }
    
    private void GoHome()
    {
        Navigation.NavigateTo("/");
    }
    
    private async Task ReportError()
    {
        // 這裡可以實作錯誤回報功能
        // 例如發送郵件、建立工單等
        await JSRuntime.InvokeVoidAsync("alert", L["Error.ReportThankYou"].ToString());
    }
    
    private void ToggleTechnicalDetails()
    {
        showTechnicalDetails = !showTechnicalDetails;
    }
}
