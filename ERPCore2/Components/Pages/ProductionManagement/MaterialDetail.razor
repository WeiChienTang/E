@page "/materials/detail/{materialId:int}"

@inject IMaterialService MaterialService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer


<GenericDetailPageComponent TEntity="Material" 
                           TService="IMaterialService"
                           EntityId="@MaterialId"
                           Entity="@material"
                           Service="@MaterialService"
                           EntityName="材質"
                           EntityNamePlural="材質"
                           IndexRoute="/materials"
                           EditRoute="/materials/edit"
                           LoadingText="載入材質資料中..."
                           BreadcrumbItems="@breadcrumbItems"
                           DataLoader="@LoadMaterialDataAsync"
                           AdditionalDataLoader="@LoadAdditionalDataAsync"
                           EntityTitleSelector="@(m => m.Name)"
                           EntitySubtitleSelector="@(m => $"材質代碼：{m.Code ?? "未設定"}")"
                           EntityDisplayNameSelector="@(m => m.Name)"
                           OnDataLoaded="@OnMaterialDataLoaded"
                           UseTabLayout="true"
                           TabSections="@GetTabSections()" RequiredPermission="Material.Read">
</GenericDetailPageComponent>

@code {
    [Parameter] public int MaterialId { get; set; }

    private Material? material;
    private bool _isLoading = false;

    // 麵包屑導航
    private List<GenericHeaderComponent.BreadcrumbItem> breadcrumbItems = new()
    {
        new("首頁", "/"),
        new("基礎資料", "#"),
        new("材質管理", "/materials"),
        new("材質詳細資料")
    };

    // GenericDetailPageComponent 需要的方法
    private async Task<Material?> LoadMaterialDataAsync()
    {
        if (_isLoading)
        {
            return material;
        }
        
        try
        {
            _isLoading = true;
            if (MaterialId <= 0) return null;
            
            var result = await MaterialService.GetByIdAsync(MaterialId);
            material = result;
            return result;
        }
        catch (Exception ex)
        {
            _ = ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadMaterialDataAsync), GetType(),
                additionalData: $"MaterialId: {MaterialId}");
            throw;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private Task LoadAdditionalDataAsync()
    {
        try
        {
            return Task.CompletedTask;
        }
        catch (Exception ex)
        {
            _ = ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadAdditionalDataAsync), GetType());
            throw;
        }
    }

    private Task OnMaterialDataLoaded()
    {
        try
        {
            StateHasChanged();
            return Task.CompletedTask;
        }
        catch (Exception ex)
        {
            _ = ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(OnMaterialDataLoaded), GetType());
            throw;
        }
    }

    // 設定標籤頁結構
    private List<GenericDetailPageComponent<Material, IMaterialService
                        >.TabSection> GetTabSections()
    {
        try
        {
            // 先定義點擊處理器
            EventCallback<int> productClickHandler = EventCallback.Factory.Create<int>(this, OnProductCardClick);
            
            return new List<GenericDetailPageComponent<Material, IMaterialService
                        >.TabSection>
            {           
                new GenericDetailPageComponent<Material, IMaterialService>.TabSection
                {
                    Id = "basic",
                    Title = "基本資料",
                    Content = @<div>
                        <BasicInfoDisplayComponent 
                            Title="材質基本資訊"
                            IconClass="fas fa-cube"
                            IconColor="text-primary"
                            Fields="@GetMaterialBasicFields()" />
                    </div>
                },            
                new GenericDetailPageComponent<Material, IMaterialService>.TabSection
                {
                    Id = "system",
                    Title = "系統資訊",
                    Content = @<div>
                        <SystemInfoDisplayComponent 
                            CreatedAt="@(material?.CreatedAt ?? DateTime.MinValue)"
                            UpdatedAt="@material?.UpdatedAt"
                            CreatedBy="@material?.CreatedBy"
                            UpdatedBy="@material?.UpdatedBy"
                            Remarks="@material?.Remarks"
                            ShowTimeline="true"
                            ShowRemarks="true" />
                    </div>
                }        
            };
        }
        catch (Exception ex)
        {
            _ = ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetTabSections), GetType(),
                additionalData: new { MaterialId });
            throw;
        }
    }

    // 導航到供應商詳細頁面
    private void NavigateToSupplierDetail(int supplierId)
    {
        try
        {
            Navigation.NavigateTo($"/suppliers/detail/{supplierId}");
        }
        catch (Exception ex)
        {
            _ = ErrorHandlingHelper.HandlePageErrorAsync(
                ex,
                nameof(NavigateToSupplierDetail),
                GetType(),
                additionalData: new { SupplierId = supplierId, PageName = "MaterialDetail" });
        }
    }

    // 處理商品卡片點擊事件
    private async Task OnProductCardClick(int productId)
    {
        try
        {
            Navigation.NavigateTo($"/products/detail/{productId}");
            await Task.CompletedTask;
        }
        catch (Exception ex)
        {
            _ = ErrorHandlingHelper.HandlePageErrorAsync(
                ex, 
                nameof(OnProductCardClick),
                GetType(),
                additionalData: new { ProductId = productId, MaterialId }
            );
        }
    }

    // 取得材質基本資料欄位
    private IEnumerable<BasicInfoDisplayComponent.BasicInfoField> GetMaterialBasicFields()
    {
        try
        {
            return new List<BasicInfoDisplayComponent.BasicInfoField>
            {
                new()
                {
                    Label = "材質代碼",
                    Value = material?.Code,
                    IsPrimary = true,
                    ValueBold = true,
                    EmptyText = "未設定",
                    IconClass = "fas fa-barcode",
                    IconBgClass = "bg-primary bg-opacity-10",
                    IconTextClass = "text-primary"
                },
                new()
                {
                    Label = "材質名稱",
                    Value = material?.Name,
                    ValueBold = true,
                    IconClass = "fas fa-cube",
                    IconBgClass = "bg-info bg-opacity-10",
                    IconTextClass = "text-info"
                },
                new()
                {
                    Label = "描述",
                    Value = material?.Description,
                    Format = BasicInfoDisplayComponent.FieldFormat.MultiLine,
                    IconClass = "fas fa-align-left",
                    IconBgClass = "bg-secondary bg-opacity-10",
                    IconTextClass = "text-secondary",
                    ColSize = 12,
                    VisibilityCondition = () => !string.IsNullOrEmpty(material?.Description)
                },
                new()
                {
                    Label = "備註",
                    Value = material?.Remarks,
                    Format = BasicInfoDisplayComponent.FieldFormat.MultiLine,
                    IconClass = "fas fa-sticky-note",
                    IconBgClass = "bg-warning bg-opacity-10",
                    IconTextClass = "text-warning",
                    ColSize = 12,
                    VisibilityCondition = () => !string.IsNullOrEmpty(material?.Remarks)
                }
            };
        }
        catch (Exception ex)
        {
            _ = ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(GetMaterialBasicFields), GetType());
            throw;
        }
    }
}