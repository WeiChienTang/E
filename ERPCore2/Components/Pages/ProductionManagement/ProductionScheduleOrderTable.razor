@* 待排程訂單表格 - 左側顯示可選擇的訂單列表 *@
@using ERPCore2.Components.Shared.UI.Button
@using ERPCore2.Components.Shared.Base
@using ERPCore2.Helpers.InteractiveTableComponentHelper
@using ERPCore2.Models
@using ERPCore2.Helpers

<div class="card h-100">
    <div class="card-header bg-primary text-white py-2">
        <div class="d-flex justify-content-between align-items-center">
            <span class="fw-bold"><i class="bi bi-list-task me-2"></i>待排程訂單</span>
        </div>
    </div>
    
    <div class="card-body p-2">        
        @* 訂單列表 - 使用 InteractiveTableComponent *@
        <div style="max-height: 400px; overflow-y: auto;">
            <InteractiveTableComponent TItem="PendingScheduleOrderDto"
                                       Items="@FilteredOrdersList"
                                       ColumnDefinitions="@GetColumnDefinitions()"
                                       ShowHeader="true"
                                       ShowActions="false"
                                       ShowRowNumbers="false"
                                       IsStriped="true"
                                       IsHoverable="true"
                                       IsBordered="true"
                                       EmptyMessage="@GetEmptyMessage()"
                                       EnableRowClick="true"
                                       OnRowClick="HandleRowClick"
                                       RowClickCursor="pointer"
                                       EnableDrag="true"
                                       DragDropGroup="production-schedule"
                                       TableId="order-table"
                                       OnDragStart="HandleDragStart"
                                       CssClass="mb-0 table-sm" />
        </div>
    </div>
</div>

@code {
    // ===== 參數 =====
    
    /// <summary>
    /// 待排程訂單列表
    /// </summary>
    [Parameter] public List<PendingScheduleOrderDto> Orders { get; set; } = new();
    
    /// <summary>
    /// 可用客戶列表（篩選用）
    /// </summary>
    [Parameter] public List<Customer> AvailableCustomers { get; set; } = new();
    
    /// <summary>
    /// 是否正在載入
    /// </summary>
    [Parameter] public bool IsLoading { get; set; }
    
    /// <summary>
    /// 當選擇訂單時觸發（開啟明細選擇彈窗）
    /// </summary>
    [Parameter] public EventCallback<PendingScheduleOrderDto> OnOrderSelected { get; set; }
    
    /// <summary>
    /// 當需要重新載入資料時觸發
    /// </summary>
    [Parameter] public EventCallback OnRefreshRequested { get; set; }
    
    // ===== 內部狀態 =====
    private int? selectedCustomerId;
    private string searchKeyword = string.Empty;
    
    /// <summary>
    /// 篩選後的訂單列表（轉為 List 供 InteractiveTableComponent 使用）
    /// </summary>
    private List<PendingScheduleOrderDto> FilteredOrdersList
    {
        get
        {
            var result = Orders.AsEnumerable();
            
            // 客戶篩選
            if (selectedCustomerId.HasValue)
            {
                result = result.Where(o => o.CustomerId == selectedCustomerId.Value);
            }
            
            // 關鍵字搜尋
            if (!string.IsNullOrWhiteSpace(searchKeyword))
            {
                var keyword = searchKeyword.Trim().ToLower();
                result = result.Where(o => 
                    o.OrderCode.ToLower().Contains(keyword) ||
                    o.CustomerName.ToLower().Contains(keyword));
            }
            
            return result.OrderByDescending(o => o.OrderDate).ToList();
        }
    }
    
    // ===== 表格欄位定義 =====
    
    private List<InteractiveColumnDefinition> GetColumnDefinitions()
    {
        return new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = "訂單編號",
                PropertyName = nameof(PendingScheduleOrderDto.OrderCode),
                ColumnType = InteractiveColumnType.Display,
                Width = "30%",
                CellCssClass = "text-primary fw-bold small"
            },
            new()
            {
                Title = "日期",
                PropertyName = nameof(PendingScheduleOrderDto.OrderDate),
                ColumnType = InteractiveColumnType.Custom,
                Width = "15%",
                CustomTemplate = item =>
                {
                    var order = (PendingScheduleOrderDto)item;
                    return @<small class="text-muted">@order.OrderDate.ToString("MM/dd")</small>;
                }
            },
            new()
            {
                Title = "客戶",
                PropertyName = nameof(PendingScheduleOrderDto.CustomerName),
                ColumnType = InteractiveColumnType.Custom,
                Width = "35%",
                CustomTemplate = item =>
                {
                    var order = (PendingScheduleOrderDto)item;
                    return @<small>@order.CustomerName</small>;
                }
            },
            new()
            {
                Title = "待排明細",
                PropertyName = nameof(PendingScheduleOrderDto.PendingItemCount),
                ColumnType = InteractiveColumnType.Custom,
                Width = "20%",
                TextAlign = "center",
                CustomTemplate = item =>
                {
                    var order = (PendingScheduleOrderDto)item;
                    var pendingCount = order.Details?.Count(d => d.PendingQuantity > 0) ?? order.PendingItemCount;
                    return @<span class="badge bg-warning text-dark">@pendingCount 項</span>;
                }
            }
        };
    }
    
    private string GetEmptyMessage()
    {
        return IsLoading ? "載入中..." : "沒有待排程的訂單";
    }
    
    // ===== 事件處理 =====
    
    private async Task OnSelectOrder(PendingScheduleOrderDto order)
    {
        if (OnOrderSelected.HasDelegate)
        {
            await OnOrderSelected.InvokeAsync(order);
        }
    }
    
    private void OnFilterChanged()
    {
        // 篩選條件變更時自動更新 UI（透過 FilteredOrdersList 計算屬性）
        StateHasChanged();
    }
    
    private async Task RefreshData()
    {
        if (OnRefreshRequested.HasDelegate)
        {
            await OnRefreshRequested.InvokeAsync();
        }
    }
    
    // ===== 公開方法 =====
    
    /// <summary>
    /// 設定客戶篩選（供外部呼叫）
    /// </summary>
    public void SetCustomerFilter(int? customerId)
    {
        selectedCustomerId = customerId;
        StateHasChanged();
    }
    
    /// <summary>
    /// 清除篩選條件
    /// </summary>
    public void ClearFilters()
    {
        selectedCustomerId = null;
        searchKeyword = string.Empty;
        StateHasChanged();
    }
    
    // ===== 拖放事件處理 =====
    
    private void HandleDragStart(PendingScheduleOrderDto order)
    {
        // 拖曳開始時的處理（如需要可在此加入額外邏輯）
        // DragDropState 已由 InteractiveTableComponent 自動設定
    }
    
    // ===== 行點擊事件處理 =====
    
    /// <summary>
    /// 處理行點擊事件 - 直接開啟明細選擇彈窗
    /// </summary>
    private async Task HandleRowClick(PendingScheduleOrderDto order)
    {
        Console.WriteLine($"[DEBUG] ProductionScheduleOrderTable.HandleRowClick called, order: {order.OrderCode}");
        
        if (OnOrderSelected.HasDelegate)
        {
            Console.WriteLine("[DEBUG] Invoking OnOrderSelected");
            await OnOrderSelected.InvokeAsync(order);
        }
        else
        {
            Console.WriteLine("[DEBUG] OnOrderSelected.HasDelegate is false!");
        }
    }
}
