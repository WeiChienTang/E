@* 可重用的生產排程編輯組件 - 雙表格設計（左側訂單、右側排程項目）*@
@using ERPCore2.Components.Shared.UI.Button
@using ERPCore2.Components.Shared.Base
@using ERPCore2.Helpers.InteractiveTableComponentHelper
@using ERPCore2.Data.Enums
@using ERPCore2.Models
@inject IProductionScheduleService ProductionScheduleService
@inject IProductionScheduleItemService ProductionScheduleItemService
@inject ICustomerService CustomerService
@inject IEmployeeService EmployeeService
@inject IProductService ProductService
@inject ISalesOrderService SalesOrderService
@inject ISalesOrderDetailService SalesOrderDetailService
@inject INotificationService NotificationService

<GenericEditModalComponent TEntity="ProductionSchedule" 
                          TService="IProductionScheduleService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@ProductionScheduleId"
                          Service="@ProductionScheduleService"
                          EntityName="生產排程"
                          EntityNamePlural="生產排程"
                          ModalTitle="@(ProductionScheduleId.HasValue ? "編輯生產排程" : "新增生產排程")"
                          Size="GenericEditModalComponent<ProductionSchedule, IProductionScheduleService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@autoCompleteConfig?.Prefillers"
                          AutoCompleteCollections="@autoCompleteConfig?.Collections"
                          AutoCompleteDisplayProperties="@autoCompleteConfig?.DisplayProperties"
                          AutoCompleteValueProperties="@autoCompleteConfig?.ValueProperties"
                          DataLoader="@LoadProductionScheduleData"
                          UseGenericSave="true"
                          SaveSuccessMessage="@(ProductionScheduleId.HasValue ? "生產排程更新成功" : "生產排程新增成功")"
                          SaveFailureMessage="生產排程儲存失敗"
                          RequiredPermission="ProductionSchedule.Read"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnEntityLoaded="@HandleEntityLoaded"
                          CustomModules="@GetCustomModules()" />

@* 排程項目編輯 Modal *@
<ProductionScheduleItemEditModal IsVisible="@showScheduleItemModal"
                                 IsVisibleChanged="@((bool visible) => showScheduleItemModal = visible)"
                                 ProductionScheduleItemId="@selectedScheduleItemId"
                                 IsReadOnly="@IsReadOnly"
                                 OnSaved="@HandleScheduleItemSaved"
                                 OnCancel="@(() => showScheduleItemModal = false)" />

@* 明細選擇彈窗 *@
<ProductionScheduleDetailSelectorModal IsVisible="@showDetailSelectorModal"
                                       OrderInfo="@selectedOrderForDetails"
                                       Details="@pendingDetails"
                                       OnConfirmed="@HandleDetailSelectionConfirmed"
                                       OnCancelled="@HandleDetailSelectorCancelled" />

@code {
    // ===== 參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? ProductionScheduleId { get; set; }
    [Parameter] public EventCallback<ProductionSchedule> OnProductionScheduleSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public Dictionary<string, object?>? PrefilledValues { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;

    // ===== 內部狀態 =====
    private GenericEditModalComponent<ProductionSchedule, IProductionScheduleService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    private List<Customer> availableCustomers = new();
    private List<Employee> availableEmployees = new();
    private List<Product> availableProducts = new();
    private List<SalesOrder> availableSalesOrders = new();
    
    // AutoComplete 配置
    private AutoCompleteConfig? autoCompleteConfig;
    
    // ===== 排程項目相關 =====
    private List<ProductionScheduleItem> scheduleItems = new();
    private bool showScheduleItemModal = false;
    private int? selectedScheduleItemId = null;
    
    // ===== 雙表格設計相關 =====
    private List<PendingScheduleOrderDto> pendingOrders = new();
    private List<ScheduleItemDto> currentScheduleItems = new();
    private bool showDetailSelectorModal = false;
    private PendingScheduleOrderDto? selectedOrderForDetails = null;
    private List<PendingScheduleDetailDto> pendingDetails = new();
    
    // 資料載入狀態標記
    private bool isDataLoaded = false;

    // ===== 生命週期 =====
    
    /// <summary>
    /// 處理實體載入完成事件（由 GenericEditModalComponent 的導航觸發）
    /// 當上下筆切換時觸發 UI 更新，確保表單欄位正確渲染
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            // 載入排程項目
            await LoadScheduleItemsAsync(loadedEntityId);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入資料時發生錯誤：{ex.Message}");
        }
    }
    
    private async Task LoadScheduleItemsAsync(int scheduleId)
    {
        try
        {
            scheduleItems = await ProductionScheduleItemService.GetByScheduleIdAsync(scheduleId);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入排程項目失敗: {ex.Message}");
            scheduleItems = new();
        }
    }

    // ===== 事件處理 =====
    private async Task HandleSaveSuccess()
    {
        try
        {
            // 如果父組件需要知道排程已儲存
            if (OnProductionScheduleSaved.HasDelegate && editModalComponent?.Entity != null)
            {
                await OnProductionScheduleSaved.InvokeAsync(editModalComponent.Entity);
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理儲存成功事件時發生錯誤：{ex.Message}");
        }
    }

    private async Task HandleCancel()
    {
        try
        {
            if (OnCancel.HasDelegate)
            {
                await OnCancel.InvokeAsync();
            }

            await CloseModal();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"處理取消事件時發生錯誤：{ex.Message}");
        }
    }

    private async Task CloseModal()
    {
        if (IsVisibleChanged.HasDelegate)
        {
            await IsVisibleChanged.InvokeAsync(false);
        }
    }

    // ===== 資料載入 =====
    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // 載入客戶列表
            availableCustomers = await CustomerService.GetAllAsync();
            
            // 載入員工列表（排除超級管理員）
            var allEmployees = await EmployeeService.GetAllAsync();
            availableEmployees = allEmployees.Where(e => !e.IsSuperAdmin).ToList();
            
            // 載入商品列表（用於顯示排程項目）
            availableProducts = await ProductService.GetAllAsync();
            
            // 載入銷貨訂單列表
            availableSalesOrders = await SalesOrderService.GetAllAsync();
            
            // 建立 AutoComplete 配置
            autoCompleteConfig = new AutoCompleteConfigBuilder<ProductionSchedule>()
                .AddField(nameof(ProductionSchedule.CustomerId), "CompanyName", availableCustomers)
                .AddField(nameof(ProductionSchedule.CreatedByEmployeeId), "Name", availableEmployees)
                .AddField(nameof(ProductionSchedule.SalesOrderId), "Code", availableSalesOrders)
                .Build();
            
            // 載入待排程訂單列表（雙表格設計）
            await LoadPendingOrdersAsync();
            
            // 初始化當前排程項目列表
            currentScheduleItems = new List<ScheduleItemDto>();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入相關資料時發生錯誤：{ex.Message}");
            availableCustomers = new List<Customer>();
            availableEmployees = new List<Employee>();
            availableProducts = new List<Product>();
            availableSalesOrders = new List<SalesOrder>();
            pendingOrders = new List<PendingScheduleOrderDto>();
            currentScheduleItems = new List<ScheduleItemDto>();
        }
    }

    private async Task<ProductionSchedule?> LoadProductionScheduleData()
    {
        try
        {
            if (!ProductionScheduleId.HasValue) 
            {
                // 新增模式：建立新的排程實體並生成編號
                var newSchedule = new ProductionSchedule
                {
                    Code = await EntityCodeGenerationHelper.GenerateForEntity<ProductionSchedule, IProductionScheduleService>(ProductionScheduleService, "PS"),
                    ScheduleDate = DateTime.Today,
                    Status = EntityStatus.Active
                };
                
                // 應用預填值
                PrefilledValueHelper.ApplyPrefilledValues(newSchedule, PrefilledValues);
                
                return newSchedule;
            }

            var schedule = await ProductionScheduleService.GetByIdAsync(ProductionScheduleId.Value);            
            
            if (schedule == null)
            {
                // 如果找不到排程，建立新的預設排程
                return new ProductionSchedule
                {
                    ScheduleDate = DateTime.Today,
                    Status = EntityStatus.Active
                };
            }
            return schedule;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入生產排程資料時發生錯誤：{ex.Message}");
            
            // 設定安全的預設值，確保程式不會崩潰
            return new ProductionSchedule
            {
                Code = "ERROR",
                ScheduleDate = DateTime.Today,
                Status = EntityStatus.Active
            };
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && !isDataLoaded)
        {
            // 先載入資料（包含 AutoComplete 配置）
            await LoadAdditionalDataAsync();
            // 再初始化表單欄位
            InitializeFormFields();
            isDataLoaded = true;
            
            // 如果是編輯模式且有 ProductionScheduleId，載入排程項目
            if (ProductionScheduleId.HasValue)
            {
                await LoadScheduleItemsAsync(ProductionScheduleId.Value);
            }
            else
            {
                // 新增模式時清空列表
                scheduleItems = new();
            }
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
        }
    }

    // ===== 表單初始化 =====
    private void InitializeFormFields()
    {
        try
        {
            formFields = new List<FormFieldDefinition>
            {
                // 基本資訊區段
                new()
                {
                    PropertyName = nameof(ProductionSchedule.Code),
                    Label = "排程編號",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入排程編號",
                    IsRequired = true,
                    HelpText = "排程的唯一識別編號，新增時系統會自動產生，也可手動修改"
                },
                new()
                {
                    PropertyName = nameof(ProductionSchedule.ScheduleDate),
                    Label = "排程日期",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "排程建立日期"
                },
                new()
                {
                    PropertyName = nameof(ProductionSchedule.CustomerId),
                    Label = "客戶",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇客戶",
                    MinSearchLength = 0,
                    HelpText = "輸入客戶名稱進行搜尋，或直接選擇（可選）"
                },
                new()
                {
                    PropertyName = nameof(ProductionSchedule.CreatedByEmployeeId),
                    Label = "製單人員",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇製單人員",
                    MinSearchLength = 0,
                    HelpText = "輸入員工名稱進行搜尋，或直接選擇"
                },
                
                // 來源資訊區段
                new()
                {
                    PropertyName = nameof(ProductionSchedule.SalesOrderId),
                    Label = "訂單編號",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入訂單編號進行搜尋",
                    MinSearchLength = 0,
                    HelpText = "輸入銷貨訂單編號進行搜尋，選擇來源訂單（可選）"
                },

                FormFieldConfigurationHelper.CreateRemarksField<ProductionSchedule>()
            };

            formSections = FormSectionHelper<ProductionSchedule>.Create()
                .AddToSection(FormSectionNames.BasicInfo,
                    ps => ps.Code,
                    ps => ps.ScheduleDate,
                    ps => ps.CustomerId,
                    ps => ps.CreatedByEmployeeId,
                    ps => ps.SalesOrderId)
                .AddToSection(FormSectionNames.AdditionalData,
                    ps => ps.Remarks)
                .Build();
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("初始化表單欄位時發生錯誤");
        }
    }

    // ===== 自訂模組 =====
    private List<GenericEditModalComponent<ProductionSchedule, IProductionScheduleService>.CustomModule> GetCustomModules()
    {
        try
        {
            return new List<GenericEditModalComponent<ProductionSchedule, IProductionScheduleService>.CustomModule>
            {
                new GenericEditModalComponent<ProductionSchedule, IProductionScheduleService>.CustomModule
                {
                    Title = "",
                    Content = CreateScheduleItemsContent(),
                    Order = 1
                }
            };
        }
        catch
        {
            return new List<GenericEditModalComponent<ProductionSchedule, IProductionScheduleService>.CustomModule>();
        }
    }

    /// <summary>
    /// 創建排程項目列表內容 - 雙表格設計
    /// </summary>
    private RenderFragment CreateScheduleItemsContent() => __builder =>
    {
        <div class="row mt-3">
            @* 左側：待排程訂單表格 *@
            <div class="col-md-6">
                <ProductionScheduleOrderTable Orders="@pendingOrders"
                                              OnOrderSelected="@HandleOrderSelected"
                                              OnRefreshRequested="@HandleRefreshPendingOrders" />
            </div>
            
            @* 右側：排程項目表格 *@
            <div class="col-md-6">
                <ProductionScheduleItemTable Items="@currentScheduleItems"
                                             IsReadOnly="@IsReadOnly"
                                             OnItemRemoved="@HandleScheduleItemRemoved"
                                             OnQuantityChanged="@HandleScheduleItemQuantityChanged"
                                             OnOrderDropped="@HandleOrderDropped" />
            </div>
        </div>
        
        @* 保留原有的詳細表格供查看已儲存的項目 *@
        @if (ProductionScheduleId.HasValue && scheduleItems.Any())
        {
            <div class="card mt-3">
                <div class="card-header bg-info text-white py-2">
                    <i class="bi bi-list-ul me-2"></i>已儲存的排程項目
                </div>
                <div class="card-body p-0">
                    <InteractiveTableComponent TItem="ProductionScheduleItem"
                                              Items="@scheduleItems"
                                              ColumnDefinitions="@GetScheduleItemColumns()"
                                              ShowHeader="true"
                                              ShowActions="true"
                                              ActionsTemplate="@GetScheduleItemActionsTemplate()"
                                              IsStriped="true"
                                              IsHoverable="true"
                                              IsBordered="true"
                                              EnableRowClick="true"
                                              OnRowClick="@HandleScheduleItemRowClick"
                                              EmptyMessage="尚無排程項目"
                                              CssClass="mb-0" />
                </div>
            </div>
        }
    };

    /// <summary>
    /// 取得排程項目欄位定義
    /// </summary>
    private List<InteractiveColumnDefinition> GetScheduleItemColumns()
    {
        return new List<InteractiveColumnDefinition>
        {
            new InteractiveColumnDefinition
            {
                Title = "商品",
                PropertyName = nameof(ProductionScheduleItem.ProductId),
                ColumnType = InteractiveColumnType.Display,
                Width = "30%",
                DisplayFormatter = item =>
                {
                    var scheduleItem = item as ProductionScheduleItem;
                    if (scheduleItem?.Product == null) return "未知商品";
                    
                    return $"[{scheduleItem.Product.Code}] {scheduleItem.Product.Name}";
                }
            },
            new InteractiveColumnDefinition
            {
                Title = "排程數量",
                PropertyName = nameof(ProductionScheduleItem.ScheduledQuantity),
                ColumnType = InteractiveColumnType.Display,
                Width = "12%",
                TextAlign = "right",
                DisplayFormatter = item =>
                {
                    var scheduleItem = item as ProductionScheduleItem;
                    return NumberFormatHelper.FormatSmart(scheduleItem?.ScheduledQuantity ?? 0);
                }
            },
            new InteractiveColumnDefinition
            {
                Title = "完成數量",
                PropertyName = nameof(ProductionScheduleItem.CompletedQuantity),
                ColumnType = InteractiveColumnType.Custom,
                Width = "12%",
                CustomTemplate = item =>
                {
                    var scheduleItem = item as ProductionScheduleItem;
                    if (scheduleItem == null) return __builder => { };
                    
                    return __builder =>
                    {
                        <span class="@(scheduleItem.CompletedQuantity >= scheduleItem.ScheduledQuantity ? "text-success fw-bold" : "")" style="display: block; text-align: right;">
                            @NumberFormatHelper.FormatSmart(scheduleItem.CompletedQuantity)
                        </span>
                    };
                }
            },
            new InteractiveColumnDefinition
            {
                Title = "狀態",
                PropertyName = nameof(ProductionScheduleItem.ProductionItemStatus),
                ColumnType = InteractiveColumnType.Custom,
                Width = "15%",
                CustomTemplate = item =>
                {
                    var scheduleItem = item as ProductionScheduleItem;
                    if (scheduleItem == null) return __builder => { };
                    return GetStatusBadge(scheduleItem.ProductionItemStatus);
                }
            },
            new InteractiveColumnDefinition
            {
                Title = "預計完成",
                PropertyName = nameof(ProductionScheduleItem.PlannedEndDate),
                ColumnType = InteractiveColumnType.Display,
                Width = "15%",
                DisplayFormatter = item =>
                {
                    var scheduleItem = item as ProductionScheduleItem;
                    return scheduleItem?.PlannedEndDate?.ToString("yyyy-MM-dd") ?? "-";
                }
            }
        };
    }

    /// <summary>
    /// 取得排程項目操作按鈕模板
    /// </summary>
    private RenderFragment<ProductionScheduleItem> GetScheduleItemActionsTemplate()
    {
        return item => __builder =>
        {
            <GenericButtonComponent Text="查看"
                                  Variant="ButtonVariant.Blue"
                                  Size="ButtonSize.Small"
                                  Icon="bi bi-eye"
                                  OnClick="@(() => HandleOpenScheduleItem(item.Id))" />
        };
    }

    /// <summary>
    /// 處理排程項目行點擊事件
    /// </summary>
    private async Task HandleScheduleItemRowClick(ProductionScheduleItem item)
    {
        HandleOpenScheduleItem(item.Id);
        await Task.CompletedTask;
    }

    /// <summary>
    /// 取得狀態標籤
    /// </summary>
    private RenderFragment GetStatusBadge(ProductionItemStatus status) => __builder =>
    {
        var (badgeClass, icon, text) = status switch
        {
            ProductionItemStatus.Pending => ("bg-secondary", "bi-clock", "待處理"),
            ProductionItemStatus.InProgress => ("bg-warning text-dark", "bi-play-circle", "生產中"),
            ProductionItemStatus.Completed => ("bg-success", "bi-check-circle", "已完成"),
            _ => ("bg-secondary", "bi-question-circle", "未知")
        };
        
        <span class="badge @badgeClass">
            <i class="@icon me-1"></i>@text
        </span>
    };

    /// <summary>
    /// 開啟排程項目詳情
    /// </summary>
    private void HandleOpenScheduleItem(int itemId)
    {
        selectedScheduleItemId = itemId;
        showScheduleItemModal = true;
        StateHasChanged();
    }

    /// <summary>
    /// 處理排程項目儲存後的事件
    /// </summary>
    private async Task HandleScheduleItemSaved(ProductionScheduleItem savedItem)
    {
        // 更新列表中的項目
        var index = scheduleItems.FindIndex(x => x.Id == savedItem.Id);
        if (index >= 0)
        {
            scheduleItems[index] = savedItem;
        }
        
        showScheduleItemModal = false;
        selectedScheduleItemId = null;
        StateHasChanged();
        
        await Task.CompletedTask;
    }

    // ===== 雙表格設計事件處理 =====

    /// <summary>
    /// 載入待排程訂單列表
    /// </summary>
    private async Task LoadPendingOrdersAsync()
    {
        try
        {
            pendingOrders = new List<PendingScheduleOrderDto>();
            
            // 取得所有銷貨訂單
            var salesOrders = await SalesOrderService.GetAllAsync();
            
            foreach (var order in salesOrders)
            {
                // 取得訂單明細
                var details = await SalesOrderDetailService.GetBySalesOrderIdWithIncludesAsync(order.Id);
                
                // 計算待排程數量和待排明細
                decimal pendingQuantity = 0;
                int pendingItemCount = 0;
                var orderDetails = new List<PendingScheduleDetailDto>();
                
                foreach (var detail in details)
                {
                    // 從 ProductionScheduleItem 計算已排程數量
                    var scheduledQty = await GetScheduledQuantityForOrderDetailAsync(detail.Id);
                    
                    // 檢查是否已經在當前排程項目列表中（尚未儲存的）
                    var currentScheduleQty = currentScheduleItems
                        .Where(si => si.SalesOrderDetailId == detail.Id)
                        .Sum(si => si.ScheduleQuantity);
                    
                    var totalScheduled = scheduledQty + currentScheduleQty;
                    var remaining = detail.OrderQuantity - totalScheduled;
                    
                    if (remaining > 0)
                    {
                        pendingQuantity += remaining;
                        pendingItemCount++;
                        
                        orderDetails.Add(new PendingScheduleDetailDto
                        {
                            SalesOrderDetailId = detail.Id,
                            ProductId = detail.ProductId,
                            ProductCode = detail.Product?.Code ?? "",
                            ProductName = detail.Product?.Name ?? "未知商品",
                            OrderQuantity = detail.OrderQuantity,
                            ScheduledQuantity = totalScheduled,
                            PendingQuantity = remaining
                        });
                    }
                }
                
                if (pendingItemCount > 0)
                {
                    pendingOrders.Add(new PendingScheduleOrderDto
                    {
                        SalesOrderId = order.Id,
                        OrderCode = order.Code ?? "",
                        CustomerId = order.CustomerId,
                        CustomerName = order.Customer?.CompanyName ?? "未知客戶",
                        OrderDate = order.OrderDate,
                        PendingScheduleQuantity = pendingQuantity,
                        PendingItemCount = pendingItemCount,
                        Details = orderDetails
                    });
                }
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入待排程訂單失敗: {ex.Message}");
            pendingOrders = new();
        }
    }

    /// <summary>
    /// 取得訂單明細已排程數量
    /// </summary>
    private async Task<decimal> GetScheduledQuantityForOrderDetailAsync(int salesOrderDetailId)
    {
        try
        {
            // 查詢已排程數量（排除目前排程中尚未儲存的項目）
            var allItems = await ProductionScheduleItemService.GetAllAsync();
            return allItems
                .Where(item => item.SalesOrderDetailId == salesOrderDetailId)
                .Sum(item => item.ScheduledQuantity);
        }
        catch
        {
            return 0;
        }
    }

    /// <summary>
    /// 處理訂單選擇事件（點擊加入按鈕）
    /// </summary>
    private async Task HandleOrderSelected(PendingScheduleOrderDto order)
    {
        try
        {
            selectedOrderForDetails = order;
            
            // 載入該訂單的待排程明細
            pendingDetails = new List<PendingScheduleDetailDto>();
            
            var details = await SalesOrderDetailService.GetBySalesOrderIdWithIncludesAsync(order.SalesOrderId);
            
            foreach (var detail in details)
            {
                var scheduledQty = await GetScheduledQuantityForOrderDetailAsync(detail.Id);
                var pendingQty = detail.OrderQuantity - scheduledQty;
                
                // 檢查是否已經在當前排程項目列表中
                var alreadyInSchedule = currentScheduleItems.Any(
                    si => si.SalesOrderDetailId == detail.Id);
                
                if (alreadyInSchedule)
                {
                    // 已在排程中，扣除當前排程數量
                    var currentItem = currentScheduleItems.First(si => si.SalesOrderDetailId == detail.Id);
                    pendingQty -= currentItem.ScheduleQuantity;
                }
                
                pendingDetails.Add(new PendingScheduleDetailDto
                {
                    SalesOrderDetailId = detail.Id,
                    ProductId = detail.ProductId,
                    ProductCode = detail.Product?.Code ?? "",
                    ProductName = detail.Product?.Name ?? "未知商品",
                    OrderQuantity = detail.OrderQuantity,
                    ScheduledQuantity = scheduledQty,
                    PendingQuantity = Math.Max(0, pendingQty),
                    IsSelected = pendingQty > 0,
                    ScheduleQuantity = Math.Max(0, pendingQty)
                });
            }
            
            showDetailSelectorModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入訂單明細失敗: {ex.Message}");
        }
    }

    /// <summary>
    /// 處理拖放訂單事件（從左側表格拖放到右側）
    /// </summary>
    private async Task HandleOrderDropped(PendingScheduleOrderDto order)
    {
        // 拖放行為與點擊按鈕相同，開啟明細選擇彈窗
        await HandleOrderSelected(order);
    }

    /// <summary>
    /// 處理明細選擇確認
    /// </summary>
    private async Task HandleDetailSelectionConfirmed(List<PendingScheduleDetailDto> selectedDetails)
    {
        Console.WriteLine($"[DEBUG] HandleDetailSelectionConfirmed called, selectedDetails count: {selectedDetails?.Count ?? 0}");
        
        if (selectedDetails == null || selectedDetails.Count == 0)
        {
            return;
        }
        
        try
        {
            foreach (var detail in selectedDetails)
            {
                // 檢查是否已存在
                var existingItem = currentScheduleItems.FirstOrDefault(
                    si => si.SalesOrderDetailId == detail.SalesOrderDetailId);
                
                if (existingItem != null)
                {
                    // 更新數量
                    existingItem.ScheduleQuantity += detail.ScheduleQuantity;
                }
                else
                {
                    // 新增項目
                    currentScheduleItems.Add(new ScheduleItemDto
                    {
                        SalesOrderId = selectedOrderForDetails?.SalesOrderId ?? 0,
                        SalesOrderCode = selectedOrderForDetails?.OrderCode ?? "",
                        SalesOrderDetailId = detail.SalesOrderDetailId,
                        ProductId = detail.ProductId,
                        ProductCode = detail.ProductCode,
                        ProductName = detail.ProductName,
                        ScheduleQuantity = detail.ScheduleQuantity,
                        PendingScheduleQuantity = detail.PendingQuantity - detail.ScheduleQuantity,
                        CustomerName = selectedOrderForDetails?.CustomerName ?? "",
                        Status = ProductionItemStatus.Pending,
                        IsNew = true,
                        CanDelete = true
                    });
                }
            }
            
            showDetailSelectorModal = false;
            selectedOrderForDetails = null;
            pendingDetails = new();
            
            // 重新載入待排程訂單列表
            await LoadPendingOrdersAsync();
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"加入排程項目失敗: {ex.Message}");
        }
    }

    /// <summary>
    /// 處理明細選擇取消
    /// </summary>
    private void HandleDetailSelectorCancelled()
    {
        showDetailSelectorModal = false;
        selectedOrderForDetails = null;
        pendingDetails = new();
        StateHasChanged();
    }

    /// <summary>
    /// 處理排程項目移除
    /// </summary>
    private async Task HandleScheduleItemRemoved(ScheduleItemDto item)
    {
        currentScheduleItems.Remove(item);
        
        // 重新載入待排程訂單列表
        await LoadPendingOrdersAsync();
        
        StateHasChanged();
    }

    /// <summary>
    /// 處理排程項目數量變更
    /// </summary>
    private void HandleScheduleItemQuantityChanged((ScheduleItemDto Item, decimal NewQuantity) args)
    {
        args.Item.ScheduleQuantity = args.NewQuantity;
        StateHasChanged();
    }

    /// <summary>
    /// 處理刷新待排程訂單請求
    /// </summary>
    private async Task HandleRefreshPendingOrders()
    {
        await LoadPendingOrdersAsync();
        StateHasChanged();
    }

    // ===== 公開方法 (供父組件調用) =====

    /// <summary>
    /// 開啟新增生產排程 Modal
    /// </summary>
    public async Task ShowAddModal()
    {
        ProductionScheduleId = null;
        scheduleItems = new();
        if (IsVisibleChanged.HasDelegate)
        {
            await IsVisibleChanged.InvokeAsync(true);
        }
    }

    /// <summary>
    /// 開啟編輯生產排程 Modal
    /// </summary>
    public async Task ShowEditModal(int scheduleId)
    {
        ProductionScheduleId = scheduleId;
        if (IsVisibleChanged.HasDelegate)
        {
            await IsVisibleChanged.InvokeAsync(true);
        }
    }
}
