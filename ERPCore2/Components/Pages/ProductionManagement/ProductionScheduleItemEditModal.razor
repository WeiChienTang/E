@* 生產排程項目編輯 Modal - 編輯單個排程項目的詳細資訊 *@
@using ERPCore2.Components.Shared.UI.Button
@using ERPCore2.Data.Entities
@using ERPCore2.Models.Enums
@inject IProductionScheduleItemService ProductionScheduleItemService
@inject IProductionScheduleDetailService ProductionScheduleDetailService
@inject IProductService ProductService
@inject IWarehouseService WarehouseService
@inject IInventoryStockService InventoryStockService
@inject INotificationService NotificationService

<BaseModalComponent IsVisible="@IsVisible"
                   IsVisibleChanged="@IsVisibleChanged"
                   Title="@GetModalTitle()"
                   Icon="bi bi-clipboard-check"
                   HeaderColor="@GetHeaderColor()"
                   ShowFooter="false"
                   CloseOnBackdropClick="false"
                   CloseOnEscape="true"
                   IsLoading="@isLoading"
                   LoadingMessage="載入中..."
                   HeaderButtons="@HeaderButtons"
                   BodyContent="@BodyContent" />

@code {
    // ===== 參數定義 =====
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    
    /// <summary>
    /// 排程項目 ID
    /// </summary>
    [Parameter] public int? ProductionScheduleItemId { get; set; }
    
    /// <summary>
    /// 是否唯讀模式
    /// </summary>
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    /// <summary>
    /// 儲存成功回調
    /// </summary>
    [Parameter] public EventCallback<ProductionScheduleItem> OnSaved { get; set; }
    
    /// <summary>
    /// 取消回調
    /// </summary>
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== 私有欄位 =====
    private bool isLoading = false;
    private ProductionScheduleItem? scheduleItem;
    private List<ProductionScheduleDetail> scheduleDetails = new();
    private List<Product> availableProducts = new();
    private List<Warehouse> availableWarehouses = new();
    private Dictionary<int, decimal> productStockQuantities = new();

    // ===== 生命週期 =====
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && ProductionScheduleItemId.HasValue)
        {
            await LoadDataAsync();
        }
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // 載入參考資料
            availableProducts = await ProductService.GetAllAsync();
            availableWarehouses = await WarehouseService.GetAllAsync();
            
            // 載入庫存資訊
            await LoadStockQuantitiesAsync();
            
            // 載入排程項目
            if (ProductionScheduleItemId.HasValue)
            {
                scheduleItem = await ProductionScheduleItemService.GetByIdAsync(ProductionScheduleItemId.Value);
                
                if (scheduleItem != null)
                {
                    // 載入組件明細
                    scheduleDetails = await ProductionScheduleDetailService.GetByScheduleItemIdAsync(ProductionScheduleItemId.Value);
                }
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入失敗：{ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadStockQuantitiesAsync()
    {
        try
        {
            productStockQuantities.Clear();
            
            foreach (var product in availableProducts)
            {
                var stocks = await InventoryStockService.GetByProductIdAsync(product.Id);
                var totalStock = stocks.Sum(s => s.TotalCurrentStock);
                productStockQuantities[product.Id] = totalStock;
            }
        }
        catch
        {
            // 忽略庫存載入錯誤
        }
    }

    private string GetModalTitle()
    {
        if (scheduleItem?.Product != null)
        {
            return $"排程項目 - {scheduleItem.Product.Name}";
        }
        return "排程項目詳情";
    }

    private BaseModalComponent.HeaderVariant GetHeaderColor()
    {
        if (scheduleItem == null) return BaseModalComponent.HeaderVariant.Info;
        
        return scheduleItem.ProductionItemStatus switch
        {
            ProductionItemStatus.Pending => BaseModalComponent.HeaderVariant.Info,
            ProductionItemStatus.InProgress => BaseModalComponent.HeaderVariant.Warning,
            ProductionItemStatus.Completed => BaseModalComponent.HeaderVariant.Success,
            _ => BaseModalComponent.HeaderVariant.Info
        };
    }

    // ===== Header Buttons =====
    private RenderFragment HeaderButtons => __builder =>
    {
        <div class="w-100 d-flex align-items-center px-2">
            <div class="d-flex gap-2 ms-auto">
                @if (!IsReadOnly && scheduleItem?.ProductionItemStatus != ProductionItemStatus.Completed)
                {
                    @if (scheduleItem?.ProductionItemStatus == ProductionItemStatus.Pending)
                    {
                        <GenericButtonComponent Text="組件領料"
                                              Variant="ButtonVariant.DarkBlue"
                                              Size="ButtonSize.Small"
                                              Icon="bi bi-box-arrow-up"
                                              OnClick="@HandleShowMaterialIssueModal" />
                        <GenericButtonComponent Text="開始生產"
                                              Variant="ButtonVariant.Yellow"
                                              Size="ButtonSize.Small"
                                              Icon="bi bi-play-fill"
                                              OnClick="@HandleStartProduction" />
                    }
                    @if (scheduleItem?.ProductionItemStatus == ProductionItemStatus.InProgress)
                    {
                        <GenericButtonComponent Text="組件領料"
                                              Variant="ButtonVariant.DarkBlue"
                                              Size="ButtonSize.Small"
                                              Icon="bi bi-box-arrow-up"
                                              OnClick="@HandleShowMaterialIssueModal" />
                        <GenericButtonComponent Text="完工登錄"
                                              Variant="ButtonVariant.Green"
                                              Size="ButtonSize.Small"
                                              Icon="bi bi-check2-square"
                                              OnClick="@HandleShowCompletionModal" />
                    }
                    <GenericButtonComponent Text="儲存"
                                          Variant="ButtonVariant.Blue"
                                          Size="ButtonSize.Small"
                                          OnClick="@HandleSave" />
                }
            </div>
        </div>
    };

    // ===== Body Content =====
    private RenderFragment BodyContent => __builder =>
    {
        <div class="container-fluid">
            @if (scheduleItem != null)
            {
                @* 基本資訊 *@
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>基本資訊</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label text-muted small">商品</label>
                                <div class="fw-bold">
                                    @(scheduleItem.Product?.Name ?? "-")
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label text-muted small">計劃數量</label>
                                <div class="fw-bold text-primary">
                                    @scheduleItem.ScheduledQuantity.ToString("N2")
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label text-muted small">已完成數量</label>
                                <div class="fw-bold @(scheduleItem.CompletedQuantity >= scheduleItem.ScheduledQuantity ? "text-success" : "text-warning")">
                                    @scheduleItem.CompletedQuantity.ToString("N2")
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-muted small">狀態</label>
                                <div>
                                    @GetStatusBadge(scheduleItem.ProductionItemStatus)
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-muted small">預計完成日期</label>
                                <div>@(scheduleItem.PlannedEndDate?.ToString("yyyy-MM-dd") ?? "-")</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-muted small">實際開始日期</label>
                                <div>@(scheduleItem.ActualStartDate?.ToString("yyyy-MM-dd") ?? "-")</div>
                            </div>
                        </div>
                    </div>
                </div>

                @* 來源訂單資訊（如果有） *@
                @if (scheduleItem.SalesOrderDetailId.HasValue)
                {
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>來源訂單</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label text-muted small">銷貨訂單明細 ID</label>
                                    <div>@scheduleItem.SalesOrderDetailId</div>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                @* 組件需求 *@
                <div class="card mb-3">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>組件需求</h6>
                        <span class="badge bg-secondary">@scheduleDetails.Count 項</span>
                    </div>
                    <div class="card-body p-0">
                        @if (scheduleDetails.Any())
                        {
                            <table class="table table-sm table-striped mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 35%">組件商品</th>
                                        <th style="width: 15%" class="text-end">需求數量</th>
                                        <th style="width: 15%" class="text-end">已發料</th>
                                        <th style="width: 15%" class="text-end">庫存</th>
                                        <th style="width: 20%">狀態</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var detail in scheduleDetails)
                                    {
                                        var product = availableProducts.FirstOrDefault(p => p.Id == detail.ComponentProductId);
                                        var stockQty = productStockQuantities.GetValueOrDefault(detail.ComponentProductId, 0);
                                        var issuedQty = detail.IssuedQuantity;
                                        var isEnough = stockQty >= detail.RequiredQuantity;
                                        
                                        <tr>
                                            <td>
                                                @if (product != null)
                                                {
                                                    <span>[@product.Code] @product.Name</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">未知商品</span>
                                                }
                                            </td>
                                            <td class="text-end">@detail.RequiredQuantity.ToString("N2")</td>
                                            <td class="text-end">@issuedQty.ToString("N2")</td>
                                            <td class="text-end @(isEnough ? "text-success" : "text-danger") fw-bold">
                                                @stockQty.ToString("N0")
                                            </td>
                                            <td>
                                                @if (issuedQty >= detail.RequiredQuantity)
                                                {
                                                    <span class="badge bg-success">
                                                        <i class="bi bi-check-circle me-1"></i>已發料完成
                                                    </span>
                                                }
                                                else if (issuedQty > 0)
                                                {
                                                    <span class="badge bg-warning text-dark">
                                                        <i class="bi bi-hourglass-split me-1"></i>部分發料
                                                    </span>
                                                }
                                                else if (!isEnough)
                                                {
                                                    <span class="badge bg-danger">
                                                        <i class="bi bi-exclamation-triangle me-1"></i>庫存不足
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">
                                                        <i class="bi bi-clock me-1"></i>待發料
                                                    </span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-inbox fs-3 mb-2 d-block"></i>
                                沒有組件需求
                            </div>
                        }
                    </div>
                </div>

                @* 進度區塊 *@
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>生產進度</h6>
                    </div>
                    <div class="card-body">
                        @{
                            var progressPercent = scheduleItem.ScheduledQuantity > 0 
                                ? (scheduleItem.CompletedQuantity / scheduleItem.ScheduledQuantity) * 100 
                                : 0;
                            var progressClass = progressPercent >= 100 ? "bg-success" 
                                : progressPercent >= 50 ? "bg-warning" 
                                : "bg-info";
                        }
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar @progressClass" 
                                 role="progressbar" 
                                 style="width: @progressPercent%;" 
                                 aria-valuenow="@progressPercent" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                @progressPercent.ToString("N1")%
                            </div>
                        </div>
                        <div class="mt-2 text-muted small text-center">
                            @scheduleItem.CompletedQuantity.ToString("N2") / @scheduleItem.ScheduledQuantity.ToString("N2")
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="text-center text-muted py-5">
                    <i class="bi bi-question-circle fs-1 mb-3 d-block"></i>
                    找不到排程項目資料
                </div>
            }
        </div>
    };

    // ===== Helper Methods =====
    private RenderFragment GetStatusBadge(ProductionItemStatus status) => __builder =>
    {
        var (badgeClass, icon, text) = status switch
        {
            ProductionItemStatus.Pending => ("bg-secondary", "bi-clock", "待處理"),
            ProductionItemStatus.InProgress => ("bg-warning text-dark", "bi-play-circle", "生產中"),
            ProductionItemStatus.Completed => ("bg-success", "bi-check-circle", "已完成"),
            _ => ("bg-secondary", "bi-question-circle", "未知")
        };
        
        <span class="badge @badgeClass">
            <i class="@icon me-1"></i>@text
        </span>
    };

    // ===== 事件處理 =====
    private async Task HandleStartProduction()
    {
        if (scheduleItem == null) return;
        
        try
        {
            isLoading = true;
            StateHasChanged();
            
            scheduleItem.ProductionItemStatus = ProductionItemStatus.InProgress;
            scheduleItem.ActualStartDate = DateTime.Now;
            
            var result = await ProductionScheduleItemService.UpdateAsync(scheduleItem);
            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync("已開始生產");
                StateHasChanged();
            }
            else
            {
                await NotificationService.ShowErrorAsync($"更新失敗：{result.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"操作失敗：{ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleSave()
    {
        if (scheduleItem == null) return;
        
        try
        {
            isLoading = true;
            StateHasChanged();
            
            var result = await ProductionScheduleItemService.UpdateAsync(scheduleItem);
            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync("儲存成功");
                
                if (OnSaved.HasDelegate)
                {
                    await OnSaved.InvokeAsync(scheduleItem);
                }
                
                await CloseModal();
            }
            else
            {
                await NotificationService.ShowErrorAsync($"儲存失敗：{result.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"儲存失敗：{ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // ===== 完工登錄相關 =====
    private bool showCompletionModal = false;

    private void HandleShowCompletionModal()
    {
        showCompletionModal = true;
        StateHasChanged();
    }

    private async Task HandleCompletionRecorded(ProductionScheduleCompletion completion)
    {
        showCompletionModal = false;
        
        // 重新載入資料以更新狀態
        await LoadDataAsync();
        
        await NotificationService.ShowSuccessAsync($"完工登錄成功，完成數量：{completion.CompletedQuantity:N2}");
    }

    // ===== 組件領料相關 =====
    private bool showMaterialIssueModal = false;

    private void HandleShowMaterialIssueModal()
    {
        showMaterialIssueModal = true;
        StateHasChanged();
    }

    private async Task HandleMaterialIssued()
    {
        showMaterialIssueModal = false;
        
        // 重新載入資料以更新已領數量
        await LoadDataAsync();
    }

    private async Task HandleCancel()
    {
        if (OnCancel.HasDelegate)
        {
            await OnCancel.InvokeAsync();
        }
        
        await CloseModal();
    }

    private async Task CloseModal()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }
}

@* 完工登錄 Modal *@
<ProductionCompletionModal IsVisible="@showCompletionModal"
                          IsVisibleChanged="@((bool visible) => { showCompletionModal = visible; StateHasChanged(); })"
                          ProductionScheduleItemId="@ProductionScheduleItemId"
                          OnCompletionRecorded="@HandleCompletionRecorded" />

@* 組件領料 Modal *@
<MaterialIssueModal IsVisible="@showMaterialIssueModal"
                   IsVisibleChanged="@((bool visible) => { showMaterialIssueModal = visible; StateHasChanged(); })"
                   ProductionScheduleItemId="@ProductionScheduleItemId"
                   OnMaterialIssued="@HandleMaterialIssued" />
