@* 沖款單編輯組件 *@
@inject ISetoffDocumentService SetoffDocumentService
@inject ISetoffProductDetailService SetoffProductDetailService
@inject ISetoffPaymentService SetoffPaymentService
@inject ISetoffPrepaymentService SetoffPrepaymentService
@inject ISetoffPrepaymentUsageService SetoffPrepaymentUsageService
@inject IPrepaymentTypeService PrepaymentTypeService
@inject ICompanyService CompanyService
@inject ICustomerService CustomerService
@inject ISupplierService SupplierService
@inject INotificationService NotificationService
@inject ISetoffDocumentReportService SetoffDocumentReportService
@inject IStringLocalizer<SharedResource> L
@using ERPCore2.Models.Reports

<GenericEditModalComponent TEntity="SetoffDocument" 
                          TService="ISetoffDocumentService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@SetoffDocumentId"
                          Service="@SetoffDocumentService"
                          EntityName="@L["Entity.SetoffDocument"]"
                          EntityNamePlural="@L["Entity.SetoffDocument"]"
                          ModalTitle="@(SetoffDocumentId.HasValue ? L["Message.EditTitle", L["Entity.SetoffDocument"]].ToString() : L["Message.CreateTitle", L["Entity.SetoffDocument"]].ToString())"
                          Size="GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@(autoCompleteConfig?.Prefillers)"
                          AutoCompleteCollections="@(autoCompleteConfig?.Collections)"
                          AutoCompleteDisplayProperties="@(autoCompleteConfig?.DisplayProperties)"
                          AutoCompleteValueProperties="@(autoCompleteConfig?.ValueProperties)"
                          DataLoader="@LoadSetoffDocumentData"
                          UseGenericSave="true"
                          SaveSuccessMessage="@(SetoffDocumentId.HasValue ? L["Message.UpdateSuccess", L["Entity.SetoffDocument"]].ToString() : L["Message.CreateSuccess", L["Entity.SetoffDocument"]].ToString())"
                          SaveFailureMessage="@L["Message.SaveFailure", L["Entity.SetoffDocument"]]"
                          RequiredPermission="@PermissionRegistry.SetoffDocument.Read"
                          CustomValidator="@ValidateBeforeSave"
                          AfterSave="@SaveSetoffDocumentDetailsAsync"
                          OnEntitySaved="@OnSetoffDocumentSaved"
                          OnCancel="@OnCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          CustomModules="@GetCustomModules()"
                          OnEntityLoaded="@HandleEntityLoaded"
                          ShowPrintButton="true"
                          ReportService="@SetoffDocumentReportService"
                          ReportId="@GetCurrentReportId()"
                          ReportPreviewTitle="@GetReportPreviewTitle()"
                          GetReportDocumentName="@(e => GetDocumentName(e))">
</GenericEditModalComponent>


@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SetoffDocumentId { get; set; }
    [Parameter] public SetoffType? DefaultSetoffType { get; set; } // 新增：預設的沖款類型
    [Parameter] public EventCallback<SetoffDocument> OnSetoffDocumentSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    
    // ===== 預填參數（用於轉單功能）=====
    // 廠商相關（應付帳款）
    [Parameter] public int? PrefilledSupplierId { get; set; }
    [Parameter] public int? PrefilledPurchaseReceivingId { get; set; }
    [Parameter] public int? PrefilledPurchaseReturnId { get; set; }
    // 客戶相關（應收帳款）
    [Parameter] public int? PrefilledCustomerId { get; set; }
    [Parameter] public int? PrefilledSalesDeliveryId { get; set; }
    [Parameter] public int? PrefilledSalesReturnId { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // 轉單自動載入控制
    private bool shouldAutoLoadFromReceiving = false;
    private bool shouldAutoLoadFromPurchaseReturn = false;
    private bool shouldAutoLoadFromDelivery = false;
    private bool shouldAutoLoadFromSalesReturn = false;
    private int? filterPurchaseReceivingId = null;
    private int? filterPurchaseReturnId = null;
    private int? filterSalesDeliveryId = null;
    private int? filterSalesReturnId = null;
    
    // 選項清單
    private List<Company> companies = new();
    private List<Customer> customers = new();
    private List<Supplier> suppliers = new();
    
    // AutoComplete 配置
    private AutoCompleteConfig? autoCompleteConfig;
    
    // 商品明細相關
    private List<SetoffProductDetail> setoffProductDetails = new();
    private bool IsReadOnly => false; // 可根據權限或狀態控制
    private SetoffProductTable? setoffProductDetailManager;
    
    // 收款記錄相關
    private List<SetoffPayment> setoffPayments = new();
    private SetoffPaymentTable? setoffPaymentTable;
    
    // 預收付款項相關
    private List<SetoffPrepayment> setoffPrepayments = new();
    private SetoffPrepaymentTable? setoffPrepaymentDetailManager;
    
    // DataVersion 計數器（防止重複載入）
    private int _productDetailsDataVersion = 0;
    private int _paymentDetailsDataVersion = 0;
    private int _prepaymentDetailsDataVersion = 0;
    
    // 日期篩選
    private DateTime? filterStartDate;
    private DateTime? filterEndDate;

    // ===== 必要方法 =====
    
    /// <summary>
    /// 處理實體載入完成事件（由 GenericEditModalComponent 的導航觸發）
    /// 當上下筆切換時，重新載入對應的三個明細資料（商品明細、收款記錄、預收付款項）
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        // 方案 A + D：明細已由 DataLoader 載入，三個 Table 自動偵測參數變化
        await LoadSetoffDocumentDetails(loadedEntityId);
        StateHasChanged();
    }
    
    /// <summary>
    /// 載入沖款單的三個明細資料（商品明細、收款記錄、預收付款項）
    /// 用於上下筆切換時重新載入明細
    /// </summary>
    private async Task LoadSetoffDocumentDetails(int setoffDocumentId)
    {
        // 1. 載入商品明細
        setoffProductDetails = await SetoffProductDetailService.GetBySetoffDocumentIdAsync(setoffDocumentId);
        
        // 2. 載入收款記錄
        setoffPayments = await SetoffPaymentService.GetBySetoffDocumentIdAsync(setoffDocumentId);
        
        // 3. 載入預收付款項（包含主記錄和使用記錄）
        setoffPrepayments = new List<SetoffPrepayment>();
        
        // 3.1 載入預收/預付主記錄（Amount > 0）
        var prepaymentRecords = await SetoffPrepaymentService.GetBySetoffDocumentIdAsync(setoffDocumentId);
        setoffPrepayments.AddRange(prepaymentRecords);
        
        // 3.2 載入轉沖款使用記錄（UsedAmount > 0），轉換為 SetoffPrepayment 格式供前端顯示
        var usageRecords = await SetoffPrepaymentUsageService.GetBySetoffDocumentIdAsync(setoffDocumentId);
        
        // 取得所有預收付類型，用於查詢「轉沖款」類型ID
        var allPrepaymentTypes = await PrepaymentTypeService.GetAllAsync();
        
        foreach (var usage in usageRecords)
        {
            // 根據來源預收付款項的類型，判斷應該使用哪個「轉沖款」類型
            var sourceType = usage.SetoffPrepayment.PrepaymentType?.Name ?? string.Empty;
            var transferTypeName = sourceType.Contains("預收") ? "預收轉沖款" : "預付轉沖款";
            var transferType = allPrepaymentTypes.FirstOrDefault(pt => pt.Name == transferTypeName);
            
            if (transferType != null)
            {
                // 轉換為 SetoffPrepayment 格式，讓前端組件可以統一處理
                setoffPrepayments.Add(new SetoffPrepayment
                {
                    Id = 0,
                    PrepaymentTypeId = transferType.Id,
                    SourceDocumentCode = usage.SourcePrepaymentCode ?? usage.SetoffPrepayment.SourceDocumentCode,
                    SourcePrepaymentId = usage.SetoffPrepaymentId,
                    Amount = usage.SetoffPrepayment.Amount,
                    UsedAmount = usage.UsedAmount,
                    CustomerId = usage.SetoffPrepayment.CustomerId,
                    SupplierId = usage.SetoffPrepayment.SupplierId,
                    SetoffDocumentId = setoffDocumentId,
                    Remarks = string.Empty
                });
            }
        }
        
        // 遞增 DataVersion 通知 Table 組件資料已更新
        _productDetailsDataVersion++;
        _paymentDetailsDataVersion++;
        _prepaymentDetailsDataVersion++;
    }
    
    // 資料載入狀態標記
    private bool isDataLoaded = false;
    
    protected override async Task OnParametersSetAsync()
    {
        // 當 SetoffDocumentId 參數變更時，重新初始化表單欄位
        if (IsVisible && !isDataLoaded)
        {
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
        }
        else if (formFields != null) // 只有在已經初始化過的情況下才重新設定
        {
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
        }
    }

    /// <summary>
    /// 儲存前驗證（在主表單儲存之前執行）
    /// </summary>
    private async Task<bool> ValidateBeforeSave(SetoffDocument entity)
    {
        try
        {
            if (entity == null)
            {
                await NotificationService.ShowErrorAsync("沒有可儲存的資料");
                return false;
            }

            // ===== 驗證三個明細表至少有一個包含資料 =====
            var hasProductDetails = setoffProductDetails?.Any(d => 
                d.CurrentSetoffAmount > 0 || d.CurrentAllowanceAmount > 0) ?? false;
            
            var hasPaymentDetails = setoffPayments?.Any(p => 
                p.ReceivedAmount > 0 || p.AllowanceAmount > 0) ?? false;
            
            var hasPrepaymentDetails = setoffPrepayments?.Any(p => 
                p.Amount > 0 || p.UsedAmount > 0) ?? false;
            
            if (!hasProductDetails && !hasPaymentDetails && !hasPrepaymentDetails)
            {
                await NotificationService.ShowErrorAsync("商品明細、收款記錄和預收付款項不可都為空白。");
                return false;
            }

            // ===== 儲存前驗證金額 =====
            var receivedFromPayments = setoffPaymentTable?.GetTotalReceivedAmount() ?? 0;
            var allowanceFromPayments = setoffPaymentTable?.GetTotalAllowanceAmount() ?? 0;
            var hasProductSetoff = setoffProductDetails?.Any(d => 
                d.CurrentSetoffAmount > 0 || d.CurrentAllowanceAmount > 0) ?? false;
            
            // 取得預收付款項類型資訊
            var allPrepaymentTypes = await PrepaymentTypeService.GetAllAsync();
            var prepaymentAmount = 0m;      // 預收/付類型的 Amount
            var prepaymentUsedAmount = 0m;  // 轉沖款類型的 UsedAmount
            
            if (setoffPrepayments != null)
            {
                foreach (var prepayment in setoffPrepayments)
                {
                    var prepaymentType = allPrepaymentTypes.FirstOrDefault(pt => pt.Id == prepayment.PrepaymentTypeId);
                    if (prepaymentType != null && prepaymentType.Name.Contains("轉沖款"))
                    {
                        prepaymentUsedAmount += prepayment.UsedAmount;
                    }
                    else
                    {
                        prepaymentAmount += prepayment.Amount;
                    }
                }
            }
            
            // ===== 驗證 entity 欄位的邏輯關係 =====
            // 正確做法：只驗證 entity 的欄位值是否符合業務邏輯公式
            // 不去核對各個子元件（商品明細、收款記錄、預收付款項）的明細數字
            // 因為所有數字都已經由 Handler 方法計算並反映在 entity 的欄位上
            
            // 驗證：本期已收 + 預收沖款 = 本期沖銷 + 本期折讓 + 本期預收
            var expectedTotalCollection = entity.CurrentSetoffAmount + entity.TotalAllowanceAmount + entity.CurrentPrepaymentAmount;
            var actualLeftSide = entity.TotalCollectionAmount + entity.PrepaymentSetoffAmount;
            if (Math.Abs(expectedTotalCollection - actualLeftSide) > 0.01m)
            {
                await NotificationService.ShowErrorAsync(
                    $"本期已收驗證失敗：\n\n" +
                    $"公式：本期已收 + 預收沖款 = 本期沖銷 + 本期折讓 + 本期預收\n\n" +
                    $"【左邊計算】\n" +
                    $"  本期已收: {entity.TotalCollectionAmount:N2}\n" +
                    $"  預收沖款: {entity.PrepaymentSetoffAmount:N2}\n" +
                    $"  左邊總計: {actualLeftSide:N2}\n\n" +
                    $"【右邊計算】\n" +
                    $"  本期沖銷: {entity.CurrentSetoffAmount:N2}\n" +
                    $"  本期折讓: {entity.TotalAllowanceAmount:N2}\n" +
                    $"  本期預收: {entity.CurrentPrepaymentAmount:N2}\n" +
                    $"  右邊總計: {expectedTotalCollection:N2}\n\n" +
                    $"請確認欄位數字是否正確。");
                return false;
            }           
            
            // 驗證預收付款項（如果有填寫的話）
            if (setoffPrepaymentDetailManager != null)
            {
                var prepaymentValidationResult = await setoffPrepaymentDetailManager.ValidateAsync();
                if (!prepaymentValidationResult)
                {
                    // 驗證失敗，直接阻止儲存
                    return false;
                }
            }
            
            // ===== 提前驗證準備儲存的預收付款項資料 =====
            // 區分兩種類型：
            // 1. 預收/預付（Amount > 0 且 UsedAmount = 0）→ 使用 SetoffPrepaymentService 驗證
            // 2. 轉沖款（UsedAmount > 0 且非預收/預付類型）→ 使用 SetoffPrepaymentUsageService 驗證
            
            // 取得所有預收付類型，用於判斷是否為轉沖款類型
            var prepaymentTypesForValidation = await PrepaymentTypeService.GetAllAsync();
            
            // 驗證預收/預付主記錄（Amount > 0 且非轉沖款類型）
            var prepaymentRecords = setoffPrepayments?
                .Where(p => 
                {
                    // 必須有 Amount > 0
                    if (p.Amount <= 0) return false;
                    
                    // 檢查是否為轉沖款類型
                    var prepaymentType = prepaymentTypesForValidation.FirstOrDefault(pt => pt.Id == p.PrepaymentTypeId);
                    if (prepaymentType != null && prepaymentType.Name.Contains("轉沖款"))
                    {
                        return false;  // 轉沖款類型，不納入預收/預付驗證
                    }
                    
                    return true;  // 預收/預付類型
                })
                .ToList() ?? new List<SetoffPrepayment>();
            
            if (prepaymentRecords.Any())
            {
                for (int i = 0; i < prepaymentRecords.Count; i++)
                {
                    var prepayment = prepaymentRecords[i];
                    
                    // 呼叫 SetoffPrepaymentService 層的驗證方法
                    var validationResult = await SetoffPrepaymentService.ValidateAsync(prepayment);
                    if (!validationResult.IsSuccess)
                    {
                        await NotificationService.ShowErrorAsync($"預收付款項驗證失敗：{validationResult.ErrorMessage}");
                        return false;
                    }
                }
            }
            
            // 驗證轉沖款使用記錄
            var usageRecords = setoffPrepayments?
                .Where(p => p.UsedAmount > 0 && p.Amount == 0)
                .ToList() ?? new List<SetoffPrepayment>();
            
            if (usageRecords.Any())
            {
                foreach (var prepayment in usageRecords)
                {
                    // 從 SourceDocumentCode 查詢原始預收付款項
                    var sourcePrepayment = await SetoffPrepaymentService.GetBySourceDocumentCodeAsync(prepayment.SourceDocumentCode);
                    if (sourcePrepayment == null)
                    {
                        await NotificationService.ShowErrorAsync($"找不到來源預收付款項：{prepayment.SourceDocumentCode}");
                        return false;
                    }
                    
                    // 驗證使用金額是否超過可用餘額
                    var usageValidation = await SetoffPrepaymentUsageService.ValidateUsageAmountAsync(
                        sourcePrepayment.Id,
                        prepayment.UsedAmount,
                        null  // 新增時不需要排除任何記錄
                    );
                    
                    if (!usageValidation.IsSuccess)
                    {
                        await NotificationService.ShowErrorAsync($"轉沖款驗證失敗：{usageValidation.ErrorMessage}");
                        return false;
                    }
                }
            }
            
            
            // ===== 驗證商品明細的本次沖款是否超過未結清餘額 =====
            // 使用 Service 層的統一驗證邏輯，避免邏輯重複
            if (hasProductSetoff && SetoffProductDetailService != null && setoffProductDetails != null)
            {
                var validDetails = setoffProductDetails
                    .Where(d => d.CurrentSetoffAmount > 0 || d.CurrentAllowanceAmount > 0)
                    .ToList();
                
                if (validDetails.Any())
                {
                    // 直接調用 Service 的驗證方法，確保前端和後端驗證邏輯一致
                    foreach (var detail in validDetails)
                    {
                        // 如果是編輯模式，傳入 detail.Id 以排除原本的沖銷金額
                        var validation = await SetoffProductDetailService.ValidateSetoffAmountAsync(
                            detail.SourceDetailId,
                            detail.SourceDetailType,
                            detail.CurrentSetoffAmount,
                            detail.CurrentAllowanceAmount,
                            detail.Id > 0 ? detail.Id : null);
                        
                        if (!validation.IsSuccess)
                        {
                            await NotificationService.ShowErrorAsync($"商品明細驗證失敗：{validation.ErrorMessage}");
                            return false;
                        }
                    }
                }
            }

            // 驗證通過
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"驗證資料時發生錯誤：{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// 儲存明細資料（在主表單儲存成功之後執行）
    /// </summary>
    private async Task SaveSetoffDocumentDetailsAsync(SetoffDocument entity)
    {
        try
        {
            if (entity == null || entity.Id <= 0)
            {
                await NotificationService.ShowErrorAsync("主檔資料無效，無法儲存明細");
                return;
            }

            // 儲存商品明細（過濾掉本次沖款和折讓都為 0 的項目）
            var validDetails = setoffProductDetails
                .Where(d => d.CurrentSetoffAmount > 0 || d.CurrentAllowanceAmount > 0)
                .ToList();
                
            if (validDetails.Any() && entity.Id > 0)
            {
                // 設定 SetoffDocumentId
                foreach (var detail in validDetails)
                {
                    detail.SetoffDocumentId = entity.Id;
                }

                var detailResult = await SetoffProductDetailService.CreateBatchWithValidationAsync(validDetails);
                if (!detailResult.IsSuccess)
                {
                    await NotificationService.ShowErrorAsync($"商品明細儲存失敗：{detailResult.ErrorMessage}");
                    return;
                }
            }

            // 儲存收款記錄（過濾掉付款方式為空的項目）
            var validPayments = setoffPayments
                .Where(p => p.PaymentMethodId.HasValue && p.PaymentMethodId.Value > 0)
                .ToList();
                
            if (entity.Id > 0)
            {
                // 取得現有的收款記錄
                var existingPayments = await SetoffPaymentService.GetBySetoffDocumentIdAsync(entity.Id);
                var existingPaymentIds = existingPayments.Select(p => p.Id).ToList();
                var currentPaymentIds = validPayments.Where(p => p.Id > 0).Select(p => p.Id).ToList();
                
                // 刪除不再存在的收款記錄
                var paymentsToDelete = existingPayments.Where(ep => !currentPaymentIds.Contains(ep.Id)).ToList();
                foreach (var paymentToDelete in paymentsToDelete)
                {
                    await SetoffPaymentService.DeleteAsync(paymentToDelete.Id);
                }
                
                // 處理新增和更新
                foreach (var payment in validPayments)
                {
                    payment.SetoffDocumentId = entity.Id;
                    
                    if (payment.Id > 0)
                    {
                        // 更新現有記錄
                        var paymentResult = await SetoffPaymentService.UpdateAsync(payment);
                        if (!paymentResult.IsSuccess)
                        {
                            await NotificationService.ShowErrorAsync($"收款記錄更新失敗：{paymentResult.ErrorMessage}");
                            return;
                        }
                    }
                    else
                    {
                        // 新增記錄
                        var paymentResult = await SetoffPaymentService.CreateAsync(payment);
                        if (!paymentResult.IsSuccess)
                        {
                            await NotificationService.ShowErrorAsync($"收款記錄新增失敗：{paymentResult.ErrorMessage}");
                            return;
                        }
                    }
                }
            }
            
            // ===== 儲存預收付款項 =====
            // 需要區分兩種情況：
            // 1. 預收/預付（Amount > 0 且非轉沖款類型）→ 儲存到 SetoffPrepayment 表
            // 2. 轉沖款（UsedAmount > 0 且為轉沖款類型）→ 儲存到 SetoffPrepaymentUsage 表
            
            if (entity.Id > 0)
            {
                // 取得所有預收付類型資訊，用於判斷是否為轉沖款類型
                var allPrepaymentTypes = await PrepaymentTypeService.GetAllAsync();
                
                // === 處理預收/預付主記錄（排除轉沖款類型）===
                var prepaymentRecords = setoffPrepayments
                    .Where(p => 
                    {
                        // 必須有 Amount > 0
                        if (p.Amount <= 0) return false;
                        
                        // 檢查是否為轉沖款類型
                        var prepaymentType = allPrepaymentTypes.FirstOrDefault(pt => pt.Id == p.PrepaymentTypeId);
                        if (prepaymentType != null && prepaymentType.Name.Contains("轉沖款"))
                        {
                            return false;  // 轉沖款類型，不納入預收/預付儲存
                        }
                        
                        return true;  // 預收/預付類型
                    })
                    .ToList();
                
                // 取得現有的預收付款項主記錄
                var existingPrepayments = await SetoffPrepaymentService.GetBySetoffDocumentIdAsync(entity.Id);
                var existingPrepaymentIds = existingPrepayments.Select(p => p.Id).ToList();
                var currentPrepaymentIds = prepaymentRecords.Where(p => p.Id > 0).Select(p => p.Id).ToList();
                
                // 刪除不再存在的預收付款項記錄
                var prepaymentsToDelete = existingPrepayments.Where(ep => !currentPrepaymentIds.Contains(ep.Id)).ToList();
                foreach (var prepaymentToDelete in prepaymentsToDelete)
                {
                    await SetoffPrepaymentService.DeleteAsync(prepaymentToDelete.Id);
                }
                
                // 處理新增和更新
                foreach (var prepayment in prepaymentRecords)
                {
                    prepayment.SetoffDocumentId = entity.Id;
                    
                    if (prepayment.Id > 0)
                    {
                        // 更新現有記錄
                        var prepaymentResult = await SetoffPrepaymentService.UpdateAsync(prepayment);
                        if (!prepaymentResult.IsSuccess)
                        {
                            await NotificationService.ShowErrorAsync($"預收付款項更新失敗：{prepaymentResult.ErrorMessage}");
                            return;
                        }
                    }
                    else
                    {
                        // 新增記錄
                        var prepaymentResult = await SetoffPrepaymentService.CreateAsync(prepayment);
                        if (!prepaymentResult.IsSuccess)
                        {
                            await NotificationService.ShowErrorAsync($"預收付款項新增失敗：{prepaymentResult.ErrorMessage}");
                            return;
                        }
                    }
                }
                
                // === 處理轉沖款使用記錄（根據類型名稱判斷）===
                var usageRecords = setoffPrepayments
                    .Where(p => 
                    {
                        // 必須有 UsedAmount > 0
                        if (p.UsedAmount <= 0) return false;
                        
                        // 檢查是否為轉沖款類型
                        var prepaymentType = allPrepaymentTypes.FirstOrDefault(pt => pt.Id == p.PrepaymentTypeId);
                        if (prepaymentType != null && prepaymentType.Name.Contains("轉沖款"))
                        {
                            return true;  // 轉沖款類型
                        }
                        
                        return false;
                    })
                    .ToList();
                
                // 取得現有的使用記錄
                var existingUsages = await SetoffPrepaymentUsageService.GetBySetoffDocumentIdAsync(entity.Id);
                
                // 先刪除所有既有的使用記錄（因為前端傳來的是完整清單）
                await SetoffPrepaymentUsageService.DeleteBySetoffDocumentIdAsync(entity.Id);
                
                // 建立新的使用記錄
                foreach (var prepayment in usageRecords)
                {
                    // 從 SourceDocumentCode 查詢原始預收付款項
                    var sourcePrepayment = await SetoffPrepaymentService.GetBySourceDocumentCodeAsync(prepayment.SourceDocumentCode);
                    if (sourcePrepayment == null)
                    {
                        await NotificationService.ShowErrorAsync($"找不到來源預收付款項：{prepayment.SourceDocumentCode}");
                        return;
                    }
                    
                    // 建立使用記錄
                    var usage = new SetoffPrepaymentUsage
                    {
                        SetoffPrepaymentId = sourcePrepayment.Id,
                        SetoffDocumentId = entity.Id,
                        UsedAmount = prepayment.UsedAmount,
                        UsageDate = DateTime.Now,
                        Remarks = $"沖款單 {entity.Code} 使用"
                    };
                    
                    var usageResult = await SetoffPrepaymentUsageService.CreateAsync(usage);
                    if (!usageResult.IsSuccess)
                    {
                        await NotificationService.ShowErrorAsync($"預收付款項使用記錄新增失敗：{usageResult.ErrorMessage}");
                        return;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"儲存明細時發生錯誤：{ex.Message}");
            throw; // 重新拋出例外，讓 GenericEditModalComponent 知道儲存失敗
        }
    }
    /// <summary>
    /// 處理商品明細變更事件，更新沖款單的各項金額欄位
    /// </summary>
    /// <remarks>
    /// 欄位說明：
    /// - 本期應收 (TotalSetoffAmount): 被選入的來源明細的原始應收/付總金額（不會因為輸入本次沖款而改變）
    /// - 本期沖銷 (CurrentSetoffAmount): 本次沖款（不包含折讓）
    /// - 本期已收 (TotalCollectionAmount): 實際收到的款項
    /// - 本期折讓 (TotalAllowanceAmount): 本次折讓的總額（單獨顯示，不計入本期沖銷）
    /// </remarks>
    private void HandleProductDetailsChanged(List<SetoffProductDetail> details)
    {
        editModalComponent?.MarkDirty();
        setoffProductDetails = details;

        // 更新總金額
        if (editModalComponent?.Entity != null)
        {
            // 【本期應收】= 被選入的來源明細的原始應收/付總金額
            // 這個值應該從 SetoffProductTable 取得來源明細的總金額
            // 只在明細被選入時計算，不會因為輸入本次沖款金額而改變
            // 退貨單據會以負數計算（例如：銷貨600 + 銷貨退回-300 = 300）
            if (setoffProductDetailManager != null)
            {
                editModalComponent.Entity.TotalSetoffAmount = setoffProductDetailManager.GetSourceTotalAmount();
            }
            
            // 【本期沖銷】= 本次沖款（不包含折讓）
            // 退貨單據會以負數計算（例如：銷貨沖款100 + 銷貨退回沖款-50 = 50）
            if (setoffProductDetailManager != null)
            {
                editModalComponent.Entity.CurrentSetoffAmount = setoffProductDetailManager.GetCurrentSetoffTotal();
            }
            else
            {
                editModalComponent.Entity.CurrentSetoffAmount = details.Sum(d => d.CurrentSetoffAmount);
            }
            
            // 【本期已收】不在此更新，由收款記錄（HandlePaymentsChanged）和預收付款項（HandlePrepaymentsChanged）決定
            // 【本期折讓】= 本次折讓的總額（單獨顯示，不計入本期沖銷）
            // 退貨單據會以負數計算
            if (setoffProductDetailManager != null)
            {
                editModalComponent.Entity.TotalAllowanceAmount = setoffProductDetailManager.GetCurrentAllowanceTotal();
            }
            else
            {
                editModalComponent.Entity.TotalAllowanceAmount = details.Sum(d => d.CurrentAllowanceAmount);
            }
        }
        
        StateHasChanged();
    }
    
    /// <summary>
    /// 處理收款記錄變更事件
    /// </summary>
    /// <remarks>
    /// 收款記錄變更時即時更新本期已收欄位
    /// 公式：本期已收 + 預收沖款 = 本期沖銷 + 本期折讓 + 本期預收
    /// 因此：本期已收 = 本期沖銷 + 本期折讓 + 本期預收 - 預收沖款
    /// 或者：本期已收 = Payment收款 + Payment折讓
    /// </remarks>
    private Task HandlePaymentsChanged(List<SetoffPayment> payments)
    {
        setoffPayments = payments;
        
        if (editModalComponent?.Entity != null && setoffPaymentTable != null)
        {
            var receivedFromPayments = setoffPaymentTable.GetTotalReceivedAmount();
            var allowanceFromPayments = setoffPaymentTable.GetTotalAllowanceAmount();
            
            // ===== 更新本期已收 =====
            // 本期已收 = Payment收款 + Payment折讓（不包含本期預收）
            // 本期預收是獨立的欄位，不應該加到本期已收
            editModalComponent.Entity.TotalCollectionAmount = receivedFromPayments + allowanceFromPayments;
        }
        
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    /// <summary>
    /// 處理預收付款項變更事件
    /// </summary>
    /// <remarks>
    /// 預收付款項變更時更新預收付款項相關的欄位
    /// - 本期預收/付（CurrentPrepaymentAmount）：新建立的預收付款項金額
    /// - 預收/付沖款（PrepaymentSetoffAmount）：使用既有預收付款項進行沖款的金額
    /// 注意：預收付款項不影響「本期已收」，「本期已收」只由收款記錄決定
    /// </remarks>
    private async Task HandlePrepaymentsChanged(List<SetoffPrepayment> prepayments)
    {
        setoffPrepayments = prepayments;
        
        if (editModalComponent?.Entity != null)
        {
            // 計算預收付款項金額
            var prepaymentUsedAmount = 0m;  // 轉沖款類型（使用既有預收付款項進行沖款）
            var prepaymentAmount = 0m;       // 預收/付類型（建立新的預收付款項）
            
            // 需要判斷預收付類型，需要先載入 PrepaymentType 資料
            var allPrepaymentTypes = await PrepaymentTypeService.GetAllAsync();
            foreach (var prepayment in prepayments)
            {
                var prepaymentType = allPrepaymentTypes.FirstOrDefault(pt => pt.Id == prepayment.PrepaymentTypeId);
                if (prepaymentType != null && prepaymentType.Name.Contains("轉沖款"))
                {
                    // 預收/付轉沖款類型：累加 UsedAmount
                    prepaymentUsedAmount += prepayment.UsedAmount;
                }
                else
                {
                    // 預收/付類型：累加 Amount
                    prepaymentAmount += prepayment.Amount;
                }
            }
            
            // ===== 更新預收付款項相關的顯示欄位 =====
            // 本期預收/付：顯示新建立的預收付款項金額
            editModalComponent.Entity.CurrentPrepaymentAmount = prepaymentAmount;
            
            // 預收/付沖款：顯示使用既有預收付款項進行沖款的金額
            editModalComponent.Entity.PrepaymentSetoffAmount = prepaymentUsedAmount;
            
            // ===== 不需要觸發本期已收的重新計算 =====
            // 本期已收只由收款記錄決定，與預收付款項無關
        }
        
        StateHasChanged();
    }
    private async Task<SetoffDocument?> LoadSetoffDocumentData()
    {
        try
        {
            SetoffDocument? setoffDocument;
            
            if (!SetoffDocumentId.HasValue)
            {
                // 新增模式 - 根據類型決定前綴
                var typePrefix = (DefaultSetoffType ?? SetoffType.AccountsReceivable) == SetoffType.AccountsReceivable ? "SO" : "PO";
                
                // 取得預設公司
                var primaryCompany = await CompanyService.GetPrimaryCompanyAsync();
                
                setoffDocument = new SetoffDocument
                {
                    Code = await EntityCodeGenerationHelper.GenerateForEntity<SetoffDocument, ISetoffDocumentService>(SetoffDocumentService, typePrefix),
                    SetoffDate = DateTime.Today,
                    SetoffType = DefaultSetoffType ?? SetoffType.AccountsReceivable,
                    TotalSetoffAmount = 0,
                    CurrentPrepaymentAmount = 0,
                    PrepaymentSetoffAmount = 0,
                    CompanyId = primaryCompany?.Id ?? 0 // 設定預設公司
                };
                
                // 處理預填參數（進貨轉沖款等場景）
                if (PrefilledSupplierId.HasValue && PrefilledSupplierId.Value > 0)
                {
                    setoffDocument.RelatedPartyId = PrefilledSupplierId.Value;
                    setoffDocument.RelatedPartyType = "Supplier";
                    setoffDocument.SetoffType = SetoffType.AccountsPayable;
                    
                    // 設定進貨單篩選ID
                    if (PrefilledPurchaseReceivingId.HasValue)
                    {
                        filterPurchaseReceivingId = PrefilledPurchaseReceivingId.Value;
                    }
                    // 設定進貨退出篩選ID
                    if (PrefilledPurchaseReturnId.HasValue)
                    {
                        filterPurchaseReturnId = PrefilledPurchaseReturnId.Value;
                    }
                }
                
                // 處理預填參數（銷貨轉沖款等場景）
                if (PrefilledCustomerId.HasValue && PrefilledCustomerId.Value > 0)
                {
                    setoffDocument.RelatedPartyId = PrefilledCustomerId.Value;
                    setoffDocument.RelatedPartyType = "Customer";
                    setoffDocument.SetoffType = SetoffType.AccountsReceivable;
                    
                    // 設定銷貨出貨篩選ID
                    if (PrefilledSalesDeliveryId.HasValue)
                    {
                        filterSalesDeliveryId = PrefilledSalesDeliveryId.Value;
                    }
                    // 設定銷貨退回篩選ID
                    if (PrefilledSalesReturnId.HasValue)
                    {
                        filterSalesReturnId = PrefilledSalesReturnId.Value;
                    }
                }
                
                // 新增模式：清空商品明細、收款記錄和預收付款項
                setoffProductDetails = new List<SetoffProductDetail>();
                setoffPayments = new List<SetoffPayment>();
                setoffPrepayments = new List<SetoffPrepayment>(); 
            }
            else
            {
                // 編輯模式
                setoffDocument = await SetoffDocumentService.GetByIdAsync(SetoffDocumentId.Value);
                
                // 載入商品明細
                setoffProductDetails = await SetoffProductDetailService.GetBySetoffDocumentIdAsync(SetoffDocumentId.Value);
                
                // 載入收款記錄
                setoffPayments = await SetoffPaymentService.GetBySetoffDocumentIdAsync(SetoffDocumentId.Value);
                
                // 載入預收付款項（包含主記錄和使用記錄）
                setoffPrepayments = new List<SetoffPrepayment>();
                
                // 1. 載入預收/預付主記錄（Amount > 0）
                var prepaymentRecords = await SetoffPrepaymentService.GetBySetoffDocumentIdAsync(SetoffDocumentId.Value);
                setoffPrepayments.AddRange(prepaymentRecords);
                
                // 2. 載入轉沖款使用記錄（UsedAmount > 0），轉換為 SetoffPrepayment 格式供前端顯示
                var usageRecords = await SetoffPrepaymentUsageService.GetBySetoffDocumentIdAsync(SetoffDocumentId.Value);
                
                // 取得所有預收付類型，用於查詢「轉沖款」類型ID
                var allPrepaymentTypes = await PrepaymentTypeService.GetAllAsync();
                
                foreach (var usage in usageRecords)
                {
                    // 根據來源預收付款項的類型，判斷應該使用哪個「轉沖款」類型
                    // 來源是「預收」→ 使用「預收轉沖款」
                    // 來源是「預付」→ 使用「預付轉沖款」
                    var sourceType = usage.SetoffPrepayment.PrepaymentType?.Name ?? string.Empty;
                    var transferTypeName = sourceType.Contains("預收") ? "預收轉沖款" : "預付轉沖款";
                    var transferType = allPrepaymentTypes.FirstOrDefault(pt => pt.Name == transferTypeName);
                    
                    if (transferType == null)
                    {
                        await NotificationService.ShowErrorAsync($"找不到預收付類型：{transferTypeName}");
                        continue;
                    }
                    
                    // 轉換為 SetoffPrepayment 格式，讓前端組件可以統一處理
                    setoffPrepayments.Add(new SetoffPrepayment
                    {
                        Id = 0,  // 使用記錄沒有 SetoffPrepayment 的 ID
                        PrepaymentTypeId = transferType.Id,  // ✅ 使用「轉沖款」類型的ID
                        SourceDocumentCode = usage.SourcePrepaymentCode ?? usage.SetoffPrepayment.SourceDocumentCode,  // ✅ 優先使用 SourcePrepaymentCode
                        SourcePrepaymentId = usage.SetoffPrepaymentId,  // ✅ 直接使用來源預收付款項的 ID
                        Amount = usage.SetoffPrepayment.Amount,  // ✅ 保存來源的總金額（用於前端顯示「總金額」欄位）
                        UsedAmount = usage.UsedAmount,  // 轉沖款：記錄使用金額
                        CustomerId = usage.SetoffPrepayment.CustomerId,
                        SupplierId = usage.SetoffPrepayment.SupplierId,
                        SetoffDocumentId = SetoffDocumentId.Value,
                        Remarks = string.Empty  // ✅ 備註恢復正常用途，不再儲存 SOURCE_ID
                    });
                }
                
                // 編輯模式：載入資料後，重新計算預收付款項相關欄位
                if (setoffDocument != null)
                {
                    var prepaymentUsedAmount = 0m;  // 轉沖款類型
                    var prepaymentAmount = 0m;       // 預收/付類型
                    
                    foreach (var prepayment in setoffPrepayments)
                    {
                        var prepaymentType = allPrepaymentTypes.FirstOrDefault(pt => pt.Id == prepayment.PrepaymentTypeId);
                        if (prepaymentType != null && prepaymentType.Name.Contains("轉沖款"))
                        {
                            prepaymentUsedAmount += prepayment.UsedAmount;
                        }
                        else
                        {
                            prepaymentAmount += prepayment.Amount;
                        }
                    }
                    
                    // 設定預收付款項相關欄位
                    setoffDocument.CurrentPrepaymentAmount = prepaymentAmount;
                    setoffDocument.PrepaymentSetoffAmount = prepaymentUsedAmount;
                }
            }
            
            // 資料載入後，重新初始化表單欄位以正確顯示客戶或廠商欄位
            // 使用 Task.Run 確保在下一個渲染週期執行
            _ = Task.Run(async () =>
            {
                await InvokeAsync(async () =>
                {
                    await InitializeFormFieldsAsync();
                    StateHasChanged();
                });
            });
            
            return setoffDocument;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入沖款單資料時發生錯誤：{ex.Message}");
            return null;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // 載入公司列表
            companies = await CompanyService.GetAllAsync();
            
            // 載入客戶列表（用於應收帳款）
            customers = await CustomerService.GetAllAsync();
            
            // 載入廠商列表（用於應付帳款）
            suppliers = await SupplierService.GetAllAsync();
            
            // 配置 AutoComplete
            autoCompleteConfig = new AutoCompleteConfigBuilder<SetoffDocument>()
                .AddField(nameof(SetoffDocument.CompanyId), "CompanyName", companies)
                .AddField("CustomerId", "CompanyName", customers)
                .AddField("SupplierId", "CompanyName", suppliers)
                .Build();
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("載入沖款單編輯相關資料時發生錯誤");
            companies = new List<Company>();
            customers = new List<Customer>();
            suppliers = new List<Supplier>();
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            // 動態加入客戶或廠商欄位 - 先判斷類型
            var currentSetoffType = editModalComponent?.Entity?.SetoffType ?? DefaultSetoffType ?? SetoffType.AccountsReceivable;
            
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SetoffDocument.Code),
                    Label = L["Field.SetoffCode"],
                    FieldType = FormFieldType.Text,
                    Placeholder = L["Placeholder.PleaseInput", L["Field.SetoffCode"]],
                    IsRequired = true,
                    MaxLength = 50,
                    HelpText = "沖款單的唯一識別號碼，新增時系統會自動產生，也可手動修改"
                }
            };

            // 根據沖款類型動態加入客戶或廠商欄位（緊接在沖款單號之後）
            if (currentSetoffType == SetoffType.AccountsReceivable)
            {
                // 應收帳款：顯示客戶欄位
                formFields.Add(new()
                {
                    PropertyName = "CustomerId",
                    Label = L["Entity.Customer"],
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = L["Placeholder.PleaseInputOrSelect", L["Entity.Customer"]],
                    MinSearchLength = 0,
                    IsRequired = true,
                    HelpText = "選擇應收帳款的客戶"
                });
            }
            else if (currentSetoffType == SetoffType.AccountsPayable)
            {
                // 應付帳款：顯示廠商欄位
                formFields.Add(new()
                {
                    PropertyName = "SupplierId",
                    Label = L["Entity.Supplier"],
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = L["Placeholder.PleaseInputOrSelect", L["Entity.Supplier"]],
                    MinSearchLength = 0,
                    IsRequired = true,
                    HelpText = "選擇應付帳款的廠商"
                });
            }

            // 繼續加入其他共用欄位
            formFields.AddRange(new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SetoffDocument.SetoffDate),
                    Label = L["Field.SetoffDate"],
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "沖款單的建立日期"
                },
                new()
                {
                    PropertyName = nameof(SetoffDocument.CompanyId),
                    Label = L["Entity.Company"],
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = companies.Count == 1 ? companies.First().CompanyName : "請輸入或選擇公司",
                    MinSearchLength = 0, // 允許空白搜尋以顯示所有選項（當只有一筆時會自動顯示）
                    IsRequired = true,
                    HelpText = "選擇沖款單所屬的公司"
                },
                new()
                {
                    PropertyName = "FilterStartDate",
                    Label = L["Field.StartDate"],
                    FieldType = FormFieldType.Date,
                    IsRequired = false,
                    HelpText = "篩選該日期之後的銷貨、銷貨退回、入庫、入庫退出單據"
                },
                new()
                {
                    PropertyName = "FilterEndDate",
                    Label = L["Field.EndDate"],
                    FieldType = FormFieldType.Date,
                    IsRequired = false,
                    HelpText = "篩選該日期之前的銷貨、銷貨退回、入庫、入庫退出單據"
                }
            });

            // 根據沖款類型決定欄位標籤
            var isReceivable = currentSetoffType == SetoffType.AccountsReceivable;
            var receivableOrPayableLabel = isReceivable ? "應收" : "應付";
            var receivedOrPaidLabel = isReceivable ? "已收" : "已付";
            var prepaymentLabel = isReceivable ? "預收" : "預付";
            var prepaymentSetoffLabel = isReceivable ? "預收沖款" : "預付沖款";
            
            // 繼續加入金額相關欄位
            formFields.AddRange(new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SetoffDocument.TotalSetoffAmount),
                    Label = $"本期{receivableOrPayableLabel}",
                    FieldType = FormFieldType.Number,
                    Placeholder = L["Placeholder.AutoCalculated"],
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "沖款單的總金額",
                },
                new()
                {
                    PropertyName = nameof(SetoffDocument.TotalCollectionAmount),
                    Label = $"本期{receivedOrPaidLabel}",
                    FieldType = FormFieldType.Number,
                    Placeholder = L["Placeholder.AutoCalculated"],
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = $"實際{receivedOrPaidLabel.Substring(1)}的款項總額",
                },
                new()
                {
                    PropertyName = nameof(SetoffDocument.CurrentSetoffAmount),
                    Label = L["Field.CurrentWriteOff"],
                    FieldType = FormFieldType.Number,
                    Placeholder = L["Placeholder.AutoCalculated"],
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "本次沖款單所沖銷的金額",
                },
                new()
                {
                    PropertyName = nameof(SetoffDocument.TotalAllowanceAmount),
                    Label = L["Field.CurrentDiscount"],
                    FieldType = FormFieldType.Number,
                    Placeholder = L["Placeholder.AutoCalculated"],
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "折讓抵銷的總額",
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SetoffDocument.CurrentPrepaymentAmount),
                    Label = $"本期{prepaymentLabel}",
                    FieldType = FormFieldType.Number,
                    Placeholder = L["Placeholder.AutoCalculated"],
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = $"本次{prepaymentLabel}的總額",
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SetoffDocument.PrepaymentSetoffAmount),
                    Label = prepaymentSetoffLabel,
                    FieldType = FormFieldType.Number,
                    Placeholder = L["Placeholder.AutoCalculated"],
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = $"{prepaymentSetoffLabel}的總額",
                },

                FormFieldConfigurationHelper.CreateRemarksField<SetoffDocument>(),
            });


            
            // 動態設定表單區段 - 使用 FormSectionHelper
            var helper = FormSectionHelper<SetoffDocument>.Create()
                .AddToSection(FormSectionNames.BasicInfo, sd => sd.Code);
            
            // 根據沖款類型動態加入客戶或廠商欄位（在單號之後）
            if (currentSetoffType == SetoffType.AccountsReceivable)
            {
                helper.AddCustomFields(FormSectionNames.BasicInfo, "CustomerId");
            }
            else if (currentSetoffType == SetoffType.AccountsPayable)
            {
                helper.AddCustomFields(FormSectionNames.BasicInfo, "SupplierId");
            }
            
            // 加入公司欄位、日期篩選欄位和沖款日期
            helper.AddToSection(FormSectionNames.BasicInfo, sd => sd.CompanyId)
                .AddCustomFields(FormSectionNames.BasicInfo, 
                    "FilterStartDate", 
                    "FilterEndDate")
                .AddToSection(FormSectionNames.BasicInfo, sd => sd.SetoffDate);
            
            // 加入金額相關區段
            formSections = helper
                .AddToSection(FormSectionNames.AmountInfo,
                    sd => sd.TotalSetoffAmount,
                    sd => sd.TotalCollectionAmount,
                    sd => sd.CurrentSetoffAmount,
                    sd => sd.TotalAllowanceAmount,
                    sd => sd.CurrentPrepaymentAmount,
                    sd => sd.PrepaymentSetoffAmount)
                .AddToSection(FormSectionNames.OtherInfo,
                    sd => sd.Remarks)
                .Build();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化表單欄位時發生錯誤");
        }
    }

    /// <summary>
    /// 欄位變更事件處理
    /// </summary>
    private Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // 處理客戶欄位變更
            if (fieldChange.PropertyName == "CustomerId" && editModalComponent?.Entity != null)
            {
                if (fieldChange.Value != null && int.TryParse(fieldChange.Value.ToString(), out int customerId))
                {
                    editModalComponent.Entity.RelatedPartyId = customerId;
                    editModalComponent.Entity.RelatedPartyType = "Customer";
                    
                    // 更新 RelatedPartyName
                    var customer = customers.FirstOrDefault(c => c.Id == customerId);
                    if (customer != null)
                    {
                        editModalComponent.Entity.RelatedPartyName = customer.CompanyName ?? "";
                    }

                }
            }

            // 處理廠商欄位變更
            if (fieldChange.PropertyName == "SupplierId" && editModalComponent?.Entity != null)
            {
                if (fieldChange.Value != null && int.TryParse(fieldChange.Value.ToString(), out int supplierId))
                {
                    editModalComponent.Entity.RelatedPartyId = supplierId;
                    editModalComponent.Entity.RelatedPartyType = "Supplier";
                    
                    // 更新 RelatedPartyName
                    var supplier = suppliers.FirstOrDefault(s => s.Id == supplierId);
                    if (supplier != null)
                    {
                        editModalComponent.Entity.RelatedPartyName = supplier.CompanyName;
                    }

                }
            }

            // 處理日期篩選變更
            if (fieldChange.PropertyName == "FilterStartDate")
            {
                if (fieldChange.Value != null && DateTime.TryParse(fieldChange.Value.ToString(), out DateTime startDate))
                {
                    filterStartDate = startDate;
                }
                else
                {
                    filterStartDate = null;
                }
                StateHasChanged();
            }
            
            if (fieldChange.PropertyName == "FilterEndDate")
            {
                if (fieldChange.Value != null && DateTime.TryParse(fieldChange.Value.ToString(), out DateTime endDate))
                {
                    filterEndDate = endDate;
                }
                else
                {
                    filterEndDate = null;
                }
                StateHasChanged();
            }
        }
        catch (Exception)
        {
            // 忽略錯誤
        }

        return Task.CompletedTask;
    }

    // ===== 列印相關方法 =====

    /// <summary>
    /// 根據沖款類型取得對應的報表 ID
    /// </summary>
    private string GetCurrentReportId()
    {
        var currentType = editModalComponent?.Entity?.SetoffType ?? DefaultSetoffType ?? SetoffType.AccountsReceivable;
        return currentType == SetoffType.AccountsReceivable
            ? ReportIds.AccountsReceivableSetoff
            : ReportIds.AccountsPayableSetoff;
    }

    /// <summary>
    /// 根據沖款類型取得報表預覽標題
    /// </summary>
    private string GetReportPreviewTitle()
    {
        var currentType = editModalComponent?.Entity?.SetoffType ?? DefaultSetoffType ?? SetoffType.AccountsReceivable;
        return currentType == SetoffType.AccountsReceivable
            ? "應收沖款單預覽"
            : "應付沖款單預覽";
    }

    /// <summary>
    /// 根據沖款類型取得列印文件名稱
    /// </summary>
    private string GetDocumentName(SetoffDocument entity)
    {
        var prefix = entity.IsAccountsReceivable ? "應收沖款單" : "應付沖款單";
        return $"{prefix}-{entity.Code}";
    }

    /// <summary>
    /// 取得關聯方名稱（客戶或廠商名稱）
    /// </summary>
    private string? GetRelatedPartyName()
    {
        if (editModalComponent?.Entity == null || editModalComponent.Entity.RelatedPartyId <= 0)
            return null;
            
        if (editModalComponent.Entity.SetoffType == SetoffType.AccountsReceivable)
        {
            // 應收帳款 - 取得客戶名稱
            var customer = customers.FirstOrDefault(c => c.Id == editModalComponent.Entity.RelatedPartyId);
            return customer?.CompanyName;
        }
        else
        {
            // 應付帳款 - 取得廠商名稱
            var supplier = suppliers.FirstOrDefault(s => s.Id == editModalComponent.Entity.RelatedPartyId);
            return supplier?.CompanyName;
        }
    }

    /// <summary>
    /// 配置自訂模組
    /// </summary>
    private List<GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule> GetCustomModules()
    {
        try
        {
            if (editModalComponent == null)
            {
                return new List<GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule>();
            }

            return new List<GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule>
            {
                new GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule
                {
                    Title = "",
                    Content = CreateSetoffProductDetailManagerContent(),
                    Order = 1
                },
                new GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule
                {
                    Title = "",
                    Content = CreateSetoffPaymentDetailManagerContent(),
                    Order = 2
                },
                new GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule
                {
                    Title = "",
                    Content = CreateSetoffPrepaymentDetailManagerContent(),
                    Order = 3
                }
            };
        }
        catch
        {
            return new List<GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule>();
        }
    }

    /// <summary>
    /// 創建沖銷商品明細管理器內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateSetoffProductDetailManagerContent() => __builder =>
    {
        <DetailSectionWrapper IsEntityReady="@(editModalComponent?.Entity != null)"
                              EntityLoadingVariant="DetailSectionWrapper.LoadingVariant.Silent"
                              IsPreconditionMet="@(editModalComponent?.Entity?.RelatedPartyId > 0)"
                              PreconditionMessage="@($"請先選擇{(editModalComponent?.Entity?.SetoffType == SetoffType.AccountsReceivable ? "客戶" : "廠商")}以載入商品明細")">
            <SetoffProductTable @ref="setoffProductDetailManager"
                                SetoffDocumentId="@SetoffDocumentId"
                                SetoffType="@editModalComponent!.Entity.SetoffType"
                                RelatedPartyId="@editModalComponent.Entity.RelatedPartyId"
                                RelatedPartyType="@editModalComponent.Entity.RelatedPartyType"
                                RelatedPartyName="@GetRelatedPartyName()"
                                StartDate="@filterStartDate"
                                EndDate="@filterEndDate"
                                ExistingDetails="@setoffProductDetails"
                                OnDetailsChanged="@HandleProductDetailsChanged"
                                IsReadOnly="@IsReadOnly"
                                DataVersion="@_productDetailsDataVersion"
                                IsParentLoading="@(editModalComponent?.IsLoading ?? false)" />
        </DetailSectionWrapper>
    };
    
    /// <summary>
    /// 創建收款記錄管理器內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateSetoffPaymentDetailManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null && editModalComponent.Entity.RelatedPartyId > 0)
            {
                <SetoffPaymentTable
                    @ref="setoffPaymentTable"
                    SetoffDocumentId="@SetoffDocumentId"
                    SetoffType="@(editModalComponent.Entity.SetoffType)"
                    ExistingPayments="@setoffPayments"
                    OnPaymentsChanged="@HandlePaymentsChanged"
                    IsReadOnly="@IsReadOnly"
                    DataVersion="@_paymentDetailsDataVersion"
                    IsParentLoading="@(editModalComponent?.IsLoading ?? false)" />
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                載入收款記錄管理器時發生錯誤,請重新整理頁面。
            </div>
        }
    };
    /// <summary>
    /// 創建預收付款項管理器內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateSetoffPrepaymentDetailManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null && editModalComponent.Entity.RelatedPartyId > 0)
            {
                <SetoffPrepaymentTable @ref="setoffPrepaymentDetailManager"
                                                       SetoffDocumentId="@SetoffDocumentId"
                                                       SetoffType="@editModalComponent.Entity.SetoffType"
                                                       CustomerId="@(editModalComponent.Entity.SetoffType == SetoffType.AccountsReceivable ? editModalComponent.Entity.RelatedPartyId : null)"
                                                       SupplierId="@(editModalComponent.Entity.SetoffType == SetoffType.AccountsPayable ? editModalComponent.Entity.RelatedPartyId : null)"
                                                       SetoffDocumentNumber="@editModalComponent.Entity.Code"
                                                       ExistingPrepayments="@setoffPrepayments"
                                                       OnPrepaymentsChanged="@HandlePrepaymentsChanged"
                                                       OnOpenRelatedDocument="@HandleOpenRelatedDocument"
                                                       IsReadOnly="@IsReadOnly"
                                                       DataVersion="@_prepaymentDetailsDataVersion"
                                                       IsParentLoading="@(editModalComponent?.IsLoading ?? false)" />
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                載入預收付款項管理器時發生錯誤,請重新整理頁面。
            </div>
        }
    };

    /// <summary>
    /// 處理開啟相關單據的事件（使用預收付款項的沖款單）
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            if (args.type == RelatedDocumentType.SetoffDocument)
            {
                // 開啟另一個沖款單 Modal（使用了預收付款項的沖款單）
                // 顯示訊息通知使用者
                await NotificationService.ShowInfoAsync(
                    $"即將開啟相關沖款單（ID: {args.id}）\n\n" +
                    "注意：目前系統不支援在編輯模式下開啟多層沖款單。\n" +
                    "請關閉目前的沖款單後，從沖款單列表中開啟目標沖款單。",
                    "功能提示");
            }
            else
            {
                await NotificationService.ShowWarningAsync($"不支援的單據類型：{args.type}");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"開啟單據失敗：{ex.Message}");
        }
    }

    // ===== 公開方法（供外部組件調用） =====
    
    /// <summary>
    /// 開啟新增沖款單 Modal 並預填進貨單資訊（公開方法供外部調用）
    /// </summary>
    /// <param name="supplierId">廠商ID</param>
    /// <param name="purchaseReceivingId">進貨單ID</param>
    /// <remarks>
    /// 此方法用於「進貨轉沖款」功能，會：
    /// 1. 設定沖款類型為「應付帳款」
    /// 2. 預填廠商資訊
    /// 3. 自動載入指定進貨單的未結清明細
    /// </remarks>
    public async Task ShowAddModalWithPrefilledReceiving(int supplierId, int purchaseReceivingId)
    {
        try
        {
            // 使用 DocumentConversionHelper 統一處理轉單邏輯
            var success = await DocumentConversionHelper.ShowConversionModalAsync(
                setPrefilledValues: () =>
                {
                    SetoffDocumentId = null;
                    PrefilledSupplierId = supplierId;
                    PrefilledPurchaseReceivingId = purchaseReceivingId;
                    DefaultSetoffType = SetoffType.AccountsPayable;
                    // 設定篩選ID（確保明細管理器渲染時就能使用正確的篩選參數）
                    filterPurchaseReceivingId = purchaseReceivingId;
                    shouldAutoLoadFromReceiving = true;
                },
                isVisibleChanged: IsVisibleChanged,
                autoLoadAction: async () =>
                {
                    shouldAutoLoadFromReceiving = false;
                    if (setoffProductDetailManager != null)
                    {
                        await setoffProductDetailManager.LoadDetailsFromPurchaseReceiving(purchaseReceivingId);
                    }
                },
                detailManagerReady: () => setoffProductDetailManager != null,
                shouldAutoLoad: () => shouldAutoLoadFromReceiving,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("轉單流程執行失敗");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledReceiving), GetType(), 
                additionalData: $"開啟預填沖款單Modal失敗 - SupplierId: {supplierId}, ReceivingId: {purchaseReceivingId}");
            await NotificationService.ShowErrorAsync("開啟沖款單時發生錯誤");
        }
    }
    
    /// <summary>
    /// 開啟新增沖款單 Modal 並預填進貨退出資訊（公開方法供外部調用）
    /// </summary>
    /// <param name="supplierId">廠商ID</param>
    /// <param name="purchaseReturnId">進貨退出ID</param>
    public async Task ShowAddModalWithPrefilledPurchaseReturn(int supplierId, int purchaseReturnId)
    {
        try
        {
            var success = await DocumentConversionHelper.ShowConversionModalAsync(
                setPrefilledValues: () =>
                {
                    SetoffDocumentId = null;
                    PrefilledSupplierId = supplierId;
                    PrefilledPurchaseReturnId = purchaseReturnId;
                    DefaultSetoffType = SetoffType.AccountsPayable;
                    filterPurchaseReturnId = purchaseReturnId;
                    shouldAutoLoadFromPurchaseReturn = true;
                },
                isVisibleChanged: IsVisibleChanged,
                autoLoadAction: async () =>
                {
                    shouldAutoLoadFromPurchaseReturn = false;
                    if (setoffProductDetailManager != null)
                    {
                        await setoffProductDetailManager.LoadDetailsFromPurchaseReturn(purchaseReturnId);
                    }
                },
                detailManagerReady: () => setoffProductDetailManager != null,
                shouldAutoLoad: () => shouldAutoLoadFromPurchaseReturn,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("轉單流程執行失敗");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledPurchaseReturn), GetType(), 
                additionalData: $"開啟預填沖款單Modal失敗 - SupplierId: {supplierId}, PurchaseReturnId: {purchaseReturnId}");
            await NotificationService.ShowErrorAsync("開啟沖款單時發生錯誤");
        }
    }
    
    /// <summary>
    /// 開啟新增沖款單 Modal 並預填銷貨出貨資訊（公開方法供外部調用）
    /// </summary>
    /// <param name="customerId">客戶ID</param>
    /// <param name="salesDeliveryId">銷貨出貨ID</param>
    public async Task ShowAddModalWithPrefilledDelivery(int customerId, int salesDeliveryId)
    {
        try
        {
            var success = await DocumentConversionHelper.ShowConversionModalAsync(
                setPrefilledValues: () =>
                {
                    SetoffDocumentId = null;
                    PrefilledCustomerId = customerId;
                    PrefilledSalesDeliveryId = salesDeliveryId;
                    DefaultSetoffType = SetoffType.AccountsReceivable;
                    filterSalesDeliveryId = salesDeliveryId;
                    shouldAutoLoadFromDelivery = true;
                },
                isVisibleChanged: IsVisibleChanged,
                autoLoadAction: async () =>
                {
                    shouldAutoLoadFromDelivery = false;
                    if (setoffProductDetailManager != null)
                    {
                        await setoffProductDetailManager.LoadDetailsFromSalesDelivery(salesDeliveryId);
                    }
                },
                detailManagerReady: () => setoffProductDetailManager != null,
                shouldAutoLoad: () => shouldAutoLoadFromDelivery,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("轉單流程執行失敗");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledDelivery), GetType(), 
                additionalData: $"開啟預填沖款單Modal失敗 - CustomerId: {customerId}, SalesDeliveryId: {salesDeliveryId}");
            await NotificationService.ShowErrorAsync("開啟沖款單時發生錯誤");
        }
    }
    
    /// <summary>
    /// 開啟新增沖款單 Modal 並預填銷貨退回資訊（公開方法供外部調用）
    /// </summary>
    /// <param name="customerId">客戶ID</param>
    /// <param name="salesReturnId">銷貨退回ID</param>
    public async Task ShowAddModalWithPrefilledSalesReturn(int customerId, int salesReturnId)
    {
        try
        {
            var success = await DocumentConversionHelper.ShowConversionModalAsync(
                setPrefilledValues: () =>
                {
                    SetoffDocumentId = null;
                    PrefilledCustomerId = customerId;
                    PrefilledSalesReturnId = salesReturnId;
                    DefaultSetoffType = SetoffType.AccountsReceivable;
                    filterSalesReturnId = salesReturnId;
                    shouldAutoLoadFromSalesReturn = true;
                },
                isVisibleChanged: IsVisibleChanged,
                autoLoadAction: async () =>
                {
                    shouldAutoLoadFromSalesReturn = false;
                    if (setoffProductDetailManager != null)
                    {
                        await setoffProductDetailManager.LoadDetailsFromSalesReturn(salesReturnId);
                    }
                },
                detailManagerReady: () => setoffProductDetailManager != null,
                shouldAutoLoad: () => shouldAutoLoadFromSalesReturn,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("轉單流程執行失敗");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledSalesReturn), GetType(), 
                additionalData: $"開啟預填沖款單Modal失敗 - CustomerId: {customerId}, SalesReturnId: {salesReturnId}");
            await NotificationService.ShowErrorAsync("開啟沖款單時發生錯誤");
        }
    }
}
