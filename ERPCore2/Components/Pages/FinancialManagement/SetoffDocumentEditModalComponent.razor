@* æ²–æ¬¾å–®ç·¨è¼¯çµ„ä»¶ *@
@inject ISetoffDocumentService SetoffDocumentService
@inject ISetoffProductDetailService SetoffProductDetailService
@inject ISetoffPaymentService SetoffPaymentService
@inject ISetoffPrepaymentService SetoffPrepaymentService
@inject ISetoffPrepaymentUsageService SetoffPrepaymentUsageService
@inject IPrepaymentTypeService PrepaymentTypeService
@inject ICompanyService CompanyService
@inject ICustomerService CustomerService
@inject ISupplierService SupplierService
@inject INotificationService NotificationService
@inject ActionButtonHelper ActionButtonHelper

<GenericEditModalComponent TEntity="SetoffDocument" 
                          TService="ISetoffDocumentService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@SetoffDocumentId"
                          Service="@SetoffDocumentService"
                          EntityName="æ²–æ¬¾å–®"
                          EntityNamePlural="æ²–æ¬¾å–®"
                          ModalTitle="@(SetoffDocumentId.HasValue ? "ç·¨è¼¯æ²–æ¬¾å–®" : "æ–°å¢æ²–æ¬¾å–®")"
                          Size="GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@(autoCompleteConfig?.Prefillers)"
                          AutoCompleteCollections="@(autoCompleteConfig?.Collections)"
                          AutoCompleteDisplayProperties="@(autoCompleteConfig?.DisplayProperties)"
                          AutoCompleteValueProperties="@(autoCompleteConfig?.ValueProperties)"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadSetoffDocumentData"
                          UseGenericSave="true"
                          SaveSuccessMessage="@(SetoffDocumentId.HasValue ? "æ²–æ¬¾å–®æ›´æ–°æˆåŠŸ" : "æ²–æ¬¾å–®æ–°å¢æˆåŠŸ")"
                          SaveFailureMessage="æ²–æ¬¾å–®å„²å­˜å¤±æ•—"
                          RequiredPermission="SetoffDocument.Read"
                          CustomValidator="@ValidateBeforeSave"
                          AfterSave="@SaveSetoffDocumentDetailsAsync"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          CustomModules="@GetCustomModules()"
                          OnEntityLoaded="@HandleEntityLoaded">
</GenericEditModalComponent>

<CompanyEditModalComponent @ref="companyEditModal"
                          IsVisible="@companyModalManager.IsModalVisible"
                          IsVisibleChanged="@companyModalManager.HandleModalVisibilityChangedAsync"
                          CompanyId="@companyModalManager.SelectedEntityId"
                          OnCompanySaved="@OnCompanySavedWrapper"
                          OnCancel="@companyModalManager.HandleModalCancelAsync" />

<CustomerEditModalComponent @ref="customerEditModal"
                           IsVisible="@customerModalManager.IsModalVisible"
                           IsVisibleChanged="@customerModalManager.HandleModalVisibilityChangedAsync"
                           CustomerId="@customerModalManager.SelectedEntityId"
                           OnCustomerSaved="@OnCustomerSavedWrapper"
                           OnCancel="@customerModalManager.HandleModalCancelAsync" />

<SupplierEditModalComponent @ref="supplierEditModal"
                           IsVisible="@supplierModalManager.IsModalVisible"
                           IsVisibleChanged="@supplierModalManager.HandleModalVisibilityChangedAsync"
                           SupplierId="@supplierModalManager.SelectedEntityId"
                           OnSupplierSaved="@OnSupplierSavedWrapper"
                           OnCancel="@supplierModalManager.HandleModalCancelAsync" />

@code {
    // ===== å¿…è¦åƒæ•¸ =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SetoffDocumentId { get; set; }
    [Parameter] public SetoffType? DefaultSetoffType { get; set; } // æ–°å¢ï¼šé è¨­çš„æ²–æ¬¾é¡å‹
    [Parameter] public EventCallback<SetoffDocument> OnSetoffDocumentSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    
    // ===== é å¡«åƒæ•¸ï¼ˆç”¨æ–¼è½‰å–®åŠŸèƒ½ï¼‰=====
    // å» å•†ç›¸é—œï¼ˆæ‡‰ä»˜å¸³æ¬¾ï¼‰
    [Parameter] public int? PrefilledSupplierId { get; set; }
    [Parameter] public int? PrefilledPurchaseReceivingId { get; set; }
    [Parameter] public int? PrefilledPurchaseReturnId { get; set; }
    // å®¢æˆ¶ç›¸é—œï¼ˆæ‡‰æ”¶å¸³æ¬¾ï¼‰
    [Parameter] public int? PrefilledCustomerId { get; set; }
    [Parameter] public int? PrefilledSalesDeliveryId { get; set; }
    [Parameter] public int? PrefilledSalesReturnId { get; set; }

    // ===== å…§éƒ¨ç‹€æ…‹ =====
    private GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // è½‰å–®è‡ªå‹•è¼‰å…¥æ§åˆ¶
    private bool shouldAutoLoadFromReceiving = false;
    private bool shouldAutoLoadFromPurchaseReturn = false;
    private bool shouldAutoLoadFromDelivery = false;
    private bool shouldAutoLoadFromSalesReturn = false;
    private int? filterPurchaseReceivingId = null;
    private int? filterPurchaseReturnId = null;
    private int? filterSalesDeliveryId = null;
    private int? filterSalesReturnId = null;
    
    // å…¬å¸ç·¨è¼¯ Modal ç›¸é—œè®Šæ•¸ - ä½¿ç”¨æ³›å‹ç®¡ç†å™¨
    private CompanyEditModalComponent? companyEditModal;
    private RelatedEntityModalManager<Company> companyModalManager = default!;
    
    // å®¢æˆ¶ç·¨è¼¯ Modal ç›¸é—œè®Šæ•¸ - ä½¿ç”¨æ³›å‹ç®¡ç†å™¨
    private CustomerEditModalComponent? customerEditModal;
    private RelatedEntityModalManager<Customer> customerModalManager = default!;
    
    // å» å•†ç·¨è¼¯ Modal ç›¸é—œè®Šæ•¸ - ä½¿ç”¨æ³›å‹ç®¡ç†å™¨
    private SupplierEditModalComponent? supplierEditModal;
    private RelatedEntityModalManager<Supplier> supplierModalManager = default!;
    
    private ModalManagerCollection modalManagers = default!;
    
    // é¸é …æ¸…å–®
    private List<Company> companies = new();
    private List<Customer> customers = new();
    private List<Supplier> suppliers = new();
    
    // AutoComplete é…ç½®
    private AutoCompleteConfig? autoCompleteConfig;
    
    // å•†å“æ˜ç´°ç›¸é—œ
    private List<SetoffProductDetail> setoffProductDetails = new();
    private bool IsReadOnly => false; // å¯æ ¹æ“šæ¬Šé™æˆ–ç‹€æ…‹æ§åˆ¶
    private SetoffProductTable? setoffProductDetailManager;
    
    // æ”¶æ¬¾è¨˜éŒ„ç›¸é—œ
    private List<SetoffPayment> setoffPayments = new();
    private SetoffPaymentTable? setoffPaymentTable;
    
    // é æ”¶ä»˜æ¬¾é …ç›¸é—œ
    private List<SetoffPrepayment> setoffPrepayments = new();
    private SetoffPrepaymentTable? setoffPrepaymentDetailManager;
    
    // æ—¥æœŸç¯©é¸
    private DateTime? filterStartDate;
    private DateTime? filterEndDate;

    // ===== å¿…è¦æ–¹æ³• =====
    
    /// <summary>
    /// è™•ç†å¯¦é«”è¼‰å…¥å®Œæˆäº‹ä»¶ï¼ˆç”± GenericEditModalComponent çš„å°èˆªè§¸ç™¼ï¼‰
    /// ç•¶ä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼Œé‡æ–°è¼‰å…¥å°æ‡‰çš„ä¸‰å€‹æ˜ç´°è³‡æ–™ï¼ˆå•†å“æ˜ç´°ã€æ”¶æ¬¾è¨˜éŒ„ã€é æ”¶ä»˜æ¬¾é …ï¼‰
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        try
        {
            // 1. é‡æ–°è¼‰å…¥ä¸‰å€‹æ˜ç´°è³‡æ–™ï¼ˆå¾è³‡æ–™åº«ï¼‰
            await LoadSetoffDocumentDetails(loadedEntityId);
            
            // ğŸ”‘ é—œéµï¼šç«‹å³è§¸ç™¼ UI æ›´æ–°ï¼Œè®“ Table å…ƒä»¶æ”¶åˆ°æ–°çš„åƒæ•¸
            StateHasChanged();
            
            // 2. è§¸ç™¼ä¸‰å€‹ Table å…ƒä»¶åˆ·æ–°
            if (setoffProductDetailManager != null)
            {
                await setoffProductDetailManager.RefreshDetailsAsync();
            }
            if (setoffPaymentTable != null)
            {
                await setoffPaymentTable.RefreshDetailsAsync();
            }
            if (setoffPrepaymentDetailManager != null)
            {
                await setoffPrepaymentDetailManager.RefreshDetailsAsync();
            }
            
            // 3. æœ€å¾Œå†æ¬¡æ›´æ–° UI
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleEntityLoaded), GetType(), 
                additionalData: $"è™•ç†å¯¦é«”è¼‰å…¥äº‹ä»¶å¤±æ•— - EntityId: {loadedEntityId}");
            await NotificationService.ShowErrorAsync("è¼‰å…¥æ˜ç´°è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    /// <summary>
    /// è¼‰å…¥æ²–æ¬¾å–®çš„ä¸‰å€‹æ˜ç´°è³‡æ–™ï¼ˆå•†å“æ˜ç´°ã€æ”¶æ¬¾è¨˜éŒ„ã€é æ”¶ä»˜æ¬¾é …ï¼‰
    /// ç”¨æ–¼ä¸Šä¸‹ç­†åˆ‡æ›æ™‚é‡æ–°è¼‰å…¥æ˜ç´°
    /// </summary>
    private async Task LoadSetoffDocumentDetails(int setoffDocumentId)
    {
        // 1. è¼‰å…¥å•†å“æ˜ç´°
        setoffProductDetails = await SetoffProductDetailService.GetBySetoffDocumentIdAsync(setoffDocumentId);
        
        // 2. è¼‰å…¥æ”¶æ¬¾è¨˜éŒ„
        setoffPayments = await SetoffPaymentService.GetBySetoffDocumentIdAsync(setoffDocumentId);
        
        // 3. è¼‰å…¥é æ”¶ä»˜æ¬¾é …ï¼ˆåŒ…å«ä¸»è¨˜éŒ„å’Œä½¿ç”¨è¨˜éŒ„ï¼‰
        setoffPrepayments = new List<SetoffPrepayment>();
        
        // 3.1 è¼‰å…¥é æ”¶/é ä»˜ä¸»è¨˜éŒ„ï¼ˆAmount > 0ï¼‰
        var prepaymentRecords = await SetoffPrepaymentService.GetBySetoffDocumentIdAsync(setoffDocumentId);
        setoffPrepayments.AddRange(prepaymentRecords);
        
        // 3.2 è¼‰å…¥è½‰æ²–æ¬¾ä½¿ç”¨è¨˜éŒ„ï¼ˆUsedAmount > 0ï¼‰ï¼Œè½‰æ›ç‚º SetoffPrepayment æ ¼å¼ä¾›å‰ç«¯é¡¯ç¤º
        var usageRecords = await SetoffPrepaymentUsageService.GetBySetoffDocumentIdAsync(setoffDocumentId);
        
        // å–å¾—æ‰€æœ‰é æ”¶ä»˜é¡å‹ï¼Œç”¨æ–¼æŸ¥è©¢ã€Œè½‰æ²–æ¬¾ã€é¡å‹ID
        var allPrepaymentTypes = await PrepaymentTypeService.GetAllAsync();
        
        foreach (var usage in usageRecords)
        {
            // æ ¹æ“šä¾†æºé æ”¶ä»˜æ¬¾é …çš„é¡å‹ï¼Œåˆ¤æ–·æ‡‰è©²ä½¿ç”¨å“ªå€‹ã€Œè½‰æ²–æ¬¾ã€é¡å‹
            var sourceType = usage.SetoffPrepayment.PrepaymentType?.Name ?? string.Empty;
            var transferTypeName = sourceType.Contains("é æ”¶") ? "é æ”¶è½‰æ²–æ¬¾" : "é ä»˜è½‰æ²–æ¬¾";
            var transferType = allPrepaymentTypes.FirstOrDefault(pt => pt.Name == transferTypeName);
            
            if (transferType != null)
            {
                // è½‰æ›ç‚º SetoffPrepayment æ ¼å¼ï¼Œè®“å‰ç«¯çµ„ä»¶å¯ä»¥çµ±ä¸€è™•ç†
                setoffPrepayments.Add(new SetoffPrepayment
                {
                    Id = 0,
                    PrepaymentTypeId = transferType.Id,
                    SourceDocumentCode = usage.SourcePrepaymentCode ?? usage.SetoffPrepayment.SourceDocumentCode,
                    SourcePrepaymentId = usage.SetoffPrepaymentId,
                    Amount = usage.SetoffPrepayment.Amount,
                    UsedAmount = usage.UsedAmount,
                    CustomerId = usage.SetoffPrepayment.CustomerId,
                    SupplierId = usage.SetoffPrepayment.SupplierId,
                    SetoffDocumentId = setoffDocumentId,
                    Remarks = string.Empty
                });
            }
        }
    }
    
    // è³‡æ–™è¼‰å…¥ç‹€æ…‹æ¨™è¨˜
    private bool isDataLoaded = false;
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // ä½¿ç”¨ ModalManagerInitHelper åˆå§‹åŒ– Modal ç®¡ç†å™¨
            // æ³¨æ„: CustomerId å’Œ SupplierId æ˜¯è™›æ“¬å±¬æ€§,å®ƒå€‘çš„ setter æœƒè‡ªå‹•è™•ç† RelatedPartyId å’Œ RelatedPartyType
            modalManagers = ModalManagerInitHelper.CreateBuilder<SetoffDocument, ISetoffDocumentService>(
                    () => editModalComponent,
                    NotificationService,
                    StateHasChanged,
                    LoadAdditionalDataAsync,
                    InitializeFormFieldsAsync)
                .AddManager<Company>(nameof(SetoffDocument.CompanyId), "å…¬å¸")
                .AddManager<Customer>("CustomerId", "å®¢æˆ¶")  // è™›æ“¬å±¬æ€§,ä½¿ç”¨å­—ä¸²
                .AddManager<Supplier>("SupplierId", "å» å•†")  // è™›æ“¬å±¬æ€§,ä½¿ç”¨å­—ä¸²
                .Build();
            companyModalManager = modalManagers.Get<Company>(nameof(SetoffDocument.CompanyId));
            customerModalManager = modalManagers.Get<Customer>("CustomerId");
            supplierModalManager = modalManagers.Get<Supplier>("SupplierId");
            
            // ç§»é™¤è‡ªå‹•è¼‰å…¥è³‡æ–™ï¼Œæ”¹ç‚ºåœ¨ OnParametersSetAsync ä¸­æ ¹æ“š IsVisible è¼‰å…¥
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–æ²–æ¬¾å–®ç·¨è¼¯çµ„ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        // ç•¶ SetoffDocumentId åƒæ•¸è®Šæ›´æ™‚ï¼Œé‡æ–°åˆå§‹åŒ–è¡¨å–®æ¬„ä½
        if (IsVisible && !isDataLoaded)
        {
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
            isDataLoaded = true;
        }
        else if (!IsVisible)
        {
            isDataLoaded = false;
        }
        else if (formFields != null) // åªæœ‰åœ¨å·²ç¶“åˆå§‹åŒ–éçš„æƒ…æ³ä¸‹æ‰é‡æ–°è¨­å®š
        {
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
        }
        
        await base.OnParametersSetAsync();
    }

    /// <summary>
    /// å„²å­˜å‰é©—è­‰ï¼ˆåœ¨ä¸»è¡¨å–®å„²å­˜ä¹‹å‰åŸ·è¡Œï¼‰
    /// </summary>
    private async Task<bool> ValidateBeforeSave(SetoffDocument entity)
    {
        try
        {
            if (entity == null)
            {
                await NotificationService.ShowErrorAsync("æ²’æœ‰å¯å„²å­˜çš„è³‡æ–™");
                return false;
            }

            // ===== é©—è­‰ä¸‰å€‹æ˜ç´°è¡¨è‡³å°‘æœ‰ä¸€å€‹åŒ…å«è³‡æ–™ =====
            var hasProductDetails = setoffProductDetails?.Any(d => 
                d.CurrentSetoffAmount > 0 || d.CurrentAllowanceAmount > 0) ?? false;
            
            var hasPaymentDetails = setoffPayments?.Any(p => 
                p.ReceivedAmount > 0 || p.AllowanceAmount > 0) ?? false;
            
            var hasPrepaymentDetails = setoffPrepayments?.Any(p => 
                p.Amount > 0 || p.UsedAmount > 0) ?? false;
            
            if (!hasProductDetails && !hasPaymentDetails && !hasPrepaymentDetails)
            {
                await NotificationService.ShowErrorAsync("å•†å“æ˜ç´°ã€æ”¶æ¬¾è¨˜éŒ„å’Œé æ”¶ä»˜æ¬¾é …ä¸å¯éƒ½ç‚ºç©ºç™½ã€‚");
                return false;
            }

            // ===== å„²å­˜å‰é©—è­‰é‡‘é¡ =====
            var receivedFromPayments = setoffPaymentTable?.GetTotalReceivedAmount() ?? 0;
            var allowanceFromPayments = setoffPaymentTable?.GetTotalAllowanceAmount() ?? 0;
            var hasProductSetoff = setoffProductDetails?.Any(d => 
                d.CurrentSetoffAmount > 0 || d.CurrentAllowanceAmount > 0) ?? false;
            
            // å–å¾—é æ”¶ä»˜æ¬¾é …é¡å‹è³‡è¨Š
            var allPrepaymentTypes = await PrepaymentTypeService.GetAllAsync();
            var prepaymentAmount = 0m;      // é æ”¶/ä»˜é¡å‹çš„ Amount
            var prepaymentUsedAmount = 0m;  // è½‰æ²–æ¬¾é¡å‹çš„ UsedAmount
            
            if (setoffPrepayments != null)
            {
                foreach (var prepayment in setoffPrepayments)
                {
                    var prepaymentType = allPrepaymentTypes.FirstOrDefault(pt => pt.Id == prepayment.PrepaymentTypeId);
                    if (prepaymentType != null && prepaymentType.Name.Contains("è½‰æ²–æ¬¾"))
                    {
                        prepaymentUsedAmount += prepayment.UsedAmount;
                    }
                    else
                    {
                        prepaymentAmount += prepayment.Amount;
                    }
                }
            }
            
            // ===== é©—è­‰ entity æ¬„ä½çš„é‚è¼¯é—œä¿‚ =====
            // æ­£ç¢ºåšæ³•ï¼šåªé©—è­‰ entity çš„æ¬„ä½å€¼æ˜¯å¦ç¬¦åˆæ¥­å‹™é‚è¼¯å…¬å¼
            // ä¸å»æ ¸å°å„å€‹å­å…ƒä»¶ï¼ˆå•†å“æ˜ç´°ã€æ”¶æ¬¾è¨˜éŒ„ã€é æ”¶ä»˜æ¬¾é …ï¼‰çš„æ˜ç´°æ•¸å­—
            // å› ç‚ºæ‰€æœ‰æ•¸å­—éƒ½å·²ç¶“ç”± Handler æ–¹æ³•è¨ˆç®—ä¸¦åæ˜ åœ¨ entity çš„æ¬„ä½ä¸Š
            
            // é©—è­‰ï¼šæœ¬æœŸå·²æ”¶ + é æ”¶æ²–æ¬¾ = æœ¬æœŸæ²–éŠ· + æœ¬æœŸæŠ˜è®“ + æœ¬æœŸé æ”¶
            var expectedTotalCollection = entity.CurrentSetoffAmount + entity.TotalAllowanceAmount + entity.CurrentPrepaymentAmount;
            var actualLeftSide = entity.TotalCollectionAmount + entity.PrepaymentSetoffAmount;
            if (Math.Abs(expectedTotalCollection - actualLeftSide) > 0.01m)
            {
                await NotificationService.ShowErrorAsync(
                    $"æœ¬æœŸå·²æ”¶é©—è­‰å¤±æ•—ï¼š\n\n" +
                    $"å…¬å¼ï¼šæœ¬æœŸå·²æ”¶ + é æ”¶æ²–æ¬¾ = æœ¬æœŸæ²–éŠ· + æœ¬æœŸæŠ˜è®“ + æœ¬æœŸé æ”¶\n\n" +
                    $"ã€å·¦é‚Šè¨ˆç®—ã€‘\n" +
                    $"  æœ¬æœŸå·²æ”¶: {entity.TotalCollectionAmount:N2}\n" +
                    $"  é æ”¶æ²–æ¬¾: {entity.PrepaymentSetoffAmount:N2}\n" +
                    $"  å·¦é‚Šç¸½è¨ˆ: {actualLeftSide:N2}\n\n" +
                    $"ã€å³é‚Šè¨ˆç®—ã€‘\n" +
                    $"  æœ¬æœŸæ²–éŠ·: {entity.CurrentSetoffAmount:N2}\n" +
                    $"  æœ¬æœŸæŠ˜è®“: {entity.TotalAllowanceAmount:N2}\n" +
                    $"  æœ¬æœŸé æ”¶: {entity.CurrentPrepaymentAmount:N2}\n" +
                    $"  å³é‚Šç¸½è¨ˆ: {expectedTotalCollection:N2}\n\n" +
                    $"è«‹ç¢ºèªæ¬„ä½æ•¸å­—æ˜¯å¦æ­£ç¢ºã€‚");
                return false;
            }           
            
            // é©—è­‰é æ”¶ä»˜æ¬¾é …ï¼ˆå¦‚æœæœ‰å¡«å¯«çš„è©±ï¼‰
            if (setoffPrepaymentDetailManager != null)
            {
                var prepaymentValidationResult = await setoffPrepaymentDetailManager.ValidateAsync();
                if (!prepaymentValidationResult)
                {
                    // é©—è­‰å¤±æ•—ï¼Œç›´æ¥é˜»æ­¢å„²å­˜
                    return false;
                }
            }
            
            // ===== æå‰é©—è­‰æº–å‚™å„²å­˜çš„é æ”¶ä»˜æ¬¾é …è³‡æ–™ =====
            // å€åˆ†å…©ç¨®é¡å‹ï¼š
            // 1. é æ”¶/é ä»˜ï¼ˆAmount > 0 ä¸” UsedAmount = 0ï¼‰â†’ ä½¿ç”¨ SetoffPrepaymentService é©—è­‰
            // 2. è½‰æ²–æ¬¾ï¼ˆUsedAmount > 0 ä¸”éé æ”¶/é ä»˜é¡å‹ï¼‰â†’ ä½¿ç”¨ SetoffPrepaymentUsageService é©—è­‰
            
            // å–å¾—æ‰€æœ‰é æ”¶ä»˜é¡å‹ï¼Œç”¨æ–¼åˆ¤æ–·æ˜¯å¦ç‚ºè½‰æ²–æ¬¾é¡å‹
            var prepaymentTypesForValidation = await PrepaymentTypeService.GetAllAsync();
            
            // é©—è­‰é æ”¶/é ä»˜ä¸»è¨˜éŒ„ï¼ˆAmount > 0 ä¸”éè½‰æ²–æ¬¾é¡å‹ï¼‰
            var prepaymentRecords = setoffPrepayments?
                .Where(p => 
                {
                    // å¿…é ˆæœ‰ Amount > 0
                    if (p.Amount <= 0) return false;
                    
                    // æª¢æŸ¥æ˜¯å¦ç‚ºè½‰æ²–æ¬¾é¡å‹
                    var prepaymentType = prepaymentTypesForValidation.FirstOrDefault(pt => pt.Id == p.PrepaymentTypeId);
                    if (prepaymentType != null && prepaymentType.Name.Contains("è½‰æ²–æ¬¾"))
                    {
                        return false;  // è½‰æ²–æ¬¾é¡å‹ï¼Œä¸ç´å…¥é æ”¶/é ä»˜é©—è­‰
                    }
                    
                    return true;  // é æ”¶/é ä»˜é¡å‹
                })
                .ToList() ?? new List<SetoffPrepayment>();
            
            if (prepaymentRecords.Any())
            {
                for (int i = 0; i < prepaymentRecords.Count; i++)
                {
                    var prepayment = prepaymentRecords[i];
                    
                    // å‘¼å« SetoffPrepaymentService å±¤çš„é©—è­‰æ–¹æ³•
                    var validationResult = await SetoffPrepaymentService.ValidateAsync(prepayment);
                    if (!validationResult.IsSuccess)
                    {
                        await NotificationService.ShowErrorAsync($"é æ”¶ä»˜æ¬¾é …é©—è­‰å¤±æ•—ï¼š{validationResult.ErrorMessage}");
                        return false;
                    }
                }
            }
            
            // é©—è­‰è½‰æ²–æ¬¾ä½¿ç”¨è¨˜éŒ„
            var usageRecords = setoffPrepayments?
                .Where(p => p.UsedAmount > 0 && p.Amount == 0)
                .ToList() ?? new List<SetoffPrepayment>();
            
            if (usageRecords.Any())
            {
                foreach (var prepayment in usageRecords)
                {
                    // å¾ SourceDocumentCode æŸ¥è©¢åŸå§‹é æ”¶ä»˜æ¬¾é …
                    var sourcePrepayment = await SetoffPrepaymentService.GetBySourceDocumentCodeAsync(prepayment.SourceDocumentCode);
                    if (sourcePrepayment == null)
                    {
                        await NotificationService.ShowErrorAsync($"æ‰¾ä¸åˆ°ä¾†æºé æ”¶ä»˜æ¬¾é …ï¼š{prepayment.SourceDocumentCode}");
                        return false;
                    }
                    
                    // é©—è­‰ä½¿ç”¨é‡‘é¡æ˜¯å¦è¶…éå¯ç”¨é¤˜é¡
                    var usageValidation = await SetoffPrepaymentUsageService.ValidateUsageAmountAsync(
                        sourcePrepayment.Id,
                        prepayment.UsedAmount,
                        null  // æ–°å¢æ™‚ä¸éœ€è¦æ’é™¤ä»»ä½•è¨˜éŒ„
                    );
                    
                    if (!usageValidation.IsSuccess)
                    {
                        await NotificationService.ShowErrorAsync($"è½‰æ²–æ¬¾é©—è­‰å¤±æ•—ï¼š{usageValidation.ErrorMessage}");
                        return false;
                    }
                }
            }
            
            
            // ===== é©—è­‰å•†å“æ˜ç´°çš„æœ¬æ¬¡æ²–æ¬¾æ˜¯å¦è¶…éæœªçµæ¸…é¤˜é¡ =====
            // ä½¿ç”¨ Service å±¤çš„çµ±ä¸€é©—è­‰é‚è¼¯ï¼Œé¿å…é‚è¼¯é‡è¤‡
            if (hasProductSetoff && SetoffProductDetailService != null && setoffProductDetails != null)
            {
                var validDetails = setoffProductDetails
                    .Where(d => d.CurrentSetoffAmount > 0 || d.CurrentAllowanceAmount > 0)
                    .ToList();
                
                if (validDetails.Any())
                {
                    // ç›´æ¥èª¿ç”¨ Service çš„é©—è­‰æ–¹æ³•ï¼Œç¢ºä¿å‰ç«¯å’Œå¾Œç«¯é©—è­‰é‚è¼¯ä¸€è‡´
                    foreach (var detail in validDetails)
                    {
                        // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ï¼Œå‚³å…¥ detail.Id ä»¥æ’é™¤åŸæœ¬çš„æ²–éŠ·é‡‘é¡
                        var validation = await SetoffProductDetailService.ValidateSetoffAmountAsync(
                            detail.SourceDetailId,
                            detail.SourceDetailType,
                            detail.CurrentSetoffAmount,
                            detail.CurrentAllowanceAmount,
                            detail.Id > 0 ? detail.Id : null);
                        
                        if (!validation.IsSuccess)
                        {
                            await NotificationService.ShowErrorAsync($"å•†å“æ˜ç´°é©—è­‰å¤±æ•—ï¼š{validation.ErrorMessage}");
                            return false;
                        }
                    }
                }
            }

            // é©—è­‰é€šé
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é©—è­‰è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// å„²å­˜æ˜ç´°è³‡æ–™ï¼ˆåœ¨ä¸»è¡¨å–®å„²å­˜æˆåŠŸä¹‹å¾ŒåŸ·è¡Œï¼‰
    /// </summary>
    private async Task SaveSetoffDocumentDetailsAsync(SetoffDocument entity)
    {
        try
        {
            if (entity == null || entity.Id <= 0)
            {
                await NotificationService.ShowErrorAsync("ä¸»æª”è³‡æ–™ç„¡æ•ˆï¼Œç„¡æ³•å„²å­˜æ˜ç´°");
                return;
            }

            // å„²å­˜å•†å“æ˜ç´°ï¼ˆéæ¿¾æ‰æœ¬æ¬¡æ²–æ¬¾å’ŒæŠ˜è®“éƒ½ç‚º 0 çš„é …ç›®ï¼‰
            var validDetails = setoffProductDetails
                .Where(d => d.CurrentSetoffAmount > 0 || d.CurrentAllowanceAmount > 0)
                .ToList();
                
            if (validDetails.Any() && entity.Id > 0)
            {
                // è¨­å®š SetoffDocumentId
                foreach (var detail in validDetails)
                {
                    detail.SetoffDocumentId = entity.Id;
                }

                var detailResult = await SetoffProductDetailService.CreateBatchWithValidationAsync(validDetails);
                if (!detailResult.IsSuccess)
                {
                    await NotificationService.ShowErrorAsync($"å•†å“æ˜ç´°å„²å­˜å¤±æ•—ï¼š{detailResult.ErrorMessage}");
                    return;
                }
            }

            // å„²å­˜æ”¶æ¬¾è¨˜éŒ„ï¼ˆéæ¿¾æ‰ä»˜æ¬¾æ–¹å¼ç‚ºç©ºçš„é …ç›®ï¼‰
            var validPayments = setoffPayments
                .Where(p => p.PaymentMethodId.HasValue && p.PaymentMethodId.Value > 0)
                .ToList();
                
            if (entity.Id > 0)
            {
                // å–å¾—ç¾æœ‰çš„æ”¶æ¬¾è¨˜éŒ„
                var existingPayments = await SetoffPaymentService.GetBySetoffDocumentIdAsync(entity.Id);
                var existingPaymentIds = existingPayments.Select(p => p.Id).ToList();
                var currentPaymentIds = validPayments.Where(p => p.Id > 0).Select(p => p.Id).ToList();
                
                // åˆªé™¤ä¸å†å­˜åœ¨çš„æ”¶æ¬¾è¨˜éŒ„
                var paymentsToDelete = existingPayments.Where(ep => !currentPaymentIds.Contains(ep.Id)).ToList();
                foreach (var paymentToDelete in paymentsToDelete)
                {
                    await SetoffPaymentService.DeleteAsync(paymentToDelete.Id);
                }
                
                // è™•ç†æ–°å¢å’Œæ›´æ–°
                foreach (var payment in validPayments)
                {
                    payment.SetoffDocumentId = entity.Id;
                    
                    if (payment.Id > 0)
                    {
                        // æ›´æ–°ç¾æœ‰è¨˜éŒ„
                        var paymentResult = await SetoffPaymentService.UpdateAsync(payment);
                        if (!paymentResult.IsSuccess)
                        {
                            await NotificationService.ShowErrorAsync($"æ”¶æ¬¾è¨˜éŒ„æ›´æ–°å¤±æ•—ï¼š{paymentResult.ErrorMessage}");
                            return;
                        }
                    }
                    else
                    {
                        // æ–°å¢è¨˜éŒ„
                        var paymentResult = await SetoffPaymentService.CreateAsync(payment);
                        if (!paymentResult.IsSuccess)
                        {
                            await NotificationService.ShowErrorAsync($"æ”¶æ¬¾è¨˜éŒ„æ–°å¢å¤±æ•—ï¼š{paymentResult.ErrorMessage}");
                            return;
                        }
                    }
                }
            }
            
            // ===== å„²å­˜é æ”¶ä»˜æ¬¾é … =====
            // éœ€è¦å€åˆ†å…©ç¨®æƒ…æ³ï¼š
            // 1. é æ”¶/é ä»˜ï¼ˆAmount > 0 ä¸”éè½‰æ²–æ¬¾é¡å‹ï¼‰â†’ å„²å­˜åˆ° SetoffPrepayment è¡¨
            // 2. è½‰æ²–æ¬¾ï¼ˆUsedAmount > 0 ä¸”ç‚ºè½‰æ²–æ¬¾é¡å‹ï¼‰â†’ å„²å­˜åˆ° SetoffPrepaymentUsage è¡¨
            
            if (entity.Id > 0)
            {
                // å–å¾—æ‰€æœ‰é æ”¶ä»˜é¡å‹è³‡è¨Šï¼Œç”¨æ–¼åˆ¤æ–·æ˜¯å¦ç‚ºè½‰æ²–æ¬¾é¡å‹
                var allPrepaymentTypes = await PrepaymentTypeService.GetAllAsync();
                
                // === è™•ç†é æ”¶/é ä»˜ä¸»è¨˜éŒ„ï¼ˆæ’é™¤è½‰æ²–æ¬¾é¡å‹ï¼‰===
                var prepaymentRecords = setoffPrepayments
                    .Where(p => 
                    {
                        // å¿…é ˆæœ‰ Amount > 0
                        if (p.Amount <= 0) return false;
                        
                        // æª¢æŸ¥æ˜¯å¦ç‚ºè½‰æ²–æ¬¾é¡å‹
                        var prepaymentType = allPrepaymentTypes.FirstOrDefault(pt => pt.Id == p.PrepaymentTypeId);
                        if (prepaymentType != null && prepaymentType.Name.Contains("è½‰æ²–æ¬¾"))
                        {
                            return false;  // è½‰æ²–æ¬¾é¡å‹ï¼Œä¸ç´å…¥é æ”¶/é ä»˜å„²å­˜
                        }
                        
                        return true;  // é æ”¶/é ä»˜é¡å‹
                    })
                    .ToList();
                
                // å–å¾—ç¾æœ‰çš„é æ”¶ä»˜æ¬¾é …ä¸»è¨˜éŒ„
                var existingPrepayments = await SetoffPrepaymentService.GetBySetoffDocumentIdAsync(entity.Id);
                var existingPrepaymentIds = existingPrepayments.Select(p => p.Id).ToList();
                var currentPrepaymentIds = prepaymentRecords.Where(p => p.Id > 0).Select(p => p.Id).ToList();
                
                // åˆªé™¤ä¸å†å­˜åœ¨çš„é æ”¶ä»˜æ¬¾é …è¨˜éŒ„
                var prepaymentsToDelete = existingPrepayments.Where(ep => !currentPrepaymentIds.Contains(ep.Id)).ToList();
                foreach (var prepaymentToDelete in prepaymentsToDelete)
                {
                    await SetoffPrepaymentService.DeleteAsync(prepaymentToDelete.Id);
                }
                
                // è™•ç†æ–°å¢å’Œæ›´æ–°
                foreach (var prepayment in prepaymentRecords)
                {
                    prepayment.SetoffDocumentId = entity.Id;
                    
                    if (prepayment.Id > 0)
                    {
                        // æ›´æ–°ç¾æœ‰è¨˜éŒ„
                        var prepaymentResult = await SetoffPrepaymentService.UpdateAsync(prepayment);
                        if (!prepaymentResult.IsSuccess)
                        {
                            await NotificationService.ShowErrorAsync($"é æ”¶ä»˜æ¬¾é …æ›´æ–°å¤±æ•—ï¼š{prepaymentResult.ErrorMessage}");
                            return;
                        }
                    }
                    else
                    {
                        // æ–°å¢è¨˜éŒ„
                        var prepaymentResult = await SetoffPrepaymentService.CreateAsync(prepayment);
                        if (!prepaymentResult.IsSuccess)
                        {
                            await NotificationService.ShowErrorAsync($"é æ”¶ä»˜æ¬¾é …æ–°å¢å¤±æ•—ï¼š{prepaymentResult.ErrorMessage}");
                            return;
                        }
                    }
                }
                
                // === è™•ç†è½‰æ²–æ¬¾ä½¿ç”¨è¨˜éŒ„ï¼ˆæ ¹æ“šé¡å‹åç¨±åˆ¤æ–·ï¼‰===
                var usageRecords = setoffPrepayments
                    .Where(p => 
                    {
                        // å¿…é ˆæœ‰ UsedAmount > 0
                        if (p.UsedAmount <= 0) return false;
                        
                        // æª¢æŸ¥æ˜¯å¦ç‚ºè½‰æ²–æ¬¾é¡å‹
                        var prepaymentType = allPrepaymentTypes.FirstOrDefault(pt => pt.Id == p.PrepaymentTypeId);
                        if (prepaymentType != null && prepaymentType.Name.Contains("è½‰æ²–æ¬¾"))
                        {
                            return true;  // è½‰æ²–æ¬¾é¡å‹
                        }
                        
                        return false;
                    })
                    .ToList();
                
                // å–å¾—ç¾æœ‰çš„ä½¿ç”¨è¨˜éŒ„
                var existingUsages = await SetoffPrepaymentUsageService.GetBySetoffDocumentIdAsync(entity.Id);
                
                // å…ˆåˆªé™¤æ‰€æœ‰æ—¢æœ‰çš„ä½¿ç”¨è¨˜éŒ„ï¼ˆå› ç‚ºå‰ç«¯å‚³ä¾†çš„æ˜¯å®Œæ•´æ¸…å–®ï¼‰
                await SetoffPrepaymentUsageService.DeleteBySetoffDocumentIdAsync(entity.Id);
                
                // å»ºç«‹æ–°çš„ä½¿ç”¨è¨˜éŒ„
                foreach (var prepayment in usageRecords)
                {
                    // å¾ SourceDocumentCode æŸ¥è©¢åŸå§‹é æ”¶ä»˜æ¬¾é …
                    var sourcePrepayment = await SetoffPrepaymentService.GetBySourceDocumentCodeAsync(prepayment.SourceDocumentCode);
                    if (sourcePrepayment == null)
                    {
                        await NotificationService.ShowErrorAsync($"æ‰¾ä¸åˆ°ä¾†æºé æ”¶ä»˜æ¬¾é …ï¼š{prepayment.SourceDocumentCode}");
                        return;
                    }
                    
                    // å»ºç«‹ä½¿ç”¨è¨˜éŒ„
                    var usage = new SetoffPrepaymentUsage
                    {
                        SetoffPrepaymentId = sourcePrepayment.Id,
                        SetoffDocumentId = entity.Id,
                        UsedAmount = prepayment.UsedAmount,
                        UsageDate = DateTime.Now,
                        Remarks = $"æ²–æ¬¾å–® {entity.Code} ä½¿ç”¨"
                    };
                    
                    var usageResult = await SetoffPrepaymentUsageService.CreateAsync(usage);
                    if (!usageResult.IsSuccess)
                    {
                        await NotificationService.ShowErrorAsync($"é æ”¶ä»˜æ¬¾é …ä½¿ç”¨è¨˜éŒ„æ–°å¢å¤±æ•—ï¼š{usageResult.ErrorMessage}");
                        return;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å„²å­˜æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            throw; // é‡æ–°æ‹‹å‡ºä¾‹å¤–ï¼Œè®“ GenericEditModalComponent çŸ¥é“å„²å­˜å¤±æ•—
        }
    }
    
    /// <summary>
    /// å„²å­˜æˆåŠŸå¾Œè™•ç†ï¼ˆé€šçŸ¥çˆ¶çµ„ä»¶ï¼‰
    /// </summary>
    private async Task HandleSaveSuccess()
    {
        try
        {
            if (editModalComponent?.Entity != null && OnSetoffDocumentSaved.HasDelegate)
            {
                await OnSetoffDocumentSaved.InvokeAsync(editModalComponent.Entity);
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é€šçŸ¥çˆ¶çµ„ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }
    
    /// <summary>
    /// è™•ç†å•†å“æ˜ç´°è®Šæ›´äº‹ä»¶ï¼Œæ›´æ–°æ²–æ¬¾å–®çš„å„é …é‡‘é¡æ¬„ä½
    /// </summary>
    /// <remarks>
    /// æ¬„ä½èªªæ˜ï¼š
    /// - æœ¬æœŸæ‡‰æ”¶ (TotalSetoffAmount): è¢«é¸å…¥çš„ä¾†æºæ˜ç´°çš„åŸå§‹æ‡‰æ”¶/ä»˜ç¸½é‡‘é¡ï¼ˆä¸æœƒå› ç‚ºè¼¸å…¥æœ¬æ¬¡æ²–æ¬¾è€Œæ”¹è®Šï¼‰
    /// - æœ¬æœŸæ²–éŠ· (CurrentSetoffAmount): æœ¬æ¬¡æ²–æ¬¾ï¼ˆä¸åŒ…å«æŠ˜è®“ï¼‰
    /// - æœ¬æœŸå·²æ”¶ (TotalCollectionAmount): å¯¦éš›æ”¶åˆ°çš„æ¬¾é …
    /// - æœ¬æœŸæŠ˜è®“ (TotalAllowanceAmount): æœ¬æ¬¡æŠ˜è®“çš„ç¸½é¡ï¼ˆå–®ç¨é¡¯ç¤ºï¼Œä¸è¨ˆå…¥æœ¬æœŸæ²–éŠ·ï¼‰
    /// </remarks>
    private void HandleProductDetailsChanged(List<SetoffProductDetail> details)
    {
        setoffProductDetails = details;
        
        // æ›´æ–°ç¸½é‡‘é¡
        if (editModalComponent?.Entity != null)
        {
            // ã€æœ¬æœŸæ‡‰æ”¶ã€‘= è¢«é¸å…¥çš„ä¾†æºæ˜ç´°çš„åŸå§‹æ‡‰æ”¶/ä»˜ç¸½é‡‘é¡
            // é€™å€‹å€¼æ‡‰è©²å¾ SetoffProductTable å–å¾—ä¾†æºæ˜ç´°çš„ç¸½é‡‘é¡
            // åªåœ¨æ˜ç´°è¢«é¸å…¥æ™‚è¨ˆç®—ï¼Œä¸æœƒå› ç‚ºè¼¸å…¥æœ¬æ¬¡æ²–æ¬¾é‡‘é¡è€Œæ”¹è®Š
            // é€€è²¨å–®æ“šæœƒä»¥è² æ•¸è¨ˆç®—ï¼ˆä¾‹å¦‚ï¼šéŠ·è²¨600 + éŠ·è²¨é€€å›-300 = 300ï¼‰
            if (setoffProductDetailManager != null)
            {
                editModalComponent.Entity.TotalSetoffAmount = setoffProductDetailManager.GetSourceTotalAmount();
            }
            
            // ã€æœ¬æœŸæ²–éŠ·ã€‘= æœ¬æ¬¡æ²–æ¬¾ï¼ˆä¸åŒ…å«æŠ˜è®“ï¼‰
            // é€€è²¨å–®æ“šæœƒä»¥è² æ•¸è¨ˆç®—ï¼ˆä¾‹å¦‚ï¼šéŠ·è²¨æ²–æ¬¾100 + éŠ·è²¨é€€å›æ²–æ¬¾-50 = 50ï¼‰
            if (setoffProductDetailManager != null)
            {
                editModalComponent.Entity.CurrentSetoffAmount = setoffProductDetailManager.GetCurrentSetoffTotal();
            }
            else
            {
                editModalComponent.Entity.CurrentSetoffAmount = details.Sum(d => d.CurrentSetoffAmount);
            }
            
            // ã€æœ¬æœŸå·²æ”¶ã€‘ä¸åœ¨æ­¤æ›´æ–°ï¼Œç”±æ”¶æ¬¾è¨˜éŒ„ï¼ˆHandlePaymentsChangedï¼‰å’Œé æ”¶ä»˜æ¬¾é …ï¼ˆHandlePrepaymentsChangedï¼‰æ±ºå®š
            // ã€æœ¬æœŸæŠ˜è®“ã€‘= æœ¬æ¬¡æŠ˜è®“çš„ç¸½é¡ï¼ˆå–®ç¨é¡¯ç¤ºï¼Œä¸è¨ˆå…¥æœ¬æœŸæ²–éŠ·ï¼‰
            // é€€è²¨å–®æ“šæœƒä»¥è² æ•¸è¨ˆç®—
            if (setoffProductDetailManager != null)
            {
                editModalComponent.Entity.TotalAllowanceAmount = setoffProductDetailManager.GetCurrentAllowanceTotal();
            }
            else
            {
                editModalComponent.Entity.TotalAllowanceAmount = details.Sum(d => d.CurrentAllowanceAmount);
            }
        }
        
        StateHasChanged();
    }
    
    /// <summary>
    /// è™•ç†æ”¶æ¬¾è¨˜éŒ„è®Šæ›´äº‹ä»¶
    /// </summary>
    /// <remarks>
    /// æ”¶æ¬¾è¨˜éŒ„è®Šæ›´æ™‚å³æ™‚æ›´æ–°æœ¬æœŸå·²æ”¶æ¬„ä½
    /// å…¬å¼ï¼šæœ¬æœŸå·²æ”¶ + é æ”¶æ²–æ¬¾ = æœ¬æœŸæ²–éŠ· + æœ¬æœŸæŠ˜è®“ + æœ¬æœŸé æ”¶
    /// å› æ­¤ï¼šæœ¬æœŸå·²æ”¶ = æœ¬æœŸæ²–éŠ· + æœ¬æœŸæŠ˜è®“ + æœ¬æœŸé æ”¶ - é æ”¶æ²–æ¬¾
    /// æˆ–è€…ï¼šæœ¬æœŸå·²æ”¶ = Paymentæ”¶æ¬¾ + PaymentæŠ˜è®“
    /// </remarks>
    private Task HandlePaymentsChanged(List<SetoffPayment> payments)
    {
        setoffPayments = payments;
        
        if (editModalComponent?.Entity != null && setoffPaymentTable != null)
        {
            var receivedFromPayments = setoffPaymentTable.GetTotalReceivedAmount();
            var allowanceFromPayments = setoffPaymentTable.GetTotalAllowanceAmount();
            
            // ===== æ›´æ–°æœ¬æœŸå·²æ”¶ =====
            // æœ¬æœŸå·²æ”¶ = Paymentæ”¶æ¬¾ + PaymentæŠ˜è®“ï¼ˆä¸åŒ…å«æœ¬æœŸé æ”¶ï¼‰
            // æœ¬æœŸé æ”¶æ˜¯ç¨ç«‹çš„æ¬„ä½ï¼Œä¸æ‡‰è©²åŠ åˆ°æœ¬æœŸå·²æ”¶
            editModalComponent.Entity.TotalCollectionAmount = receivedFromPayments + allowanceFromPayments;
        }
        
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    /// <summary>
    /// è™•ç†é æ”¶ä»˜æ¬¾é …è®Šæ›´äº‹ä»¶
    /// </summary>
    /// <remarks>
    /// é æ”¶ä»˜æ¬¾é …è®Šæ›´æ™‚æ›´æ–°é æ”¶ä»˜æ¬¾é …ç›¸é—œçš„æ¬„ä½
    /// - æœ¬æœŸé æ”¶/ä»˜ï¼ˆCurrentPrepaymentAmountï¼‰ï¼šæ–°å»ºç«‹çš„é æ”¶ä»˜æ¬¾é …é‡‘é¡
    /// - é æ”¶/ä»˜æ²–æ¬¾ï¼ˆPrepaymentSetoffAmountï¼‰ï¼šä½¿ç”¨æ—¢æœ‰é æ”¶ä»˜æ¬¾é …é€²è¡Œæ²–æ¬¾çš„é‡‘é¡
    /// æ³¨æ„ï¼šé æ”¶ä»˜æ¬¾é …ä¸å½±éŸ¿ã€Œæœ¬æœŸå·²æ”¶ã€ï¼Œã€Œæœ¬æœŸå·²æ”¶ã€åªç”±æ”¶æ¬¾è¨˜éŒ„æ±ºå®š
    /// </remarks>
    private async Task HandlePrepaymentsChanged(List<SetoffPrepayment> prepayments)
    {
        setoffPrepayments = prepayments;
        
        if (editModalComponent?.Entity != null)
        {
            // è¨ˆç®—é æ”¶ä»˜æ¬¾é …é‡‘é¡
            var prepaymentUsedAmount = 0m;  // è½‰æ²–æ¬¾é¡å‹ï¼ˆä½¿ç”¨æ—¢æœ‰é æ”¶ä»˜æ¬¾é …é€²è¡Œæ²–æ¬¾ï¼‰
            var prepaymentAmount = 0m;       // é æ”¶/ä»˜é¡å‹ï¼ˆå»ºç«‹æ–°çš„é æ”¶ä»˜æ¬¾é …ï¼‰
            
            // éœ€è¦åˆ¤æ–·é æ”¶ä»˜é¡å‹ï¼Œéœ€è¦å…ˆè¼‰å…¥ PrepaymentType è³‡æ–™
            var allPrepaymentTypes = await PrepaymentTypeService.GetAllAsync();
            foreach (var prepayment in prepayments)
            {
                var prepaymentType = allPrepaymentTypes.FirstOrDefault(pt => pt.Id == prepayment.PrepaymentTypeId);
                if (prepaymentType != null && prepaymentType.Name.Contains("è½‰æ²–æ¬¾"))
                {
                    // é æ”¶/ä»˜è½‰æ²–æ¬¾é¡å‹ï¼šç´¯åŠ  UsedAmount
                    prepaymentUsedAmount += prepayment.UsedAmount;
                }
                else
                {
                    // é æ”¶/ä»˜é¡å‹ï¼šç´¯åŠ  Amount
                    prepaymentAmount += prepayment.Amount;
                }
            }
            
            // ===== æ›´æ–°é æ”¶ä»˜æ¬¾é …ç›¸é—œçš„é¡¯ç¤ºæ¬„ä½ =====
            // æœ¬æœŸé æ”¶/ä»˜ï¼šé¡¯ç¤ºæ–°å»ºç«‹çš„é æ”¶ä»˜æ¬¾é …é‡‘é¡
            editModalComponent.Entity.CurrentPrepaymentAmount = prepaymentAmount;
            
            // é æ”¶/ä»˜æ²–æ¬¾ï¼šé¡¯ç¤ºä½¿ç”¨æ—¢æœ‰é æ”¶ä»˜æ¬¾é …é€²è¡Œæ²–æ¬¾çš„é‡‘é¡
            editModalComponent.Entity.PrepaymentSetoffAmount = prepaymentUsedAmount;
            
            // ===== ä¸éœ€è¦è§¸ç™¼æœ¬æœŸå·²æ”¶çš„é‡æ–°è¨ˆç®— =====
            // æœ¬æœŸå·²æ”¶åªç”±æ”¶æ¬¾è¨˜éŒ„æ±ºå®šï¼Œèˆ‡é æ”¶ä»˜æ¬¾é …ç„¡é—œ
        }
        
        StateHasChanged();
    }

    private async Task HandleCancel()
    {
        await OnCancel.InvokeAsync();
        await CloseModal();
    }

    private async Task CloseModal()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }

    private async Task<SetoffDocument?> LoadSetoffDocumentData()
    {
        try
        {
            SetoffDocument? setoffDocument;
            
            if (!SetoffDocumentId.HasValue)
            {
                // æ–°å¢æ¨¡å¼ - æ ¹æ“šé¡å‹æ±ºå®šå‰ç¶´
                var typePrefix = (DefaultSetoffType ?? SetoffType.AccountsReceivable) == SetoffType.AccountsReceivable ? "SO" : "PO";
                
                // å–å¾—é è¨­å…¬å¸
                var primaryCompany = await CompanyService.GetPrimaryCompanyAsync();
                
                setoffDocument = new SetoffDocument
                {
                    Code = await EntityCodeGenerationHelper.GenerateForEntity<SetoffDocument, ISetoffDocumentService>(SetoffDocumentService, typePrefix),
                    SetoffDate = DateTime.Today,
                    SetoffType = DefaultSetoffType ?? SetoffType.AccountsReceivable,
                    TotalSetoffAmount = 0,
                    CurrentPrepaymentAmount = 0,
                    PrepaymentSetoffAmount = 0,
                    CompanyId = primaryCompany?.Id ?? 0 // è¨­å®šé è¨­å…¬å¸
                };
                
                // è™•ç†é å¡«åƒæ•¸ï¼ˆé€²è²¨è½‰æ²–æ¬¾ç­‰å ´æ™¯ï¼‰
                if (PrefilledSupplierId.HasValue && PrefilledSupplierId.Value > 0)
                {
                    setoffDocument.RelatedPartyId = PrefilledSupplierId.Value;
                    setoffDocument.RelatedPartyType = "Supplier";
                    setoffDocument.SetoffType = SetoffType.AccountsPayable;
                    
                    // è¨­å®šé€²è²¨å–®ç¯©é¸ID
                    if (PrefilledPurchaseReceivingId.HasValue)
                    {
                        filterPurchaseReceivingId = PrefilledPurchaseReceivingId.Value;
                    }
                    // è¨­å®šé€²è²¨é€€å‡ºç¯©é¸ID
                    if (PrefilledPurchaseReturnId.HasValue)
                    {
                        filterPurchaseReturnId = PrefilledPurchaseReturnId.Value;
                    }
                }
                
                // è™•ç†é å¡«åƒæ•¸ï¼ˆéŠ·è²¨è½‰æ²–æ¬¾ç­‰å ´æ™¯ï¼‰
                if (PrefilledCustomerId.HasValue && PrefilledCustomerId.Value > 0)
                {
                    setoffDocument.RelatedPartyId = PrefilledCustomerId.Value;
                    setoffDocument.RelatedPartyType = "Customer";
                    setoffDocument.SetoffType = SetoffType.AccountsReceivable;
                    
                    // è¨­å®šéŠ·è²¨å‡ºè²¨ç¯©é¸ID
                    if (PrefilledSalesDeliveryId.HasValue)
                    {
                        filterSalesDeliveryId = PrefilledSalesDeliveryId.Value;
                    }
                    // è¨­å®šéŠ·è²¨é€€å›ç¯©é¸ID
                    if (PrefilledSalesReturnId.HasValue)
                    {
                        filterSalesReturnId = PrefilledSalesReturnId.Value;
                    }
                }
                
                // æ–°å¢æ¨¡å¼ï¼šæ¸…ç©ºå•†å“æ˜ç´°ã€æ”¶æ¬¾è¨˜éŒ„å’Œé æ”¶ä»˜æ¬¾é …
                setoffProductDetails = new List<SetoffProductDetail>();
                setoffPayments = new List<SetoffPayment>();
                setoffPrepayments = new List<SetoffPrepayment>(); 
            }
            else
            {
                // ç·¨è¼¯æ¨¡å¼
                setoffDocument = await SetoffDocumentService.GetByIdAsync(SetoffDocumentId.Value);
                
                // è¼‰å…¥å•†å“æ˜ç´°
                setoffProductDetails = await SetoffProductDetailService.GetBySetoffDocumentIdAsync(SetoffDocumentId.Value);
                
                // è¼‰å…¥æ”¶æ¬¾è¨˜éŒ„
                setoffPayments = await SetoffPaymentService.GetBySetoffDocumentIdAsync(SetoffDocumentId.Value);
                
                // è¼‰å…¥é æ”¶ä»˜æ¬¾é …ï¼ˆåŒ…å«ä¸»è¨˜éŒ„å’Œä½¿ç”¨è¨˜éŒ„ï¼‰
                setoffPrepayments = new List<SetoffPrepayment>();
                
                // 1. è¼‰å…¥é æ”¶/é ä»˜ä¸»è¨˜éŒ„ï¼ˆAmount > 0ï¼‰
                var prepaymentRecords = await SetoffPrepaymentService.GetBySetoffDocumentIdAsync(SetoffDocumentId.Value);
                setoffPrepayments.AddRange(prepaymentRecords);
                
                // 2. è¼‰å…¥è½‰æ²–æ¬¾ä½¿ç”¨è¨˜éŒ„ï¼ˆUsedAmount > 0ï¼‰ï¼Œè½‰æ›ç‚º SetoffPrepayment æ ¼å¼ä¾›å‰ç«¯é¡¯ç¤º
                var usageRecords = await SetoffPrepaymentUsageService.GetBySetoffDocumentIdAsync(SetoffDocumentId.Value);
                
                // å–å¾—æ‰€æœ‰é æ”¶ä»˜é¡å‹ï¼Œç”¨æ–¼æŸ¥è©¢ã€Œè½‰æ²–æ¬¾ã€é¡å‹ID
                var allPrepaymentTypes = await PrepaymentTypeService.GetAllAsync();
                
                foreach (var usage in usageRecords)
                {
                    // æ ¹æ“šä¾†æºé æ”¶ä»˜æ¬¾é …çš„é¡å‹ï¼Œåˆ¤æ–·æ‡‰è©²ä½¿ç”¨å“ªå€‹ã€Œè½‰æ²–æ¬¾ã€é¡å‹
                    // ä¾†æºæ˜¯ã€Œé æ”¶ã€â†’ ä½¿ç”¨ã€Œé æ”¶è½‰æ²–æ¬¾ã€
                    // ä¾†æºæ˜¯ã€Œé ä»˜ã€â†’ ä½¿ç”¨ã€Œé ä»˜è½‰æ²–æ¬¾ã€
                    var sourceType = usage.SetoffPrepayment.PrepaymentType?.Name ?? string.Empty;
                    var transferTypeName = sourceType.Contains("é æ”¶") ? "é æ”¶è½‰æ²–æ¬¾" : "é ä»˜è½‰æ²–æ¬¾";
                    var transferType = allPrepaymentTypes.FirstOrDefault(pt => pt.Name == transferTypeName);
                    
                    if (transferType == null)
                    {
                        await NotificationService.ShowErrorAsync($"æ‰¾ä¸åˆ°é æ”¶ä»˜é¡å‹ï¼š{transferTypeName}");
                        continue;
                    }
                    
                    // è½‰æ›ç‚º SetoffPrepayment æ ¼å¼ï¼Œè®“å‰ç«¯çµ„ä»¶å¯ä»¥çµ±ä¸€è™•ç†
                    setoffPrepayments.Add(new SetoffPrepayment
                    {
                        Id = 0,  // ä½¿ç”¨è¨˜éŒ„æ²’æœ‰ SetoffPrepayment çš„ ID
                        PrepaymentTypeId = transferType.Id,  // âœ… ä½¿ç”¨ã€Œè½‰æ²–æ¬¾ã€é¡å‹çš„ID
                        SourceDocumentCode = usage.SourcePrepaymentCode ?? usage.SetoffPrepayment.SourceDocumentCode,  // âœ… å„ªå…ˆä½¿ç”¨ SourcePrepaymentCode
                        SourcePrepaymentId = usage.SetoffPrepaymentId,  // âœ… ç›´æ¥ä½¿ç”¨ä¾†æºé æ”¶ä»˜æ¬¾é …çš„ ID
                        Amount = usage.SetoffPrepayment.Amount,  // âœ… ä¿å­˜ä¾†æºçš„ç¸½é‡‘é¡ï¼ˆç”¨æ–¼å‰ç«¯é¡¯ç¤ºã€Œç¸½é‡‘é¡ã€æ¬„ä½ï¼‰
                        UsedAmount = usage.UsedAmount,  // è½‰æ²–æ¬¾ï¼šè¨˜éŒ„ä½¿ç”¨é‡‘é¡
                        CustomerId = usage.SetoffPrepayment.CustomerId,
                        SupplierId = usage.SetoffPrepayment.SupplierId,
                        SetoffDocumentId = SetoffDocumentId.Value,
                        Remarks = string.Empty  // âœ… å‚™è¨»æ¢å¾©æ­£å¸¸ç”¨é€”ï¼Œä¸å†å„²å­˜ SOURCE_ID
                    });
                }
                
                // ç·¨è¼¯æ¨¡å¼ï¼šè¼‰å…¥è³‡æ–™å¾Œï¼Œé‡æ–°è¨ˆç®—é æ”¶ä»˜æ¬¾é …ç›¸é—œæ¬„ä½
                if (setoffDocument != null)
                {
                    var prepaymentUsedAmount = 0m;  // è½‰æ²–æ¬¾é¡å‹
                    var prepaymentAmount = 0m;       // é æ”¶/ä»˜é¡å‹
                    
                    foreach (var prepayment in setoffPrepayments)
                    {
                        var prepaymentType = allPrepaymentTypes.FirstOrDefault(pt => pt.Id == prepayment.PrepaymentTypeId);
                        if (prepaymentType != null && prepaymentType.Name.Contains("è½‰æ²–æ¬¾"))
                        {
                            prepaymentUsedAmount += prepayment.UsedAmount;
                        }
                        else
                        {
                            prepaymentAmount += prepayment.Amount;
                        }
                    }
                    
                    // è¨­å®šé æ”¶ä»˜æ¬¾é …ç›¸é—œæ¬„ä½
                    setoffDocument.CurrentPrepaymentAmount = prepaymentAmount;
                    setoffDocument.PrepaymentSetoffAmount = prepaymentUsedAmount;
                }
            }
            
            // è³‡æ–™è¼‰å…¥å¾Œï¼Œé‡æ–°åˆå§‹åŒ–è¡¨å–®æ¬„ä½ä»¥æ­£ç¢ºé¡¯ç¤ºå®¢æˆ¶æˆ–å» å•†æ¬„ä½
            // ä½¿ç”¨ Task.Run ç¢ºä¿åœ¨ä¸‹ä¸€å€‹æ¸²æŸ“é€±æœŸåŸ·è¡Œ
            _ = Task.Run(async () =>
            {
                await InvokeAsync(async () =>
                {
                    await InitializeFormFieldsAsync();
                    StateHasChanged();
                });
            });
            
            return setoffDocument;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥æ²–æ¬¾å–®è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
            return null;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // è¼‰å…¥å…¬å¸åˆ—è¡¨
            companies = await CompanyService.GetAllAsync();
            
            // è¼‰å…¥å®¢æˆ¶åˆ—è¡¨ï¼ˆç”¨æ–¼æ‡‰æ”¶å¸³æ¬¾ï¼‰
            customers = await CustomerService.GetAllAsync();
            
            // è¼‰å…¥å» å•†åˆ—è¡¨ï¼ˆç”¨æ–¼æ‡‰ä»˜å¸³æ¬¾ï¼‰
            suppliers = await SupplierService.GetAllAsync();
            
            // é…ç½® AutoComplete
            autoCompleteConfig = new AutoCompleteConfigBuilder<SetoffDocument>()
                .AddField(nameof(SetoffDocument.CompanyId), "CompanyName", companies)
                .AddField("CustomerId", "CompanyName", customers)
                .AddField("SupplierId", "CompanyName", suppliers)
                .Build();
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("è¼‰å…¥æ²–æ¬¾å–®ç·¨è¼¯ç›¸é—œè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
            companies = new List<Company>();
            customers = new List<Customer>();
            suppliers = new List<Supplier>();
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            // å‹•æ…‹åŠ å…¥å®¢æˆ¶æˆ–å» å•†æ¬„ä½ - å…ˆåˆ¤æ–·é¡å‹
            var currentSetoffType = editModalComponent?.Entity?.SetoffType ?? DefaultSetoffType ?? SetoffType.AccountsReceivable;
            
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SetoffDocument.Code),
                    Label = "æ²–æ¬¾å–®è™Ÿ",
                    FieldType = FormFieldType.Text,
                    Placeholder = "è«‹è¼¸å…¥æ²–æ¬¾å–®è™Ÿ",
                    IsRequired = true,
                    MaxLength = 50,
                    HelpText = "æ²–æ¬¾å–®çš„å”¯ä¸€è­˜åˆ¥è™Ÿç¢¼ï¼Œæ–°å¢æ™‚ç³»çµ±æœƒè‡ªå‹•ç”¢ç”Ÿï¼Œä¹Ÿå¯æ‰‹å‹•ä¿®æ”¹"
                }
            };

            // æ ¹æ“šæ²–æ¬¾é¡å‹å‹•æ…‹åŠ å…¥å®¢æˆ¶æˆ–å» å•†æ¬„ä½ï¼ˆç·Šæ¥åœ¨æ²–æ¬¾å–®è™Ÿä¹‹å¾Œï¼‰
            if (currentSetoffType == SetoffType.AccountsReceivable)
            {
                // æ‡‰æ”¶å¸³æ¬¾ï¼šé¡¯ç¤ºå®¢æˆ¶æ¬„ä½
                formFields.Add(new()
                {
                    PropertyName = "CustomerId",
                    Label = "å®¢æˆ¶",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡å®¢æˆ¶",
                    MinSearchLength = 0,
                    IsRequired = true,
                    HelpText = "é¸æ“‡æ‡‰æ”¶å¸³æ¬¾çš„å®¢æˆ¶",
                    ActionButtons = await GetCustomerActionButtonsAsync()
                });
            }
            else if (currentSetoffType == SetoffType.AccountsPayable)
            {
                // æ‡‰ä»˜å¸³æ¬¾ï¼šé¡¯ç¤ºå» å•†æ¬„ä½
                formFields.Add(new()
                {
                    PropertyName = "SupplierId",
                    Label = "å» å•†",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "è«‹è¼¸å…¥æˆ–é¸æ“‡å» å•†",
                    MinSearchLength = 0,
                    IsRequired = true,
                    HelpText = "é¸æ“‡æ‡‰ä»˜å¸³æ¬¾çš„å» å•†",
                    ActionButtons = await GetSupplierActionButtonsAsync()
                });
            }

            // ç¹¼çºŒåŠ å…¥å…¶ä»–å…±ç”¨æ¬„ä½
            formFields.AddRange(new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SetoffDocument.SetoffDate),
                    Label = "æ²–æ¬¾æ—¥æœŸ",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "æ²–æ¬¾å–®çš„å»ºç«‹æ—¥æœŸ"
                },
                new()
                {
                    PropertyName = nameof(SetoffDocument.CompanyId),
                    Label = "å…¬å¸",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = companies.Count == 1 ? companies.First().CompanyName : "è«‹è¼¸å…¥æˆ–é¸æ“‡å…¬å¸",
                    MinSearchLength = 0, // å…è¨±ç©ºç™½æœå°‹ä»¥é¡¯ç¤ºæ‰€æœ‰é¸é …ï¼ˆç•¶åªæœ‰ä¸€ç­†æ™‚æœƒè‡ªå‹•é¡¯ç¤ºï¼‰
                    IsRequired = true,
                    HelpText = "é¸æ“‡æ²–æ¬¾å–®æ‰€å±¬çš„å…¬å¸",
                    ActionButtons = await GetCompanyActionButtonsAsync()
                },
                new()
                {
                    PropertyName = "FilterStartDate",
                    Label = "èµ·å§‹æ—¥æœŸ",
                    FieldType = FormFieldType.Date,
                    IsRequired = false,
                    HelpText = "ç¯©é¸è©²æ—¥æœŸä¹‹å¾Œçš„éŠ·è²¨ã€éŠ·è²¨é€€å›ã€å…¥åº«ã€å…¥åº«é€€å‡ºå–®æ“š"
                },
                new()
                {
                    PropertyName = "FilterEndDate",
                    Label = "çµæŸæ—¥æœŸ",
                    FieldType = FormFieldType.Date,
                    IsRequired = false,
                    HelpText = "ç¯©é¸è©²æ—¥æœŸä¹‹å‰çš„éŠ·è²¨ã€éŠ·è²¨é€€å›ã€å…¥åº«ã€å…¥åº«é€€å‡ºå–®æ“š"
                }
            });

            // æ ¹æ“šæ²–æ¬¾é¡å‹æ±ºå®šæ¬„ä½æ¨™ç±¤
            var isReceivable = currentSetoffType == SetoffType.AccountsReceivable;
            var receivableOrPayableLabel = isReceivable ? "æ‡‰æ”¶" : "æ‡‰ä»˜";
            var receivedOrPaidLabel = isReceivable ? "å·²æ”¶" : "å·²ä»˜";
            var prepaymentLabel = isReceivable ? "é æ”¶" : "é ä»˜";
            var prepaymentSetoffLabel = isReceivable ? "é æ”¶æ²–æ¬¾" : "é ä»˜æ²–æ¬¾";
            
            // ç¹¼çºŒåŠ å…¥é‡‘é¡ç›¸é—œæ¬„ä½
            formFields.AddRange(new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SetoffDocument.TotalSetoffAmount),
                    Label = $"æœ¬æœŸ{receivableOrPayableLabel}",
                    FieldType = FormFieldType.Number,
                    Placeholder = "ç³»çµ±è‡ªå‹•è¨ˆç®—",
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "æ²–æ¬¾å–®çš„ç¸½é‡‘é¡",
                },
                new()
                {
                    PropertyName = nameof(SetoffDocument.TotalCollectionAmount),
                    Label = $"æœ¬æœŸ{receivedOrPaidLabel}",
                    FieldType = FormFieldType.Number,
                    Placeholder = "ç³»çµ±è‡ªå‹•è¨ˆç®—",
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = $"å¯¦éš›{receivedOrPaidLabel.Substring(1)}çš„æ¬¾é …ç¸½é¡",
                },
                new()
                {
                    PropertyName = nameof(SetoffDocument.CurrentSetoffAmount),
                    Label = "æœ¬æœŸæ²–éŠ·",
                    FieldType = FormFieldType.Number,
                    Placeholder = "ç³»çµ±è‡ªå‹•è¨ˆç®—",
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "æœ¬æ¬¡æ²–æ¬¾å–®æ‰€æ²–éŠ·çš„é‡‘é¡",
                },
                new()
                {
                    PropertyName = nameof(SetoffDocument.TotalAllowanceAmount),
                    Label = "æœ¬æœŸæŠ˜è®“",
                    FieldType = FormFieldType.Number,
                    Placeholder = "ç³»çµ±è‡ªå‹•è¨ˆç®—",
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "æŠ˜è®“æŠµéŠ·çš„ç¸½é¡",
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SetoffDocument.CurrentPrepaymentAmount),
                    Label = $"æœ¬æœŸ{prepaymentLabel}",
                    FieldType = FormFieldType.Number,
                    Placeholder = "ç³»çµ±è‡ªå‹•è¨ˆç®—",
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = $"æœ¬æ¬¡{prepaymentLabel}çš„ç¸½é¡",
                },
                new FormFieldDefinition()
                {
                    PropertyName = nameof(SetoffDocument.PrepaymentSetoffAmount),
                    Label = prepaymentSetoffLabel,
                    FieldType = FormFieldType.Number,
                    Placeholder = "ç³»çµ±è‡ªå‹•è¨ˆç®—",
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = $"{prepaymentSetoffLabel}çš„ç¸½é¡",
                },

                FormFieldConfigurationHelper.CreateRemarksField<SetoffDocument>(),
            });


            
            // å‹•æ…‹è¨­å®šè¡¨å–®å€æ®µ - ä½¿ç”¨ FormSectionHelper
            var helper = FormSectionHelper<SetoffDocument>.Create()
                .AddToSection(FormSectionNames.BasicInfo, sd => sd.Code);
            
            // æ ¹æ“šæ²–æ¬¾é¡å‹å‹•æ…‹åŠ å…¥å®¢æˆ¶æˆ–å» å•†æ¬„ä½ï¼ˆåœ¨å–®è™Ÿä¹‹å¾Œï¼‰
            if (currentSetoffType == SetoffType.AccountsReceivable)
            {
                helper.AddCustomFields(FormSectionNames.BasicInfo, "CustomerId");
            }
            else if (currentSetoffType == SetoffType.AccountsPayable)
            {
                helper.AddCustomFields(FormSectionNames.BasicInfo, "SupplierId");
            }
            
            // åŠ å…¥å…¬å¸æ¬„ä½ã€æ—¥æœŸç¯©é¸æ¬„ä½å’Œæ²–æ¬¾æ—¥æœŸ
            helper.AddToSection(FormSectionNames.BasicInfo, sd => sd.CompanyId)
                .AddCustomFields(FormSectionNames.BasicInfo, 
                    "FilterStartDate", 
                    "FilterEndDate")
                .AddToSection(FormSectionNames.BasicInfo, sd => sd.SetoffDate);
            
            // åŠ å…¥é‡‘é¡ç›¸é—œå€æ®µ
            formSections = helper
                .AddToSection(FormSectionNames.AmountInfo,
                    sd => sd.TotalSetoffAmount,
                    sd => sd.TotalCollectionAmount,
                    sd => sd.CurrentSetoffAmount,
                    sd => sd.TotalAllowanceAmount,
                    sd => sd.CurrentPrepaymentAmount,
                    sd => sd.PrepaymentSetoffAmount)
                .AddToSection(FormSectionNames.OtherInfo,
                    sd => sd.Remarks)
                .Build();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("åˆå§‹åŒ–è¡¨å–®æ¬„ä½æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }

    /// <summary>
    /// æ¬„ä½è®Šæ›´äº‹ä»¶è™•ç†
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {            
            // ä½¿ç”¨çµ±ä¸€ Helper è™•ç†å…¬å¸æ¬„ä½è®Šæ›´
            if (fieldChange.PropertyName == nameof(SetoffDocument.CompanyId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    companyModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
            }
            
            // è™•ç†å®¢æˆ¶æ¬„ä½è®Šæ›´
            if (fieldChange.PropertyName == "CustomerId" && editModalComponent?.Entity != null)
            {
                if (fieldChange.Value != null && int.TryParse(fieldChange.Value.ToString(), out int customerId))
                {
                    editModalComponent.Entity.RelatedPartyId = customerId;
                    editModalComponent.Entity.RelatedPartyType = "Customer";
                    
                    // æ›´æ–° RelatedPartyName
                    var customer = customers.FirstOrDefault(c => c.Id == customerId);
                    if (customer != null)
                    {
                        editModalComponent.Entity.RelatedPartyName = customer.CompanyName ?? "";
                    }
                    
                    // æ›´æ–° ActionButtons
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        customerModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                }
            }
            
            // è™•ç†å» å•†æ¬„ä½è®Šæ›´
            if (fieldChange.PropertyName == "SupplierId" && editModalComponent?.Entity != null)
            {
                if (fieldChange.Value != null && int.TryParse(fieldChange.Value.ToString(), out int supplierId))
                {
                    editModalComponent.Entity.RelatedPartyId = supplierId;
                    editModalComponent.Entity.RelatedPartyType = "Supplier";
                    
                    // æ›´æ–° RelatedPartyName
                    var supplier = suppliers.FirstOrDefault(s => s.Id == supplierId);
                    if (supplier != null)
                    {
                        editModalComponent.Entity.RelatedPartyName = supplier.CompanyName;
                    }
                    
                    // æ›´æ–° ActionButtons
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        supplierModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                }
            }
            
            // è™•ç†æ—¥æœŸç¯©é¸è®Šæ›´
            if (fieldChange.PropertyName == "FilterStartDate")
            {
                if (fieldChange.Value != null && DateTime.TryParse(fieldChange.Value.ToString(), out DateTime startDate))
                {
                    filterStartDate = startDate;
                }
                else
                {
                    filterStartDate = null;
                }
                StateHasChanged();
            }
            
            if (fieldChange.PropertyName == "FilterEndDate")
            {
                if (fieldChange.Value != null && DateTime.TryParse(fieldChange.Value.ToString(), out DateTime endDate))
                {
                    filterEndDate = endDate;
                }
                else
                {
                    filterEndDate = null;
                }
                StateHasChanged();
            }
        }
        catch (Exception)
        {
            // å¿½ç•¥éŒ¯èª¤
        }
    }

    // ===== Modal ç®¡ç†å™¨ =====
    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(SetoffDocument.CompanyId), companyModalManager },
            { "CustomerId", customerModalManager },
            { "SupplierId", supplierModalManager }
        };
    }

    // ===== Action Buttons =====
    private async Task<List<FieldActionButton>> GetCompanyActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent,
            companyModalManager,
            nameof(SetoffDocument.CompanyId)
        );
    }

    private Task<List<FieldActionButton>> GetCustomerActionButtonsAsync()
    {
        // å–å¾—ç›®å‰çš„ RelatedPartyId (ç•¶ SetoffType æ˜¯æ‡‰æ”¶å¸³æ¬¾æ™‚)
        int? currentCustomerId = null;
        if (editModalComponent?.Entity?.SetoffType == SetoffType.AccountsReceivable && 
            editModalComponent.Entity.RelatedPartyType == "Customer")
        {
            currentCustomerId = editModalComponent.Entity.RelatedPartyId > 0 
                ? editModalComponent.Entity.RelatedPartyId 
                : null;
        }
        
        return Task.FromResult(customerModalManager.GenerateActionButtons(currentCustomerId));
    }

    private Task<List<FieldActionButton>> GetSupplierActionButtonsAsync()
    {
        // å–å¾—ç›®å‰çš„ RelatedPartyId (ç•¶ SetoffType æ˜¯æ‡‰ä»˜å¸³æ¬¾æ™‚)
        int? currentSupplierId = null;
        if (editModalComponent?.Entity?.SetoffType == SetoffType.AccountsPayable && 
            editModalComponent.Entity.RelatedPartyType == "Supplier")
        {
            currentSupplierId = editModalComponent.Entity.RelatedPartyId > 0 
                ? editModalComponent.Entity.RelatedPartyId 
                : null;
        }
        
        return Task.FromResult(supplierModalManager.GenerateActionButtons(currentSupplierId));
    }

    private async Task OnCompanySavedWrapper(Company company)
    {
        await companyModalManager.HandleEntitySavedAsync(company, shouldAutoSelect: true);
    }

    private async Task OnCustomerSavedWrapper(Customer customer)
    {
        await customerModalManager.HandleEntitySavedAsync(customer, shouldAutoSelect: true);
    }

    private async Task OnSupplierSavedWrapper(Supplier supplier)
    {
        await supplierModalManager.HandleEntitySavedAsync(supplier, shouldAutoSelect: true);
    }

    /// <summary>
    /// å–å¾—é—œè¯æ–¹åç¨±ï¼ˆå®¢æˆ¶æˆ–å» å•†åç¨±ï¼‰
    /// </summary>
    private string? GetRelatedPartyName()
    {
        if (editModalComponent?.Entity == null || editModalComponent.Entity.RelatedPartyId <= 0)
            return null;
            
        if (editModalComponent.Entity.SetoffType == SetoffType.AccountsReceivable)
        {
            // æ‡‰æ”¶å¸³æ¬¾ - å–å¾—å®¢æˆ¶åç¨±
            var customer = customers.FirstOrDefault(c => c.Id == editModalComponent.Entity.RelatedPartyId);
            return customer?.CompanyName;
        }
        else
        {
            // æ‡‰ä»˜å¸³æ¬¾ - å–å¾—å» å•†åç¨±
            var supplier = suppliers.FirstOrDefault(s => s.Id == editModalComponent.Entity.RelatedPartyId);
            return supplier?.CompanyName;
        }
    }

    /// <summary>
    /// é…ç½®è‡ªè¨‚æ¨¡çµ„
    /// </summary>
    private List<GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule> GetCustomModules()
    {
        try
        {
            if (editModalComponent == null)
            {
                return new List<GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule>();
            }

            return new List<GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule>
            {
                new GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule
                {
                    Title = "",
                    Content = CreateSetoffProductDetailManagerContent(),
                    Order = 1
                },
                new GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule
                {
                    Title = "",
                    Content = CreateSetoffPaymentDetailManagerContent(),
                    Order = 2
                },
                new GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule
                {
                    Title = "",
                    Content = CreateSetoffPrepaymentDetailManagerContent(),
                    Order = 3
                }
            };
        }
        catch
        {
            return new List<GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule>();
        }
    }

    /// <summary>
    /// å‰µå»ºæ²–éŠ·å•†å“æ˜ç´°ç®¡ç†å™¨å…§å®¹çš„ RenderFragment
    /// </summary>
    private RenderFragment CreateSetoffProductDetailManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null && editModalComponent.Entity.RelatedPartyId > 0)
            {
                <SetoffProductTable 
                    @ref="setoffProductDetailManager"
                    @key="@editModalComponent.Entity.Id"
                    SetoffDocumentId="@SetoffDocumentId"
                    SetoffType="@editModalComponent.Entity.SetoffType"
                    RelatedPartyId="@editModalComponent.Entity.RelatedPartyId"
                    RelatedPartyType="@editModalComponent.Entity.RelatedPartyType"
                    RelatedPartyName="@GetRelatedPartyName()"
                    StartDate="@filterStartDate"
                    EndDate="@filterEndDate"
                    ExistingDetails="@setoffProductDetails"
                    OnDetailsChanged="@HandleProductDetailsChanged"
                    IsReadOnly="@IsReadOnly" />
            }
            else
            {
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    è«‹å…ˆé¸æ“‡@(editModalComponent?.Entity?.SetoffType == SetoffType.AccountsReceivable ? "å®¢æˆ¶" : "å» å•†")ä»¥è¼‰å…¥å•†å“æ˜ç´°
                </div>
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                è¼‰å…¥æ˜ç´°ç®¡ç†å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤,è«‹é‡æ–°æ•´ç†é é¢ã€‚
            </div>
        }
    };
    
    /// <summary>
    /// å‰µå»ºæ”¶æ¬¾è¨˜éŒ„ç®¡ç†å™¨å…§å®¹çš„ RenderFragment
    /// </summary>
    private RenderFragment CreateSetoffPaymentDetailManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null && editModalComponent.Entity.RelatedPartyId > 0)
            {
                <SetoffPaymentTable
                    @ref="setoffPaymentTable"
                    SetoffDocumentId="@SetoffDocumentId"
                    SetoffType="@(editModalComponent.Entity.SetoffType)"
                    ExistingPayments="@setoffPayments"
                    OnPaymentsChanged="@HandlePaymentsChanged"
                    IsReadOnly="@IsReadOnly" />
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                è¼‰å…¥æ”¶æ¬¾è¨˜éŒ„ç®¡ç†å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤,è«‹é‡æ–°æ•´ç†é é¢ã€‚
            </div>
        }
    };
    /// <summary>
    /// å‰µå»ºé æ”¶ä»˜æ¬¾é …ç®¡ç†å™¨å…§å®¹çš„ RenderFragment
    /// </summary>
    private RenderFragment CreateSetoffPrepaymentDetailManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null && editModalComponent.Entity.RelatedPartyId > 0)
            {
                <SetoffPrepaymentTable @ref="setoffPrepaymentDetailManager"
                                                       SetoffDocumentId="@SetoffDocumentId"
                                                       SetoffType="@editModalComponent.Entity.SetoffType"
                                                       CustomerId="@(editModalComponent.Entity.SetoffType == SetoffType.AccountsReceivable ? editModalComponent.Entity.RelatedPartyId : null)"
                                                       SupplierId="@(editModalComponent.Entity.SetoffType == SetoffType.AccountsPayable ? editModalComponent.Entity.RelatedPartyId : null)"
                                                       SetoffDocumentNumber="@editModalComponent.Entity.Code"
                                                       ExistingPrepayments="@setoffPrepayments"
                                                       OnPrepaymentsChanged="@HandlePrepaymentsChanged"
                                                       OnOpenRelatedDocument="@HandleOpenRelatedDocument"
                                                       IsReadOnly="@IsReadOnly" />
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                è¼‰å…¥é æ”¶ä»˜æ¬¾é …ç®¡ç†å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤,è«‹é‡æ–°æ•´ç†é é¢ã€‚
            </div>
        }
    };

    /// <summary>
    /// è™•ç†é–‹å•Ÿç›¸é—œå–®æ“šçš„äº‹ä»¶ï¼ˆä½¿ç”¨é æ”¶ä»˜æ¬¾é …çš„æ²–æ¬¾å–®ï¼‰
    /// </summary>
    private async Task HandleOpenRelatedDocument((RelatedDocumentType type, int id) args)
    {
        try
        {
            if (args.type == RelatedDocumentType.SetoffDocument)
            {
                // é–‹å•Ÿå¦ä¸€å€‹æ²–æ¬¾å–® Modalï¼ˆä½¿ç”¨äº†é æ”¶ä»˜æ¬¾é …çš„æ²–æ¬¾å–®ï¼‰
                // é¡¯ç¤ºè¨Šæ¯é€šçŸ¥ä½¿ç”¨è€…
                await NotificationService.ShowInfoAsync(
                    $"å³å°‡é–‹å•Ÿç›¸é—œæ²–æ¬¾å–®ï¼ˆID: {args.id}ï¼‰\n\n" +
                    "æ³¨æ„ï¼šç›®å‰ç³»çµ±ä¸æ”¯æ´åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹é–‹å•Ÿå¤šå±¤æ²–æ¬¾å–®ã€‚\n" +
                    "è«‹é—œé–‰ç›®å‰çš„æ²–æ¬¾å–®å¾Œï¼Œå¾æ²–æ¬¾å–®åˆ—è¡¨ä¸­é–‹å•Ÿç›®æ¨™æ²–æ¬¾å–®ã€‚",
                    "åŠŸèƒ½æç¤º");
            }
            else
            {
                await NotificationService.ShowWarningAsync($"ä¸æ”¯æ´çš„å–®æ“šé¡å‹ï¼š{args.type}");
            }
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"é–‹å•Ÿå–®æ“šå¤±æ•—ï¼š{ex.Message}");
        }
    }

    // ===== å…¬é–‹æ–¹æ³•ï¼ˆä¾›å¤–éƒ¨çµ„ä»¶èª¿ç”¨ï¼‰ =====
    
    /// <summary>
    /// é–‹å•Ÿæ–°å¢æ²–æ¬¾å–® Modal ä¸¦é å¡«é€²è²¨å–®è³‡è¨Šï¼ˆå…¬é–‹æ–¹æ³•ä¾›å¤–éƒ¨èª¿ç”¨ï¼‰
    /// </summary>
    /// <param name="supplierId">å» å•†ID</param>
    /// <param name="purchaseReceivingId">é€²è²¨å–®ID</param>
    /// <remarks>
    /// æ­¤æ–¹æ³•ç”¨æ–¼ã€Œé€²è²¨è½‰æ²–æ¬¾ã€åŠŸèƒ½ï¼Œæœƒï¼š
    /// 1. è¨­å®šæ²–æ¬¾é¡å‹ç‚ºã€Œæ‡‰ä»˜å¸³æ¬¾ã€
    /// 2. é å¡«å» å•†è³‡è¨Š
    /// 3. è‡ªå‹•è¼‰å…¥æŒ‡å®šé€²è²¨å–®çš„æœªçµæ¸…æ˜ç´°
    /// </remarks>
    public async Task ShowAddModalWithPrefilledReceiving(int supplierId, int purchaseReceivingId)
    {
        try
        {
            // ä½¿ç”¨ DocumentConversionHelper çµ±ä¸€è™•ç†è½‰å–®é‚è¼¯
            var success = await DocumentConversionHelper.ShowConversionModalAsync(
                setPrefilledValues: () =>
                {
                    SetoffDocumentId = null;
                    PrefilledSupplierId = supplierId;
                    PrefilledPurchaseReceivingId = purchaseReceivingId;
                    DefaultSetoffType = SetoffType.AccountsPayable;
                    // è¨­å®šç¯©é¸IDï¼ˆç¢ºä¿æ˜ç´°ç®¡ç†å™¨æ¸²æŸ“æ™‚å°±èƒ½ä½¿ç”¨æ­£ç¢ºçš„ç¯©é¸åƒæ•¸ï¼‰
                    filterPurchaseReceivingId = purchaseReceivingId;
                    shouldAutoLoadFromReceiving = true;
                },
                isVisibleChanged: IsVisibleChanged,
                autoLoadAction: async () =>
                {
                    shouldAutoLoadFromReceiving = false;
                    if (setoffProductDetailManager != null)
                    {
                        await setoffProductDetailManager.LoadDetailsFromPurchaseReceiving(purchaseReceivingId);
                    }
                },
                detailManagerReady: () => setoffProductDetailManager != null,
                shouldAutoLoad: () => shouldAutoLoadFromReceiving,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("è½‰å–®æµç¨‹åŸ·è¡Œå¤±æ•—");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledReceiving), GetType(), 
                additionalData: $"é–‹å•Ÿé å¡«æ²–æ¬¾å–®Modalå¤±æ•— - SupplierId: {supplierId}, ReceivingId: {purchaseReceivingId}");
            await NotificationService.ShowErrorAsync("é–‹å•Ÿæ²–æ¬¾å–®æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    /// <summary>
    /// é–‹å•Ÿæ–°å¢æ²–æ¬¾å–® Modal ä¸¦é å¡«é€²è²¨é€€å‡ºè³‡è¨Šï¼ˆå…¬é–‹æ–¹æ³•ä¾›å¤–éƒ¨èª¿ç”¨ï¼‰
    /// </summary>
    /// <param name="supplierId">å» å•†ID</param>
    /// <param name="purchaseReturnId">é€²è²¨é€€å‡ºID</param>
    public async Task ShowAddModalWithPrefilledPurchaseReturn(int supplierId, int purchaseReturnId)
    {
        try
        {
            var success = await DocumentConversionHelper.ShowConversionModalAsync(
                setPrefilledValues: () =>
                {
                    SetoffDocumentId = null;
                    PrefilledSupplierId = supplierId;
                    PrefilledPurchaseReturnId = purchaseReturnId;
                    DefaultSetoffType = SetoffType.AccountsPayable;
                    filterPurchaseReturnId = purchaseReturnId;
                    shouldAutoLoadFromPurchaseReturn = true;
                },
                isVisibleChanged: IsVisibleChanged,
                autoLoadAction: async () =>
                {
                    shouldAutoLoadFromPurchaseReturn = false;
                    if (setoffProductDetailManager != null)
                    {
                        await setoffProductDetailManager.LoadDetailsFromPurchaseReturn(purchaseReturnId);
                    }
                },
                detailManagerReady: () => setoffProductDetailManager != null,
                shouldAutoLoad: () => shouldAutoLoadFromPurchaseReturn,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("è½‰å–®æµç¨‹åŸ·è¡Œå¤±æ•—");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledPurchaseReturn), GetType(), 
                additionalData: $"é–‹å•Ÿé å¡«æ²–æ¬¾å–®Modalå¤±æ•— - SupplierId: {supplierId}, PurchaseReturnId: {purchaseReturnId}");
            await NotificationService.ShowErrorAsync("é–‹å•Ÿæ²–æ¬¾å–®æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    /// <summary>
    /// é–‹å•Ÿæ–°å¢æ²–æ¬¾å–® Modal ä¸¦é å¡«éŠ·è²¨å‡ºè²¨è³‡è¨Šï¼ˆå…¬é–‹æ–¹æ³•ä¾›å¤–éƒ¨èª¿ç”¨ï¼‰
    /// </summary>
    /// <param name="customerId">å®¢æˆ¶ID</param>
    /// <param name="salesDeliveryId">éŠ·è²¨å‡ºè²¨ID</param>
    public async Task ShowAddModalWithPrefilledDelivery(int customerId, int salesDeliveryId)
    {
        try
        {
            var success = await DocumentConversionHelper.ShowConversionModalAsync(
                setPrefilledValues: () =>
                {
                    SetoffDocumentId = null;
                    PrefilledCustomerId = customerId;
                    PrefilledSalesDeliveryId = salesDeliveryId;
                    DefaultSetoffType = SetoffType.AccountsReceivable;
                    filterSalesDeliveryId = salesDeliveryId;
                    shouldAutoLoadFromDelivery = true;
                },
                isVisibleChanged: IsVisibleChanged,
                autoLoadAction: async () =>
                {
                    shouldAutoLoadFromDelivery = false;
                    if (setoffProductDetailManager != null)
                    {
                        await setoffProductDetailManager.LoadDetailsFromSalesDelivery(salesDeliveryId);
                    }
                },
                detailManagerReady: () => setoffProductDetailManager != null,
                shouldAutoLoad: () => shouldAutoLoadFromDelivery,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("è½‰å–®æµç¨‹åŸ·è¡Œå¤±æ•—");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledDelivery), GetType(), 
                additionalData: $"é–‹å•Ÿé å¡«æ²–æ¬¾å–®Modalå¤±æ•— - CustomerId: {customerId}, SalesDeliveryId: {salesDeliveryId}");
            await NotificationService.ShowErrorAsync("é–‹å•Ÿæ²–æ¬¾å–®æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
    
    /// <summary>
    /// é–‹å•Ÿæ–°å¢æ²–æ¬¾å–® Modal ä¸¦é å¡«éŠ·è²¨é€€å›è³‡è¨Šï¼ˆå…¬é–‹æ–¹æ³•ä¾›å¤–éƒ¨èª¿ç”¨ï¼‰
    /// </summary>
    /// <param name="customerId">å®¢æˆ¶ID</param>
    /// <param name="salesReturnId">éŠ·è²¨é€€å›ID</param>
    public async Task ShowAddModalWithPrefilledSalesReturn(int customerId, int salesReturnId)
    {
        try
        {
            var success = await DocumentConversionHelper.ShowConversionModalAsync(
                setPrefilledValues: () =>
                {
                    SetoffDocumentId = null;
                    PrefilledCustomerId = customerId;
                    PrefilledSalesReturnId = salesReturnId;
                    DefaultSetoffType = SetoffType.AccountsReceivable;
                    filterSalesReturnId = salesReturnId;
                    shouldAutoLoadFromSalesReturn = true;
                },
                isVisibleChanged: IsVisibleChanged,
                autoLoadAction: async () =>
                {
                    shouldAutoLoadFromSalesReturn = false;
                    if (setoffProductDetailManager != null)
                    {
                        await setoffProductDetailManager.LoadDetailsFromSalesReturn(salesReturnId);
                    }
                },
                detailManagerReady: () => setoffProductDetailManager != null,
                shouldAutoLoad: () => shouldAutoLoadFromSalesReturn,
                stateHasChangedAction: StateHasChanged,
                invokeAsync: InvokeAsync
            );

            if (!success)
            {
                throw new Exception("è½‰å–®æµç¨‹åŸ·è¡Œå¤±æ•—");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ShowAddModalWithPrefilledSalesReturn), GetType(), 
                additionalData: $"é–‹å•Ÿé å¡«æ²–æ¬¾å–®Modalå¤±æ•— - CustomerId: {customerId}, SalesReturnId: {salesReturnId}");
            await NotificationService.ShowErrorAsync("é–‹å•Ÿæ²–æ¬¾å–®æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
    }
}
