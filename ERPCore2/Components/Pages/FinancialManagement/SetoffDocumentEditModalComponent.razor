@* 沖款單編輯組件 *@
@inject ISetoffDocumentService SetoffDocumentService
@inject ISetoffProductDetailService SetoffProductDetailService
@inject ISetoffPaymentService SetoffPaymentService
@inject ISetoffPrepaymentService SetoffPrepaymentService
@inject ICompanyService CompanyService
@inject ICustomerService CustomerService
@inject ISupplierService SupplierService
@inject INotificationService NotificationService
@inject ActionButtonHelper ActionButtonHelper

<GenericEditModalComponent TEntity="SetoffDocument" 
                          TService="ISetoffDocumentService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          Id="@SetoffDocumentId"
                          Service="@SetoffDocumentService"
                          EntityName="沖款單"
                          EntityNamePlural="沖款單"
                          ModalTitle="@(SetoffDocumentId.HasValue ? "編輯沖款單" : "新增沖款單")"
                          Size="GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@GetFormFields()"
                          FormSections="@formSections"
                          AutoCompletePrefillers="@GetAutoCompletePrefillers()"
                          AutoCompleteCollections="@GetAutoCompleteCollections()"
                          AutoCompleteDisplayProperties="@GetAutoCompleteDisplayProperties()"
                          AutoCompleteValueProperties="@GetAutoCompleteValueProperties()"
                          ModalManagers="@GetModalManagers()"
                          DataLoader="@LoadSetoffDocumentData"
                          AdditionalDataLoader="@LoadAdditionalDataAsync"
                          UseGenericSave="true"
                          SaveSuccessMessage="@(SetoffDocumentId.HasValue ? "沖款單更新成功" : "沖款單新增成功")"
                          SaveFailureMessage="沖款單儲存失敗"
                          RequiredPermission="SetoffDocument.Read"
                          CustomValidator="@ValidateBeforeSave"
                          OnSaveSuccess="@HandleSaveSuccess"
                          OnCancel="@HandleCancel"
                          OnFieldChanged="@OnFieldValueChanged"
                          CustomModules="@GetCustomModules()">
</GenericEditModalComponent>

<CompanyEditModalComponent @ref="companyEditModal"
                          IsVisible="@companyModalManager.IsModalVisible"
                          IsVisibleChanged="@companyModalManager.HandleModalVisibilityChangedAsync"
                          CompanyId="@companyModalManager.SelectedEntityId"
                          OnCompanySaved="@OnCompanySavedWrapper"
                          OnCancel="@companyModalManager.HandleModalCancelAsync" />

<CustomerEditModalComponent @ref="customerEditModal"
                           IsVisible="@customerModalManager.IsModalVisible"
                           IsVisibleChanged="@customerModalManager.HandleModalVisibilityChangedAsync"
                           CustomerId="@customerModalManager.SelectedEntityId"
                           OnCustomerSaved="@OnCustomerSavedWrapper"
                           OnCancel="@customerModalManager.HandleModalCancelAsync" />

<SupplierEditModalComponent @ref="supplierEditModal"
                           IsVisible="@supplierModalManager.IsModalVisible"
                           IsVisibleChanged="@supplierModalManager.HandleModalVisibilityChangedAsync"
                           SupplierId="@supplierModalManager.SelectedEntityId"
                           OnSupplierSaved="@OnSupplierSavedWrapper"
                           OnCancel="@supplierModalManager.HandleModalCancelAsync" />

@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? SetoffDocumentId { get; set; }
    [Parameter] public SetoffType? DefaultSetoffType { get; set; } // 新增：預設的沖款類型
    [Parameter] public EventCallback<SetoffDocument> OnSetoffDocumentSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // 公司編輯 Modal 相關變數 - 使用泛型管理器
    private CompanyEditModalComponent? companyEditModal;
    private RelatedEntityModalManager<Company> companyModalManager = default!;
    
    // 客戶編輯 Modal 相關變數 - 使用泛型管理器
    private CustomerEditModalComponent? customerEditModal;
    private RelatedEntityModalManager<Customer> customerModalManager = default!;
    
    // 廠商編輯 Modal 相關變數 - 使用泛型管理器
    private SupplierEditModalComponent? supplierEditModal;
    private RelatedEntityModalManager<Supplier> supplierModalManager = default!;
    
    // 選項清單
    private List<Company> companies = new();
    private List<Customer> customers = new();
    private List<Supplier> suppliers = new();
    
    // 商品明細相關
    private List<SetoffProductDetail> setoffProductDetails = new();
    private bool IsReadOnly => false; // 可根據權限或狀態控制
    private SetoffProductDetailManagerComponent? setoffProductDetailManager;
    
    // 收款記錄相關
    private List<SetoffPayment> setoffPayments = new();
    private SetoffPaymentDetailManagerComponent? setoffPaymentDetailManager;
    
    // 預收付款項相關
    private List<SetoffPrepayment> setoffPrepayments = new();
    private SetoffPrepaymentDetailManagerComponent? setoffPrepaymentDetailManager;
    
    // 日期篩選
    private DateTime? filterStartDate;
    private DateTime? filterEndDate;

    // ===== 必要方法 =====
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 初始化公司 Modal 管理器
            InitializeCompanyModalManager();
            
            // 初始化客戶 Modal 管理器
            InitializeCustomerModalManager();
            
            // 初始化廠商 Modal 管理器
            InitializeSupplierModalManager();
            
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化沖款單編輯組件時發生錯誤");
        }
    }
    
    protected override async Task OnParametersSetAsync()
    {
        // 當 SetoffDocumentId 參數變更時，重新初始化表單欄位
        if (formFields != null) // 只有在已經初始化過的情況下才重新設定
        {
            await LoadAdditionalDataAsync();
            await InitializeFormFieldsAsync();
        }
        
        await base.OnParametersSetAsync();
    }

    /// <summary>
    /// 初始化公司 Modal 管理器
    /// </summary>
    private void InitializeCompanyModalManager()
    {
        companyModalManager = new RelatedEntityManagerBuilder<Company>(NotificationService, "公司")
            .WithPropertyName(nameof(SetoffDocument.CompanyId))
            .WithReloadCallback(LoadAdditionalDataAsync)
            .WithStateChangedCallback(StateHasChanged)
            .WithAutoSelectCallback(companyId => 
            {
                if (editModalComponent?.Entity != null)
                {
                    editModalComponent.Entity.CompanyId = companyId;
                }
            })
            .WithCustomPostProcess(async company => 
            {
                // 重新初始化表單欄位以更新按鈕狀態
                await InitializeFormFieldsAsync();
            })
            .Build();
    }

    /// <summary>
    /// 初始化客戶 Modal 管理器
    /// </summary>
    private void InitializeCustomerModalManager()
    {
        customerModalManager = new RelatedEntityManagerBuilder<Customer>(NotificationService, "客戶")
            .WithPropertyName("CustomerId")
            .WithReloadCallback(LoadAdditionalDataAsync)
            .WithStateChangedCallback(StateHasChanged)
            .WithAutoSelectCallback(customerId => 
            {
                if (editModalComponent?.Entity != null)
                {
                    editModalComponent.Entity.RelatedPartyId = customerId;
                    editModalComponent.Entity.RelatedPartyType = "Customer";
                    
                    // 更新 RelatedPartyName
                    var customer = customers.FirstOrDefault(c => c.Id == customerId);
                    if (customer != null)
                    {
                        editModalComponent.Entity.RelatedPartyName = customer.CompanyName;
                    }
                }
            })
            .WithCustomPostProcess(async customer => 
            {
                // 重新初始化表單欄位以更新按鈕狀態
                await InitializeFormFieldsAsync();
            })
            .Build();
    }

    /// <summary>
    /// 初始化廠商 Modal 管理器
    /// </summary>
    private void InitializeSupplierModalManager()
    {
        supplierModalManager = new RelatedEntityManagerBuilder<Supplier>(NotificationService, "廠商")
            .WithPropertyName("SupplierId")
            .WithReloadCallback(LoadAdditionalDataAsync)
            .WithStateChangedCallback(StateHasChanged)
            .WithAutoSelectCallback(supplierId => 
            {
                if (editModalComponent?.Entity != null)
                {
                    editModalComponent.Entity.RelatedPartyId = supplierId;
                    editModalComponent.Entity.RelatedPartyType = "Supplier";
                    
                    // 更新 RelatedPartyName
                    var supplier = suppliers.FirstOrDefault(s => s.Id == supplierId);
                    if (supplier != null)
                    {
                        editModalComponent.Entity.RelatedPartyName = supplier.CompanyName;
                    }
                }
            })
            .WithCustomPostProcess(async supplier => 
            {
                // 重新初始化表單欄位以更新按鈕狀態
                await InitializeFormFieldsAsync();
            })
            .Build();
    }

    /// <summary>
    /// 儲存前驗證（在主表單儲存之前執行）
    /// </summary>
    private async Task<bool> ValidateBeforeSave(SetoffDocument entity)
    {
        try
        {
            if (entity == null)
            {
                await NotificationService.ShowErrorAsync("沒有可儲存的資料");
                return false;
            }

            // ===== 儲存前驗證金額 =====
            // 驗證收款記錄的金額是否與主表單一致
            var receivedFromPayments = setoffPaymentDetailManager?.GetTotalReceivedAmount() ?? 0;
            var allowanceFromPayments = setoffPaymentDetailManager?.GetTotalAllowanceAmount() ?? 0;
            
            // 檢查收款記錄的收款金額是否等於本期已收
            if (Math.Abs(receivedFromPayments - entity.TotalCollectionAmount) > 0.01m)
            {
                await NotificationService.ShowErrorAsync(
                    $"收款記錄金額錯誤：收款記錄總額 {receivedFromPayments:N2}，應等於本期已收 {entity.TotalCollectionAmount:N2}。請檢查收款記錄。");
                return false;
            }
            
            // 檢查收款記錄的折讓金額是否等於本期折讓
            if (Math.Abs(allowanceFromPayments - entity.TotalAllowanceAmount) > 0.01m)
            {
                await NotificationService.ShowErrorAsync(
                    $"折讓記錄金額錯誤：收款記錄折讓總額 {allowanceFromPayments:N2}，應等於本期折讓 {entity.TotalAllowanceAmount:N2}。請檢查收款記錄。");
                return false;
            }

            // 驗證通過
            return true;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"驗證資料時發生錯誤：{ex.Message}");
            return false;
        }
    }

    /// <summary>
    /// 儲存成功後處理（在主表單儲存成功之後執行）
    /// </summary>
    private async Task HandleSaveSuccess()
    {
        try
        {
            if (editModalComponent?.Entity == null)
            {
                await NotificationService.ShowErrorAsync("沒有可儲存的資料");
                return;
            }

            var entity = editModalComponent.Entity;

            // 儲存商品明細（過濾掉本次沖款和折讓都為 0 的項目）
            var validDetails = setoffProductDetails
                .Where(d => d.CurrentSetoffAmount > 0 || d.CurrentAllowanceAmount > 0)
                .ToList();
                
            if (validDetails.Any() && entity.Id > 0)
            {
                // 設定 SetoffDocumentId
                foreach (var detail in validDetails)
                {
                    detail.SetoffDocumentId = entity.Id;
                }

                var detailResult = await SetoffProductDetailService.CreateBatchWithValidationAsync(validDetails);
                if (!detailResult.IsSuccess)
                {
                    await NotificationService.ShowErrorAsync($"商品明細儲存失敗：{detailResult.ErrorMessage}");
                    return;
                }
            }

            // 儲存收款記錄（過濾掉付款方式為空的項目）
            var validPayments = setoffPayments
                .Where(p => p.PaymentMethodId.HasValue && p.PaymentMethodId.Value > 0)
                .ToList();
                
            if (entity.Id > 0)
            {
                // 先刪除舊的收款記錄
                var existingPayments = await SetoffPaymentService.GetBySetoffDocumentIdAsync(entity.Id);
                foreach (var existingPayment in existingPayments)
                {
                    await SetoffPaymentService.DeleteAsync(existingPayment.Id);
                }
                
                // 新增收款記錄
                foreach (var payment in validPayments)
                {
                    payment.SetoffDocumentId = entity.Id;
                    payment.Id = 0; // 確保是新增
                    
                    var paymentResult = await SetoffPaymentService.CreateAsync(payment);
                    if (!paymentResult.IsSuccess)
                    {
                        await NotificationService.ShowErrorAsync($"收款記錄儲存失敗：{paymentResult.ErrorMessage}");
                        return;
                    }
                }
            }
            
            // 儲存預收付款項（過濾掉使用金額為 0 的項目）
            var validPrepayments = setoffPrepayments
                .Where(p => p.UsedAmount > 0)
                .ToList();
                
            if (entity.Id > 0)
            {
                // 先刪除舊的預收付款項記錄
                var existingPrepayments = await SetoffPrepaymentService.GetBySetoffDocumentIdAsync(entity.Id);
                foreach (var existingPrepayment in existingPrepayments)
                {
                    await SetoffPrepaymentService.DeleteAsync(existingPrepayment.Id);
                }
                
                // 新增預收付款項記錄
                foreach (var prepayment in validPrepayments)
                {
                    prepayment.SetoffDocumentId = entity.Id;
                    prepayment.Id = 0; // 確保是新增
                    
                    var prepaymentResult = await SetoffPrepaymentService.CreateAsync(prepayment);
                    if (!prepaymentResult.IsSuccess)
                    {
                        await NotificationService.ShowErrorAsync($"預收付款項儲存失敗：{prepaymentResult.ErrorMessage}");
                        return;
                    }
                }
            }

            await OnSetoffDocumentSaved.InvokeAsync(entity);
            await CloseModal();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"儲存商品明細時發生錯誤：{ex.Message}");
        }
    }
    
    /// <summary>
    /// 處理商品明細變更事件，更新沖款單的各項金額欄位
    /// </summary>
    /// <remarks>
    /// 欄位說明：
    /// - 本期應收 (TotalSetoffAmount): 被選入的來源明細的原始應收/付總金額（不會因為輸入本次沖款而改變）
    /// - 本期沖銷 (CurrentSetoffAmount): 本次沖款 + 本次折讓的總和
    /// - 本期已收 (TotalCollectionAmount): 實際收到的款項（目前等於本次沖款，未來會考慮手續費等因素）
    /// - 本期折讓 (TotalAllowanceAmount): 本次折讓的總額
    /// </remarks>
    private Task HandleProductDetailsChanged(List<SetoffProductDetail> details)
    {
        setoffProductDetails = details;
        
        // 更新總金額
        if (editModalComponent?.Entity != null)
        {
            // 【本期應收】= 被選入的來源明細的原始應收/付總金額
            // 這個值應該從 SetoffProductDetailManagerComponent 取得來源明細的總金額
            // 只在明細被選入時計算，不會因為輸入本次沖款金額而改變
            if (setoffProductDetailManager != null)
            {
                editModalComponent.Entity.TotalSetoffAmount = setoffProductDetailManager.GetSourceTotalAmount();
            }
            
            // 【本期沖銷】= 本次沖款 + 本次折讓的總和
            editModalComponent.Entity.CurrentSetoffAmount = details.Sum(d => d.CurrentSetoffAmount + d.CurrentAllowanceAmount);
            
            // 【本期已收】= 實際收到的款項總額
            // 目前等於本次沖款，未來會加入手續費等其他因素的計算
            // TODO: 未來需考慮手續費、匯差等因素
            editModalComponent.Entity.TotalCollectionAmount = details.Sum(d => d.CurrentSetoffAmount);
            
            // 【本期折讓】= 本次折讓的總額
            editModalComponent.Entity.TotalAllowanceAmount = details.Sum(d => d.CurrentAllowanceAmount);
        }
        
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    /// <summary>
    /// 處理收款記錄變更事件
    /// </summary>
    /// <remarks>
    /// 註：收款記錄變更時不即時更新主表單金額欄位，改為在儲存時進行驗證
    /// </remarks>
    private Task HandlePaymentsChanged(List<SetoffPayment> payments)
    {
        setoffPayments = payments;
        
        // 註解：不在此處更新金額，改為在儲存時驗證
        // 讓使用者自由輸入 Payment 資料，不會即時影響已收或折讓欄位
        // if (editModalComponent?.Entity != null && setoffPaymentDetailManager != null)
        // {
        //     // 【本期已收】= 收款記錄的收款金額總和
        //     var receivedFromPayments = setoffPaymentDetailManager.GetTotalReceivedAmount();
        //     editModalComponent.Entity.TotalCollectionAmount = receivedFromPayments;
        //     
        //     // 【本期折讓】= 商品明細的折讓 + 收款記錄的折讓金額總和
        //     var allowanceFromDetails = setoffProductDetails.Sum(d => d.CurrentAllowanceAmount);
        //     var allowanceFromPayments = setoffPaymentDetailManager.GetTotalAllowanceAmount();
        //     editModalComponent.Entity.TotalAllowanceAmount = allowanceFromDetails + allowanceFromPayments;
        // }
        
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    /// <summary>
    /// 處理預收付款項變更事件
    /// </summary>
    private Task HandlePrepaymentsChanged(List<SetoffPrepayment> prepayments)
    {
        setoffPrepayments = prepayments;
        
        // 註：預收付款項的金額變更不會直接影響主表單的金額欄位
        // 預收付款項主要用於記錄使用了哪些預收/預付款項來沖銷本次的應收/應付帳款
        
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task HandleCancel()
    {
        await OnCancel.InvokeAsync();
        await CloseModal();
    }

    private async Task CloseModal()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }

    private async Task<SetoffDocument?> LoadSetoffDocumentData()
    {
        try
        {
            SetoffDocument? setoffDocument;
            
            if (!SetoffDocumentId.HasValue)
            {
                // 新增模式 - 使用 DefaultSetoffType 或預設為應收帳款
                setoffDocument = new SetoffDocument
                {
                    SetoffNumber = await GenerateSetoffNumberAsync(),
                    SetoffDate = DateTime.Today,
                    SetoffType = DefaultSetoffType ?? SetoffType.AccountsReceivable,
                    TotalSetoffAmount = 0
                };
                
                // 新增模式：清空商品明細和收款記錄
                setoffProductDetails = new List<SetoffProductDetail>();
                setoffPayments = new List<SetoffPayment>();
            }
            else
            {
                // 編輯模式
                setoffDocument = await SetoffDocumentService.GetByIdAsync(SetoffDocumentId.Value);
                
                // 載入商品明細
                setoffProductDetails = await SetoffProductDetailService.GetBySetoffDocumentIdAsync(SetoffDocumentId.Value);
                
                // 載入收款記錄
                setoffPayments = await SetoffPaymentService.GetBySetoffDocumentIdAsync(SetoffDocumentId.Value);
            }
            
            // 資料載入後，重新初始化表單欄位以正確顯示客戶或廠商欄位
            // 使用 Task.Run 確保在下一個渲染週期執行
            _ = Task.Run(async () =>
            {
                await InvokeAsync(async () =>
                {
                    await InitializeFormFieldsAsync();
                    StateHasChanged();
                });
            });
            
            return setoffDocument;
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"載入沖款單資料時發生錯誤：{ex.Message}");
            return null;
        }
    }

    private async Task LoadAdditionalDataAsync()
    {
        try
        {
            // 載入公司列表
            companies = await CompanyService.GetAllAsync();
            
            // 載入客戶列表（用於應收帳款）
            customers = await CustomerService.GetAllAsync();
            
            // 載入廠商列表（用於應付帳款）
            suppliers = await SupplierService.GetAllAsync();
        }
        catch (Exception)
        {
            _ = NotificationService.ShowErrorAsync("載入沖款單編輯相關資料時發生錯誤");
            companies = new List<Company>();
            customers = new List<Customer>();
            suppliers = new List<Supplier>();
        }
    }

    private async Task InitializeFormFieldsAsync()
    {
        try
        {
            // 動態加入客戶或廠商欄位 - 先判斷類型
            var currentSetoffType = editModalComponent?.Entity?.SetoffType ?? DefaultSetoffType ?? SetoffType.AccountsReceivable;
            
            formFields = new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SetoffDocument.SetoffNumber),
                    Label = "沖款單號",
                    FieldType = FormFieldType.Text,
                    Placeholder = "請輸入沖款單號",
                    IsRequired = true,
                    MaxLength = 50,
                    HelpText = "沖款單的唯一識別號碼，新增時系統會自動產生，也可手動修改"
                }
            };

            // 根據沖款類型動態加入客戶或廠商欄位（緊接在沖款單號之後）
            if (currentSetoffType == SetoffType.AccountsReceivable)
            {
                // 應收帳款：顯示客戶欄位
                formFields.Add(new()
                {
                    PropertyName = "CustomerId",
                    Label = "客戶",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇客戶",
                    MinSearchLength = 0,
                    IsRequired = true,
                    HelpText = "選擇應收帳款的客戶",
                    ActionButtons = await GetCustomerActionButtonsAsync()
                });
            }
            else if (currentSetoffType == SetoffType.AccountsPayable)
            {
                // 應付帳款：顯示廠商欄位
                formFields.Add(new()
                {
                    PropertyName = "SupplierId",
                    Label = "廠商",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇廠商",
                    MinSearchLength = 0,
                    IsRequired = true,
                    HelpText = "選擇應付帳款的廠商",
                    ActionButtons = await GetSupplierActionButtonsAsync()
                });
            }

            // 繼續加入其他共用欄位
            formFields.AddRange(new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SetoffDocument.CompanyId),
                    Label = "公司",
                    FieldType = FormFieldType.AutoComplete,
                    Placeholder = "請輸入或選擇公司",
                    MinSearchLength = 0, // 允許空白搜尋以顯示所有選項
                    IsRequired = true,
                    HelpText = "選擇沖款單所屬的公司",
                    ActionButtons = await GetCompanyActionButtonsAsync()
                },
                new()
                {
                    PropertyName = "FilterStartDate",
                    Label = "來源單據起始日期",
                    FieldType = FormFieldType.Date,
                    IsRequired = false,
                    HelpText = "篩選該日期之後的銷貨、銷貨退回、入庫、入庫退出單據"
                },
                new()
                {
                    PropertyName = "FilterEndDate",
                    Label = "來源單據結束日期",
                    FieldType = FormFieldType.Date,
                    IsRequired = false,
                    HelpText = "篩選該日期之前的銷貨、銷貨退回、入庫、入庫退出單據"
                },
                new()
                {
                    PropertyName = nameof(SetoffDocument.SetoffDate),
                    Label = "沖款日期",
                    FieldType = FormFieldType.Date,
                    IsRequired = true,
                    HelpText = "沖款單的建立日期"
                }
            });

            // 繼續加入金額相關欄位
            formFields.AddRange(new List<FormFieldDefinition>
            {
                new()
                {
                    PropertyName = nameof(SetoffDocument.TotalSetoffAmount),
                    Label = "本期應收",
                    FieldType = FormFieldType.Number,
                    Placeholder = "系統自動計算",
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "沖款單的總金額",
                },
                new()
                {
                    PropertyName = nameof(SetoffDocument.CurrentSetoffAmount),
                    Label = "本期沖銷",
                    FieldType = FormFieldType.Number,
                    Placeholder = "系統自動計算",
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "本次沖款單所沖銷的金額",
                },
                new()
                {
                    PropertyName = nameof(SetoffDocument.TotalCollectionAmount),
                    Label = "本期已收",
                    FieldType = FormFieldType.Number,
                    Placeholder = "系統自動計算",
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "實際收到的款項總額",
                },
                new()
                {
                    PropertyName = nameof(SetoffDocument.TotalAllowanceAmount),
                    Label = "本期折讓",
                    FieldType = FormFieldType.Number,
                    Placeholder = "系統自動計算",
                    IsRequired = false,
                    IsReadOnly = true,
                    HelpText = "折讓抵銷的總額",
                },

                FormFieldConfigurationHelper.CreateRemarksField<SetoffDocument>(),
            });


            
            // 動態設定表單區段 - 使用有序列表以控制欄位順序
            var sectionList = new List<KeyValuePair<string, string>>
            {
                new(nameof(SetoffDocument.SetoffNumber), "基本資訊")
            };

            // 根據沖款類型加入對應的關聯方區段(插入在沖款單號之後)
            if (currentSetoffType == SetoffType.AccountsReceivable)
            {
                sectionList.Add(new("CustomerId", "基本資訊"));
            }
            else if (currentSetoffType == SetoffType.AccountsPayable)
            {
                sectionList.Add(new("SupplierId", "基本資訊"));
            }

            // 繼續加入其他基本資訊欄位
            sectionList.AddRange(new[]
            {
                new KeyValuePair<string, string>(nameof(SetoffDocument.CompanyId), "基本資訊"),
                new KeyValuePair<string, string>("FilterStartDate", "基本資訊"),
                new KeyValuePair<string, string>("FilterEndDate", "基本資訊"),
                new KeyValuePair<string, string>(nameof(SetoffDocument.SetoffDate), "基本資訊")
            });

            // 加入金額相關區段
            sectionList.AddRange(new[]
            {
                new KeyValuePair<string, string>(nameof(SetoffDocument.TotalSetoffAmount), "金額資訊(系統自動計算)"),                
                new KeyValuePair<string, string>(nameof(SetoffDocument.CurrentSetoffAmount), "金額資訊(系統自動計算)"),
                new KeyValuePair<string, string>(nameof(SetoffDocument.TotalCollectionAmount), "金額資訊(系統自動計算)"),
                new KeyValuePair<string, string>(nameof(SetoffDocument.TotalAllowanceAmount), "金額資訊(系統自動計算)"),
                new KeyValuePair<string, string>(nameof(SetoffDocument.Remarks), "其他資訊")
            });

            // 轉換為 Dictionary
            formSections = sectionList.ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
        }
        catch (Exception)
        {
            await NotificationService.ShowErrorAsync("初始化表單欄位時發生錯誤");
        }
    }

    private List<FormFieldDefinition> GetFormFields()
    {
        return formFields;
    }

    /// <summary>
    /// 產生沖款單號
    /// </summary>
    private async Task<string> GenerateSetoffNumberAsync()
    {
        try
        {
            // 格式: SO-YYYYMMDD-001
            var today = DateTime.Today;
            var prefix = $"SO-{today:yyyyMMdd}";
            
            var allSetoffDocs = await SetoffDocumentService.GetAllAsync();
            var todaySetoffDocs = allSetoffDocs
                .Where(s => s.SetoffNumber.StartsWith(prefix))
                .ToList();
            
            var maxNumber = todaySetoffDocs.Any()
                ? todaySetoffDocs.Max(s =>
                {
                    var parts = s.SetoffNumber.Split('-');
                    return parts.Length == 3 && int.TryParse(parts[2], out var num) ? num : 0;
                })
                : 0;
            
            return $"{prefix}-{(maxNumber + 1):D3}";
        }
        catch (Exception)
        {
            return $"SO-{DateTime.Today:yyyyMMdd}-001";
        }
    }

    /// <summary>
    /// 欄位變更事件處理
    /// </summary>
    private async Task OnFieldValueChanged((string PropertyName, object? Value) fieldChange)
    {
        try
        {
            // 註解：因為沖款類型現在由 DefaultSetoffType 控制，不再需要手動變更處理
            // 如果未來需要支援手動變更沖款類型，可以取消註解以下程式碼
            /*
            if (fieldChange.PropertyName == nameof(SetoffDocument.SetoffType) && editModalComponent?.Entity != null)
            {
                editModalComponent.Entity.RelatedPartyId = 0;
                editModalComponent.Entity.RelatedPartyName = string.Empty;
                editModalComponent.Entity.RelatedPartyType = string.Empty;
                
                await InitializeFormFieldsAsync();
                StateHasChanged();
            }
            */
            
            // 使用統一 Helper 處理公司欄位變更
            if (fieldChange.PropertyName == nameof(SetoffDocument.CompanyId))
            {
                await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                    companyModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
            }
            
            // 處理客戶欄位變更
            if (fieldChange.PropertyName == "CustomerId" && editModalComponent?.Entity != null)
            {
                if (fieldChange.Value != null && int.TryParse(fieldChange.Value.ToString(), out int customerId))
                {
                    editModalComponent.Entity.RelatedPartyId = customerId;
                    editModalComponent.Entity.RelatedPartyType = "Customer";
                    
                    // 更新 RelatedPartyName
                    var customer = customers.FirstOrDefault(c => c.Id == customerId);
                    if (customer != null)
                    {
                        editModalComponent.Entity.RelatedPartyName = customer.CompanyName;
                    }
                    
                    // 更新 ActionButtons
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        customerModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                }
            }
            
            // 處理廠商欄位變更
            if (fieldChange.PropertyName == "SupplierId" && editModalComponent?.Entity != null)
            {
                if (fieldChange.Value != null && int.TryParse(fieldChange.Value.ToString(), out int supplierId))
                {
                    editModalComponent.Entity.RelatedPartyId = supplierId;
                    editModalComponent.Entity.RelatedPartyType = "Supplier";
                    
                    // 更新 RelatedPartyName
                    var supplier = suppliers.FirstOrDefault(s => s.Id == supplierId);
                    if (supplier != null)
                    {
                        editModalComponent.Entity.RelatedPartyName = supplier.CompanyName;
                    }
                    
                    // 更新 ActionButtons
                    await ActionButtonHelper.UpdateFieldActionButtonsAsync(
                        supplierModalManager, formFields, fieldChange.PropertyName, fieldChange.Value);
                }
            }
            
            // 處理日期篩選變更
            if (fieldChange.PropertyName == "FilterStartDate")
            {
                if (fieldChange.Value != null && DateTime.TryParse(fieldChange.Value.ToString(), out DateTime startDate))
                {
                    filterStartDate = startDate;
                }
                else
                {
                    filterStartDate = null;
                }
                StateHasChanged();
            }
            
            if (fieldChange.PropertyName == "FilterEndDate")
            {
                if (fieldChange.Value != null && DateTime.TryParse(fieldChange.Value.ToString(), out DateTime endDate))
                {
                    filterEndDate = endDate;
                }
                else
                {
                    filterEndDate = null;
                }
                StateHasChanged();
            }
        }
        catch (Exception)
        {
            // 忽略錯誤
        }
    }

    // ===== AutoComplete 相關方法 =====
    private Dictionary<string, Func<string, Dictionary<string, object?>>> GetAutoCompletePrefillers()
    {
        return new Dictionary<string, Func<string, Dictionary<string, object?>>>
        {
            {
                nameof(SetoffDocument.CompanyId),
                searchTerm => new Dictionary<string, object?>
                {
                    ["CompanyName"] = searchTerm
                }
            },
            {
                "CustomerId",
                searchTerm => new Dictionary<string, object?>
                {
                    ["CompanyName"] = searchTerm
                }
            },
            {
                "SupplierId",
                searchTerm => new Dictionary<string, object?>
                {
                    ["CompanyName"] = searchTerm
                }
            }
        };
    }

    private Dictionary<string, IEnumerable<object>> GetAutoCompleteCollections()
    {
        return new Dictionary<string, IEnumerable<object>>
        {
            { nameof(SetoffDocument.CompanyId), companies.Cast<object>() },
            { "CustomerId", customers.Cast<object>() },
            { "SupplierId", suppliers.Cast<object>() }
        };
    }

    private Dictionary<string, string> GetAutoCompleteDisplayProperties()
    {
        return new Dictionary<string, string>
        {
            { nameof(SetoffDocument.CompanyId), "CompanyName" },
            { "CustomerId", "CompanyName" },
            { "SupplierId", "CompanyName" }
        };
    }

    private Dictionary<string, string> GetAutoCompleteValueProperties()
    {
        return new Dictionary<string, string>
        {
            { nameof(SetoffDocument.CompanyId), "Id" },
            { "CustomerId", "Id" },
            { "SupplierId", "Id" }
        };
    }

    // ===== Modal 管理器 =====
    private Dictionary<string, object> GetModalManagers()
    {
        return new Dictionary<string, object>
        {
            { nameof(SetoffDocument.CompanyId), companyModalManager },
            { "CustomerId", customerModalManager },
            { "SupplierId", supplierModalManager }
        };
    }

    // ===== Action Buttons =====
    private async Task<List<FieldActionButton>> GetCompanyActionButtonsAsync()
    {
        return await ActionButtonHelper.GenerateFieldActionButtonsAsync(
            editModalComponent,
            companyModalManager,
            nameof(SetoffDocument.CompanyId)
        );
    }

    private Task<List<FieldActionButton>> GetCustomerActionButtonsAsync()
    {
        // 取得目前的 RelatedPartyId (當 SetoffType 是應收帳款時)
        int? currentCustomerId = null;
        if (editModalComponent?.Entity?.SetoffType == SetoffType.AccountsReceivable && 
            editModalComponent.Entity.RelatedPartyType == "Customer")
        {
            currentCustomerId = editModalComponent.Entity.RelatedPartyId > 0 
                ? editModalComponent.Entity.RelatedPartyId 
                : null;
        }
        
        return Task.FromResult(customerModalManager.GenerateActionButtons(currentCustomerId));
    }

    private Task<List<FieldActionButton>> GetSupplierActionButtonsAsync()
    {
        // 取得目前的 RelatedPartyId (當 SetoffType 是應付帳款時)
        int? currentSupplierId = null;
        if (editModalComponent?.Entity?.SetoffType == SetoffType.AccountsPayable && 
            editModalComponent.Entity.RelatedPartyType == "Supplier")
        {
            currentSupplierId = editModalComponent.Entity.RelatedPartyId > 0 
                ? editModalComponent.Entity.RelatedPartyId 
                : null;
        }
        
        return Task.FromResult(supplierModalManager.GenerateActionButtons(currentSupplierId));
    }

    private async Task OnCompanySavedWrapper(Company company)
    {
        await companyModalManager.HandleEntitySavedAsync(company, shouldAutoSelect: true);
    }

    private async Task OnCustomerSavedWrapper(Customer customer)
    {
        await customerModalManager.HandleEntitySavedAsync(customer, shouldAutoSelect: true);
    }

    private async Task OnSupplierSavedWrapper(Supplier supplier)
    {
        await supplierModalManager.HandleEntitySavedAsync(supplier, shouldAutoSelect: true);
    }

    /// <summary>
    /// 配置自訂模組
    /// </summary>
    private List<GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule> GetCustomModules()
    {
        try
        {
            if (editModalComponent == null)
            {
                return new List<GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule>();
            }

            return new List<GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule>
            {
                new GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule
                {
                    Title = "",
                    Content = CreateSetoffProductDetailManagerContent(),
                    Order = 1
                },
                new GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule
                {
                    Title = "",
                    Content = CreateSetoffPaymentDetailManagerContent(),
                    Order = 2
                },
                new GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule
                {
                    Title = "",
                    Content = CreateSetoffPrepaymentDetailManagerContent(),
                    Order = 3
                }
            };
        }
        catch
        {
            return new List<GenericEditModalComponent<SetoffDocument, ISetoffDocumentService>.CustomModule>();
        }
    }

    /// <summary>
    /// 創建沖銷商品明細管理器內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateSetoffProductDetailManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null && editModalComponent.Entity.RelatedPartyId > 0)
            {
                <SetoffProductDetailManagerComponent 
                    @ref="setoffProductDetailManager"
                    SetoffDocumentId="@SetoffDocumentId"
                    SetoffType="@editModalComponent.Entity.SetoffType"
                    RelatedPartyId="@editModalComponent.Entity.RelatedPartyId"
                    RelatedPartyType="@editModalComponent.Entity.RelatedPartyType"
                    StartDate="@filterStartDate"
                    EndDate="@filterEndDate"
                    ExistingDetails="@setoffProductDetails"
                    OnDetailsChanged="@HandleProductDetailsChanged"
                    IsReadOnly="@IsReadOnly" />
            }
            else
            {
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    請先選擇@(editModalComponent?.Entity?.SetoffType == SetoffType.AccountsReceivable ? "客戶" : "廠商")以載入商品明細
                </div>
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                載入明細管理器時發生錯誤,請重新整理頁面。
            </div>
        }
    };
    
    /// <summary>
    /// 創建收款記錄管理器內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateSetoffPaymentDetailManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null && editModalComponent.Entity.RelatedPartyId > 0)
            {
                <SetoffPaymentDetailManagerComponent 
                    @ref="setoffPaymentDetailManager"
                    SetoffDocumentId="@SetoffDocumentId"
                    ExistingPayments="@setoffPayments"
                    OnPaymentsChanged="@HandlePaymentsChanged"
                    IsReadOnly="@IsReadOnly" />
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                載入收款記錄管理器時發生錯誤,請重新整理頁面。
            </div>
        }
    };
    
    /// <summary>
    /// 創建預收付款項管理器內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateSetoffPrepaymentDetailManagerContent() => __builder =>
    {
        try
        {
            @if (editModalComponent?.Entity != null && editModalComponent.Entity.RelatedPartyId > 0)
            {
                <SetoffPrepaymentDetailManagerComponent 
                    @ref="setoffPrepaymentDetailManager"
                    SetoffDocumentId="@SetoffDocumentId"
                    RelatedPartyId="@editModalComponent.Entity.RelatedPartyId"
                    RelatedPartyType="@editModalComponent.Entity.RelatedPartyType"
                    ExistingPrepayments="@setoffPrepayments"
                    OnPrepaymentsChanged="@HandlePrepaymentsChanged"
                    IsReadOnly="@IsReadOnly" />
            }
        }
        catch
        {
            <div class="alert alert-warning" role="alert">
                載入預收付款項管理器時發生錯誤,請重新整理頁面。
            </div>
        }
    };
}
