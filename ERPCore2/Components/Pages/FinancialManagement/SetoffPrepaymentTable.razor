@* æ²–æ¬¾é æ”¶ä»˜æ¬¾é …ç®¡ç†çµ„ä»¶ - ç®¡ç†é æ”¶ä»˜æ¬¾é …çš„ä½¿ç”¨è¨˜éŒ„ *@

@inject ISetoffPrepaymentService SetoffPrepaymentService
@inject ISetoffPrepaymentUsageService SetoffPrepaymentUsageService
@inject IPrepaymentTypeService PrepaymentTypeService
@inject INotificationService NotificationService
@inject RelatedDocumentsHelper RelatedDocumentsHelper
@inject IStringLocalizer<SharedResource> L

<div class="card-body p-0">
    <InteractiveTableComponent TItem="SetoffPrepaymentItem" 
                                @ref="tableComponent"
                                Items="@PrepaymentItems"
                                ColumnDefinitions="@GetPrepaymentColumnDefinitions()"
                                IsReadOnly="@IsReadOnly"
                                ShowRowNumbers="false"
                                EmptyMessage="@L["Setoff.NoPrepaymentRecords"]"
                                ShowBuiltInActions="true"
                                ShowBuiltInDeleteButton="false"
                                CustomActionsTemplate="@GetCustomActionsTemplate"
                                OnItemDelete="@HandleRemovePrepaymentRecord"
                                ActionsColumnWidth = "60px"
                                EnableAutoEmptyRow="true"
                                AllowAddNewRow="@(!IsReadOnly)"
                                DataLoadCompleted="@_dataLoadCompleted"
                                CreateEmptyItem="@CreateEmptyItem" />
</div>

<!-- ç›¸é—œå–®æ“šæŸ¥çœ‹ Modal -->
<RelatedDocumentsModalComponent IsVisible="@showRelatedDocumentsModal"
                               IsVisibleChanged="@((bool visible) => showRelatedDocumentsModal = visible)"
                               ProductName="@selectedPrepaymentName"
                               RelatedDocuments="@relatedDocuments"
                               IsLoading="@isLoadingRelatedDocuments"
                               OnDocumentClick="@HandleRelatedDocumentClick" />

@code {
    // ===== ç§æœ‰æ¬„ä½ =====
    private bool _dataLoadCompleted = true;  // è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜
    private InteractiveTableComponent<SetoffPrepaymentItem>? tableComponent;
    
    // ===== åƒæ•¸å®šç¾© =====
    [Parameter] public int? SetoffDocumentId { get; set; }
    [Parameter] public int? CustomerId { get; set; }
    [Parameter] public int? SupplierId { get; set; }
    [Parameter] public SetoffType SetoffType { get; set; } // æ–°å¢ï¼šæ²–æ¬¾é¡å‹ï¼ˆæ‡‰æ”¶/æ‡‰ä»˜ï¼‰
    [Parameter] public string? SetoffDocumentNumber { get; set; } // æ²–æ¬¾å–®è™Ÿï¼ˆç”¨æ–¼è¨­å®šä¾†æºå–®è™Ÿï¼‰
    
    // è³‡æ–™ç¶å®š
    [Parameter] public List<SetoffPrepayment> ExistingPrepayments { get; set; } = new();
    [Parameter] public EventCallback<List<SetoffPrepayment>> OnPrepaymentsChanged { get; set; }
    
    // é¡¯ç¤ºæ§åˆ¶
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // æ–¹æ¡ˆ D æ”¹è‰¯ç‰ˆï¼šä½¿ç”¨ DataVersion è¿½è¹¤
    [Parameter] public int DataVersion { get; set; } = 0;
    
    // ä¿®æ­£ï¼šçˆ¶å…ƒä»¶è¼‰å…¥ä¸­æ¨™è¨˜
    [Parameter] public bool IsParentLoading { get; set; } = false;
    
    // ===== ç›¸é—œå–®æ“šé–‹å•Ÿäº‹ä»¶ =====
    [Parameter] public EventCallback<(RelatedDocumentType type, int id)> OnOpenRelatedDocument { get; set; }
    
    // ===== å…§éƒ¨ç‹€æ…‹ =====
    private List<SetoffPrepaymentItem> PrepaymentItems { get; set; } = new();
    private List<SetoffPrepayment> AvailablePrepayments { get; set; } = new();
    private List<PrepaymentType> AllPrepaymentTypes { get; set; } = new();
    private List<PrepaymentType> FilteredPrepaymentTypes { get; set; } = new();
    
    // ç”¨æ–¼è¿½è¹¤åƒæ•¸è®Šæ›´ï¼Œé¿å…ä¸å¿…è¦çš„é‡æ–°è¼‰å…¥
    private int? _previousCustomerId;
    private int? _previousSupplierId;
    private int _previousExistingPrepaymentsCount;

    // æ–¹æ¡ˆ D æ”¹è‰¯ç‰ˆï¼šè¿½è¹¤ DataVersion
    private int _previousDataVersion = 0;
    
    // é˜²æ­¢é‡å…¥
    private bool _isLoadingData = false;

    // ===== ç›¸é—œå–®æ“šæŸ¥çœ‹ =====
    private bool showRelatedDocumentsModal = false;
    private string selectedPrepaymentName = string.Empty;
    private List<RelatedDocument>? relatedDocuments = null;
    private bool isLoadingRelatedDocuments = false;

    // ===== è¨ˆç®—å±¬æ€§ =====
    /// <summary>
    /// å–å¾—ç¸½é‡‘é¡ï¼ˆé æ”¶/é ä»˜é¡å‹çš„ Amount + è½‰æ²–æ¬¾é¡å‹çš„ UsedAmountï¼‰
    /// </summary>
    private decimal TotalUsedAmount => PrepaymentItems
        .Where(p => p.PrepaymentTypeId.HasValue && p.PrepaymentTypeId.Value > 0)
        .Sum(p =>
        {
            // åˆ¤æ–·æ˜¯å¦ç‚ºè½‰æ²–æ¬¾é¡å‹
            if (p.PrepaymentTypeId.HasValue)
            {
                var selectedType = FilteredPrepaymentTypes.FirstOrDefault(pt => pt.Id == p.PrepaymentTypeId.Value);
                if (selectedType != null && IsTransferType(selectedType.Name))
                {
                    // è½‰æ²–æ¬¾é¡å‹ï¼šè¨ˆç®— UsedAmount
                    return p.UsedAmount;
                }
            }
            // é æ”¶/é ä»˜é¡å‹ï¼šè¨ˆç®— Amount
            return p.Amount;
        });

    // ===== ç”Ÿå‘½é€±æœŸæ–¹æ³• =====
    protected override async Task OnInitializedAsync()
    {
        // ä¿®æ­£ï¼šå¦‚æœçˆ¶å…ƒä»¶æ­£åœ¨è¼‰å…¥ä¸­ï¼Œè·³éè³‡æ–™è¼‰å…¥
        // ğŸ”¥ é‡è¦ï¼šæ­¤æ™‚ä¸è¨­å®š _previousDataVersionï¼Œè®“ OnParametersSetAsync èƒ½å¤ åµæ¸¬åˆ°è®ŠåŒ–
        if (IsParentLoading) { return; }
        
        // åªæœ‰åœ¨æˆåŠŸè¼‰å…¥å¾Œæ‰è¨­å®šè¿½è¹¤è®Šæ•¸
        _previousDataVersion = DataVersion;
        _previousCustomerId = CustomerId;
        _previousSupplierId = SupplierId;
        
        await LoadPrepaymentTypesAsync();
        // æ­¤æ™‚ä¸ç¯©é¸é¡å‹ï¼Œå› ç‚º SetoffType åƒæ•¸å¯èƒ½é‚„æœªè¨­å®š
        // FilterPrepaymentTypes() æœƒåœ¨ OnParametersSetAsync() ä¸­åŸ·è¡Œ
        await LoadAvailablePrepaymentsAsync();
        LoadExistingPrepayments();
        
        // åˆå§‹åŒ–è¿½è¹¤è®Šæ•¸
        _previousExistingPrepaymentsCount = ExistingPrepayments?.Count ?? 0;
    }

    protected override async Task OnParametersSetAsync()
    {
        // ç¯©é¸é æ”¶ä»˜é¡å‹ï¼ˆç¢ºä¿ SetoffType å·²æ­£ç¢ºè¨­å®šï¼‰
        FilterPrepaymentTypes();
        
        // é˜²æ­¢é‡å…¥
        if (_isLoadingData) { return; }
        
        // æ–¹æ¡ˆ D æ”¹è‰¯ç‰ˆï¼šå„ªå…ˆæª¢æŸ¥ DataVersion
        bool versionChanged = DataVersion != _previousDataVersion;
        
        if (versionChanged)
        {
            _previousDataVersion = DataVersion;
            _previousCustomerId = CustomerId;
            _previousSupplierId = SupplierId;
            
            _isLoadingData = true;
            try
            {
                await LoadAvailablePrepaymentsAsync();
                LoadExistingPrepayments();
                _previousExistingPrepaymentsCount = ExistingPrepayments?.Count ?? 0;
            }
            finally
            {
                _isLoadingData = false;
            }
        }
        else
        {
            // åªæœ‰ç•¶ CustomerId æˆ– SupplierId çœŸæ­£è®Šæ›´æ™‚ï¼Œæ‰é‡æ–°è¼‰å…¥å¯ç”¨çš„é æ”¶ä»˜æ¬¾é …
            if (_previousCustomerId != CustomerId || _previousSupplierId != SupplierId)
            {
                await LoadAvailablePrepaymentsAsync();
                _previousCustomerId = CustomerId;
                _previousSupplierId = SupplierId;
            }
            
            // åªæœ‰ç•¶ ExistingPrepayments çœŸæ­£è®Šæ›´æ™‚ï¼ˆæ•¸é‡ä¸åŒï¼‰ï¼Œæ‰é‡æ–°è¼‰å…¥è³‡æ–™
            var currentCount = ExistingPrepayments?.Count ?? 0;
            if (_previousExistingPrepaymentsCount != currentCount)
            {
                LoadExistingPrepayments();
                _previousExistingPrepaymentsCount = currentCount;
            }
        }
        
        await base.OnParametersSetAsync();
    }

    // ===== å»ºç«‹ç©ºé …ç›®æ–¹æ³• =====
    
    /// <summary>
    /// å‰µå»ºç©ºçš„é æ”¶ä»˜æ¬¾é …è¨˜éŒ„é …ç›®
    /// </summary>
    private SetoffPrepaymentItem CreateEmptyItem()
    {
        return new SetoffPrepaymentItem
        {
            Id = 0,
            PrepaymentTypeId = null,
            SourcePrepaymentId = null,
            SourceDocumentCode = string.Empty,
            Amount = 0,
            UsedAmount = 0,
            Remarks = null,
            ExistingPrepayment = null
        };
    }

    // ===== è³‡æ–™è¼‰å…¥æ–¹æ³• =====
    
    /// <summary>
    /// è¼‰å…¥æ‰€æœ‰é æ”¶ä»˜é¡å‹
    /// </summary>
    private async Task LoadPrepaymentTypesAsync()
    {
        try
        {
            AllPrepaymentTypes = await PrepaymentTypeService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync(string.Format(L["Message.LoadPrepaymentTypeFailed"], ex.Message));
            AllPrepaymentTypes = new List<PrepaymentType>();
            FilteredPrepaymentTypes = new List<PrepaymentType>();
        }
    }
    
    /// <summary>
    /// æ ¹æ“šæ²–æ¬¾é¡å‹ç¯©é¸é æ”¶ä»˜é¡å‹
    /// æ‡‰æ”¶ï¼šé¡¯ç¤ºã€Œé æ”¶ã€å’Œã€Œé æ”¶è½‰æ²–æ¬¾ã€
    /// æ‡‰ä»˜ï¼šé¡¯ç¤ºã€Œé ä»˜ã€å’Œã€Œé ä»˜è½‰æ²–æ¬¾ã€
    /// </summary>
    private void FilterPrepaymentTypes()
    {
        if (AllPrepaymentTypes == null || !AllPrepaymentTypes.Any())
        {
            FilteredPrepaymentTypes = new List<PrepaymentType>();
            return;
        }
        
        if (SetoffType == SetoffType.AccountsReceivable)
        {
            // æ‡‰æ”¶å¸³æ¬¾ï¼šé¡¯ç¤ºæ‰€æœ‰ã€Œé æ”¶ã€ç›¸é—œé¡å‹ï¼ˆåŒ…æ‹¬é æ”¶å’Œé æ”¶è½‰æ²–æ¬¾ï¼‰
            FilteredPrepaymentTypes = AllPrepaymentTypes
                .Where(pt => pt.Name.Contains("é æ”¶"))
                .ToList();
        }
        else if (SetoffType == SetoffType.AccountsPayable)
        {
            // æ‡‰ä»˜å¸³æ¬¾ï¼šé¡¯ç¤ºæ‰€æœ‰ã€Œé ä»˜ã€ç›¸é—œé¡å‹ï¼ˆåŒ…æ‹¬é ä»˜å’Œé ä»˜è½‰æ²–æ¬¾ï¼‰
            FilteredPrepaymentTypes = AllPrepaymentTypes
                .Where(pt => pt.Name.Contains("é ä»˜"))
                .ToList();
        }
        else
        {
            FilteredPrepaymentTypes = new List<PrepaymentType>();
        }
    }
    
    private async Task LoadAvailablePrepaymentsAsync()
    {
        try
        {
            // æ ¹æ“šå®¢æˆ¶æˆ–ä¾›æ‡‰å•†è¼‰å…¥å¯ç”¨çš„é æ”¶ä»˜æ¬¾é …
            if (CustomerId.HasValue && CustomerId.Value > 0)
            {
                AvailablePrepayments = await SetoffPrepaymentService.GetAvailableByCustomerIdAsync(CustomerId.Value);
            }
            else if (SupplierId.HasValue && SupplierId.Value > 0)
            {
                AvailablePrepayments = await SetoffPrepaymentService.GetAvailableBySupplierIdAsync(SupplierId.Value);
            }
            else
            {
                AvailablePrepayments = new List<SetoffPrepayment>();
            }
            
            //  è¼‰å…¥å¯ç”¨é æ”¶ä»˜æ¬¾é …å¾Œï¼Œè‡ªå‹•æ¯”å°ä¸¦è¨­å®šç·¨è¼¯æ¨¡å¼ä¸‹çš„ SourcePrepaymentId
            MatchSourcePrepaymentIds();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync(string.Format(L["Message.LoadAvailablePrepaymentFailed"], ex.Message));
            AvailablePrepayments = new List<SetoffPrepayment>();
        }
    }
    
    /// <summary>
    /// è‡ªå‹•æ¯”å°ä¸¦è¨­å®š SourcePrepaymentIdï¼ˆç·¨è¼¯æ¨¡å¼ç”¨ï¼‰
    /// </summary>
    private void MatchSourcePrepaymentIds()
    {
        if (!PrepaymentItems.Any() || !AvailablePrepayments.Any())
            return;
        
        foreach (var item in PrepaymentItems)
        {
            // åªè™•ç†è½‰æ²–æ¬¾é¡å‹ä¸”å°šæœªè¨­å®š SourcePrepaymentId çš„é …ç›®
            if (!item.PrepaymentTypeId.HasValue)
                continue;
            
            var selectedType = FilteredPrepaymentTypes?.FirstOrDefault(pt => pt.Id == item.PrepaymentTypeId.Value);
            if (selectedType == null || !IsTransferType(selectedType.Name))
                continue;
            
            // å¦‚æœå·²ç¶“æœ‰ SourcePrepaymentIdï¼Œä¸éœ€è¦å†æ¯”å°
            if (item.SourcePrepaymentId.HasValue && item.SourcePrepaymentId.Value > 0)
                continue;
            
            // æ ¹æ“š SourceDocumentCode æŸ¥è©¢å°æ‡‰çš„ä¾†æºé æ”¶ä»˜æ¬¾é …
            if (!string.IsNullOrEmpty(item.SourceDocumentCode))
            {
                var sourcePrepayment = AvailablePrepayments.FirstOrDefault(p => p.SourceDocumentCode == item.SourceDocumentCode);
                if (sourcePrepayment != null)
                {
                    item.SourcePrepaymentId = sourcePrepayment.Id;
                    
                    // åŒæ™‚è¨­å®š Amountï¼ˆä¾†æºçš„ç¸½é‡‘é¡ï¼Œç”¨æ–¼é¡¯ç¤ºï¼‰
                    if (item.Amount == 0)
                    {
                        item.Amount = sourcePrepayment.Amount;
                    }
                }
            }
        }
    }

    private void LoadExistingPrepayments()
    {
        if (ExistingPrepayments?.Any() == true)
        {
            //  ç·¨è¼¯æ¨¡å¼ï¼šè¼‰å…¥å·²å­˜åœ¨çš„é æ”¶ä»˜æ¬¾é …è¨˜éŒ„
            _dataLoadCompleted = false;  // é–‹å§‹è¼‰å…¥
            
            PrepaymentItems.Clear();
            PrepaymentItems = ExistingPrepayments.Select((prepayment, index) => 
            {
                //  ç›´æ¥ä½¿ç”¨ SourcePrepaymentId æ¬„ä½ï¼ˆä¸å†å¾ Remarks è§£æï¼‰
                var item = new SetoffPrepaymentItem
                {
                    Id = prepayment.Id,
                    PrepaymentTypeId = prepayment.PrepaymentTypeId,
                    SourcePrepaymentId = prepayment.SourcePrepaymentId,  //  ç›´æ¥ä½¿ç”¨è³‡æ–™åº«æ¬„ä½
                    SourceDocumentCode = prepayment.SourceDocumentCode,
                    Amount = prepayment.Amount,
                    UsedAmount = prepayment.UsedAmount,
                    Remarks = prepayment.Remarks,
                    ExistingPrepayment = prepayment
                };
                
                return item;
            }).ToList();
            
            _dataLoadCompleted = true;  // è¼‰å…¥å®Œæˆï¼Œè§¸ç™¼ç©ºè¡Œæª¢æŸ¥
            
            //  è¼‰å…¥å¾Œç«‹å³å˜—è©¦æ¯”å° SourcePrepaymentIdï¼ˆå¦‚æœ AvailablePrepayments å·²è¼‰å…¥ï¼‰
            if (AvailablePrepayments?.Any() == true)
            {
                MatchSourcePrepaymentIds();
            }
        }
        // ğŸ”‘ æ–°å¢æ¨¡å¼ï¼šä¸åšä»»ä½•äº‹ï¼Œè®“ InteractiveTableComponent è‡ªå‹•ç”¢ç”Ÿç¬¬ä¸€è¡Œç©ºè¡Œ
        // ä¸å‘¼å« Clear()ï¼Œé¿å…æ¸…é™¤å·²è‡ªå‹•ç”¢ç”Ÿçš„ç©ºè¡Œï¼ˆæ™‚åºå•é¡Œï¼‰
    }

    // ===== InteractiveTable æ¬„ä½å®šç¾© =====
    private List<InteractiveColumnDefinition> GetPrepaymentColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = L["Setoff.PrepaymentType"],
                PropertyName = nameof(SetoffPrepaymentItem.PrepaymentTypeId),
                ColumnType = InteractiveColumnType.Select,
                Width = "180px",
                TriggerEmptyRowOnFilled = true,  //  è§¸ç™¼æ¬„ä½ï¼šé¸æ“‡å¾Œè‡ªå‹•æ–°å¢ç©ºè¡Œ
                Options = new List<InteractiveSelectOption>
                {
                    new InteractiveSelectOption { Value = 0, Text = L["Placeholder.SelectType"] }
                }
                .Concat((FilteredPrepaymentTypes ?? new List<PrepaymentType>()).Select(pt => new InteractiveSelectOption
                { 
                    Value = pt.Id, 
                    Text = pt.Name 
                })).ToList(),
                OnSelectionChanged = EventCallback.Factory.Create<(object, object?)>(this, async args =>
                {
                    var (itemObj, value) = args;
                    var item = (SetoffPrepaymentItem)itemObj;
                    
                    if (value != null && int.TryParse(value.ToString(), out int typeId) && typeId > 0)
                    {
                        item.PrepaymentTypeId = typeId;
                        
                        // åˆ¤æ–·æ˜¯å¦éœ€è¦é¡¯ç¤ºä¾†æºå–®è™Ÿæ¬„ä½
                        var selectedType = FilteredPrepaymentTypes!.FirstOrDefault(pt => pt.Id == typeId);
                        if (selectedType != null && !IsTransferType(selectedType.Name))
                        {
                            // éè½‰æ²–æ¬¾é¡å‹ï¼šæ¸…ç©ºä¾†æºç›¸é—œæ¬„ä½ï¼Œè¨­å®šä¾†æºå–®è™Ÿç‚ºæ²–æ¬¾å–®è™Ÿ
                            item.SourcePrepaymentId = null;
                            item.SourceDocumentCode = SetoffDocumentNumber ?? string.Empty;
                            item.Amount = 0;
                        }
                    }
                    else
                    {
                        item.PrepaymentTypeId = null;
                        item.SourcePrepaymentId = null;
                        item.SourceDocumentCode = string.Empty;
                        item.Amount = 0;
                        item.UsedAmount = 0;
                    }
                    
                    await NotifyPrepaymentsChanged();
                    StateHasChanged();
                })
            },

            new()
            {
                Title = L["Setoff.SourceDocumentCode"],
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "250px",
                CustomTemplate = item =>
                {
                    var prepaymentItem = (SetoffPrepaymentItem)item;
                    
                    // å¦‚æœæœªé¸æ“‡é¡å‹ï¼Œé¡¯ç¤º "-"
                    if (!prepaymentItem.PrepaymentTypeId.HasValue)
                        return @<span class="text-muted">-</span>;
                    
                    var selectedType = FilteredPrepaymentTypes!.FirstOrDefault(pt => pt.Id == prepaymentItem.PrepaymentTypeId.Value);
                    if (selectedType == null)
                        return @<span class="text-muted">-</span>;
                    
                    // åˆ¤æ–·æ˜¯å¦ç‚ºè½‰æ²–æ¬¾é¡å‹
                    if (!IsTransferType(selectedType.Name))
                    {
                        // é æ”¶/é ä»˜é¡å‹ï¼šé¡¯ç¤ºä¾†æºå–®è™Ÿï¼ˆæ²–æ¬¾å–®è™Ÿï¼‰
                        var sourceCode = string.IsNullOrEmpty(prepaymentItem.SourceDocumentCode) 
                            ? "-" 
                            : prepaymentItem.SourceDocumentCode;
                        return @<span class="text-muted">@sourceCode</span>;
                    }
                    
                    // è½‰æ²–æ¬¾é¡å‹ï¼šé¡¯ç¤ºä¸‹æ‹‰é¸å–®
                    // å»ºç«‹ä¸‹æ‹‰é¸å–®é¸é …
                    var options = new List<InteractiveSelectOption>
                    {
                        new InteractiveSelectOption { Value = 0, Text = L["Placeholder.SelectPrepayment"] }
                    };
                    
                    // åŠ å…¥å¯ç”¨çš„é æ”¶ä»˜æ¬¾é …
                    var availableOptions = AvailablePrepayments.Select(p => new InteractiveSelectOption
                    { 
                        Value = p.Id, 
                        Text = $"{p.SourceDocumentCode} (é‡‘é¡: {NumberFormatHelper.FormatSmart(p.Amount)}, å‰©é¤˜: {NumberFormatHelper.FormatSmart(p.AvailableBalance)})" 
                    });
                    options.AddRange(availableOptions);
                    
                    var currentValue = prepaymentItem.SourcePrepaymentId ?? 0;
                    
                    //  ç·¨è¼¯æ¨¡å¼ï¼šå¦‚æœç•¶å‰é¸ä¸­çš„é …ç›®ä¸åœ¨ AvailablePrepayments ä¸­ï¼Œéœ€è¦åŠ å…¥åˆ°é¸é …æ¸…å–®
                    // é€™ç¨®æƒ…æ³ç™¼ç”Ÿåœ¨ï¼šä¾†æºé æ”¶ä»˜æ¬¾é …å·²ç¶“ç”¨å®Œï¼Œä¸å†é¡¯ç¤ºåœ¨å¯ç”¨æ¸…å–®ä¸­
                    if (currentValue > 0 && !options.Any(o => o.Value.Equals(currentValue)))
                    {
                        // ä½¿ç”¨ SourceDocumentCode å’Œ Amount é¡¯ç¤ºï¼ˆå› ç‚º AvailablePrepayments ä¸­æ‰¾ä¸åˆ°ï¼‰
                        var displayText = !string.IsNullOrEmpty(prepaymentItem.SourceDocumentCode)
                            ? $"{prepaymentItem.SourceDocumentCode} (é‡‘é¡: {NumberFormatHelper.FormatSmart(prepaymentItem.Amount)})"
                            : L["Setoff.UnknownSource"].ToString();
                        
                        // æ’å…¥åˆ°ç¬¬äºŒå€‹ä½ç½®ï¼ˆ"è«‹é¸æ“‡..."ä¹‹å¾Œï¼‰
                        options.Insert(1, new InteractiveSelectOption
                        {
                            Value = currentValue,
                            Text = displayText
                        });
                    }
                    
                    // ç›´æ¥ç¶å®šåˆ° item çš„å±¬æ€§ï¼Œä¸ä½¿ç”¨å±€éƒ¨è®Šæ•¸
                    return @<select class="form-select form-select-sm" 
                                    value="@currentValue"
                                    disabled="@IsReadOnly"
                                    @onchange="@(async e => await OnSourcePrepaymentChangedAsync(prepaymentItem, e.Value?.ToString()))">
                        @foreach (var option in options)
                        {
                            <option value="@option.Value">@option.Text</option>
                        }
                    </select>;
                }
            },
            new()
            {
                Title = L["Setoff.TotalAmount"],
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "120px",
                CustomTemplate = item =>
                {
                    var prepaymentItem = (SetoffPrepaymentItem)item;
                    
                    // å¦‚æœæœªé¸æ“‡é¡å‹ï¼Œé¡¯ç¤º "-"
                    if (!prepaymentItem.PrepaymentTypeId.HasValue)
                        return @<span class="text-muted">-</span>;
                    
                    var selectedType = FilteredPrepaymentTypes!.FirstOrDefault(pt => pt.Id == prepaymentItem.PrepaymentTypeId.Value);
                    if (selectedType == null)
                        return @<span class="text-muted">-</span>;
                    
                    if (IsTransferType(selectedType.Name))
                    {
                        // è½‰æ²–æ¬¾é¡å‹ï¼šé¡¯ç¤ºä¾†æºé æ”¶ä»˜æ¬¾é …çš„ç¸½é‡‘é¡
                        // å„ªå…ˆä½¿ç”¨ item.Amountï¼ˆç·¨è¼¯æ¨¡å¼æ™‚å·²ç¶“è¨­å®šå¥½ï¼‰
                        // å¦‚æœ Amount ç‚º 0ï¼Œå‰‡å¾ AvailablePrepayments æŸ¥è©¢ï¼ˆæ–°å¢æ¨¡å¼ï¼‰
                        var amount = prepaymentItem.Amount;
                        if (amount == 0 && prepaymentItem.SourcePrepaymentId.HasValue)
                        {
                            var sourcePrepayment = AvailablePrepayments.FirstOrDefault(p => p.Id == prepaymentItem.SourcePrepaymentId);
                            amount = sourcePrepayment?.Amount ?? 0;
                        }
                        return @<span class="text-muted">@NumberFormatHelper.FormatSmart(amount)</span>;
                    }
                    else
                    {
                        // é æ”¶/é ä»˜é¡å‹ï¼šé¡¯ç¤ºæœ¬æ¬¡æ”¶ä»˜çš„é‡‘é¡ï¼ˆå³ Amountï¼‰
                        return @<span class="text-muted">@NumberFormatHelper.FormatSmart(prepaymentItem.Amount)</span>;
                    }
                }
            },
            new()
            {
                Title = L["Setoff.AvailableBalance"],
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "120px",
                CustomTemplate = item =>
                {
                    var prepaymentItem = (SetoffPrepaymentItem)item;
                    
                    // æª¢æŸ¥æ˜¯å¦é¸æ“‡äº†é¡å‹
                    if (!prepaymentItem.PrepaymentTypeId.HasValue)
                        return @<span class="text-muted">-</span>;
                    
                    var selectedType = FilteredPrepaymentTypes!.FirstOrDefault(pt => pt.Id == prepaymentItem.PrepaymentTypeId.Value);
                    if (selectedType == null)
                        return @<span class="text-muted">-</span>;

                    if (IsTransferType(selectedType.Name))
                    {
                        // è½‰æ²–æ¬¾é¡å‹ï¼šä½¿ç”¨ AdjustedBalanceHelper è¨ˆç®—å‹•æ…‹èª¿æ•´å¾Œçš„å¯ç”¨é¤˜é¡
                        var sourcePrepayment = AvailablePrepayments.FirstOrDefault(p => p.Id == prepaymentItem.SourcePrepaymentId);
                        if (sourcePrepayment == null)
                            return @<span class="text-muted">-</span>;
                        
                        var baseAvailableBalance = sourcePrepayment.AvailableBalance;
                        var originalUsedAmount = prepaymentItem.ExistingPrepayment?.UsedAmount ?? 0;
                        var currentUsedAmount = prepaymentItem.UsedAmount;
                        
                        var adjustedBalance = AdjustedBalanceHelper.CalculateAdjustedBalance(
                            baseAvailableBalance,
                            originalUsedAmount,
                            currentUsedAmount,
                            IsEditMode());
                        
                        return @<span class="text-primary fw-bold">@NumberFormatHelper.FormatSmart(adjustedBalance)</span>;
                    }
                    else
                    {
                        // é æ”¶/é ä»˜é¡å‹ï¼šåªåœ¨ç·¨è¼¯æ¨¡å¼ä¸‹é¡¯ç¤ºæ­¤é æ”¶ä»˜æ¬¾é …çš„å¯ç”¨é¤˜é¡
                        if (IsEditMode() && prepaymentItem.ExistingPrepayment != null)
                        {
                            // ç·¨è¼¯æ¨¡å¼ï¼šè¨ˆç®—å¯ç”¨é¤˜é¡ = ç¸½é‡‘é¡ - å·²ç”¨é‡‘é¡
                            var availableBalance = prepaymentItem.ExistingPrepayment.Amount - prepaymentItem.ExistingPrepayment.UsedAmount;
                            return @<span class="text-success fw-bold">@NumberFormatHelper.FormatSmart(availableBalance)</span>;
                        }
                        else
                        {
                            // æ–°å¢æ¨¡å¼ï¼šé¡¯ç¤º "-"ï¼ˆå› ç‚ºé‚„æ²’å»ºç«‹ï¼Œæ²’æœ‰å¯ç”¨é¤˜é¡çš„æ¦‚å¿µï¼‰
                            return @<span class="text-muted">-</span>;
                        }
                    }
                }
            },
            new()
            {
                Title = L["Setoff.Amount"],
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "150px",
                CustomTemplate = item =>
                {
                    var prepaymentItem = (SetoffPrepaymentItem)item;
                    
                    // æª¢æŸ¥æ˜¯å¦ç‚ºè½‰æ²–æ¬¾é¡å‹
                    bool isTransferType = false;
                    if (prepaymentItem.PrepaymentTypeId.HasValue)
                    {
                        var selectedType = FilteredPrepaymentTypes!.FirstOrDefault(pt => pt.Id == prepaymentItem.PrepaymentTypeId.Value);
                        isTransferType = selectedType != null && IsTransferType(selectedType.Name);
                    }
                    
                    // æ ¹æ“šé¡å‹æ±ºå®šé¡¯ç¤ºçš„å€¼
                    var displayValue = isTransferType ? prepaymentItem.UsedAmount : prepaymentItem.Amount;
                    var formattedValue = NumberFormatHelper.FormatForInput(displayValue);
                    
                    return @<input type="number" 
                                   class="form-control  text-end" 
                                   value="@formattedValue" 
                                   onkeydown="if(['e','E','+','-'].includes(event.key)) event.preventDefault();"
                                   disabled="@IsReadOnly"
                                   step="1"
                                   min="0"
                                   placeholder=""
                                   @oninput="@(e => OnAmountInput(prepaymentItem, e.Value?.ToString()))" />;
                }
            },
            new()
            {
                Title = L["Label.Remarks"],
                PropertyName = nameof(SetoffPrepaymentItem.Remarks),
                ColumnType = InteractiveColumnType.Input,
                Width = "200px",
                IsRequired = false,
                OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
                {
                    var (itemObj, value) = args;
                    var item = (SetoffPrepaymentItem)itemObj;
                    
                    item.Remarks = value;
                    
                    // å‚™è¨»è®Šæ›´æ™‚ä¹Ÿéœ€è¦é€šçŸ¥çˆ¶çµ„ä»¶ï¼Œä»¥ä¾¿æ­£ç¢ºè¿½è¹¤è®Šæ›´
                    await NotifyPrepaymentsChanged();
                    StateHasChanged();
                })
            }
        };

        return columns;
    }
    
    private RenderFragment<SetoffPrepaymentItem> GetCustomActionsTemplate => item => __builder =>
    {
        // æª¢æŸ¥é …ç›®æ˜¯å¦å¯ä»¥åˆªé™¤ï¼ˆåªåœ¨ç·¨è¼¯æ¨¡å¼ä¸‹æ‰éœ€è¦æª¢æŸ¥ï¼‰
        bool canDelete = !IsEditMode();
        var isLastEmptyRow = tableComponent?.IsLastEmptyRow(item) ?? false;
        
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥æŸ¥çœ‹ç›¸é—œå–®æ“šï¼ˆåªæœ‰ã€Œé æ”¶/é ä»˜ã€é¡å‹ä¸”å·²å„²å­˜çš„è¨˜éŒ„ï¼‰
        bool canViewRelated = false;
        if (item.PrepaymentTypeId.HasValue && item.Id > 0)
        {
            var selectedType = FilteredPrepaymentTypes?.FirstOrDefault(pt => pt.Id == item.PrepaymentTypeId.Value);
            canViewRelated = selectedType != null && !IsTransferType(selectedType.Name);
        }
        
        if (isLastEmptyRow)
        {
            // æœ€å¾Œä¸€å€‹ç©ºè¡Œï¼šé¡¯ç¤ºç¦ç”¨çš„åˆªé™¤æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Red"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="true"
                                   Title="@L["Label.KeepOneEmptyRow"]"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else if (canDelete)
        {
            // å¯ä»¥åˆªé™¤ï¼šé¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Red"
                                   IconClass="bi bi-trash text-white"
                                   Size="ButtonSize.Large"
                                   IsDisabled="@IsReadOnly"
                                   Title="@L["Button.Delete"]"
                                   OnClick="async () => await HandleRemovePrepaymentRecord(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else if (canViewRelated)
        {
            // ç·¨è¼¯æ¨¡å¼ä¸”å¯ä»¥æŸ¥çœ‹ç›¸é—œå–®æ“šï¼šé¡¯ç¤ºæŸ¥çœ‹æŒ‰éˆ•
            <GenericButtonComponent Variant="ButtonVariant.Blue"
                                   IconClass="bi bi-eye text-white"
                                   Size="ButtonSize.Large"
                                   Title="@L["Setoff.ViewRelatedSetoff"]"
                                   OnClick="async () => await ShowRelatedDocuments(item)"
                                   StopPropagation="true"
                                   CssClass="btn-square" />
        }
        else
        {
            // ç·¨è¼¯æ¨¡å¼ä½†ä¸èƒ½æŸ¥çœ‹ç›¸é—œå–®æ“šï¼šé¡¯ç¤ºç©ºç™½æˆ–ç¦ç”¨ç‹€æ…‹
            <span class="text-muted">-</span>
        }
    };
    
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦ç‚ºè½‰æ²–æ¬¾é¡å‹ï¼ˆé æ”¶è½‰æ²–æ¬¾ã€é ä»˜è½‰æ²–æ¬¾ï¼‰
    /// </summary>
    private bool IsTransferType(string typeName)
    {
        return typeName.Contains("è½‰æ²–æ¬¾");
    }
    
    /// <summary>
    /// è™•ç†ä¾†æºé æ”¶ä»˜æ¬¾é …è®Šæ›´
    /// </summary>
    private async Task OnSourcePrepaymentChangedAsync(SetoffPrepaymentItem item, string? value)
    {
        if (value != null && int.TryParse(value, out int prepaymentId) && prepaymentId > 0)
        {
            item.SourcePrepaymentId = prepaymentId;
            
            // è‡ªå‹•å¸¶å…¥ä¾†æºé æ”¶ä»˜æ¬¾é …çš„è³‡è¨Š
            var selectedPrepayment = AvailablePrepayments.FirstOrDefault(p => p.Id == prepaymentId);
            if (selectedPrepayment != null)
            {
                item.SourceDocumentCode = selectedPrepayment.SourceDocumentCode;
                //  è½‰æ²–æ¬¾é¡å‹ï¼šAmount ç‚ºä¾†æºçš„ç¸½é‡‘é¡ï¼ˆç”¨æ–¼é¡¯ç¤ºï¼‰ï¼ŒUsedAmount ç‚ºå¯ç”¨é¤˜é¡
                item.Amount = selectedPrepayment.Amount;  // è¨­å®šä¾†æºçš„ç¸½é‡‘é¡
                item.UsedAmount = selectedPrepayment.AvailableBalance;
            }
        }
        else
        {
            item.SourcePrepaymentId = null;
            item.SourceDocumentCode = string.Empty;
            item.Amount = 0;
            item.UsedAmount = 0;
        }
        
        await NotifyPrepaymentsChanged();
        // ä¸å‘¼å« StateHasChanged()ï¼Œè®“ Blazor è‡ªå‹•è™•ç†æ¸²æŸ“
    }

    // ===== äº‹ä»¶è™•ç†æ–¹æ³• =====
    private async Task HandleRemovePrepaymentRecord(SetoffPrepaymentItem item)
    {
        if (IsReadOnly) return;
        
        PrepaymentItems.Remove(item);
        
        await NotificationService.ShowInfoAsync(L["Message.PrepaymentRecordRemoved"]);
        await NotifyPrepaymentsChanged();
        StateHasChanged();
    }

    private async Task OnAmountInput(SetoffPrepaymentItem item, string? value)
    {
        // åˆ¤æ–·æ˜¯å¦ç‚ºè½‰æ²–æ¬¾é¡å‹
        bool isTransferType = false;
        if (item.PrepaymentTypeId.HasValue)
        {
            var selectedType = FilteredPrepaymentTypes.FirstOrDefault(pt => pt.Id == item.PrepaymentTypeId.Value);
            isTransferType = selectedType != null && IsTransferType(selectedType.Name);
        }
        
        if (decimal.TryParse(value, out var amount))
        {
            if (isTransferType)
            {
                // è½‰æ²–æ¬¾é¡å‹ï¼šè¼¸å…¥çš„æ˜¯ UsedAmountï¼Œä½¿ç”¨ AdjustedBalanceHelper é©—è­‰
                var sourcePrepayment = AvailablePrepayments.FirstOrDefault(p => p.Id == item.SourcePrepaymentId);
                if (sourcePrepayment != null)
                {
                    var originalUsedAmount = item.ExistingPrepayment?.UsedAmount ?? 0;
                    
                    // ä½¿ç”¨ AdjustedBalanceHelper é©—è­‰é‡‘é¡
                    var isValid = AdjustedBalanceHelper.ValidateAmount(
                        amount,
                        sourcePrepayment.AvailableBalance,
                        originalUsedAmount,
                        IsEditMode());
                    
                    if (!isValid)
                    {
                        // è¨ˆç®—æœ€å¤§å¯ç”¨é‡‘é¡
                        var maxAvailable = AdjustedBalanceHelper.CalculateAdjustedBalance(
                            sourcePrepayment.AvailableBalance,
                            originalUsedAmount,
                            0,
                            IsEditMode());
                        
                        // ä¸å…è¨±è¶…éå¯ç”¨é¤˜é¡ï¼Œç›´æ¥è¨­ç‚ºæœ€å¤§å¯ç”¨é‡‘é¡
                        item.UsedAmount = maxAvailable;
                        await NotificationService.ShowWarningAsync(string.Format(L["Message.UsedAmountExceedsBalance"], NumberFormatHelper.FormatSmart(maxAvailable)));
                    }
                    else if (amount < 0)
                    {
                        // ä¸å…è¨±è² æ•¸
                        item.UsedAmount = 0;
                        await NotificationService.ShowWarningAsync(L["Message.UsedAmountBelowZero"]);
                    }
                    else
                    {
                        item.UsedAmount = amount;
                    }
                }
                else
                {
                    item.UsedAmount = amount;
                }
            }
            else
            {
                // é æ”¶/é ä»˜é¡å‹ï¼šè¼¸å…¥çš„æ˜¯ Amount
                if (amount < 0)
                {
                    item.Amount = 0;
                    await NotificationService.ShowWarningAsync(L["Message.AmountBelowZero"]);
                }
                else
                {
                    item.Amount = amount;
                }
            }
        }
        else if (string.IsNullOrWhiteSpace(value))
        {
            // å¦‚æœè¼¸å…¥ç‚ºç©ºç™½ï¼Œè¨­ç‚º0
            if (isTransferType)
            {
                item.UsedAmount = 0;
            }
            else
            {
                item.Amount = 0;
            }
        }
        
        await NotifyPrepaymentsChanged();
        StateHasChanged();
    }

    private async Task NotifyPrepaymentsChanged()
    {
        // åªå‚³ééç©ºè¡Œçš„é æ”¶ä»˜æ¬¾é …è¨˜éŒ„
        // âœ… ä¿®æ­£ï¼šç›´æ¥ä½¿ç”¨ item çš„æ¬„ä½å€¼ï¼Œä¸è¦å¾ AvailablePrepayments é‡æ–°æŸ¥è©¢ï¼Œé¿å…è³‡æ–™è¢«è¦†è“‹
        var prepayments = PrepaymentItems
            .Where(item => item.PrepaymentTypeId.HasValue && item.PrepaymentTypeId.Value > 0)
            .Select(item => new SetoffPrepayment
            {
                // çµ±ä¸€ä½¿ç”¨ ExistingPrepayment?.Idï¼Œèˆ‡ SetoffPaymentTable ä¿æŒä¸€è‡´
                Id = item.ExistingPrepayment?.Id ?? 0,
                SetoffDocumentId = SetoffDocumentId ?? 0,
                PrepaymentTypeId = item.PrepaymentTypeId ?? 0,
                SourceDocumentCode = item.SourceDocumentCode,  // âœ… ç›´æ¥ä½¿ç”¨ item çš„å€¼
                SourcePrepaymentId = item.SourcePrepaymentId,
                Amount = item.Amount,  // âœ… ç›´æ¥ä½¿ç”¨ item çš„å€¼
                UsedAmount = item.UsedAmount,  // âœ… ç›´æ¥ä½¿ç”¨ item çš„å€¼
                CustomerId = CustomerId,  // âœ… ä½¿ç”¨åƒæ•¸å‚³å…¥çš„å€¼
                SupplierId = SupplierId,  // âœ… ä½¿ç”¨åƒæ•¸å‚³å…¥çš„å€¼
                Remarks = item.Remarks,
                // é‡è¦ï¼šä¸è¨­å®šå°èˆªå±¬æ€§ï¼Œé¿å… EF Core è¿½è¹¤è¡çª
                PrepaymentType = null!,
                Customer = null,
                Supplier = null,
                SetoffDocument = null,
                SourcePrepayment = null
            })
            .ToList();

        await DetailSyncHelper.SyncToParentAsync(prepayments, OnPrepaymentsChanged);
    }

    // ===== å…¬é–‹æ–¹æ³•ï¼ˆä¾›çˆ¶çµ„ä»¶èª¿ç”¨ï¼‰=====
    
    /// <summary>
    /// å–å¾—ç¸½ä½¿ç”¨é‡‘é¡
    /// </summary>
    public decimal GetTotalUsedAmount() => TotalUsedAmount;

    /// <summary>
    /// é©—è­‰é æ”¶ä»˜æ¬¾é …è¨˜éŒ„
    /// </summary>
    public async Task<bool> ValidateAsync()
    {
        var errors = new List<string>();
        
        var nonEmptyItems = PrepaymentItems
            .Where(item => item.PrepaymentTypeId.HasValue && item.PrepaymentTypeId.Value > 0)
            .ToList();
        
        foreach (var item in nonEmptyItems)
        {
            // æª¢æŸ¥æ˜¯å¦é¸æ“‡äº†é æ”¶ä»˜é¡å‹
            if (!item.PrepaymentTypeId.HasValue || item.PrepaymentTypeId.Value <= 0)
            {
                errors.Add(L["Message.SelectPrepaymentType"]);
                continue;
            }
            
            var selectedType = FilteredPrepaymentTypes.FirstOrDefault(pt => pt.Id == item.PrepaymentTypeId.Value);
            if (selectedType != null && IsTransferType(selectedType.Name))
            {
                // è½‰æ²–æ¬¾é¡å‹ï¼šå¿…é ˆé¸æ“‡ä¾†æºé æ”¶ä»˜æ¬¾é …
                if (!item.SourcePrepaymentId.HasValue || item.SourcePrepaymentId.Value <= 0)
                {
                    errors.Add(L["Message.TransferTypeNeedsSource"]);
                    continue;
                }
                
                // ä½¿ç”¨ AdjustedBalanceHelper æª¢æŸ¥ä½¿ç”¨é‡‘é¡æ˜¯å¦è¶…éå¯ç”¨é¤˜é¡
                var sourcePrepayment = AvailablePrepayments.FirstOrDefault(p => p.Id == item.SourcePrepaymentId);
                if (sourcePrepayment != null)
                {
                    var originalUsedAmount = item.ExistingPrepayment?.UsedAmount ?? 0;
                    
                    var isValid = AdjustedBalanceHelper.ValidateAmount(
                        item.UsedAmount,
                        sourcePrepayment.AvailableBalance,
                        originalUsedAmount,
                        IsEditMode());
                    
                    if (!isValid)
                    {
                        var maxAvailable = AdjustedBalanceHelper.CalculateAdjustedBalance(
                            sourcePrepayment.AvailableBalance,
                            originalUsedAmount,
                            0,
                            IsEditMode());
                        
                        errors.Add(string.Format(L["Message.UsedAmountExceedsBalance"], $"{sourcePrepayment.SourceDocumentCode} (max: {NumberFormatHelper.FormatSmart(maxAvailable)})" ));
                    }
                }
                
                // è½‰æ²–æ¬¾é¡å‹ï¼šæª¢æŸ¥ UsedAmount å¿…é ˆå¤§æ–¼ 0
                if (item.UsedAmount <= 0)
                {
                    errors.Add(L["Message.UsedAmountMustBePositive"]);
                }
            }
            else if (selectedType != null)
            {
                //  é æ”¶/é ä»˜é¡å‹ï¼šæª¢æŸ¥ Amount å¿…é ˆå¤§æ–¼ 0
                if (item.Amount <= 0)
                {
                    errors.Add(L["Message.AmountMustBePositive"]);
                }
            }
        }
        
        if (errors.Any())
        {
            var errorMessage = string.Join("\n", errors);
            await NotificationService.ShowErrorAsync(errorMessage);
            return false;
        }
        
        return true;
    }
    
    /// <summary>
    /// å…¬é–‹çš„åˆ·æ–°æ–¹æ³•ï¼Œç”¨æ–¼å¤–éƒ¨è§¸ç™¼æ˜ç´°åˆ·æ–°ï¼ˆä¾‹å¦‚ï¼šä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼‰
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadAvailablePrepaymentsAsync();
        LoadExistingPrepayments();
        StateHasChanged();
    }
    
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼ï¼ˆç·¨è¼¯æ¨¡å¼ä¸‹ä¸å…è¨±åˆªé™¤æ˜ç´°ï¼‰
    /// </summary>
    private bool IsEditMode()
    {
        return SetoffDocumentId.HasValue && SetoffDocumentId.Value > 0;
    }

    // ===== ç›¸é—œå–®æ“šæŸ¥çœ‹æ–¹æ³• =====
    
    /// <summary>
    /// é¡¯ç¤ºç›¸é—œå–®æ“šï¼ˆä½¿ç”¨æ­¤é æ”¶ä»˜æ¬¾é …çš„æ²–æ¬¾å–®ï¼‰
    /// </summary>
    private async Task ShowRelatedDocuments(SetoffPrepaymentItem item)
    {
        // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ ID
        if (item.Id <= 0)
        {
            await NotificationService.ShowWarningAsync(L["Message.RecordNotSavedCannotQuery"]);
            return;
        }
        
        // è¨­å®šé¡¯ç¤ºåç¨±
        var typeName = FilteredPrepaymentTypes?.FirstOrDefault(pt => pt.Id == item.PrepaymentTypeId)?.Name ?? "é æ”¶ä»˜æ¬¾é …";
        selectedPrepaymentName = $"{typeName} - {item.SourceDocumentCode}";
        
        // é¡¯ç¤º Modal ä¸¦é–‹å§‹è¼‰å…¥
        showRelatedDocumentsModal = true;
        isLoadingRelatedDocuments = true;
        relatedDocuments = null;
        StateHasChanged();
        
        try
        {
            relatedDocuments = await RelatedDocumentsHelper.GetRelatedDocumentsForPrepaymentAsync(item.Id);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥ç›¸é—œå–®æ“šå¤±æ•—ï¼š{ex.Message}");
        }
        finally
        {
            isLoadingRelatedDocuments = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// è™•ç†é»æ“Šç›¸é—œå–®æ“šçš„äº‹ä»¶
    /// </summary>
    private async Task HandleRelatedDocumentClick(RelatedDocument document)
    {
        // è§¸ç™¼äº‹ä»¶ï¼Œè®“çˆ¶çµ„ä»¶ï¼ˆEditModalï¼‰è™•ç†é–‹å•Ÿç›¸é—œå–®æ“š
        if (OnOpenRelatedDocument.HasDelegate)
        {
            await OnOpenRelatedDocument.InvokeAsync((document.DocumentType, document.DocumentId));
        }
        else
        {
            await NotificationService.ShowInfoAsync(
                $"è«‹åœ¨çˆ¶çµ„ä»¶ä¸­å¯¦ä½œ OnOpenRelatedDocument äº‹ä»¶ä¾†é–‹å•Ÿ {document.TypeDisplayName}ï¼š{document.DocumentNumber}");
        }
    }

    // ===== å…§éƒ¨è³‡æ–™é¡åˆ¥ =====
    private class SetoffPrepaymentItem : BaseEntity
    {
        public int? PrepaymentTypeId { get; set; }
        public int? SourcePrepaymentId { get; set; }
        public string SourceDocumentCode { get; set; } = string.Empty;
        public decimal Amount { get; set; }
        public decimal UsedAmount { get; set; }
        public SetoffPrepayment? ExistingPrepayment { get; set; }
        // Remarks ç¹¼æ‰¿è‡ª BaseEntity
    }
}
