@* 傳票編輯組件 - 支援主檔 + 分錄明細行的複合編輯 *@
@inject IJournalEntryService JournalEntryService
@inject IAccountItemService AccountItemService
@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthenticationStateProvider

@if (IsVisible)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
            <div class="modal-content">

                @* ===== 標題列 ===== *@
                <div class="modal-header bg-light">
                    <h5 class="modal-title">
                        <i class="bi bi-journal-text me-2"></i>
                        @(JournalEntryId.HasValue ? $"編輯傳票 {journalEntry?.Code}" : "新增傳票")
                    </h5>
                    <button type="button" class="btn-close" @onclick="HandleCancel" disabled="@isSaving"></button>
                </div>

                @* ===== 主體 ===== *@
                <div class="modal-body">
                    @if (isLoading)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">載入中...</p>
                        </div>
                    }
                    else if (journalEntry != null)
                    {
                        <EditForm Model="journalEntry" @ref="editForm">
                            @* ===== 主檔資訊 ===== *@
                            <div class="card mb-3">
                                <div class="card-header fw-semibold">基本資料</div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label required">傳票日期</label>
                                            <InputDate class="form-control" @bind-Value="journalEntry.EntryDate"
                                                       disabled="@IsReadOnly" />
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label required">傳票類型</label>
                                            <InputSelect class="form-select" @bind-Value="journalEntry.EntryType"
                                                         disabled="@IsReadOnly">
                                                <option value="@JournalEntryType.Manual">手動輸入</option>
                                                <option value="@JournalEntryType.Adjusting">調整分錄</option>
                                                <option value="@JournalEntryType.Closing">結帳分錄</option>
                                                <option value="@JournalEntryType.AutoGenerated" disabled>自動產生</option>
                                                <option value="@JournalEntryType.Reversing" disabled>沖銷分錄</option>
                                            </InputSelect>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label required">會計年度</label>
                                            <InputNumber class="form-control" @bind-Value="journalEntry.FiscalYear"
                                                         disabled="@IsReadOnly" />
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label required">會計期間（月）</label>
                                            <InputSelect class="form-select" @bind-Value="journalEntry.FiscalPeriod"
                                                         disabled="@IsReadOnly">
                                                @for (int m = 1; m <= 12; m++)
                                                {
                                                    var month = m;
                                                    <option value="@month">@month 月</option>
                                                }
                                            </InputSelect>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">狀態</label>
                                            <div class="form-control-plaintext">
                                                <span class="badge @GetStatusBadgeClass(journalEntry.JournalEntryStatus)">
                                                    @GetStatusText(journalEntry.JournalEntryStatus)
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">傳票說明</label>
                                            <InputText class="form-control" @bind-Value="journalEntry.Description"
                                                       placeholder="請輸入傳票說明" disabled="@IsReadOnly" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            @* ===== 分錄明細 ===== *@
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center fw-semibold">
                                    <span>分錄明細</span>
                                    @if (!IsReadOnly)
                                    {
                                        <button type="button" class="btn btn-sm btn-outline-primary" @onclick="AddLine">
                                            <i class="bi bi-plus-lg me-1"></i>新增行
                                        </button>
                                    }
                                </div>
                                <div class="card-body p-0">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 40px;">#</th>
                                                <th>會計科目</th>
                                                <th style="width: 100px;">借貸</th>
                                                <th style="width: 140px; text-align: right;">金額</th>
                                                <th>說明</th>
                                                @if (!IsReadOnly)
                                                {
                                                    <th style="width: 60px;"></th>
                                                }
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (!lines.Any())
                                            {
                                                <tr>
                                                    <td colspan="6" class="text-center text-muted py-3">
                                                        尚未新增分錄行，點擊「新增行」開始輸入
                                                    </td>
                                                </tr>
                                            }
                                            else
                                            {
                                                @foreach (var (line, idx) in lines.Select((l, i) => (l, i)))
                                                {
                                                    <tr>
                                                        <td class="align-middle text-muted">@(idx + 1)</td>
                                                        <td>
                                                            @if (IsReadOnly)
                                                            {
                                                                <span>@(line.AccountItem?.Code) @(line.AccountItem?.Name)</span>
                                                            }
                                                            else
                                                            {
                                                                <select class="form-select form-select-sm"
                                                                        value="@line.AccountItemId"
                                                                        @onchange="e => UpdateLineAccount(line, e)">
                                                                    <option value="0">-- 選擇科目 --</option>
                                                                    @foreach (var account in detailAccounts)
                                                                    {
                                                                        <option value="@account.Id">@account.Code @account.Name</option>
                                                                    }
                                                                </select>
                                                            }
                                                        </td>
                                                        <td>
                                                            @if (IsReadOnly)
                                                            {
                                                                <span class="badge @(line.Direction == AccountDirection.Debit ? "bg-primary" : "bg-success")">
                                                                    @(line.Direction == AccountDirection.Debit ? "借" : "貸")
                                                                </span>
                                                            }
                                                            else
                                                            {
                                                                <select class="form-select form-select-sm"
                                                                        value="@((int)line.Direction)"
                                                                        @onchange="e => UpdateLineDirection(line, e)">
                                                                    <option value="@((int)AccountDirection.Debit)">借（Debit）</option>
                                                                    <option value="@((int)AccountDirection.Credit)">貸（Credit）</option>
                                                                </select>
                                                            }
                                                        </td>
                                                        <td style="text-align: right;">
                                                            @if (IsReadOnly)
                                                            {
                                                                <span>@line.Amount.ToString("N2")</span>
                                                            }
                                                            else
                                                            {
                                                                <InputNumber class="form-control form-control-sm text-end"
                                                                             @bind-Value="line.Amount"
                                                                             @bind-Value:after="RecalculateTotals" />
                                                            }
                                                        </td>
                                                        <td>
                                                            @if (IsReadOnly)
                                                            {
                                                                <span class="text-muted">@(line.LineDescription ?? "-")</span>
                                                            }
                                                            else
                                                            {
                                                                <InputText class="form-control form-control-sm"
                                                                           @bind-Value="line.LineDescription"
                                                                           placeholder="說明" />
                                                            }
                                                        </td>
                                                        @if (!IsReadOnly)
                                                        {
                                                            <td class="align-middle text-center">
                                                                <button type="button" class="btn btn-sm btn-outline-danger"
                                                                        @onclick="() => RemoveLine(line)">
                                                                    <i class="bi bi-x"></i>
                                                                </button>
                                                            </td>
                                                        }
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                        <tfoot class="table-light fw-semibold">
                                            <tr>
                                                <td colspan="3" class="text-end">合計</td>
                                                <td style="text-align: right;">
                                                    <div class="text-primary">借：@totalDebit.ToString("N2")</div>
                                                    <div class="text-success">貸：@totalCredit.ToString("N2")</div>
                                                </td>
                                                <td colspan="@(IsReadOnly ? 1 : 2)">
                                                    @if (isBalanced && lines.Any())
                                                    {
                                                        <span class="badge bg-success">
                                                            <i class="bi bi-check-circle me-1"></i>借貸平衡
                                                        </span>
                                                    }
                                                    else if (lines.Any())
                                                    {
                                                        <span class="badge bg-danger">
                                                            差額 @Math.Abs(totalDebit - totalCredit).ToString("N2")
                                                        </span>
                                                    }
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>

                            @* ===== 備注 ===== *@
                            @if (!IsReadOnly || !string.IsNullOrWhiteSpace(journalEntry.Remarks))
                            {
                                <div class="card">
                                    <div class="card-header fw-semibold">備注</div>
                                    <div class="card-body">
                                        <InputTextArea class="form-control" @bind-Value="journalEntry.Remarks"
                                                       rows="2" placeholder="備注（選填）"
                                                       disabled="@IsReadOnly" />
                                    </div>
                                </div>
                            }
                        </EditForm>
                    }
                </div>

                @* ===== 按鈕列 ===== *@
                <div class="modal-footer">
                    @if (journalEntry != null && !isLoading)
                    {
                        @* 來源單號顯示 *@
                        @if (!string.IsNullOrWhiteSpace(journalEntry.SourceDocumentCode))
                        {
                            <span class="text-muted me-auto small">
                                來源：@journalEntry.SourceDocumentType @journalEntry.SourceDocumentCode
                            </span>
                        }

                        @* 草稿狀態：可儲存、可過帳 *@
                        @if (journalEntry.JournalEntryStatus == JournalEntryStatus.Draft)
                        {
                            <button type="button" class="btn btn-outline-secondary" @onclick="HandleCancel" disabled="@isSaving">
                                取消
                            </button>
                            <button type="button" class="btn btn-outline-primary" @onclick="HandleSaveDraft" disabled="@isSaving">
                                @if (isSaving && saveAction == "draft")
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                儲存草稿
                            </button>
                            <button type="button" class="btn btn-success" @onclick="HandlePost"
                                    disabled="@(isSaving || !isBalanced || !lines.Any())">
                                @if (isSaving && saveAction == "post")
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                <i class="bi bi-check2-circle me-1"></i>過帳
                            </button>
                        }

                        @* 已過帳：可沖銷 *@
                        else if (journalEntry.JournalEntryStatus == JournalEntryStatus.Posted && !journalEntry.IsReversed)
                        {
                            <button type="button" class="btn btn-outline-secondary" @onclick="HandleCancel">
                                關閉
                            </button>
                            <button type="button" class="btn btn-warning" @onclick="HandleReverse" disabled="@isSaving">
                                @if (isSaving && saveAction == "reverse")
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                <i class="bi bi-arrow-counterclockwise me-1"></i>沖銷此傳票
                            </button>
                        }

                        @* 其他狀態：僅關閉 *@
                        else
                        {
                            <button type="button" class="btn btn-secondary" @onclick="HandleCancel">關閉</button>
                        }
                    }
                    else
                    {
                        <button type="button" class="btn btn-secondary" @onclick="HandleCancel">取消</button>
                    }
                </div>

            </div>
        </div>
    </div>
}

@code {
    // ===== 參數 =====
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? JournalEntryId { get; set; }
    [Parameter] public EventCallback<JournalEntry> OnJournalEntrySaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== 內部狀態 =====
    private EditForm? editForm;
    private JournalEntry? journalEntry;
    private List<JournalEntryLine> lines = new();
    private List<AccountItem> detailAccounts = new();
    private bool isLoading = false;
    private bool isSaving = false;
    private string saveAction = "";
    private decimal totalDebit = 0;
    private decimal totalCredit = 0;
    private bool isBalanced => totalDebit == totalCredit && totalDebit > 0;
    private bool IsReadOnly => journalEntry?.JournalEntryStatus is
        JournalEntryStatus.Posted or JournalEntryStatus.Cancelled or JournalEntryStatus.Reversed;
    private string currentUser = "System";

    // ===== 生命週期 =====
    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible)
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            currentUser = authState.User.Identity?.Name ?? "System";

            if (detailAccounts.Count == 0)
                detailAccounts = await AccountItemService.GetDetailAccountsAsync();

            await LoadDataAsync();
        }
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        try
        {
            if (JournalEntryId.HasValue)
            {
                journalEntry = await JournalEntryService.GetWithLinesAsync(JournalEntryId.Value);
                if (journalEntry != null)
                {
                    lines = journalEntry.Lines
                        .OrderBy(l => l.LineNumber)
                        .ToList();
                    RecalculateTotals();
                }
            }
            else
            {
                // 新增：預設值
                var now = DateTime.Now;
                journalEntry = new JournalEntry
                {
                    EntryDate = now,
                    EntryType = JournalEntryType.Manual,
                    JournalEntryStatus = JournalEntryStatus.Draft,
                    FiscalYear = now.Year,
                    FiscalPeriod = now.Month
                };
                lines = new List<JournalEntryLine>();
                totalDebit = 0;
                totalCredit = 0;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDataAsync), GetType());
            await NotificationService.ShowErrorAsync("載入傳票資料失敗");
        }
        finally
        {
            isLoading = false;
        }
    }

    // ===== 分錄行操作 =====

    private void AddLine()
    {
        lines.Add(new JournalEntryLine
        {
            LineNumber = lines.Count + 1,
            Direction = AccountDirection.Debit,
            Amount = 0
        });
    }

    private void RemoveLine(JournalEntryLine line)
    {
        lines.Remove(line);
        RenumberLines();
        RecalculateTotals();
    }

    private void RenumberLines()
    {
        for (int i = 0; i < lines.Count; i++)
            lines[i].LineNumber = i + 1;
    }

    private void UpdateLineAccount(JournalEntryLine line, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var accountId))
        {
            line.AccountItemId = accountId;
            line.AccountItem = detailAccounts.FirstOrDefault(a => a.Id == accountId) ?? null!;
        }
    }

    private void UpdateLineDirection(JournalEntryLine line, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var dirValue) &&
            Enum.IsDefined(typeof(AccountDirection), dirValue))
        {
            line.Direction = (AccountDirection)dirValue;
            RecalculateTotals();
        }
    }

    private void RecalculateTotals()
    {
        totalDebit = lines
            .Where(l => l.Direction == AccountDirection.Debit)
            .Sum(l => l.Amount);
        totalCredit = lines
            .Where(l => l.Direction == AccountDirection.Credit)
            .Sum(l => l.Amount);
    }

    // ===== 按鈕事件 =====

    private async Task HandleSaveDraft()
    {
        if (journalEntry == null) return;
        isSaving = true;
        saveAction = "draft";
        try
        {
            PrepareJournalEntryForSave();
            var (success, error) = await JournalEntryService.SaveWithLinesAsync(journalEntry, currentUser);
            if (success)
            {
                await NotificationService.ShowSuccessAsync("草稿儲存成功");
                await OnJournalEntrySaved.InvokeAsync(journalEntry);
                await CloseModal();
            }
            else
            {
                await NotificationService.ShowErrorAsync($"儲存失敗：{error}");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleSaveDraft), GetType());
            await NotificationService.ShowErrorAsync("儲存時發生錯誤");
        }
        finally
        {
            isSaving = false;
            saveAction = "";
        }
    }

    private async Task HandlePost()
    {
        if (journalEntry == null) return;
        if (!isBalanced)
        {
            await NotificationService.ShowWarningAsync("借貸不平衡，無法過帳");
            return;
        }
        isSaving = true;
        saveAction = "post";
        try
        {
            // 先儲存草稿
            PrepareJournalEntryForSave();
            var (saveSuccess, saveError) = await JournalEntryService.SaveWithLinesAsync(journalEntry, currentUser);
            if (!saveSuccess)
            {
                await NotificationService.ShowErrorAsync($"儲存失敗：{saveError}");
                return;
            }

            // 再過帳
            var (postSuccess, postError) = await JournalEntryService.PostEntryAsync(journalEntry.Id, currentUser);
            if (postSuccess)
            {
                await NotificationService.ShowSuccessAsync("傳票過帳成功");
                await OnJournalEntrySaved.InvokeAsync(journalEntry);
                await CloseModal();
            }
            else
            {
                await NotificationService.ShowErrorAsync($"過帳失敗：{postError}");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePost), GetType());
            await NotificationService.ShowErrorAsync("過帳時發生錯誤");
        }
        finally
        {
            isSaving = false;
            saveAction = "";
        }
    }

    private async Task HandleReverse()
    {
        if (journalEntry == null) return;
        isSaving = true;
        saveAction = "reverse";
        try
        {
            var (success, error, reversalEntry) = await JournalEntryService.ReverseEntryAsync(
                journalEntry.Id, DateTime.Now, currentUser);

            if (success)
            {
                await NotificationService.ShowSuccessAsync($"沖銷傳票建立成功：{reversalEntry?.Code}");
                await OnJournalEntrySaved.InvokeAsync(journalEntry);
                await CloseModal();
            }
            else
            {
                await NotificationService.ShowErrorAsync($"沖銷失敗：{error}");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleReverse), GetType());
            await NotificationService.ShowErrorAsync("沖銷時發生錯誤");
        }
        finally
        {
            isSaving = false;
            saveAction = "";
        }
    }

    private async Task HandleCancel()
    {
        await CloseModal();
        await OnCancel.InvokeAsync();
    }

    private async Task CloseModal()
    {
        journalEntry = null;
        lines = new List<JournalEntryLine>();
        await IsVisibleChanged.InvokeAsync(false);
    }

    private void PrepareJournalEntryForSave()
    {
        if (journalEntry == null) return;
        journalEntry.Lines = lines;
        // 同步 FiscalYear/FiscalPeriod 與 EntryDate
        journalEntry.FiscalYear = journalEntry.EntryDate.Year;
        journalEntry.FiscalPeriod = journalEntry.EntryDate.Month;
    }

    // ===== 顯示輔助 =====

    private string GetStatusBadgeClass(JournalEntryStatus status) => status switch
    {
        JournalEntryStatus.Draft     => "bg-secondary",
        JournalEntryStatus.Posted    => "bg-success",
        JournalEntryStatus.Cancelled => "bg-danger",
        JournalEntryStatus.Reversed  => "bg-warning text-dark",
        _                            => "bg-secondary"
    };

    private string GetStatusText(JournalEntryStatus status) => status switch
    {
        JournalEntryStatus.Draft     => "草稿",
        JournalEntryStatus.Posted    => "已過帳",
        JournalEntryStatus.Cancelled => "已取消",
        JournalEntryStatus.Reversed  => "已沖銷",
        _                            => status.ToString()
    };

    // ===== 公開方法（供父組件調用）=====
    public async Task ShowAddModal()
    {
        JournalEntryId = null;
        await IsVisibleChanged.InvokeAsync(true);
    }

    public async Task ShowEditModal(int id)
    {
        JournalEntryId = id;
        await IsVisibleChanged.InvokeAsync(true);
    }
}
