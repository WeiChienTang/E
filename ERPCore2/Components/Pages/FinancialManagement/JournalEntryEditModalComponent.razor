@* 傳票編輯組件 - 使用 GenericEditModalComponent 統一架構 *@

@using ERPCore2.Helpers
@using ERPCore2.Helpers.EditModal
@inject IJournalEntryService JournalEntryService
@inject IAccountItemService AccountItemService
@inject ICompanyService CompanyService
@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthenticationStateProvider

<GenericEditModalComponent TEntity="JournalEntry"
                          TService="IJournalEntryService"
                          @ref="editModalComponent"
                          IsVisible="@IsVisible"
                          IsVisibleChanged="@IsVisibleChanged"
                          @bind-Id="@JournalEntryId"
                          Service="@JournalEntryService"
                          EntityName="傳票"
                          EntityNamePlural="傳票"
                          ModalTitle="@(JournalEntryId.HasValue ? "編輯傳票" : "新增傳票")"
                          Size="GenericEditModalComponent<JournalEntry, IJournalEntryService>.ModalSize.Desktop"
                          UseGenericForm="true"
                          FormFields="@formFields"
                          FormSections="@formSections"
                          DataLoader="@LoadJournalEntryData"
                          AdditionalDataLoader="@LoadAdditionalDataAsync"
                          SaveHandler="@SaveJournalEntryWrapper"
                          SaveSuccessMessage="傳票儲存成功"
                          SaveFailureMessage="傳票儲存失敗"
                          RequiredPermission="JournalEntry.Read"
                          OnEntitySaved="@OnJournalEntrySaved"
                          OnCancel="@OnCancel"
                          ShowAddButton="false"
                          ShowDeleteButton="false"
                          ShowPrintButton="false"
                          CustomModules="@GetCustomModules()"
                          CustomActionButtons="@GetCustomActionButtons()"
                          FormHeaderContent="@GetFormHeaderContent()"
                          OnEntityLoaded="@HandleEntityLoaded">
</GenericEditModalComponent>

@code {
    // ===== 必要參數 =====
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int? JournalEntryId { get; set; }
    [Parameter] public EventCallback<JournalEntry> OnJournalEntrySaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    // ===== 內部狀態 =====
    private GenericEditModalComponent<JournalEntry, IJournalEntryService>? editModalComponent;
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();

    // 查閱資料
    private List<AccountItem> detailAccounts = new();
    private List<Company> companies = new();
    private bool isDataLoaded = false;

    // 分錄行管理（由 JournalEntryLineTable 管理）
    private JournalEntryLineTable? lineTableComponent;
    private List<JournalEntryLine> journalEntryLines = new();
    private int _detailsDataVersion = 0;

    // 借貸合計（由 JournalEntryLineTable 回報）
    private decimal totalDebit = 0;
    private decimal totalCredit = 0;
    private bool isBalanced => totalDebit == totalCredit && totalDebit > 0;
    private bool hasValidLines => journalEntryLines.Any();

    // 自訂按鈕狀態
    private bool isSaving = false;
    private string saveAction = "";
    private string currentUser = "System";

    private bool IsReadOnly => editModalComponent?.Entity?.JournalEntryStatus is
        JournalEntryStatus.Posted or JournalEntryStatus.Cancelled or JournalEntryStatus.Reversed;

    // ===== 資料載入 =====

    /// <summary>
    /// 載入查閱資料 - 會計科目、公司清單（由 GenericEditModalComponent 的 AdditionalDataLoader 觸發）
    /// </summary>
    private async Task LoadAdditionalDataAsync()
    {
        if (isDataLoaded) return;

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUser = authState.User.Identity?.Name ?? "System";

        detailAccounts = await AccountItemService.GetDetailAccountsAsync();
        companies = await CompanyService.GetActiveCompaniesAsync();

        isDataLoaded = true;
    }

    /// <summary>
    /// 載入傳票資料（由 GenericEditModalComponent 的 DataLoader 觸發）
    /// </summary>
    private async Task<JournalEntry?> LoadJournalEntryData()
    {
        JournalEntry? entry;

        if (JournalEntryId.HasValue)
        {
            entry = await JournalEntryService.GetWithLinesAsync(JournalEntryId.Value);
            if (entry != null)
            {
                journalEntryLines = entry.Lines.ToList();
            }
        }
        else
        {
            var now = DateTime.Now;
            var primaryCompany = await CompanyService.GetPrimaryCompanyAsync();
            entry = new JournalEntry
            {
                EntryDate = now,
                EntryType = JournalEntryType.Manual,
                JournalEntryStatus = JournalEntryStatus.Draft,
                FiscalYear = now.Year,
                FiscalPeriod = now.Month,
                CompanyId = primaryCompany?.Id ?? 0
            };
            journalEntryLines = new List<JournalEntryLine>();
            totalDebit = 0;
            totalCredit = 0;
        }

        _detailsDataVersion++;
        InitializeFormFields(entry);

        return entry;
    }

    // ===== 表單欄位初始化 =====
    private void InitializeFormFields(JournalEntry? entity)
    {
        if (entity == null)
        {
            formFields = new List<FormFieldDefinition>();
            formSections = new Dictionary<string, string>();
            return;
        }

        var isPosted = entity.JournalEntryStatus is
            JournalEntryStatus.Posted or JournalEntryStatus.Cancelled or JournalEntryStatus.Reversed;

        formFields = new List<FormFieldDefinition>
        {
            new FormFieldDefinition
            {
                PropertyName = nameof(JournalEntry.Code),
                Label = "傳票編號",
                FieldType = FormFieldType.Text,
                IsRequired = false,
                IsReadOnly = isPosted,
                Placeholder = "留空自動產生"
            },
            new FormFieldDefinition
            {
                PropertyName = nameof(JournalEntry.EntryDate),
                Label = "傳票日期",
                FieldType = FormFieldType.Date,
                IsRequired = true,
                IsReadOnly = isPosted
            },
            new FormFieldDefinition
            {
                PropertyName = nameof(JournalEntry.CompanyId),
                Label = "公司",
                FieldType = FormFieldType.Select,
                IsRequired = true,
                IsReadOnly = isPosted,
                Options = companies.Select(c => new SelectOption
                {
                    Value = c.Id.ToString(),
                    Text = c.CompanyName ?? c.Code ?? c.Id.ToString()
                }).ToList()
            },
            new FormFieldDefinition
            {
                PropertyName = nameof(JournalEntry.EntryType),
                Label = "傳票類型",
                FieldType = FormFieldType.Select,
                IsRequired = true,
                IsReadOnly = isPosted,
                Options = new List<SelectOption>
                {
                    new SelectOption { Value = ((int)JournalEntryType.Manual).ToString(), Text = "手動輸入" },
                    new SelectOption { Value = ((int)JournalEntryType.Adjusting).ToString(), Text = "調整分錄" },
                    new SelectOption { Value = ((int)JournalEntryType.Closing).ToString(), Text = "結帳分錄" },
                    new SelectOption { Value = ((int)JournalEntryType.AutoGenerated).ToString(), Text = "自動產生", IsDisabled = true },
                    new SelectOption { Value = ((int)JournalEntryType.Reversing).ToString(), Text = "沖銷分錄", IsDisabled = true }
                }
            },
            new FormFieldDefinition
            {
                PropertyName = nameof(JournalEntry.FiscalYear),
                Label = "會計年度",
                FieldType = FormFieldType.Number,
                IsRequired = true,
                IsReadOnly = isPosted,
                Min = 2000,
                Max = 2100
            },
            new FormFieldDefinition
            {
                PropertyName = nameof(JournalEntry.FiscalPeriod),
                Label = "會計期間（月）",
                FieldType = FormFieldType.Select,
                IsRequired = true,
                IsReadOnly = isPosted,
                Options = Enumerable.Range(1, 12).Select(m => new SelectOption
                {
                    Value = m.ToString(),
                    Text = $"{m} 月"
                }).ToList()
            },
            new FormFieldDefinition
            {
                PropertyName = nameof(JournalEntry.Description),
                Label = "傳票說明",
                FieldType = FormFieldType.Text,
                IsReadOnly = isPosted,
                Placeholder = "請輸入傳票說明"
            },
            new FormFieldDefinition
            {
                PropertyName = nameof(JournalEntry.Remarks),
                Label = "備注",
                FieldType = FormFieldType.TextArea,
                IsReadOnly = isPosted,
                Rows = 2,
                Placeholder = ""
            }
        };

        formSections = FormSectionHelper<JournalEntry>.Create()
            .AddToSection(FormSectionNames.BasicInfo,
                je => je.Code,
                je => je.EntryDate,
                je => je.CompanyId,
                je => je.EntryType,
                je => je.FiscalYear,
                je => je.FiscalPeriod)
            .AddToSection(FormSectionNames.OtherInfo,
                je => je.Description,
                je => je.Remarks)
            .Build();
    }

    // ===== 自訂模組 =====

    /// <summary>
    /// 配置自訂模組（分錄行表格）
    /// </summary>
    private List<GenericEditModalComponent<JournalEntry, IJournalEntryService>.CustomModule> GetCustomModules()
    {
        return CustomModuleHelper.CreateSingle(editModalComponent, CreateLineTableContent());
    }

    /// <summary>
    /// 創建分錄行表格內容的 RenderFragment
    /// </summary>
    private RenderFragment CreateLineTableContent() => __builder =>
    {
        if (editModalComponent?.Entity != null)
        {
            <JournalEntryLineTable @ref="lineTableComponent"
                                   AccountItems="@detailAccounts"
                                   ExistingLines="@journalEntryLines"
                                   DataVersion="@_detailsDataVersion"
                                   IsReadOnly="@IsReadOnly"
                                   IsParentLoading="@(editModalComponent?.IsLoading ?? false)"
                                   OnLinesChanged="@HandleLinesChanged"
                                   OnTotalsChanged="@HandleTotalsChanged" />
        }
        else
        {
            <div class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">載入中...</span>
                </div>
            </div>
        }
    };

    // ===== 自訂按鈕 =====

    /// <summary>
    /// 取得自訂操作按鈕（過帳、沖銷）
    /// </summary>
    private RenderFragment? GetCustomActionButtons() => __builder =>
    {
        var entity = editModalComponent?.Entity;
        if (entity == null) return;

        @* 來源單號顯示（自動產生的傳票） *@
        if (!string.IsNullOrWhiteSpace(entity.SourceDocumentCode))
        {
            <span class="badge bg-info me-2 fs-6">
                <i class="bi bi-link-45deg me-1"></i>來源：@entity.SourceDocumentType @entity.SourceDocumentCode
            </span>
        }

        @* 過帳按鈕（草稿狀態才顯示） *@
        if (entity.JournalEntryStatus == JournalEntryStatus.Draft)
        {
            <GenericButtonComponent Text="過帳"
                                  Variant="ButtonVariant.Green"
                                  OnClick="HandlePost"
                                  IsDisabled="@(isSaving || !isBalanced || !hasValidLines)"
                                  IsLoading="@(isSaving && saveAction == "post")" />
        }

        @* 沖銷按鈕（已過帳且未沖銷才顯示） *@
        if (entity.JournalEntryStatus == JournalEntryStatus.Posted && !entity.IsReversed)
        {
            <GenericButtonComponent Text="沖銷"
                                  Variant="ButtonVariant.Green"
                                  OnClick="HandleReverse"
                                  IsDisabled="@isSaving"
                                  IsLoading="@(isSaving && saveAction == "reverse")" />
        }
    };

    // ===== 表單頂部提示訊息 =====

    /// <summary>
    /// 取得狀態提示訊息（唯讀狀態警告）
    /// </summary>
    private RenderFragment? GetFormHeaderContent() => __builder =>
    {
        var entity = editModalComponent?.Entity;
        if (entity == null) return;

        var isReadOnly = entity.JournalEntryStatus is
            JournalEntryStatus.Posted or JournalEntryStatus.Cancelled or JournalEntryStatus.Reversed;

        if (isReadOnly)
        {
            <div class="alert alert-warning d-flex align-items-center py-2 mb-3">
                <i class="bi bi-lock-fill me-2"></i>
                <span>
                    此傳票狀態為
                    <span class="badge @GetStatusBadgeClass(entity.JournalEntryStatus) ms-1">
                        @GetStatusText(entity.JournalEntryStatus)
                    </span>，僅供檢視
                </span>
            </div>
        }
    };

    // ===== 分錄行回調（由 JournalEntryLineTable 觸發） =====

    /// <summary>
    /// 處理分錄行變更事件
    /// </summary>
    private void HandleLinesChanged(List<JournalEntryLine> lines)
    {
        journalEntryLines = lines;
    }

    /// <summary>
    /// 處理合計變更事件
    /// </summary>
    private void HandleTotalsChanged((decimal TotalDebit, decimal TotalCredit, bool IsBalanced) totals)
    {
        totalDebit = totals.TotalDebit;
        totalCredit = totals.TotalCredit;
        StateHasChanged();
    }

    /// <summary>
    /// 處理實體載入完成事件（導航時觸發）
    /// 重新載入分錄明細行
    /// </summary>
    private async Task HandleEntityLoaded(int loadedEntityId)
    {
        var entry = await JournalEntryService.GetWithLinesAsync(loadedEntityId);
        if (entry != null)
        {
            journalEntryLines = entry.Lines.ToList();
        }
        else
        {
            journalEntryLines = new List<JournalEntryLine>();
        }

        _detailsDataVersion++;

        // 重新初始化表單欄位（狀態可能因導航而改變）
        if (editModalComponent?.Entity != null)
            InitializeFormFields(editModalComponent.Entity);

        totalDebit = 0;
        totalCredit = 0;
        StateHasChanged();
    }

    // ===== 儲存處理 =====

    /// <summary>
    /// 儲存處理器 - 提供給 GenericEditModalComponent 使用（內建儲存按鈕）
    /// </summary>
    private async Task<bool> SaveJournalEntryWrapper(JournalEntry entity)
    {
        if (IsReadOnly)
        {
            await NotificationService.ShowWarningAsync("此傳票已過帳/取消/沖銷，無法修改");
            return false;
        }

        // 準備分錄行資料
        entity.Lines = journalEntryLines;
        entity.FiscalYear = entity.EntryDate.Year;
        entity.FiscalPeriod = entity.EntryDate.Month;

        var (success, error) = await JournalEntryService.SaveWithLinesAsync(entity, currentUser);
        if (!success)
        {
            await NotificationService.ShowErrorAsync($"儲存失敗：{error}");
            return false;
        }

        return true;
    }

    // ===== 自訂按鈕事件 =====

    /// <summary>
    /// 過帳處理 - 先儲存再過帳
    /// </summary>
    private async Task HandlePost()
    {
        var entity = editModalComponent?.Entity;
        if (entity == null) return;
        if (!isBalanced)
        {
            await NotificationService.ShowWarningAsync("借貸不平衡，無法過帳");
            return;
        }
        isSaving = true;
        saveAction = "post";
        try
        {
            // 先儲存
            entity.Lines = journalEntryLines;
            entity.FiscalYear = entity.EntryDate.Year;
            entity.FiscalPeriod = entity.EntryDate.Month;

            var (saveSuccess, saveError) = await JournalEntryService.SaveWithLinesAsync(entity, currentUser);
            if (!saveSuccess)
            {
                await NotificationService.ShowErrorAsync($"儲存失敗：{saveError}");
                return;
            }

            // 再過帳
            var (postSuccess, postError) = await JournalEntryService.PostEntryAsync(entity.Id, currentUser);
            if (postSuccess)
            {
                await NotificationService.ShowSuccessAsync("傳票過帳成功");
                await OnJournalEntrySaved.InvokeAsync(entity);
                await IsVisibleChanged.InvokeAsync(false);
            }
            else
            {
                await NotificationService.ShowErrorAsync($"過帳失敗：{postError}");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePost), GetType());
            await NotificationService.ShowErrorAsync("過帳時發生錯誤");
        }
        finally
        {
            isSaving = false;
            saveAction = "";
        }
    }

    /// <summary>
    /// 沖銷處理 - 建立反向傳票
    /// </summary>
    private async Task HandleReverse()
    {
        var entity = editModalComponent?.Entity;
        if (entity == null) return;
        isSaving = true;
        saveAction = "reverse";
        try
        {
            var (success, error, reversalEntry) = await JournalEntryService.ReverseEntryAsync(
                entity.Id, DateTime.Now, currentUser);

            if (success)
            {
                await NotificationService.ShowSuccessAsync($"沖銷傳票建立成功：{reversalEntry?.Code}");
                await OnJournalEntrySaved.InvokeAsync(entity);
                await IsVisibleChanged.InvokeAsync(false);
            }
            else
            {
                await NotificationService.ShowErrorAsync($"沖銷失敗：{error}");
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleReverse), GetType());
            await NotificationService.ShowErrorAsync("沖銷時發生錯誤");
        }
        finally
        {
            isSaving = false;
            saveAction = "";
        }
    }

    // ===== 顯示輔助 =====
    private string GetStatusBadgeClass(JournalEntryStatus status) => status switch
    {
        JournalEntryStatus.Draft     => "bg-secondary",
        JournalEntryStatus.Posted    => "bg-success",
        JournalEntryStatus.Cancelled => "bg-danger",
        JournalEntryStatus.Reversed  => "bg-warning text-dark",
        _                            => "bg-secondary"
    };

    private string GetStatusText(JournalEntryStatus status) => status switch
    {
        JournalEntryStatus.Draft     => "草稿",
        JournalEntryStatus.Posted    => "已過帳",
        JournalEntryStatus.Cancelled => "已取消",
        JournalEntryStatus.Reversed  => "已沖銷",
        _                            => status.ToString()
    };
}
