@* æ²–éŠ·å•†å“æ˜ç´°ç®¡ç†çµ„ä»¶ - æ”¯æ´æ‡‰æ”¶/æ‡‰ä»˜é›™æ¨¡å¼ *@

@inject ISetoffProductDetailService SetoffProductDetailService
@inject IProductService ProductService
@inject IPurchaseReceivingService PurchaseReceivingService
@inject IPurchaseReturnService PurchaseReturnService
@inject ISalesDeliveryService SalesDeliveryService
@inject ISalesReturnService SalesReturnService
@inject INotificationService NotificationService
@inject IStringLocalizer<SharedResource> L
@using ERPCore2.Components.Shared.UI

@if (!RelatedPartyId.HasValue || RelatedPartyId.Value <= 0)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <div class="warning-message">
                <i class="bi bi-exclamation-triangle text-warning fs-1 mb-3"></i>
                <p class="text-muted">@GetRelatedPartyWarningMessage()</p>
            </div>
        </div>
    </div>
}
else
{
    @* æœ¬æ¬¡æ²–æ¬¾æ˜ç´°ç·¨è¼¯ - ç›´æ¥é¡¯ç¤ºæ‰€æœ‰æœªçµæ¸…æ˜ç´° *@
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <InteractiveTableComponent TItem="SetoffProductDetailItem"
                                      OnDataChanged="@NotifyDetailsChanged"
                                      Items="@SetoffItems"
                                      ColumnDefinitions="@GetSetoffColumnDefinitions()"
                                      IsReadOnly="@IsReadOnly"
                                      ShowRowNumbers="false"
                                      EmptyMessage="@GetUnsettledEmptyMessage()"
                                      ShowBuiltInActions="@(!IsEditMode())"
                                      ShowBuiltInDeleteButton="@(!IsEditMode())"
                                      OnItemDelete="@HandleRemoveItem"
                                      ShowActions="false"
                                      ActionsColumnWidth = "60px" />
        </div>

        <div class="card-footer">
            <div class="table-action-bar">
                @* å·¦å´æŒ‰éˆ•çµ„ *@
                <div class="btn-group-left">
                    <GenericButtonComponent Text="è¼‰å…¥"
                                          Variant="ButtonVariant.DarkBlue"
                                          Size="ButtonSize.Small"
                                          OnClick="ShowLoadConfirmModal"
                                          IsDisabled="@(IsReadOnly || IsEditMode())"
                                          Title="æ ¹æ“šæ¢ä»¶è¼‰å…¥æœªçµæ¸…æ˜ç´°" />
                </div>
                
                @* å³å´æŒ‰éˆ•çµ„ *@
                <div class="btn-group-right">
                    <GenericButtonComponent Text="å…¨éƒ¨æ²–æ¬¾"
                                          Variant="ButtonVariant.Green"
                                          Size="ButtonSize.Small"
                                          OnClick="FillAllSetoffAmounts"
                                          IsDisabled="@(SetoffItems.Count == 0 || IsReadOnly || !SetoffItems.Any())" />
                    <GenericButtonComponent Text="æ²–æ¬¾æ¸…ç©º"
                                          Variant="ButtonVariant.Red"
                                          Size="ButtonSize.Small"
                                          OnClick="ClearAllSetoffAmounts"
                                          IsDisabled="@(SetoffItems.Count == 0 || IsReadOnly || !SetoffItems.Any())" />
                </div>
            </div>
        </div>
    </div>
}

<!-- è¼‰å…¥ç¢ºèª Modal -->
<GenericConfirmModalComponent IsVisible="@_showLoadConfirmModal"
                             IsVisibleChanged="@((bool visible) => _showLoadConfirmModal = visible)"
                             Title="è¼‰å…¥ç¢ºèª"
                             Icon="bi-box-arrow-in-down"
                             Message="@_loadMessage"
                             Conditions="@_loadConditions"
                             SummaryMessage="@_loadSummaryMessage"
                             ConfirmButtonVariant="ButtonVariant.Blue"
                             OnConfirm="@ExecuteLoadUnsettledDetails"
                             OnCancel="@(() => _showLoadConfirmModal = false)" />

@code {
    // ===== åƒæ•¸å®šç¾© =====
    [Parameter] public int? SetoffDocumentId { get; set; }
    [Parameter] public SetoffType SetoffType { get; set; }
    [Parameter] public int? RelatedPartyId { get; set; }
    [Parameter] public string RelatedPartyType { get; set; } = string.Empty;
    [Parameter] public DateTime? StartDate { get; set; }
    [Parameter] public DateTime? EndDate { get; set; }
    
    // è³‡æ–™ç¶å®š
    [Parameter] public List<SetoffProductDetail> ExistingDetails { get; set; } = new();
    [Parameter] public EventCallback<List<SetoffProductDetail>> OnDetailsChanged { get; set; }
    
    // é¡¯ç¤ºæ§åˆ¶
    [Parameter] public bool IsReadOnly { get; set; } = false;
    [Parameter] public bool ShowAllowance { get; set; } = true;
    
    // é¡å¤–åƒæ•¸ï¼ˆç”¨æ–¼é¡¯ç¤ºç¢ºèªè¨Šæ¯ï¼‰
    [Parameter] public string? RelatedPartyName { get; set; }
    
    // è½‰å–®ç¯©é¸åƒæ•¸ï¼ˆç”¨æ–¼é€²è²¨è½‰æ²–æ¬¾ç­‰å ´æ™¯ï¼‰
    [Parameter] public int? FilterPurchaseReceivingId { get; set; }
    
    // æ–¹æ¡ˆ D æ”¹è‰¯ç‰ˆï¼šè³‡æ–™ç‰ˆæœ¬è¿½è¹¤
    [Parameter] public int DataVersion { get; set; } = 0;
    
    // ä¿®æ­£ï¼šçˆ¶å…ƒä»¶è¼‰å…¥ä¸­æ¨™è¨˜
    [Parameter] public bool IsParentLoading { get; set; } = false;
    
    // ===== å…§éƒ¨ç‹€æ…‹ =====
    private List<UnsettledDetailDto> UnsettledDetails { get; set; } = new();
    private List<SetoffProductDetailItem> SetoffItems { get; set; } = new();
    private List<Product> Products { get; set; } = new();
    
    // ===== è¼‰å…¥ç¢ºèª Modal =====
    private bool _showLoadConfirmModal = false;
    private string _loadMessage = string.Empty;
    private List<string> _loadConditions = new();
    private string _loadSummaryMessage = string.Empty;
    private bool _dataLoaded = false;

    // æ–¹æ¡ˆ Dï¼šè¿½è¹¤ ExistingDetails åƒæ•¸è®ŠåŒ–
    private List<SetoffProductDetail>? _previousExistingDetails = null;
    
    // æ–¹æ¡ˆ D æ”¹è‰¯ç‰ˆï¼šè³‡æ–™ç‰ˆæœ¬è¿½è¹¤
    private int _previousDataVersion = 0;
    private bool _isLoadingDetails = false;

    // ===== ç”Ÿå‘½é€±æœŸæ–¹æ³• =====
    protected override async Task OnInitializedAsync()
    {
        // ä¿®æ­£ï¼šçˆ¶å…ƒä»¶è¼‰å…¥ä¸­æ™‚ä¸åŸ·è¡Œåˆå§‹åŒ–
        // ğŸ”¥ é‡è¦ï¼šæ­¤æ™‚ä¸è¨­å®š _previousDataVersionï¼Œè®“ OnParametersSetAsync èƒ½å¤ åµæ¸¬åˆ°è®ŠåŒ–
        if (IsParentLoading) { return; }
        
        // åªæœ‰åœ¨æˆåŠŸè¼‰å…¥å¾Œæ‰è¨­å®šè¿½è¹¤è®Šæ•¸
        _previousDataVersion = DataVersion;
        _previousExistingDetails = ExistingDetails;
        
        await LoadProductsAsync();
        
        // ç·¨è¼¯æ¨¡å¼ä¸‹éœ€è¦è¼‰å…¥æœªçµæ¸…æ˜ç´°ï¼ˆç”¨æ–¼é¡¯ç¤ºä¾†æºè³‡è¨Šï¼‰
        if (IsEditMode())
        {
            await LoadUnsettledDetailsAsync();
            LoadExistingDetails();
            _dataLoaded = true;
        }
        // æ–°å¢æ¨¡å¼ä¸‹ä¸è‡ªå‹•è¼‰å…¥ï¼Œç­‰å¾…ä½¿ç”¨è€…é»æ“Šã€Œè¼‰å…¥ã€æŒ‰éˆ•
    }

    private int? _lastRelatedPartyId;
    private DateTime? _lastStartDate;
    private DateTime? _lastEndDate;
    
    protected override async Task OnParametersSetAsync()
    {
        // é˜²æ­¢é‡å…¥
        if (_isLoadingDetails) { return; }
        
        // æ–¹æ¡ˆ D æ”¹è‰¯ç‰ˆï¼šå„ªå…ˆæª¢æŸ¥ DataVersion
        bool versionChanged = DataVersion != _previousDataVersion;
        
        if (versionChanged)
        {
            // åŒæ™‚æ›´æ–°æ‰€æœ‰è¿½è¹¤è®Šæ•¸
            _previousDataVersion = DataVersion;
            _previousExistingDetails = ExistingDetails;
            _lastRelatedPartyId = RelatedPartyId;
            _lastStartDate = StartDate;
            _lastEndDate = EndDate;
            
            _isLoadingDetails = true;
            try
            {
                // é‡æ–°è¼‰å…¥è³‡æ–™
                if (IsEditMode())
                {
                    await LoadUnsettledDetailsAsync();
                    LoadExistingDetails();
                    _dataLoaded = true;
                }
            }
            finally
            {
                _isLoadingDetails = false;
            }
            return;
        }
        
        // æ–¹æ¡ˆ Dï¼šåµæ¸¬ ExistingDetails æ˜¯å¦è¢«çˆ¶å…ƒä»¶é‡æ–°è³¦å€¼
        if (!ReferenceEquals(ExistingDetails, _previousExistingDetails))
        {
            _previousExistingDetails = ExistingDetails;
            if (IsEditMode())
            {
                await LoadUnsettledDetailsAsync();
                LoadExistingDetails();
                _dataLoaded = true;
            }
        }
        
        // æª¢æŸ¥é—œè¯æ–¹æ˜¯å¦è®Šæ›´
        bool relatedPartyChanged = _lastRelatedPartyId != RelatedPartyId;
        
        if (relatedPartyChanged)
        {
            _lastRelatedPartyId = RelatedPartyId;
            
            // é—œè¯æ–¹è®Šæ›´æ™‚æ¸…ç©ºè³‡æ–™ï¼Œç­‰å¾…ä½¿ç”¨è€…é‡æ–°è¼‰å…¥
            if (!IsEditMode())
            {
                SetoffItems = new List<SetoffProductDetailItem>();
                UnsettledDetails = new List<UnsettledDetailDto>();
                _dataLoaded = false;
            }
            else
            {
                // ç·¨è¼¯æ¨¡å¼éœ€è¦é‡æ–°è¼‰å…¥
                await LoadUnsettledDetailsAsync();
                LoadExistingDetails();
                _dataLoaded = true;
            }
        }
        
        // æ—¥æœŸç¯©é¸è®Šæ›´æ™‚ï¼Œåªæ¨™è¨˜éœ€è¦é‡æ–°è¼‰å…¥ï¼ˆå¦‚æœå·²ç¶“è¼‰å…¥éçš„è©±ï¼‰
        bool dateFilterChanged = _lastStartDate != StartDate || _lastEndDate != EndDate;
        if (dateFilterChanged)
        {
            _lastStartDate = StartDate;
            _lastEndDate = EndDate;
            
            // å¦‚æœå·²è¼‰å…¥ä¸”æ—¥æœŸè®Šæ›´ï¼Œéœ€è¦é‡æ–°è¼‰å…¥
            if (_dataLoaded && !IsEditMode())
            {
                // é‡æ–°å¥—ç”¨æ—¥æœŸç¯©é¸
                LoadExistingDetails();
            }
        }
        
        await base.OnParametersSetAsync();
    }

    // ===== è³‡æ–™è¼‰å…¥æ–¹æ³• =====
    private async Task LoadProductsAsync()
    {
        try
        {
            Products = await ProductService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥å•†å“è³‡æ–™å¤±æ•—ï¼š{ex.Message}");
            Products = new List<Product>();
        }
    }

    private async Task LoadUnsettledDetailsAsync()
    {
        if (!RelatedPartyId.HasValue || RelatedPartyId.Value <= 0)
        {
            UnsettledDetails = new List<UnsettledDetailDto>();
            return;
        }

        try
        {
            UnsettledDetails = SetoffType == SetoffType.AccountsReceivable
                ? await SetoffProductDetailService.GetUnsettledReceivableDetailsAsync(RelatedPartyId.Value)
                : await SetoffProductDetailService.GetUnsettledPayableDetailsAsync(RelatedPartyId.Value);
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥æœªçµæ¸…æ˜ç´°å¤±æ•—ï¼š{ex.Message}");
            UnsettledDetails = new List<UnsettledDetailDto>();
        }
    }

    private void LoadExistingDetails()
    {
        // åˆ¤æ–·æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼ï¼ˆSetoffDocumentId æœ‰å€¼ä¸”å¤§æ–¼ 0ï¼‰
        bool isEditMode = SetoffDocumentId.HasValue && SetoffDocumentId.Value > 0;
        
        // å¦‚æœæœ‰å·²å­˜åœ¨çš„æ˜ç´°ï¼ˆç·¨è¼¯æ¨¡å¼ï¼‰ï¼Œå‰‡é¡¯ç¤ºå·²å­˜åœ¨çš„æ˜ç´°
        if (ExistingDetails.Any())
        {
            SetoffItems = ExistingDetails.Select(detail =>
            {
                // å˜—è©¦å¾æœªçµæ¸…æ˜ç´°ä¸­æ‰¾åˆ°å°æ‡‰çš„ä¾†æºæ˜ç´°è³‡è¨Š
                var unsettledDetail = UnsettledDetails.FirstOrDefault(u => 
                    u.SourceDetailType == detail.SourceDetailType && 
                    u.SourceDetailId == detail.SourceDetailId);
                
                return new SetoffProductDetailItem
                {
                    SourceDetailType = detail.SourceDetailType,
                    SourceDetailId = detail.SourceDetailId,
                    ProductId = detail.ProductId,
                    Product = Products.FirstOrDefault(p => p.Id == detail.ProductId),
                    CurrentSetoffAmount = detail.CurrentSetoffAmount,
                    CurrentAllowanceAmount = detail.CurrentAllowanceAmount,
                    Remarks = detail.Remarks,
                    ExistingDetail = detail,
                    UnsettledDetail = unsettledDetail, // ä¿ç•™æœªçµæ¸…æ˜ç´°è³‡è¨Šä»¥é¡¯ç¤ºä¾†æºå–®è™Ÿç­‰è³‡æ–™
                    NeedsSourceDetailLoad = unsettledDetail == null // æ¨™è¨˜éœ€è¦é¡å¤–è¼‰å…¥ä¾†æºæ˜ç´°
                };
            }).ToList();
            
            // å°æ–¼éœ€è¦è¼‰å…¥ä¾†æºæ˜ç´°çš„é …ç›®ï¼ŒéåŒæ­¥è¼‰å…¥
            _ = LoadMissingSourceDetailsAsync();
        }
        else if (!isEditMode)
        {
            // æ–°å¢æ¨¡å¼ï¼šå°‡æ‰€æœ‰æœªçµæ¸…æ˜ç´°è½‰æ›ç‚º SetoffItemsï¼Œé è¨­æœ¬æ¬¡æ²–æ¬¾å’ŒæŠ˜è®“ç‚º0
            SetoffItems = UnsettledDetails
                .Where(d => !StartDate.HasValue || d.DocumentDate >= StartDate.Value)
                .Where(d => !EndDate.HasValue || d.DocumentDate <= EndDate.Value)
                .Select(detail => new SetoffProductDetailItem
                {
                    SourceDetailType = detail.SourceDetailType,
                    SourceDetailId = detail.SourceDetailId,
                    ProductId = detail.ProductId,
                    Product = Products.FirstOrDefault(p => p.Id == detail.ProductId),
                    CurrentSetoffAmount = 0, // é è¨­ç‚º0
                    CurrentAllowanceAmount = 0, // é è¨­ç‚º0
                    Remarks = null,
                    ExistingDetail = null,
                    UnsettledDetail = detail, // ä¿ç•™æœªçµæ¸…æ˜ç´°è³‡è¨Š
                    NeedsSourceDetailLoad = false
                }).ToList();
        }
        else
        {
            // ç·¨è¼¯æ¨¡å¼ä½†æ²’æœ‰ä»»ä½•å·²å„²å­˜çš„å•†å“æ˜ç´°ï¼šé¡¯ç¤ºç©ºåˆ—è¡¨
            SetoffItems = new List<SetoffProductDetailItem>();
        }
    }
    
    /// <summary>
    /// è¼‰å…¥ç¼ºå°‘çš„ä¾†æºæ˜ç´°è³‡è¨Šï¼ˆé‡å°å·²çµæ¸…çš„æ˜ç´°ï¼‰
    /// </summary>
    private async Task LoadMissingSourceDetailsAsync()
    {
        var itemsNeedingLoad = SetoffItems.Where(i => i.NeedsSourceDetailLoad).ToList();
        
        foreach (var item in itemsNeedingLoad)
        {
            try
            {
                var sourceDetail = await SetoffProductDetailService.GetSourceDetailInfoAsync(
                    item.SourceDetailType, 
                    item.SourceDetailId);
                
                if (sourceDetail != null)
                {
                    item.UnsettledDetail = sourceDetail;
                    item.NeedsSourceDetailLoad = false;
                }
            }
            catch (Exception ex)
            {
                await NotificationService.ShowErrorAsync($"è¼‰å…¥ä¾†æºæ˜ç´°å¤±æ•—ï¼š{ex.Message}");
            }
        }
        
        // å¼·åˆ¶é‡æ–°æ¸²æŸ“ä»¥é¡¯ç¤ºè¼‰å…¥çš„è³‡æ–™
        StateHasChanged();
    }

    // ===== è¼‰å…¥ç¢ºèª Modal ç›¸é—œæ–¹æ³• =====
    
    /// <summary>
    /// é¡¯ç¤ºè¼‰å…¥ç¢ºèª Modal - æ”¶é›†è¼‰å…¥æ¢ä»¶ä¸¦é¡¯ç¤ºçµ¦ä½¿ç”¨è€…ç¢ºèª
    /// </summary>
    private async Task ShowLoadConfirmModal()
    {
        try
        {
            // æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡é—œè¯æ–¹
            if (!RelatedPartyId.HasValue || RelatedPartyId.Value <= 0)
            {
                var partyTypeName = SetoffType == SetoffType.AccountsReceivable ? "å®¢æˆ¶" : "å» å•†";
                await NotificationService.ShowWarningAsync($"è«‹å…ˆé¸æ“‡{partyTypeName}");
                return;
            }
            
            // å»ºç«‹è¼‰å…¥æ¢ä»¶æ¸…å–®
            _loadConditions = new List<string>();
            
            // æ¢ä»¶1ï¼šé—œè¯æ–¹ï¼ˆå®¢æˆ¶/å» å•†ï¼‰
            var partyName = SetoffType == SetoffType.AccountsReceivable ? "å®¢æˆ¶" : "å» å•†";
            var partyDisplayName = !string.IsNullOrWhiteSpace(RelatedPartyName)
                ? RelatedPartyName
                : $"{partyName} ID: {RelatedPartyId.Value}";
            _loadConditions.Add($"{partyName}ï¼š{partyDisplayName}");
            
            // æ¢ä»¶2ï¼šæ—¥æœŸç¯©é¸ï¼ˆå¦‚æœ‰é¸æ“‡ï¼‰
            if (StartDate.HasValue && EndDate.HasValue)
            {
                _loadConditions.Add($"æ—¥æœŸç¯„åœï¼š{StartDate.Value:yyyy/MM/dd} ~ {EndDate.Value:yyyy/MM/dd}");
            }
            else if (StartDate.HasValue)
            {
                _loadConditions.Add($"èµ·å§‹æ—¥æœŸï¼š{StartDate.Value:yyyy/MM/dd} ä¹‹å¾Œ");
            }
            else if (EndDate.HasValue)
            {
                _loadConditions.Add($"çµæŸæ—¥æœŸï¼š{EndDate.Value:yyyy/MM/dd} ä¹‹å‰");
            }
            else
            {
                _loadConditions.Add("æ—¥æœŸç¯„åœï¼šå…¨éƒ¨");
            }
            
            // è¨ˆç®—ç¬¦åˆæ¢ä»¶çš„æ˜ç´°æ•¸é‡
            int matchingCount = await GetMatchingUnsettledCountAsync();
            
            if (matchingCount == 0)
            {
                await NotificationService.ShowInfoAsync("ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æœªçµæ¸…æ˜ç´°");
                return;
            }
            
            // è¨­å®š Modal è¨Šæ¯
            var docType = SetoffType == SetoffType.AccountsReceivable ? "æ‡‰æ”¶å¸³æ¬¾" : "æ‡‰ä»˜å¸³æ¬¾";
            _loadMessage = $"å³å°‡è¼‰å…¥ä»¥ä¸‹æ¢ä»¶çš„æœªçµæ¸…{docType}æ˜ç´°ï¼š";
            _loadSummaryMessage = $"å…± {matchingCount} ç­†ï¼Œæ˜¯å¦ç¢ºå®šè¼‰å…¥ï¼Ÿ";
            
            // é¡¯ç¤ºç¢ºèª Modal
            _showLoadConfirmModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æº–å‚™è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }
    
    /// <summary>
    /// å–å¾—ç¬¦åˆæ¢ä»¶çš„æœªçµæ¸…æ˜ç´°æ•¸é‡
    /// </summary>
    private async Task<int> GetMatchingUnsettledCountAsync()
    {
        try
        {
            if (!RelatedPartyId.HasValue || RelatedPartyId.Value <= 0)
                return 0;
            
            // è¼‰å…¥æœªçµæ¸…æ˜ç´°
            var unsettledDetails = SetoffType == SetoffType.AccountsReceivable
                ? await SetoffProductDetailService.GetUnsettledReceivableDetailsAsync(RelatedPartyId.Value)
                : await SetoffProductDetailService.GetUnsettledPayableDetailsAsync(RelatedPartyId.Value);
            
            // å¥—ç”¨æ—¥æœŸç¯©é¸
            var filteredDetails = unsettledDetails
                .Where(d => !StartDate.HasValue || d.DocumentDate >= StartDate.Value)
                .Where(d => !EndDate.HasValue || d.DocumentDate <= EndDate.Value);
            
            return filteredDetails.Count();
        }
        catch
        {
            return 0;
        }
    }
    
    /// <summary>
    /// åŸ·è¡Œè¼‰å…¥æœªçµæ¸…æ˜ç´° - ä½¿ç”¨è€…ç¢ºèªå¾ŒåŸ·è¡Œ
    /// </summary>
    private async Task ExecuteLoadUnsettledDetails()
    {
        try
        {
            // é—œé–‰ç¢ºèª Modal
            _showLoadConfirmModal = false;
            
            // æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡é—œè¯æ–¹
            if (!RelatedPartyId.HasValue || RelatedPartyId.Value <= 0)
            {
                return;
            }
            
            // è¼‰å…¥æœªçµæ¸…æ˜ç´°
            await LoadUnsettledDetailsAsync();
            
            // è½‰æ›ç‚º SetoffItems
            LoadExistingDetails();
            
            // æ¨™è¨˜å·²è¼‰å…¥
            _dataLoaded = true;
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            var loadedCount = SetoffItems.Count;
            if (loadedCount > 0)
            {
                await NotificationService.ShowSuccessAsync($"å·²è¼‰å…¥ {loadedCount} ç­†æœªçµæ¸…æ˜ç´°", "è¼‰å…¥å®Œæˆ");
            }
            else
            {
                await NotificationService.ShowInfoAsync("æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æœªçµæ¸…æ˜ç´°", "æç¤º");
            }
            
            // é€šçŸ¥çˆ¶çµ„ä»¶è³‡æ–™å·²è®Šæ›´
            await NotifyDetailsChanged();
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥æœªçµæ¸…æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }

    // ===== UI è¼”åŠ©æ–¹æ³• =====
    private string GetRelatedPartyWarningMessage()
    {
        return SetoffType == SetoffType.AccountsReceivable
            ? "è«‹å…ˆé¸æ“‡å®¢æˆ¶æ‰èƒ½ç®¡ç†æ‡‰æ”¶æ²–æ¬¾æ˜ç´°"
            : "è«‹å…ˆé¸æ“‡å» å•†æ‰èƒ½ç®¡ç†æ‡‰ä»˜æ²–æ¬¾æ˜ç´°";
    }

    private string GetUnsettledEmptyMessage()
    {
        // å€åˆ†ã€Œå°šæœªè¼‰å…¥ã€å’Œã€Œè¼‰å…¥å¾Œç„¡è³‡æ–™ã€å…©ç¨®ç‹€æ…‹
        if (!_dataLoaded && !IsEditMode())
        {
            // å°šæœªè¼‰å…¥ï¼šæç¤ºç”¨æˆ¶é»æ“Šè¼‰å…¥æŒ‰éˆ•
            return "è«‹é»æ“Šã€Œè¼‰å…¥ã€æŒ‰éˆ•ä»¥è¼‰å…¥æœªçµæ¸…æ˜ç´°";
        }
        
        // è¼‰å…¥å¾Œç„¡è³‡æ–™ï¼šé¡¯ç¤ºå¯¦éš›çš„ç©ºè³‡æ–™è¨Šæ¯
        return SetoffType == SetoffType.AccountsReceivable
            ? "è©²å®¢æˆ¶æ²’æœ‰æœªçµæ¸…çš„æ‡‰æ”¶å¸³æ¬¾"
            : "è©²å» å•†æ²’æœ‰æœªçµæ¸…çš„æ‡‰ä»˜å¸³æ¬¾";
    }

    // ===== InteractiveTable æ¬„ä½å®šç¾© =====
    private List<InteractiveColumnDefinition> GetSetoffColumnDefinitions()
    {
        var columns = new List<InteractiveColumnDefinition>
        {
            new()
            {
                Title = L["Column.SourceDocNumber"],
                Tooltip = "åŸå§‹éŠ·å”®æˆ–é€²è²¨å–®æ“šçš„å–®è™Ÿ",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "150px",
                CustomTemplate = item =>
                {
                    var setoffItem = (SetoffProductDetailItem)item;
                    return @<div class="text-start">@setoffItem.UnsettledDetail?.SourceDocumentNumber</div>;
                }
            },
            new()
            {
                Title = L["Column.ProductCodeName"],
                Tooltip = "é¡¯ç¤ºå•†å“çš„ç·¨è™Ÿèˆ‡åç¨±",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "200px",
                CustomTemplate = item =>
                {
                    var setoffItem = (SetoffProductDetailItem)item;
                    return @<div>@setoffItem.Product?.Code @setoffItem.Product?.Name</div>;
                }
            },
            new()
            {
                Title = L["Column.ReceivablePayable"],
                Tooltip = "ä¾†æºå–®æ“šçš„åŸå§‹æ‡‰æ”¶æˆ–æ‡‰ä»˜é‡‘é¡ï¼ˆé€€è²¨å–®é¡¯ç¤ºç‚ºè² æ•¸ï¼‰",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "150px",
                CustomTemplate = item =>
                {
                    var setoffItem = (SetoffProductDetailItem)item;
                    var detail = setoffItem.UnsettledDetail;
                    var cssClass = detail?.IsReturn == true ? "text-danger" : "text-success";
                    var amount = detail?.TotalAmount ?? 0;
                    var displayAmount = detail?.IsReturn == true ? -amount : amount;
                    var formattedValue = NumberFormatHelper.FormatSmart(displayAmount);
                    return @<div class="text-end fw-bold @cssClass">@formattedValue</div>;
                }
            },
            new()
            {
                Title = L["Column.UnsetoffBalance"],
                Tooltip = "å°šæœªæ²–éŠ·çš„é¤˜é¡é‡‘é¡ï¼ˆç·¨è¼¯æ¨¡å¼ä¸‹æœƒå‹•æ…‹èª¿æ•´ï¼‰",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "150px",
                CustomTemplate = item =>
                {
                    var setoffItem = (SetoffProductDetailItem)item;
                    var detail = setoffItem.UnsettledDetail;
                    var baseRemainingAmount = detail?.RemainingAmount ?? 0;
                    
                    // ä½¿ç”¨ AdjustedBalanceHelper è¨ˆç®—å‹•æ…‹èª¿æ•´å¾Œçš„æœªæ²–æ¬¾é¤˜é¡
                    var originalTotalUsed = 0m;
                    var currentOtherFieldsUsed = 0m;
                    
                    if (IsEditMode() && setoffItem.ExistingDetail != null)
                    {
                        // ç·¨è¼¯æ¨¡å¼ï¼šåŸæœ‰çš„ç¸½ä½¿ç”¨é‡‘é¡ï¼ˆæ²–æ¬¾ + æŠ˜è®“ï¼‰
                        originalTotalUsed = setoffItem.ExistingDetail.CurrentSetoffAmount + 
                                          setoffItem.ExistingDetail.CurrentAllowanceAmount;
                    }
                    
                    // ç„¡è«–æ–°å¢æˆ–ç·¨è¼¯æ¨¡å¼ï¼Œéƒ½è¨ˆç®—ç•¶å‰ä½¿ç”¨é‡‘é¡ä»¥å‹•æ…‹é¡¯ç¤ºæœªæ²–æ¬¾é¤˜é¡
                    currentOtherFieldsUsed = setoffItem.CurrentSetoffAmount + 
                                            setoffItem.CurrentAllowanceAmount;
                    
                    var adjustedRemainingAmount = AdjustedBalanceHelper.CalculateAdjustedBalance(
                        baseRemainingAmount,
                        originalTotalUsed,
                        currentOtherFieldsUsed,
                        IsEditMode());
                    
                    var displayAmount = detail?.IsReturn == true ? -adjustedRemainingAmount : adjustedRemainingAmount;
                    var cssClass = adjustedRemainingAmount > 0 ? "text-warning fw-bold" : 
                                   adjustedRemainingAmount < 0 ? "text-danger fw-bold" : "text-muted";
                    var formattedValue = NumberFormatHelper.FormatSmart(displayAmount);
                    return @<div class="text-end @cssClass">@formattedValue</div>;
                }
            },
            new()
            {
                Title = L["Column.CurrentSetoff"],
                Tooltip = "æœ¬æ¬¡è¦æ²–éŠ·çš„é‡‘é¡ï¼ˆä¸å¯è¶…éæœªæ²–æ¬¾é¤˜é¡ï¼‰ğŸ’¡ é›™æ“Šå¯å¿«é€Ÿå¡«å…¥æœªæ²–æ¬¾é¤˜é¡",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = ShowAllowance ? "150px" : "200px",
                CustomTemplate = item =>
                {
                    var setoffItem = (SetoffProductDetailItem)item;
                    var isReturn = setoffItem.UnsettledDetail?.IsReturn == true;
                    // ä½¿ç”¨åƒåˆ†ä½æ ¼å¼åŒ–é¡¯ç¤ºï¼ˆé€€è²¨é¡¯ç¤ºè² æ•¸ï¼‰
                    var amount = setoffItem.CurrentSetoffAmount;
                    var displayAmount = isReturn ? -amount : amount;
                    var displayValue = amount == 0 ? "" : NumberFormatHelper.FormatSmart(displayAmount);
                    return @<input type="text"
                                  class="form-control text-end"
                                  inputmode="decimal"
                                  value="@displayValue"
                                  placeholder=""
                                  @oninput="@(e => OnSetoffAmountInput(setoffItem, e.Value?.ToString()))"
                                  @ondblclick="@(async () => await OnSetoffAmountDoubleClick(setoffItem))"
                                  readonly="@IsReadOnly" />;
                }
            }
        };

        if (ShowAllowance)
        {
            columns.Add(new InteractiveColumnDefinition
            {
                Title = L["Column.CurrentAllowance"],
                Tooltip = "æœ¬æ¬¡çµ¦äºˆçš„æŠ˜è®“é‡‘é¡ï¼ˆä¸è¨ˆå…¥å¯¦éš›æ”¶ä»˜æ¬¾ï¼‰ğŸ’¡ é›™æ“Šå¯å¿«é€Ÿå¡«å…¥æœªæ²–æ¬¾é¤˜é¡",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "150px",
                CustomTemplate = item =>
                {
                    var setoffItem = (SetoffProductDetailItem)item;
                    var isReturn = setoffItem.UnsettledDetail?.IsReturn == true;
                    // ä½¿ç”¨åƒåˆ†ä½æ ¼å¼åŒ–é¡¯ç¤ºï¼ˆé€€è²¨é¡¯ç¤ºè² æ•¸ï¼‰
                    var amount = setoffItem.CurrentAllowanceAmount;
                    var displayAmount = isReturn ? -amount : amount;
                    var displayValue = amount == 0 ? "" : NumberFormatHelper.FormatSmart(displayAmount);
                    return @<input type="text"
                                  class="form-control text-end"
                                  inputmode="decimal"
                                  value="@displayValue"
                                  placeholder=""
                                  @oninput="@(e => OnAllowanceAmountInput(setoffItem, e.Value?.ToString()))"
                                  @ondblclick="@(async () => await OnAllowanceAmountDoubleClick(setoffItem))"
                                  readonly="@IsReadOnly" />;
                }
            });
        }

        columns.Add(new InteractiveColumnDefinition
        {
            Title = L["Column.Subtotal"],
            Tooltip = "æœ¬æ¬¡æ²–æ¬¾ + æœ¬æ¬¡æŠ˜è®“çš„ç¸½è¨ˆé‡‘é¡",
            PropertyName = "",
            ColumnType = InteractiveColumnType.Custom,
            Width = "150px",
            CustomTemplate = item =>
            {
                var setoffItem = (SetoffProductDetailItem)item;
                var subtotal = setoffItem.CurrentSetoffAmount + setoffItem.CurrentAllowanceAmount;
                // å¦‚æœæ˜¯é€€è²¨å–®æ“šï¼Œå°è¨ˆéœ€è¦é¡¯ç¤ºç‚ºè² æ•¸
                var isReturn = setoffItem.UnsettledDetail?.IsReturn == true;
                var displaySubtotal = isReturn ? -subtotal : subtotal;
                var displayValue = NumberFormatHelper.FormatSmartZeroAsEmpty(displaySubtotal);
                // æ ¹æ“šæ­£è² æ•¸æ±ºå®šé¡è‰²ï¼šæ­£æ•¸ç‚ºç¶ è‰²ï¼Œè² æ•¸ç‚ºç´…è‰²
                var cssClass = displaySubtotal >= 0 ? "text-success" : "text-danger";
                return @<div class="text-end fw-bold @cssClass">@displayValue</div>;
            }
        });

        columns.Add(new InteractiveColumnDefinition
        {
            Title = L["Label.Remarks"],
            Tooltip = "å‚™è¨»èªªæ˜",
            PropertyName = nameof(SetoffProductDetailItem.Remarks),
            ColumnType = InteractiveColumnType.Input,
            Width = "200px",
            IsRequired = false,
            OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
            {
                var (itemObj, value) = args;
                var item = (SetoffProductDetailItem)itemObj;
                item.Remarks = value;
                await NotifyDetailsChanged();
            })
        });

        return columns;
    }


    // ===== äº‹ä»¶è™•ç†æ–¹æ³• =====
    private async Task OnSetoffAmountInput(SetoffProductDetailItem item, string? value)
    {
        var amount = InputEventHelper.HandlePriceInput(value);
        // å°‡è¼¸å…¥çš„é‡‘é¡è½‰ç‚ºçµ•å°å€¼å„²å­˜ï¼ˆç„¡è«–ç”¨æˆ¶è¼¸å…¥æ­£æ•¸æˆ–è² æ•¸ï¼‰
        item.CurrentSetoffAmount = Math.Abs(amount);
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// é›™æ“Šæœ¬æ¬¡æ²–æ¬¾è¼¸å…¥æ¡†æ™‚ï¼Œè‡ªå‹•å¡«å…¥æœªæ²–æ¬¾é¤˜é¡
    /// </summary>
    private async Task OnSetoffAmountDoubleClick(SetoffProductDetailItem item)
    {
        // å¦‚æœæ˜¯å”¯è®€æ¨¡å¼ï¼Œä¸åŸ·è¡Œä»»ä½•æ“ä½œ
        if (IsReadOnly) return;

        try
        {
            var detail = item.UnsettledDetail;
            if (detail == null) return;

            var baseRemainingAmount = detail.RemainingAmount;
            
            // ä½¿ç”¨ AdjustedBalanceHelper è¨ˆç®—å¯å¡«å…¥çš„æœ€å¤§é‡‘é¡
            var originalTotalUsed = 0m;
            var otherFieldsUsed = item.CurrentAllowanceAmount; // æœ¬æ¬¡æŠ˜è®“
            
            if (IsEditMode() && item.ExistingDetail != null)
            {
                // åŸæœ‰çš„ç¸½ä½¿ç”¨é‡‘é¡ï¼ˆæ²–æ¬¾ + æŠ˜è®“ï¼‰
                originalTotalUsed = item.ExistingDetail.CurrentSetoffAmount + 
                                  item.ExistingDetail.CurrentAllowanceAmount;
            }
            
            var maxFillableAmount = AdjustedBalanceHelper.GetMaxFillableAmount(
                baseRemainingAmount,
                originalTotalUsed,
                otherFieldsUsed,
                IsEditMode());
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å¯å¡«å…¥çš„é‡‘é¡
            if (maxFillableAmount <= 0)
            {
                await NotificationService.ShowInfoAsync("æ²’æœ‰å¯å¡«å…¥çš„æœªæ²–æ¬¾é¤˜é¡", "æç¤º");
                return;
            }
            
            // å¡«å…¥é‡‘é¡ï¼ˆçµ•å°å€¼ï¼‰
            item.CurrentSetoffAmount = Math.Abs(maxFillableAmount);
            await NotifyDetailsChanged();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å¡«å…¥é‡‘é¡å¤±æ•—ï¼š{ex.Message}", "éŒ¯èª¤");
        }
    }

    private async Task OnAllowanceAmountInput(SetoffProductDetailItem item, string? value)
    {
        var amount = InputEventHelper.HandlePriceInput(value);
        // å°‡è¼¸å…¥çš„é‡‘é¡è½‰ç‚ºçµ•å°å€¼å„²å­˜ï¼ˆç„¡è«–ç”¨æˆ¶è¼¸å…¥æ­£æ•¸æˆ–è² æ•¸ï¼‰
        item.CurrentAllowanceAmount = Math.Abs(amount);
        await NotifyDetailsChanged();
    }

    /// <summary>
    /// é›™æ“Šæœ¬æ¬¡æŠ˜è®“è¼¸å…¥æ¡†æ™‚ï¼Œè‡ªå‹•å¡«å…¥æœªæ²–æ¬¾é¤˜é¡
    /// </summary>
    private async Task OnAllowanceAmountDoubleClick(SetoffProductDetailItem item)
    {
        // å¦‚æœæ˜¯å”¯è®€æ¨¡å¼ï¼Œä¸åŸ·è¡Œä»»ä½•æ“ä½œ
        if (IsReadOnly) return;

        try
        {
            var detail = item.UnsettledDetail;
            if (detail == null) return;

            var baseRemainingAmount = detail.RemainingAmount;
            
            // ä½¿ç”¨ AdjustedBalanceHelper è¨ˆç®—å¯å¡«å…¥çš„æœ€å¤§é‡‘é¡
            var originalTotalUsed = 0m;
            var otherFieldsUsed = item.CurrentSetoffAmount; // æœ¬æ¬¡æ²–æ¬¾
            
            if (IsEditMode() && item.ExistingDetail != null)
            {
                // åŸæœ‰çš„ç¸½ä½¿ç”¨é‡‘é¡ï¼ˆæ²–æ¬¾ + æŠ˜è®“ï¼‰
                originalTotalUsed = item.ExistingDetail.CurrentSetoffAmount + 
                                  item.ExistingDetail.CurrentAllowanceAmount;
            }
            
            var maxFillableAmount = AdjustedBalanceHelper.GetMaxFillableAmount(
                baseRemainingAmount,
                originalTotalUsed,
                otherFieldsUsed,
                IsEditMode());
            
            // æª¢æŸ¥æ˜¯å¦æœ‰å¯å¡«å…¥çš„é‡‘é¡
            if (maxFillableAmount <= 0)
            {
                await NotificationService.ShowInfoAsync("æ²’æœ‰å¯å¡«å…¥çš„æœªæ²–æ¬¾é¤˜é¡", "æç¤º");
                return;
            }
            
            // å¡«å…¥é‡‘é¡ï¼ˆçµ•å°å€¼ï¼‰
            item.CurrentAllowanceAmount = Math.Abs(maxFillableAmount);
            await NotifyDetailsChanged();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å¡«å…¥é‡‘é¡å¤±æ•—ï¼š{ex.Message}", "éŒ¯èª¤");
        }
    }

    /// <summary>
    /// å…¨éƒ¨æ²–æ¬¾ - å°‡æ‰€æœ‰æœªçµæ¸…é …ç›®çš„æœ¬æ¬¡æ²–æ¬¾å¡«æ»¿è‡³æœªæ²–æ¬¾é¤˜é¡
    /// </summary>
    private async Task FillAllSetoffAmounts()
    {
        if (IsReadOnly) return;

        try
        {
            int filledCount = 0;
            
            foreach (var item in SetoffItems)
            {
                if (item.UnsettledDetail != null)
                {
                    var baseRemainingAmount = item.UnsettledDetail.RemainingAmount;
                    
                    // ä½¿ç”¨ AdjustedBalanceHelper è¨ˆç®—å¯å¡«å…¥çš„æœ€å¤§é‡‘é¡
                    var originalTotalUsed = 0m;
                    
                    if (IsEditMode() && item.ExistingDetail != null)
                    {
                        // åŸæœ‰çš„ç¸½ä½¿ç”¨é‡‘é¡ï¼ˆæ²–æ¬¾ + æŠ˜è®“ï¼‰
                        originalTotalUsed = item.ExistingDetail.CurrentSetoffAmount + 
                                          item.ExistingDetail.CurrentAllowanceAmount;
                    }
                    
                    var maxFillableAmount = AdjustedBalanceHelper.GetMaxFillableAmount(
                        baseRemainingAmount,
                        originalTotalUsed,
                        0, // ä¸è€ƒæ…®å…¶ä»–æ¬„ä½ï¼Œç›´æ¥å¡«æ»¿
                        IsEditMode());
                    
                    // åªæœ‰ç•¶å¯å¡«å…¥é‡‘é¡å¤§æ–¼0æ™‚æ‰å¡«å…¥
                    if (maxFillableAmount > 0)
                    {
                        item.CurrentSetoffAmount = maxFillableAmount;
                        item.CurrentAllowanceAmount = 0; // æ¸…ç©ºæŠ˜è®“
                        filledCount++;
                    }
                }
            }

            await NotifyDetailsChanged();
            
            if (filledCount > 0)
            {
                await NotificationService.ShowSuccessAsync($"å·²è‡ªå‹•å¡«å…¥ {filledCount} é …æ²–æ¬¾é‡‘é¡", "å…¨éƒ¨æ²–æ¬¾å®Œæˆ");
            }
            else
            {
                await NotificationService.ShowInfoAsync("æ²’æœ‰å¯å¡«å…¥çš„æ²–æ¬¾é …ç›®", "æç¤º");
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"å…¨éƒ¨æ²–æ¬¾å¤±æ•—ï¼š{ex.Message}", "éŒ¯èª¤");
        }
    }

    /// <summary>
    /// æ²–æ¬¾æ¸…ç©º - æ¸…ç©ºæ‰€æœ‰æœ¬æ¬¡æ²–æ¬¾å’Œæœ¬æ¬¡æŠ˜è®“é‡‘é¡
    /// </summary>
    private async Task ClearAllSetoffAmounts()
    {
        if (IsReadOnly) return;

        try
        {
            int clearedCount = 0;
            
            foreach (var item in SetoffItems)
            {
                if (item.CurrentSetoffAmount > 0 || item.CurrentAllowanceAmount > 0)
                {
                    item.CurrentSetoffAmount = 0;
                    item.CurrentAllowanceAmount = 0;
                    clearedCount++;
                }
            }

            await NotifyDetailsChanged();
            
            if (clearedCount > 0)
            {
                await NotificationService.ShowSuccessAsync($"å·²æ¸…ç©º {clearedCount} é …æ²–æ¬¾é‡‘é¡", "æ²–æ¬¾æ¸…ç©ºå®Œæˆ");
            }
            else
            {
                await NotificationService.ShowInfoAsync("æ²’æœ‰éœ€è¦æ¸…ç©ºçš„æ²–æ¬¾é …ç›®", "æç¤º");
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"æ²–æ¬¾æ¸…ç©ºå¤±æ•—ï¼š{ex.Message}", "éŒ¯èª¤");
        }
    }

    private async Task NotifyDetailsChanged()
    {
        var details = SetoffItems
            .Where(item => 
                item.CurrentSetoffAmount > 0 || 
                item.CurrentAllowanceAmount > 0 || 
                !string.IsNullOrWhiteSpace(item.Remarks) || // åŒ…å«æœ‰å‚™è¨»çš„é …ç›®
                item.ExistingDetail != null) // ç·¨è¼¯æ¨¡å¼ä¸‹åŒ…å«æ‰€æœ‰å·²å­˜åœ¨çš„æ˜ç´°
            .Select(item => new SetoffProductDetail
            {
                Id = item.ExistingDetail?.Id ?? 0,
                SetoffDocumentId = SetoffDocumentId ?? 0,
                ProductId = item.ProductId,
                SourceDetailType = item.SourceDetailType,
                SourceDetailId = item.SourceDetailId,
                CurrentSetoffAmount = item.CurrentSetoffAmount,
                CurrentAllowanceAmount = item.CurrentAllowanceAmount,
                TotalSetoffAmount = item.ExistingDetail?.TotalSetoffAmount ?? 0,
                TotalAllowanceAmount = item.ExistingDetail?.TotalAllowanceAmount ?? 0,
                Remarks = item.Remarks
            }).ToList();

        await DetailSyncHelper.SyncToParentAsync(details, OnDetailsChanged);
    }
    
    /// <summary>
    /// å–å¾—æœ¬æœŸæ²–éŠ·ç¸½é¡ï¼ˆåªè¨ˆç®—æœ¬æ¬¡æ²–æ¬¾ï¼Œä¸åŒ…å«æŠ˜è®“ï¼Œè€ƒæ…®é€€è²¨ç‚ºè² æ•¸ï¼‰
    /// </summary>
    public decimal GetCurrentSetoffTotal()
    {
        return SetoffItems
            .Where(item => item.CurrentSetoffAmount > 0 || item.CurrentAllowanceAmount > 0)
            .Sum(item =>
            {
                var total = item.CurrentSetoffAmount; // åªè¨ˆç®—æœ¬æ¬¡æ²–æ¬¾
                // å¦‚æœæ˜¯é€€è²¨å–®æ“šï¼Œé‡‘é¡å–è² å€¼
                var isReturn = item.SourceDetailType == SetoffDetailType.SalesReturnDetail || 
                              item.SourceDetailType == SetoffDetailType.PurchaseReturnDetail;
                return isReturn ? -total : total;
            });
    }
    
    /// <summary>
    /// å–å¾—æœ¬æœŸæŠ˜è®“ç¸½é¡ï¼ˆè€ƒæ…®é€€è²¨ç‚ºè² æ•¸ï¼‰
    /// </summary>
    public decimal GetCurrentAllowanceTotal()
    {
        return SetoffItems
            .Where(item => item.CurrentSetoffAmount > 0 || item.CurrentAllowanceAmount > 0)
            .Sum(item =>
            {
                var total = item.CurrentAllowanceAmount;
                // å¦‚æœæ˜¯é€€è²¨å–®æ“šï¼Œé‡‘é¡å–è² å€¼
                var isReturn = item.SourceDetailType == SetoffDetailType.SalesReturnDetail || 
                              item.SourceDetailType == SetoffDetailType.PurchaseReturnDetail;
                return isReturn ? -total : total;
            });
    }
    
    /// <summary>
    /// è™•ç†ç§»é™¤æ˜ç´°é …ç›®
    /// </summary>
    private async Task HandleRemoveItem(SetoffProductDetailItem item)
    {
        // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ä¸­çš„å·²å­˜åœ¨æ˜ç´°ï¼Œå°‡é‡‘é¡æ¸…é›¶è€Œä¸ç§»é™¤é …ç›®ï¼ˆä¿ç•™åœ¨åˆ—è¡¨ä¸­ä»¥ä¾¿æ¢å¾©ï¼‰
        if (item.ExistingDetail != null)
        {
            item.CurrentSetoffAmount = 0;
            item.CurrentAllowanceAmount = 0;
            await NotificationService.ShowInfoAsync("å·²æ¸…é™¤æ­¤é …ç›®çš„æ²–æ¬¾é‡‘é¡");
        }
        else
        {
            // æ–°å¢æ¨¡å¼ä¸‹çš„é …ç›®å¯ä»¥ç›´æ¥ç§»é™¤ï¼ˆå¯¦éš›ä¸Šæ˜¯å°‡é‡‘é¡æ¸…é›¶ï¼‰
            item.CurrentSetoffAmount = 0;
            item.CurrentAllowanceAmount = 0;
            await NotificationService.ShowInfoAsync("å·²æ¸…é™¤æ­¤é …ç›®çš„æ²–æ¬¾é‡‘é¡");
        }
        
        await NotifyDetailsChanged();
        StateHasChanged();
    }
    
    /// <summary>
    /// å–å¾—ç•¶å‰é¸ä¸­æ˜ç´°çš„ä¾†æºç¸½é‡‘é¡ï¼ˆç”¨æ–¼è¨ˆç®—æœ¬æœŸæ‡‰æ”¶ï¼‰
    /// é€€è²¨å–®æ“šæœƒä»¥è² æ•¸è¨ˆç®—
    /// </summary>
    public decimal GetSourceTotalAmount()
    {
        return SetoffItems
            .Where(item => item.CurrentSetoffAmount > 0 || item.CurrentAllowanceAmount > 0)
            .Sum(item => 
            {
                var amount = item.SourceTotalAmount;
                // å¦‚æœæ˜¯é€€è²¨å–®æ“šï¼Œé‡‘é¡å–è² å€¼
                return item.UnsettledDetail?.IsReturn == true ? -amount : amount;
            });
    }
    
    /// <summary>
    /// å…¬é–‹çš„åˆ·æ–°æ–¹æ³•ï¼Œç”¨æ–¼å¤–éƒ¨è§¸ç™¼æ˜ç´°åˆ·æ–°ï¼ˆä¾‹å¦‚ï¼šä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼‰
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        await LoadUnsettledDetailsAsync();
        LoadExistingDetails();
        StateHasChanged();
    }
    
    /// <summary>
    /// å¾é€²è²¨å–®è¼‰å…¥æœªçµæ¸…æ˜ç´°ï¼ˆç”¨æ–¼ã€Œé€²è²¨è½‰æ²–æ¬¾ã€è½‰å–®åŠŸèƒ½ï¼‰
    /// </summary>
    /// <param name="purchaseReceivingId">é€²è²¨å–®ID</param>
    /// <remarks>
    /// æ­¤æ–¹æ³•æœƒè¼‰å…¥æŒ‡å®šé€²è²¨å–®çš„æ‰€æœ‰æœªçµæ¸…å•†å“æ˜ç´°ï¼Œä¸¦é è¨­å¡«å…¥æœ¬æ¬¡æ²–æ¬¾é‡‘é¡ã€‚
    /// ä¸»è¦ç”¨æ–¼å¾ PurchaseReceivingEditModalComponent å‘¼å«ã€‚
    /// </remarks>
    public async Task LoadDetailsFromPurchaseReceiving(int purchaseReceivingId)
    {
        try
        {
            // æª¢æŸ¥é—œè¯æ–¹æ˜¯å¦å·²è¨­å®š
            if (!RelatedPartyId.HasValue || RelatedPartyId.Value <= 0)
            {
                await NotificationService.ShowWarningAsync("è«‹å…ˆé¸æ“‡å» å•†");
                return;
            }
            
            // å–å¾—é€²è²¨å–®çš„ç·¨è™Ÿï¼ˆç”¨æ–¼ç¯©é¸ï¼‰
            var purchaseReceiving = await PurchaseReceivingService.GetByIdAsync(purchaseReceivingId);
            if (purchaseReceiving == null)
            {
                await NotificationService.ShowWarningAsync("æ‰¾ä¸åˆ°æŒ‡å®šçš„é€²è²¨å–®");
                return;
            }
            var purchaseReceivingCode = purchaseReceiving.Code;
            
            // ç¢ºä¿å·²è¼‰å…¥å•†å“è³‡æ–™
            if (!Products.Any())
            {
                await LoadProductsAsync();
            }
            
            // è¼‰å…¥è©²å» å•†çš„æ‰€æœ‰æœªçµæ¸…æ˜ç´°
            await LoadUnsettledDetailsAsync();
            
            // ç¯©é¸å‡ºæŒ‡å®šé€²è²¨å–®çš„æ˜ç´°ï¼ˆé€éå–®è™Ÿæ¯”å°ï¼‰
            var matchingDetails = UnsettledDetails
                .Where(d => d.SourceDetailType == SetoffDetailType.PurchaseReceivingDetail)
                .Where(d => !string.IsNullOrEmpty(d.SourceDocumentNumber) && 
                           d.SourceDocumentNumber == purchaseReceivingCode)
                .ToList();
            
            // è½‰æ›ç‚º SetoffItemsï¼Œé è¨­æœ¬æ¬¡æ²–æ¬¾ç‚ºæœªæ²–æ¬¾é¤˜é¡ï¼ˆå…¨é¡æ²–æ¬¾ï¼‰
            SetoffItems = matchingDetails
                .Select(detail => new SetoffProductDetailItem
                {
                    SourceDetailType = detail.SourceDetailType,
                    SourceDetailId = detail.SourceDetailId,
                    ProductId = detail.ProductId,
                    Product = Products.FirstOrDefault(p => p.Id == detail.ProductId),
                    CurrentSetoffAmount = detail.RemainingAmount, // é è¨­å…¨é¡æ²–æ¬¾
                    CurrentAllowanceAmount = 0,
                    Remarks = null,
                    ExistingDetail = null,
                    UnsettledDetail = detail,
                    NeedsSourceDetailLoad = false
                }).ToList();
            
            // æ¨™è¨˜å·²è¼‰å…¥
            _dataLoaded = true;
            
            // é¡¯ç¤ºè¼‰å…¥çµæœ
            var loadedCount = SetoffItems.Count;
            if (loadedCount > 0)
            {
                await NotificationService.ShowSuccessAsync($"å·²è¼‰å…¥ {loadedCount} ç­†é€²è²¨æ˜ç´°", "è¼‰å…¥å®Œæˆ");
            }
            else
            {
                await NotificationService.ShowInfoAsync("è©²é€²è²¨å–®æ²’æœ‰æœªçµæ¸…çš„æ‡‰ä»˜æ˜ç´°", "æç¤º");
            }
            
            // é€šçŸ¥çˆ¶çµ„ä»¶è³‡æ–™å·²è®Šæ›´
            await NotifyDetailsChanged();
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥é€²è²¨æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }
    
    /// <summary>
    /// å¾é€²è²¨é€€å‡ºè¼‰å…¥æœªçµæ¸…æ˜ç´°ï¼ˆç”¨æ–¼ã€Œé€²è²¨é€€å‡ºè½‰æ²–æ¬¾ã€è½‰å–®åŠŸèƒ½ï¼‰
    /// </summary>
    /// <param name="purchaseReturnId">é€²è²¨é€€å‡ºID</param>
    public async Task LoadDetailsFromPurchaseReturn(int purchaseReturnId)
    {
        try
        {
            // æª¢æŸ¥é—œè¯æ–¹æ˜¯å¦å·²è¨­å®š
            if (!RelatedPartyId.HasValue || RelatedPartyId.Value <= 0)
            {
                await NotificationService.ShowWarningAsync("è«‹å…ˆé¸æ“‡å» å•†");
                return;
            }
            
            // å–å¾—é€²è²¨é€€å‡ºçš„ç·¨è™Ÿï¼ˆç”¨æ–¼ç¯©é¸ï¼‰
            var purchaseReturn = await PurchaseReturnService.GetByIdAsync(purchaseReturnId);
            if (purchaseReturn == null)
            {
                await NotificationService.ShowWarningAsync("æ‰¾ä¸åˆ°æŒ‡å®šçš„é€²è²¨é€€å‡º");
                return;
            }
            var purchaseReturnCode = purchaseReturn.Code;
            
            // ç¢ºä¿å·²è¼‰å…¥å•†å“è³‡æ–™
            if (!Products.Any())
            {
                await LoadProductsAsync();
            }
            
            // è¼‰å…¥è©²å» å•†çš„æ‰€æœ‰æœªçµæ¸…æ˜ç´°
            await LoadUnsettledDetailsAsync();
            
            // ç¯©é¸å‡ºæŒ‡å®šé€²è²¨é€€å‡ºçš„æ˜ç´°ï¼ˆé€éå–®è™Ÿæ¯”å°ï¼‰
            var matchingDetails = UnsettledDetails
                .Where(d => d.SourceDetailType == SetoffDetailType.PurchaseReturnDetail)
                .Where(d => !string.IsNullOrEmpty(d.SourceDocumentNumber) && 
                           d.SourceDocumentNumber == purchaseReturnCode)
                .ToList();
            
            // è½‰æ›ç‚º SetoffItemsï¼Œé è¨­æœ¬æ¬¡æ²–æ¬¾ç‚ºæœªæ²–æ¬¾é¤˜é¡ï¼ˆå…¨é¡æ²–æ¬¾ï¼‰
            SetoffItems = matchingDetails
                .Select(detail => new SetoffProductDetailItem
                {
                    SourceDetailType = detail.SourceDetailType,
                    SourceDetailId = detail.SourceDetailId,
                    ProductId = detail.ProductId,
                    Product = Products.FirstOrDefault(p => p.Id == detail.ProductId),
                    CurrentSetoffAmount = detail.RemainingAmount,
                    CurrentAllowanceAmount = 0,
                    Remarks = null,
                    ExistingDetail = null,
                    UnsettledDetail = detail,
                    NeedsSourceDetailLoad = false
                }).ToList();
            
            _dataLoaded = true;
            
            var loadedCount = SetoffItems.Count;
            if (loadedCount > 0)
            {
                await NotificationService.ShowSuccessAsync($"å·²è¼‰å…¥ {loadedCount} ç­†é€²è²¨é€€å‡ºæ˜ç´°", "è¼‰å…¥å®Œæˆ");
            }
            else
            {
                await NotificationService.ShowInfoAsync("è©²é€²è²¨é€€å‡ºæ²’æœ‰æœªçµæ¸…çš„æ‡‰ä»˜æ˜ç´°", "æç¤º");
            }
            
            await NotifyDetailsChanged();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥é€²è²¨é€€å‡ºæ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }
    
    /// <summary>
    /// å¾éŠ·è²¨å‡ºè²¨è¼‰å…¥æœªçµæ¸…æ˜ç´°ï¼ˆç”¨æ–¼ã€ŒéŠ·è²¨å‡ºè²¨è½‰æ²–æ¬¾ã€è½‰å–®åŠŸèƒ½ï¼‰
    /// </summary>
    /// <param name="salesDeliveryId">éŠ·è²¨å‡ºè²¨ID</param>
    public async Task LoadDetailsFromSalesDelivery(int salesDeliveryId)
    {
        try
        {
            // æª¢æŸ¥é—œè¯æ–¹æ˜¯å¦å·²è¨­å®š
            if (!RelatedPartyId.HasValue || RelatedPartyId.Value <= 0)
            {
                await NotificationService.ShowWarningAsync("è«‹å…ˆé¸æ“‡å®¢æˆ¶");
                return;
            }
            
            // å–å¾—éŠ·è²¨å‡ºè²¨çš„ç·¨è™Ÿï¼ˆç”¨æ–¼ç¯©é¸ï¼‰
            var salesDelivery = await SalesDeliveryService.GetByIdAsync(salesDeliveryId);
            if (salesDelivery == null)
            {
                await NotificationService.ShowWarningAsync("æ‰¾ä¸åˆ°æŒ‡å®šçš„éŠ·è²¨å‡ºè²¨å–®");
                return;
            }
            var salesDeliveryCode = salesDelivery.Code;
            
            // ç¢ºä¿å·²è¼‰å…¥å•†å“è³‡æ–™
            if (!Products.Any())
            {
                await LoadProductsAsync();
            }
            
            // è¼‰å…¥è©²å®¢æˆ¶çš„æ‰€æœ‰æœªçµæ¸…æ˜ç´°
            await LoadUnsettledDetailsAsync();
            
            // ç¯©é¸å‡ºæŒ‡å®šéŠ·è²¨å‡ºè²¨çš„æ˜ç´°ï¼ˆé€éå–®è™Ÿæ¯”å°ï¼‰
            var matchingDetails = UnsettledDetails
                .Where(d => d.SourceDetailType == SetoffDetailType.SalesDeliveryDetail)
                .Where(d => !string.IsNullOrEmpty(d.SourceDocumentNumber) && 
                           d.SourceDocumentNumber == salesDeliveryCode)
                .ToList();
            
            // è½‰æ›ç‚º SetoffItemsï¼Œé è¨­æœ¬æ¬¡æ²–æ¬¾ç‚ºæœªæ²–æ¬¾é¤˜é¡ï¼ˆå…¨é¡æ²–æ¬¾ï¼‰
            SetoffItems = matchingDetails
                .Select(detail => new SetoffProductDetailItem
                {
                    SourceDetailType = detail.SourceDetailType,
                    SourceDetailId = detail.SourceDetailId,
                    ProductId = detail.ProductId,
                    Product = Products.FirstOrDefault(p => p.Id == detail.ProductId),
                    CurrentSetoffAmount = detail.RemainingAmount,
                    CurrentAllowanceAmount = 0,
                    Remarks = null,
                    ExistingDetail = null,
                    UnsettledDetail = detail,
                    NeedsSourceDetailLoad = false
                }).ToList();
            
            _dataLoaded = true;
            
            var loadedCount = SetoffItems.Count;
            if (loadedCount > 0)
            {
                await NotificationService.ShowSuccessAsync($"å·²è¼‰å…¥ {loadedCount} ç­†éŠ·è²¨å‡ºè²¨æ˜ç´°", "è¼‰å…¥å®Œæˆ");
            }
            else
            {
                await NotificationService.ShowInfoAsync("è©²éŠ·è²¨å‡ºè²¨å–®æ²’æœ‰æœªçµæ¸…çš„æ‡‰æ”¶æ˜ç´°", "æç¤º");
            }
            
            await NotifyDetailsChanged();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥éŠ·è²¨å‡ºè²¨æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }
    
    /// <summary>
    /// å¾éŠ·è²¨é€€å›è¼‰å…¥æœªçµæ¸…æ˜ç´°ï¼ˆç”¨æ–¼ã€ŒéŠ·è²¨é€€å›è½‰æ²–æ¬¾ã€è½‰å–®åŠŸèƒ½ï¼‰
    /// </summary>
    /// <param name="salesReturnId">éŠ·è²¨é€€å›ID</param>
    public async Task LoadDetailsFromSalesReturn(int salesReturnId)
    {
        try
        {
            // æª¢æŸ¥é—œè¯æ–¹æ˜¯å¦å·²è¨­å®š
            if (!RelatedPartyId.HasValue || RelatedPartyId.Value <= 0)
            {
                await NotificationService.ShowWarningAsync("è«‹å…ˆé¸æ“‡å®¢æˆ¶");
                return;
            }
            
            // å–å¾—éŠ·è²¨é€€å›çš„ç·¨è™Ÿï¼ˆç”¨æ–¼ç¯©é¸ï¼‰
            var salesReturn = await SalesReturnService.GetByIdAsync(salesReturnId);
            if (salesReturn == null)
            {
                await NotificationService.ShowWarningAsync("æ‰¾ä¸åˆ°æŒ‡å®šçš„éŠ·è²¨é€€å›");
                return;
            }
            var salesReturnCode = salesReturn.Code;
            
            // ç¢ºä¿å·²è¼‰å…¥å•†å“è³‡æ–™
            if (!Products.Any())
            {
                await LoadProductsAsync();
            }
            
            // è¼‰å…¥è©²å®¢æˆ¶çš„æ‰€æœ‰æœªçµæ¸…æ˜ç´°
            await LoadUnsettledDetailsAsync();
            
            // ç¯©é¸å‡ºæŒ‡å®šéŠ·è²¨é€€å›çš„æ˜ç´°ï¼ˆé€éå–®è™Ÿæ¯”å°ï¼‰
            var matchingDetails = UnsettledDetails
                .Where(d => d.SourceDetailType == SetoffDetailType.SalesReturnDetail)
                .Where(d => !string.IsNullOrEmpty(d.SourceDocumentNumber) && 
                           d.SourceDocumentNumber == salesReturnCode)
                .ToList();
            
            // è½‰æ›ç‚º SetoffItemsï¼Œé è¨­æœ¬æ¬¡æ²–æ¬¾ç‚ºæœªæ²–æ¬¾é¤˜é¡ï¼ˆå…¨é¡æ²–æ¬¾ï¼‰
            SetoffItems = matchingDetails
                .Select(detail => new SetoffProductDetailItem
                {
                    SourceDetailType = detail.SourceDetailType,
                    SourceDetailId = detail.SourceDetailId,
                    ProductId = detail.ProductId,
                    Product = Products.FirstOrDefault(p => p.Id == detail.ProductId),
                    CurrentSetoffAmount = detail.RemainingAmount,
                    CurrentAllowanceAmount = 0,
                    Remarks = null,
                    ExistingDetail = null,
                    UnsettledDetail = detail,
                    NeedsSourceDetailLoad = false
                }).ToList();
            
            _dataLoaded = true;
            
            var loadedCount = SetoffItems.Count;
            if (loadedCount > 0)
            {
                await NotificationService.ShowSuccessAsync($"å·²è¼‰å…¥ {loadedCount} ç­†éŠ·è²¨é€€å›æ˜ç´°", "è¼‰å…¥å®Œæˆ");
            }
            else
            {
                await NotificationService.ShowInfoAsync("è©²éŠ·è²¨é€€å›æ²’æœ‰æœªçµæ¸…çš„æ‡‰æ”¶æ˜ç´°", "æç¤º");
            }
            
            await NotifyDetailsChanged();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥éŠ·è²¨é€€å›æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{ex.Message}");
        }
    }
    
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼ï¼ˆç·¨è¼¯æ¨¡å¼ä¸‹ä¸å…è¨±åˆªé™¤æ˜ç´°ï¼‰
    /// </summary>
    private bool IsEditMode()
    {
        return SetoffDocumentId.HasValue && SetoffDocumentId.Value > 0;
    }

    // ===== å…§éƒ¨è³‡æ–™é¡åˆ¥ =====
    private class SetoffProductDetailItem
    {
        public SetoffDetailType SourceDetailType { get; set; }
        public int SourceDetailId { get; set; }
        public int ProductId { get; set; }
        public Product? Product { get; set; }
        public decimal CurrentSetoffAmount { get; set; }
        public decimal CurrentAllowanceAmount { get; set; }
        public string? Remarks { get; set; }
        public SetoffProductDetail? ExistingDetail { get; set; }
        public UnsettledDetailDto? UnsettledDetail { get; set; } // ä¿ç•™æœªçµæ¸…æ˜ç´°è³‡è¨Š
        public bool NeedsSourceDetailLoad { get; set; } // æ¨™è¨˜æ˜¯å¦éœ€è¦é¡å¤–è¼‰å…¥ä¾†æºæ˜ç´°ï¼ˆé‡å°å·²çµæ¸…çš„æ˜ç´°ï¼‰
        
        /// <summary>
        /// ä¾†æºæ˜ç´°çš„åŸå§‹ç¸½é‡‘é¡ï¼ˆç”¨æ–¼è¨ˆç®—æœ¬æœŸæ‡‰æ”¶ï¼‰
        /// </summary>
        public decimal SourceTotalAmount => UnsettledDetail?.TotalAmount ?? 0;
    }
}
