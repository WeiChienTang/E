@* æ²–æ¬¾æ”¶æ¬¾è¨˜éŒ„ç®¡ç†çµ„ä»¶ - ç®¡ç†æ”¶æ¬¾ã€æŠ˜è®“ç­‰è²¡å‹™è³‡è¨Š *@

@inject ISetoffPaymentService SetoffPaymentService
@inject IBankService BankService
@inject IPaymentMethodService PaymentMethodService
@inject INotificationService NotificationService

<div class="card-body p-0">
    <InteractiveTableComponent TItem="SetoffPaymentItem" 
                                Items="@PaymentItems"
                                ColumnDefinitions="@GetPaymentColumnDefinitions()"
                                IsReadOnly="@IsReadOnly"
                                ShowRowNumbers="false"
                                EmptyMessage="å°šæœªæ–°å¢æ”¶æ¬¾è¨˜éŒ„"
                                ShowBuiltInActions="@(!IsEditMode())"
                                ShowBuiltInDeleteButton="@(!IsEditMode())"
                                OnItemDelete="@HandleRemovePaymentRecord"
                                ActionsColumnWidth = "60px"
                                EnableAutoEmptyRow="true"
                                AllowAddNewRow="@(!IsReadOnly && !IsEditMode())"
                                DataLoadCompleted="@_dataLoadCompleted"
                                CreateEmptyItem="@CreateEmptyItem" />
</div>

@code {
    // ===== ç§æœ‰æ¬„ä½ =====
    private bool _dataLoadCompleted = true;  // è³‡æ–™è¼‰å…¥å®Œæˆæ¨™è¨˜
    
    // ===== åƒæ•¸å®šç¾© =====
    [Parameter] public int? SetoffDocumentId { get; set; }
    
    // è³‡æ–™ç¶å®š
    [Parameter] public List<SetoffPayment> ExistingPayments { get; set; } = new();
    [Parameter] public EventCallback<List<SetoffPayment>> OnPaymentsChanged { get; set; }
    
    // é¡¯ç¤ºæ§åˆ¶
    [Parameter] public bool IsReadOnly { get; set; } = false;
    
    // æ²–æ¬¾é¡å‹ - ç”¨æ–¼å‹•æ…‹èª¿æ•´æ¬„ä½æ¨™é¡Œ
    [Parameter] public SetoffType SetoffType { get; set; } = SetoffType.AccountsReceivable;
    
    // ===== å…§éƒ¨ç‹€æ…‹ =====
    private List<SetoffPaymentItem> PaymentItems { get; set; } = new();
    private List<Bank> Banks { get; set; } = new();
    private List<PaymentMethod> PaymentMethods { get; set; } = new();
    
    // ç”¨æ–¼è¿½è¹¤åƒæ•¸è®Šæ›´ï¼Œé¿å…ä¸å¿…è¦çš„é‡æ–°è¼‰å…¥
    private int _previousExistingPaymentsCount;

    // ===== è¨ˆç®—å±¬æ€§ =====
    private decimal TotalReceivedAmount => PaymentItems
        .Where(p => p.PaymentMethodId.HasValue && p.PaymentMethodId.Value > 0)
        .Sum(p => p.ReceivedAmount);
    
    private decimal TotalAllowanceAmount => PaymentItems
        .Where(p => p.PaymentMethodId.HasValue && p.PaymentMethodId.Value > 0)
        .Sum(p => p.AllowanceAmount);

    // ===== ç”Ÿå‘½é€±æœŸæ–¹æ³• =====
    protected override async Task OnInitializedAsync()
    {
        await LoadBanksAndPaymentMethodsAsync();
        LoadExistingPayments();
        
        // åˆå§‹åŒ–è¿½è¹¤è®Šæ•¸
        _previousExistingPaymentsCount = ExistingPayments?.Count ?? 0;
    }

    protected override async Task OnParametersSetAsync()
    {
        // åªæœ‰ç•¶ ExistingPayments çœŸæ­£è®Šæ›´æ™‚ï¼ˆæ•¸é‡ä¸åŒï¼‰ï¼Œæ‰é‡æ–°è¼‰å…¥è³‡æ–™
        var currentCount = ExistingPayments?.Count ?? 0;
        if (_previousExistingPaymentsCount != currentCount)
        {
            LoadExistingPayments();
            _previousExistingPaymentsCount = currentCount;
        }
        
        await base.OnParametersSetAsync();
    }

    // ===== å»ºç«‹ç©ºé …ç›®æ–¹æ³• =====
    
    /// <summary>
    /// å‰µå»ºç©ºçš„æ”¶æ¬¾è¨˜éŒ„é …ç›®
    /// </summary>
    private SetoffPaymentItem CreateEmptyItem()
    {
        return new SetoffPaymentItem
        {
            Id = 0,
            BankId = null,
            PaymentMethodId = null,
            ReceivedAmount = 0,
            AllowanceAmount = 0,
            CheckNumber = null,
            DueDate = null,
            Remarks = null,
            ExistingPayment = null
        };
    }

    // ===== è³‡æ–™è¼‰å…¥æ–¹æ³• =====
    private async Task LoadBanksAndPaymentMethodsAsync()
    {
        try
        {
            Banks = await BankService.GetAllAsync();
            PaymentMethods = await PaymentMethodService.GetAllAsync();
        }
        catch (Exception ex)
        {
            await NotificationService.ShowErrorAsync($"è¼‰å…¥éŠ€è¡Œå’Œä»˜æ¬¾æ–¹å¼è³‡æ–™å¤±æ•—ï¼š{ex.Message}");
            Banks = new List<Bank>();
            PaymentMethods = new List<PaymentMethod>();
        }
    }

    private void LoadExistingPayments()
    {
        if (ExistingPayments?.Any() == true)
        {
            // ğŸ”‘ ç·¨è¼¯æ¨¡å¼ï¼šè¼‰å…¥å·²å­˜åœ¨çš„æ”¶æ¬¾è¨˜éŒ„
            _dataLoadCompleted = false;  // é–‹å§‹è¼‰å…¥
            
            PaymentItems.Clear();
            PaymentItems = ExistingPayments.Select(payment => new SetoffPaymentItem
            {
                Id = payment.Id,
                BankId = payment.BankId,
                PaymentMethodId = payment.PaymentMethodId,
                ReceivedAmount = payment.ReceivedAmount,
                AllowanceAmount = payment.AllowanceAmount,
                CheckNumber = payment.CheckNumber,
                DueDate = payment.DueDate,
                Remarks = payment.Remarks,
                ExistingPayment = payment
            }).ToList();
            
            _dataLoadCompleted = true;  // è¼‰å…¥å®Œæˆï¼Œè§¸ç™¼ç©ºè¡Œæª¢æŸ¥
        }
        // ğŸ”‘ æ–°å¢æ¨¡å¼ï¼šä¸åšä»»ä½•äº‹ï¼Œè®“ InteractiveTableComponent è‡ªå‹•ç”¢ç”Ÿç¬¬ä¸€è¡Œç©ºè¡Œ
        // ä¸å‘¼å« Clear()ï¼Œé¿å…æ¸…é™¤å·²è‡ªå‹•ç”¢ç”Ÿçš„ç©ºè¡Œï¼ˆæ™‚åºå•é¡Œï¼‰
    }

    // ===== InteractiveTable æ¬„ä½å®šç¾© =====
    private List<InteractiveColumnDefinition> GetPaymentColumnDefinitions()
    {
        // æ ¹æ“šæ²–æ¬¾é¡å‹æ±ºå®šæ¬„ä½æ¨™é¡Œ
        var receivedAmountLabel = SetoffType == SetoffType.AccountsReceivable ? "æ”¶æ¬¾é‡‘é¡" : "ä»˜æ¬¾é‡‘é¡";
        
        var columns = new List<InteractiveColumnDefinition>
        {

            new()
            {
                Title = "ä»˜æ¬¾æ–¹å¼",
                Tooltip = "é¸æ“‡æœ¬æ¬¡æ”¶ä»˜æ¬¾çš„æ–¹å¼ï¼ˆç¾é‡‘ã€åŒ¯æ¬¾ã€æ”¯ç¥¨ç­‰ï¼‰",
                PropertyName = nameof(SetoffPaymentItem.PaymentMethodId),
                ColumnType = InteractiveColumnType.Select,
                Width = "180px",
                IsRequired = false,
                TriggerEmptyRowOnFilled = true,  // ğŸ”‘ è§¸ç™¼æ¬„ä½ï¼šé¸æ“‡å¾Œè‡ªå‹•æ–°å¢ç©ºè¡Œ
                Options = new List<InteractiveSelectOption> 
                { 
                    new InteractiveSelectOption { Value = 0, Text = "è«‹é¸æ“‡.." } 
                }
                .Concat(PaymentMethods.Select(pm => new InteractiveSelectOption
                { 
                    Value = pm.Id, 
                    Text = pm.Name 
                })).ToList(),
                OnSelectionChanged = EventCallback.Factory.Create<(object, object?)>(this, args =>
                {
                    var (itemObj, value) = args;
                    var item = (SetoffPaymentItem)itemObj;
                    
                    if (value != null && int.TryParse(value.ToString(), out int methodId))
                    {
                        item.PaymentMethodId = methodId;
                    }
                    else
                    {
                        item.PaymentMethodId = null;
                    }
                    
                    // ä»˜æ¬¾æ–¹å¼è®Šæ›´æ™‚ä¹Ÿéœ€è¦é€šçŸ¥çˆ¶çµ„ä»¶ï¼Œä»¥ä¾¿æ­£ç¢ºè¿½è¹¤è®Šæ›´
                    _ = NotifyPaymentsChanged();
                    StateHasChanged();
                })
            },
            new()
            {
                Title = receivedAmountLabel,
                Tooltip = SetoffType == SetoffType.AccountsReceivable ? "æœ¬æ¬¡å¯¦éš›æ”¶åˆ°çš„æ¬¾é …é‡‘é¡" : "æœ¬æ¬¡å¯¦éš›æ”¯ä»˜çš„æ¬¾é …é‡‘é¡",
                PropertyName = nameof(SetoffPaymentItem.ReceivedAmount),
                ColumnType = InteractiveColumnType.Number,
                Width = "150px",
                UseThousandsSeparator = true,  // é¡¯ç¤ºåƒåˆ†ä½
                IsReadOnly = IsReadOnly,
                OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
                {
                    var (itemObj, value) = args;
                    var item = (SetoffPaymentItem)itemObj;
                    await OnReceivedAmountInput(item, value);
                })
            },
            new()
            {
                Title = "æŠ˜è®“é‡‘é¡",
                Tooltip = "æœ¬æ¬¡çµ¦äºˆçš„æŠ˜è®“é‡‘é¡ï¼ˆä¸è¨ˆå…¥å¯¦éš›æ”¶ä»˜æ¬¾ï¼‰",
                PropertyName = nameof(SetoffPaymentItem.AllowanceAmount),
                ColumnType = InteractiveColumnType.Number,
                Width = "150px",
                UseThousandsSeparator = true,  // é¡¯ç¤ºåƒåˆ†ä½
                IsReadOnly = IsReadOnly,
                OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, async args =>
                {
                    var (itemObj, value) = args;
                    var item = (SetoffPaymentItem)itemObj;
                    await OnAllowanceAmountInput(item, value);
                })
            },

            new()
            {
                Title = "éŠ€è¡Œåˆ¥",
                Tooltip = "é¸æ“‡æ”¶ä»˜æ¬¾çš„éŠ€è¡Œå¸³æˆ¶",
                PropertyName = nameof(SetoffPaymentItem.BankId),
                ColumnType = InteractiveColumnType.Select,
                Width = "180px",
                IsRequired = false,
                Options = new List<InteractiveSelectOption> 
                { 
                    new InteractiveSelectOption { Value = 0, Text = "è«‹é¸æ“‡.." } 
                }
                .Concat(Banks.Select(b => new InteractiveSelectOption
                { 
                    Value = b.Id, 
                    Text = b.BankName 
                })).ToList(),
                OnSelectionChanged = EventCallback.Factory.Create<(object, object?)>(this, args =>
                {
                    var (itemObj, value) = args;
                    var item = (SetoffPaymentItem)itemObj;
                    
                    if (value != null && int.TryParse(value.ToString(), out int bankId))
                    {
                        item.BankId = bankId;
                    }
                    else
                    {
                        item.BankId = null;
                    }
                    
                    // éŠ€è¡Œåˆ¥è®Šæ›´æ™‚ä¹Ÿéœ€è¦é€šçŸ¥çˆ¶çµ„ä»¶ï¼Œä»¥ä¾¿æ­£ç¢ºè¿½è¹¤è®Šæ›´
                    _ = NotifyPaymentsChanged();
                    StateHasChanged();
                })
            },
            new()
            {
                Title = "æ”¯ç¥¨è™Ÿç¢¼",
                Tooltip = "è‹¥ä»˜æ¬¾æ–¹å¼ç‚ºæ”¯ç¥¨ï¼Œè«‹è¼¸å…¥æ”¯ç¥¨è™Ÿç¢¼",
                PropertyName = nameof(SetoffPaymentItem.CheckNumber),
                ColumnType = InteractiveColumnType.Input,
                Width = "150px",
                IsRequired = false,
                OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, args =>
                {
                    var (itemObj, value) = args;
                    var item = (SetoffPaymentItem)itemObj;
                    
                    item.CheckNumber = value;
                    
                    // æ”¯ç¥¨è™Ÿç¢¼è®Šæ›´æ™‚ä¹Ÿéœ€è¦é€šçŸ¥çˆ¶çµ„ä»¶ï¼Œä»¥ä¾¿æ­£ç¢ºè¿½è¹¤è®Šæ›´
                    _ = NotifyPaymentsChanged();
                    StateHasChanged();
                })
            },
            new()
            {
                Title = "åˆ°æœŸæ—¥",
                Tooltip = "è‹¥ä»˜æ¬¾æ–¹å¼ç‚ºæ”¯ç¥¨ï¼Œè«‹é¸æ“‡æ”¯ç¥¨åˆ°æœŸæ—¥",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "150px",
                CustomTemplate = item =>
                {
                    var paymentItem = (SetoffPaymentItem)item;
                    var dateValue = paymentItem.DueDate?.ToString("yyyy-MM-dd") ?? "";
                    return @<div class="position-relative">
                        <input type="date" 
                               class="form-control"
                               value="@dateValue"
                               @onchange="@(e => OnDueDateChanged(paymentItem, e.Value?.ToString()))"
                               disabled="@IsReadOnly" />
                    </div>;
                }
            },
            new()
            {
                Title = "å°è¨ˆ",
                Tooltip = "æ”¶æ¬¾é‡‘é¡ + æŠ˜è®“é‡‘é¡çš„ç¸½è¨ˆ",
                PropertyName = "",
                ColumnType = InteractiveColumnType.Custom,
                Width = "150px",
                CustomTemplate = item =>
                {
                    var paymentItem = (SetoffPaymentItem)item;
                    var subtotal = paymentItem.ReceivedAmount + paymentItem.AllowanceAmount;
                    var displayValue = NumberFormatHelper.FormatSmartZeroAsEmpty(subtotal);
                    // æ ¹æ“šæ­£è² æ•¸æ±ºå®šé¡è‰²ï¼šæ­£æ•¸ç‚ºç¶ è‰²ï¼Œè² æ•¸ç‚ºç´…è‰²
                    var cssClass = subtotal >= 0 ? "text-success" : "text-danger";
                    return @<div class="text-end fw-bold @cssClass">@displayValue</div>;
                }
            },
            new()
            {
                Title = "å‚™è¨»",
                Tooltip = "å‚™è¨»èªªæ˜",
                PropertyName = nameof(SetoffPaymentItem.Remarks),
                ColumnType = InteractiveColumnType.Input,
                Width = "200px",
                IsRequired = false,
                OnInputChanged = EventCallback.Factory.Create<(object, string?)>(this, args =>
                {
                    var (itemObj, value) = args;
                    var item = (SetoffPaymentItem)itemObj;
                    
                    item.Remarks = value;
                    
                    // å‚™è¨»è®Šæ›´æ™‚ä¹Ÿéœ€è¦é€šçŸ¥çˆ¶çµ„ä»¶ï¼Œä»¥ä¾¿æ­£ç¢ºè¿½è¹¤è®Šæ›´
                    _ = NotifyPaymentsChanged();
                    StateHasChanged();
                })
            }
        };

        return columns;
    }

    // ===== äº‹ä»¶è™•ç†æ–¹æ³• =====
    private async Task HandleRemovePaymentRecord(SetoffPaymentItem item)
    {
        if (IsReadOnly) return;
        
        PaymentItems.Remove(item);
        
        await NotificationService.ShowInfoAsync("å·²ç§»é™¤æ”¶æ¬¾è¨˜éŒ„");
        await NotifyPaymentsChanged();
        StateHasChanged();
    }

    private async Task OnReceivedAmountInput(SetoffPaymentItem item, string? value)
    {
        item.ReceivedAmount = InputEventHelper.HandlePriceInput(value);
        
        await NotifyPaymentsChanged();
        StateHasChanged();
    }

    private async Task OnAllowanceAmountInput(SetoffPaymentItem item, string? value)
    {
        item.AllowanceAmount = InputEventHelper.HandlePriceInput(value);
        
        await NotifyPaymentsChanged();
        StateHasChanged();
    }

    private async Task OnDueDateChanged(SetoffPaymentItem item, string? value)
    {
        if (DateTime.TryParse(value, out var dueDate))
        {
            item.DueDate = dueDate;
        }
        else
        {
            item.DueDate = null;
        }
        
        // åˆ°æœŸæ—¥è®Šæ›´æ™‚ä¹Ÿéœ€è¦é€šçŸ¥çˆ¶çµ„ä»¶ï¼Œä»¥ä¾¿æ­£ç¢ºè¿½è¹¤è®Šæ›´
        await NotifyPaymentsChanged();
        StateHasChanged();
    }

    private async Task NotifyPaymentsChanged()
    {
        // åªå‚³ééç©ºè¡Œçš„æ”¶æ¬¾è¨˜éŒ„
        var payments = PaymentItems
            .Where(item => item.PaymentMethodId.HasValue && item.PaymentMethodId.Value > 0)
            .Select(item => new SetoffPayment
            {
                Id = item.ExistingPayment?.Id ?? 0,
                SetoffDocumentId = SetoffDocumentId ?? 0,
                BankId = item.BankId,
                PaymentMethodId = item.PaymentMethodId,
                ReceivedAmount = item.ReceivedAmount,
                AllowanceAmount = item.AllowanceAmount,
                CheckNumber = item.CheckNumber,
                DueDate = item.DueDate,
                Remarks = item.Remarks,
                // é‡è¦ï¼šä¸è¨­å®šå°èˆªå±¬æ€§ï¼Œé¿å… EF Core è¿½è¹¤è¡çª
                SetoffDocument = null!,
                Bank = null,
                PaymentMethod = null
            }).ToList();

        await DetailSyncHelper.SyncToParentAsync(payments, OnPaymentsChanged);
    }

    // ===== å…¬é–‹æ–¹æ³•ï¼ˆä¾›çˆ¶çµ„ä»¶èª¿ç”¨ï¼‰=====
    
    /// <summary>
    /// å–å¾—ç¸½æ”¶æ¬¾é‡‘é¡
    /// </summary>
    public decimal GetTotalReceivedAmount() => TotalReceivedAmount;

    /// <summary>
    /// å–å¾—ç¸½æŠ˜è®“é‡‘é¡
    /// </summary>
    public decimal GetTotalAllowanceAmount() => TotalAllowanceAmount;

    /// <summary>
    /// å–å¾—ç¸½é‡‘é¡ï¼ˆæ”¶æ¬¾ + æŠ˜è®“ï¼‰
    /// </summary>
    public decimal GetTotalAmount() => TotalReceivedAmount + TotalAllowanceAmount;
    
    /// <summary>
    /// å…¬é–‹çš„åˆ·æ–°æ–¹æ³•ï¼Œç”¨æ–¼å¤–éƒ¨è§¸ç™¼æ˜ç´°åˆ·æ–°ï¼ˆä¾‹å¦‚ï¼šä¸Šä¸‹ç­†åˆ‡æ›æ™‚ï¼‰
    /// </summary>
    public async Task RefreshDetailsAsync()
    {
        LoadExistingPayments();
        StateHasChanged();
        await Task.CompletedTask;
    }
    
    /// <summary>
    /// åˆ¤æ–·æ˜¯å¦ç‚ºç·¨è¼¯æ¨¡å¼ï¼ˆç·¨è¼¯æ¨¡å¼ä¸‹ä¸å…è¨±åˆªé™¤æ˜ç´°ï¼‰
    /// </summary>
    private bool IsEditMode()
    {
        return SetoffDocumentId.HasValue && SetoffDocumentId.Value > 0;
    }

    // ===== å…§éƒ¨è³‡æ–™é¡åˆ¥ =====
    private class SetoffPaymentItem : BaseEntity
    {
        public int? BankId { get; set; }
        public int? PaymentMethodId { get; set; }
        public decimal ReceivedAmount { get; set; }
        public decimal AllowanceAmount { get; set; }
        public string? CheckNumber { get; set; }
        public DateTime? DueDate { get; set; }
        public SetoffPayment? ExistingPayment { get; set; }
        // Remarks ç¹¼æ‰¿è‡ª BaseEntity
    }
}
