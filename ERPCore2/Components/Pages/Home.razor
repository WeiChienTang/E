@page "/"
@attribute [Authorize]
@using ERPCore2.Data.Entities
@using ERPCore2.Data.Navigation
@using ERPCore2.Models.Navigation
@using ERPCore2.Components.Shared.Dashboard
@using ERPCore2.Components.Pages.Systems
@inject IDashboardService DashboardService
@inject INotificationService NotificationService
@inject IPermissionService PermissionService
@inject ICompanyService CompanyService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>@(primaryCompany?.CompanyName ?? "ERP系統") - 系統首頁</PageTitle>

@* 從 MainLayout 接收 Action 處理器 *@
@code {
    [CascadingParameter(Name = "NavigationActionHandler")]
    private Action<string>? NavigationActionHandler { get; set; }
}

<div class="container-fluid">

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">載入中...</span>
            </div>
            <p class="text-muted mt-2">載入首頁配置中...</p>
        </div>
    }
    else
    {
        @* ==================== 動態區塊列表 ==================== *@
        @foreach (var panelWithItems in panels)
        {
            var panel = panelWithItems.Panel;
            var isEditMode = editingPanelId == panel.Id;

            <div class="dashboard-panel mb-4">
                @* 區塊標題列 *@
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 fw-bold">
                        @if (isEditMode)
                        {
                            <span class="panel-icon-edit me-2" 
                                  @onclick="@(() => OpenIconPicker(panel.Id, panel.IconClass))"
                                  title="點擊更換圖示">
                                <i class="@(panel.IconClass ?? "bi bi-grid-fill")"></i>
                                <i class="bi bi-pencil-fill icon-edit-badge"></i>
                            </span>
                        }
                        else
                        {
                            <i class="@(panel.IconClass ?? "bi bi-grid-fill") me-2"></i>
                        }
                        @if (isEditMode)
                        {
                            <input type="text"
                                   class="form-control form-control-sm d-inline-block"
                                   style="width: auto; max-width: 200px;"
                                   value="@panel.Title"
                                   maxlength="@DashboardDefaults.MaxPanelTitleLength"
                                   @onchange="@(e => HandlePanelTitleChange(panel.Id, e.Value?.ToString()))" />
                        }
                        else
                        {
                            @panel.Title
                        }
                    </h5>
                    <div>
                        @if (isEditMode)
                        {
                            <GenericButtonComponent Variant="ButtonVariant.DarkBlue"
                                                    Size="ButtonSize.Small"
                                                    Text="完成"
                                                    OnClick="@(() => FinishEditPanel())" />
                            @if (panels.Count > 1)
                            {
                                <GenericButtonComponent Variant="ButtonVariant.Red"
                                                        Size="ButtonSize.Small"
                                                        Text="刪除"
                                                        Title="刪除此區塊"
                                                        CssClass="ms-1"
                                                        OnClick="@(() => HandleDeletePanel(panel))" />
                            }
                        }
                        else
                        {
                            <GenericButtonComponent Variant="ButtonVariant.Green"
                                                    Size="ButtonSize.Small"
                                                    Text="編輯"
                                                    Title="編輯此區塊"
                                                    OnClick="@(() => StartEditPanel(panel.Id))" />
                        }
                    </div>
                </div>

                <hr class="mt-2 mb-3" />

                @* 區塊內容 *@
                @if (panelWithItems.Items.Any())
                {
                    <div class="row g-3">
                        @foreach (var configWithNav in panelWithItems.Items)
                        {
                            var capturedConfig = configWithNav;
                            var capturedPanelId = panel.Id;
                            <div class="col-xl-2 col-lg-3 col-md-4 col-sm-4 col-4"
                                 draggable="@(isEditMode ? "true" : "false")"
                                 @ondragstart="@(() => HandleDragStart(capturedConfig, capturedPanelId))"
                                 @ondragover:preventDefault="true"
                                 @ondragover="@(() => HandleDragOver(capturedConfig))"
                                 @ondrop="@(() => HandleDrop(capturedConfig, capturedPanelId))">

                                <DashboardShortcutCard NavigationItem="@capturedConfig.NavigationItem"
                                                       IsEditMode="@isEditMode"
                                                       OnClick="@(() => HandleWidgetClick(capturedConfig.NavigationItem))"
                                                       OnRemove="@(() => HandleRemoveWidget(capturedConfig, panelWithItems))" />
                            </div>
                        }

                        @if (isEditMode)
                        {
                            <div class="col-xl-2 col-lg-3 col-md-4 col-sm-4 col-4">
                                <div class="add-shortcut-card" @onclick="@(() => OpenWidgetPicker(panel.Id))">
                                    <i class="bi bi-plus-circle"></i>
                                    <span>新增項目</span>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-4">
                        <i class="bi bi-grid-1x2 text-muted" style="font-size: 2.5rem;"></i>
                        <p class="text-muted mt-3 mb-2">此區塊尚無項目</p>
                        @if (isEditMode)
                        {
                            <GenericButtonComponent Variant="ButtonVariant.DarkBlue"
                                                    Size="ButtonSize.Small"
                                                    Text="新增項目"
                                                    OnClick="@(() => OpenWidgetPicker(panel.Id))" />
                        }
                    </div>
                }
            </div>
        }

        @* 區塊管理按鈕區 *@
        <div class="text-center mt-4 mb-4">
            @if (panels.Count < DashboardDefaults.MaxPanelCount)
            {
                <GenericButtonComponent Variant="ButtonVariant.DarkBlue"
                                        Size="ButtonSize.Normal"
                                        Text="新增區塊"
                                        OnClick="@HandleCreatePanel" />
            }
            <GenericButtonComponent Variant="ButtonVariant.Orange"
                                    Size="ButtonSize.Normal"
                                    Text="恢復預設"
                                    Title="將首頁恢復為系統預設配置"
                                    CssClass="ms-2"
                                    OnClick="@HandleResetAllToDefault" />
        </div>

        @* 沒有任何區塊時的空狀態 *@
        @if (!panels.Any())
        {
            <div class="text-center py-5">
                <i class="bi bi-grid text-muted" style="font-size: 4rem;"></i>
                <p class="text-muted mt-3 mb-3">尚未設定任何區塊</p>
                <GenericButtonComponent Variant="ButtonVariant.DarkBlue"
                                        Size="ButtonSize.Normal"
                                        IconClass="bi bi-plus-lg"
                                        Text="建立第一個區塊"
                                        OnClick="@HandleCreatePanel" />
                <GenericButtonComponent Variant="ButtonVariant.Orange"
                                        Size="ButtonSize.Normal"
                                        Text="恢復預設"
                                        CssClass="ms-2"
                                        OnClick="@HandleResetAllToDefault" />
            </div>
        }
    }

</div>

@* 新增項目選擇 Modal（三個 Tab：頁面連結 / 快速功能 / 圖表介面） *@
<DashboardWidgetPickerModal IsVisible="@showWidgetPicker"
                            IsVisibleChanged="@((bool v) => showWidgetPicker = v)"
                            AvailableShortcutWidgets="@availableShortcutWidgets"
                            AvailableQuickActionWidgets="@availableQuickActionWidgets"
                            AvailableChartWidgets="@availableChartWidgets"
                            ExistingWidgetKeys="@currentPickerExistingKeys"
                            OnConfirm="@HandleAddWidgets" />

@* 重置確認 Modal *@
<GenericConfirmModalComponent IsVisible="@showResetConfirm"
                             IsVisibleChanged="@((bool v) => showResetConfirm = v)"
                             Title="恢復預設配置"
                             Icon="bi-arrow-counterclockwise"
                             Message="確定要將首頁恢復為預設配置嗎？所有自訂區塊將被清除，並重新建立預設的「頁面捷徑」與「快速功能」區塊。"
                             ConfirmButtonText="確定恢復"
                             HeaderColor="BaseModalComponent.HeaderVariant.Warning"
                             OnConfirm="@ConfirmResetAllToDefault" />

@* 刪除區塊確認 Modal *@
<GenericConfirmModalComponent IsVisible="@showDeletePanelConfirm"
                             IsVisibleChanged="@((bool v) => showDeletePanelConfirm = v)"
                             Title="刪除區塊"
                             Icon="bi-trash"
                             Message="@deleteConfirmMessage"
                             ConfirmButtonText="確定"
                             HeaderColor="BaseModalComponent.HeaderVariant.Danger"
                             OnConfirm="@ConfirmDeletePanel" />

@* 新增區塊 Modal *@
<BaseModalComponent IsVisible="@showCreatePanelModal"
                    IsVisibleChanged="@((bool v) => showCreatePanelModal = v)"
                    Title="新增區塊"
                    Size="BaseModalComponent.ModalSize.Small"
                    HeaderColor="BaseModalComponent.HeaderVariant.Primary"
                    UseWhiteCloseButton="true">
    <HeaderButtons>
        <GenericButtonComponent Variant="ButtonVariant.Blue"
                               Text="建立"
                               OnClick="@ConfirmCreatePanel"
                               IsDisabled="@string.IsNullOrWhiteSpace(newPanelTitle)" />
        <GenericButtonComponent Variant="ButtonVariant.Red"
                               Text="取消"
                               OnClick="@CancelCreatePanel" />
    </HeaderButtons>
    <BodyContent>
        <div class="mb-3">
            <label class="form-label">區塊標題</label>
            <input type="text"
                   class="form-control"
                   placeholder="請輸入區塊標題"
                   maxlength="@DashboardDefaults.MaxPanelTitleLength"
                   @bind="newPanelTitle"
                   @bind:event="oninput" />
            <div class="form-text">最多 @DashboardDefaults.MaxPanelTitleLength 字</div>
        </div>
    </BodyContent>
</BaseModalComponent>

@* ==================== 圖示選擇 Modal ==================== *@
<IconPickerModal IsVisible="@showIconPicker"
                 IsVisibleChanged="@((bool v) => showIconPicker = v)"
                 CurrentIcon="@iconPickerCurrentIcon"
                 OnConfirm="@HandleIconSelected" />

@* ==================== 公司設定確認 Modal ==================== *@
<GenericConfirmModalComponent IsVisible="@showCompanySetupConfirm"
                             IsVisibleChanged="@((bool v) => showCompanySetupConfirm = v)"
                             Title="設定公司資料"
                             Icon="bi-building"
                             Message="系統尚未設定公司資料，是否立即設定？"
                             ConfirmButtonText="立即設定"
                             CancelButtonText="稍後設定"
                             HeaderColor="BaseModalComponent.HeaderVariant.Primary"
                             OnConfirm="@OpenCompanySetupModal" />

@* ==================== 公司編輯 Modal ==================== *@
<CompanyEditModalComponent IsVisible="@showCompanyEditModal"
                          IsVisibleChanged="@((bool v) => showCompanyEditModal = v)"
                          CompanyId="@null"
                          OnCompanySaved="@HandleCompanySetupComplete"
                          OnCancel="@(() => showCompanyEditModal = false)" />

@* ==================== 快速功能 Modal Host ==================== *@
<QuickActionModalHost @ref="quickActionHost" 
                      ConfiguredActionIds="@GetConfiguredQuickActionIds()" />

@code {
    // ===== 狀態欄位 =====
    private int currentEmployeeId = 0;
    private bool isLoading = true;

    // 公司資料
    private Company? primaryCompany;
    private bool showCompanySetupConfirm = false;
    private bool showCompanyEditModal = false;

    // 區塊資料
    private List<DashboardPanelWithItems> panels = new();

    // 編輯狀態
    private int? editingPanelId = null;

    // Widget Picker Modal 狀態
    private bool showWidgetPicker = false;
    private List<NavigationItem> availableShortcutWidgets = new();
    private List<NavigationItem> availableQuickActionWidgets = new();
    private List<NavigationItem> availableChartWidgets = new();
    private HashSet<string> currentPickerExistingKeys = new();
    private int currentPickerPanelId = 0;

    // 重置確認 Modal
    private bool showResetConfirm = false;

    // 刪除區塊確認 Modal
    private bool showDeletePanelConfirm = false;
    private string deleteConfirmMessage = "";
    private int deletePanelId = 0;

    // 新增區塊 Modal
    private bool showCreatePanelModal = false;
    private string newPanelTitle = "";

    // 圖示選擇器 Modal
    private bool showIconPicker = false;
    private int iconPickerPanelId = 0;
    private string? iconPickerCurrentIcon = null;

    // 拖曳排序
    private DashboardConfigWithNavItem? draggedItem = null;
    private int draggedPanelId = 0;

    // QuickAction Modal Host
    private QuickActionModalHost? quickActionHost;

    // ===== 生命週期 =====

    protected override async Task OnInitializedAsync()
    {
        // 載入預設公司資料
        await LoadPrimaryCompanyAsync();

        var employeeId = await CurrentUserHelper.GetCurrentEmployeeIdAsync(AuthenticationStateProvider);

        if (employeeId.HasValue)
        {
            currentEmployeeId = employeeId.Value;
            await LoadDashboardAsync();
        }

        isLoading = false;
    }

    // ===== 資料載入 =====

    /// <summary>
    /// 載入預設公司資料
    /// </summary>
    private async Task LoadPrimaryCompanyAsync()
    {
        try
        {
            primaryCompany = await CompanyService.GetPrimaryCompanyAsync();
            
            // 如果沒有任何公司資料，顯示設定提示
            if (primaryCompany == null)
            {
                showCompanySetupConfirm = true;
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadPrimaryCompanyAsync), GetType());
        }
    }

    private async Task LoadDashboardAsync()
    {
        try
        {
            panels = await DashboardService.GetEmployeePanelsAsync(currentEmployeeId);
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDashboardAsync), GetType());
            await NotificationService.ShowErrorAsync("載入首頁配置失敗");
        }
    }

    /// <summary>
    /// 取得已配置的快速功能 ActionId 清單，用於 QuickActionModalHost 預先渲染
    /// </summary>
    private List<string> GetConfiguredQuickActionIds()
    {
        return panels
            .SelectMany(p => p.Items)
            .Where(c => c.NavigationItem?.ItemType == NavigationItemType.QuickAction && c.NavigationItem?.ActionId != null)
            .Select(c => c.NavigationItem!.ActionId!)
            .Distinct()
            .ToList();
    }

    // ===== 區塊編輯 =====

    private void StartEditPanel(int panelId)
    {
        editingPanelId = panelId;
    }

    private void FinishEditPanel()
    {
        editingPanelId = null;
    }

    private async Task HandlePanelTitleChange(int panelId, string? newTitle)
    {
        if (string.IsNullOrWhiteSpace(newTitle)) return;

        try
        {
            var result = await DashboardService.UpdatePanelTitleAsync(panelId, newTitle);
            if (result.IsSuccess)
            {
                var panel = panels.FirstOrDefault(p => p.Panel.Id == panelId);
                if (panel != null)
                {
                    panel.Panel.Title = newTitle.Trim();
                }
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandlePanelTitleChange), GetType());
            await NotificationService.ShowErrorAsync("更新標題失敗");
        }
    }

    // ===== 圖示編輯 =====

    /// <summary>
    /// 開啟圖示選擇器 Modal
    /// </summary>
    private void OpenIconPicker(int panelId, string? currentIcon)
    {
        iconPickerPanelId = panelId;
        iconPickerCurrentIcon = currentIcon;
        showIconPicker = true;
    }

    /// <summary>
    /// 處理圖示選擇確認
    /// </summary>
    private async Task HandleIconSelected(string iconClass)
    {
        try
        {
            var result = await DashboardService.UpdatePanelIconAsync(iconPickerPanelId, iconClass);
            if (result.IsSuccess)
            {
                var panel = panels.FirstOrDefault(p => p.Panel.Id == iconPickerPanelId);
                if (panel != null)
                {
                    panel.Panel.IconClass = iconClass;
                }
                await NotificationService.ShowSuccessAsync("圖示已更新");
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleIconSelected), GetType());
            await NotificationService.ShowErrorAsync("更新圖示失敗");
        }
        finally
        {
            showIconPicker = false;
        }
    }

    // ===== 新增區塊 =====

    private void HandleCreatePanel()
    {
        newPanelTitle = "";
        showCreatePanelModal = true;
    }

    private void CancelCreatePanel()
    {
        newPanelTitle = "";
        showCreatePanelModal = false;
    }

    private async Task ConfirmCreatePanel()
    {
        if (string.IsNullOrWhiteSpace(newPanelTitle))
        {
            await NotificationService.ShowWarningAsync("請輸入區塊標題");
            return;
        }

        try
        {
            var result = await DashboardService.CreatePanelAsync(currentEmployeeId, newPanelTitle);
            if (result.IsSuccess && result.Data != null)
            {
                panels.Add(result.Data);
                editingPanelId = result.Data.Panel.Id; // 自動進入編輯模式
                showCreatePanelModal = false;
                newPanelTitle = "";
                await NotificationService.ShowSuccessAsync("區塊已建立");
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ConfirmCreatePanel), GetType());
            await NotificationService.ShowErrorAsync("建立區塊失敗");
        }
    }

    // ===== 刪除區塊 =====

    private void HandleDeletePanel(EmployeeDashboardPanel panel)
    {
        deletePanelId = panel.Id;
        deleteConfirmMessage = $"確定要刪除「{panel.Title}」區塊嗎？區塊內的所有項目將一併刪除。";
        showDeletePanelConfirm = true;
    }

    private async Task ConfirmDeletePanel()
    {
        try
        {
            var result = await DashboardService.DeletePanelAsync(deletePanelId);
            if (result.IsSuccess)
            {
                panels.RemoveAll(p => p.Panel.Id == deletePanelId);
                editingPanelId = null;
                await NotificationService.ShowSuccessAsync("區塊已刪除");
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ConfirmDeletePanel), GetType());
            await NotificationService.ShowErrorAsync("刪除區塊失敗");
        }
    }

    // ===== 恢復預設配置 =====

    /// <summary>
    /// 顯示恢復預設配置確認 Modal
    /// </summary>
    private void HandleResetAllToDefault()
    {
        showResetConfirm = true;
    }

    /// <summary>
    /// 確認恢復預設配置，刪除所有自訂區塊並重建預設區塊
    /// </summary>
    private async Task ConfirmResetAllToDefault()
    {
        try
        {
            var result = await DashboardService.ResetAllPanelsToDefaultAsync(currentEmployeeId);
            if (result.IsSuccess)
            {
                editingPanelId = null; // 退出編輯模式
                await NotificationService.ShowSuccessAsync("已恢復為預設配置");
                await LoadDashboardAsync();
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ConfirmResetAllToDefault), GetType());
            await NotificationService.ShowErrorAsync("恢復預設配置失敗");
        }
    }

    // ===== 捷徑點擊處理 =====

    private void HandleWidgetClick(NavigationItem navItem)
    {
        try
        {
            switch (navItem.ItemType)
            {
                case NavigationItemType.Route:
                    if (!string.IsNullOrEmpty(navItem.Route) && navItem.Route != "#")
                    {
                        NavigationManager.NavigateTo(navItem.Route);
                    }
                    break;

                case NavigationItemType.Action:
                    if (!string.IsNullOrEmpty(navItem.ActionId) && NavigationActionHandler != null)
                    {
                        NavigationActionHandler.Invoke(navItem.ActionId);
                    }
                    break;

                case NavigationItemType.QuickAction:
                    if (!string.IsNullOrEmpty(navItem.ActionId))
                    {
                        quickActionHost?.Open(navItem.ActionId);
                    }
                    break;
            }
        }
        catch (Exception ex)
        {
            _ = ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleWidgetClick), GetType());
            _ = NotificationService.ShowErrorAsync("開啟功能失敗");
        }
    }

    // ===== 新增項目 =====

    private async Task OpenWidgetPicker(int panelId)
    {
        try
        {
            currentPickerPanelId = panelId;
            
            // 同時載入三種類型的可用項目
            var loadTasks = new[]
            {
                DashboardService.GetAvailableWidgetsAsync(currentEmployeeId, false),
                DashboardService.GetAvailableWidgetsAsync(currentEmployeeId, true),
                DashboardService.GetAvailableChartWidgetsAsync(currentEmployeeId)
            };
            await Task.WhenAll(loadTasks);
            availableShortcutWidgets = loadTasks[0].Result;
            availableQuickActionWidgets = loadTasks[1].Result;
            availableChartWidgets = loadTasks[2].Result;
            currentPickerExistingKeys = await DashboardService.GetPanelExistingKeysAsync(panelId);
            
            showWidgetPicker = true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(OpenWidgetPicker), GetType());
            await NotificationService.ShowErrorAsync("載入可用項目失敗");
        }
    }

    private async Task HandleAddWidgets(List<string> navigationItemKeys)
    {
        try
        {
            var result = await DashboardService.AddWidgetBatchAsync(currentPickerPanelId, navigationItemKeys);

            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync("項目已新增");
                await LoadDashboardAsync();
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleAddWidgets), GetType());
            await NotificationService.ShowErrorAsync("新增項目失敗");
        }
    }

    // ===== 移除項目 =====

    private async Task HandleRemoveWidget(DashboardConfigWithNavItem configWithNav, DashboardPanelWithItems panelWithItems)
    {
        try
        {
            var result = await DashboardService.RemoveWidgetAsync(configWithNav.Config.Id);

            if (result.IsSuccess)
            {
                panelWithItems.Items.Remove(configWithNav);
                await NotificationService.ShowSuccessAsync("已移除");
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleRemoveWidget), GetType());
            await NotificationService.ShowErrorAsync("移除失敗");
        }
    }

    // ===== 拖曳排序 =====

    private void HandleDragStart(DashboardConfigWithNavItem configWithNav, int panelId)
    {
        draggedItem = configWithNav;
        draggedPanelId = panelId;
    }

    private void HandleDragOver(DashboardConfigWithNavItem target)
    {
        // 僅觸發 UI 效果
    }

    private async Task HandleDrop(DashboardConfigWithNavItem target, int panelId)
    {
        // 不允許跨區塊拖曳
        if (draggedItem == null || draggedPanelId != panelId || draggedItem.Config.Id == target.Config.Id)
        {
            draggedItem = null;
            return;
        }

        try
        {
            var panelWithItems = panels.FirstOrDefault(p => p.Panel.Id == panelId);
            if (panelWithItems == null) return;

            var items = panelWithItems.Items;
            var oldIndex = items.IndexOf(draggedItem);
            var newIndex = items.IndexOf(target);

            if (oldIndex >= 0 && newIndex >= 0)
            {
                items.RemoveAt(oldIndex);
                items.Insert(newIndex, draggedItem);

                var configIds = items.Select(c => c.Config.Id).ToList();
                var result = await DashboardService.UpdateItemSortOrderAsync(panelId, configIds);

                if (!result.IsSuccess)
                {
                    await LoadDashboardAsync();
                    await NotificationService.ShowErrorAsync("排序更新失敗");
                }
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDrop), GetType());
            await NotificationService.ShowErrorAsync("排序更新失敗");
        }
        finally
        {
            draggedItem = null;
        }
    }

    // ===== 公司設定處理 =====

    /// <summary>
    /// 開啟公司設定 Modal
    /// </summary>
    private void OpenCompanySetupModal()
    {
        showCompanySetupConfirm = false;
        showCompanyEditModal = true;
    }

    /// <summary>
    /// 處理公司設定完成事件
    /// </summary>
    private async Task HandleCompanySetupComplete(Company savedCompany)
    {
        try
        {
            // 將新建立的公司設為預設
            await CompanyService.SetDefaultCompanyAsync(savedCompany.Id);

            // 重新載入公司資料
            primaryCompany = savedCompany;
            primaryCompany.IsDefault = true;

            showCompanyEditModal = false;
            await NotificationService.ShowSuccessAsync("公司設定完成");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleCompanySetupComplete), GetType());
            await NotificationService.ShowErrorAsync("設定公司時發生錯誤");
        }
    }

    // ===== 資源清理 =====

    public void Dispose()
    {
        // 目前沒有需要清理的資源
    }
}
