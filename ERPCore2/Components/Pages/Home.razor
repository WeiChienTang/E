@page "/"
@attribute [Authorize]
@using ERPCore2.Data.Entities
@using ERPCore2.Data.Navigation
@using ERPCore2.Models.Navigation
@using ERPCore2.Components.Shared.Dashboard
@inject IDashboardService DashboardService
@inject INotificationService NotificationService
@inject IPermissionService PermissionService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>美莊磚業 - 系統首頁</PageTitle>

@* 從 MainLayout 接收 Action 處理器 *@
@code {
    [CascadingParameter(Name = "NavigationActionHandler")]
    private Action<string>? NavigationActionHandler { get; set; }
}

<div class="container-fluid">

    @* 頂部工具列 *@
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0 fw-bold">
            <i class="bi bi-house-fill me-2"></i>系統首頁
        </h5>
        <div>
            @if (isEditMode)
            {
                <button class="btn btn-outline-warning btn-sm me-2" @onclick="HandleResetToDefault" title="重置為預設配置">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>重置預設
                </button>
                <button class="btn btn-primary btn-sm" @onclick="ToggleEditMode">
                    <i class="bi bi-check-lg me-1"></i>完成編輯
                </button>
            }
            else
            {
                <button class="btn btn-outline-secondary btn-sm" @onclick="ToggleEditMode" title="編輯首頁捷徑">
                    <i class="bi bi-pencil-square me-1"></i>編輯首頁
                </button>
            }
        </div>
    </div>

    @* 捷徑卡片區域 *@
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">載入中...</span>
            </div>
            <p class="text-muted mt-2">載入首頁配置中...</p>
        </div>
    }
    else if (dashboardConfigs.Any())
    {
        <div class="row g-3">
            @foreach (var configWithNav in dashboardConfigs)
            {
                var capturedConfig = configWithNav;
                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6"
                     draggable="@(isEditMode ? "true" : "false")"
                     @ondragstart="@(() => HandleDragStart(capturedConfig))"
                     @ondragover:preventDefault="true"
                     @ondragover="@(() => HandleDragOver(capturedConfig))"
                     @ondrop="@(() => HandleDrop(capturedConfig))">

                    <DashboardShortcutCard NavigationItem="@capturedConfig.NavigationItem"
                                           IsEditMode="@isEditMode"
                                           OnClick="@(() => HandleWidgetClick(capturedConfig.NavigationItem))"
                                           OnRemove="@(() => HandleRemoveWidget(capturedConfig))" />
                </div>
            }

            @* 編輯模式下的「新增捷徑」卡片 *@
            @if (isEditMode)
            {
                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                    <div class="add-shortcut-card" @onclick="OpenWidgetPicker">
                        <i class="bi bi-plus-circle fs-2"></i>
                        <span class="small fw-semibold mt-1">新增捷徑</span>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-center py-5">
            <i class="bi bi-grid-1x2 text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-3 mb-2">尚未設定首頁捷徑</p>
            <button class="btn btn-primary btn-sm" @onclick="OpenWidgetPicker">
                <i class="bi bi-plus-lg me-1"></i>新增捷徑
            </button>
        </div>
    }

</div>

@* 新增捷徑選擇 Modal *@
<DashboardWidgetPickerModal IsVisible="@showWidgetPicker"
                            IsVisibleChanged="@((bool v) => showWidgetPicker = v)"
                            AvailableWidgets="@availableWidgets"
                            ExistingWidgetKeys="@existingWidgetKeys"
                            OnConfirm="@HandleAddWidgets" />

@* 重置確認 Modal *@
<GenericConfirmModalComponent IsVisible="@showResetConfirm"
                             IsVisibleChanged="@((bool v) => showResetConfirm = v)"
                             Title="重置首頁配置"
                             Icon="bi-arrow-counterclockwise"
                             Message="確定要將首頁捷徑重置為預設配置嗎？現有的自訂配置將被清除。"
                             ConfirmButtonText="確定重置"
                             HeaderColor="BaseModalComponent.HeaderVariant.Warning"
                             OnConfirm="@ConfirmResetToDefault" />

@code {
    // ===== 狀態欄位 =====
    private int currentEmployeeId = 0;
    private bool isLoading = true;
    private bool isEditMode = false;

    // 儀表板配置
    private List<DashboardConfigWithNavItem> dashboardConfigs = new();
    private List<NavigationItem> availableWidgets = new();
    private HashSet<string> existingWidgetKeys = new();

    // Modal 狀態
    private bool showWidgetPicker = false;
    private bool showResetConfirm = false;

    // 拖曳排序
    private DashboardConfigWithNavItem? draggedItem = null;

    // ===== 生命週期 =====

    protected override async Task OnInitializedAsync()
    {
        var employeeId = await CurrentUserHelper.GetCurrentEmployeeIdAsync(AuthenticationStateProvider);

        if (employeeId.HasValue)
        {
            currentEmployeeId = employeeId.Value;
            await LoadDashboardAsync();
        }

        isLoading = false;
    }

    // ===== 資料載入 =====

    private async Task LoadDashboardAsync()
    {
        try
        {
            dashboardConfigs = await DashboardService.GetEmployeeDashboardAsync(currentEmployeeId);
            UpdateExistingWidgetKeys();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(LoadDashboardAsync), GetType());
            await NotificationService.ShowErrorAsync("載入首頁配置失敗");
        }
    }

    private void UpdateExistingWidgetKeys()
    {
        existingWidgetKeys = dashboardConfigs
            .Select(c => c.Config.NavigationItemKey)
            .ToHashSet();
    }

    // ===== 編輯模式 =====

    private void ToggleEditMode()
    {
        isEditMode = !isEditMode;
    }

    // ===== 捷徑點擊處理 =====

    private void HandleWidgetClick(NavigationItem navItem)
    {
        try
        {
            switch (navItem.ItemType)
            {
                case NavigationItemType.Route:
                    if (!string.IsNullOrEmpty(navItem.Route) && navItem.Route != "#")
                    {
                        NavigationManager.NavigateTo(navItem.Route);
                    }
                    break;

                case NavigationItemType.Action:
                    if (!string.IsNullOrEmpty(navItem.ActionId) && NavigationActionHandler != null)
                    {
                        NavigationActionHandler.Invoke(navItem.ActionId);
                    }
                    break;
            }
        }
        catch (Exception ex)
        {
            _ = ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleWidgetClick), GetType());
            _ = NotificationService.ShowErrorAsync("開啟功能失敗");
        }
    }

    // ===== 新增捷徑 =====

    private async Task OpenWidgetPicker()
    {
        try
        {
            availableWidgets = await DashboardService.GetAvailableWidgetsAsync(currentEmployeeId);
            UpdateExistingWidgetKeys();
            showWidgetPicker = true;
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(OpenWidgetPicker), GetType());
            await NotificationService.ShowErrorAsync("載入可用捷徑失敗");
        }
    }

    private async Task HandleAddWidgets(List<string> navigationItemKeys)
    {
        try
        {
            var result = await DashboardService.AddWidgetBatchAsync(currentEmployeeId, navigationItemKeys);

            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync("捷徑已新增");
                await LoadDashboardAsync();
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleAddWidgets), GetType());
            await NotificationService.ShowErrorAsync("新增捷徑失敗");
        }
    }

    // ===== 移除捷徑 =====

    private async Task HandleRemoveWidget(DashboardConfigWithNavItem configWithNav)
    {
        try
        {
            var result = await DashboardService.RemoveWidgetAsync(currentEmployeeId, configWithNav.Config.Id);

            if (result.IsSuccess)
            {
                dashboardConfigs.Remove(configWithNav);
                UpdateExistingWidgetKeys();
                await NotificationService.ShowSuccessAsync("已移除捷徑");
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleRemoveWidget), GetType());
            await NotificationService.ShowErrorAsync("移除捷徑失敗");
        }
    }

    // ===== 重置預設 =====

    private void HandleResetToDefault()
    {
        showResetConfirm = true;
    }

    private async Task ConfirmResetToDefault()
    {
        try
        {
            var result = await DashboardService.ResetToDefaultAsync(currentEmployeeId);

            if (result.IsSuccess)
            {
                await NotificationService.ShowSuccessAsync("已重置為預設配置");
                await LoadDashboardAsync();
                isEditMode = false;
            }
            else
            {
                await NotificationService.ShowErrorAsync(result.ErrorMessage);
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(ConfirmResetToDefault), GetType());
            await NotificationService.ShowErrorAsync("重置配置失敗");
        }
    }

    // ===== 拖曳排序 =====

    private void HandleDragStart(DashboardConfigWithNavItem configWithNav)
    {
        draggedItem = configWithNav;
    }

    private void HandleDragOver(DashboardConfigWithNavItem target)
    {
        // 僅觸發 UI 效果，實際排序在 Drop 時處理
    }

    private async Task HandleDrop(DashboardConfigWithNavItem target)
    {
        if (draggedItem == null || draggedItem.Config.Id == target.Config.Id)
        {
            draggedItem = null;
            return;
        }

        try
        {
            // 在本地清單中調整順序
            var oldIndex = dashboardConfigs.IndexOf(draggedItem);
            var newIndex = dashboardConfigs.IndexOf(target);

            if (oldIndex >= 0 && newIndex >= 0)
            {
                dashboardConfigs.RemoveAt(oldIndex);
                dashboardConfigs.Insert(newIndex, draggedItem);

                // 儲存新排序到資料庫
                var configIds = dashboardConfigs.Select(c => c.Config.Id).ToList();
                var result = await DashboardService.UpdateSortOrderAsync(currentEmployeeId, configIds);

                if (!result.IsSuccess)
                {
                    // 排序儲存失敗，重新載入
                    await LoadDashboardAsync();
                    await NotificationService.ShowErrorAsync("排序更新失敗");
                }
            }
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(ex, nameof(HandleDrop), GetType());
            await NotificationService.ShowErrorAsync("排序更新失敗");
        }
        finally
        {
            draggedItem = null;
        }
    }

    // ===== 資源清理 =====

    public void Dispose()
    {
        // 目前沒有需要清理的資源
    }
}
