@page "/inventoryoverview"
@using ERPCore2.Data.Entities
@using ERPCore2.Services
@using ERPCore2.Services.Inventory
@using ERPCore2.Helpers
@using Microsoft.AspNetCore.Components.Web
@inject IInventoryStockService InventoryStockService
@inject IProductService ProductService
@inject IWarehouseService WarehouseService
@inject IWarehouseLocationService WarehouseLocationService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

@rendermode InteractiveServer

<PageTitle>庫存查詢總覽</PageTitle>

<div class="page-header">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <!-- 麵包屑導航 -->
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">首頁</a></li>
                        <li class="breadcrumb-item">庫存管理</li>
                        <li class="breadcrumb-item active" aria-current="page">庫存查詢總覽</li>
                    </ol>
                </nav>
                
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 mb-1">庫存查詢總覽</h1>
                        <p class="text-muted mb-0">即時查看所有商品的庫存狀況與警戒提醒</p>
                    </div>
                    <div class="btn-toolbar" role="toolbar">
                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-outline-success" @onclick="ExportToExcel">
                                <i class="fas fa-file-excel me-1"></i>匯出Excel
                            </button>
                            <button type="button" class="btn btn-outline-primary" @onclick="RefreshData">
                                <i class="fas fa-sync-alt me-1"></i>重新整理
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- 統計卡片 -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                總商品數量
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@statistics.GetValueOrDefault("TotalProducts", 0)</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-boxes fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                總庫存價值
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">$@(((decimal)statistics.GetValueOrDefault("TotalInventoryValue", 0m)).ToString("N0"))</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                低庫存警戒
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@statistics.GetValueOrDefault("LowStockCount", 0)</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                零庫存商品
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@statistics.GetValueOrDefault("ZeroStockCount", 0)</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-ban fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 篩選區 -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">篩選條件</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="warehouseFilter" class="form-label">倉庫</label>
                    <select id="warehouseFilter" class="form-select" @bind="selectedWarehouseId" @bind:after="OnFilterChanged">
                        <option value="">全部倉庫</option>
                        @foreach (var warehouse in warehouses)
                        {
                            <option value="@warehouse.Id">@warehouse.WarehouseName</option>
                        }
                    </select>
                </div>
                
                <div class="col-md-3 mb-3">
                    <label for="categoryFilter" class="form-label">商品分類</label>
                    <select id="categoryFilter" class="form-select" @bind="selectedCategoryId" @bind:after="OnFilterChanged">
                        <option value="">全部分類</option>
                        @foreach (var category in productCategories)
                        {
                            <option value="@category.Id">@category.CategoryName</option>
                        }
                    </select>
                </div>
                
                <div class="col-md-3 mb-3">
                    <label for="locationFilter" class="form-label">庫位</label>
                    <select id="locationFilter" class="form-select" @bind="selectedLocationId" @bind:after="OnFilterChanged" disabled="@(selectedWarehouseId == null)">
                        <option value="">全部庫位</option>
                        @foreach (var location in filteredLocations)
                        {
                            <option value="@location.Id">@location.LocationCode - @location.LocationName</option>
                        }
                    </select>
                </div>
                
                <div class="col-md-3 mb-3">
                    <label for="stockStatusFilter" class="form-label">庫存狀態</label>
                    <select id="stockStatusFilter" class="form-select" @bind="stockStatusFilter" @bind:after="OnFilterChanged">
                        <option value="">全部狀態</option>
                        <option value="normal">正常庫存</option>
                        <option value="low">低庫存</option>
                        <option value="zero">零庫存</option>
                    </select>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="searchTerm" class="form-label">搜尋</label>
                    <div class="input-group">
                        <input type="text" id="searchTerm" class="form-control" placeholder="輸入商品代碼或名稱..." @bind="searchTerm" @onkeypress="OnSearchKeyPress">
                        <button class="btn btn-outline-secondary" type="button" @onclick="OnFilterChanged">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                
                <div class="col-md-6 mb-3 d-flex align-items-end">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-warning" @onclick="ShowLowStockOnly">
                            <i class="fas fa-exclamation-triangle me-1"></i>僅顯示低庫存
                        </button>
                        <button type="button" class="btn btn-outline-secondary" @onclick="ClearFilters">
                            <i class="fas fa-times me-1"></i>清除篩選
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 庫存清單 -->
    <div class="card shadow">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">庫存清單</h6>
            <span class="badge bg-primary">共 @filteredInventoryStocks.Count 筆資料</span>
        </div>
        <div class="card-body p-0">
            @if (isLoading)
            {
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">載入中...</span>
                    </div>
                    <p class="mt-2 text-muted">載入庫存資料中...</p>
                </div>
            }
            else if (!filteredInventoryStocks.Any())
            {
                <div class="text-center p-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">沒有找到符合條件的庫存資料</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 120px;">商品代碼</th>
                                <th>商品名稱</th>
                                <th style="width: 100px;">分類</th>
                                <th style="width: 80px;">單位</th>
                                <th style="width: 120px;">倉庫</th>
                                <th style="width: 100px;">庫位</th>
                                <th style="width: 80px;" class="text-end">現有庫存</th>
                                <th style="width: 80px;" class="text-end">預留庫存</th>
                                <th style="width: 80px;" class="text-end">可用庫存</th>
                                <th style="width: 80px;" class="text-end">警戒線</th>
                                <th style="width: 100px;" class="text-center">狀態</th>
                                <th style="width: 120px;" class="text-end">平均成本</th>
                                <th style="width: 120px;">最後異動</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in pagedInventoryStocks)
                            {
                                var isLowStock = item.MinStockLevel.HasValue && item.CurrentStock <= item.MinStockLevel.Value;
                                var isZeroStock = item.CurrentStock == 0;
                                
                                <tr class="@(isZeroStock ? "table-danger" : isLowStock ? "table-warning" : "")">
                                    <td>
                                        <code>@item.Product.ProductCode</code>
                                    </td>
                                    <td>
                                        <strong>@item.Product.ProductName</strong>
                                        @if (!string.IsNullOrEmpty(item.Product.Description))
                                        {
                                            <br><small class="text-muted">@item.Product.Description</small>
                                        }
                                    </td>
                                    <td>
                                        @(item.Product.ProductCategory?.CategoryName ?? "-")
                                    </td>
                                    <td>
                                        @(item.Product.Unit?.UnitName ?? "-")
                                    </td>
                                    <td>
                                        <span class="badge bg-info">@item.Warehouse.WarehouseName</span>
                                    </td>
                                    <td>
                                        @if (item.WarehouseLocation != null)
                                        {
                                            <span class="badge bg-secondary">@item.WarehouseLocation.LocationCode</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        <strong class="@(isZeroStock ? "text-danger" : isLowStock ? "text-warning" : "text-success")">
                                            @item.CurrentStock.ToString("N0")
                                        </strong>
                                    </td>
                                    <td class="text-end">
                                        @item.ReservedStock.ToString("N0")
                                    </td>
                                    <td class="text-end">
                                        <strong>@item.AvailableStock.ToString("N0")</strong>
                                    </td>
                                    <td class="text-end">
                                        @(item.MinStockLevel?.ToString("N0") ?? "-")
                                    </td>
                                    <td class="text-center">
                                        @if (isZeroStock)
                                        {
                                            <span class="badge bg-danger">零庫存</span>
                                        }
                                        else if (isLowStock)
                                        {
                                            <span class="badge bg-warning">低庫存</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success">正常</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        @if (item.AverageCost.HasValue)
                                        {
                                            <span>$@item.AverageCost.Value.ToString("N2")</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (item.LastTransactionDate.HasValue)
                                        {
                                            <span>@item.LastTransactionDate.Value.ToString("yyyy/MM/dd")</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                
                <!-- 分頁 -->
                @if (totalPages > 1)
                {
                    <div class="card-footer">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-muted">
                                    顯示第 @((currentPage - 1) * pageSize + 1) - @Math.Min(currentPage * pageSize, filteredInventoryStocks.Count) 筆，共 @filteredInventoryStocks.Count 筆
                                </small>
                            </div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0">
                                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                        <button class="page-link" @onclick="() => ChangePage(currentPage - 1)" disabled="@(currentPage == 1)">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                    </li>
                                    
                                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                                    {
                                        var pageNum = i;
                                        <li class="page-item @(currentPage == pageNum ? "active" : "")">
                                            <button class="page-link" @onclick="() => ChangePage(pageNum)">@pageNum</button>
                                        </li>
                                    }
                                    
                                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                        <button class="page-link" @onclick="() => ChangePage(currentPage + 1)" disabled="@(currentPage == totalPages)">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    // 資料相關
    private List<InventoryStock> inventoryStocks = new();
    private List<InventoryStock> filteredInventoryStocks = new();
    private List<InventoryStock> pagedInventoryStocks = new();
    private Dictionary<string, object> statistics = new();
    
    // 選項清單
    private List<Warehouse> warehouses = new();
    private List<ProductCategory> productCategories = new();
    private List<WarehouseLocation> warehouseLocations = new();
    private List<WarehouseLocation> filteredLocations = new();
    
    // 篩選條件
    private int? selectedWarehouseId;
    private int? selectedCategoryId;
    private int? selectedLocationId;
    private string stockStatusFilter = "";
    private string searchTerm = "";
    
    // 分頁相關
    private int currentPage = 1;
    private int pageSize = 20;
    private int totalPages = 1;
    
    // 狀態
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadBasicDataAsync();
            await LoadInventoryDataAsync();
            await LoadStatisticsAsync();
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(
                ex, 
                "庫存總覽頁面初始化", 
                GetType(), 
                Navigation
            );
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadBasicDataAsync()
    {
        warehouses = await WarehouseService.GetAllAsync();
        productCategories = await ProductService.GetProductCategoriesAsync();
        warehouseLocations = await WarehouseLocationService.GetAllAsync();
    }

    private async Task LoadInventoryDataAsync()
    {
        inventoryStocks = await InventoryStockService.GetInventoryOverviewAsync(
            selectedWarehouseId, 
            selectedCategoryId, 
            selectedLocationId
        );
        ApplyFilters();
    }

    private async Task LoadStatisticsAsync()
    {
        statistics = await InventoryStockService.GetInventoryStatisticsAsync();
    }

    private void ApplyFilters()
    {
        filteredInventoryStocks = inventoryStocks.ToList();

        // 搜尋篩選
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var term = searchTerm.Trim().ToLower();
            filteredInventoryStocks = filteredInventoryStocks.Where(i =>
                i.Product.ProductCode.ToLower().Contains(term) ||
                i.Product.ProductName.ToLower().Contains(term)
            ).ToList();
        }

        // 庫存狀態篩選
        switch (stockStatusFilter)
        {
            case "low":
                filteredInventoryStocks = filteredInventoryStocks.Where(i =>
                    i.MinStockLevel.HasValue && i.CurrentStock <= i.MinStockLevel.Value && i.CurrentStock > 0
                ).ToList();
                break;
            case "zero":
                filteredInventoryStocks = filteredInventoryStocks.Where(i => i.CurrentStock == 0).ToList();
                break;
            case "normal":
                filteredInventoryStocks = filteredInventoryStocks.Where(i =>
                    !i.MinStockLevel.HasValue || i.CurrentStock > i.MinStockLevel.Value
                ).ToList();
                break;
        }

        UpdatePagination();
    }

    private void UpdatePagination()
    {
        totalPages = (int)Math.Ceiling((double)filteredInventoryStocks.Count / pageSize);
        currentPage = Math.Min(currentPage, Math.Max(1, totalPages));
        
        pagedInventoryStocks = filteredInventoryStocks
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private async Task OnFilterChanged()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            // 更新庫位選項
            if (selectedWarehouseId.HasValue)
            {
                filteredLocations = warehouseLocations.Where(l => l.WarehouseId == selectedWarehouseId.Value).ToList();
            }
            else
            {
                filteredLocations = warehouseLocations;
                selectedLocationId = null;
            }

            await LoadInventoryDataAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await OnFilterChanged();
        }
    }

    private async Task ShowLowStockOnly()
    {
        stockStatusFilter = "low";
        await OnFilterChanged();
    }

    private async Task ClearFilters()
    {
        selectedWarehouseId = null;
        selectedCategoryId = null;
        selectedLocationId = null;
        stockStatusFilter = "";
        searchTerm = "";
        currentPage = 1;
        
        await OnFilterChanged();
    }

    private async Task RefreshData()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            await LoadInventoryDataAsync();
            await LoadStatisticsAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ChangePage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
            UpdatePagination();
        }
    }

    private async Task ExportToExcel()
    {
        try
        {
            // 這裡可以實作 Excel 匯出功能
            await JSRuntime.InvokeVoidAsync("alert", "Excel 匯出功能開發中...");
        }
        catch (Exception ex)
        {
            await ErrorHandlingHelper.HandlePageErrorAsync(
                ex, 
                "匯出Excel", 
                GetType(), 
                Navigation
            );
        }
    }
}
