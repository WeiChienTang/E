@page "/units/edit"
@page "/units/edit/{id:int?}"
@page "/inventory/units/edit"
@page "/inventory/units/edit/{id:int?}"
@inject IUnitService UnitService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>@GetPageTitle()</PageTitle>

<GenericEditPageComponent TEntity="Unit" 
                         TService="IUnitService"
                         Id="@Id"
                         Entity="@unit"
                         Service="@UnitService"
                         EntityName="單位"
                         EntityNamePlural="單位"
                         FormTitle="基本資料"
                         FormSubtitle="計量單位的基本資訊設定"
                         FormIcon="rulers"
                         IndexRoute="/inventory/units"
                         BreadcrumbItems="@breadcrumbItems"
                         UseGenericForm="true"
                         FormFields="@formFields"
                         FormSections="@formSections"
                         DataLoader="@LoadEntityAsync"
                         SaveHandler="@SaveEntityAsync"
                         CustomValidation="@ValidateEntityAsync"
                         OnSaveSuccess="@HandleSaveSuccess"
                         OnCancel="@HandleCancel">
    
</GenericEditPageComponent>

@code {
    [Parameter] public int? Id { get; set; }
    
    // 資料模型
    private Unit unit = new() 
    { 
        IsActive = true,
        IsBaseUnit = false
    };
    
    // 表單欄位定義
    private List<FormFieldDefinition> formFields = new();
    private Dictionary<string, string> formSections = new();
    
    // 麵包屑導航
    private List<GenericHeaderComponent.BreadcrumbItem> breadcrumbItems = new();

    protected override void OnParametersSet()
    {
        InitializeBreadcrumbs();
        InitializeFormFields();
    }

    private void InitializeBreadcrumbs()
    {
        breadcrumbItems = new List<GenericHeaderComponent.BreadcrumbItem>
        {
            new("首頁", "/"),
            new("庫存管理", "/inventory"),
            new("單位管理", "/inventory/units"),
            new(Id.HasValue ? "編輯單位" : "新增單位")
        };
    }

    private void InitializeFormFields()
    {
        formFields = new List<FormFieldDefinition>
        {
            new()
            {
                PropertyName = nameof(Unit.UnitCode),
                Label = "單位代碼",
                FieldType = FormFieldType.Text,
                Placeholder = "請輸入單位代碼",
                IsRequired = true,
                ContainerCssClass = "col-md-4"
            },
            new()
            {
                PropertyName = nameof(Unit.UnitName),
                Label = "單位名稱",
                FieldType = FormFieldType.Text,
                Placeholder = "請輸入單位名稱",
                IsRequired = true,
                ContainerCssClass = "col-md-8"
            },
            new()
            {
                PropertyName = nameof(Unit.Symbol),
                Label = "單位符號",
                FieldType = FormFieldType.Text,
                Placeholder = "請輸入單位符號（如：kg, m, l）",
                ContainerCssClass = "col-md-6"
            },
            new()
            {
                PropertyName = nameof(Unit.IsBaseUnit),
                Label = "設為基本單位",
                FieldType = FormFieldType.Checkbox,
                HelpText = "基本單位作為轉換的基準單位",
                ContainerCssClass = "col-md-6"
            },
            new()
            {
                PropertyName = nameof(Unit.IsActive),
                Label = "啟用狀態",
                FieldType = FormFieldType.Checkbox,
                ContainerCssClass = "col-md-6"
            }
        };

        formSections = new Dictionary<string, string>
        {
            { nameof(Unit.UnitCode), "基本資訊" },
            { nameof(Unit.UnitName), "基本資訊" },
            { nameof(Unit.Symbol), "顯示設定" },
            { nameof(Unit.IsBaseUnit), "設定選項" },
            { nameof(Unit.IsActive), "設定選項" }
        };
    }

    private string GetPageTitle()
    {
        return Id.HasValue ? "編輯單位" : "新增單位";
    }

    // GenericEditPageComponent 回調方法
    private async Task<Unit?> LoadEntityAsync()
    {
        if (!Id.HasValue) return null;
        
        var result = await UnitService.GetByIdAsync(Id.Value);
        if (result == null)
        {
            throw new InvalidOperationException($"找不到 ID 為 {Id.Value} 的單位");
        }
        return result;
    }

    private async Task<bool> SaveEntityAsync(Unit entity)
    {
        try
        {
            if (Id.HasValue)
            {
                var result = await UnitService.UpdateAsync(entity);
                if (!result.IsSuccess)
                {
                    if (OperatingSystem.IsBrowser())
                    {
                        await JSRuntime.InvokeVoidAsync("alert", $"更新失敗：{result.ErrorMessage}");
                    }
                    return false;
                }
                if (OperatingSystem.IsBrowser())
                {
                    await JSRuntime.InvokeVoidAsync("alert", "單位更新成功");
                }
            }
            else
            {
                var result = await UnitService.CreateAsync(entity);
                if (!result.IsSuccess)
                {
                    if (OperatingSystem.IsBrowser())
                    {
                        await JSRuntime.InvokeVoidAsync("alert", $"新增失敗：{result.ErrorMessage}");
                    }
                    return false;
                }
                if (OperatingSystem.IsBrowser())
                {
                    await JSRuntime.InvokeVoidAsync("alert", "單位新增成功");
                }
            }
            return true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"儲存單位資料時發生錯誤：{ex.Message}");
            if (OperatingSystem.IsBrowser())
            {
                await JSRuntime.InvokeVoidAsync("alert", $"儲存失敗：{ex.Message}");
            }
            return false;
        }
    }

    private async Task<bool> ValidateEntityAsync(Unit entity)
    {
        try
        {
            // 驗證基本資料
            if (string.IsNullOrWhiteSpace(entity.UnitCode))
            {
                if (OperatingSystem.IsBrowser())
                {
                    await JSRuntime.InvokeVoidAsync("alert", "單位代碼為必填");
                }
                return false;
            }

            if (string.IsNullOrWhiteSpace(entity.UnitName))
            {
                if (OperatingSystem.IsBrowser())
                {
                    await JSRuntime.InvokeVoidAsync("alert", "單位名稱為必填");
                }
                return false;
            }

            return true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"驗證單位資料時發生錯誤：{ex.Message}");
            return false;
        }
    }

    private Task HandleSaveSuccess()
    {
        Navigation.NavigateTo("/inventory/units");
        return Task.CompletedTask;
    }

    private Task HandleCancel()
    {
        Navigation.NavigateTo("/inventory/units");
        return Task.CompletedTask;
    }
}