@using ERPCore2.Components.Shared
@using ERPCore2.Components.Pages.Reports
@using ERPCore2.Helpers
@using Microsoft.JSInterop
@inherits LayoutComponentBase
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer
@implements IAsyncDisposable

<div class="page">    
    <div class="sidebar">
        <NavMenu OnActionTriggered="@HandleNavigationAction" />
    </div>

    <main class="main-content">
        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

@* 全域頁面搜尋 Modal *@
<PageSearchModalComponent @ref="pageSearchModal" 
                         IsVisible="@showPageSearch"
                         IsVisibleChanged="@((bool visible) => showPageSearch = visible)" />

@* 快捷鍵說明 Modal *@
<ShortcutKeysModalComponent IsVisible="@showShortcutKeys"
                           IsVisibleChanged="@((bool visible) => showShortcutKeys = visible)" />

@* 應收帳款報表 Modal *@
<AccountsReceivableReportPage IsVisible="@showAccountsReceivableReport"
                             IsVisibleChanged="@((bool visible) => showAccountsReceivableReport = visible)" />

@* 快速功能表（右下角浮動按鈕） *@
<QuickActionMenu @rendermode="InteractiveServer" 
                OnPageSearchClick="@OpenPageSearch"
                OnShortcutKeysClick="@OpenShortcutKeys" />

@code {
    // 頁面搜尋 Modal 參考
    private PageSearchModalComponent? pageSearchModal;
    private bool showPageSearch = false;
    
    // 快捷鍵說明 Modal 狀態
    private bool showShortcutKeys = false;
    
    // 應收帳款報表 Modal 狀態
    private bool showAccountsReceivableReport = false;
    
    // JavaScript 互操作
    private DotNetObjectReference<MainLayout>? dotNetReference;
    
    // Action 處理器註冊表
    private NavigationActionHelper.ActionHandlerRegistry? actionRegistry;

    protected override void OnInitialized()
    {
        // 初始化 Action 註冊表
        actionRegistry = NavigationActionHelper.CreateRegistry();
        
        // 註冊所有 Action 處理器
        actionRegistry.Register("OpenAccountsReceivableReport", OpenAccountsReceivableReport);
        
        // 未來可在此繼續註冊其他 Action
        // actionRegistry.Register("OpenAnotherModal", OpenAnotherModal);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // 建立 .NET 物件參考
                dotNetReference = DotNetObjectReference.Create(this);
                
                // 將參考設置為全域變數，讓 NavDropdownItem 可以訪問
                await JSRuntime.InvokeVoidAsync("eval", "window.mainLayoutRef = arguments[0]", dotNetReference);
                
                // 載入 keyboard-shortcuts.js 並初始化
                await JSRuntime.InvokeVoidAsync("eval", @"
                    if (!window.KeyboardShortcuts) {
                        var script = document.createElement('script');
                        script.src = '/js/keyboard-shortcuts.js';
                        document.head.appendChild(script);
                    }
                ");
                
                // 等待腳本載入
                await Task.Delay(100);
                
                // 初始化快捷鍵監聽
                await JSRuntime.InvokeVoidAsync("KeyboardShortcuts.initialize", dotNetReference);
            }
            catch
            {
                // 忽略初始化快捷鍵失敗
            }
        }
    }

    /// <summary>
    /// JavaScript 呼叫此方法以開啟頁面搜尋 Modal
    /// </summary>
    [JSInvokable]
    public async Task OpenPageSearch()
    {
        try
        {
            showPageSearch = true;
            StateHasChanged();
            
            if (pageSearchModal != null)
            {
                await pageSearchModal.Open();
            }
        }
        catch
        {
            // 忽略開啟頁面搜尋失敗
        }
    }

    /// <summary>
    /// 開啟快捷鍵說明 Modal
    /// </summary>
    private void OpenShortcutKeys()
    {
        try
        {
            showShortcutKeys = true;
            StateHasChanged();
        }
        catch
        {
            // 忽略開啟快捷鍵說明失敗
        }
    }
    
    /// <summary>
    /// 開啟應收帳款報表 Modal
    /// JavaScript 可呼叫此方法
    /// </summary>
    [JSInvokable]
    public void OpenAccountsReceivableReport()
    {
        try
        {
            showAccountsReceivableReport = true;
            StateHasChanged();
        }
        catch
        {
            // 忽略開啟應收帳款報表失敗
        }
    }
    
    /// <summary>
    /// 處理導航動作觸發
    /// </summary>
    private void HandleNavigationAction(string actionId)
    {
        // 使用 ActionHandlerRegistry 執行 Action
        actionRegistry?.Execute(actionId);
    }

    /// <summary>
    /// 清理資源
    /// </summary>
    public async ValueTask DisposeAsync()
    {
        try
        {
            // 清理 JavaScript 快捷鍵監聽器
            await JSRuntime.InvokeVoidAsync("KeyboardShortcuts.dispose");

            // 清理 .NET 物件參考
            dotNetReference?.Dispose();
        }
        catch
        {
            // 忽略清理錯誤
        }
    }
}
