@using ERPCore2.Components.Shared
@using ERPCore2.Components.Shared.Report
@using ERPCore2.Components.Pages.Reports
@using ERPCore2.Components.Pages.Employees
@using ERPCore2.Helpers
@using ERPCore2.Services
@using ERPCore2.Services.Reports.Interfaces
@using ERPCore2.Models
@using ERPCore2.Data.Navigation
@using ERPCore2.Models.Navigation
@using Microsoft.JSInterop
@inherits LayoutComponentBase
@inject IJSRuntime JSRuntime
@inject INavigationPermissionService NavigationPermissionService
@inject INavigationSearchService NavigationSearchService
@inject IReportSearchService ReportSearchService
@inject IStringLocalizer<SharedResource> L
@rendermode InteractiveServer
@implements IAsyncDisposable

<CascadingValue Value="@((Action<string>)HandleNavigationAction)" Name="NavigationActionHandler">
<div class="page">    
    <div class="sidebar">
        <NavMenu OnActionTriggered="@HandleNavigationAction" />
    </div>

    <main class="main-content">
        <article class="content px-4">
            @Body
        </article>
    </main>
</div>
</CascadingValue>

@* 全域頁面搜尋 Modal *@
<GenericSearchModalComponent @ref="pageSearchModal" 
                            IsVisible="@showPageSearch"
                            IsVisibleChanged="@((bool visible) => showPageSearch = visible)"
                            ActionRegistry="@actionRegistry"
                            Title="頁面搜尋"
                            Icon="bi-search"
                            Placeholder="輸入功能名稱或關鍵字搜尋..."
                            ResultUnitName="功能"
                            ShowIcon="false"
                            EmptyStateIcon="bi bi-lightning-charge"
                            EmptyStateMessage="開始輸入以搜尋功能頁面"
                            EmptyStateHint="支援功能名稱、關鍵字搜尋"
                            EmptyResultMessage="沒有找到符合條件的功能，請嘗試使用其他關鍵字"
                            SearchFunction="@SearchNavigationItems" />

@* 全域報表搜尋 Modal *@
<GenericSearchModalComponent @ref="reportSearchModal" 
                            IsVisible="@showReportSearch"
                            IsVisibleChanged="@((bool visible) => showReportSearch = visible)"
                            Title="報表搜尋"
                            Icon="bi-printer"
                            Placeholder="輸入報表名稱或關鍵字搜尋..."
                            ResultUnitName="報表"
                            ShowIcon="true"
                            EmptyStateIcon="bi bi-printer"
                            EmptyStateMessage="開始輸入以搜尋報表"
                            EmptyStateHint="支援報表名稱、描述、分類關鍵字搜尋"
                            EmptyResultMessage="沒有找到符合條件的報表，請嘗試使用其他關鍵字"
                            SearchFunction="@SearchReports"
                            CategoryDisplayNameFunc="@ReportSearchService.GetCategoryDisplayName"
                            OnItemSelected="@HandleReportSelected" />

@* 快捷鍵說明 Modal *@
<ShortcutKeysModalComponent IsVisible="@showShortcutKeys"
                           IsVisibleChanged="@((bool visible) => showShortcutKeys = visible)" />

@* 應收帳款報表 Modal（舊版，將逐步替換為 GenericReportFilterModalComponent） *@
<AccountsReceivableReportPage IsVisible="@showAccountsReceivableReport"
                             IsVisibleChanged="@((bool visible) => showAccountsReceivableReport = visible)" />

@* 通用報表篩選 Modal *@
<GenericReportFilterModalComponent IsVisible="@(!string.IsNullOrEmpty(currentFilterReportId))"
                                  IsVisibleChanged="@((bool visible) => { if (!visible) currentFilterReportId = string.Empty; })"
                                  ReportId="@currentFilterReportId"
                                  OnPrintSuccess="@HandleFilterPrintSuccess" />

@* 通用報表中心 Modal *@
<GenericReportIndexPage IsVisible="@(!string.IsNullOrEmpty(currentReportCategory))"
                       IsVisibleChanged="@((bool visible) => { if (!visible) currentReportCategory = string.Empty; })"
                       Category="@currentReportCategory"
                       OnReportSelected="@HandleReportSelected" />

@* 權限組權限管理 Modal *@
<RolePermissionManagement IsVisible="@showRolePermissionManagement"
                         IsVisibleChanged="@((bool visible) => showRolePermissionManagement = visible)" />

@* 客戶分析圖表 Modal *@
<CustomerChartModalComponent IsVisible="@showCustomerCharts"
                             IsVisibleChanged="@((bool visible) => showCustomerCharts = visible)" />

@* 系統參數設定 Modal *@
<SystemParameterSettingsModal IsVisible="@showSystemParameterSettings"
                             IsVisibleChanged="@((bool visible) => showSystemParameterSettings = visible)" />

@* 個人化設定 Modal *@
<PersonalPreferenceModalComponent IsVisible="@showPersonalPreference"
                                  IsVisibleChanged="@((bool visible) => showPersonalPreference = visible)" />

@* 快速功能表（右下角浮動按鈕） *@
<QuickActionMenu @rendermode="InteractiveServer"
                OnPageSearchClick="@OpenPageSearch"
                OnReportSearchClick="@OpenReportSearch"
                OnShortcutKeysClick="@OpenShortcutKeys" />

@* 模組停用提示 Modal（圖表、報表觸發被停用模組時顯示） *@
<BaseModalComponent IsVisible="@_showModuleDisabledModal"
                    IsVisibleChanged="@((bool v) => _showModuleDisabledModal = v)"
                    Title="@L["Module.NotAvailable"]"
                    Icon="bi bi-lock-fill"
                    Size="BaseModalComponent.ModalSize.Default"
                    UseWhiteCloseButton="false">
    <BodyContent>
        <div class="d-flex flex-column align-items-center justify-content-center py-4">
            <i class="bi bi-lock-fill text-secondary" style="font-size: 4rem;"></i>
            <h5 class="mt-3 text-secondary">@L["Module.NotAvailable"]</h5>
            <p class="text-muted text-center mb-0">@L["Module.DisabledMessage"]</p>
        </div>
    </BodyContent>
</BaseModalComponent>

@code {
    // 模組停用提示 Modal 狀態
    private bool _showModuleDisabledModal = false;

    // 頁面搜尋 Modal 參考
    private GenericSearchModalComponent? pageSearchModal;
    private bool showPageSearch = false;
    
    // 報表搜尋 Modal 參考
    private GenericSearchModalComponent? reportSearchModal;
    private bool showReportSearch = false;
    
    // 快捷鍵說明 Modal 狀態
    private bool showShortcutKeys = false;
    
    // 應收帳款報表 Modal 狀態
    private bool showAccountsReceivableReport = false;
    
    // 通用報表中心 Modal 狀態（存放當前開啟的報表分類，空字串表示關閉）
    private string currentReportCategory = string.Empty;
    
    // 通用報表篩選 Modal 狀態（存放當前要篩選的報表 ID，空字串表示關閉）
    private string currentFilterReportId = string.Empty;
    
    // 角色權限管理 Modal 狀態
    private bool showRolePermissionManagement = false;

    // 客戶分析圖表 Modal 狀態
    private bool showCustomerCharts = false;
    
    // 系統參數設定 Modal 狀態
    private bool showSystemParameterSettings = false;

    // 個人化設定 Modal 狀態
    private bool showPersonalPreference = false;
    
    // Action 處理器註册表
    private NavigationActionHelper.ActionHandlerRegistry? actionRegistry;

    protected override async Task OnInitializedAsync()
    {
        // 初始化報表篩選模板註冊表（純記憶體操作，SSR / Circuit 皆需要）
        FilterTemplateInitializer.EnsureInitialized();

        // SSR 預渲染：跳過 DB 查詢與 ActionRegistry 初始化，等 Circuit 連線後再執行
        if (!RendererInfo.IsInteractive)
        {
            return;
        }

        try
        {
            // 預先載入當前使用者的所有權限到快取
            var employeeId = await NavigationPermissionService.GetCurrentEmployeeIdAsync();
            if (employeeId > 0)
            {
                // 這會觸發一次資料庫查詢，並將結果快取
                _ = await NavigationPermissionService.GetAllEmployeePermissionsAsync(employeeId);
            }
        }
        catch (Exception ex)
        {
            _ = ex;
            // 忽略預載錯誤，不影響主要功能
        }

        // 初始化 Action 註冊表
        actionRegistry = NavigationActionHelper.CreateRegistry();

        // 註册所有 Action 處理器
        actionRegistry.Register("OpenAccountsReceivableReport", OpenAccountsReceivableReport);
        actionRegistry.Register("OpenRolePermissionManagement", OpenRolePermissionManagement);
        actionRegistry.Register("OpenSystemParameterSettings", OpenSystemParameterSettings);
        actionRegistry.Register("OpenPersonalPreference", OpenPersonalPreference);
        actionRegistry.Register("OpenCustomerReportIndex", OpenCustomerReportIndex);
        actionRegistry.Register("OpenCustomerCharts", OpenCustomerCharts);
        actionRegistry.Register("OpenSupplierReportIndex", OpenSupplierReportIndex);        
        actionRegistry.Register("OpenProductReportIndex", OpenProductReportIndex);
        actionRegistry.Register("OpenPurchaseReportIndex", OpenPurchaseReportIndex);
        actionRegistry.Register("OpenSalesReportIndex", OpenSalesReportIndex);
        actionRegistry.Register("OpenFinancialReportIndex", OpenFinancialReportIndex);
        actionRegistry.Register("OpenAccountingReportIndex", OpenAccountingReportIndex);
        actionRegistry.Register("OpenInventoryReportIndex", OpenInventoryReportIndex);
        actionRegistry.Register("OpenHRReportIndex", OpenHRReportIndex);
        actionRegistry.Register("OpenVehicleReportIndex", OpenVehicleReportIndex);
        actionRegistry.Register("OpenWasteReportIndex", OpenWasteReportIndex);
        // actionRegistry.Register("OpenAnotherModal", OpenAnotherModal);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // 註冊 Alt+S 快捷鍵開啟頁面搜尋
                await JSRuntime.InvokeVoidAsync("eval", @"
                    if (!window.altSRegistered) {
                        document.addEventListener('keydown', function(e) {
                            if (e.altKey && (e.key === 's' || e.key === 'S') && !e.ctrlKey && !e.shiftKey) {
                                e.preventDefault();
                                
                                // 嘗試直接點擊頁面搜尋按鈕（如果快速功能表已展開）
                                var pageSearchBtn = document.querySelector('.quick-action-item[title*=""頁面搜尋""]');
                                if (pageSearchBtn) {
                                    pageSearchBtn.click();
                                    return;
                                }
                                
                                // 如果功能表未展開，先展開再點擊頁面搜尋
                                var quickActionBtn = document.querySelector('.quick-action-main-btn');
                                if (quickActionBtn) {
                                    quickActionBtn.click();
                                    
                                    // 等待 DOM 更新後再點擊頁面搜尋按鈕
                                    setTimeout(function() {
                                        var pageSearchBtn = document.querySelector('.quick-action-item[title*=""頁面搜尋""]');
                                        if (pageSearchBtn) {
                                            pageSearchBtn.click();
                                        }
                                    }, 100);
                                }
                            }
                        });
                        window.altSRegistered = true;
                    }
                ");
                
                // 註冊 Alt+R 快捷鍵開啟報表搜尋
                await JSRuntime.InvokeVoidAsync("eval", @"
                    if (!window.altRRegistered) {
                        document.addEventListener('keydown', function(e) {
                            if (e.altKey && (e.key === 'r' || e.key === 'R') && !e.ctrlKey && !e.shiftKey) {
                                e.preventDefault();
                                
                                // 嘗試直接點擊報表搜尋按鈕（如果快速功能表已展開）
                                var reportSearchBtn = document.querySelector('.quick-action-item[title*=""報表搜尋""]');
                                if (reportSearchBtn) {
                                    reportSearchBtn.click();
                                    return;
                                }
                                
                                // 如果功能表未展開，先展開再點擊報表搜尋
                                var quickActionBtn = document.querySelector('.quick-action-main-btn');
                                if (quickActionBtn) {
                                    quickActionBtn.click();
                                    
                                    // 等待 DOM 更新後再點擊報表搜尋按鈕
                                    setTimeout(function() {
                                        var reportSearchBtn = document.querySelector('.quick-action-item[title*=""報表搜尋""]');
                                        if (reportSearchBtn) {
                                            reportSearchBtn.click();
                                        }
                                    }, 100);
                                }
                            }
                        });
                        window.altRRegistered = true;
                    }
                ");
            }
            catch
            {
                // 忽略初始化錯誤
            }
        }
    }

    /// <summary>
    /// JavaScript 呼叫此方法以開啟頁面搜尋 Modal
    /// </summary>
    [JSInvokable]
    public async Task OpenPageSearch()
    {
        try
        {
            showPageSearch = true;
            StateHasChanged();
            
            if (pageSearchModal != null)
            {
                await pageSearchModal.Open();
            }
        }
        catch
        {
            // 忽略開啟頁面搜尋失敗
        }
    }

    /// <summary>
    /// 開啟報表搜尋 Modal
    /// </summary>
    [JSInvokable]
    public async Task OpenReportSearch()
    {
        try
        {
            showReportSearch = true;
            StateHasChanged();
            
            if (reportSearchModal != null)
            {
                await reportSearchModal.Open();
            }
        }
        catch
        {
            // 忽略開啟報表搜尋失敗
        }
    }

    /// <summary>
    /// 開啟快捷鍵說明 Modal
    /// </summary>
    private void OpenShortcutKeys()
    {
        try
        {
            showShortcutKeys = true;
            StateHasChanged();
        }
        catch
        {
            // 忽略開啟快捷鍵說明失敗
        }
    }
    
    /// <summary>
    /// 開啟應收帳款報表 Modal
    /// JavaScript 可呼叫此方法
    /// </summary>
    [JSInvokable]
    public void OpenAccountsReceivableReport()
    {
        try
        {
            showAccountsReceivableReport = true;
            StateHasChanged();
        }
        catch
        {
            // 忽略開啟應收帳款報表失敗
        }
    }
    
    /// <summary>
    /// 開啟角色權限管理 Modal
    /// JavaScript 可呼叫此方法
    /// </summary>
    [JSInvokable]
    public void OpenRolePermissionManagement()
    {
        try
        {
            showRolePermissionManagement = true;
            StateHasChanged();
        }
        catch
        {
            // 忽略開啟權限組權限管理失敗
        }
    }
    
    /// <summary>
    /// 開啟系統參數設定 Modal
    /// JavaScript 可呼叫此方法
    /// </summary>
    [JSInvokable]
    public void OpenSystemParameterSettings()
    {
        try
        {
            showSystemParameterSettings = true;
            StateHasChanged();
        }
        catch
        {
            // 忽略開啟系統參數設定失敗
        }
    }

    /// <summary>
    /// 開啟個人化設定 Modal
    /// </summary>
    [JSInvokable]
    public void OpenPersonalPreference()
    {
        try
        {
            showPersonalPreference = true;
            StateHasChanged();
        }
        catch
        {
            // 忽略開啟個人化設定失敗
        }
    }
    
    /// <summary>
    /// 開啟報表中心 Modal
    /// </summary>
    /// <param name="category">報表分類（使用 ReportCategory 常數）</param>
    public void OpenReportIndex(string category)
    {
        try
        {
            currentReportCategory = category;
            StateHasChanged();
        }
        catch
        {
            // 忽略開啟報表中心失敗
        }
    }
    
    /// <summary>
    /// 開啟客戶報表中心 Modal（保留供 JSInvokable 使用）
    /// </summary>
    [JSInvokable]
    public void OpenCustomerReportIndex() => OpenReportIndex(ERPCore2.Models.Reports.ReportCategory.Customer);

    /// <summary>
    /// 開啟客戶分析圖表 Modal
    /// </summary>
    [JSInvokable]
    public void OpenCustomerCharts()
    {
        try { showCustomerCharts = true; StateHasChanged(); }
        catch { }
    }
    
    /// <summary>
    /// 開啟廠商報表中心 Modal（保留供 JSInvokable 使用）
    /// </summary>
    [JSInvokable]
    public void OpenSupplierReportIndex() => OpenReportIndex(ERPCore2.Models.Reports.ReportCategory.Supplier);

    /// <summary>
    /// 開啟商品報表中心 Modal（保留供 JSInvokable 使用）
    /// </summary>
    [JSInvokable]
    public void OpenProductReportIndex() => OpenReportIndex(ERPCore2.Models.Reports.ReportCategory.Product);

    /// <summary>
    /// 開啟採購報表中心 Modal（保留供 JSInvokable 使用）
    /// </summary>
    [JSInvokable]
    public void OpenPurchaseReportIndex() => OpenReportIndex(ERPCore2.Models.Reports.ReportCategory.Purchase);

    /// <summary>
    /// 開啟銷貨報表中心 Modal（保留供 JSInvokable 使用）
    /// </summary>
    [JSInvokable]
    public void OpenSalesReportIndex() => OpenReportIndex(ERPCore2.Models.Reports.ReportCategory.Sales);

    /// <summary>
    /// 開啟財務報表中心 Modal（保留供 JSInvokable 使用）
    /// </summary>
    [JSInvokable]
    public void OpenFinancialReportIndex() => OpenReportIndex(ERPCore2.Models.Reports.ReportCategory.Financial);

    /// <summary>
    /// 開啟會計報表中心 Modal
    /// </summary>
    [JSInvokable]
    public void OpenAccountingReportIndex() => OpenReportIndex(ERPCore2.Models.Reports.ReportCategory.Accounting);

    /// <summary>
    /// 開啟倉庫報表中心 Modal（保留供 JSInvokable 使用）
    /// </summary>
    [JSInvokable]
    public void OpenInventoryReportIndex() => OpenReportIndex(ERPCore2.Models.Reports.ReportCategory.Inventory);

    /// <summary>
    /// 開啟人力報表中心 Modal（保留供 JSInvokable 使用）
    /// </summary>
    [JSInvokable]
    public void OpenHRReportIndex() => OpenReportIndex(ERPCore2.Models.Reports.ReportCategory.HR);

    /// <summary>
    /// 開啟車輛報表中心 Modal（保留供 JSInvokable 使用）
    /// </summary>
    [JSInvokable]
    public void OpenVehicleReportIndex() => OpenReportIndex(ERPCore2.Models.Reports.ReportCategory.Vehicle);

    /// <summary>
    /// 開啟廢料報表中心 Modal（保留供 JSInvokable 使用）
    /// </summary>
    [JSInvokable]
    public void OpenWasteReportIndex() => OpenReportIndex(ERPCore2.Models.Reports.ReportCategory.Waste);

    /// <summary>
    /// 處理報表中心選擇的報表
    /// 當使用者在報表中心點擊列印按鈕時觸發
    /// </summary>
    private void HandleReportSelected(string actionId)
    {
        // 從 ActionId 查找對應的 ReportId
        var reportDef = Data.ReportRegistry.GetAllReports()
            .FirstOrDefault(r => r.ActionId == actionId);
        
        if (reportDef != null)
        {
            // 檢查是否有對應的篩選模板配置
            if (Models.Reports.FilterTemplates.FilterTemplateRegistry.HasConfig(reportDef.Id))
            {
                // 使用新的通用篩選 Modal
                currentFilterReportId = reportDef.Id;
                StateHasChanged();
                return;
            }
        }
        
        // 沒有篩選配置，使用舊的 ActionHandlerRegistry 執行
        actionRegistry?.Execute(actionId);
    }
    
    /// <summary>
    /// 處理篩選 Modal 列印成功事件
    /// </summary>
    private void HandleFilterPrintSuccess()
    {
        currentFilterReportId = string.Empty;
        StateHasChanged();
    }
    
    // ===== 搜尋函數 =====
    
    /// <summary>
    /// 搜尋導航項目（頁面搜尋用）
    /// </summary>
    private List<ISearchableItem> SearchNavigationItems(string searchTerm)
    {
        return NavigationSearchService.SearchNavigationItems(searchTerm)
            .Where(item => !item.IsParent && 
                (item.ItemType == NavigationItemType.Action || 
                 (!string.IsNullOrEmpty(item.Route) && item.Route != "#")))
            .Cast<ISearchableItem>()
            .ToList();
    }
    
    /// <summary>
    /// 搜尋報表（報表搜尋用）
    /// </summary>
    private List<ISearchableItem> SearchReports(string searchTerm)
    {
        return ReportSearchService.SearchReports(searchTerm, onlyEnabled: true)
            .Cast<ISearchableItem>()
            .ToList();
    }
    
    /// <summary>
    /// 處理導航動作觸發
    /// 執行前檢查所屬模組是否啟用（SuperAdmin 自動繞過）
    /// </summary>
    private async void HandleNavigationAction(string actionId)
    {
        try
        {
            // 從扁平化導航清單中找到對應的 Action 項目
            var navItem = NavigationConfig.GetFlattenedNavigationItems()
                .FirstOrDefault(item => item.ItemType == NavigationItemType.Action && item.ActionId == actionId);

            // 若有 ModuleKey，檢查模組是否啟用（CanAccessModuleAsync 內部已處理 SuperAdmin 繞過）
            if (!string.IsNullOrEmpty(navItem?.ModuleKey))
            {
                var canAccess = await NavigationPermissionService.CanAccessModuleAsync(navItem.ModuleKey);
                if (!canAccess)
                {
                    _showModuleDisabledModal = true;
                    StateHasChanged();
                    return;
                }
            }

            // 使用 ActionHandlerRegistry 執行 Action
            actionRegistry?.Execute(actionId);
        }
        catch
        {
            // 忽略執行失敗，避免影響 UI
        }
    }

    /// <summary>
    /// 清理資源
    /// </summary>
    public async ValueTask DisposeAsync()
    {
        try
        {
            // 清理 JavaScript 快捷鍵監聽器
            await JSRuntime.InvokeVoidAsync("KeyboardShortcuts.dispose");
        }
        catch
        {
            // 忽略清理錯誤
        }
    }
}
