@using ERPCore2.Components.Shared
@using ERPCore2.Components.Shared.Report
@using ERPCore2.Components.Pages.Reports
@using ERPCore2.Components.Pages.Employees
@using ERPCore2.Helpers
@using ERPCore2.Services
@using ERPCore2.Services.Reports.Interfaces
@using ERPCore2.Models
@using Microsoft.JSInterop
@inherits LayoutComponentBase
@inject IJSRuntime JSRuntime
@inject INavigationPermissionService NavigationPermissionService
@inject INavigationSearchService NavigationSearchService
@inject IReportSearchService ReportSearchService
@rendermode InteractiveServer
@implements IAsyncDisposable

<div class="page">    
    <div class="sidebar">
        <NavMenu OnActionTriggered="@HandleNavigationAction" />
    </div>

    <main class="main-content">
        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

@* 全域頁面搜尋 Modal *@
<GenericSearchModalComponent @ref="pageSearchModal" 
                            IsVisible="@showPageSearch"
                            IsVisibleChanged="@((bool visible) => showPageSearch = visible)"
                            ActionRegistry="@actionRegistry"
                            Title="頁面搜尋"
                            Icon="bi-search"
                            Placeholder="輸入功能名稱或關鍵字搜尋..."
                            ResultUnitName="功能"
                            ShowIcon="false"
                            EmptyStateIcon="bi bi-lightning-charge"
                            EmptyStateMessage="開始輸入以搜尋功能頁面"
                            EmptyStateHint="支援功能名稱、關鍵字搜尋"
                            EmptyResultMessage="沒有找到符合條件的功能，請嘗試使用其他關鍵字"
                            SearchFunction="@SearchNavigationItems" />

@* 全域報表搜尋 Modal *@
<GenericSearchModalComponent @ref="reportSearchModal" 
                            IsVisible="@showReportSearch"
                            IsVisibleChanged="@((bool visible) => showReportSearch = visible)"
                            Title="報表搜尋"
                            Icon="bi-printer"
                            Placeholder="輸入報表名稱或關鍵字搜尋..."
                            ResultUnitName="報表"
                            ShowIcon="true"
                            EmptyStateIcon="bi bi-printer"
                            EmptyStateMessage="開始輸入以搜尋報表"
                            EmptyStateHint="支援報表名稱、描述、分類關鍵字搜尋"
                            EmptyResultMessage="沒有找到符合條件的報表，請嘗試使用其他關鍵字"
                            SearchFunction="@SearchReports"
                            CategoryDisplayNameFunc="@ReportSearchService.GetCategoryDisplayName"
                            OnItemSelected="@HandleReportSelected" />

@* 快捷鍵說明 Modal *@
<ShortcutKeysModalComponent IsVisible="@showShortcutKeys"
                           IsVisibleChanged="@((bool visible) => showShortcutKeys = visible)" />

@* 應收帳款報表 Modal（舊版，將逐步替換為 GenericReportFilterModalComponent） *@
<AccountsReceivableReportPage IsVisible="@showAccountsReceivableReport"
                             IsVisibleChanged="@((bool visible) => showAccountsReceivableReport = visible)" />

@* 通用報表篩選 Modal *@
<GenericReportFilterModalComponent IsVisible="@(!string.IsNullOrEmpty(currentFilterReportId))"
                                  IsVisibleChanged="@((bool visible) => { if (!visible) currentFilterReportId = string.Empty; })"
                                  ReportId="@currentFilterReportId"
                                  OnPrintSuccess="@HandleFilterPrintSuccess" />

@* 通用報表中心 Modal *@
<GenericReportIndexPage IsVisible="@(!string.IsNullOrEmpty(currentReportCategory))"
                       IsVisibleChanged="@((bool visible) => { if (!visible) currentReportCategory = string.Empty; })"
                       Category="@currentReportCategory"
                       OnReportSelected="@HandleReportSelected" />

@* 權限組權限管理 Modal *@
<RolePermissionManagement IsVisible="@showRolePermissionManagement"
                         IsVisibleChanged="@((bool visible) => showRolePermissionManagement = visible)" />

@* 快速功能表（右下角浮動按鈕） *@
<QuickActionMenu @rendermode="InteractiveServer" 
                OnPageSearchClick="@OpenPageSearch"
                OnReportSearchClick="@OpenReportSearch"
                OnShortcutKeysClick="@OpenShortcutKeys" />

@code {
    // 頁面搜尋 Modal 參考
    private GenericSearchModalComponent? pageSearchModal;
    private bool showPageSearch = false;
    
    // 報表搜尋 Modal 參考
    private GenericSearchModalComponent? reportSearchModal;
    private bool showReportSearch = false;
    
    // 快捷鍵說明 Modal 狀態
    private bool showShortcutKeys = false;
    
    // 應收帳款報表 Modal 狀態
    private bool showAccountsReceivableReport = false;
    
    // 通用報表中心 Modal 狀態（存放當前開啟的報表分類，空字串表示關閉）
    private string currentReportCategory = string.Empty;
    
    // 通用報表篩選 Modal 狀態（存放當前要篩選的報表 ID，空字串表示關閉）
    private string currentFilterReportId = string.Empty;
    
    // 角色權限管理 Modal 狀態
    private bool showRolePermissionManagement = false;
    
    // Action 處理器註册表
    private NavigationActionHelper.ActionHandlerRegistry? actionRegistry;

    protected override async Task OnInitializedAsync()
    {
        // 初始化報表篩選模板註冊表
        FilterTemplateInitializer.EnsureInitialized();
        
        try
        {
            // 預先載入當前使用者的所有權限到快取
            var employeeId = await NavigationPermissionService.GetCurrentEmployeeIdAsync();
            if (employeeId > 0)
            {
                // 這會觸發一次資料庫查詢，並將結果快取
                _ = await NavigationPermissionService.GetAllEmployeePermissionsAsync(employeeId);
            }
        }
        catch
        {
            // 忽略預載錯誤，不影響主要功能
        }
        
        // 初始化 Action 註冊表
        actionRegistry = NavigationActionHelper.CreateRegistry();
        
        // 註册所有 Action 處理器
        actionRegistry.Register("OpenAccountsReceivableReport", OpenAccountsReceivableReport);
        actionRegistry.Register("OpenRolePermissionManagement", OpenRolePermissionManagement);        
        actionRegistry.Register("OpenCustomerReportIndex", OpenCustomerReportIndex);
        actionRegistry.Register("OpenSupplierReportIndex", OpenSupplierReportIndex);        
        actionRegistry.Register("OpenProductReportIndex", OpenProductReportIndex);
        actionRegistry.Register("OpenPurchaseReportIndex", OpenPurchaseReportIndex);
        // actionRegistry.Register("OpenAnotherModal", OpenAnotherModal);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // 註冊 Alt+S 快捷鍵開啟頁面搜尋
                await JSRuntime.InvokeVoidAsync("eval", @"
                    if (!window.altSRegistered) {
                        document.addEventListener('keydown', function(e) {
                            if (e.altKey && (e.key === 's' || e.key === 'S') && !e.ctrlKey && !e.shiftKey) {
                                e.preventDefault();
                                
                                // 嘗試直接點擊頁面搜尋按鈕（如果快速功能表已展開）
                                var pageSearchBtn = document.querySelector('.quick-action-item[title*=""頁面搜尋""]');
                                if (pageSearchBtn) {
                                    pageSearchBtn.click();
                                    return;
                                }
                                
                                // 如果功能表未展開，先展開再點擊頁面搜尋
                                var quickActionBtn = document.querySelector('.quick-action-main-btn');
                                if (quickActionBtn) {
                                    quickActionBtn.click();
                                    
                                    // 等待 DOM 更新後再點擊頁面搜尋按鈕
                                    setTimeout(function() {
                                        var pageSearchBtn = document.querySelector('.quick-action-item[title*=""頁面搜尋""]');
                                        if (pageSearchBtn) {
                                            pageSearchBtn.click();
                                        }
                                    }, 100);
                                }
                            }
                        });
                        window.altSRegistered = true;
                    }
                ");
                
                // 註冊 Alt+R 快捷鍵開啟報表搜尋
                await JSRuntime.InvokeVoidAsync("eval", @"
                    if (!window.altRRegistered) {
                        document.addEventListener('keydown', function(e) {
                            if (e.altKey && (e.key === 'r' || e.key === 'R') && !e.ctrlKey && !e.shiftKey) {
                                e.preventDefault();
                                
                                // 嘗試直接點擊報表搜尋按鈕（如果快速功能表已展開）
                                var reportSearchBtn = document.querySelector('.quick-action-item[title*=""報表搜尋""]');
                                if (reportSearchBtn) {
                                    reportSearchBtn.click();
                                    return;
                                }
                                
                                // 如果功能表未展開，先展開再點擊報表搜尋
                                var quickActionBtn = document.querySelector('.quick-action-main-btn');
                                if (quickActionBtn) {
                                    quickActionBtn.click();
                                    
                                    // 等待 DOM 更新後再點擊報表搜尋按鈕
                                    setTimeout(function() {
                                        var reportSearchBtn = document.querySelector('.quick-action-item[title*=""報表搜尋""]');
                                        if (reportSearchBtn) {
                                            reportSearchBtn.click();
                                        }
                                    }, 100);
                                }
                            }
                        });
                        window.altRRegistered = true;
                    }
                ");
            }
            catch
            {
                // 忽略初始化錯誤
            }
        }
    }

    /// <summary>
    /// JavaScript 呼叫此方法以開啟頁面搜尋 Modal
    /// </summary>
    [JSInvokable]
    public async Task OpenPageSearch()
    {
        try
        {
            showPageSearch = true;
            StateHasChanged();
            
            if (pageSearchModal != null)
            {
                await pageSearchModal.Open();
            }
        }
        catch
        {
            // 忽略開啟頁面搜尋失敗
        }
    }

    /// <summary>
    /// 開啟報表搜尋 Modal
    /// </summary>
    [JSInvokable]
    public async Task OpenReportSearch()
    {
        try
        {
            showReportSearch = true;
            StateHasChanged();
            
            if (reportSearchModal != null)
            {
                await reportSearchModal.Open();
            }
        }
        catch
        {
            // 忽略開啟報表搜尋失敗
        }
    }

    /// <summary>
    /// 開啟快捷鍵說明 Modal
    /// </summary>
    private void OpenShortcutKeys()
    {
        try
        {
            showShortcutKeys = true;
            StateHasChanged();
        }
        catch
        {
            // 忽略開啟快捷鍵說明失敗
        }
    }
    
    /// <summary>
    /// 開啟應收帳款報表 Modal
    /// JavaScript 可呼叫此方法
    /// </summary>
    [JSInvokable]
    public void OpenAccountsReceivableReport()
    {
        try
        {
            showAccountsReceivableReport = true;
            StateHasChanged();
        }
        catch
        {
            // 忽略開啟應收帳款報表失敗
        }
    }
    
    /// <summary>
    /// 開啟角色權限管理 Modal
    /// JavaScript 可呼叫此方法
    /// </summary>
    [JSInvokable]
    public void OpenRolePermissionManagement()
    {
        try
        {
            showRolePermissionManagement = true;
            StateHasChanged();
        }
        catch
        {
            // 忽略開啟權限組權限管理失敗
        }
    }
    
    /// <summary>
    /// 開啟報表中心 Modal
    /// </summary>
    /// <param name="category">報表分類（使用 ReportCategory 常數）</param>
    public void OpenReportIndex(string category)
    {
        try
        {
            currentReportCategory = category;
            StateHasChanged();
        }
        catch
        {
            // 忽略開啟報表中心失敗
        }
    }
    
    /// <summary>
    /// 開啟客戶報表中心 Modal（保留供 JSInvokable 使用）
    /// </summary>
    [JSInvokable]
    public void OpenCustomerReportIndex() => OpenReportIndex(ERPCore2.Models.Reports.ReportCategory.Customer);
    
    /// <summary>
    /// 開啟廠商報表中心 Modal（保留供 JSInvokable 使用）
    /// </summary>
    [JSInvokable]
    public void OpenSupplierReportIndex() => OpenReportIndex(ERPCore2.Models.Reports.ReportCategory.Supplier);

    /// <summary>
    /// 開啟商品報表中心 Modal（保留供 JSInvokable 使用）
    /// </summary>
    [JSInvokable]
    public void OpenProductReportIndex() => OpenReportIndex(ERPCore2.Models.Reports.ReportCategory.Product);

    /// <summary>
    /// 開啟採購報表中心 Modal（保留供 JSInvokable 使用）
    /// </summary>
    [JSInvokable]
    public void OpenPurchaseReportIndex() => OpenReportIndex(ERPCore2.Models.Reports.ReportCategory.Purchase);
    
    /// <summary>
    /// 處理報表中心選擇的報表
    /// 當使用者在報表中心點擊列印按鈕時觸發
    /// </summary>
    private void HandleReportSelected(string actionId)
    {
        // 從 ActionId 查找對應的 ReportId
        var reportDef = Data.ReportRegistry.GetAllReports()
            .FirstOrDefault(r => r.ActionId == actionId);
        
        if (reportDef != null)
        {
            // 檢查是否有對應的篩選模板配置
            if (Models.Reports.FilterTemplates.FilterTemplateRegistry.HasConfig(reportDef.Id))
            {
                // 使用新的通用篩選 Modal
                currentFilterReportId = reportDef.Id;
                StateHasChanged();
                return;
            }
        }
        
        // 沒有篩選配置，使用舊的 ActionHandlerRegistry 執行
        actionRegistry?.Execute(actionId);
    }
    
    /// <summary>
    /// 處理篩選 Modal 列印成功事件
    /// </summary>
    private void HandleFilterPrintSuccess()
    {
        currentFilterReportId = string.Empty;
        StateHasChanged();
    }
    
    // ===== 搜尋函數 =====
    
    /// <summary>
    /// 搜尋導航項目（頁面搜尋用）
    /// </summary>
    private List<ISearchableItem> SearchNavigationItems(string searchTerm)
    {
        return NavigationSearchService.SearchNavigationItems(searchTerm)
            .Where(item => !item.IsParent && 
                (item.ItemType == NavigationItemType.Action || 
                 (!string.IsNullOrEmpty(item.Route) && item.Route != "#")))
            .Cast<ISearchableItem>()
            .ToList();
    }
    
    /// <summary>
    /// 搜尋報表（報表搜尋用）
    /// </summary>
    private List<ISearchableItem> SearchReports(string searchTerm)
    {
        return ReportSearchService.SearchReports(searchTerm, onlyEnabled: true)
            .Cast<ISearchableItem>()
            .ToList();
    }
    
    /// <summary>
    /// 處理導航動作觸發
    /// </summary>
    private void HandleNavigationAction(string actionId)
    {
        // 使用 ActionHandlerRegistry 執行 Action
        actionRegistry?.Execute(actionId);
    }

    /// <summary>
    /// 清理資源
    /// </summary>
    public async ValueTask DisposeAsync()
    {
        try
        {
            // 清理 JavaScript 快捷鍵監聽器
            await JSRuntime.InvokeVoidAsync("KeyboardShortcuts.dispose");
        }
        catch
        {
            // 忽略清理錯誤
        }
    }
}
