# 傳票系統設計

## 更新日期
2026-02-25

---

## 概述

傳票系統（Journal Entry）是會計模組的核心記錄單元，支援手動輸入、自動產生、過帳、沖銷等完整流程。每筆傳票由主檔（JournalEntry）與多筆分錄明細（JournalEntryLine）組成。

---

## 1. Enum 定義

**檔案：** `Models/Enums/JournalEntryEnums.cs`

### JournalEntryType（傳票類型）

| 值 | 名稱 | 說明 |
|----|------|------|
| 1 | AutoGenerated | 業務單據自動產生 |
| 2 | Manual | 會計人員手動輸入 |
| 3 | Adjusting | 調整分錄 |
| 4 | Closing | 結帳分錄 |
| 5 | Reversing | 沖銷分錄 |

### JournalEntryStatus（傳票狀態）

| 值 | 名稱 | 說明 |
|----|------|------|
| 1 | Draft | 草稿（可編輯，不影響帳） |
| 2 | Posted | 已過帳（鎖定，影響科目餘額） |
| 3 | Cancelled | 已取消 |
| 4 | Reversed | 已沖銷（原始傳票被反向沖銷） |

---

## 2. JournalEntry Entity

**檔案：** `Data/Entities/FinancialManagement/JournalEntry.cs`

**主要欄位：**

| 欄位 | 型別 | 說明 |
|------|------|------|
| EntryDate | DateTime | 傳票日期 |
| EntryType | JournalEntryType | 傳票類型 |
| JournalEntryStatus | JournalEntryStatus | 傳票狀態 |
| Description | string? | 傳票說明 |
| CompanyId | int | 公司 FK |
| FiscalYear | int | 會計年度 |
| FiscalPeriod | int (1-12) | 會計期間（月份） |
| SourceDocumentType | string? | 來源單據類型（"PurchaseReceiving" 等） |
| SourceDocumentId | int? | 來源單據 ID |
| SourceDocumentCode | string? | 來源單號（方便搜尋，免 JOIN） |
| TotalDebitAmount | decimal(18,2) | 借方合計 |
| TotalCreditAmount | decimal(18,2) | 貸方合計 |
| IsReversed | bool | 是否已被沖銷 |
| ReversalEntryId | int? | 沖銷傳票 ID（自我參照） |
| IsBalanced | [NotMapped] | TotalDebit == TotalCredit && > 0 |

---

## 3. JournalEntryLine Entity

**檔案：** `Data/Entities/FinancialManagement/JournalEntryLine.cs`

**主要欄位：**

| 欄位 | 型別 | 說明 |
|------|------|------|
| JournalEntryId | int | 傳票主檔 FK |
| LineNumber | int | 行次 |
| AccountItemId | int | 會計科目 FK（僅明細科目） |
| Direction | AccountDirection | 借方 / 貸方 |
| Amount | decimal(18,2) | 金額 |
| LineDescription | string? | 分錄說明 |

---

## 4. DbContext 設定

**檔案：** `Data/Context/AppDbContext.cs`

- `DbSet<JournalEntry> JournalEntries`
- `DbSet<JournalEntryLine> JournalEntryLines`

---

## 5. JournalEntry Service

**檔案：** `Services/FinancialManagement/IJournalEntryService.cs` / `JournalEntryService.cs`

命名空間：`ERPCore2.Services`（符合 `_Imports.razor` 慣例）

| 方法 | 說明 |
|------|------|
| `IsJournalEntryCodeExistsAsync` | 供 EntityCodeGenerationHelper 反射呼叫 |
| `GetByFiscalPeriodAsync` | 依會計年度+期間查詢（含分錄明細） |
| `GetBySourceDocumentAsync` | 依來源單據查詢已產生的傳票 |
| `GetDraftEntriesAsync` | 查詢所有草稿傳票 |
| `GetWithLinesAsync` | 取得含分錄明細的傳票（供 EditModal 使用） |
| `PostEntryAsync` | 過帳：Draft → Posted，須借貸平衡 |
| `ReverseEntryAsync` | 沖銷：建立反向傳票，原傳票標記 Reversed |
| `SaveWithLinesAsync` | 儲存傳票及分錄（含新增/更新/刪除行） |

---

## 6. UI 元件

### FieldConfiguration

**檔案：** `Components/FieldConfiguration/JournalEntryFieldConfiguration.cs`

8 欄位：Code、EntryDate（DateRange）、EntryType（badge）、JournalEntryStatus（badge）、Description、TotalDebitAmount、TotalCreditAmount、SourceDocumentCode

### Index 頁面

**檔案：** `Components/Pages/FinancialManagement/JournalEntryIndex.razor`

- 路由：`/journal-entries`
- 標準 GenericIndexPageComponent 架構

### EditModal

**檔案：** `Components/Pages/FinancialManagement/JournalEntryEditModalComponent.razor`

全客製化 EditModal（含動態分錄行），使用 `BaseModalComponent`，按鈕置於 `HeaderButtons`。

**主表單欄位：**
- EntryDate、EntryType
- FiscalYear / FiscalPeriod（自動同步，由 EntryDate 帶入）
- Status（唯讀）
- Description

**分錄明細表（動態行）：**
- 選科目（僅明細科目）
- 借 / 貸方向
- 金額
- 說明
- 刪除按鈕

**底部即時顯示：**
- 借方合計 / 貸方合計 / 差額 badge（平衡=綠色 ✓；不平衡=紅色差額）

**操作按鈕（依狀態控制）：**

| 狀態 | 顯示按鈕 |
|------|---------|
| 草稿 | 取消 / 儲存草稿 / 過帳（不平衡時禁用） |
| 已過帳（未沖銷） | 關閉 / 沖銷此傳票 |
| 已取消 / 已沖銷 | 關閉 |

### 導覽與權限

- 導覽：`NavigationConfig.cs` 已新增，QuickActionId = `"NewJournalEntry"`
- `PermissionSeeder.cs`：新增 `JournalEntry.Read` 權限
- `QuickActionModalHost.razor`：`"NewJournalEntry"` → `JournalEntryEditModalComponent`

---

## 相關文件

- [README_會計設計總綱.md](README_會計設計總綱.md)
- [README_會計_批次轉傳票.md](README_會計_批次轉傳票.md)（業務單據自動產生傳票）
- [README_會計_財務報表.md](README_會計_財務報表.md)（基於傳票資料的財務報表）
