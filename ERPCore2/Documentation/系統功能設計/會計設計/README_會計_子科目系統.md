# 子科目（明細科目）自動產生系統

## 更新日期
2026-02-25

---

## 概述

客戶、廠商、商品建立時，在對應統制科目下自動建立明細子科目，批次轉傳票改用子科目（fallback 統制科目）。系統參數可控制是否啟用、統制科目代碼、及代碼產生格式。

---

## 子科目代碼格式（兩種模式）

| 模式 | 說明 | 範例 |
|------|------|------|
| Sequential（流水號） | 三位補零流水號，依建立順序遞增 | `1191.001`、`1191.002` |
| EntityCode（實體編碼） | 使用客戶/廠商/商品的 Code 欄位作後綴（點號過濾） | `1191.C0001` |

> **選用建議：** 流水號適合大量客戶/廠商，一眼看不出對應實體；實體編碼適合代碼有意義的場景，可從代碼直接辨認對應實體。

---

## 子科目 Name / Description 命名規則

| 欄位 | 值 | 說明 |
|------|----|------|
| `Name` | 繼承上層科目名稱（如 `應收帳款`） | 讓子科目出現在試算表時仍可辨認科目性質 |
| `Description` | 連結實體名稱（公司名或商品名） | 供人工查核時辨認對應實體 |

---

## Entity 欄位

### AccountItem 新增欄位

> 欄位說明已整合至 [README_會計_科目表.md](README_會計_科目表.md) 第 1 節。子科目專用欄位：`LinkedCustomerId`、`LinkedSupplierId`、`LinkedProductId`、`IsAutoGenerated`。

### SystemParameter 新增欄位

| 欄位 | 型別 | 預設值 | 說明 |
|------|------|--------|------|
| AutoCreateCustomerSubAccount | bool | false | 自動建立客戶子科目 |
| AutoCreateSupplierSubAccount | bool | false | 自動建立廠商子科目 |
| AutoCreateProductSubAccount | bool | false | 自動建立商品子科目 |
| CustomerSubAccountParentCode | string (Max 20) | 1191 | 應收帳款統制科目代碼（可依公司科目表調整） |
| SupplierSubAccountParentCode | string (Max 20) | 2171 | 應付帳款統制科目代碼（可依公司科目表調整） |
| ProductSubAccountParentCode | string (Max 20) | 1231 | 商品存貨統制科目代碼（可依公司科目表調整） |
| SubAccountCodeFormat | SubAccountCodeFormat | Sequential | 子科目代碼格式（0=流水號；1=實體編碼） |

> **預設值說明：** 統制科目代碼採用台灣「商業會計項目表 112 年度」對應代碼，各公司科目表可能不同，因此保留可編輯。

---

## ISubAccountService / SubAccountService

**檔案：** `Services/FinancialManagement/ISubAccountService.cs` / `SubAccountService.cs`

| 方法 | 說明 |
|------|------|
| `GetSubAccountForCustomerAsync(int)` | 查詢客戶子科目（不建立） |
| `GetSubAccountForSupplierAsync(int)` | 查詢廠商子科目（不建立） |
| `GetSubAccountForProductAsync(int)` | 查詢商品子科目（不建立） |
| `GetOrCreateCustomerSubAccountAsync(int, string)` | 取得或建立客戶子科目（需系統參數啟用） |
| `GetOrCreateSupplierSubAccountAsync(int, string)` | 取得或建立廠商子科目（需系統參數啟用） |
| `GetOrCreateProductSubAccountAsync(int, string)` | 取得或建立商品子科目（需系統參數啟用） |
| `BatchCreateForAllCustomersAsync(string)` | 批次補建所有現有 Active 客戶子科目 |
| `BatchCreateForAllSuppliersAsync(string)` | 批次補建所有現有 Active 廠商子科目 |
| `BatchCreateForAllProductsAsync(string)` | 批次補建所有現有 Active 商品子科目 |

### GetOrCreate 執行流程

1. 檢查是否已存在對應子科目（`LinkedCustomerId/SupplierId/ProductId`）→ 直接回傳
2. 讀取 SystemParameter；若功能未啟用（`AutoCreateXxxSubAccount = false`）→ 回傳 null
3. 查詢統制科目（依 `XxxSubAccountParentCode`）；找不到 → log warning + 回傳 null
4. `GenerateSubAccountCodeAsync`：依 `SubAccountCodeFormat` 產生代碼
5. 建立子科目：`Name = parent.Name`、`Description = 公司名/商品名`
6. 直接寫 DB（繞過 AccountItemService，避免觸發唯一代碼競爭）

---

## 已過帳科目鎖定

`AccountItemService.ValidateAsync` 增強：若科目已有「已過帳」傳票行，下列欄位不允許修改：
- `AccountType`（科目大類）
- `Direction`（借貸方向）
- `ParentId`（上層科目）

---

## 批次轉傳票整合

`JournalEntryAutoGenerationService` 新增兩個私有 helper：
- `GetARAccountForCustomerAsync(customerId)`：優先取客戶子科目，找不到 fallback `1191`
- `GetAPAccountForSupplierAsync(supplierId)`：優先取廠商子科目，找不到 fallback `2171`

涵蓋文件類型：進貨入庫、進貨退回、銷貨出貨、銷貨退回、沖款單、銷貨折讓、進貨折讓。

> 商品子科目（`1231.*`）本版未整合進 COGS 傳票（一張出貨單含多商品，拆分複雜）。

---

## 系統參數設定頁面

**檔案：** `Components/Pages/Systems/SystemParameterSettingsModal.razor`

新增「子科目設定」頁籤：
- **自動產生設定**：三個開關（客戶/廠商/商品）+ 代碼格式下拉（含 LabelHelpItems 說明）
- **統制科目代碼**：三個文字欄位（應收/應付/商品存貨）
- **批次補建**：三個按鈕（補建客戶/廠商/商品），含執行結果顯示，關閉 Modal 時自動清除結果

---

## Migrations

| Migration | 說明 |
|-----------|------|
| `20260223143910_AddSubAccountFields` | `AccountItems` 新增 4 欄（3 FK + IsAutoGenerated）+ FK 索引；`SystemParameters` 新增 6 欄（3 開關 + 3 代碼） |
| `20260223150439_FixSubAccountParentCodeDefaults` | 資料修正：將空字串的統制科目代碼補回預設值（1191/2171/1231） |
| `20260223152706_AddSubAccountCodeFormat` | `SystemParameters` 新增 `SubAccountCodeFormat` int 欄（defaultValue: 0） |

---

## 相關文件

- [README_會計設計總綱.md](README_會計設計總綱.md)
- [README_會計_科目表.md](README_會計_科目表.md)（AccountItem Entity 欄位定義）
- [README_會計_批次轉傳票.md](README_會計_批次轉傳票.md)（批次轉傳票整合細節）
