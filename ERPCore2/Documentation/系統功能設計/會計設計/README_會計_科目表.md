# 會計科目表設計

## 更新日期
2026-02-25

---

## 概述

科目表是整個會計模組的基礎，採用台灣「商業會計項目表（112年度）」標準，共 553 筆科目，以四層樹狀階層組織，並支援子科目自動產生。

---

## 1. AccountItem Entity

**檔案：** `Data/Entities/FinancialManagement/AccountItem.cs`

繼承 `BaseEntity`，額外欄位：

| 欄位 | 型別 | 說明 |
|------|------|------|
| Name | string (Required, Max 100) | 科目名稱（中文）；子科目繼承上層科目名稱 |
| EnglishName | string? (Max 200) | 英文名稱 |
| Description | string? (Max 500) | 說明（中文）；子科目存放連結實體名稱（公司名/商品名） |
| EnglishDescription | string? (Max 500) | 英文說明 |
| AccountLevel | int (Required) | 科目層級（1~5；子科目為上層 +1） |
| ParentId | int? | 父層科目 ID（自我參照外鍵） |
| AccountType | AccountType (Required) | 科目大類（列舉）；子科目繼承上層 |
| Direction | AccountDirection (Required) | 借貸方向（列舉）；子科目繼承上層 |
| IsDetailAccount | bool | 是否為明細科目（僅明細科目可記帳） |
| SortOrder | int | 排序順序 |
| LinkedCustomerId | int? | 連結客戶 FK（SetNull on delete）；子科目專用 |
| LinkedSupplierId | int? | 連結廠商 FK（SetNull on delete）；子科目專用 |
| LinkedProductId | int? | 連結商品 FK（SetNull on delete）；子科目專用 |
| IsAutoGenerated | bool | 系統自動產生（預設 false） |
| LinkedEntityName | string? [NotMapped] | 取自連結實體的名稱（唯讀計算屬性，需 Include） |

---

## 2. Enum 定義

**檔案：** `Models/Enums/AccountingEnums.cs`

所有 Enum 值同時標記 `[Description]` 和 `[Display(Name)]`，前者供一般顯示邏輯使用，後者供 `DynamicFilterTemplate` 讀取。

### AccountType（科目大類）

| 值 | 名稱 | 說明 |
|----|------|------|
| 1 | Asset | 資產 |
| 2 | Liability | 負債 |
| 3 | Equity | 權益 |
| 4 | Revenue | 營業收入 |
| 5 | Cost | 營業成本 |
| 6 | Expense | 營業費用 |
| 7 | NonOperatingIncomeAndExpense | 營業外收益及費損 |
| 8 | ComprehensiveIncome | 綜合損益總額 |

### AccountDirection（借貸方向）

| 值 | 名稱 | 說明 |
|----|------|------|
| 1 | Debit | 借方（資產、成本、費用類） |
| 2 | Credit | 貸方（負債、權益、收入類） |

**借貸方向預設規則：**

| 方向 | 適用科目 |
|------|---------|
| Debit | 資產（1）、營業成本（5）、營業費用（6）、營業外收益及費損（7） |
| Credit | 負債（2）、權益（3）、營業收入（4）、綜合損益總額（8） |

### SubAccountCodeFormat（子科目代碼格式）

| 值 | 名稱 | 說明 |
|----|------|------|
| 0 | Sequential | 流水號（1191.001, 1191.002...） |
| 1 | EntityCode | 實體編碼，使用客戶/廠商/商品的 Code 作為後綴（1191.C0001） |

### AccountLevelFilter（層級篩選，用於報表）

| 值 | 名稱 | 說明 |
|----|------|------|
| 1 | Level1 | 第1層 |
| 2 | Level2 | 第2層 |
| 3 | Level3 | 第3層 |
| 4 | Level4 | 第4層 |
| 5 | Level5 | 第5層 |

---

## 3. DbContext 設定

**檔案：** `Data/Context/AppDbContext.cs`

- `DbSet<AccountItem> AccountItems`
- OnModelCreating：自我參照關聯（Parent ↔ Children），刪除行為 `DeleteBehavior.Restrict`
- 唯一索引：Code
- 查詢索引：AccountType、AccountLevel、ParentId、IsDetailAccount
- 子科目 FK：LinkedCustomerId / LinkedSupplierId / LinkedProductId（各 SetNull + 過濾索引）

---

## 4. Seeder 種子資料

**檔案：** `Data/SeedDataManager/Seeders/AccountItemSeeder.cs`

商業會計項目表 112 年度，共 553 筆，已透過 `Data/SeedData.cs` 註冊載入。

兩階段載入：
1. **第一階段**：建立所有 AccountItem（不含 ParentId）
2. **第二階段**：依科目代碼前綴對應，設定 ParentId 建立樹狀階層

| 層級 | 數量 | 說明 |
|------|------|------|
| Level 1 | 8 | 大分類（資產、負債、權益、收入、成本、費用、營業外、綜合損益） |
| Level 2 | 20 | 子分類（流動資產、非流動資產、流動負債等） |
| Level 3 | 94 | 中分類（現金及約當現金、應收帳款等） |
| Level 4 | 431 | 明細科目（庫存現金、銀行存款等）— 實際記帳使用 |
| **合計** | **553** | |

---

## 5. AccountItem Service

**檔案：** `Services/FinancialManagement/IAccountItemService.cs` / `AccountItemService.cs`

| 方法 | 說明 |
|------|------|
| `IsAccountItemCodeExistsAsync(code, excludeId?)` | 供 EntityCodeGenerationHelper 反射呼叫 |
| `GetByAccountTypeAsync(accountType)` | 依科目大類查詢 |
| `GetByLevelAsync(level)` | 依層級查詢 |
| `GetDetailAccountsAsync()` | 查詢所有明細科目 |
| `GetAllWithParentAsync()` | 查詢所有科目（含上層科目、LinkedCustomer/Supplier/Product） |
| `GetByCodeAsync(code)` | 依科目代碼查詢 Active 科目（供自動分錄使用） |
| `ValidateAsync` | 已增強：已過帳科目鎖定 AccountType、Direction、ParentId 不可修改 |

**已過帳科目鎖定：** 若科目已有「已過帳」傳票行，下列欄位不允許修改：
- `AccountType`（科目大類）
- `Direction`（借貸方向）
- `ParentId`（上層科目）

---

## 6. UI 元件

| 檔案 | 說明 |
|------|------|
| `Components/FieldConfiguration/AccountItemFieldConfiguration.cs` | 7 個欄位：Code、Name、AccountLevel、AccountType、Direction、IsDetailAccount、ParentName |
| `Components/Pages/FinancialManagement/AccountItemIndex.razor` | 路由 `/account-items`，科目列表、新增、編輯、刪除、狀態切換 |
| `Components/Pages/FinancialManagement/AccountItemEditModalComponent.razor` | 三個欄位群組：基本資料、科目屬性、附加資料 |

- 導覽：`NavigationConfig.cs` 已新增，QuickActionId = `"NewAccountItem"`
- `QuickActionModalHost.razor`：`"NewAccountItem"` → `AccountItemEditModalComponent`

---

## 7. 會計科目表報表（FN005）

| 檔案 | 路徑 |
|------|------|
| `AccountItemListCriteria.cs` | `Models/Reports/FilterCriteria/` |
| `IAccountItemListReportService.cs` | `Services/Reports/Interfaces/` |
| `AccountItemListReportService.cs` | `Services/Reports/` |

**篩選條件（AccountItemListCriteria）：**

| 欄位 | 類型 | 說明 |
|------|------|------|
| AccountTypes | FilterEnum(AccountType) | 科目大類多選 |
| AccountDirections | FilterEnum(AccountDirection) | 借貸方向多選 |
| AccountLevels | FilterEnum(AccountLevelFilter) | 層級多選 |
| CodeKeyword | FilterKeyword | 科目代碼搜尋 |
| NameKeyword | FilterKeyword | 科目名稱搜尋 |
| DetailAccountOnly | FilterToggle | 僅顯示明細科目 |

**報表格式：** 依科目大類分組，表格含項次、科目代碼、科目名稱（含層級縮排）、層級、借貸方向、明細標記、上層科目。頁尾顯示統計數量及製表/財務主管簽名欄。

---

## 相關文件

- [README_會計設計總綱.md](README_會計設計總綱.md)
- [README_會計_子科目系統.md](README_會計_子科目系統.md)（子科目自動產生與代碼格式）
