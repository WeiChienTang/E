# 會計模組設計進度

## 更新日期
2026-02-23

---

## 概述

本文件記錄 ERPCore2 會計模組的設計與實作現況，涵蓋科目表、傳票系統、批次轉傳票、及財務報表。

---

## 設計目標

1. **會計科目表管理** — 建立符合台灣「商業會計項目表（112年度）」的標準科目表
2. **樹狀階層結構** — 支援多層級科目，透過自我參照（ParentId）建立父子關係
3. **自動產生報表** — 透過科目階層彙總，自動產出資產負債表、損益表等財務報表
4. **種子資料載入** — 系統初始化時自動載入 553 筆標準會計科目

---

## 已完成項目

### 1. AccountItem Entity

**檔案：** `Data/Entities/FinancialManagement/AccountItem.cs`

繼承 `BaseEntity`，額外欄位：

| 欄位 | 型別 | 說明 |
|------|------|------|
| Name | string (Required, Max 100) | 科目名稱（中文）；子科目繼承上層科目名稱 |
| EnglishName | string? (Max 200) | 英文名稱 |
| Description | string? (Max 500) | 說明（中文）；子科目存放連結實體名稱（公司名/商品名） |
| EnglishDescription | string? (Max 500) | 英文說明 |
| AccountLevel | int (Required) | 科目層級（1~5；子科目為上層 +1） |
| ParentId | int? | 父層科目 ID（自我參照外鍵） |
| AccountType | AccountType (Required) | 科目大類（列舉）；子科目繼承上層 |
| Direction | AccountDirection (Required) | 借貸方向（列舉）；子科目繼承上層 |
| IsDetailAccount | bool | 是否為明細科目（僅明細科目可記帳） |
| SortOrder | int | 排序順序 |
| LinkedCustomerId | int? | 連結客戶 FK（SetNull on delete）；子科目專用 |
| LinkedSupplierId | int? | 連結廠商 FK（SetNull on delete）；子科目專用 |
| LinkedProductId | int? | 連結商品 FK（SetNull on delete）；子科目專用 |
| IsAutoGenerated | bool | 系統自動產生（預設 false） |
| LinkedEntityName | string? [NotMapped] | 取自連結實體的名稱（唯讀計算屬性，需 Include） |

---

### 2. Enum 定義

**檔案：** `Models/Enums/AccountingEnums.cs`

所有 Enum 值同時標記 `[Description]` 和 `[Display(Name)]`，前者供一般顯示邏輯使用，後者供 `DynamicFilterTemplate` 讀取。

#### AccountType（科目大類）

| 值 | 名稱 | 說明 |
|----|------|------|
| 1 | Asset | 資產 |
| 2 | Liability | 負債 |
| 3 | Equity | 權益 |
| 4 | Revenue | 營業收入 |
| 5 | Cost | 營業成本 |
| 6 | Expense | 營業費用 |
| 7 | NonOperatingIncomeAndExpense | 營業外收益及費損 |
| 8 | ComprehensiveIncome | 綜合損益總額 |

#### AccountDirection（借貸方向）

| 值 | 名稱 | 說明 |
|----|------|------|
| 1 | Debit | 借方（資產、成本、費用類） |
| 2 | Credit | 貸方（負債、權益、收入類） |

#### SubAccountCodeFormat（子科目代碼格式）

| 值 | 名稱 | 說明 |
|----|------|------|
| 0 | Sequential | 流水號（1191.001, 1191.002...） |
| 1 | EntityCode | 實體編碼，使用客戶/廠商/商品的 Code 作為後綴（1191.C0001） |

#### AccountLevelFilter（層級篩選，用於報表）

| 值 | 名稱 | 說明 |
|----|------|------|
| 1 | Level1 | 第1層 |
| 2 | Level2 | 第2層 |
| 3 | Level3 | 第3層 |
| 4 | Level4 | 第4層 |
| 5 | Level5 | 第5層 |

**JournalEntry 相關 Enum：** `Models/Enums/JournalEntryEnums.cs`

| Enum | 值 | 說明 |
|------|---|------|
| JournalEntryType.AutoGenerated | 1 | 業務單據自動產生 |
| JournalEntryType.Manual | 2 | 會計人員手動輸入 |
| JournalEntryType.Adjusting | 3 | 調整分錄 |
| JournalEntryType.Closing | 4 | 結帳分錄 |
| JournalEntryType.Reversing | 5 | 沖銷分錄 |
| JournalEntryStatus.Draft | 1 | 草稿（可編輯，不影響帳） |
| JournalEntryStatus.Posted | 2 | 已過帳（鎖定，影響科目餘額） |
| JournalEntryStatus.Cancelled | 3 | 已取消 |
| JournalEntryStatus.Reversed | 4 | 已沖銷（原始傳票被反向沖銷） |

---

### 3. DbContext 設定

**檔案：** `Data/Context/AppDbContext.cs`

- `DbSet<AccountItem> AccountItems`
- OnModelCreating：自我參照關聯（Parent ↔ Children），刪除行為 `DeleteBehavior.Restrict`
- 唯一索引：Code
- 查詢索引：AccountType、AccountLevel、ParentId、IsDetailAccount
- 子科目 FK：LinkedCustomerId / LinkedSupplierId / LinkedProductId（各 SetNull + 過濾索引）
- `DbSet<JournalEntry> JournalEntries` / `DbSet<JournalEntryLine> JournalEntryLines`

---

### 4. Seeder 種子資料

**檔案：** `Data/SeedDataManager/Seeders/AccountItemSeeder.cs`

商業會計項目表 112 年度，共 553 筆，已透過 `Data/SeedData.cs` 註冊載入。

兩階段載入：
1. **第一階段**：建立所有 AccountItem（不含 ParentId）
2. **第二階段**：依科目代碼前綴對應，設定 ParentId 建立樹狀階層

| 層級 | 數量 | 說明 |
|------|------|------|
| Level 1 | 8 | 大分類（資產、負債、權益、收入、成本、費用、營業外、綜合損益） |
| Level 2 | 20 | 子分類（流動資產、非流動資產、流動負債等） |
| Level 3 | 94 | 中分類（現金及約當現金、應收帳款等） |
| Level 4 | 431 | 明細科目（庫存現金、銀行存款等）— 實際記帳使用 |
| **合計** | **553** | |

---

### 5. AccountItem Service

**檔案：** `Services/FinancialManagement/IAccountItemService.cs` / `AccountItemService.cs`

| 方法 | 說明 |
|------|------|
| `IsAccountItemCodeExistsAsync(code, excludeId?)` | 供 EntityCodeGenerationHelper 反射呼叫 |
| `GetByAccountTypeAsync(accountType)` | 依科目大類查詢 |
| `GetByLevelAsync(level)` | 依層級查詢 |
| `GetDetailAccountsAsync()` | 查詢所有明細科目 |
| `GetAllWithParentAsync()` | 查詢所有科目（含上層科目、LinkedCustomer/Supplier/Product） |
| `GetByCodeAsync(code)` | 依科目代碼查詢 Active 科目（供自動分錄使用） |
| `ValidateAsync` | 已增強：已過帳科目鎖定 AccountType、Direction、ParentId 不可修改 |

---

### 6. AccountItem FieldConfiguration / Index / EditModal

| 檔案 | 說明 |
|------|------|
| `Components/FieldConfiguration/AccountItemFieldConfiguration.cs` | 7 個欄位：Code、Name、AccountLevel、AccountType、Direction、IsDetailAccount、ParentName |
| `Components/Pages/FinancialManagement/AccountItemIndex.razor` | 路由 `/account-items`，科目列表、新增、編輯、刪除、狀態切換 |
| `Components/Pages/FinancialManagement/AccountItemEditModalComponent.razor` | 三個欄位群組：基本資料、科目屬性、附加資料 |

- 導覽：`NavigationConfig.cs` 已新增，QuickActionId = `"NewAccountItem"`
- `QuickActionModalHost.razor`：`"NewAccountItem"` → `AccountItemEditModalComponent`

---

### 7. 會計科目表報表（FN005）

| 檔案 | 路徑 |
|------|------|
| `AccountItemListCriteria.cs` | `Models/Reports/FilterCriteria/` |
| `IAccountItemListReportService.cs` | `Services/Reports/Interfaces/` |
| `AccountItemListReportService.cs` | `Services/Reports/` |

**篩選條件（AccountItemListCriteria）：**

| 欄位 | 類型 | 說明 |
|------|------|------|
| AccountTypes | FilterEnum(AccountType) | 科目大類多選 |
| AccountDirections | FilterEnum(AccountDirection) | 借貸方向多選 |
| AccountLevels | FilterEnum(AccountLevelFilter) | 層級多選 |
| CodeKeyword | FilterKeyword | 科目代碼搜尋 |
| NameKeyword | FilterKeyword | 科目名稱搜尋 |
| DetailAccountOnly | FilterToggle | 僅顯示明細科目 |

報表格式：依科目大類分組，表格含項次、科目代碼、科目名稱（含層級縮排）、層級、借貸方向、明細標記、上層科目。頁尾顯示統計數量及製表/財務主管簽名欄。

---

### 8. JournalEntry / JournalEntryLine Entity

**檔案：** `Data/Entities/FinancialManagement/JournalEntry.cs` / `JournalEntryLine.cs`

**JournalEntry 主要欄位：**

| 欄位 | 型別 | 說明 |
|------|------|------|
| EntryDate | DateTime | 傳票日期 |
| EntryType | JournalEntryType | 傳票類型 |
| JournalEntryStatus | JournalEntryStatus | 傳票狀態 |
| Description | string? | 傳票說明 |
| CompanyId | int | 公司 FK |
| FiscalYear | int | 會計年度 |
| FiscalPeriod | int (1-12) | 會計期間（月份） |
| SourceDocumentType | string? | 來源單據類型（"PurchaseReceiving" 等） |
| SourceDocumentId | int? | 來源單據 ID |
| SourceDocumentCode | string? | 來源單號（方便搜尋，免 JOIN） |
| TotalDebitAmount | decimal(18,2) | 借方合計 |
| TotalCreditAmount | decimal(18,2) | 貸方合計 |
| IsReversed | bool | 是否已被沖銷 |
| ReversalEntryId | int? | 沖銷傳票 ID（自我參照） |
| IsBalanced | [NotMapped] | TotalDebit == TotalCredit && > 0 |

**JournalEntryLine 主要欄位：**

| 欄位 | 型別 | 說明 |
|------|------|------|
| JournalEntryId | int | 傳票主檔 FK |
| LineNumber | int | 行次 |
| AccountItemId | int | 會計科目 FK（僅明細科目） |
| Direction | AccountDirection | 借方 / 貸方 |
| Amount | decimal(18,2) | 金額 |
| LineDescription | string? | 分錄說明 |

---

### 9. JournalEntry Service

**檔案：** `Services/FinancialManagement/IJournalEntryService.cs` / `JournalEntryService.cs`

命名空間：`ERPCore2.Services`（符合 `_Imports.razor` 慣例）

| 方法 | 說明 |
|------|------|
| `IsJournalEntryCodeExistsAsync` | 供 EntityCodeGenerationHelper 反射呼叫 |
| `GetByFiscalPeriodAsync` | 依會計年度+期間查詢（含分錄明細） |
| `GetBySourceDocumentAsync` | 依來源單據查詢已產生的傳票 |
| `GetDraftEntriesAsync` | 查詢所有草稿傳票 |
| `GetWithLinesAsync` | 取得含分錄明細的傳票（供 EditModal 使用） |
| `PostEntryAsync` | 過帳：Draft → Posted，須借貸平衡 |
| `ReverseEntryAsync` | 沖銷：建立反向傳票，原傳票標記 Reversed |
| `SaveWithLinesAsync` | 儲存傳票及分錄（含新增/更新/刪除行） |

---

### 10. JournalEntry FieldConfiguration / Index / EditModal

| 檔案 | 說明 |
|------|------|
| `Components/FieldConfiguration/JournalEntryFieldConfiguration.cs` | 8 欄位：Code、EntryDate（DateRange）、EntryType（badge）、JournalEntryStatus（badge）、Description、TotalDebitAmount、TotalCreditAmount、SourceDocumentCode |
| `Components/Pages/FinancialManagement/JournalEntryIndex.razor` | 路由 `/journal-entries`，標準 GenericIndexPageComponent |
| `Components/Pages/FinancialManagement/JournalEntryEditModalComponent.razor` | 全客製化 EditModal（含動態分錄行），使用 BaseModalComponent，按鈕置於 HeaderButtons |

**EditModal 特殊設計：**

- 主表單：EntryDate、EntryType、FiscalYear/FiscalPeriod（自動同步）、Status（唯讀）、Description
- 分錄明細表：選科目（僅明細科目）、借/貸方向、金額、說明、刪除按鈕
- 底部即時顯示：借方/貸方合計、差額 badge（平衡=綠色✓；不平衡=紅色差額）
- 操作按鈕（HeaderButtons）依狀態控制：
  - 草稿：取消 / 儲存草稿 / 過帳（不平衡時禁用）
  - 已過帳（未沖銷）：關閉 / 沖銷此傳票
  - 其他（已取消/已沖銷）：關閉

- 導覽：`NavigationConfig.cs` 已新增，QuickActionId = `"NewJournalEntry"`
- `PermissionSeeder.cs`：新增 `JournalEntry.Read` 權限
- `QuickActionModalHost.razor`：`"NewJournalEntry"` → `JournalEntryEditModalComponent`

---

### 11. 業務 Entity IsJournalized 欄位

五個業務 Entity 各新增：

```csharp
public bool IsJournalized { get; set; } = false;
public DateTime? JournalizedAt { get; set; }
```

| Entity | 檔案路徑 |
|--------|---------|
| PurchaseReceiving | `Data/Entities/Purchase/PurchaseReceiving.cs` |
| PurchaseReturn | `Data/Entities/Purchase/PurchaseReturn.cs` |
| SalesDelivery | `Data/Entities/Sales/SalesDelivery.cs` |
| SalesReturn | `Data/Entities/Sales/SalesReturn.cs` |
| SetoffDocument | `Data/Entities/FinancialManagement/SetoffDocument.cs` |

---

### 12. 批次轉傳票服務

**檔案：** `Services/FinancialManagement/IJournalEntryAutoGenerationService.cs` / `JournalEntryAutoGenerationService.cs`

支援五類業務單據批次轉傳票，轉換後自動過帳並標記 `IsJournalized = true`。

**科目常數（商業會計項目表 112 年度）：**

| 常數 | 代碼 | 科目名稱 |
|------|------|---------|
| AccountReceivableCode | 1191 | 應收帳款 |
| AccountPayableCode | 2171 | 應付帳款 |
| InventoryCode | 1231 | 商品存貨 |
| SalesRevenueCode | 4111 | 銷貨收入 |
| CostOfGoodsSoldCode | 5111 | 銷貨成本 |
| InputVatCode | 1268 | 進項稅額 |
| OutputVatCode | 2204 | 銷項稅額 |
| BankDepositCode | 1113 | 銀行存款 |
| SalesAllowanceCode | 4114 | 銷貨折讓 |
| PurchaseAllowanceCode | 5124 | 進貨折讓 |
| AdvanceFromCustomerCode | 2221 | 預收貨款 |
| AdvanceToSupplierCode | 1266 | 預付貨款 |

**分錄規則（稅額=0 時省略稅額行；COGS=0 時省略成本行）：**

```
進貨入庫：
  借：商品存貨 (1231)  = TotalAmount
  借：進項稅額 (1268)  = TaxAmount
    貸：應付帳款 (2171) = TotalAmountIncludingTax

進貨退回：
  借：應付帳款 (2171)  = TotalReturnAmountWithTax
    貸：商品存貨 (1231) = TotalReturnAmount
    貸：進項稅額 (1268) = ReturnTaxAmount

銷貨出貨：
  借：應收帳款 (1191)  = TotalAmountWithTax
    貸：銷貨收入 (4111) = TotalAmount
    貸：銷項稅額 (2204) = TaxAmount
  借：銷貨成本 (5111)  = COGS（移動加權均價 × 出庫量）
    貸：商品存貨 (1231) = COGS

銷貨退回：
  借：銷貨收入 (4111)  = TotalReturnAmount
  借：銷項稅額 (2204)  = ReturnTaxAmount
    貸：應收帳款 (1191) = TotalReturnAmountWithTax
  借：商品存貨 (1231)  = COGS 沖回
    貸：銷貨成本 (5111) = COGS 沖回

應收沖款（IsAccountsReceivable = true）：
  借：銀行存款 (1113)  = TotalCollectionAmount
  借：銷貨折讓 (4114)  = TotalAllowanceAmount
  借：預收貨款 (2221)  = PrepaymentSetoffAmount
    貸：應收帳款 (1191) = CurrentSetoffAmount

應付沖款（IsAccountsReceivable = false）：
  借：應付帳款 (2171)  = CurrentSetoffAmount
    貸：銀行存款 (1113) = TotalCollectionAmount
    貸：進貨折讓 (5124) = TotalAllowanceAmount
    貸：預付貨款 (1266) = PrepaymentSetoffAmount
```

**COGS 金額來源：** `InventoryTransaction.TotalAmount`（`ReduceStockAsync` 出庫時記錄，等於出庫量 × 當時移動加權均價，無須重新計算）

**JournalizeXxxAsync 執行流程：**

1. `GetBySourceDocumentAsync` → 防重複（已有傳票則回傳失敗）
2. 讀取原始單據（含 Include Supplier/Customer）
3. `GetByCodeAsync` 取得所需 AccountItem
4. 建立 `JournalEntry` + `JournalEntryLine` 清單
5. `CreateAndPostEntryAsync`：`SaveWithLinesAsync` → `PostEntryAsync`（Draft → Posted）
6. 標記 `IsJournalized = true`、`JournalizedAt = DateTime.Now`

---

### 13. 批次轉傳票頁面

**檔案：** `Components/Pages/FinancialManagement/JournalEntryBatchPage.razor`

- 路由：`/journal-entry-batch`
- 頂部日期範圍篩選 + 查詢/清除按鈕
- 5 個可折疊 Section：進貨入庫、進貨退回、銷貨出貨、銷貨退回、沖款單
- 每列有「轉傳票」按鈕（單筆）
- 右上角「全部轉傳票（N 筆）」批次按鈕
- 查詢使用 `Task.WhenAll` 並行取得五類待轉清單

---

### 14. 試算表（FN006）

| 檔案 | 路徑 |
|------|------|
| `TrialBalanceCriteria.cs` | `Models/Reports/FilterCriteria/` |
| `ITrialBalanceReportService.cs` | `Services/Reports/Interfaces/` |
| `TrialBalanceReportService.cs` | `Services/Reports/` |

**篩選條件：**

| 欄位 | 類型 | 說明 |
|------|------|------|
| StartDate / EndDate | FilterDateRange | 傳票日期範圍（本期發生額起訖） |
| AccountTypes | FilterEnum(AccountType) | 科目大類多選（空=全部） |
| ShowZeroBalance | FilterToggle | 顯示零餘額科目（預設 false） |

**查詢邏輯（兩次查詢）：**
- Query 1：`EntryDate BETWEEN StartDate AND EndDate` → 本期借方/貸方發生額
- Query 2：`EntryDate <= EndDate`（不限起始）→ 期末累計借方/貸方餘額

**期末餘額計算：**
- 借方正常科目：`EndingDebitBalance = CumulativeDebit - CumulativeCredit`
- 貸方正常科目：`EndingCreditBalance = CumulativeCredit - CumulativeDebit`

**報表格式：** 依 AccountType 分組，欄位：科目代碼 | 科目名稱 | 本期借方 | 本期貸方 | 期末借方餘額 | 期末貸方餘額。頁尾驗證借方/貸方合計平衡，製表人員/財務主管簽名欄。

---

### 15. 損益表（FN007）

| 檔案 | 路徑 |
|------|------|
| `IncomeStatementCriteria.cs` | `Models/Reports/FilterCriteria/` |
| `IIncomeStatementReportService.cs` | `Services/Reports/Interfaces/` |
| `IncomeStatementReportService.cs` | `Services/Reports/` |

**篩選條件：** StartDate / EndDate（FilterDateRange）

**固定查詢範圍：** AccountType in {Revenue(4), Cost(5), Expense(6), NonOperatingIncomeAndExpense(7)}

**餘額計算規則：**
- Revenue（Credit 正常）：Balance = Credit - Debit
- Cost/Expense（Debit 正常）：Balance = Debit - Credit
- NonOperating：依各科目 `Direction` 屬性決定

**報表結構：**

```
一、銷貨收入             xxx
    各科目明細...

二、減：銷貨成本         (xxx)
    各科目明細...

毛利潤：                 xxx

三、減：營業費用         (xxx)
    各科目明細...

營業損益：               xxx

四、營業外收益及費損     xxx（淨額）
    各科目明細（收益+/費損-）...

稅前損益：               xxx
```

---

### 16. 資產負債表（FN008）

| 檔案 | 路徑 |
|------|------|
| `BalanceSheetCriteria.cs` | `Models/Reports/FilterCriteria/` |
| `IBalanceSheetReportService.cs` | `Services/Reports/Interfaces/` |
| `BalanceSheetReportService.cs` | `Services/Reports/` |

**篩選條件：** StartDate / EndDate（FilterDateRange），EndDate 作為截止日

**核心屬性：** `AsOfDate = EndDate ?? DateTime.Today`

**固定查詢範圍：** AccountType in {Asset(1), Liability(2), Equity(3)}，`EntryDate <= AsOfDate`

**報表結構：**

```
【資產】
  各科目明細（Balance = Debit - Credit）
資產合計   xxx

【負債】
  各科目明細（Balance = Credit - Debit）
負債合計   xxx

【權益】
  各科目明細（Balance = Credit - Debit）
權益合計   xxx

負債及權益合計   xxx
```

頁尾：驗證 `|資產合計 - 負債及權益合計| < 0.01`（✓ 平衡 或 ⚠ 差額）

---

## 科目階層結構

科目表採用四層樹狀結構，以「庫存現金」為例：

```
Level 1: Code "1"     → 資產（ParentId: null）
  Level 2: Code "11-12" → 流動資產（ParentId → "1"）
    Level 3: Code "111"    → 現金及約當現金（ParentId → "11-12"）
      Level 4: Code "1111"   → 庫存現金（ParentId → "111"）← 實際記帳科目
```

**原始 Excel 層級對應：**
- Excel「一級項目」單位數代碼（1~8）→ Level 1
- Excel「一級項目」多位數代碼（11-12、31 等）→ Level 2
- Excel「二級項目」（111、112 等）→ Level 3
- Excel「四級項目」（1111、1112 等）→ Level 4（Excel「三級項目」為空，不使用）

---

## 報表系統通用架構（FN005~FN008）

| 項目 | 設計 |
|------|------|
| 服務介面模式 | 不繼承 `IEntityReportService<T>`，只定義 `RenderBatchToImagesAsync(XxxCriteria)` |
| 呼叫方式 | `GenericReportFilterModalComponent` 透過反射呼叫 |
| 入口點 | 報表中心（Alt+R 或選單）→ 搜尋 → 篩選 → 預覽 → 列印 |
| DI 注冊 | `AddScoped<IXxxReportService, XxxReportService>()` in `ServiceRegistration.cs` |
| 報表定義 | `ReportRegistry.cs`，Category = `ReportCategory.Financial`，Permission = `JournalEntry.Read` |
| 篩選模板 | `FilterTemplateRegistry.cs`，使用 `DynamicFilterTemplate` |

---

## 待辦項目

### 近期

- [ ] 在業務單據 EditModal 加入「相關傳票」顯示區塊（透過 SourceDocumentType + SourceDocumentId 查詢）

### 中長期

- [ ] 期初存貨建立功能（正式程序輸入量+成本，同時產生 InventoryTransaction + JournalEntry：借 商品存貨 / 貸 期初存貨調整）
- [ ] 科目餘額細帳（依科目查傳票明細，類似帳卡）
- [ ] 期末結帳功能（Closing Entries：收入/費用科目歸零 → 轉本期損益 → 轉保留盈餘）
- [ ] 現金流量表（間接法）
- [ ] 報表匯出功能（PDF / Excel）

---

## 相關檔案一覽

| 檔案 | 路徑 | 說明 |
|------|------|------|
| AccountItem.cs | `Data/Entities/FinancialManagement/` | AccountItem Entity（含子科目欄位） |
| AccountingEnums.cs | `Models/Enums/` | AccountType、AccountDirection、SubAccountCodeFormat、AccountLevelFilter |
| AccountItemSeeder.cs | `Data/SeedDataManager/Seeders/` | 553 筆種子資料（112年度） |
| AppDbContext.cs | `Data/Context/` | DbSet 與關聯設定 |
| IAccountItemService.cs | `Services/FinancialManagement/` | 科目服務介面 |
| AccountItemService.cs | `Services/FinancialManagement/` | 科目服務實作 |
| AccountItemFieldConfiguration.cs | `Components/FieldConfiguration/` | 科目欄位定義 |
| AccountItemIndex.razor | `Components/Pages/FinancialManagement/` | 科目列表頁面（/account-items） |
| AccountItemEditModalComponent.razor | `Components/Pages/FinancialManagement/` | 科目編輯表單 |
| AccountItemListCriteria.cs | `Models/Reports/FilterCriteria/` | FN005 篩選條件 |
| IAccountItemListReportService.cs | `Services/Reports/Interfaces/` | FN005 服務介面 |
| AccountItemListReportService.cs | `Services/Reports/` | FN005 服務實作 |
| JournalEntryEnums.cs | `Models/Enums/` | JournalEntryType、JournalEntryStatus |
| JournalEntry.cs | `Data/Entities/FinancialManagement/` | 傳票主檔 Entity |
| JournalEntryLine.cs | `Data/Entities/FinancialManagement/` | 傳票分錄明細 Entity |
| IJournalEntryService.cs | `Services/FinancialManagement/` | 傳票服務介面 |
| JournalEntryService.cs | `Services/FinancialManagement/` | 傳票服務實作 |
| JournalEntryFieldConfiguration.cs | `Components/FieldConfiguration/` | 傳票欄位定義 |
| JournalEntryIndex.razor | `Components/Pages/FinancialManagement/` | 傳票列表頁面（/journal-entries） |
| JournalEntryEditModalComponent.razor | `Components/Pages/FinancialManagement/` | 傳票編輯 Modal（BaseModalComponent，按鈕於 HeaderButtons） |
| IJournalEntryAutoGenerationService.cs | `Services/FinancialManagement/` | 批次轉傳票服務介面 |
| JournalEntryAutoGenerationService.cs | `Services/FinancialManagement/` | 批次轉傳票服務實作（五類單據 + COGS + 子科目整合） |
| JournalEntryBatchPage.razor | `Components/Pages/FinancialManagement/` | 批次轉傳票頁面（/journal-entry-batch） |
| ISubAccountService.cs | `Services/FinancialManagement/` | 子科目服務介面 |
| SubAccountService.cs | `Services/FinancialManagement/` | 子科目服務實作（Sequential/EntityCode 雙格式） |
| SystemParameterSettingsModal.razor | `Components/Pages/Systems/` | 系統參數設定（含子科目設定頁籤） |
| TrialBalanceCriteria.cs | `Models/Reports/FilterCriteria/` | FN006 篩選條件 |
| IncomeStatementCriteria.cs | `Models/Reports/FilterCriteria/` | FN007 篩選條件 |
| BalanceSheetCriteria.cs | `Models/Reports/FilterCriteria/` | FN008 篩選條件 |
| ITrialBalanceReportService.cs | `Services/Reports/Interfaces/` | FN006 服務介面 |
| IIncomeStatementReportService.cs | `Services/Reports/Interfaces/` | FN007 服務介面 |
| IBalanceSheetReportService.cs | `Services/Reports/Interfaces/` | FN008 服務介面 |
| TrialBalanceReportService.cs | `Services/Reports/` | FN006 服務實作 |
| IncomeStatementReportService.cs | `Services/Reports/` | FN007 服務實作 |
| BalanceSheetReportService.cs | `Services/Reports/` | FN008 服務實作 |

---

## 設計決策

### 科目階層：單一表格 + ParentId 自我參照

採用單一表格加自我參照，原因：原始 Excel 第三級為空，層級數量不固定，樹狀結構可自然處理，且報表彙總需要逐層遞迴，樹狀模型是最適合的資料模型。

### 每筆資料標記 AccountType

為了報表產生效能，每筆資料直接標記 AccountType，避免每次查詢都需要遞迴到根節點。

### 借貸方向預設規則

| 方向 | 適用科目 |
|------|---------|
| Debit | 資產（1）、營業成本（5）、營業費用（6）、營業外收益及費損（7） |
| Credit | 負債（2）、權益（3）、營業收入（4）、綜合損益總額（8） |

### 批次轉傳票（非即時）

業務單據確認後仍可修改內容，即時轉傳票會造成傳票與單據金額不符。採批次方式，讓會計人員月底審核無誤後再一次執行，轉換後以 `IsJournalized = true` 鎖定。

### COGS 計算方式

採用移動加權平均成本法（Moving Weighted Average Cost）。COGS 金額取自 `InventoryTransaction.TotalAmount`（出庫時由 `ReduceStockAsync` 自動寫入：出庫量 × 當時 AverageCost）。期初存貨功能列入中長期規劃；現階段 COGS 分錄依賴 InventoryTransaction 已有的正確成本記錄。

---

## 子科目（明細科目）自動產生系統

**版本：** 2026-02-23

### 功能概述

客戶、廠商、商品建立時，在對應統制科目下自動建立明細子科目，批次轉傳票改用子科目（fallback 統制科目）。系統參數可控制是否啟用、統制科目代碼、及代碼產生格式。

### 子科目代碼格式（兩種模式）

| 模式 | 說明 | 範例 |
|------|------|------|
| Sequential（流水號） | 三位補零流水號，依建立順序遞增 | `1191.001`、`1191.002` |
| EntityCode（實體編碼） | 使用客戶/廠商/商品的 Code 欄位作後綴（點號過濾） | `1191.C0001` |

> **選用建議：** 流水號適合大量客戶/廠商，一眼看不出對應實體；實體編碼適合代碼有意義的場景，可從代碼直接辨認對應實體。

### 子科目 Name / Description 命名規則

| 欄位 | 值 | 說明 |
|------|----|----|
| `Name` | 繼承上層科目名稱（如 `應收帳款`） | 讓子科目出現在試算表時仍可辨認科目性質 |
| `Description` | 連結實體名稱（公司名或商品名） | 供人工查核時辨認對應實體 |

### Entity 新增欄位

> 欄位說明已整合至第 1 節 AccountItem Entity。

**`SystemParameter`** 新增：

| 欄位 | 型別 | 預設值 | 說明 |
|------|------|--------|------|
| AutoCreateCustomerSubAccount | bool | false | 自動建立客戶子科目 |
| AutoCreateSupplierSubAccount | bool | false | 自動建立廠商子科目 |
| AutoCreateProductSubAccount | bool | false | 自動建立商品子科目 |
| CustomerSubAccountParentCode | string (Max 20) | 1191 | 應收帳款統制科目代碼（可依公司科目表調整） |
| SupplierSubAccountParentCode | string (Max 20) | 2171 | 應付帳款統制科目代碼（可依公司科目表調整） |
| ProductSubAccountParentCode | string (Max 20) | 1231 | 商品存貨統制科目代碼（可依公司科目表調整） |
| SubAccountCodeFormat | SubAccountCodeFormat | Sequential | 子科目代碼格式（0=流水號；1=實體編碼） |

> **預設值說明：** 統制科目代碼採用台灣「商業會計項目表 112 年度」對應代碼，各公司科目表可能不同，因此保留可編輯。

### 新增服務

**`ISubAccountService` / `SubAccountService`**（`Services/FinancialManagement/`）

| 方法 | 說明 |
|------|------|
| `GetSubAccountForCustomerAsync(int)` | 查詢客戶子科目（不建立） |
| `GetSubAccountForSupplierAsync(int)` | 查詢廠商子科目（不建立） |
| `GetSubAccountForProductAsync(int)` | 查詢商品子科目（不建立） |
| `GetOrCreateCustomerSubAccountAsync(int, string)` | 取得或建立客戶子科目（需系統參數啟用） |
| `GetOrCreateSupplierSubAccountAsync(int, string)` | 取得或建立廠商子科目（需系統參數啟用） |
| `GetOrCreateProductSubAccountAsync(int, string)` | 取得或建立商品子科目（需系統參數啟用） |
| `BatchCreateForAllCustomersAsync(string)` | 批次補建所有現有 Active 客戶子科目 |
| `BatchCreateForAllSuppliersAsync(string)` | 批次補建所有現有 Active 廠商子科目 |
| `BatchCreateForAllProductsAsync(string)` | 批次補建所有現有 Active 商品子科目 |

**GetOrCreate 執行流程：**
1. 檢查是否已存在對應子科目（`LinkedCustomerId/SupplierId/ProductId`）→ 直接回傳
2. 讀取 SystemParameter；若功能未啟用（`AutoCreateXxxSubAccount = false`）→ 回傳 null
3. 查詢統制科目（依 `XxxSubAccountParentCode`）；找不到 → log warning + 回傳 null
4. `GenerateSubAccountCodeAsync`：依 `SubAccountCodeFormat` 產生代碼
5. 建立子科目：`Name = parent.Name`、`Description = 公司名/商品名`
6. 直接寫 DB（繞過 AccountItemService，避免觸發唯一代碼競爭）

### 已過帳科目鎖定

**`AccountItemService.ValidateAsync`** 增強：若科目已有「已過帳」傳票行，下列欄位不允許修改：
- `AccountType`（科目大類）
- `Direction`（借貸方向）
- `ParentId`（上層科目）

### 批次轉傳票整合

`JournalEntryAutoGenerationService` 新增兩個私有 helper：
- `GetARAccountForCustomerAsync(customerId)`：優先取客戶子科目，找不到 fallback `1191`
- `GetAPAccountForSupplierAsync(supplierId)`：優先取廠商子科目，找不到 fallback `2171`

涵蓋文件類型：進貨入庫、進貨退回、銷貨出貨、銷貨退回、沖款單、銷貨折讓、進貨折讓。
商品子科目（`1231.*`）本版未整合進 COGS 傳票（一張出貨單含多商品，拆分複雜）。

### 系統參數設定頁面

**`Components/Pages/Systems/SystemParameterSettingsModal.razor`** 新增「子科目設定」頁籤：
- **自動產生設定**：三個開關（客戶/廠商/商品）+ 代碼格式下拉（含 LabelHelpItems 說明）
- **統制科目代碼**：三個文字欄位（應收/應付/商品存貨）
- **批次補建**：三個按鈕（補建客戶/廠商/商品），含執行結果顯示，關閉 Modal 時自動清除結果

### Migrations

| Migration | 說明 |
|-----------|------|
| `20260223143910_AddSubAccountFields` | `AccountItems` 新增 4 欄（3 FK + IsAutoGenerated）+ FK 索引；`SystemParameters` 新增 6 欄（3 開關 + 3 代碼） |
| `20260223150439_FixSubAccountParentCodeDefaults` | 資料修正：將空字串的統制科目代碼補回預設值（1191/2171/1231） |
| `20260223152706_AddSubAccountCodeFormat` | `SystemParameters` 新增 `SubAccountCodeFormat` int 欄（defaultValue: 0） |
