# 進貨明細管理組件 - 鎖定明細保護機制（快速參考）

## 🎯 修改目標

防止 Footer 批次操作按鈕影響已有退貨/沖款記錄的「被鎖定」明細。

## 🔧 修改內容

### 1. 載入所有未入庫
- **策略**：完全禁用
- **條件**：當存在任何被鎖定的明細時，按鈕變灰且無法點擊
- **原因**：此操作會清空所有明細，風險極高

### 2. 統一倉庫
- **策略**：智能過濾
- **行為**：只修改未鎖定的明細，跳過被鎖定的明細
- **提示**：「已統一設定 X 項明細（已跳過 Y 項已鎖定的明細）」

### 3. 進貨量全填
- **策略**：智能過濾
- **行為**：只填入未鎖定明細的數量
- **提示**：「已填入 X 項明細（已跳過 Y 項已鎖定的明細）」

### 4. 進貨量清空
- **策略**：智能過濾
- **行為**：只清空未鎖定明細的數量
- **提示**：「已清空 X 項明細（已跳過 Y 項已鎖定的明細）」

### 5. 清除明細
- **策略**：智能過濾
- **行為**：只刪除未鎖定的明細，保留被鎖定的明細
- **提示**：「已清除 X 項明細（已保留 Y 項已鎖定的明細）」

## 🔒 被鎖定的明細

明細在以下情況下被視為「鎖定」：
1. **有退貨記錄**：`HasReturnRecord(item)` = true
2. **有沖款記錄**：`HasPaymentRecord(item)` = true

判斷方法：`CanDeleteItem(item, out _)` 回傳 false

## 📋 新增的輔助方法

```csharp
/// <summary>
/// 檢查是否有被鎖定的明細（有退貨或沖款記錄的明細）
/// </summary>
private bool HasLockedDetails()
{
    return ReceivingItems.Any(item => 
        !IsEmptyRow(item) && 
        (HasReturnRecord(item) || HasPaymentRecord(item)));
}
```

## 🎨 使用者體驗

### 視覺回饋
- ✅ 按鈕禁用：灰色且無法點擊
- 💬 明確的提示訊息：告知處理了多少項、跳過了多少項
- ⚠️ 友善的警告：當全部明細都被鎖定時

### 操作流程示例

**情境：部分被鎖定**
```
點擊「統一倉庫」→ 選擇倉庫
↓
修改 3 個未鎖定的明細
保留 2 個被鎖定的明細
↓
通知：已統一設定 3 項明細的倉庫為：主倉庫
     （已跳過 2 項已鎖定的明細）
```

**情境：全部被鎖定**
```
點擊「統一倉庫」→ 選擇倉庫
↓
警告：所有明細都已有退貨或沖款記錄，無法統一設定倉庫
```

## 📊 比較表

| 按鈕 | 原本行為 | 新行為 | 策略 |
|------|---------|--------|------|
| 載入所有未入庫 | 清空所有明細並載入 | 有鎖定明細時禁用按鈕 | 完全禁用 |
| 統一倉庫 | 修改所有明細 | 只修改未鎖定明細 | 智能過濾 |
| 進貨量全填 | 填入所有明細 | 只填入未鎖定明細 | 智能過濾 |
| 進貨量清空 | 清空所有明細 | 只清空未鎖定明細 | 智能過濾 |
| 清除明細 | 刪除所有明細 | 只刪除未鎖定明細 | 智能過濾 |

## 🧪 快速測試

1. 建立進貨單，其中 1 個明細有退貨記錄
2. 確認「載入所有未入庫」按鈕被禁用 ✅
3. 點擊「統一倉庫」，確認只修改未鎖定明細 ✅
4. 確認提示訊息正確顯示跳過的數量 ✅

## 📁 相關檔案

- 主要組件：`Components/Shared/SubCollections/PurchaseReceivingDetailManagerComponent.razor`
- 詳細文件：`Documentation/README_PurchaseReceivingDetailManager_鎖定明細保護.md`

## 📅 修改資訊

- **日期**：2025-10-13
- **修改範圍**：Footer 批次操作按鈕行為
- **向下相容**：是（不影響現有單一明細的鎖定邏輯）
