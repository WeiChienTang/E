# ä½¿ç”¨è€…æ§åˆ¶å¯©æ ¸æ©Ÿåˆ¶

## ğŸ“‹ æ¦‚è¿°

æœ¬åŠŸèƒ½å…è¨±ç®¡ç†å“¡é€éç³»çµ±åƒæ•¸è¨­å®šé é¢ï¼Œè‡ªç”±é–‹å•Ÿæˆ–é—œé–‰å„ç¨®å–®æ“šçš„å¯©æ ¸æµç¨‹ï¼Œæä¾›é«˜åº¦å½ˆæ€§ä»¥é©æ‡‰ä¸åŒè¦æ¨¡ä¼æ¥­çš„éœ€æ±‚ã€‚

---

## ğŸ¯ åŠŸèƒ½ç›®æ¨™

### æ¥­å‹™éœ€æ±‚
1. **å½ˆæ€§æ§åˆ¶**ï¼šä¸åŒä¼æ¥­å°å¯©æ ¸æµç¨‹çš„éœ€æ±‚ä¸åŒï¼Œå°å‹ä¼æ¥­å¯èƒ½ä¸éœ€è¦åš´æ ¼å¯©æ ¸ï¼Œå¤§å‹ä¼æ¥­å‰‡éœ€è¦å®Œæ•´çš„å¯©æ ¸æ©Ÿåˆ¶
2. **å³æ™‚åˆ‡æ›**ï¼šç®¡ç†å“¡å¯ä»¥éš¨æ™‚é–‹å•Ÿæˆ–é—œé–‰å¯©æ ¸åŠŸèƒ½ï¼Œç„¡éœ€ä¿®æ”¹ç¨‹å¼ç¢¼
3. **åˆ†é¡ç®¡ç†**ï¼šæ¡è³¼ã€éŠ·å”®ã€åº«å­˜ç­‰ä¸åŒæµç¨‹å¯ç¨ç«‹è¨­å®šå¯©æ ¸éœ€æ±‚
4. **å‘ä¸‹ç›¸å®¹**ï¼šé è¨­å€¼ä¿æŒèˆ‡ç¾æœ‰ç³»çµ±ä¸€è‡´ï¼Œä¸å½±éŸ¿ç¾æœ‰åŠŸèƒ½

### æŠ€è¡“ç›®æ¨™
1. çµ±ä¸€çš„å¯©æ ¸é‚è¼¯ç®¡ç†
2. é«˜æ•ˆèƒ½çš„è¨­å®šæŸ¥è©¢ï¼ˆå¸¶å¿«å–æ©Ÿåˆ¶ï¼‰
3. æ˜“æ–¼æ“´å……çš„æ¶æ§‹è¨­è¨ˆ
4. æ¸…æ™°çš„ä½¿ç”¨è€…ä»‹é¢

---

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

### å±¤ç´šçµæ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UI Layer (å‰ç«¯å±¤)                      â”‚
â”‚  - ApprovalSettingsTab.razor (å¯©æ ¸è¨­å®š Tab)              â”‚
â”‚  - PurchaseOrderEditModalComponent.razor (æ¡è³¼å–®ç·¨è¼¯)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  Helper Layer (è¼”åŠ©å±¤)                    â”‚
â”‚  - ApprovalConfigHelper (å¯©æ ¸é‚è¼¯çµ±ä¸€ç®¡ç†)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 Service Layer (æœå‹™å±¤)                    â”‚
â”‚  - ISystemParameterService (å¯©æ ¸æŸ¥è©¢ä»‹é¢)                â”‚
â”‚  - SystemParameterService (å¸¶å¿«å–çš„å¯¦ä½œ)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   Data Layer (è³‡æ–™å±¤)                     â”‚
â”‚  - SystemParameter Entity (å¯©æ ¸é–‹é—œæ¬„ä½)                 â”‚
â”‚  - Migration: AddApprovalConfigToSystemParameter         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ æ–°å¢/ä¿®æ”¹çš„æª”æ¡ˆ

### 1. è³‡æ–™å±¤ (Data Layer)

#### âœ¨ ä¿®æ”¹ï¼š`Data/Entities/Systems/SystemParameter.cs`
æ–°å¢ä»¥ä¸‹æ¬„ä½ï¼š

```csharp
/// <summary>
/// æ˜¯å¦å•Ÿç”¨æ¡è³¼å–®å¯©æ ¸
/// </summary>
[Display(Name = "å•Ÿç”¨æ¡è³¼å–®å¯©æ ¸")]
public bool EnablePurchaseOrderApproval { get; set; } = true;

/// <summary>
/// æ˜¯å¦å•Ÿç”¨é€²è²¨å–®å¯©æ ¸
/// </summary>
[Display(Name = "å•Ÿç”¨é€²è²¨å–®å¯©æ ¸")]
public bool EnablePurchaseReceivingApproval { get; set; } = false;

/// <summary>
/// æ˜¯å¦å•Ÿç”¨é€²è²¨é€€å›å¯©æ ¸
/// </summary>
[Display(Name = "å•Ÿç”¨é€²è²¨é€€å›å¯©æ ¸")]
public bool EnablePurchaseReturnApproval { get; set; } = false;

/// <summary>
/// æ˜¯å¦å•Ÿç”¨éŠ·è²¨å–®å¯©æ ¸
/// </summary>
[Display(Name = "å•Ÿç”¨éŠ·è²¨å–®å¯©æ ¸")]
public bool EnableSalesOrderApproval { get; set; } = false;

/// <summary>
/// æ˜¯å¦å•Ÿç”¨éŠ·è²¨é€€å›å¯©æ ¸
/// </summary>
[Display(Name = "å•Ÿç”¨éŠ·è²¨é€€å›å¯©æ ¸")]
public bool EnableSalesReturnApproval { get; set; } = false;

/// <summary>
/// æ˜¯å¦å•Ÿç”¨åº«å­˜èª¿æ’¥å¯©æ ¸
/// </summary>
[Display(Name = "å•Ÿç”¨åº«å­˜èª¿æ’¥å¯©æ ¸")]
public bool EnableInventoryTransferApproval { get; set; } = false;
```

**é è¨­å€¼èªªæ˜ï¼š**
- æ¡è³¼å–®å¯©æ ¸ï¼šé è¨­ `true`ï¼ˆä¿æŒç¾æœ‰è¡Œç‚ºï¼‰
- å…¶ä»–å¯©æ ¸ï¼šé è¨­ `false`ï¼ˆé è¨­ä¸å•Ÿç”¨ï¼Œç”±ç®¡ç†å“¡æ±ºå®šï¼‰

#### âœ¨ æ–°å¢ï¼šMigration
- **æª”æ¡ˆåç¨±ï¼š** `20251024234825_AddApprovalConfigToSystemParameter.cs`
- **èªªæ˜ï¼š** åœ¨ `SystemParameters` è³‡æ–™è¡¨æ–°å¢ 6 å€‹å¯©æ ¸é–‹é—œæ¬„ä½

---

### 2. æœå‹™å±¤ (Service Layer)

#### âœ¨ ä¿®æ”¹ï¼š`Services/Systems/ISystemParameterService.cs`

**æ–°å¢å¯©æ ¸é¡å‹åˆ—èˆ‰ï¼š**
```csharp
public enum ApprovalType
{
    PurchaseOrder,        // æ¡è³¼å–®
    PurchaseReceiving,    // é€²è²¨å–®
    PurchaseReturn,       // é€²è²¨é€€å›
    SalesOrder,           // éŠ·è²¨å–®
    SalesReturn,          // éŠ·è²¨é€€å›
    InventoryTransfer     // åº«å­˜èª¿æ’¥
}
```

**æ–°å¢ä»‹é¢æ–¹æ³•ï¼š**
```csharp
// çµ±ä¸€æŸ¥è©¢æ–¹æ³•
Task<bool> IsApprovalEnabledAsync(ApprovalType approvalType);

// å€‹åˆ¥æŸ¥è©¢æ–¹æ³•
Task<bool> IsPurchaseOrderApprovalEnabledAsync();
Task<bool> IsPurchaseReceivingApprovalEnabledAsync();
Task<bool> IsPurchaseReturnApprovalEnabledAsync();
Task<bool> IsSalesOrderApprovalEnabledAsync();
Task<bool> IsSalesReturnApprovalEnabledAsync();
Task<bool> IsInventoryTransferApprovalEnabledAsync();

// å¿«å–ç®¡ç†
void ClearApprovalConfigCache();
```

#### âœ¨ ä¿®æ”¹ï¼š`Services/Systems/SystemParameterService.cs`

**å¯¦ä½œé‡é»ï¼š**
1. **å¿«å–æ©Ÿåˆ¶**ï¼š5 åˆ†é˜å¿«å–ï¼Œæ¸›å°‘è³‡æ–™åº«æŸ¥è©¢
   ```csharp
   private SystemParameter? _cachedParameter;
   private DateTime _cacheExpiration = DateTime.MinValue;
   private readonly TimeSpan _cacheDuration = TimeSpan.FromMinutes(5);
   ```

2. **çµ±ä¸€æŸ¥è©¢é‚è¼¯**ï¼š
   ```csharp
   public async Task<bool> IsApprovalEnabledAsync(ApprovalType approvalType)
   {
       var parameter = await GetCachedSystemParameterAsync();
       return approvalType switch
       {
           ApprovalType.PurchaseOrder => parameter.EnablePurchaseOrderApproval,
           // ... å…¶ä»–é¡å‹
       };
   }
   ```

3. **è‡ªå‹•æ¸…é™¤å¿«å–**ï¼šè¦†å¯« `UpdateAsync` æ–¹æ³•ï¼Œæ›´æ–°åƒæ•¸æ™‚è‡ªå‹•æ¸…é™¤å¿«å–

---

### 3. è¼”åŠ©å±¤ (Helper Layer)

#### âœ¨ æ–°å¢ï¼š`Helpers/ApprovalConfigHelper.cs`

**åŠŸèƒ½ï¼š** çµ±ä¸€ç®¡ç†å¯©æ ¸ç›¸é—œçš„åˆ¤æ–·é‚è¼¯

**ä¸»è¦æ–¹æ³•ï¼š**

1. **åˆ¤æ–·æ¬„ä½æ˜¯å¦é–å®š**
   ```csharp
   public static bool ShouldLockFieldByApproval(
       bool isApprovalEnabled,
       bool isApproved,
       bool hasUndeletableDetails)
   {
       if (!isApprovalEnabled)
       {
           // æœªå•Ÿç”¨å¯©æ ¸ï¼šåªæ ¹æ“šã€Œæ˜¯å¦æœ‰ä¸‹ä¸€æ­¥å‹•ä½œã€é–å®š
           return hasUndeletableDetails;
       }
       else
       {
           // å·²å•Ÿç”¨å¯©æ ¸ï¼šæ ¹æ“šã€Œå¯©æ ¸ç‹€æ…‹ æˆ– æ˜¯å¦æœ‰ä¸‹ä¸€æ­¥å‹•ä½œã€é–å®š
           return isApproved || hasUndeletableDetails;
       }
   }
   ```

2. **åˆ¤æ–·æ˜¯å¦å¯åŸ·è¡Œéœ€å¯©æ ¸çš„å‹•ä½œ**
   ```csharp
   public static bool CanPerformActionRequiringApproval(
       bool isApprovalEnabled,
       bool isApproved)
   {
       return !isApprovalEnabled || isApproved;
   }
   ```

3. **åˆ¤æ–·æ˜¯å¦å¯å„²å­˜**
   ```csharp
   public static bool CanSaveWhenApproved(
       bool isApprovalEnabled,
       bool isApproved,
       bool isPreApprovalSave = false)
   {
       if (!isApprovalEnabled || isPreApprovalSave)
           return true;
       
       return !isApproved;
   }
   ```

4. **å–å¾—è­¦å‘Šè¨Šæ¯**
   ```csharp
   public static string? GetApprovalWarningMessage(
       bool isApprovalEnabled,
       bool isApproved,
       string entityName = "å–®æ“š")
   ```

---

### 4. UI å±¤ (UI Layer)

#### âœ¨ æ–°å¢ï¼š`Components/Pages/Systems/SystemParameterSettings/Shared/Tabs/ApprovalSettingsTab.razor`

**åŠŸèƒ½ï¼š** å¯©æ ¸æµç¨‹è¨­å®šä»‹é¢

**UI ç‰¹è‰²ï¼š**
- **åˆ†å€è¨­è¨ˆ**ï¼šæ¡è³¼æµç¨‹ã€éŠ·å”®æµç¨‹ã€åº«å­˜æµç¨‹ä¸‰å€‹å€æ®µ
- **å³æ™‚é è¦½**ï¼šå³å´é è¦½å€é¡¯ç¤ºç•¶å‰æ‰€æœ‰è¨­å®šç‹€æ…‹
- **ç‹€æ…‹æç¤º**ï¼šæ¯å€‹é–‹é—œéƒ½æœ‰æ¸…æ¥šçš„ç‹€æ…‹èªªæ˜ï¼ˆå·²å•Ÿç”¨/æœªå•Ÿç”¨ï¼‰
- **æ“ä½œèªªæ˜**ï¼šåº•éƒ¨èªªæ˜å€åŸŸè§£é‡‹å¯©æ ¸æµç¨‹çš„æ„ç¾©å’Œå»ºè­°

**UI çµæ§‹ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¡è³¼æµç¨‹å¯©æ ¸                                    â”‚
â”‚  â”œâ”€ æ¡è³¼å–®å¯©æ ¸      [âœ“]                         â”‚
â”‚  â”œâ”€ é€²è²¨å–®å¯©æ ¸      [ ]                         â”‚
â”‚  â””â”€ é€²è²¨é€€å›å¯©æ ¸    [ ]                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  éŠ·å”®æµç¨‹å¯©æ ¸                                    â”‚
â”‚  â”œâ”€ éŠ·è²¨å–®å¯©æ ¸      [ ]                         â”‚
â”‚  â””â”€ éŠ·è²¨é€€å›å¯©æ ¸    [ ]                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åº«å­˜æµç¨‹å¯©æ ¸                                    â”‚
â”‚  â””â”€ åº«å­˜èª¿æ’¥å¯©æ ¸    [ ]                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [èªªæ˜å€åŸŸ]                                      â”‚
â”‚  - å•Ÿç”¨å¯©æ ¸ï¼šéœ€ç¶“å¯©æ ¸é€šéå¾Œæ‰èƒ½åŸ·è¡Œä¸‹ä¸€æ­¥        â”‚
â”‚  - æœªå•Ÿç”¨å¯©æ ¸ï¼šå„²å­˜å¾Œå¯ç›´æ¥åŸ·è¡Œå¾ŒçºŒæ“ä½œ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### âœ¨ ä¿®æ”¹ï¼š`Components/Pages/Systems/SystemParameterSettings/SystemParameterSettings.razor`

**è®Šæ›´å…§å®¹ï¼š**
1. æ–°å¢ã€Œå¯©æ ¸æµç¨‹è¨­å®šã€Tab å®šç¾©
2. æ–°å¢ Tab å…§å®¹å€åŸŸï¼Œæ•´åˆ `ApprovalSettingsTab`

**æ–°å¢ Tabï¼š**
```csharp
tabDefinitions = new()
{
    new("basic", "ç³»çµ±åŸºæœ¬è¨­å®š", ""),
    new("approval", "å¯©æ ¸æµç¨‹è¨­å®š", ""),  // â† æ–°å¢
    new("appearance", "å¤–è§€è¨­å®š", ""),
    // ...
};
```

#### âœ¨ ä¿®æ”¹ï¼š`Components/Pages/Purchase/PurchaseOrderEditModalComponent.razor`

**æ•´åˆå¯©æ ¸é–‹é—œé‚è¼¯ï¼š**

1. **è¼‰å…¥å¯©æ ¸è¨­å®š**
   ```csharp
   protected override async Task OnInitializedAsync()
   {
       // è¼‰å…¥å¯©æ ¸é–‹é—œè¨­å®š
       isApprovalEnabled = await SystemParameterService
           .IsPurchaseOrderApprovalEnabledAsync();
       
       InitializeSupplierModalManager();
   }
   ```

2. **ä½¿ç”¨ Helper åˆ¤æ–·é–å®šç‹€æ…‹**
   ```csharp
   private async Task InitializeFormFieldsAsync()
   {
       var shouldLock = ApprovalConfigHelper.ShouldLockFieldByApproval(
           isApprovalEnabled,
           editModalComponent?.Entity?.IsApproved ?? false,
           hasUndeletableDetails
       );
       
       // æ ¹æ“š shouldLock è¨­å®šæ¬„ä½å”¯è®€ç‹€æ…‹
   }
   ```

3. **å‹•æ…‹é¡¯ç¤ºå¯©æ ¸å€åŸŸ**
   ```csharp
   private bool ShouldShowApprovalSection()
   {
       // åªæœ‰åœ¨å•Ÿç”¨å¯©æ ¸ + ç·¨è¼¯ç¾æœ‰å–®æ“šæ™‚æ‰é¡¯ç¤º
       return isApprovalEnabled && 
              PurchaseOrderId.HasValue && 
              PurchaseOrderId.Value > 0;
   }
   ```

4. **æª¢æŸ¥è½‰å–®æ¬Šé™**
   ```csharp
   private async Task HandleCreateReceivingFromOrder()
   {
       if (!ApprovalConfigHelper.CanPerformActionRequiringApproval(
           isApprovalEnabled, 
           editModalComponent.Entity.IsApproved))
       {
           await NotificationService.ShowWarningAsync(
               "åªæœ‰å·²æ ¸å‡†çš„æ¡è³¼å–®æ‰èƒ½è½‰é€²è²¨å–®");
           return;
       }
       // ...
   }
   ```

5. **æ–°å¢ using æŒ‡ä»¤**
   ```csharp
   @using ERPCore2.Helpers
   ```

6. **æ–°å¢å»ºæ§‹å‡½æ•¸**
   ```csharp
   public PurchaseOrderEditModalComponent()
   {
       // æå‰åˆå§‹åŒ– supplierModalManager ä»¥é¿å… NullReferenceException
       supplierModalManager = new RelatedEntityModalManager<Supplier>();
   }
   ```

#### âœ¨ ä¿®æ”¹ï¼š`Components/Pages/Purchase/PurchaseReceivingEditModalComponent.razor`

**æ•´åˆå¯©æ ¸é–‹é—œé‚è¼¯ï¼š**

1. **æ–°å¢å¯©æ ¸é–‹é—œæ¬„ä½**
   ```csharp
   // ===== å¯©æ ¸é–‹é—œç‹€æ…‹ =====
   private bool isApprovalEnabled = true; // æ˜¯å¦å•Ÿç”¨æ¡è³¼å–®å¯©æ ¸åŠŸèƒ½ï¼ˆå¾ç³»çµ±åƒæ•¸è¼‰å…¥ï¼‰
   ```

2. **è¼‰å…¥å¯©æ ¸è¨­å®š**
   ```csharp
   protected override async Task OnInitializedAsync()
   {
       // è¼‰å…¥å¯©æ ¸é–‹é—œè¨­å®šï¼ˆå„ªå…ˆåŸ·è¡Œï¼Œå½±éŸ¿å¾ŒçºŒé‚è¼¯ï¼‰
       isApprovalEnabled = await SystemParameterService
           .IsPurchaseOrderApprovalEnabledAsync();
       
       // åˆå§‹åŒ– Modal ç®¡ç†å™¨
       InitializeSupplierModalManager();
   }
   ```

3. **å‚³éå¯©æ ¸é–‹é—œçµ¦å­çµ„ä»¶**
   ```csharp
   <PurchaseReceivingDetailManagerComponent 
       IsApprovalEnabled="@isApprovalEnabled"
       ... />
   ```

4. **æ–°å¢å»ºæ§‹å‡½æ•¸**
   ```csharp
   public PurchaseReceivingEditModalComponent()
   {
       // æå‰åˆå§‹åŒ– supplierModalManager ä»¥é¿å… NullReferenceException
       supplierModalManager = new RelatedEntityModalManager<Supplier>();
   }
   ```

#### âœ¨ ä¿®æ”¹ï¼š`Components/Shared/SubCollections/PurchaseReceivingDetailManagerComponent.razor`

**æ•´åˆå¯©æ ¸é–‹é—œé‚è¼¯ï¼š**

1. **æ–°å¢å¯©æ ¸é–‹é—œåƒæ•¸**
   ```csharp
   // ===== å¯©æ ¸æ§åˆ¶åƒæ•¸ =====
   [Parameter] public bool IsApprovalEnabled { get; set; } = true; // æ˜¯å¦å•Ÿç”¨æ¡è³¼å–®å¯©æ ¸ï¼ˆå¾ç³»çµ±åƒæ•¸è¼‰å…¥ï¼‰
   ```

2. **åœ¨è¼‰å…¥æ¡è³¼æ˜ç´°æ™‚å‚³éå¯©æ ¸é–‹é—œ**
   ```csharp
   private async Task LoadAvailableProductsAsync()
   {
       if (SelectedSupplierId.HasValue && SelectedSupplierId.Value > 0)
       {
           // è¼‰å…¥è©²å» å•†æœªå®Œæˆé€²è²¨çš„æ¡è³¼æ˜ç´°
           // æ ¹æ“šå¯©æ ¸é–‹é—œæ±ºå®šæ˜¯å¦åªè¼‰å…¥å·²å¯©æ ¸çš„æ¡è³¼å–®
           AvailablePurchaseDetails = await PurchaseOrderService
               .GetReceivingDetailsBySupplierAsync(
                   SelectedSupplierId.Value, 
                   includeCompleted: false,
                   checkApproval: IsApprovalEnabled); // å‚³éå¯©æ ¸é–‹é—œ
           
           // å¾æ¡è³¼æ˜ç´°ä¸­æå–å•†å“æ¸…å–®
           AvailableProducts = AvailablePurchaseDetails
               .Where(pd => pd.Product != null)
               .Select(pd => pd.Product!)
               .Distinct()
               .ToList();
       }
   }
   ```

#### âœ¨ ä¿®æ”¹ï¼š`Services/Purchase/IPurchaseOrderService.cs`

**æ–°å¢å¯©æ ¸æª¢æŸ¥åƒæ•¸ï¼š**

```csharp
/// <summary>
/// ç²å–å» å•†çš„å¯é€²è²¨æ¡è³¼æ˜ç´°ï¼ˆå«å¯©æ ¸éæ¿¾ï¼‰
/// </summary>
/// <param name="supplierId">å» å•†ID</param>
/// <param name="includeCompleted">æ˜¯å¦åŒ…å«å·²å®Œæˆçš„æ˜ç´°</param>
/// <param name="checkApproval">æ˜¯å¦æª¢æŸ¥å¯©æ ¸ç‹€æ…‹ï¼ˆtrue=åªè¼‰å…¥å·²å¯©æ ¸ï¼Œfalse=ä¸æª¢æŸ¥å¯©æ ¸ï¼‰</param>
Task<List<PurchaseOrderDetail>> GetReceivingDetailsBySupplierAsync(
    int supplierId, 
    bool includeCompleted, 
    bool checkApproval = true);
```

#### âœ¨ ä¿®æ”¹ï¼š`Services/Purchase/PurchaseOrderService.cs`

**å¯¦ä½œå¯©æ ¸æª¢æŸ¥é‚è¼¯ï¼š**

```csharp
public async Task<List<PurchaseOrderDetail>> GetReceivingDetailsBySupplierAsync(
    int supplierId, 
    bool includeCompleted, 
    bool checkApproval = true)
{
    try
    {
        using var context = await _contextFactory.CreateDbContextAsync();
        
        var query = context.PurchaseOrderDetails
            .Include(pod => pod.PurchaseOrder)
                .ThenInclude(po => po.Supplier)
            .Include(pod => pod.PurchaseOrder)
                .ThenInclude(po => po.Warehouse)
            .Include(pod => pod.Product)
            .Where(pod => pod.PurchaseOrder.SupplierId == supplierId);

        // æ ¹æ“šåƒæ•¸æ±ºå®šæ˜¯å¦æª¢æŸ¥å¯©æ ¸ç‹€æ…‹
        if (checkApproval)
        {
            query = query.Where(pod => pod.PurchaseOrder.IsApproved);
        }

        if (!includeCompleted)
        {
            // åªåŒ…å«æœªå®Œæˆçš„æ˜ç´°ï¼šæ—¢æœªæ‰‹å‹•å®Œæˆï¼Œä¸”æ•¸é‡æœªæ»¿
            query = query.Where(pod => !pod.IsReceivingCompleted && 
                                     pod.ReceivedQuantity < pod.OrderQuantity);
        }

        return await query.OrderBy(pod => pod.PurchaseOrder.PurchaseOrderNumber)
                        .ThenBy(pod => pod.Product.Name)
                        .ToListAsync();
    }
    catch (Exception ex)
    {
        await ErrorHandlingHelper.HandleServiceErrorAsync(ex, 
            nameof(GetReceivingDetailsBySupplierAsync), GetType(), _logger, 
            new { 
                SupplierId = supplierId,
                IncludeCompleted = includeCompleted,
                CheckApproval = checkApproval
            });
        return new List<PurchaseOrderDetail>();
    }
}
```

---

## ğŸ”„ æ ¸å¿ƒé‚è¼¯æµç¨‹

### 1. å¯©æ ¸é–‹é—œæŸ¥è©¢æµç¨‹

```
ä½¿ç”¨è€…æ“ä½œ
    â†“
å‰ç«¯çµ„ä»¶è¼‰å…¥
    â†“
å‘¼å« SystemParameterService.IsApprovalEnabledAsync()
    â†“
æª¢æŸ¥å¿«å– (5åˆ†é˜æœ‰æ•ˆæœŸ)
    â†“ (å¿«å–æœªå‘½ä¸­)
å¾è³‡æ–™åº«æŸ¥è©¢ SystemParameter
    â†“
æ›´æ–°å¿«å–
    â†“
è¿”å›å¯©æ ¸é–‹é—œç‹€æ…‹
    â†“
å‰ç«¯æ ¹æ“šç‹€æ…‹èª¿æ•´ UI è¡Œç‚º
```

### 2. æ¬„ä½é–å®šé‚è¼¯

```mermaid
graph TD
    A[æª¢æŸ¥æ˜¯å¦é–å®šæ¬„ä½] --> B{æ˜¯å¦å•Ÿç”¨å¯©æ ¸?}
    B -->|å¦| C{æ˜¯å¦æœ‰ä¸‹ä¸€æ­¥å‹•ä½œ?}
    B -->|æ˜¯| D{æ˜¯å¦å·²å¯©æ ¸ OR æœ‰ä¸‹ä¸€æ­¥å‹•ä½œ?}
    C -->|æ˜¯| E[é–å®šæ¬„ä½]
    C -->|å¦| F[ä¸é–å®šæ¬„ä½]
    D -->|æ˜¯| E
    D -->|å¦| F
```

**èªªæ˜ï¼š**
- **æœªå•Ÿç”¨å¯©æ ¸**ï¼šåªæ ¹æ“šã€Œæ˜¯å¦æœ‰ä¸‹ä¸€æ­¥å‹•ä½œã€ï¼ˆå¦‚å·²æœ‰é€²è²¨è¨˜éŒ„ï¼‰é–å®š
- **å·²å•Ÿç”¨å¯©æ ¸**ï¼šå·²å¯©æ ¸é€šé OR æœ‰ä¸‹ä¸€æ­¥å‹•ä½œæ™‚é–å®š

### 3. è½‰å–®æ¬Šé™æª¢æŸ¥

```mermaid
graph TD
    A[ä½¿ç”¨è€…é»æ“Šã€Œè½‰é€²è²¨å–®ã€] --> B{æ˜¯å¦å•Ÿç”¨å¯©æ ¸?}
    B -->|å¦| C[å…è¨±è½‰å–®]
    B -->|æ˜¯| D{æ˜¯å¦å·²å¯©æ ¸é€šé?}
    D -->|æ˜¯| C
    D -->|å¦| E[é¡¯ç¤ºè­¦å‘Šï¼šéœ€å…ˆå¯©æ ¸]
```

### 4. é€²è²¨å–®ã€Œè¼‰å…¥æœªå…¥åº«ã€æµç¨‹

```
ä½¿ç”¨è€…é»æ“Šã€Œè¼‰å…¥æœªå…¥åº«ã€
    â†“
PurchaseReceivingDetailManagerComponent.LoadAllUnreceivedItems()
    â†“
å‘¼å« LoadAvailableProductsAsync()
    â†“
Service: GetReceivingDetailsBySupplierAsync(supplierId, false, isApprovalEnabled)
    â†“
Service å±¤åˆ¤æ–·å¯©æ ¸éæ¿¾:
  - if (checkApproval == true) 
      â†’ WHERE IsApproved = true (åªè¼‰å…¥å·²å¯©æ ¸çš„æ¡è³¼å–®)
  - if (checkApproval == false) 
      â†’ ä¸æª¢æŸ¥ IsApproved (è¼‰å…¥æ‰€æœ‰æ¡è³¼å–®)
    â†“
GetAvailablePurchaseDetails() é€²è¡ŒäºŒæ¬¡ç¯©é¸:
  - ç¯©é¸æ¡è³¼å–®IDï¼ˆå¦‚æœ‰æŒ‡å®šï¼‰
  - ç¯©é¸å•†å“IDï¼ˆå¦‚æœ‰æŒ‡å®šï¼‰
    â†“
è¿”å›å¯ç”¨çš„æ¡è³¼æ˜ç´°åˆ—è¡¨
    â†“
LoadUnreceivedItemsInternal() æ‰¹æ¬¡è¼‰å…¥æ˜ç´°
    â†“
é¡¯ç¤ºè¼‰å…¥æˆåŠŸè¨Šæ¯
```

**èªªæ˜ï¼š**
- **å•Ÿç”¨å¯©æ ¸æ™‚**ï¼š`isApprovalEnabled = true` â†’ åªèƒ½è¼‰å…¥å·²å¯©æ ¸é€šéçš„æ¡è³¼å–®æ˜ç´°
- **æœªå•Ÿç”¨å¯©æ ¸æ™‚**ï¼š`isApprovalEnabled = false` â†’ å¯è¼‰å…¥æ‰€æœ‰æ¡è³¼å–®æ˜ç´°ï¼ˆä¸ç®¡å¯©æ ¸ç‹€æ…‹ï¼‰

---

## ğŸ’¾ è³‡æ–™åº«è®Šæ›´

### Migration: AddApprovalConfigToSystemParameter

**åŸ·è¡Œå‘½ä»¤ï¼š**
```bash
dotnet ef migrations add AddApprovalConfigToSystemParameter
dotnet ef database update
```

**è®Šæ›´å…§å®¹ï¼š**
åœ¨ `SystemParameters` è³‡æ–™è¡¨æ–°å¢ä»¥ä¸‹æ¬„ä½ï¼š

| æ¬„ä½åç¨± | è³‡æ–™å‹åˆ¥ | é è¨­å€¼ | èªªæ˜ |
|---------|---------|--------|------|
| `EnablePurchaseOrderApproval` | bit | 0 (false) | å•Ÿç”¨æ¡è³¼å–®å¯©æ ¸ |
| `EnablePurchaseReceivingApproval` | bit | 0 (false) | å•Ÿç”¨é€²è²¨å–®å¯©æ ¸ |
| `EnablePurchaseReturnApproval` | bit | 0 (false) | å•Ÿç”¨é€²è²¨é€€å›å¯©æ ¸ |
| `EnableSalesOrderApproval` | bit | 0 (false) | å•Ÿç”¨éŠ·è²¨å–®å¯©æ ¸ |
| `EnableSalesReturnApproval` | bit | 0 (false) | å•Ÿç”¨éŠ·è²¨é€€å›å¯©æ ¸ |
| `EnableInventoryTransferApproval` | bit | 0 (false) | å•Ÿç”¨åº«å­˜èª¿æ’¥å¯©æ ¸ |

**æ³¨æ„äº‹é …ï¼š**
- Migration é è¨­å€¼ç‚º `false`ï¼ˆè³‡æ–™åº«å±¤ç´šï¼‰
- Entity é è¨­å€¼ä¸­ `EnablePurchaseOrderApproval` ç‚º `true`ï¼ˆç¨‹å¼ç¢¼å±¤ç´šï¼‰
- æ–°å»ºç«‹çš„ SystemParameter è¨˜éŒ„æœƒä½¿ç”¨ Entity é è¨­å€¼

---

## ğŸ“– ä½¿ç”¨èªªæ˜

### ç®¡ç†å“¡æ“ä½œæŒ‡å—

#### 1. é€²å…¥è¨­å®šé é¢
1. ç™»å…¥ç³»çµ±
2. é€²å…¥ã€Œç³»çµ±ç®¡ç†ã€â†’ã€Œç³»çµ±åƒæ•¸è¨­å®šã€
3. é»æ“Šã€Œå¯©æ ¸æµç¨‹è¨­å®šã€Tab

#### 2. è¨­å®šå¯©æ ¸é–‹é—œ
1. æ¯å€‹å–®æ“šé¡å‹éƒ½æœ‰ç¨ç«‹çš„é–‹é—œ
2. é»æ“Šé–‹é—œå³å¯åˆ‡æ›ç‹€æ…‹
3. ç¶ è‰² âœ“ = å·²å•Ÿç”¨å¯©æ ¸
4. ç°è‰² âœ— = æœªå•Ÿç”¨å¯©æ ¸

#### 3. å„²å­˜è¨­å®š
1. èª¿æ•´å®Œæ‰€æœ‰é–‹é—œå¾Œï¼Œé»æ“Šã€Œå„²å­˜è¨­å®šã€æŒ‰éˆ•
2. ç³»çµ±æœƒé¡¯ç¤ºã€Œç³»çµ±åƒæ•¸å·²æˆåŠŸå„²å­˜ï¼ã€è¨Šæ¯
3. è¨­å®šç«‹å³ç”Ÿæ•ˆï¼ˆå¿«å–æœƒåœ¨ 5 åˆ†é˜å…§æ›´æ–°ï¼‰

#### 4. é‡æ–°è¼‰å…¥
- å¦‚éœ€æ¢å¾©åˆ°è³‡æ–™åº«ä¸­çš„è¨­å®šï¼Œé»æ“Šã€Œé‡æ–°è¼‰å…¥ã€æŒ‰éˆ•

### å¯©æ ¸é–‹é—œæ•ˆæœèªªæ˜

#### âœ… å•Ÿç”¨å¯©æ ¸æ™‚
- **æ¡è³¼å–®**ï¼šéœ€å¯©æ ¸é€šéæ‰èƒ½è½‰é€²è²¨å–®
- **é€²è²¨å–®**ï¼šéœ€å¯©æ ¸é€šéæ‰èƒ½å½±éŸ¿åº«å­˜
- **é€²è²¨é€€å›**ï¼šéœ€å¯©æ ¸é€šéæ‰èƒ½å½±éŸ¿åº«å­˜
- **éŠ·è²¨å–®**ï¼šéœ€å¯©æ ¸é€šéæ‰èƒ½å½±éŸ¿åº«å­˜
- **éŠ·è²¨é€€å›**ï¼šéœ€å¯©æ ¸é€šéæ‰èƒ½å½±éŸ¿åº«å­˜
- **åº«å­˜èª¿æ’¥**ï¼šéœ€å¯©æ ¸é€šéæ‰èƒ½åŸ·è¡Œèª¿æ’¥

#### âŒ æœªå•Ÿç”¨å¯©æ ¸æ™‚
- å–®æ“šå„²å­˜å¾Œå¯ç›´æ¥åŸ·è¡Œå¾ŒçºŒæ“ä½œ
- ä¸é¡¯ç¤ºã€Œå¯©æ ¸ã€å’Œã€Œé§å›ã€æŒ‰éˆ•
- é©åˆå°å‹ä¼æ¥­æˆ–ä¿¡ä»»åº¦é«˜çš„ç’°å¢ƒ

### é€²è²¨å–®èˆ‡æ¡è³¼å–®å¯©æ ¸çš„é—œè¯

#### é—œè¯èªªæ˜

é€²è²¨å–®çš„ã€Œè¼‰å…¥æœªå…¥åº«ã€åŠŸèƒ½æœƒå—åˆ°**æ¡è³¼å–®å¯©æ ¸é–‹é—œ**çš„å½±éŸ¿ï¼š

| æ¡è³¼å–®å¯©æ ¸é–‹é—œ | é€²è²¨å–®ã€Œè¼‰å…¥æœªå…¥åº«ã€è¡Œç‚º |
|--------------|---------------------|
| **å•Ÿç”¨å¯©æ ¸** (`EnablePurchaseOrderApproval = true`) | åªèƒ½è¼‰å…¥**å·²å¯©æ ¸é€šé**çš„æ¡è³¼å–®æ˜ç´° |
| **æœªå•Ÿç”¨å¯©æ ¸** (`EnablePurchaseOrderApproval = false`) | å¯è¼‰å…¥**æ‰€æœ‰æ¡è³¼å–®**çš„æ˜ç´°ï¼ˆä¸æª¢æŸ¥å¯©æ ¸ç‹€æ…‹ï¼‰ |

#### è³‡æ–™æµå‘

```
æ¡è³¼å–® â†’ å¯©æ ¸ â†’ é€²è²¨å–®
   â†“       â†“       â†“
å»ºç«‹    é€šé/é§å›  è¼‰å…¥æœªå…¥åº«
```

**è©³ç´°æµç¨‹ï¼š**

1. **æ¡è³¼å–®éšæ®µ**
   - æ¡è³¼äººå“¡å»ºç«‹æ¡è³¼å–®
   - å¦‚æœå•Ÿç”¨å¯©æ ¸ï¼šéœ€ç­‰å¾…å¯©æ ¸é€šé
   - å¦‚æœæœªå•Ÿç”¨å¯©æ ¸ï¼šå„²å­˜å¾Œç«‹å³å¯ç”¨

2. **é€²è²¨å–®éšæ®µ**
   - å€‰ç®¡äººå“¡é–‹å•Ÿé€²è²¨å–®ç·¨è¼¯é é¢
   - é¸æ“‡å» å•†
   - é»æ“Šã€Œè¼‰å…¥æœªå…¥åº«ã€æŒ‰éˆ•
   - **ç³»çµ±æ ¹æ“šå¯©æ ¸é–‹é—œæ±ºå®šå¯è¼‰å…¥çš„æ¡è³¼å–®ç¯„åœ**

3. **å¯©æ ¸é–‹é—œå½±éŸ¿**
   - **å•Ÿç”¨å¯©æ ¸**ï¼š
     - Service æŸ¥è©¢æ™‚åŠ ä¸Š `WHERE IsApproved = true`
     - åªé¡¯ç¤ºå·²å¯©æ ¸çš„æ¡è³¼å–®æ˜ç´°
     - ç¢ºä¿é€²è²¨è³‡æ–™çš„æº–ç¢ºæ€§
   
   - **æœªå•Ÿç”¨å¯©æ ¸**ï¼š
     - Service æŸ¥è©¢æ™‚ä¸æª¢æŸ¥ `IsApproved`
     - é¡¯ç¤ºæ‰€æœ‰æ¡è³¼å–®æ˜ç´°ï¼ˆåŒ…å«æœªå¯©æ ¸çš„ï¼‰
     - æé«˜ä½œæ¥­æ•ˆç‡

#### å¯¦ä½œç´°ç¯€

**PurchaseReceivingEditModalComponent** è¼‰å…¥å¯©æ ¸é–‹é—œï¼š
```csharp
protected override async Task OnInitializedAsync()
{
    // è¼‰å…¥æ¡è³¼å–®å¯©æ ¸é–‹é—œï¼ˆæ³¨æ„ï¼šä¸æ˜¯é€²è²¨å–®å¯©æ ¸é–‹é—œï¼‰
    isApprovalEnabled = await SystemParameterService
        .IsPurchaseOrderApprovalEnabledAsync();
}
```

**å‚³éçµ¦ PurchaseReceivingDetailManagerComponent**ï¼š
```csharp
<PurchaseReceivingDetailManagerComponent 
    IsApprovalEnabled="@isApprovalEnabled"  // å‚³éæ¡è³¼å–®å¯©æ ¸é–‹é—œ
    ... />
```

**LoadAvailableProductsAsync** ä½¿ç”¨å¯©æ ¸é–‹é—œï¼š
```csharp
AvailablePurchaseDetails = await PurchaseOrderService
    .GetReceivingDetailsBySupplierAsync(
        SelectedSupplierId.Value, 
        includeCompleted: false,
        checkApproval: IsApprovalEnabled);  // æ ¹æ“šé–‹é—œæ±ºå®šæ˜¯å¦éæ¿¾
```

**Service å±¤çš„æ¢ä»¶éæ¿¾**ï¼š
```csharp
var query = context.PurchaseOrderDetails
    .Where(pod => pod.PurchaseOrder.SupplierId == supplierId);

// æ ¹æ“šåƒæ•¸æ±ºå®šæ˜¯å¦æª¢æŸ¥å¯©æ ¸ç‹€æ…‹
if (checkApproval)
{
    query = query.Where(pod => pod.PurchaseOrder.IsApproved);
}
```

#### ä½¿ç”¨æƒ…å¢ƒç¯„ä¾‹

**æƒ…å¢ƒ 1ï¼šåš´æ ¼å¯©æ ¸æ¨¡å¼ï¼ˆå¤§å‹ä¼æ¥­ï¼‰**
- è¨­å®šï¼š`EnablePurchaseOrderApproval = true`
- æµç¨‹ï¼š
  1. æ¡è³¼å“¡å»ºç«‹æ¡è³¼å–® â†’ é€å¯©
  2. ä¸»ç®¡å¯©æ ¸é€šé
  3. å€‰ç®¡é–‹å•Ÿé€²è²¨å–®ï¼Œé»æ“Šã€Œè¼‰å…¥æœªå…¥åº«ã€
  4. **åªçœ‹åˆ°å·²å¯©æ ¸çš„æ¡è³¼å–®æ˜ç´°**
  5. é¸æ“‡æ˜ç´°é€²è¡Œå…¥åº«

**æƒ…å¢ƒ 2ï¼šå½ˆæ€§ä½œæ¥­æ¨¡å¼ï¼ˆå°å‹ä¼æ¥­ï¼‰**
- è¨­å®šï¼š`EnablePurchaseOrderApproval = false`
- æµç¨‹ï¼š
  1. æ¡è³¼å“¡å»ºç«‹æ¡è³¼å–® â†’ ç›´æ¥å„²å­˜
  2. å€‰ç®¡é–‹å•Ÿé€²è²¨å–®ï¼Œé»æ“Šã€Œè¼‰å…¥æœªå…¥åº«ã€
  3. **çœ‹åˆ°æ‰€æœ‰æ¡è³¼å–®æ˜ç´°**ï¼ˆåŒ…å«å‰›å»ºç«‹çš„ï¼‰
  4. é¸æ“‡æ˜ç´°é€²è¡Œå…¥åº«

#### å‘ä¸‹ç›¸å®¹æ€§

**é è¨­è¡Œç‚ºï¼š**
- `checkApproval` åƒæ•¸é è¨­ç‚º `true`
- ç¾æœ‰ç¨‹å¼ç¢¼ä¸å‚³éæ­¤åƒæ•¸æ™‚ï¼Œä»ç„¶åªè¼‰å…¥å·²å¯©æ ¸çš„æ¡è³¼å–®
- ç¢ºä¿ç³»çµ±å‡ç´šå¾Œä¸å½±éŸ¿ç¾æœ‰æ¥­å‹™æµç¨‹

**Service æ–¹æ³•ç°½åï¼š**
```csharp
Task<List<PurchaseOrderDetail>> GetReceivingDetailsBySupplierAsync(
    int supplierId, 
    bool includeCompleted, 
    bool checkApproval = true);  // é è¨­å€¼ç¢ºä¿å‘ä¸‹ç›¸å®¹
```

---

## ğŸ¯ è¨­è¨ˆäº®é»

### 1. é«˜åº¦å½ˆæ€§
- æ¯ç¨®å–®æ“šç¨ç«‹è¨­å®šï¼Œæ»¿è¶³ä¸åŒæ¥­å‹™éœ€æ±‚
- å³æ™‚åˆ‡æ›ï¼Œç„¡éœ€é‡å•Ÿç³»çµ±

### 2. æ•ˆèƒ½å„ªåŒ–
- **å¿«å–æ©Ÿåˆ¶**ï¼š5 åˆ†é˜å¿«å–ï¼Œå¤§å¹…æ¸›å°‘è³‡æ–™åº«æŸ¥è©¢
- **è‡ªå‹•å¤±æ•ˆ**ï¼šæ›´æ–°åƒæ•¸æ™‚è‡ªå‹•æ¸…é™¤å¿«å–
- **å®‰å…¨é è¨­**ï¼šæŸ¥è©¢å¤±æ•—æ™‚é è¨­ç‚ºä¸å•Ÿç”¨å¯©æ ¸

### 3. çµ±ä¸€ç®¡ç†
- **ApprovalConfigHelper**ï¼šé›†ä¸­æ‰€æœ‰å¯©æ ¸é‚è¼¯åˆ¤æ–·
- **ä¸€è‡´æ€§**ï¼šæ‰€æœ‰å–®æ“šä½¿ç”¨ç›¸åŒçš„åˆ¤æ–·é‚è¼¯
- **æ˜“ç¶­è­·**ï¼šä¿®æ”¹é‚è¼¯åªéœ€æ›´æ–° Helper

### 4. å‘ä¸‹ç›¸å®¹
- æ¡è³¼å–®é è¨­å•Ÿç”¨å¯©æ ¸ï¼ˆèˆ‡ç¾æœ‰è¡Œç‚ºä¸€è‡´ï¼‰
- ä¸å½±éŸ¿å·²å­˜åœ¨çš„å–®æ“š
- æ¼¸é€²å¼å‡ç´š

### 5. ä½¿ç”¨è€…å‹å–„
- **æ¸…æ™°çš„ UI**ï¼šæ¯å€‹é–‹é—œéƒ½æœ‰è©³ç´°èªªæ˜
- **å³æ™‚é è¦½**ï¼šå³å´é¡¯ç¤ºç•¶å‰è¨­å®šç‹€æ…‹
- **æ“ä½œæç¤º**ï¼šåº•éƒ¨èªªæ˜å€åŸŸè§£é‡‹åŠŸèƒ½æ„ç¾©

---

## ğŸš€ æœªä¾†æ“´å……å»ºè­°

### 1. å¤šç´šå¯©æ ¸
```
æ¡è³¼å–®
  â†“
éƒ¨é–€ä¸»ç®¡å¯©æ ¸
  â†“
è²¡å‹™å¯©æ ¸
  â†“
ç¸½ç¶“ç†å¯©æ ¸
  â†“
æ ¸å‡†é€šé
```

**å¯¦æ–½æ–¹å‘ï¼š**
- æ–°å¢ `ApprovalLevel` æ¬„ä½ï¼ˆå¯©æ ¸å±¤ç´šï¼‰
- æ–°å¢ `ApprovalFlow` è³‡æ–™è¡¨ï¼ˆå®šç¾©å¯©æ ¸æµç¨‹ï¼‰
- æ“´å…… `ApprovalType` æ”¯æ´å¤šç´šå¯©æ ¸

### 2. å¯©æ ¸æ¬Šé™é…ç½®
```
è§’è‰²è¨­å®š
  â”œâ”€ æ¡è³¼ä¸»ç®¡ï¼šå¯å¯©æ ¸æ¡è³¼å–®
  â”œâ”€ è²¡å‹™äººå“¡ï¼šå¯å¯©æ ¸æ‰€æœ‰æ¶‰åŠé‡‘é¡çš„å–®æ“š
  â””â”€ å€‰ç®¡äººå“¡ï¼šå¯å¯©æ ¸åº«å­˜èª¿æ’¥
```

**å¯¦æ–½æ–¹å‘ï¼š**
- æ–°å¢ `ApprovalPermission` è³‡æ–™è¡¨
- æ•´åˆç¾æœ‰çš„ Permission ç³»çµ±
- UI æ–°å¢ã€Œå¯©æ ¸æ¬Šé™é…ç½®ã€Tab

### 3. å¯©æ ¸æ­·å²è¨˜éŒ„
```
è¨˜éŒ„å…§å®¹
  â”œâ”€ å¯©æ ¸äººå“¡
  â”œâ”€ å¯©æ ¸æ™‚é–“
  â”œâ”€ å¯©æ ¸å‹•ä½œï¼ˆæ ¸å‡†/é§å›ï¼‰
  â”œâ”€ é§å›åŸå› 
  â””â”€ é™„åŠ æ„è¦‹
```

**å¯¦æ–½æ–¹å‘ï¼š**
- æ–°å¢ `ApprovalHistory` è³‡æ–™è¡¨
- åœ¨å–®æ“šè©³æƒ…é é¢é¡¯ç¤ºå¯©æ ¸æ­·å²
- æä¾›å¯©æ ¸è¨˜éŒ„æŸ¥è©¢åŠŸèƒ½

### 4. æ¢ä»¶å¼å¯©æ ¸
```
è¦å‰‡ç¯„ä¾‹
  - æ¡è³¼é‡‘é¡ > 100,000ï¼šéœ€è¦å¯©æ ¸
  - æ¡è³¼é‡‘é¡ <= 100,000ï¼šä¸éœ€å¯©æ ¸
```

**å¯¦æ–½æ–¹å‘ï¼š**
- æ–°å¢ `ApprovalRule` è³‡æ–™è¡¨ï¼ˆå®šç¾©æ¢ä»¶ï¼‰
- æ“´å…… `IsApprovalEnabledAsync` æ”¯æ´è¦å‰‡åˆ¤æ–·
- UI æ–°å¢ã€Œå¯©æ ¸è¦å‰‡é…ç½®ã€åŠŸèƒ½

### 5. é€šçŸ¥æé†’
```
é€šçŸ¥æ™‚æ©Ÿ
  â”œâ”€ å–®æ“šé€å¯©æ™‚ï¼šé€šçŸ¥å¯©æ ¸äººå“¡
  â”œâ”€ å¯©æ ¸å®Œæˆæ™‚ï¼šé€šçŸ¥ç”³è«‹äººå“¡
  â””â”€ é€¾æœŸæœªå¯©æ™‚ï¼šé€šçŸ¥ç›¸é—œäººå“¡
```

**å¯¦æ–½æ–¹å‘ï¼š**
- æ•´åˆéƒµä»¶é€šçŸ¥ç³»çµ±
- æ–°å¢ç«™å…§è¨Šæ¯åŠŸèƒ½
- å»ºç«‹å¯©æ ¸å„€è¡¨æ¿

---

## ğŸ” æ¸¬è©¦å»ºè­°

### åŠŸèƒ½æ¸¬è©¦

#### 1. å¯©æ ¸é–‹é—œè¨­å®šæ¸¬è©¦
- [ ] æˆåŠŸé–‹å•Ÿ/é—œé–‰æ¡è³¼å–®å¯©æ ¸
- [ ] æˆåŠŸé–‹å•Ÿ/é—œé–‰å…¶ä»–å–®æ“šå¯©æ ¸
- [ ] è¨­å®šå„²å­˜å¾Œç«‹å³ç”Ÿæ•ˆ
- [ ] é‡æ–°è¼‰å…¥æ¢å¾©è³‡æ–™åº«è¨­å®š

#### 2. æ¡è³¼å–®å¯©æ ¸æµç¨‹æ¸¬è©¦ï¼ˆå•Ÿç”¨å¯©æ ¸ï¼‰
- [ ] æœªå¯©æ ¸çš„æ¡è³¼å–®ç„¡æ³•è½‰é€²è²¨å–®
- [ ] æœªå¯©æ ¸çš„æ¡è³¼å–®ä¸»æª”æ¬„ä½ä¸é–å®š
- [ ] å¯©æ ¸é€šéå¾Œå¯ä»¥è½‰é€²è²¨å–®
- [ ] å¯©æ ¸é€šéå¾Œä¸»æª”æ¬„ä½é–å®š
- [ ] é¡¯ç¤ºå¯©æ ¸å’Œé§å›æŒ‰éˆ•

#### 3. æ¡è³¼å–®éå¯©æ ¸æµç¨‹æ¸¬è©¦ï¼ˆé—œé–‰å¯©æ ¸ï¼‰
- [ ] å„²å­˜å¾Œå¯ç›´æ¥è½‰é€²è²¨å–®
- [ ] ä¸é¡¯ç¤ºå¯©æ ¸å’Œé§å›æŒ‰éˆ•
- [ ] åªæœ‰ã€Œæœ‰ä¸‹ä¸€æ­¥å‹•ä½œã€æ™‚æ‰é–å®šæ¬„ä½

#### 4. å¿«å–æ©Ÿåˆ¶æ¸¬è©¦
- [ ] é¦–æ¬¡æŸ¥è©¢æœƒå­˜å…¥å¿«å–
- [ ] 5 åˆ†é˜å…§ä¸é‡è¤‡æŸ¥è©¢è³‡æ–™åº«
- [ ] æ›´æ–°åƒæ•¸å¾Œå¿«å–è‡ªå‹•æ¸…é™¤

#### 5. éŒ¯èª¤è™•ç†æ¸¬è©¦
- [ ] è³‡æ–™åº«æŸ¥è©¢å¤±æ•—æ™‚é è¨­ç‚ºä¸å•Ÿç”¨å¯©æ ¸
- [ ] é¡¯ç¤ºå‹å–„çš„éŒ¯èª¤è¨Šæ¯

---

## ï¿½ å·²çŸ¥å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

### å•é¡Œ 1: NullReferenceException in BuildRenderTree

**ç™¼ç”Ÿæ™‚é–“ï¼š** 2025å¹´10æœˆ25æ—¥  
**å½±éŸ¿ç¯„åœï¼š** PurchaseOrderEditModalComponent çµ„ä»¶åˆå§‹åŒ–

#### å•é¡Œæè¿°
åœ¨æ•´åˆå¯©æ ¸é‚è¼¯å¾Œï¼Œé–‹å•Ÿæ¡è³¼å–®ç·¨è¼¯ Modal æ™‚å‡ºç¾ `NullReferenceException`ï¼š

```
System.NullReferenceException: Object reference not set to an instance of an object.
   at ERPCore2.Components.Pages.Purchase.PurchaseOrderEditModalComponent.BuildRenderTree(RenderTreeBuilder __builder)
```

#### æ ¹æœ¬åŸå› 
**Blazor çµ„ä»¶æ¸²æŸ“é †åºå•é¡Œï¼š**

```csharp
// âŒ éŒ¯èª¤çš„åˆå§‹åŒ–æ–¹å¼
private RelatedEntityModalManager<Supplier> supplierModalManager = default!;

// Blazor çµ„ä»¶å®£å‘Šæ™‚å°±èª¿ç”¨ GetModalManagers()
<GenericEditModalComponent ModalManagers="@GetModalManagers()" ... />

// GetModalManagers() è¿”å› supplierModalManager
// ä½†æ­¤æ™‚ supplierModalManager é‚„æ˜¯ null (default!)
// â†’ NullReferenceExceptionï¼
```

**Blazor çµ„ä»¶ç”Ÿå‘½é€±æœŸï¼š**
1. âœ… **å»ºæ§‹å‡½æ•¸åŸ·è¡Œ** â†’ æ¬„ä½åˆå§‹åŒ–
2. âœ… **çµ„ä»¶æ¨™è¨˜æ¸²æŸ“** â†’ `GetModalManagers()` è¢«èª¿ç”¨ï¼ˆâŒ æ­¤æ™‚ supplierModalManager æ˜¯ nullï¼‰
3. âŒ `OnInitializedAsync()` â†’ `InitializeSupplierModalManager()` æ‰åŸ·è¡Œï¼ˆå¤ªæ™šäº†ï¼ï¼‰

#### è§£æ±ºæ–¹æ¡ˆ

**åœ¨å»ºæ§‹å‡½æ•¸ä¸­æå‰åˆå§‹åŒ– `supplierModalManager`ï¼š**

```csharp
// âœ… æ­£ç¢ºçš„åˆå§‹åŒ–æ–¹å¼
private RelatedEntityModalManager<Supplier> supplierModalManager;

// å»ºæ§‹å‡½æ•¸ä¸­æå‰åˆå§‹åŒ–
public PurchaseOrderEditModalComponent()
{
    // æå‰åˆå§‹åŒ– supplierModalManager ä»¥é¿å… NullReferenceException
    // å¯¦éš›é…ç½®æœƒåœ¨ OnInitializedAsync ä¸­å®Œæˆ
    supplierModalManager = new RelatedEntityModalManager<Supplier>();
}

// ä¹‹å¾Œåœ¨ OnInitializedAsync ä¸­é…ç½®ç´°ç¯€
protected override async Task OnInitializedAsync()
{
    // è¼‰å…¥å¯©æ ¸é–‹é—œè¨­å®š
    isApprovalEnabled = await SystemParameterService
        .IsPurchaseOrderApprovalEnabledAsync();
    
    // é…ç½® Modal ç®¡ç†å™¨çš„ callbacks ç­‰
    InitializeSupplierModalManager();
}
```

#### ä¿®æ”¹æª”æ¡ˆ
- `Components/Pages/Purchase/PurchaseOrderEditModalComponent.razor`
  - æ–°å¢å»ºæ§‹å‡½æ•¸ `PurchaseOrderEditModalComponent()`
  - åœ¨å»ºæ§‹å‡½æ•¸ä¸­åˆå§‹åŒ– `supplierModalManager`

#### ç¶“é©—æ•™è¨“
1. **Blazor çµ„ä»¶å±¬æ€§ç¶å®šåœ¨çµ„ä»¶å®£å‘Šæ™‚å°±æœƒåŸ·è¡Œ**ï¼Œä¸æ˜¯åœ¨ `OnInitializedAsync` ä¹‹å¾Œ
2. **`default!` åªæ˜¯å£“åˆ¶ç·¨è­¯å™¨è­¦å‘Š**ï¼Œä¸¦ä¸æœƒçœŸæ­£åˆå§‹åŒ–ç‰©ä»¶
3. **éœ€è¦åœ¨çµ„ä»¶å®£å‘Šæ™‚ä½¿ç”¨çš„ç‰©ä»¶ï¼Œå¿…é ˆåœ¨å»ºæ§‹å‡½æ•¸æˆ–æ¬„ä½åˆå§‹åŒ–æ™‚å°±å»ºç«‹**
4. **`OnInitializedAsync` é©åˆåšéåŒæ­¥è¼‰å…¥å’Œé…ç½®ï¼Œä¸é©åˆåšå¿…è¦ç‰©ä»¶çš„åˆå§‹åŒ–**

#### ç›¸é—œå•é¡Œ
æ­¤å•é¡Œèˆ‡å¯©æ ¸é‚è¼¯ç„¡é—œï¼Œè€Œæ˜¯ Blazor çµ„ä»¶ç”Ÿå‘½é€±æœŸçš„ç†è§£å•é¡Œã€‚å³ä½¿æ²’æœ‰æ–°å¢å¯©æ ¸åŠŸèƒ½ï¼Œåœ¨å…¶ä»–éœ€è¦åœ¨çµ„ä»¶å®£å‘Šæ™‚ä½¿ç”¨çš„ç‰©ä»¶ä¸Šä¹Ÿå¯èƒ½é‡åˆ°é¡ä¼¼å•é¡Œã€‚

#### é é˜²æªæ–½
- æª¢æŸ¥æ‰€æœ‰åœ¨çµ„ä»¶æ¨™è¨˜ä¸­ä½¿ç”¨çš„æ–¹æ³•ï¼ˆå¦‚ `GetXxx()`ï¼‰ï¼Œç¢ºä¿å®ƒå€‘ä¸æœƒå­˜å–æœªåˆå§‹åŒ–çš„ç‰©ä»¶
- å„ªå…ˆä½¿ç”¨æ¬„ä½åˆå§‹åŒ–ï¼ˆ`= new()`ï¼‰æˆ–å»ºæ§‹å‡½æ•¸åˆå§‹åŒ–ï¼Œè€Œéä¾è³´ `OnInitializedAsync`
- é¿å…ä½¿ç”¨ `default!` ä¾†å£“åˆ¶è­¦å‘Šï¼Œæ‡‰è©²çœŸæ­£åˆå§‹åŒ–ç‰©ä»¶

---

## ï¿½ğŸ“ é–‹ç™¼ç­†è¨˜

### è¨­è¨ˆè€ƒé‡

#### ç‚ºä½•æ¡ç”¨ã€Œç³»çµ±åƒæ•¸ã€è€Œéã€Œæ¬Šé™ç³»çµ±ã€ï¼Ÿ
1. **å½ˆæ€§éœ€æ±‚**ï¼šå¯©æ ¸æ©Ÿåˆ¶æ˜¯æ¥­å‹™æµç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œè€Œéå­˜å–æ¬Šé™
2. **ç°¡åŒ–ç®¡ç†**ï¼šç®¡ç†å“¡ç„¡éœ€è¨­å®šè¤‡é›œçš„æ¬Šé™è¦å‰‡
3. **çµ±ä¸€é…ç½®**ï¼šæ‰€æœ‰å¯©æ ¸è¨­å®šé›†ä¸­åœ¨ä¸€è™•
4. **æ˜“æ–¼ç†è§£**ï¼šä½¿ç”¨è€…å®¹æ˜“ç†è§£é–‹é—œçš„æ„ç¾©

#### ç‚ºä½•ä½¿ç”¨å¿«å–ï¼Ÿ
1. **æ•ˆèƒ½è€ƒé‡**ï¼šå¯©æ ¸é–‹é—œæŸ¥è©¢é »ç¹ï¼Œéœ€è¦æ¸›å°‘è³‡æ–™åº«è² æ“”
2. **å³æ™‚æ€§è¦æ±‚**ï¼š5 åˆ†é˜å¿«å–æä¾›å³æ™‚æ€§å’Œæ•ˆèƒ½çš„å¹³è¡¡
3. **è‡ªå‹•å¤±æ•ˆ**ï¼šæ›´æ–°åƒæ•¸æ™‚è‡ªå‹•æ¸…é™¤ï¼Œç¢ºä¿è³‡æ–™ä¸€è‡´æ€§

#### ç‚ºä½•å»ºç«‹ ApprovalConfigHelperï¼Ÿ
1. **çµ±ä¸€é‚è¼¯**ï¼šé¿å…æ¯å€‹çµ„ä»¶éƒ½é‡è¤‡åˆ¤æ–·é‚è¼¯
2. **æ˜“æ–¼ç¶­è­·**ï¼šä¿®æ”¹é‚è¼¯åªéœ€æ›´æ–°ä¸€è™•
3. **æ¸¬è©¦å‹å–„**ï¼šéœæ…‹æ–¹æ³•å®¹æ˜“é€²è¡Œå–®å…ƒæ¸¬è©¦
4. **å¯è®€æ€§**ï¼šèªæ„åŒ–çš„æ–¹æ³•åç¨±æé«˜ç¨‹å¼ç¢¼å¯è®€æ€§

### æŠ€è¡“å‚µå‹™

#### ç›®å‰çš„é™åˆ¶
1. **å–®ä¸€å±¤ç´šå¯©æ ¸**ï¼šç›®å‰åªæ”¯æ´ã€Œå¯©æ ¸é€šé/é§å›ã€ï¼Œç„¡æ³•å¤šç´šå¯©æ ¸
2. **å…¨åŸŸè¨­å®š**ï¼šæ‰€æœ‰ä½¿ç”¨è€…å…±ç”¨åŒä¸€å¥—å¯©æ ¸è¦å‰‡
3. **ç„¡æ­·å²è¨˜éŒ„**ï¼šç„¡æ³•è¿½è¹¤å¯©æ ¸è¨­å®šçš„è®Šæ›´æ­·å²

#### æ½›åœ¨é¢¨éšª
1. **å¿«å–ä¸ä¸€è‡´**ï¼šåˆ†æ•£å¼éƒ¨ç½²æ™‚éœ€è¦è€ƒæ…®å¿«å–åŒæ­¥å•é¡Œ
2. **å‘ä¸‹ç›¸å®¹**ï¼šæœªä¾†æ–°å¢å¯©æ ¸é¡å‹æ™‚éœ€è¦æ³¨æ„å‘ä¸‹ç›¸å®¹

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [README_ä¸»æª”é–ä½è¨­è¨ˆ.md](README_ä¸»æª”é–ä½è¨­è¨ˆ.md) - ä¸»æª”é–å®šæ©Ÿåˆ¶èªªæ˜
- [README_é€²è²¨æ˜ç´°é–å®šä¸»æª”æ¬„ä½.md](README_é€²è²¨æ˜ç´°é–å®šä¸»æª”æ¬„ä½.md) - æ˜ç´°é–å®šé‚è¼¯
- [README_Services.md](README_Services.md) - Service å±¤æ¶æ§‹èªªæ˜

---

## ğŸ‘¥ ç¶­è­·è³‡è¨Š

**é–‹ç™¼åœ˜éšŠï¼š** ERPCore2 é–‹ç™¼åœ˜éšŠ  
**æœ€å¾Œæ›´æ–°ï¼š** 2025å¹´10æœˆ25æ—¥  
**ç¶­è­·ç‹€æ…‹ï¼š** ğŸŸ¢ ç©æ¥µç¶­è­·ä¸­

å¦‚æœ‰å•é¡Œæˆ–å»ºè­°ï¼Œè«‹è¯ç¹«é–‹ç™¼åœ˜éšŠæˆ–æäº¤ Issueã€‚
